/*!
 * PixiJS - v8.1.0
 * Compiled Tue, 09 Apr 2024 13:40:17 UTC
 *
 * PixiJS is licensed under the MIT License.
 * http://www.opensource.org/licenses/mit-license
 */
var PIXI=function(t){"use strict";var e,r=Object.defineProperty,s=Object.defineProperties,i=Object.getOwnPropertyDescriptors,n=Object.getOwnPropertySymbols,o=Object.prototype.hasOwnProperty,a=Object.prototype.propertyIsEnumerable,l=(t,e,s)=>e in t?r(t,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[e]=s,h=(t,e)=>{for(var r in e||(e={}))o.call(e,r)&&l(t,r,e[r]);if(n)for(var r of n(e))a.call(e,r)&&l(t,r,e[r]);return t},u=((e=u||{}).Application="application",e.WebGLPipes="webgl-pipes",e.WebGLPipesAdaptor="webgl-pipes-adaptor",e.WebGLSystem="webgl-system",e.WebGPUPipes="webgpu-pipes",e.WebGPUPipesAdaptor="webgpu-pipes-adaptor",e.WebGPUSystem="webgpu-system",e.CanvasSystem="canvas-system",e.CanvasPipesAdaptor="canvas-pipes-adaptor",e.CanvasPipes="canvas-pipes",e.Asset="asset",e.LoadParser="load-parser",e.ResolveParser="resolve-parser",e.CacheParser="cache-parser",e.DetectionParser="detection-parser",e.MaskEffect="mask-effect",e.BlendMode="blend-mode",e.TextureSource="texture-source",e.Environment="environment",e);const c=t=>{if("function"==typeof t||"object"==typeof t&&t.extension){const e="object"!=typeof t.extension?{type:t.extension}:t.extension;t=((t,e)=>s(t,i(e)))(h({},e),{ref:t})}if("object"!=typeof t)throw new Error("Invalid extension type");return"string"==typeof(t=h({},t)).type&&(t.type=[t.type]),t},d=(t,e)=>{var r;return null!=(r=c(t).priority)?r:e},p={_addHandlers:{},_removeHandlers:{},_queue:{},remove(...t){return t.map(c).forEach((t=>{t.type.forEach((e=>{var r,s;return null==(s=(r=this._removeHandlers)[e])?void 0:s.call(r,t)}))})),this},add(...t){return t.map(c).forEach((t=>{t.type.forEach((e=>{var r,s;const i=this._addHandlers,n=this._queue;i[e]?null==(s=i[e])||s.call(i,t):(n[e]=n[e]||[],null==(r=n[e])||r.push(t))}))})),this},handle(t,e,r){var s;const i=this._addHandlers,n=this._removeHandlers;i[t]=e,n[t]=r;const o=this._queue;return o[t]&&(null==(s=o[t])||s.forEach((t=>e(t))),delete o[t]),this},handleByMap(t,e){return this.handle(t,(t=>{t.name&&(e[t.name]=t.ref)}),(t=>{t.name&&delete e[t.name]}))},handleByNamedList(t,e,r=-1){return this.handle(t,(t=>{e.findIndex((e=>e.name===t.name))>=0||(e.push({name:t.name,value:t.ref}),e.sort(((t,e)=>d(e.value,r)-d(t.value,r))))}),(t=>{const r=e.findIndex((e=>e.name===t.name));-1!==r&&e.splice(r,1)}))},handleByList(t,e,r=-1){return this.handle(t,(t=>{e.includes(t.ref)||(e.push(t.ref),e.sort(((t,e)=>d(e,r)-d(t,r))))}),(t=>{const r=e.indexOf(t.ref);-1!==r&&e.splice(r,1)}))}};"undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self&&self;function f(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}var g={exports:{}};!function(t){var e=Object.prototype.hasOwnProperty,r="~";function s(){}function i(t,e,r){this.fn=t,this.context=e,this.once=r||!1}function n(t,e,s,n,o){if("function"!=typeof s)throw new TypeError("The listener must be a function");var a=new i(s,n||t,o),l=r?r+e:e;return t._events[l]?t._events[l].fn?t._events[l]=[t._events[l],a]:t._events[l].push(a):(t._events[l]=a,t._eventsCount++),t}function o(t,e){0==--t._eventsCount?t._events=new s:delete t._events[e]}function a(){this._events=new s,this._eventsCount=0}Object.create&&(s.prototype=Object.create(null),(new s).__proto__||(r=!1)),a.prototype.eventNames=function(){var t,s,i=[];if(0===this._eventsCount)return i;for(s in t=this._events)e.call(t,s)&&i.push(r?s.slice(1):s);return Object.getOwnPropertySymbols?i.concat(Object.getOwnPropertySymbols(t)):i},a.prototype.listeners=function(t){var e=r?r+t:t,s=this._events[e];if(!s)return[];if(s.fn)return[s.fn];for(var i=0,n=s.length,o=new Array(n);i<n;i++)o[i]=s[i].fn;return o},a.prototype.listenerCount=function(t){var e=r?r+t:t,s=this._events[e];return s?s.fn?1:s.length:0},a.prototype.emit=function(t,e,s,i,n,o){var a=r?r+t:t;if(!this._events[a])return!1;var l,h,u=this._events[a],c=arguments.length;if(u.fn){switch(u.once&&this.removeListener(t,u.fn,void 0,!0),c){case 1:return u.fn.call(u.context),!0;case 2:return u.fn.call(u.context,e),!0;case 3:return u.fn.call(u.context,e,s),!0;case 4:return u.fn.call(u.context,e,s,i),!0;case 5:return u.fn.call(u.context,e,s,i,n),!0;case 6:return u.fn.call(u.context,e,s,i,n,o),!0}for(h=1,l=new Array(c-1);h<c;h++)l[h-1]=arguments[h];u.fn.apply(u.context,l)}else{var d,p=u.length;for(h=0;h<p;h++)switch(u[h].once&&this.removeListener(t,u[h].fn,void 0,!0),c){case 1:u[h].fn.call(u[h].context);break;case 2:u[h].fn.call(u[h].context,e);break;case 3:u[h].fn.call(u[h].context,e,s);break;case 4:u[h].fn.call(u[h].context,e,s,i);break;default:if(!l)for(d=1,l=new Array(c-1);d<c;d++)l[d-1]=arguments[d];u[h].fn.apply(u[h].context,l)}}return!0},a.prototype.on=function(t,e,r){return n(this,t,e,r,!1)},a.prototype.once=function(t,e,r){return n(this,t,e,r,!0)},a.prototype.removeListener=function(t,e,s,i){var n=r?r+t:t;if(!this._events[n])return this;if(!e)return o(this,n),this;var a=this._events[n];if(a.fn)a.fn===e&&(!i||a.once)&&(!s||a.context===s)&&o(this,n);else{for(var l=0,h=[],u=a.length;l<u;l++)(a[l].fn!==e||i&&!a[l].once||s&&a[l].context!==s)&&h.push(a[l]);h.length?this._events[n]=1===h.length?h[0]:h:o(this,n)}return this},a.prototype.removeAllListeners=function(t){var e;return t?(e=r?r+t:t,this._events[e]&&o(this,e)):(this._events=new s,this._eventsCount=0),this},a.prototype.off=a.prototype.removeListener,a.prototype.addListener=a.prototype.on,a.prefixed=r,a.EventEmitter=a,t.exports=a}(g);var m=f(g.exports),_={grad:.9,turn:360,rad:360/(2*Math.PI)},x=function(t){return"string"==typeof t?t.length>0:"number"==typeof t},y=function(t,e,r){return void 0===e&&(e=0),void 0===r&&(r=Math.pow(10,e)),Math.round(r*t)/r+0},b=function(t,e,r){return void 0===e&&(e=0),void 0===r&&(r=1),t>r?r:t>e?t:e},v=function(t){return(t=isFinite(t)?t%360:0)>0?t:t+360},T=function(t){return{r:b(t.r,0,255),g:b(t.g,0,255),b:b(t.b,0,255),a:b(t.a)}},S=function(t){return{r:y(t.r),g:y(t.g),b:y(t.b),a:y(t.a,3)}},w=/^#([0-9a-f]{3,8})$/i,E=function(t){var e=t.toString(16);return e.length<2?"0"+e:e},A=function(t){var e=t.r,r=t.g,s=t.b,i=t.a,n=Math.max(e,r,s),o=n-Math.min(e,r,s),a=o?n===e?(r-s)/o:n===r?2+(s-e)/o:4+(e-r)/o:0;return{h:60*(a<0?a+6:a),s:n?o/n*100:0,v:n/255*100,a:i}},M=function(t){var e=t.h,r=t.s,s=t.v,i=t.a;e=e/360*6,r/=100,s/=100;var n=Math.floor(e),o=s*(1-r),a=s*(1-(e-n)*r),l=s*(1-(1-e+n)*r),h=n%6;return{r:255*[s,a,o,o,l,s][h],g:255*[l,s,s,a,o,o][h],b:255*[o,o,l,s,s,a][h],a:i}},P=function(t){return{h:v(t.h),s:b(t.s,0,100),l:b(t.l,0,100),a:b(t.a)}},R=function(t){return{h:y(t.h),s:y(t.s),l:y(t.l),a:y(t.a,3)}},O=function(t){return M((r=(e=t).s,{h:e.h,s:(r*=((s=e.l)<50?s:100-s)/100)>0?2*r/(s+r)*100:0,v:s+r,a:e.a}));var e,r,s},C=function(t){return{h:(e=A(t)).h,s:(i=(200-(r=e.s))*(s=e.v)/100)>0&&i<200?r*s/100/(i<=100?i:200-i)*100:0,l:i/2,a:e.a};var e,r,s,i},I=/^hsla?\(\s*([+-]?\d*\.?\d+)(deg|rad|grad|turn)?\s*,\s*([+-]?\d*\.?\d+)%\s*,\s*([+-]?\d*\.?\d+)%\s*(?:,\s*([+-]?\d*\.?\d+)(%)?\s*)?\)$/i,G=/^hsla?\(\s*([+-]?\d*\.?\d+)(deg|rad|grad|turn)?\s+([+-]?\d*\.?\d+)%\s+([+-]?\d*\.?\d+)%\s*(?:\/\s*([+-]?\d*\.?\d+)(%)?\s*)?\)$/i,k=/^rgba?\(\s*([+-]?\d*\.?\d+)(%)?\s*,\s*([+-]?\d*\.?\d+)(%)?\s*,\s*([+-]?\d*\.?\d+)(%)?\s*(?:,\s*([+-]?\d*\.?\d+)(%)?\s*)?\)$/i,B=/^rgba?\(\s*([+-]?\d*\.?\d+)(%)?\s+([+-]?\d*\.?\d+)(%)?\s+([+-]?\d*\.?\d+)(%)?\s*(?:\/\s*([+-]?\d*\.?\d+)(%)?\s*)?\)$/i,D={string:[[function(t){var e=w.exec(t);return e?(t=e[1]).length<=4?{r:parseInt(t[0]+t[0],16),g:parseInt(t[1]+t[1],16),b:parseInt(t[2]+t[2],16),a:4===t.length?y(parseInt(t[3]+t[3],16)/255,2):1}:6===t.length||8===t.length?{r:parseInt(t.substr(0,2),16),g:parseInt(t.substr(2,2),16),b:parseInt(t.substr(4,2),16),a:8===t.length?y(parseInt(t.substr(6,2),16)/255,2):1}:null:null},"hex"],[function(t){var e=k.exec(t)||B.exec(t);return e?e[2]!==e[4]||e[4]!==e[6]?null:T({r:Number(e[1])/(e[2]?100/255:1),g:Number(e[3])/(e[4]?100/255:1),b:Number(e[5])/(e[6]?100/255:1),a:void 0===e[7]?1:Number(e[7])/(e[8]?100:1)}):null},"rgb"],[function(t){var e=I.exec(t)||G.exec(t);if(!e)return null;var r,s,i=P({h:(r=e[1],s=e[2],void 0===s&&(s="deg"),Number(r)*(_[s]||1)),s:Number(e[3]),l:Number(e[4]),a:void 0===e[5]?1:Number(e[5])/(e[6]?100:1)});return O(i)},"hsl"]],object:[[function(t){var e=t.r,r=t.g,s=t.b,i=t.a,n=void 0===i?1:i;return x(e)&&x(r)&&x(s)?T({r:Number(e),g:Number(r),b:Number(s),a:Number(n)}):null},"rgb"],[function(t){var e=t.h,r=t.s,s=t.l,i=t.a,n=void 0===i?1:i;if(!x(e)||!x(r)||!x(s))return null;var o=P({h:Number(e),s:Number(r),l:Number(s),a:Number(n)});return O(o)},"hsl"],[function(t){var e=t.h,r=t.s,s=t.v,i=t.a,n=void 0===i?1:i;if(!x(e)||!x(r)||!x(s))return null;var o,a=(o={h:Number(e),s:Number(r),v:Number(s),a:Number(n)},{h:v(o.h),s:b(o.s,0,100),v:b(o.v,0,100),a:b(o.a)});return M(a)},"hsv"]]},F=function(t,e){for(var r=0;r<e.length;r++){var s=e[r][0](t);if(s)return[s,e[r][1]]}return[null,void 0]},N=function(t){return"string"==typeof t?F(t.trim(),D.string):"object"==typeof t&&null!==t?F(t,D.object):[null,void 0]},U=function(t,e){var r=C(t);return{h:r.h,s:b(r.s+100*e,0,100),l:r.l,a:r.a}},L=function(t){return(299*t.r+587*t.g+114*t.b)/1e3/255},X=function(t,e){var r=C(t);return{h:r.h,s:r.s,l:b(r.l+100*e,0,100),a:r.a}},z=function(){function t(t){this.parsed=N(t)[0],this.rgba=this.parsed||{r:0,g:0,b:0,a:1}}return t.prototype.isValid=function(){return null!==this.parsed},t.prototype.brightness=function(){return y(L(this.rgba),2)},t.prototype.isDark=function(){return L(this.rgba)<.5},t.prototype.isLight=function(){return L(this.rgba)>=.5},t.prototype.toHex=function(){return e=(t=S(this.rgba)).r,r=t.g,s=t.b,n=(i=t.a)<1?E(y(255*i)):"","#"+E(e)+E(r)+E(s)+n;var t,e,r,s,i,n},t.prototype.toRgb=function(){return S(this.rgba)},t.prototype.toRgbString=function(){return e=(t=S(this.rgba)).r,r=t.g,s=t.b,(i=t.a)<1?"rgba("+e+", "+r+", "+s+", "+i+")":"rgb("+e+", "+r+", "+s+")";var t,e,r,s,i},t.prototype.toHsl=function(){return R(C(this.rgba))},t.prototype.toHslString=function(){return e=(t=R(C(this.rgba))).h,r=t.s,s=t.l,(i=t.a)<1?"hsla("+e+", "+r+"%, "+s+"%, "+i+")":"hsl("+e+", "+r+"%, "+s+"%)";var t,e,r,s,i},t.prototype.toHsv=function(){return t=A(this.rgba),{h:y(t.h),s:y(t.s),v:y(t.v),a:y(t.a,3)};var t},t.prototype.invert=function(){return H({r:255-(t=this.rgba).r,g:255-t.g,b:255-t.b,a:t.a});var t},t.prototype.saturate=function(t){return void 0===t&&(t=.1),H(U(this.rgba,t))},t.prototype.desaturate=function(t){return void 0===t&&(t=.1),H(U(this.rgba,-t))},t.prototype.grayscale=function(){return H(U(this.rgba,-1))},t.prototype.lighten=function(t){return void 0===t&&(t=.1),H(X(this.rgba,t))},t.prototype.darken=function(t){return void 0===t&&(t=.1),H(X(this.rgba,-t))},t.prototype.rotate=function(t){return void 0===t&&(t=15),this.hue(this.hue()+t)},t.prototype.alpha=function(t){return"number"==typeof t?H({r:(e=this.rgba).r,g:e.g,b:e.b,a:t}):y(this.rgba.a,3);var e},t.prototype.hue=function(t){var e=C(this.rgba);return"number"==typeof t?H({h:t,s:e.s,l:e.l,a:e.a}):y(e.h)},t.prototype.isEqual=function(t){return this.toHex()===H(t).toHex()},t}(),H=function(t){return t instanceof z?t:new z(t)},j=[];var V=Object.defineProperty,W=Object.getOwnPropertySymbols,$=Object.prototype.hasOwnProperty,Y=Object.prototype.propertyIsEnumerable,q=(t,e,r)=>e in t?V(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r;!function(t){t.forEach((function(t){j.indexOf(t)<0&&(t(z,D),j.push(t))}))}([function(t,e){var r={white:"#ffffff",bisque:"#ffe4c4",blue:"#0000ff",cadetblue:"#5f9ea0",chartreuse:"#7fff00",chocolate:"#d2691e",coral:"#ff7f50",antiquewhite:"#faebd7",aqua:"#00ffff",azure:"#f0ffff",whitesmoke:"#f5f5f5",papayawhip:"#ffefd5",plum:"#dda0dd",blanchedalmond:"#ffebcd",black:"#000000",gold:"#ffd700",goldenrod:"#daa520",gainsboro:"#dcdcdc",cornsilk:"#fff8dc",cornflowerblue:"#6495ed",burlywood:"#deb887",aquamarine:"#7fffd4",beige:"#f5f5dc",crimson:"#dc143c",cyan:"#00ffff",darkblue:"#00008b",darkcyan:"#008b8b",darkgoldenrod:"#b8860b",darkkhaki:"#bdb76b",darkgray:"#a9a9a9",darkgreen:"#006400",darkgrey:"#a9a9a9",peachpuff:"#ffdab9",darkmagenta:"#8b008b",darkred:"#8b0000",darkorchid:"#9932cc",darkorange:"#ff8c00",darkslateblue:"#483d8b",gray:"#808080",darkslategray:"#2f4f4f",darkslategrey:"#2f4f4f",deeppink:"#ff1493",deepskyblue:"#00bfff",wheat:"#f5deb3",firebrick:"#b22222",floralwhite:"#fffaf0",ghostwhite:"#f8f8ff",darkviolet:"#9400d3",magenta:"#ff00ff",green:"#008000",dodgerblue:"#1e90ff",grey:"#808080",honeydew:"#f0fff0",hotpink:"#ff69b4",blueviolet:"#8a2be2",forestgreen:"#228b22",lawngreen:"#7cfc00",indianred:"#cd5c5c",indigo:"#4b0082",fuchsia:"#ff00ff",brown:"#a52a2a",maroon:"#800000",mediumblue:"#0000cd",lightcoral:"#f08080",darkturquoise:"#00ced1",lightcyan:"#e0ffff",ivory:"#fffff0",lightyellow:"#ffffe0",lightsalmon:"#ffa07a",lightseagreen:"#20b2aa",linen:"#faf0e6",mediumaquamarine:"#66cdaa",lemonchiffon:"#fffacd",lime:"#00ff00",khaki:"#f0e68c",mediumseagreen:"#3cb371",limegreen:"#32cd32",mediumspringgreen:"#00fa9a",lightskyblue:"#87cefa",lightblue:"#add8e6",midnightblue:"#191970",lightpink:"#ffb6c1",mistyrose:"#ffe4e1",moccasin:"#ffe4b5",mintcream:"#f5fffa",lightslategray:"#778899",lightslategrey:"#778899",navajowhite:"#ffdead",navy:"#000080",mediumvioletred:"#c71585",powderblue:"#b0e0e6",palegoldenrod:"#eee8aa",oldlace:"#fdf5e6",paleturquoise:"#afeeee",mediumturquoise:"#48d1cc",mediumorchid:"#ba55d3",rebeccapurple:"#663399",lightsteelblue:"#b0c4de",mediumslateblue:"#7b68ee",thistle:"#d8bfd8",tan:"#d2b48c",orchid:"#da70d6",mediumpurple:"#9370db",purple:"#800080",pink:"#ffc0cb",skyblue:"#87ceeb",springgreen:"#00ff7f",palegreen:"#98fb98",red:"#ff0000",yellow:"#ffff00",slateblue:"#6a5acd",lavenderblush:"#fff0f5",peru:"#cd853f",palevioletred:"#db7093",violet:"#ee82ee",teal:"#008080",slategray:"#708090",slategrey:"#708090",aliceblue:"#f0f8ff",darkseagreen:"#8fbc8f",darkolivegreen:"#556b2f",greenyellow:"#adff2f",seagreen:"#2e8b57",seashell:"#fff5ee",tomato:"#ff6347",silver:"#c0c0c0",sienna:"#a0522d",lavender:"#e6e6fa",lightgreen:"#90ee90",orange:"#ffa500",orangered:"#ff4500",steelblue:"#4682b4",royalblue:"#4169e1",turquoise:"#40e0d0",yellowgreen:"#9acd32",salmon:"#fa8072",saddlebrown:"#8b4513",sandybrown:"#f4a460",rosybrown:"#bc8f8f",darksalmon:"#e9967a",lightgoldenrodyellow:"#fafad2",snow:"#fffafa",lightgrey:"#d3d3d3",lightgray:"#d3d3d3",dimgray:"#696969",dimgrey:"#696969",olivedrab:"#6b8e23",olive:"#808000"},s={};for(var i in r)s[r[i]]=i;var n={};t.prototype.toName=function(e){if(!(this.rgba.a||this.rgba.r||this.rgba.g||this.rgba.b))return"transparent";var i,o,a=s[this.toHex()];if(a)return a;if(null!=e&&e.closest){var l=this.toRgb(),h=1/0,u="black";if(!n.length)for(var c in r)n[c]=new t(r[c]).toRgb();for(var d in r){var p=(i=l,o=n[d],Math.pow(i.r-o.r,2)+Math.pow(i.g-o.g,2)+Math.pow(i.b-o.b,2));p<h&&(h=p,u=d)}return u}},e.string.push([function(e){var s=e.toLowerCase(),i="transparent"===s?"#0000":r[s];return i?new t(i).toRgb():null},"name"])}]);const K=class t{constructor(t=16777215){this._value=null,this._components=new Float32Array(4),this._components.fill(1),this._int=16777215,this.value=t}get red(){return this._components[0]}get green(){return this._components[1]}get blue(){return this._components[2]}get alpha(){return this._components[3]}setValue(t){return this.value=t,this}set value(e){if(e instanceof t)this._value=this._cloneSource(e._value),this._int=e._int,this._components.set(e._components);else{if(null===e)throw new Error("Cannot set Color#value to null");(null===this._value||!this._isSourceEqual(this._value,e))&&(this._normalize(e),this._value=this._cloneSource(e))}}get value(){return this._value}_cloneSource(t){return"string"==typeof t||"number"==typeof t||t instanceof Number||null===t?t:Array.isArray(t)||ArrayBuffer.isView(t)?t.slice(0):"object"==typeof t&&null!==t?((t,e)=>{for(var r in e||(e={}))$.call(e,r)&&q(t,r,e[r]);if(W)for(var r of W(e))Y.call(e,r)&&q(t,r,e[r]);return t})({},t):t}_isSourceEqual(t,e){const r=typeof t;if(r!==typeof e)return!1;if("number"===r||"string"===r||t instanceof Number)return t===e;if(Array.isArray(t)&&Array.isArray(e)||ArrayBuffer.isView(t)&&ArrayBuffer.isView(e))return t.length===e.length&&t.every(((t,r)=>t===e[r]));if(null!==t&&null!==e){const r=Object.keys(t),s=Object.keys(e);return r.length===s.length&&r.every((r=>t[r]===e[r]))}return t===e}toRgba(){const[t,e,r,s]=this._components;return{r:t,g:e,b:r,a:s}}toRgb(){const[t,e,r]=this._components;return{r:t,g:e,b:r}}toRgbaString(){const[t,e,r]=this.toUint8RgbArray();return`rgba(${t},${e},${r},${this.alpha})`}toUint8RgbArray(t){const[e,r,s]=this._components;return this._arrayRgb||(this._arrayRgb=[]),(t=t||this._arrayRgb)[0]=Math.round(255*e),t[1]=Math.round(255*r),t[2]=Math.round(255*s),t}toArray(t){this._arrayRgba||(this._arrayRgba=[]),t=t||this._arrayRgba;const[e,r,s,i]=this._components;return t[0]=e,t[1]=r,t[2]=s,t[3]=i,t}toRgbArray(t){this._arrayRgb||(this._arrayRgb=[]),t=t||this._arrayRgb;const[e,r,s]=this._components;return t[0]=e,t[1]=r,t[2]=s,t}toNumber(){return this._int}toBgrNumber(){const[t,e,r]=this.toUint8RgbArray();return(r<<16)+(e<<8)+t}toLittleEndianNumber(){const t=this._int;return(t>>16)+(65280&t)+((255&t)<<16)}multiply(e){const[r,s,i,n]=t._temp.setValue(e)._components;return this._components[0]*=r,this._components[1]*=s,this._components[2]*=i,this._components[3]*=n,this._refreshInt(),this._value=null,this}premultiply(t,e=!0){return e&&(this._components[0]*=t,this._components[1]*=t,this._components[2]*=t),this._components[3]=t,this._refreshInt(),this._value=null,this}toPremultiplied(t,e=!0){if(1===t)return(255<<24)+this._int;if(0===t)return e?0:this._int;let r=this._int>>16&255,s=this._int>>8&255,i=255&this._int;return e&&(r=r*t+.5|0,s=s*t+.5|0,i=i*t+.5|0),(255*t<<24)+(r<<16)+(s<<8)+i}toHex(){const t=this._int.toString(16);return`#${"000000".substring(0,6-t.length)+t}`}toHexa(){const t=Math.round(255*this._components[3]).toString(16);return this.toHex()+"00".substring(0,2-t.length)+t}setAlpha(t){return this._components[3]=this._clamp(t),this}_normalize(e){let r,s,i,n;if(("number"==typeof e||e instanceof Number)&&e>=0&&e<=16777215){r=(e>>16&255)/255,s=(e>>8&255)/255,i=(255&e)/255,n=1}else if((Array.isArray(e)||e instanceof Float32Array)&&e.length>=3&&e.length<=4)e=this._clamp(e),[r,s,i,n=1]=e;else if((e instanceof Uint8Array||e instanceof Uint8ClampedArray)&&e.length>=3&&e.length<=4)e=this._clamp(e,0,255),[r,s,i,n=255]=e,r/=255,s/=255,i/=255,n/=255;else if("string"==typeof e||"object"==typeof e){if("string"==typeof e){const r=t.HEX_PATTERN.exec(e);r&&(e=`#${r[2]}`)}const o=H(e);o.isValid()&&(({r:r,g:s,b:i,a:n}=o.rgba),r/=255,s/=255,i/=255)}if(void 0===r)throw new Error(`Unable to convert color ${e}`);this._components[0]=r,this._components[1]=s,this._components[2]=i,this._components[3]=n,this._refreshInt()}_refreshInt(){this._clamp(this._components);const[t,e,r]=this._components;this._int=(255*t<<16)+(255*e<<8)+(255*r|0)}_clamp(t,e=0,r=1){return"number"==typeof t?Math.min(Math.max(t,e),r):(t.forEach(((s,i)=>{t[i]=Math.min(Math.max(s,e),r)})),t)}static isColorLike(e){return"number"==typeof e||"string"==typeof e||e instanceof Number||e instanceof t||Array.isArray(e)||e instanceof Uint8Array||e instanceof Uint8ClampedArray||e instanceof Float32Array||void 0!==e.r&&void 0!==e.g&&void 0!==e.b||void 0!==e.r&&void 0!==e.g&&void 0!==e.b&&void 0!==e.a||void 0!==e.h&&void 0!==e.s&&void 0!==e.l||void 0!==e.h&&void 0!==e.s&&void 0!==e.l&&void 0!==e.a||void 0!==e.h&&void 0!==e.s&&void 0!==e.v||void 0!==e.h&&void 0!==e.s&&void 0!==e.v&&void 0!==e.a}};K.shared=new K,K._temp=new K,K.HEX_PATTERN=/^(#|0x)?(([a-f0-9]{3}){1,2}([a-f0-9]{2})?)$/i;let Z=K;const Q={cullArea:null,cullable:!1,cullableChildren:!0},J=2*Math.PI,tt=180/Math.PI,et=Math.PI/180;class rt{constructor(t=0,e=0){this.x=0,this.y=0,this.x=t,this.y=e}clone(){return new rt(this.x,this.y)}copyFrom(t){return this.set(t.x,t.y),this}copyTo(t){return t.set(this.x,this.y),t}equals(t){return t.x===this.x&&t.y===this.y}set(t=0,e=t){return this.x=t,this.y=e,this}static get shared(){return st.x=0,st.y=0,st}}const st=new rt;class it{constructor(t=1,e=0,r=0,s=1,i=0,n=0){this.array=null,this.a=t,this.b=e,this.c=r,this.d=s,this.tx=i,this.ty=n}fromArray(t){this.a=t[0],this.b=t[1],this.c=t[3],this.d=t[4],this.tx=t[2],this.ty=t[5]}set(t,e,r,s,i,n){return this.a=t,this.b=e,this.c=r,this.d=s,this.tx=i,this.ty=n,this}toArray(t,e){this.array||(this.array=new Float32Array(9));const r=e||this.array;return t?(r[0]=this.a,r[1]=this.b,r[2]=0,r[3]=this.c,r[4]=this.d,r[5]=0,r[6]=this.tx,r[7]=this.ty,r[8]=1):(r[0]=this.a,r[1]=this.c,r[2]=this.tx,r[3]=this.b,r[4]=this.d,r[5]=this.ty,r[6]=0,r[7]=0,r[8]=1),r}apply(t,e){e=e||new rt;const r=t.x,s=t.y;return e.x=this.a*r+this.c*s+this.tx,e.y=this.b*r+this.d*s+this.ty,e}applyInverse(t,e){e=e||new rt;const r=this.a,s=this.b,i=this.c,n=this.d,o=this.tx,a=this.ty,l=1/(r*n+i*-s),h=t.x,u=t.y;return e.x=n*l*h+-i*l*u+(a*i-o*n)*l,e.y=r*l*u+-s*l*h+(-a*r+o*s)*l,e}translate(t,e){return this.tx+=t,this.ty+=e,this}scale(t,e){return this.a*=t,this.d*=e,this.c*=t,this.b*=e,this.tx*=t,this.ty*=e,this}rotate(t){const e=Math.cos(t),r=Math.sin(t),s=this.a,i=this.c,n=this.tx;return this.a=s*e-this.b*r,this.b=s*r+this.b*e,this.c=i*e-this.d*r,this.d=i*r+this.d*e,this.tx=n*e-this.ty*r,this.ty=n*r+this.ty*e,this}append(t){const e=this.a,r=this.b,s=this.c,i=this.d;return this.a=t.a*e+t.b*s,this.b=t.a*r+t.b*i,this.c=t.c*e+t.d*s,this.d=t.c*r+t.d*i,this.tx=t.tx*e+t.ty*s+this.tx,this.ty=t.tx*r+t.ty*i+this.ty,this}appendFrom(t,e){const r=t.a,s=t.b,i=t.c,n=t.d,o=t.tx,a=t.ty,l=e.a,h=e.b,u=e.c,c=e.d;return this.a=r*l+s*u,this.b=r*h+s*c,this.c=i*l+n*u,this.d=i*h+n*c,this.tx=o*l+a*u+e.tx,this.ty=o*h+a*c+e.ty,this}setTransform(t,e,r,s,i,n,o,a,l){return this.a=Math.cos(o+l)*i,this.b=Math.sin(o+l)*i,this.c=-Math.sin(o-a)*n,this.d=Math.cos(o-a)*n,this.tx=t-(r*this.a+s*this.c),this.ty=e-(r*this.b+s*this.d),this}prepend(t){const e=this.tx;if(1!==t.a||0!==t.b||0!==t.c||1!==t.d){const e=this.a,r=this.c;this.a=e*t.a+this.b*t.c,this.b=e*t.b+this.b*t.d,this.c=r*t.a+this.d*t.c,this.d=r*t.b+this.d*t.d}return this.tx=e*t.a+this.ty*t.c+t.tx,this.ty=e*t.b+this.ty*t.d+t.ty,this}decompose(t){const e=this.a,r=this.b,s=this.c,i=this.d,n=t.pivot,o=-Math.atan2(-s,i),a=Math.atan2(r,e),l=Math.abs(o+a);return l<1e-5||Math.abs(J-l)<1e-5?(t.rotation=a,t.skew.x=t.skew.y=0):(t.rotation=0,t.skew.x=o,t.skew.y=a),t.scale.x=Math.sqrt(e*e+r*r),t.scale.y=Math.sqrt(s*s+i*i),t.position.x=this.tx+(n.x*e+n.y*s),t.position.y=this.ty+(n.x*r+n.y*i),t}invert(){const t=this.a,e=this.b,r=this.c,s=this.d,i=this.tx,n=t*s-e*r;return this.a=s/n,this.b=-e/n,this.c=-r/n,this.d=t/n,this.tx=(r*this.ty-s*i)/n,this.ty=-(t*this.ty-e*i)/n,this}isIdentity(){return 1===this.a&&0===this.b&&0===this.c&&1===this.d&&0===this.tx&&0===this.ty}identity(){return this.a=1,this.b=0,this.c=0,this.d=1,this.tx=0,this.ty=0,this}clone(){const t=new it;return t.a=this.a,t.b=this.b,t.c=this.c,t.d=this.d,t.tx=this.tx,t.ty=this.ty,t}copyTo(t){return t.a=this.a,t.b=this.b,t.c=this.c,t.d=this.d,t.tx=this.tx,t.ty=this.ty,t}copyFrom(t){return this.a=t.a,this.b=t.b,this.c=t.c,this.d=t.d,this.tx=t.tx,this.ty=t.ty,this}equals(t){return t.a===this.a&&t.b===this.b&&t.c===this.c&&t.d===this.d&&t.tx===this.tx&&t.ty===this.ty}static get IDENTITY(){return ot.identity()}static get shared(){return nt.identity()}}const nt=new it,ot=new it;class at{constructor(t,e,r){this._x=e||0,this._y=r||0,this._observer=t}clone(t){return new at(null!=t?t:this._observer,this._x,this._y)}set(t=0,e=t){return(this._x!==t||this._y!==e)&&(this._x=t,this._y=e,this._observer._onUpdate(this)),this}copyFrom(t){return(this._x!==t.x||this._y!==t.y)&&(this._x=t.x,this._y=t.y,this._observer._onUpdate(this)),this}copyTo(t){return t.set(this._x,this._y),t}equals(t){return t.x===this._x&&t.y===this._y}get x(){return this._x}set x(t){this._x!==t&&(this._x=t,this._observer._onUpdate(this))}get y(){return this._y}set y(t){this._y!==t&&(this._y=t,this._observer._onUpdate(this))}}const lt={default:-1};function ht(t="default"){return void 0===lt[t]&&(lt[t]=-1),++lt[t]}function ut(t,e,r){const s=t.length;let i;if(e>=s||0===r)return;const n=s-(r=e+r>s?s-e:r);for(i=e;i<n;++i)t[i]=t[i+r];t.length=n}const ct={allowChildren:!0,removeChildren(t=0,e){const r=null!=e?e:this.children.length,s=r-t,i=[];if(s>0&&s<=r){for(let e=r-1;e>=t;e--){const t=this.children[e];t&&(this.renderGroup&&this.renderGroup.removeChild(t),i.push(t),t.parent=null)}ut(this.children,t,r);for(let t=0;t<i.length;++t)this.emit("childRemoved",i[t],this,t),i[t].emit("removed",this);return i}if(0===s&&0===this.children.length)return i;throw new RangeError("removeChildren: numeric values are outside the acceptable range.")},removeChildAt(t){const e=this.getChildAt(t);return this.removeChild(e)},getChildAt(t){if(t<0||t>=this.children.length)throw new Error(`getChildAt: Index (${t}) does not exist.`);return this.children[t]},setChildIndex(t,e){if(e<0||e>=this.children.length)throw new Error(`The index ${e} supplied is out of bounds ${this.children.length}`);this.getChildIndex(t),this.addChildAt(t,e)},getChildIndex(t){const e=this.children.indexOf(t);if(-1===e)throw new Error("The supplied Container must be a child of the caller");return e},addChildAt(t,e){const{children:r}=this;if(e<0||e>r.length)throw new Error(`${t}addChildAt: The index ${e} supplied is out of bounds ${r.length}`);if(t.parent){const r=t.parent.children.indexOf(t);if(t.parent===this&&r===e)return t;-1!==r&&t.parent.children.splice(r,1)}return e===r.length?r.push(t):r.splice(e,0,t),t.parent=this,t.didChange=!0,t.didViewUpdate=!1,t._updateFlags=15,this.renderGroup&&this.renderGroup.addChild(t),this.sortableChildren&&(this.sortDirty=!0),this.emit("childAdded",t,this,e),t.emit("added",this),t},swapChildren(t,e){if(t===e)return;const r=this.getChildIndex(t),s=this.getChildIndex(e);this.children[r]=e,this.children[s]=t},removeFromParent(){var t;null==(t=this.parent)||t.removeChild(this)}};class dt{constructor(t){this.pipe="filter",this.priority=1,this.filters=null==t?void 0:t.filters,this.filterArea=null==t?void 0:t.filterArea}destroy(){for(let t=0;t<this.filters.length;t++)this.filters[t].destroy();this.filters=null,this.filterArea=null}}class pt{constructor(t,e){this._pool=[],this._count=0,this._index=0,this._classType=t,e&&this.prepopulate(e)}prepopulate(t){for(let e=0;e<t;e++)this._pool[this._index++]=new this._classType;this._count+=t}get(t){var e;let r;return r=this._index>0?this._pool[--this._index]:new this._classType,null==(e=r.init)||e.call(r,t),r}return(t){var e;null==(e=t.reset)||e.call(t),this._pool[this._index++]=t}get totalSize(){return this._count}get totalFree(){return this._index}get totalUsed(){return this._count-this._index}}class ft{constructor(){this._poolsByClass=new Map}prepopulate(t,e){this.getPool(t).prepopulate(e)}get(t,e){return this.getPool(t).get(e)}return(t){this.getPool(t.constructor).return(t)}getPool(t){return this._poolsByClass.has(t)||this._poolsByClass.set(t,new pt(t)),this._poolsByClass.get(t)}stats(){const t={};return this._poolsByClass.forEach((e=>{const r=t[e._classType.name]?e._classType.name+e._classType.ID:e._classType.name;t[r]={free:e.totalFree,used:e.totalUsed,size:e.totalSize}})),t}}const gt=new ft;class mt{constructor(){this._effectClasses=[],this._tests=[],this._initialized=!1}init(){this._initialized||(this._initialized=!0,this._effectClasses.forEach((t=>{this.add({test:t.test,maskClass:t})})))}add(t){this._tests.push(t)}getMaskEffect(t){this._initialized||this.init();for(let e=0;e<this._tests.length;e++){const r=this._tests[e];if(r.test(t))return gt.get(r.maskClass,t)}return t}returnMaskEffect(t){gt.return(t)}}const _t=new mt;p.handleByList(u.MaskEffect,_t._effectClasses);const xt={_mask:null,_filters:null,effects:[],addEffect(t){-1===this.effects.indexOf(t)&&(this.effects.push(t),this.effects.sort(((t,e)=>t.priority-e.priority)),this.renderGroup&&(this.renderGroup.structureDidChange=!0),this._updateIsSimple())},removeEffect(t){const e=this.effects.indexOf(t);-1!==e&&(this.effects.splice(e,1),!this.isRenderGroupRoot&&this.renderGroup&&(this.renderGroup.structureDidChange=!0),this._updateIsSimple())},set mask(t){if(this._mask||(this._mask={mask:null,effect:null}),this._mask.mask===t||(this._mask.effect&&(this.removeEffect(this._mask.effect),_t.returnMaskEffect(this._mask.effect),this._mask.effect=null),this._mask.mask=t,null==t))return;const e=_t.getMaskEffect(t);this._mask.effect=e,this.addEffect(e)},get mask(){var t;return null==(t=this._mask)?void 0:t.mask},set filters(t){!Array.isArray(t)&&t&&(t=[t]),this._filters||(this._filters={filters:null,effect:null,filterArea:null});const e=(null==t?void 0:t.length)>0,r=this._filters.effect&&!e||!this._filters.effect&&e;if(t=Array.isArray(t)?t.slice(0):t,this._filters.filters=Object.freeze(t),r)if(e){const t=gt.get(dt);this._filters.effect=t,this.addEffect(t)}else{const t=this._filters.effect;this.removeEffect(t),t.filterArea=null,t.filters=null,this._filters.effect=null,gt.return(t)}e&&(this._filters.effect.filters=t,this._filters.effect.filterArea=this.filterArea)},get filters(){var t;return null==(t=this._filters)?void 0:t.filters},set filterArea(t){this._filters||(this._filters={filters:null,effect:null,filterArea:null}),this._filters.filterArea=t},get filterArea(){var t;return null==(t=this._filters)?void 0:t.filterArea}},yt={label:null,get name(){return this.label},set name(t){this.label=t},getChildByName(t,e=!1){return this.getChildByLabel(t,e)},getChildByLabel(t,e=!1){const r=this.children;for(let e=0;e<r.length;e++){const s=r[e];if(s.label===t||t instanceof RegExp&&t.test(s.label))return s}if(e)for(let e=0;e<r.length;e++){const s=r[e].getChildByLabel(t,!0);if(s)return s}return null},getChildrenByLabel(t,e=!1,r=[]){const s=this.children;for(let e=0;e<s.length;e++){const i=s[e];(i.label===t||t instanceof RegExp&&t.test(i.label))&&r.push(i)}if(e)for(let e=0;e<s.length;e++)s[e].getChildrenByLabel(t,!0,r);return r}},bt=[new rt,new rt,new rt,new rt];class vt{constructor(t=0,e=0,r=0,s=0){this.type="rectangle",this.x=Number(t),this.y=Number(e),this.width=Number(r),this.height=Number(s)}get left(){return this.x}get right(){return this.x+this.width}get top(){return this.y}get bottom(){return this.y+this.height}isEmpty(){return this.left===this.right||this.top===this.bottom}static get EMPTY(){return new vt(0,0,0,0)}clone(){return new vt(this.x,this.y,this.width,this.height)}copyFromBounds(t){return this.x=t.minX,this.y=t.minY,this.width=t.maxX-t.minX,this.height=t.maxY-t.minY,this}copyFrom(t){return this.x=t.x,this.y=t.y,this.width=t.width,this.height=t.height,this}copyTo(t){return t.copyFrom(this),t}contains(t,e){return!(this.width<=0||this.height<=0)&&(t>=this.x&&t<this.x+this.width&&e>=this.y&&e<this.y+this.height)}strokeContains(t,e,r){const{width:s,height:i}=this;if(s<=0||i<=0)return!1;const n=this.x,o=this.y;return t>=n-r/2&&t<=n+s+r/2&&e>=o-r/2&&e<=o+i+r/2&&!(t>n+r/2&&t<n+s-r/2&&e>o+r/2&&e<o+i-r/2)}intersects(t,e){if(!e){const e=this.x<t.x?t.x:this.x;if((this.right>t.right?t.right:this.right)<=e)return!1;const r=this.y<t.y?t.y:this.y;return(this.bottom>t.bottom?t.bottom:this.bottom)>r}const r=this.left,s=this.right,i=this.top,n=this.bottom;if(s<=r||n<=i)return!1;const o=bt[0].set(t.left,t.top),a=bt[1].set(t.left,t.bottom),l=bt[2].set(t.right,t.top),h=bt[3].set(t.right,t.bottom);if(l.x<=o.x||a.y<=o.y)return!1;const u=Math.sign(e.a*e.d-e.b*e.c);if(0===u||(e.apply(o,o),e.apply(a,a),e.apply(l,l),e.apply(h,h),Math.max(o.x,a.x,l.x,h.x)<=r||Math.min(o.x,a.x,l.x,h.x)>=s||Math.max(o.y,a.y,l.y,h.y)<=i||Math.min(o.y,a.y,l.y,h.y)>=n))return!1;const c=u*(a.y-o.y),d=u*(o.x-a.x),p=c*r+d*i,f=c*s+d*i,g=c*r+d*n,m=c*s+d*n;if(Math.max(p,f,g,m)<=c*o.x+d*o.y||Math.min(p,f,g,m)>=c*h.x+d*h.y)return!1;const _=u*(o.y-l.y),x=u*(l.x-o.x),y=_*r+x*i,b=_*s+x*i,v=_*r+x*n,T=_*s+x*n;return!(Math.max(y,b,v,T)<=_*o.x+x*o.y||Math.min(y,b,v,T)>=_*h.x+x*h.y)}pad(t=0,e=t){return this.x-=t,this.y-=e,this.width+=2*t,this.height+=2*e,this}fit(t){const e=Math.max(this.x,t.x),r=Math.min(this.x+this.width,t.x+t.width),s=Math.max(this.y,t.y),i=Math.min(this.y+this.height,t.y+t.height);return this.x=e,this.width=Math.max(r-e,0),this.y=s,this.height=Math.max(i-s,0),this}ceil(t=1,e=.001){const r=Math.ceil((this.x+this.width-e)*t)/t,s=Math.ceil((this.y+this.height-e)*t)/t;return this.x=Math.floor((this.x+e)*t)/t,this.y=Math.floor((this.y+e)*t)/t,this.width=r-this.x,this.height=s-this.y,this}enlarge(t){const e=Math.min(this.x,t.x),r=Math.max(this.x+this.width,t.x+t.width),s=Math.min(this.y,t.y),i=Math.max(this.y+this.height,t.y+t.height);return this.x=e,this.width=r-e,this.y=s,this.height=i-s,this}getBounds(t){return(t=t||new vt).copyFrom(this),t}}const Tt=new it;class St{constructor(t=1/0,e=1/0,r=-1/0,s=-1/0){this.minX=1/0,this.minY=1/0,this.maxX=-1/0,this.maxY=-1/0,this.matrix=Tt,this.minX=t,this.minY=e,this.maxX=r,this.maxY=s}isEmpty(){return this.minX>this.maxX||this.minY>this.maxY}get rectangle(){this._rectangle||(this._rectangle=new vt);const t=this._rectangle;return this.minX>this.maxX||this.minY>this.maxY?(t.x=0,t.y=0,t.width=0,t.height=0):t.copyFromBounds(this),t}clear(){return this.minX=1/0,this.minY=1/0,this.maxX=-1/0,this.maxY=-1/0,this.matrix=Tt,this}set(t,e,r,s){this.minX=t,this.minY=e,this.maxX=r,this.maxY=s}addFrame(t,e,r,s,i){i||(i=this.matrix);const n=i.a,o=i.b,a=i.c,l=i.d,h=i.tx,u=i.ty;let c=this.minX,d=this.minY,p=this.maxX,f=this.maxY,g=n*t+a*e+h,m=o*t+l*e+u;g<c&&(c=g),m<d&&(d=m),g>p&&(p=g),m>f&&(f=m),g=n*r+a*e+h,m=o*r+l*e+u,g<c&&(c=g),m<d&&(d=m),g>p&&(p=g),m>f&&(f=m),g=n*t+a*s+h,m=o*t+l*s+u,g<c&&(c=g),m<d&&(d=m),g>p&&(p=g),m>f&&(f=m),g=n*r+a*s+h,m=o*r+l*s+u,g<c&&(c=g),m<d&&(d=m),g>p&&(p=g),m>f&&(f=m),this.minX=c,this.minY=d,this.maxX=p,this.maxY=f}addRect(t,e){this.addFrame(t.x,t.y,t.x+t.width,t.y+t.height,e)}addBounds(t,e){this.addFrame(t.minX,t.minY,t.maxX,t.maxY,e)}addBoundsMask(t){this.minX=this.minX>t.minX?this.minX:t.minX,this.minY=this.minY>t.minY?this.minY:t.minY,this.maxX=this.maxX<t.maxX?this.maxX:t.maxX,this.maxY=this.maxY<t.maxY?this.maxY:t.maxY}applyMatrix(t){const e=this.minX,r=this.minY,s=this.maxX,i=this.maxY,{a:n,b:o,c:a,d:l,tx:h,ty:u}=t;let c=n*e+a*r+h,d=o*e+l*r+u;this.minX=c,this.minY=d,this.maxX=c,this.maxY=d,c=n*s+a*r+h,d=o*s+l*r+u,this.minX=c<this.minX?c:this.minX,this.minY=d<this.minY?d:this.minY,this.maxX=c>this.maxX?c:this.maxX,this.maxY=d>this.maxY?d:this.maxY,c=n*e+a*i+h,d=o*e+l*i+u,this.minX=c<this.minX?c:this.minX,this.minY=d<this.minY?d:this.minY,this.maxX=c>this.maxX?c:this.maxX,this.maxY=d>this.maxY?d:this.maxY,c=n*s+a*i+h,d=o*s+l*i+u,this.minX=c<this.minX?c:this.minX,this.minY=d<this.minY?d:this.minY,this.maxX=c>this.maxX?c:this.maxX,this.maxY=d>this.maxY?d:this.maxY}fit(t){return this.minX<t.left&&(this.minX=t.left),this.maxX>t.right&&(this.maxX=t.right),this.minY<t.top&&(this.minY=t.top),this.maxY>t.bottom&&(this.maxY=t.bottom),this}fitBounds(t,e,r,s){return this.minX<t&&(this.minX=t),this.maxX>e&&(this.maxX=e),this.minY<r&&(this.minY=r),this.maxY>s&&(this.maxY=s),this}pad(t,e=t){return this.minX-=t,this.maxX+=t,this.minY-=e,this.maxY+=e,this}ceil(){return this.minX=Math.floor(this.minX),this.minY=Math.floor(this.minY),this.maxX=Math.ceil(this.maxX),this.maxY=Math.ceil(this.maxY),this}clone(){return new St(this.minX,this.minY,this.maxX,this.maxY)}scale(t,e=t){return this.minX*=t,this.minY*=e,this.maxX*=t,this.maxY*=e,this}get x(){return this.minX}set x(t){const e=this.maxX-this.minX;this.minX=t,this.maxX=t+e}get y(){return this.minY}set y(t){const e=this.maxY-this.minY;this.minY=t,this.maxY=t+e}get width(){return this.maxX-this.minX}set width(t){this.maxX=this.minX+t}get height(){return this.maxY-this.minY}set height(t){this.maxY=this.minY+t}get left(){return this.minX}get right(){return this.maxX}get top(){return this.minY}get bottom(){return this.maxY}get isPositive(){return this.maxX-this.minX>0&&this.maxY-this.minY>0}get isValid(){return this.minX+this.minY!==1/0}addVertexData(t,e,r,s){let i=this.minX,n=this.minY,o=this.maxX,a=this.maxY;s||(s=this.matrix);const l=s.a,h=s.b,u=s.c,c=s.d,d=s.tx,p=s.ty;for(let s=e;s<r;s+=2){const e=t[s],r=t[s+1],f=l*e+u*r+d,g=h*e+c*r+p;i=f<i?f:i,n=g<n?g:n,o=f>o?f:o,a=g>a?g:a}this.minX=i,this.minY=n,this.maxX=o,this.maxY=a}containsPoint(t,e){return this.minX<=t&&this.minY<=e&&this.maxX>=t&&this.maxY>=e}toString(){return`[pixi.js:Bounds minX=${this.minX} minY=${this.minY} maxX=${this.maxX} maxY=${this.maxY} width=${this.width} height=${this.height}]`}}const wt=new pt(it),Et=new pt(St);function At(t,e,r){let s,i;return r.clear(),t.parent?e?s=t.parent.worldTransform:(i=wt.get().identity(),s=Pt(t,i)):s=it.IDENTITY,Mt(t,r,s,e),i&&wt.return(i),r.isValid||r.set(0,0,0,0),r}function Mt(t,e,r,s){var i,n;if(!t.visible||!t.measurable)return;let o;s?o=t.worldTransform:(t.updateLocalTransform(),o=wt.get(),o.appendFrom(t.localTransform,r));const a=e,l=!!t.effects.length;if(l&&(e=Et.get().clear()),t.boundsArea)e.addRect(t.boundsArea,o);else{t.addBounds&&(e.matrix=o,t.addBounds(e));for(let r=0;r<t.children.length;r++)Mt(t.children[r],e,o,s)}if(l){for(let r=0;r<t.effects.length;r++)null==(n=(i=t.effects[r]).addBounds)||n.call(i,e);a.addBounds(e,it.IDENTITY),Et.return(e)}s||wt.return(o)}function Pt(t,e){const r=t.parent;return r&&(Pt(r,e),r.updateLocalTransform(),e.append(r.localTransform)),e}function Rt(t,e,r){return e.clear(),r||(r=it.IDENTITY),Ot(t,e,r,t,!0),e.isValid||e.set(0,0,0,0),e}function Ot(t,e,r,s,i){var n,o;let a;if(i)a=wt.get(),a=r.copyTo(a);else{if(!t.visible||!t.measurable)return;t.updateLocalTransform();const e=t.localTransform;a=wt.get(),a.appendFrom(e,r)}const l=e,h=!!t.effects.length;if(h&&(e=Et.get().clear()),t.boundsArea)e.addRect(t.boundsArea,a);else{t.renderPipeId&&(e.matrix=a,t.addBounds(e));const r=t.children;for(let t=0;t<r.length;t++)Ot(r[t],e,a,s,!1)}if(h){for(let r=0;r<t.effects.length;r++)null==(o=(n=t.effects[r]).addLocalBounds)||o.call(n,e,s);l.addBounds(e,it.IDENTITY),Et.return(e)}wt.return(a)}function Ct(t,e){const r=t.children;for(let t=0;t<r.length;t++){const s=r[t],i=(255&s.uid)<<24|16777215&s._didChangeId;e.data[e.index]!==i&&(e.data[e.index]=i,e.didChange=!0),e.index++,s.children.length&&Ct(s,e)}return e.didChange}const It=new it,Gt={_localBoundsCacheId:-1,_localBoundsCacheData:null,_setWidth(t,e){const r=Math.sign(this.scale.x)||1;this.scale.x=0!==e?t/e*r:r},_setHeight(t,e){const r=Math.sign(this.scale.y)||1;this.scale.y=0!==e?t/e*r:r},getLocalBounds(){this._localBoundsCacheData||(this._localBoundsCacheData={data:[],index:1,didChange:!1,localBounds:new St});const t=this._localBoundsCacheData;return t.index=1,t.didChange=!1,t.data[0]!==this._didChangeId>>12&&(t.didChange=!0,t.data[0]=this._didChangeId>>12),Ct(this,t),t.didChange&&Rt(this,t.localBounds,It),t.localBounds},getBounds(t,e){return At(this,t,e||new St)}},kt={_onRender:null,set onRender(t){const e=this.renderGroup;if(!t)return this._onRender&&(null==e||e.removeOnRender(this)),void(this._onRender=null);this._onRender||null==e||e.addOnRender(this),this._onRender=t},get onRender(){return this._onRender}},Bt={_zIndex:0,sortDirty:!1,sortableChildren:!1,get zIndex(){return this._zIndex},set zIndex(t){this._zIndex!==t&&(this._zIndex=t,this.depthOfChildModified())},depthOfChildModified(){this.parent&&(this.parent.sortableChildren=!0,this.parent.sortDirty=!0),this.renderGroup&&!this.isRenderGroupRoot&&(this.renderGroup.structureDidChange=!0)},sortChildren(){this.sortDirty&&(this.sortDirty=!1,this.children.sort(Dt))}};function Dt(t,e){return t._zIndex-e._zIndex}const Ft={getGlobalPosition(t=new rt,e=!1){return this.parent?this.parent.toGlobal(this._position,t,e):(t.x=this._position.x,t.y=this._position.y),t},toGlobal(t,e,r=!1){if(!r){this.updateLocalTransform();const r=Pt(this,new it);return r.append(this.localTransform),r.apply(t,e)}return this.worldTransform.apply(t,e)},toLocal(t,e,r,s){if(e&&(t=e.toGlobal(t,r,s)),!s){this.updateLocalTransform();const e=Pt(this,new it);return e.append(this.localTransform),e.applyInverse(t,r)}return this.worldTransform.applyInverse(t,r)}};class Nt{constructor(){this.uid=ht("instructionSet"),this.instructions=[],this.instructionSize=0}reset(){this.instructionSize=0}add(t){this.instructions[this.instructionSize++]=t}log(){this.instructions.length=this.instructionSize,console.table(this.instructions,["type","action"])}}class Ut{constructor(t){this.renderPipeId="renderGroup",this.root=null,this.canBundle=!1,this.renderGroupParent=null,this.renderGroupChildren=[],this._children=[],this.worldTransform=new it,this.worldColorAlpha=4294967295,this.worldColor=16777215,this.worldAlpha=1,this.childrenToUpdate=Object.create(null),this.updateTick=0,this.childrenRenderablesToUpdate={list:[],index:0},this.structureDidChange=!0,this.instructionSet=new Nt,this._onRenderContainers=[],this.root=t,this.addChild(t)}get localTransform(){return this.root.localTransform}addRenderGroupChild(t){t.renderGroupParent&&t.renderGroupParent._removeRenderGroupChild(t),t.renderGroupParent=this,this.onChildUpdate(t.root),this.renderGroupChildren.push(t)}_removeRenderGroupChild(t){t.root.didChange&&this._removeChildFromUpdate(t.root);const e=this.renderGroupChildren.indexOf(t);e>-1&&this.renderGroupChildren.splice(e,1),t.renderGroupParent=null}addChild(t){if(this.structureDidChange=!0,t!==this.root&&(this._children.push(t),t.updateTick=-1,t.parent===this.root?t.relativeRenderGroupDepth=1:t.relativeRenderGroupDepth=t.parent.relativeRenderGroupDepth+1,t._onRender&&this.addOnRender(t)),t.renderGroup){if(t.renderGroup.root===t)return void this.addRenderGroupChild(t.renderGroup)}else t.renderGroup=this,t.didChange=!0;const e=t.children;t.isRenderGroupRoot||this.onChildUpdate(t);for(let t=0;t<e.length;t++)this.addChild(e[t])}removeChild(t){if(this.structureDidChange=!0,t._onRender&&this.removeOnRender(t),t.renderGroup.root!==t){const e=t.children;for(let t=0;t<e.length;t++)this.removeChild(e[t]);t.didChange&&t.renderGroup._removeChildFromUpdate(t),t.renderGroup=null}else this._removeRenderGroupChild(t.renderGroup);const e=this._children.indexOf(t);e>-1&&this._children.splice(e,1)}onChildUpdate(t){let e=this.childrenToUpdate[t.relativeRenderGroupDepth];e||(e=this.childrenToUpdate[t.relativeRenderGroupDepth]={index:0,list:[]}),e.list[e.index++]=t}updateRenderable(t){t.globalDisplayStatus<7||(t.didViewUpdate=!1,this.instructionSet.renderPipes[t.renderPipeId].updateRenderable(t))}onChildViewUpdate(t){this.childrenRenderablesToUpdate.list[this.childrenRenderablesToUpdate.index++]=t}_removeChildFromUpdate(t){const e=this.childrenToUpdate[t.relativeRenderGroupDepth];if(!e)return;const r=e.list.indexOf(t);r>-1&&e.list.splice(r,1),e.index--}get isRenderable(){return 7===this.root.localDisplayStatus&&this.worldAlpha>0}addOnRender(t){this._onRenderContainers.push(t)}removeOnRender(t){this._onRenderContainers.splice(this._onRenderContainers.indexOf(t),1)}runOnRender(){for(let t=0;t<this._onRenderContainers.length;t++)this._onRenderContainers[t]._onRender()}}function Lt(t,e,r={}){for(const s in e)!r[s]&&void 0!==e[s]&&(t[s]=e[s])}const Xt=new at(null),zt=new at(null),Ht=new at(null,1,1);class jt extends m{constructor(t={}){var e,r;super(),this.uid=ht("renderable"),this._updateFlags=15,this.isRenderGroupRoot=!1,this.renderGroup=null,this.didChange=!1,this.didViewUpdate=!1,this.relativeRenderGroupDepth=0,this.children=[],this.parent=null,this.includeInBuild=!0,this.measurable=!0,this.isSimple=!0,this.updateTick=-1,this.localTransform=new it,this.relativeGroupTransform=new it,this.groupTransform=this.relativeGroupTransform,this.destroyed=!1,this._position=new at(this,0,0),this._scale=Ht,this._pivot=zt,this._skew=Xt,this._cx=1,this._sx=0,this._cy=0,this._sy=1,this._rotation=0,this.localColor=16777215,this.localAlpha=1,this.groupAlpha=1,this.groupColor=16777215,this.groupColorAlpha=4294967295,this.localBlendMode="inherit",this.groupBlendMode="normal",this.localDisplayStatus=7,this.globalDisplayStatus=7,this._didChangeId=0,this._didLocalTransformChangeId=-1,Lt(this,t,{children:!0,parent:!0,effects:!0}),null==(e=t.children)||e.forEach((t=>this.addChild(t))),this.effects=[],null==(r=t.parent)||r.addChild(this)}static mixin(t){Object.defineProperties(jt.prototype,Object.getOwnPropertyDescriptors(t))}addChild(...t){if(t.length>1){for(let e=0;e<t.length;e++)this.addChild(t[e]);return t[0]}const e=t[0];return e.parent===this?(this.children.splice(this.children.indexOf(e),1),this.children.push(e),this.renderGroup&&!this.isRenderGroupRoot&&(this.renderGroup.structureDidChange=!0),e):(e.parent&&e.parent.removeChild(e),this.children.push(e),this.sortableChildren&&(this.sortDirty=!0),e.parent=this,e.didChange=!0,e.didViewUpdate=!1,e._updateFlags=15,this.renderGroup&&this.renderGroup.addChild(e),this.emit("childAdded",e,this,this.children.length-1),e.emit("added",this),0!==e._zIndex&&e.depthOfChildModified(),e)}removeChild(...t){if(t.length>1){for(let e=0;e<t.length;e++)this.removeChild(t[e]);return t[0]}const e=t[0],r=this.children.indexOf(e);return r>-1&&(this.children.splice(r,1),this.renderGroup&&this.renderGroup.removeChild(e),e.parent=null,this.emit("childRemoved",e,this,r),e.emit("removed",this)),e}_onUpdate(t){if(t&&t===this._skew&&this._updateSkew(),this._didChangeId++,!this.didChange)if(this.didChange=!0,this.isRenderGroupRoot){const t=this.renderGroup.renderGroupParent;t&&t.onChildUpdate(this)}else this.renderGroup&&this.renderGroup.onChildUpdate(this)}set isRenderGroup(t){if(this.isRenderGroupRoot&&!1===t)throw new Error("[Pixi] cannot undo a render group just yet");t&&this.enableRenderGroup()}get isRenderGroup(){return this.isRenderGroupRoot}enableRenderGroup(){if(this.renderGroup&&this.renderGroup.root===this)return;this.isRenderGroupRoot=!0;const t=this.renderGroup;if(t&&t.removeChild(this),this.renderGroup=new Ut(this),t){for(let e=0;e<t.renderGroupChildren.length;e++){const r=t.renderGroupChildren[e];let s=r.root;for(;s;){if(s===this){this.renderGroup.addRenderGroupChild(r);break}s=s.parent}}t.addRenderGroupChild(this.renderGroup)}this._updateIsSimple(),this.groupTransform=it.IDENTITY}_updateIsSimple(){this.isSimple=!this.isRenderGroupRoot&&0===this.effects.length}get worldTransform(){return this._worldTransform||(this._worldTransform=new it),this.renderGroup&&(this.isRenderGroupRoot?this._worldTransform.copyFrom(this.renderGroup.worldTransform):this._worldTransform.appendFrom(this.relativeGroupTransform,this.renderGroup.worldTransform)),this._worldTransform}get x(){return this._position.x}set x(t){this._position.x=t}get y(){return this._position.y}set y(t){this._position.y=t}get position(){return this._position}set position(t){this._position.copyFrom(t)}get rotation(){return this._rotation}set rotation(t){this._rotation!==t&&(this._rotation=t,this._onUpdate(this._skew))}get angle(){return this.rotation*tt}set angle(t){this.rotation=t*et}get pivot(){return this._pivot===zt&&(this._pivot=new at(this,0,0)),this._pivot}set pivot(t){this._pivot===zt&&(this._pivot=new at(this,0,0)),"number"==typeof t?this._pivot.set(t):this._pivot.copyFrom(t)}get skew(){return this._skew===Xt&&(this._skew=new at(this,0,0)),this._skew}set skew(t){this._skew===Xt&&(this._skew=new at(this,0,0)),this._skew.copyFrom(t)}get scale(){return this._scale===Ht&&(this._scale=new at(this,1,1)),this._scale}set scale(t){this._scale===Ht&&(this._scale=new at(this,0,0)),"number"==typeof t?this._scale.set(t):this._scale.copyFrom(t)}get width(){return Math.abs(this.scale.x*this.getLocalBounds().width)}set width(t){const e=this.getLocalBounds().width;this._setWidth(t,e)}get height(){return Math.abs(this.scale.y*this.getLocalBounds().height)}set height(t){const e=this.getLocalBounds().height;this._setHeight(t,e)}getSize(t){t||(t={});const e=this.getLocalBounds();return t.width=Math.abs(this.scale.x*e.width),t.height=Math.abs(this.scale.y*e.height),t}setSize(t,e){var r;const s=this.getLocalBounds();let i,n;"object"!=typeof t?(i=t,n=null!=e?e:t):(i=t.width,n=null!=(r=t.height)?r:t.width),void 0!==i&&this._setWidth(i,s.width),void 0!==n&&this._setHeight(n,s.height)}_updateSkew(){const t=this._rotation,e=this._skew;this._cx=Math.cos(t+e._y),this._sx=Math.sin(t+e._y),this._cy=-Math.sin(t-e._x),this._sy=Math.cos(t-e._x)}updateTransform(t){return this.position.set("number"==typeof t.x?t.x:this.position.x,"number"==typeof t.y?t.y:this.position.y),this.scale.set("number"==typeof t.scaleX?t.scaleX||1:this.scale.x,"number"==typeof t.scaleY?t.scaleY||1:this.scale.y),this.rotation="number"==typeof t.rotation?t.rotation:this.rotation,this.skew.set("number"==typeof t.skewX?t.skewX:this.skew.x,"number"==typeof t.skewY?t.skewY:this.skew.y),this.pivot.set("number"==typeof t.pivotX?t.pivotX:this.pivot.x,"number"==typeof t.pivotY?t.pivotY:this.pivot.y),this}setFromMatrix(t){t.decompose(this)}updateLocalTransform(){if((15&this._didLocalTransformChangeId)===this._didChangeId)return;this._didLocalTransformChangeId=this._didChangeId;const t=this.localTransform,e=this._scale,r=this._pivot,s=this._position,i=e._x,n=e._y,o=r._x,a=r._y;t.a=this._cx*i,t.b=this._sx*i,t.c=this._cy*n,t.d=this._sy*n,t.tx=s._x-(o*t.a+a*t.c),t.ty=s._y-(o*t.b+a*t.d)}set alpha(t){t!==this.localAlpha&&(this.localAlpha=t,this._updateFlags|=1,this._onUpdate())}get alpha(){return this.localAlpha}set tint(t){const e=Z.shared.setValue(null!=t?t:16777215).toBgrNumber();e!==this.localColor&&(this.localColor=e,this._updateFlags|=1,this._onUpdate())}get tint(){const t=this.localColor;return((255&t)<<16)+(65280&t)+(t>>16&255)}set blendMode(t){this.localBlendMode!==t&&(this.renderGroup&&!this.isRenderGroupRoot&&(this.renderGroup.structureDidChange=!0),this._updateFlags|=2,this.localBlendMode=t,this._onUpdate())}get blendMode(){return this.localBlendMode}get visible(){return!!(2&this.localDisplayStatus)}set visible(t){const e=t?1:0;(2&this.localDisplayStatus)>>1!==e&&(this.renderGroup&&!this.isRenderGroupRoot&&(this.renderGroup.structureDidChange=!0),this._updateFlags|=4,this.localDisplayStatus^=2,this._onUpdate())}get culled(){return!(4&this.localDisplayStatus)}set culled(t){const e=t?1:0;(4&this.localDisplayStatus)>>2!==e&&(this.renderGroup&&!this.isRenderGroupRoot&&(this.renderGroup.structureDidChange=!0),this._updateFlags|=4,this.localDisplayStatus^=4,this._onUpdate())}get renderable(){return!!(1&this.localDisplayStatus)}set renderable(t){const e=t?1:0;(1&this.localDisplayStatus)!==e&&(this._updateFlags|=4,this.localDisplayStatus^=1,this.renderGroup&&!this.isRenderGroupRoot&&(this.renderGroup.structureDidChange=!0),this._onUpdate())}get isRenderable(){return 7===this.localDisplayStatus&&this.groupAlpha>0}destroy(t=!1){if(this.destroyed)return;this.destroyed=!0,this.removeFromParent(),this.parent=null,this._mask=null,this._filters=null,this.effects=null,this._position=null,this._scale=null,this._pivot=null,this._skew=null,this.emit("destroyed",this),this.removeAllListeners();const e="boolean"==typeof t?t:null==t?void 0:t.children,r=this.removeChildren(0,this.children.length);if(e)for(let e=0;e<r.length;++e)r[e].destroy(t)}}jt.mixin(ct),jt.mixin(Ft),jt.mixin(kt),jt.mixin(Gt),jt.mixin(xt),jt.mixin(yt),jt.mixin(Bt),jt.mixin(Q);class Vt{constructor(t){this.bubbles=!0,this.cancelBubble=!0,this.cancelable=!1,this.composed=!1,this.defaultPrevented=!1,this.eventPhase=Vt.prototype.NONE,this.propagationStopped=!1,this.propagationImmediatelyStopped=!1,this.layer=new rt,this.page=new rt,this.NONE=0,this.CAPTURING_PHASE=1,this.AT_TARGET=2,this.BUBBLING_PHASE=3,this.manager=t}get layerX(){return this.layer.x}get layerY(){return this.layer.y}get pageX(){return this.page.x}get pageY(){return this.page.y}get data(){return this}composedPath(){return this.manager&&(!this.path||this.path[this.path.length-1]!==this.target)&&(this.path=this.target?this.manager.propagationPath(this.target):[]),this.path}initEvent(t,e,r){throw new Error("initEvent() is a legacy DOM API. It is not implemented in the Federated Events API.")}initUIEvent(t,e,r,s,i){throw new Error("initUIEvent() is a legacy DOM API. It is not implemented in the Federated Events API.")}preventDefault(){this.nativeEvent instanceof Event&&this.nativeEvent.cancelable&&this.nativeEvent.preventDefault(),this.defaultPrevented=!0}stopImmediatePropagation(){this.propagationImmediatelyStopped=!0}stopPropagation(){this.propagationStopped=!0}}var Wt,$t=/iPhone/i,Yt=/iPod/i,qt=/iPad/i,Kt=/\biOS-universal(?:.+)Mac\b/i,Zt=/\bAndroid(?:.+)Mobile\b/i,Qt=/Android/i,Jt=/(?:SD4930UR|\bSilk(?:.+)Mobile\b)/i,te=/Silk/i,ee=/Windows Phone/i,re=/\bWindows(?:.+)ARM\b/i,se=/BlackBerry/i,ie=/BB10/i,ne=/Opera Mini/i,oe=/\b(CriOS|Chrome)(?:.+)Mobile/i,ae=/Mobile(?:.+)Firefox\b/i,le=function(t){return void 0!==t&&"MacIntel"===t.platform&&"number"==typeof t.maxTouchPoints&&t.maxTouchPoints>1&&"undefined"==typeof MSStream};function he(t){var e={userAgent:"",platform:"",maxTouchPoints:0};t||"undefined"==typeof navigator?"string"==typeof t?e.userAgent=t:t&&t.userAgent&&(e={userAgent:t.userAgent,platform:t.platform,maxTouchPoints:t.maxTouchPoints||0}):e={userAgent:navigator.userAgent,platform:navigator.platform,maxTouchPoints:navigator.maxTouchPoints||0};var r=e.userAgent,s=r.split("[FBAN");void 0!==s[1]&&(r=s[0]),void 0!==(s=r.split("Twitter"))[1]&&(r=s[0]);var i=function(t){return function(e){return e.test(t)}}(r),n={apple:{phone:i($t)&&!i(ee),ipod:i(Yt),tablet:!i($t)&&(i(qt)||le(e))&&!i(ee),universal:i(Kt),device:(i($t)||i(Yt)||i(qt)||i(Kt)||le(e))&&!i(ee)},amazon:{phone:i(Jt),tablet:!i(Jt)&&i(te),device:i(Jt)||i(te)},android:{phone:!i(ee)&&i(Jt)||!i(ee)&&i(Zt),tablet:!i(ee)&&!i(Jt)&&!i(Zt)&&(i(te)||i(Qt)),device:!i(ee)&&(i(Jt)||i(te)||i(Zt)||i(Qt))||i(/\bokhttp\b/i)},windows:{phone:i(ee),tablet:i(re),device:i(ee)||i(re)},other:{blackberry:i(se),blackberry10:i(ie),opera:i(ne),firefox:i(ae),chrome:i(oe),device:i(se)||i(ie)||i(ne)||i(ae)||i(oe)},any:!1,phone:!1,tablet:!1};return n.any=n.apple.device||n.android.device||n.windows.device||n.other.device,n.phone=n.apple.phone||n.android.phone||n.windows.phone,n.tablet=n.apple.tablet||n.android.tablet||n.windows.tablet,n}const ue=(null!=(Wt=he.default)?Wt:he)(globalThis.navigator);class ce{constructor(t,e=ue){this._mobileInfo=e,this.debug=!1,this._isActive=!1,this._isMobileAccessibility=!1,this._pool=[],this._renderId=0,this._children=[],this._androidUpdateCount=0,this._androidUpdateFrequency=500,this._hookDiv=null,(e.tablet||e.phone)&&this._createTouchHook();const r=document.createElement("div");r.style.width="100px",r.style.height="100px",r.style.position="absolute",r.style.top="0px",r.style.left="0px",r.style.zIndex=2..toString(),this._div=r,this._renderer=t,this._onKeyDown=this._onKeyDown.bind(this),this._onMouseMove=this._onMouseMove.bind(this),globalThis.addEventListener("keydown",this._onKeyDown,!1)}get isActive(){return this._isActive}get isMobileAccessibility(){return this._isMobileAccessibility}get hookDiv(){return this._hookDiv}_createTouchHook(){const t=document.createElement("button");t.style.width="1px",t.style.height="1px",t.style.position="absolute",t.style.top="-1000px",t.style.left="-1000px",t.style.zIndex=2..toString(),t.style.backgroundColor="#FF0000",t.title="select to enable accessibility for this content",t.addEventListener("focus",(()=>{this._isMobileAccessibility=!0,this._activate(),this._destroyTouchHook()})),document.body.appendChild(t),this._hookDiv=t}_destroyTouchHook(){this._hookDiv&&(document.body.removeChild(this._hookDiv),this._hookDiv=null)}_activate(){var t;this._isActive||(this._isActive=!0,globalThis.document.addEventListener("mousemove",this._onMouseMove,!0),globalThis.removeEventListener("keydown",this._onKeyDown,!1),this._renderer.runners.postrender.add(this),null==(t=this._renderer.view.canvas.parentNode)||t.appendChild(this._div))}_deactivate(){var t;!this._isActive||this._isMobileAccessibility||(this._isActive=!1,globalThis.document.removeEventListener("mousemove",this._onMouseMove,!0),globalThis.addEventListener("keydown",this._onKeyDown,!1),this._renderer.runners.postrender.remove(this),null==(t=this._div.parentNode)||t.removeChild(this._div))}_updateAccessibleObjects(t){if(!t.visible||!t.accessibleChildren)return;t.accessible&&t.isInteractive()&&(t._accessibleActive||this._addChild(t),t._renderId=this._renderId);const e=t.children;if(e)for(let t=0;t<e.length;t++)this._updateAccessibleObjects(e[t])}init(t){var e;this.debug=null!=(e=null==t?void 0:t.debug)?e:this.debug,this._renderer.runners.postrender.remove(this)}postrender(){const t=performance.now();if(this._mobileInfo.android.device&&t<this._androidUpdateCount||(this._androidUpdateCount=t+this._androidUpdateFrequency,!this._renderer.renderingToScreen||!this._renderer.view.canvas))return;this._renderer.lastObjectRendered&&this._updateAccessibleObjects(this._renderer.lastObjectRendered);const{x:e,y:r,width:s,height:i}=this._renderer.view.canvas.getBoundingClientRect(),{width:n,height:o,resolution:a}=this._renderer,l=s/n*a,h=i/o*a;let u=this._div;u.style.left=`${e}px`,u.style.top=`${r}px`,u.style.width=`${n}px`,u.style.height=`${o}px`;for(let t=0;t<this._children.length;t++){const e=this._children[t];if(e._renderId!==this._renderId)e._accessibleActive=!1,ut(this._children,t,1),this._div.removeChild(e._accessibleDiv),this._pool.push(e._accessibleDiv),e._accessibleDiv=null,t--;else{u=e._accessibleDiv;let t=e.hitArea;const r=e.worldTransform;e.hitArea?(u.style.left=(r.tx+t.x*r.a)*l+"px",u.style.top=(r.ty+t.y*r.d)*h+"px",u.style.width=t.width*r.a*l+"px",u.style.height=t.height*r.d*h+"px"):(t=e.getBounds().rectangle,this._capHitArea(t),u.style.left=t.x*l+"px",u.style.top=t.y*h+"px",u.style.width=t.width*l+"px",u.style.height=t.height*h+"px",u.title!==e.accessibleTitle&&null!==e.accessibleTitle&&(u.title=e.accessibleTitle||""),u.getAttribute("aria-label")!==e.accessibleHint&&null!==e.accessibleHint&&u.setAttribute("aria-label",e.accessibleHint||"")),(e.accessibleTitle!==u.title||e.tabIndex!==u.tabIndex)&&(u.title=e.accessibleTitle||"",u.tabIndex=e.tabIndex,this.debug&&this._updateDebugHTML(u))}}this._renderId++}_updateDebugHTML(t){t.innerHTML=`type: ${t.type}</br> title : ${t.title}</br> tabIndex: ${t.tabIndex}`}_capHitArea(t){t.x<0&&(t.width+=t.x,t.x=0),t.y<0&&(t.height+=t.y,t.y=0);const{width:e,height:r}=this._renderer;t.x+t.width>e&&(t.width=e-t.x),t.y+t.height>r&&(t.height=r-t.y)}_addChild(t){let e=this._pool.pop();e||(e=document.createElement("button"),e.style.width="100px",e.style.height="100px",e.style.backgroundColor=this.debug?"rgba(255,255,255,0.5)":"transparent",e.style.position="absolute",e.style.zIndex=2..toString(),e.style.borderStyle="none",navigator.userAgent.toLowerCase().includes("chrome")?e.setAttribute("aria-live","off"):e.setAttribute("aria-live","polite"),navigator.userAgent.match(/rv:.*Gecko\//)?e.setAttribute("aria-relevant","additions"):e.setAttribute("aria-relevant","text"),e.addEventListener("click",this._onClick.bind(this)),e.addEventListener("focus",this._onFocus.bind(this)),e.addEventListener("focusout",this._onFocusOut.bind(this))),e.style.pointerEvents=t.accessiblePointerEvents,e.type=t.accessibleType,t.accessibleTitle&&null!==t.accessibleTitle?e.title=t.accessibleTitle:(!t.accessibleHint||null===t.accessibleHint)&&(e.title=`container ${t.tabIndex}`),t.accessibleHint&&null!==t.accessibleHint&&e.setAttribute("aria-label",t.accessibleHint),this.debug&&this._updateDebugHTML(e),t._accessibleActive=!0,t._accessibleDiv=e,e.container=t,this._children.push(t),this._div.appendChild(t._accessibleDiv),t._accessibleDiv.tabIndex=t.tabIndex}_dispatchEvent(t,e){const{container:r}=t.target,s=this._renderer.events.rootBoundary,i=Object.assign(new Vt(s),{target:r});s.rootTarget=this._renderer.lastObjectRendered,e.forEach((t=>s.dispatchEvent(i,t)))}_onClick(t){this._dispatchEvent(t,["click","pointertap","tap"])}_onFocus(t){t.target.getAttribute("aria-live")||t.target.setAttribute("aria-live","assertive"),this._dispatchEvent(t,["mouseover"])}_onFocusOut(t){t.target.getAttribute("aria-live")||t.target.setAttribute("aria-live","polite"),this._dispatchEvent(t,["mouseout"])}_onKeyDown(t){9===t.keyCode&&this._activate()}_onMouseMove(t){0===t.movementX&&0===t.movementY||this._deactivate()}destroy(){this._destroyTouchHook(),this._div=null,globalThis.document.removeEventListener("mousemove",this._onMouseMove,!0),globalThis.removeEventListener("keydown",this._onKeyDown),this._pool=null,this._children=null,this._renderer=null}}ce.extension={type:[u.WebGLSystem,u.WebGPUSystem],name:"accessibility"};const de={accessible:!1,accessibleTitle:null,accessibleHint:null,tabIndex:0,_accessibleActive:!1,_accessibleDiv:null,accessibleType:"button",accessiblePointerEvents:"auto",accessibleChildren:!0,_renderId:-1};p.add(ce),jt.mixin(de);class pe{static init(t){Object.defineProperty(this,"resizeTo",{set(t){globalThis.removeEventListener("resize",this.queueResize),this._resizeTo=t,t&&(globalThis.addEventListener("resize",this.queueResize),this.resize())},get(){return this._resizeTo}}),this.queueResize=()=>{this._resizeTo&&(this._cancelResize(),this._resizeId=requestAnimationFrame((()=>this.resize())))},this._cancelResize=()=>{this._resizeId&&(cancelAnimationFrame(this._resizeId),this._resizeId=null)},this.resize=()=>{if(!this._resizeTo)return;let t,e;if(this._cancelResize(),this._resizeTo===globalThis.window)t=globalThis.innerWidth,e=globalThis.innerHeight;else{const{clientWidth:r,clientHeight:s}=this._resizeTo;t=r,e=s}this.renderer.resize(t,e),this.render()},this._resizeId=null,this._resizeTo=null,this.resizeTo=t.resizeTo||null}static destroy(){globalThis.removeEventListener("resize",this.queueResize),this._cancelResize(),this._cancelResize=null,this.queueResize=null,this.resizeTo=null,this.resize=null}}pe.extension=u.Application;var fe=(t=>(t[t.INTERACTION=50]="INTERACTION",t[t.HIGH=25]="HIGH",t[t.NORMAL=0]="NORMAL",t[t.LOW=-25]="LOW",t[t.UTILITY=-50]="UTILITY",t))(fe||{});class ge{constructor(t,e=null,r=0,s=!1){this.next=null,this.previous=null,this._destroyed=!1,this._fn=t,this._context=e,this.priority=r,this._once=s}match(t,e=null){return this._fn===t&&this._context===e}emit(t){this._fn&&(this._context?this._fn.call(this._context,t):this._fn(t));const e=this.next;return this._once&&this.destroy(!0),this._destroyed&&(this.next=null),e}connect(t){this.previous=t,t.next&&(t.next.previous=this),this.next=t.next,t.next=this}destroy(t=!1){this._destroyed=!0,this._fn=null,this._context=null,this.previous&&(this.previous.next=this.next),this.next&&(this.next.previous=this.previous);const e=this.next;return this.next=t?null:e,this.previous=null,e}}const me=class t{constructor(){this.autoStart=!1,this.deltaTime=1,this.lastTime=-1,this.speed=1,this.started=!1,this._requestId=null,this._maxElapsedMS=100,this._minElapsedMS=0,this._protected=!1,this._lastFrame=-1,this._head=new ge(null,null,1/0),this.deltaMS=1/t.targetFPMS,this.elapsedMS=1/t.targetFPMS,this._tick=t=>{this._requestId=null,this.started&&(this.update(t),this.started&&null===this._requestId&&this._head.next&&(this._requestId=requestAnimationFrame(this._tick)))}}_requestIfNeeded(){null===this._requestId&&this._head.next&&(this.lastTime=performance.now(),this._lastFrame=this.lastTime,this._requestId=requestAnimationFrame(this._tick))}_cancelIfNeeded(){null!==this._requestId&&(cancelAnimationFrame(this._requestId),this._requestId=null)}_startIfPossible(){this.started?this._requestIfNeeded():this.autoStart&&this.start()}add(t,e,r=fe.NORMAL){return this._addListener(new ge(t,e,r))}addOnce(t,e,r=fe.NORMAL){return this._addListener(new ge(t,e,r,!0))}_addListener(t){let e=this._head.next,r=this._head;if(e){for(;e;){if(t.priority>e.priority){t.connect(r);break}r=e,e=e.next}t.previous||t.connect(r)}else t.connect(r);return this._startIfPossible(),this}remove(t,e){let r=this._head.next;for(;r;)r=r.match(t,e)?r.destroy():r.next;return this._head.next||this._cancelIfNeeded(),this}get count(){if(!this._head)return 0;let t=0,e=this._head;for(;e=e.next;)t++;return t}start(){this.started||(this.started=!0,this._requestIfNeeded())}stop(){this.started&&(this.started=!1,this._cancelIfNeeded())}destroy(){if(!this._protected){this.stop();let t=this._head.next;for(;t;)t=t.destroy(!0);this._head.destroy(),this._head=null}}update(e=performance.now()){let r;if(e>this.lastTime){if(r=this.elapsedMS=e-this.lastTime,r>this._maxElapsedMS&&(r=this._maxElapsedMS),r*=this.speed,this._minElapsedMS){const t=e-this._lastFrame|0;if(t<this._minElapsedMS)return;this._lastFrame=e-t%this._minElapsedMS}this.deltaMS=r,this.deltaTime=this.deltaMS*t.targetFPMS;const s=this._head;let i=s.next;for(;i;)i=i.emit(this);s.next||this._cancelIfNeeded()}else this.deltaTime=this.deltaMS=this.elapsedMS=0;this.lastTime=e}get FPS(){return 1e3/this.elapsedMS}get minFPS(){return 1e3/this._maxElapsedMS}set minFPS(e){const r=Math.min(this.maxFPS,e),s=Math.min(Math.max(0,r)/1e3,t.targetFPMS);this._maxElapsedMS=1/s}get maxFPS(){return this._minElapsedMS?Math.round(1e3/this._minElapsedMS):0}set maxFPS(t){if(0===t)this._minElapsedMS=0;else{const e=Math.max(this.minFPS,t);this._minElapsedMS=1/(e/1e3)}}static get shared(){if(!t._shared){const e=t._shared=new t;e.autoStart=!0,e._protected=!0}return t._shared}static get system(){if(!t._system){const e=t._system=new t;e.autoStart=!0,e._protected=!0}return t._system}};me.targetFPMS=.06;let _e=me;class xe{static init(t){t=Object.assign({autoStart:!0,sharedTicker:!1},t),Object.defineProperty(this,"ticker",{set(t){this._ticker&&this._ticker.remove(this.render,this),this._ticker=t,t&&t.add(this.render,this,fe.LOW)},get(){return this._ticker}}),this.stop=()=>{this._ticker.stop()},this.start=()=>{this._ticker.start()},this._ticker=null,this.ticker=t.sharedTicker?_e.shared:new _e,t.autoStart&&this.start()}static destroy(){if(this._ticker){const t=this._ticker;this.ticker=null,t.destroy()}}}xe.extension=u.Application,p.add(pe),p.add(xe);const ye=new class{constructor(){this.interactionFrequency=10,this._deltaTime=0,this._didMove=!1,this._tickerAdded=!1,this._pauseUpdate=!0}init(t){this.removeTickerListener(),this.events=t,this.interactionFrequency=10,this._deltaTime=0,this._didMove=!1,this._tickerAdded=!1,this._pauseUpdate=!0}get pauseUpdate(){return this._pauseUpdate}set pauseUpdate(t){this._pauseUpdate=t}addTickerListener(){this._tickerAdded||!this.domElement||(_e.system.add(this._tickerUpdate,this,fe.INTERACTION),this._tickerAdded=!0)}removeTickerListener(){this._tickerAdded&&(_e.system.remove(this._tickerUpdate,this),this._tickerAdded=!1)}pointerMoved(){this._didMove=!0}_update(){if(!this.domElement||this._pauseUpdate)return;if(this._didMove)return void(this._didMove=!1);const t=this.events._rootPointerEvent;this.events.supportsTouchEvents&&"touch"===t.pointerType||globalThis.document.dispatchEvent(new PointerEvent("pointermove",{clientX:t.clientX,clientY:t.clientY}))}_tickerUpdate(t){this._deltaTime+=t.deltaTime,!(this._deltaTime<this.interactionFrequency)&&(this._deltaTime=0,this._update())}};class be extends Vt{constructor(){super(...arguments),this.client=new rt,this.movement=new rt,this.offset=new rt,this.global=new rt,this.screen=new rt}get clientX(){return this.client.x}get clientY(){return this.client.y}get x(){return this.clientX}get y(){return this.clientY}get movementX(){return this.movement.x}get movementY(){return this.movement.y}get offsetX(){return this.offset.x}get offsetY(){return this.offset.y}get globalX(){return this.global.x}get globalY(){return this.global.y}get screenX(){return this.screen.x}get screenY(){return this.screen.y}getLocalPosition(t,e,r){return t.worldTransform.applyInverse(r||this.global,e)}getModifierState(t){return"getModifierState"in this.nativeEvent&&this.nativeEvent.getModifierState(t)}initMouseEvent(t,e,r,s,i,n,o,a,l,h,u,c,d,p,f){throw new Error("Method not implemented.")}}class ve extends be{constructor(){super(...arguments),this.width=0,this.height=0,this.isPrimary=!1}getCoalescedEvents(){return"pointermove"===this.type||"mousemove"===this.type||"touchmove"===this.type?[this]:[]}getPredictedEvents(){throw new Error("getPredictedEvents is not supported!")}}class Te extends be{constructor(){super(...arguments),this.DOM_DELTA_PIXEL=0,this.DOM_DELTA_LINE=1,this.DOM_DELTA_PAGE=2}}Te.DOM_DELTA_PIXEL=0,Te.DOM_DELTA_LINE=1,Te.DOM_DELTA_PAGE=2;const Se=new rt,we=new rt;class Ee{constructor(t){this.dispatch=new m,this.moveOnAll=!1,this.enableGlobalMoveEvents=!0,this.mappingState={trackingData:{}},this.eventPool=new Map,this._allInteractiveElements=[],this._hitElements=[],this._isPointerMoveEvent=!1,this.rootTarget=t,this.hitPruneFn=this.hitPruneFn.bind(this),this.hitTestFn=this.hitTestFn.bind(this),this.mapPointerDown=this.mapPointerDown.bind(this),this.mapPointerMove=this.mapPointerMove.bind(this),this.mapPointerOut=this.mapPointerOut.bind(this),this.mapPointerOver=this.mapPointerOver.bind(this),this.mapPointerUp=this.mapPointerUp.bind(this),this.mapPointerUpOutside=this.mapPointerUpOutside.bind(this),this.mapWheel=this.mapWheel.bind(this),this.mappingTable={},this.addEventMapping("pointerdown",this.mapPointerDown),this.addEventMapping("pointermove",this.mapPointerMove),this.addEventMapping("pointerout",this.mapPointerOut),this.addEventMapping("pointerleave",this.mapPointerOut),this.addEventMapping("pointerover",this.mapPointerOver),this.addEventMapping("pointerup",this.mapPointerUp),this.addEventMapping("pointerupoutside",this.mapPointerUpOutside),this.addEventMapping("wheel",this.mapWheel)}addEventMapping(t,e){this.mappingTable[t]||(this.mappingTable[t]=[]),this.mappingTable[t].push({fn:e,priority:0}),this.mappingTable[t].sort(((t,e)=>t.priority-e.priority))}dispatchEvent(t,e){t.propagationStopped=!1,t.propagationImmediatelyStopped=!1,this.propagate(t,e),this.dispatch.emit(e||t.type,t)}mapEvent(t){if(!this.rootTarget)return;const e=this.mappingTable[t.type];if(e)for(let r=0,s=e.length;r<s;r++)e[r].fn(t)}hitTest(t,e){ye.pauseUpdate=!0;const r=this[this._isPointerMoveEvent&&this.enableGlobalMoveEvents?"hitTestMoveRecursive":"hitTestRecursive"](this.rootTarget,this.rootTarget.eventMode,Se.set(t,e),this.hitTestFn,this.hitPruneFn);return r&&r[0]}propagate(t,e){if(!t.target)return;const r=t.composedPath();t.eventPhase=t.CAPTURING_PHASE;for(let s=0,i=r.length-1;s<i;s++)if(t.currentTarget=r[s],this.notifyTarget(t,e),t.propagationStopped||t.propagationImmediatelyStopped)return;if(t.eventPhase=t.AT_TARGET,t.currentTarget=t.target,this.notifyTarget(t,e),!t.propagationStopped&&!t.propagationImmediatelyStopped){t.eventPhase=t.BUBBLING_PHASE;for(let s=r.length-2;s>=0;s--)if(t.currentTarget=r[s],this.notifyTarget(t,e),t.propagationStopped||t.propagationImmediatelyStopped)return}}all(t,e,r=this._allInteractiveElements){if(0===r.length)return;t.eventPhase=t.BUBBLING_PHASE;const s=Array.isArray(e)?e:[e];for(let e=r.length-1;e>=0;e--)s.forEach((s=>{t.currentTarget=r[e],this.notifyTarget(t,s)}))}propagationPath(t){const e=[t];for(let r=0;r<2048&&t!==this.rootTarget&&t.parent;r++){if(!t.parent)throw new Error("Cannot find propagation path to disconnected target");e.push(t.parent),t=t.parent}return e.reverse(),e}hitTestMoveRecursive(t,e,r,s,i,n=!1){let o=!1;if(this._interactivePrune(t))return null;if(("dynamic"===t.eventMode||"dynamic"===e)&&(ye.pauseUpdate=!1),t.interactiveChildren&&t.children){const a=t.children;for(let l=a.length-1;l>=0;l--){const h=a[l],u=this.hitTestMoveRecursive(h,this._isInteractive(e)?e:h.eventMode,r,s,i,n||i(t,r));if(u){if(u.length>0&&!u[u.length-1].parent)continue;const e=t.isInteractive();(u.length>0||e)&&(e&&this._allInteractiveElements.push(t),u.push(t)),0===this._hitElements.length&&(this._hitElements=u),o=!0}}}const a=this._isInteractive(e),l=t.isInteractive();return l&&l&&this._allInteractiveElements.push(t),n||this._hitElements.length>0?null:o?this._hitElements:a&&!i(t,r)&&s(t,r)?l?[t]:[]:null}hitTestRecursive(t,e,r,s,i){if(this._interactivePrune(t)||i(t,r))return null;if(("dynamic"===t.eventMode||"dynamic"===e)&&(ye.pauseUpdate=!1),t.interactiveChildren&&t.children){const n=t.children,o=r;for(let r=n.length-1;r>=0;r--){const a=n[r],l=this.hitTestRecursive(a,this._isInteractive(e)?e:a.eventMode,o,s,i);if(l){if(l.length>0&&!l[l.length-1].parent)continue;const e=t.isInteractive();return(l.length>0||e)&&l.push(t),l}}}const n=this._isInteractive(e),o=t.isInteractive();return n&&s(t,r)?o?[t]:[]:null}_isInteractive(t){return"static"===t||"dynamic"===t}_interactivePrune(t){return!t||!t.visible||!t.renderable||"none"===t.eventMode||"passive"===t.eventMode&&!t.interactiveChildren}hitPruneFn(t,e){if(t.hitArea&&(t.worldTransform.applyInverse(e,we),!t.hitArea.contains(we.x,we.y)))return!0;if(t.effects&&t.effects.length)for(let r=0;r<t.effects.length;r++){const s=t.effects[r];if(s.containsPoint&&!s.containsPoint(e,this.hitTestFn))return!0}return!1}hitTestFn(t,e){return!!t.hitArea||!(null==t||!t.containsPoint)&&(t.worldTransform.applyInverse(e,we),t.containsPoint(we))}notifyTarget(t,e){var r,s;const i=`on${e=null!=e?e:t.type}`;null==(s=(r=t.currentTarget)[i])||s.call(r,t);const n=t.eventPhase===t.CAPTURING_PHASE||t.eventPhase===t.AT_TARGET?`${e}capture`:e;this._notifyListeners(t,n),t.eventPhase===t.AT_TARGET&&this._notifyListeners(t,e)}mapPointerDown(t){if(!(t instanceof ve))return;const e=this.createPointerEvent(t);if(this.dispatchEvent(e,"pointerdown"),"touch"===e.pointerType)this.dispatchEvent(e,"touchstart");else if("mouse"===e.pointerType||"pen"===e.pointerType){const t=2===e.button;this.dispatchEvent(e,t?"rightdown":"mousedown")}this.trackingData(t.pointerId).pressTargetsByButton[t.button]=e.composedPath(),this.freeEvent(e)}mapPointerMove(t){var e,r,s;if(!(t instanceof ve))return;this._allInteractiveElements.length=0,this._hitElements.length=0,this._isPointerMoveEvent=!0;const i=this.createPointerEvent(t);this._isPointerMoveEvent=!1;const n="mouse"===i.pointerType||"pen"===i.pointerType,o=this.trackingData(t.pointerId),a=this.findMountedTarget(o.overTargets);if((null==(e=o.overTargets)?void 0:e.length)>0&&a!==i.target){const e="mousemove"===t.type?"mouseout":"pointerout",r=this.createPointerEvent(t,e,a);if(this.dispatchEvent(r,"pointerout"),n&&this.dispatchEvent(r,"mouseout"),!i.composedPath().includes(a)){const e=this.createPointerEvent(t,"pointerleave",a);for(e.eventPhase=e.AT_TARGET;e.target&&!i.composedPath().includes(e.target);)e.currentTarget=e.target,this.notifyTarget(e),n&&this.notifyTarget(e,"mouseleave"),e.target=e.target.parent;this.freeEvent(e)}this.freeEvent(r)}if(a!==i.target){const e="mousemove"===t.type?"mouseover":"pointerover",r=this.clonePointerEvent(i,e);this.dispatchEvent(r,"pointerover"),n&&this.dispatchEvent(r,"mouseover");let s=null==a?void 0:a.parent;for(;s&&s!==this.rootTarget.parent&&s!==i.target;)s=s.parent;if(!s||s===this.rootTarget.parent){const t=this.clonePointerEvent(i,"pointerenter");for(t.eventPhase=t.AT_TARGET;t.target&&t.target!==a&&t.target!==this.rootTarget.parent;)t.currentTarget=t.target,this.notifyTarget(t),n&&this.notifyTarget(t,"mouseenter"),t.target=t.target.parent;this.freeEvent(t)}this.freeEvent(r)}const l=[],h=null==(r=this.enableGlobalMoveEvents)||r;this.moveOnAll?l.push("pointermove"):this.dispatchEvent(i,"pointermove"),h&&l.push("globalpointermove"),"touch"===i.pointerType&&(this.moveOnAll?l.splice(1,0,"touchmove"):this.dispatchEvent(i,"touchmove"),h&&l.push("globaltouchmove")),n&&(this.moveOnAll?l.splice(1,0,"mousemove"):this.dispatchEvent(i,"mousemove"),h&&l.push("globalmousemove"),this.cursor=null==(s=i.target)?void 0:s.cursor),l.length>0&&this.all(i,l),this._allInteractiveElements.length=0,this._hitElements.length=0,o.overTargets=i.composedPath(),this.freeEvent(i)}mapPointerOver(t){var e;if(!(t instanceof ve))return;const r=this.trackingData(t.pointerId),s=this.createPointerEvent(t),i="mouse"===s.pointerType||"pen"===s.pointerType;this.dispatchEvent(s,"pointerover"),i&&this.dispatchEvent(s,"mouseover"),"mouse"===s.pointerType&&(this.cursor=null==(e=s.target)?void 0:e.cursor);const n=this.clonePointerEvent(s,"pointerenter");for(n.eventPhase=n.AT_TARGET;n.target&&n.target!==this.rootTarget.parent;)n.currentTarget=n.target,this.notifyTarget(n),i&&this.notifyTarget(n,"mouseenter"),n.target=n.target.parent;r.overTargets=s.composedPath(),this.freeEvent(s),this.freeEvent(n)}mapPointerOut(t){if(!(t instanceof ve))return;const e=this.trackingData(t.pointerId);if(e.overTargets){const r="mouse"===t.pointerType||"pen"===t.pointerType,s=this.findMountedTarget(e.overTargets),i=this.createPointerEvent(t,"pointerout",s);this.dispatchEvent(i),r&&this.dispatchEvent(i,"mouseout");const n=this.createPointerEvent(t,"pointerleave",s);for(n.eventPhase=n.AT_TARGET;n.target&&n.target!==this.rootTarget.parent;)n.currentTarget=n.target,this.notifyTarget(n),r&&this.notifyTarget(n,"mouseleave"),n.target=n.target.parent;e.overTargets=null,this.freeEvent(i),this.freeEvent(n)}this.cursor=null}mapPointerUp(t){if(!(t instanceof ve))return;const e=performance.now(),r=this.createPointerEvent(t);if(this.dispatchEvent(r,"pointerup"),"touch"===r.pointerType)this.dispatchEvent(r,"touchend");else if("mouse"===r.pointerType||"pen"===r.pointerType){const t=2===r.button;this.dispatchEvent(r,t?"rightup":"mouseup")}const s=this.trackingData(t.pointerId),i=this.findMountedTarget(s.pressTargetsByButton[t.button]);let n=i;if(i&&!r.composedPath().includes(i)){let e=i;for(;e&&!r.composedPath().includes(e);){if(r.currentTarget=e,this.notifyTarget(r,"pointerupoutside"),"touch"===r.pointerType)this.notifyTarget(r,"touchendoutside");else if("mouse"===r.pointerType||"pen"===r.pointerType){const t=2===r.button;this.notifyTarget(r,t?"rightupoutside":"mouseupoutside")}e=e.parent}delete s.pressTargetsByButton[t.button],n=e}if(n){const i=this.clonePointerEvent(r,"click");i.target=n,i.path=null,s.clicksByButton[t.button]||(s.clicksByButton[t.button]={clickCount:0,target:i.target,timeStamp:e});const o=s.clicksByButton[t.button];if(o.target===i.target&&e-o.timeStamp<200?++o.clickCount:o.clickCount=1,o.target=i.target,o.timeStamp=e,i.detail=o.clickCount,"mouse"===i.pointerType){const t=2===i.button;this.dispatchEvent(i,t?"rightclick":"click")}else"touch"===i.pointerType&&this.dispatchEvent(i,"tap");this.dispatchEvent(i,"pointertap"),this.freeEvent(i)}this.freeEvent(r)}mapPointerUpOutside(t){if(!(t instanceof ve))return;const e=this.trackingData(t.pointerId),r=this.findMountedTarget(e.pressTargetsByButton[t.button]),s=this.createPointerEvent(t);if(r){let i=r;for(;i;)s.currentTarget=i,this.notifyTarget(s,"pointerupoutside"),"touch"===s.pointerType?this.notifyTarget(s,"touchendoutside"):("mouse"===s.pointerType||"pen"===s.pointerType)&&this.notifyTarget(s,2===s.button?"rightupoutside":"mouseupoutside"),i=i.parent;delete e.pressTargetsByButton[t.button]}this.freeEvent(s)}mapWheel(t){if(!(t instanceof Te))return;const e=this.createWheelEvent(t);this.dispatchEvent(e),this.freeEvent(e)}findMountedTarget(t){if(!t)return null;let e=t[0];for(let r=1;r<t.length&&t[r].parent===e;r++)e=t[r];return e}createPointerEvent(t,e,r){var s;const i=this.allocateEvent(ve);return this.copyPointerData(t,i),this.copyMouseData(t,i),this.copyData(t,i),i.nativeEvent=t.nativeEvent,i.originalEvent=t,i.target=null!=(s=null!=r?r:this.hitTest(i.global.x,i.global.y))?s:this._hitElements[0],"string"==typeof e&&(i.type=e),i}createWheelEvent(t){const e=this.allocateEvent(Te);return this.copyWheelData(t,e),this.copyMouseData(t,e),this.copyData(t,e),e.nativeEvent=t.nativeEvent,e.originalEvent=t,e.target=this.hitTest(e.global.x,e.global.y),e}clonePointerEvent(t,e){const r=this.allocateEvent(ve);return r.nativeEvent=t.nativeEvent,r.originalEvent=t.originalEvent,this.copyPointerData(t,r),this.copyMouseData(t,r),this.copyData(t,r),r.target=t.target,r.path=t.composedPath().slice(),r.type=null!=e?e:r.type,r}copyWheelData(t,e){e.deltaMode=t.deltaMode,e.deltaX=t.deltaX,e.deltaY=t.deltaY,e.deltaZ=t.deltaZ}copyPointerData(t,e){t instanceof ve&&e instanceof ve&&(e.pointerId=t.pointerId,e.width=t.width,e.height=t.height,e.isPrimary=t.isPrimary,e.pointerType=t.pointerType,e.pressure=t.pressure,e.tangentialPressure=t.tangentialPressure,e.tiltX=t.tiltX,e.tiltY=t.tiltY,e.twist=t.twist)}copyMouseData(t,e){t instanceof be&&e instanceof be&&(e.altKey=t.altKey,e.button=t.button,e.buttons=t.buttons,e.client.copyFrom(t.client),e.ctrlKey=t.ctrlKey,e.metaKey=t.metaKey,e.movement.copyFrom(t.movement),e.screen.copyFrom(t.screen),e.shiftKey=t.shiftKey,e.global.copyFrom(t.global))}copyData(t,e){e.isTrusted=t.isTrusted,e.srcElement=t.srcElement,e.timeStamp=performance.now(),e.type=t.type,e.detail=t.detail,e.view=t.view,e.which=t.which,e.layer.copyFrom(t.layer),e.page.copyFrom(t.page)}trackingData(t){return this.mappingState.trackingData[t]||(this.mappingState.trackingData[t]={pressTargetsByButton:{},clicksByButton:{},overTarget:null}),this.mappingState.trackingData[t]}allocateEvent(t){this.eventPool.has(t)||this.eventPool.set(t,[]);const e=this.eventPool.get(t).pop()||new t(this);return e.eventPhase=e.NONE,e.currentTarget=null,e.path=null,e.target=null,e}freeEvent(t){if(t.manager!==this)throw new Error("It is illegal to free an event not managed by this EventBoundary!");const e=t.constructor;this.eventPool.has(e)||this.eventPool.set(e,[]),this.eventPool.get(e).push(t)}_notifyListeners(t,e){const r=t.currentTarget._events[e];if(r&&t.currentTarget.isInteractive())if("fn"in r)r.once&&t.currentTarget.removeListener(e,r.fn,void 0,!0),r.fn.call(r.context,t);else for(let s=0,i=r.length;s<i&&!t.propagationImmediatelyStopped;s++)r[s].once&&t.currentTarget.removeListener(e,r[s].fn,void 0,!0),r[s].fn.call(r[s].context,t)}}var Ae=Object.defineProperty,Me=Object.getOwnPropertySymbols,Pe=Object.prototype.hasOwnProperty,Re=Object.prototype.propertyIsEnumerable,Oe=(t,e,r)=>e in t?Ae(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r;const Ce={touchstart:"pointerdown",touchend:"pointerup",touchendoutside:"pointerupoutside",touchmove:"pointermove",touchcancel:"pointercancel"},Ie=class t{constructor(e){this.supportsTouchEvents="ontouchstart"in globalThis,this.supportsPointerEvents=!!globalThis.PointerEvent,this.domElement=null,this.resolution=1,this.renderer=e,this.rootBoundary=new Ee(null),ye.init(this),this.autoPreventDefault=!0,this._eventsAdded=!1,this._rootPointerEvent=new ve(null),this._rootWheelEvent=new Te(null),this.cursorStyles={default:"inherit",pointer:"pointer"},this.features=new Proxy(((t,e)=>{for(var r in e||(e={}))Pe.call(e,r)&&Oe(t,r,e[r]);if(Me)for(var r of Me(e))Re.call(e,r)&&Oe(t,r,e[r]);return t})({},t.defaultEventFeatures),{set:(t,e,r)=>("globalMove"===e&&(this.rootBoundary.enableGlobalMoveEvents=r),t[e]=r,!0)}),this._onPointerDown=this._onPointerDown.bind(this),this._onPointerMove=this._onPointerMove.bind(this),this._onPointerUp=this._onPointerUp.bind(this),this._onPointerOverOut=this._onPointerOverOut.bind(this),this.onWheel=this.onWheel.bind(this)}static get defaultEventMode(){return this._defaultEventMode}init(e){var r,s;const{canvas:i,resolution:n}=this.renderer;this.setTargetElement(i),this.resolution=n,t._defaultEventMode=null!=(r=e.eventMode)?r:"passive",Object.assign(this.features,null!=(s=e.eventFeatures)?s:{}),this.rootBoundary.enableGlobalMoveEvents=this.features.globalMove}resolutionChange(t){this.resolution=t}destroy(){this.setTargetElement(null),this.renderer=null,this._currentCursor=null}setCursor(t){t=t||"default";let e=!0;if(globalThis.OffscreenCanvas&&this.domElement instanceof OffscreenCanvas&&(e=!1),this._currentCursor===t)return;this._currentCursor=t;const r=this.cursorStyles[t];if(r)switch(typeof r){case"string":e&&(this.domElement.style.cursor=r);break;case"function":r(t);break;case"object":e&&Object.assign(this.domElement.style,r)}else e&&"string"==typeof t&&!Object.prototype.hasOwnProperty.call(this.cursorStyles,t)&&(this.domElement.style.cursor=t)}get pointer(){return this._rootPointerEvent}_onPointerDown(t){if(!this.features.click)return;this.rootBoundary.rootTarget=this.renderer.lastObjectRendered;const e=this._normalizeToPointerData(t);this.autoPreventDefault&&e[0].isNormalized&&(t.cancelable||!("cancelable"in t))&&t.preventDefault();for(let t=0,r=e.length;t<r;t++){const r=e[t],s=this._bootstrapEvent(this._rootPointerEvent,r);this.rootBoundary.mapEvent(s)}this.setCursor(this.rootBoundary.cursor)}_onPointerMove(t){if(!this.features.move)return;this.rootBoundary.rootTarget=this.renderer.lastObjectRendered,ye.pointerMoved();const e=this._normalizeToPointerData(t);for(let t=0,r=e.length;t<r;t++){const r=this._bootstrapEvent(this._rootPointerEvent,e[t]);this.rootBoundary.mapEvent(r)}this.setCursor(this.rootBoundary.cursor)}_onPointerUp(t){if(!this.features.click)return;this.rootBoundary.rootTarget=this.renderer.lastObjectRendered;let e=t.target;t.composedPath&&t.composedPath().length>0&&(e=t.composedPath()[0]);const r=e!==this.domElement?"outside":"",s=this._normalizeToPointerData(t);for(let t=0,e=s.length;t<e;t++){const e=this._bootstrapEvent(this._rootPointerEvent,s[t]);e.type+=r,this.rootBoundary.mapEvent(e)}this.setCursor(this.rootBoundary.cursor)}_onPointerOverOut(t){if(!this.features.click)return;this.rootBoundary.rootTarget=this.renderer.lastObjectRendered;const e=this._normalizeToPointerData(t);for(let t=0,r=e.length;t<r;t++){const r=this._bootstrapEvent(this._rootPointerEvent,e[t]);this.rootBoundary.mapEvent(r)}this.setCursor(this.rootBoundary.cursor)}onWheel(t){if(!this.features.wheel)return;const e=this.normalizeWheelEvent(t);this.rootBoundary.rootTarget=this.renderer.lastObjectRendered,this.rootBoundary.mapEvent(e)}setTargetElement(t){this._removeEvents(),this.domElement=t,ye.domElement=t,this._addEvents()}_addEvents(){if(this._eventsAdded||!this.domElement)return;ye.addTickerListener();const t=this.domElement.style;t&&(globalThis.navigator.msPointerEnabled?(t.msContentZooming="none",t.msTouchAction="none"):this.supportsPointerEvents&&(t.touchAction="none")),this.supportsPointerEvents?(globalThis.document.addEventListener("pointermove",this._onPointerMove,!0),this.domElement.addEventListener("pointerdown",this._onPointerDown,!0),this.domElement.addEventListener("pointerleave",this._onPointerOverOut,!0),this.domElement.addEventListener("pointerover",this._onPointerOverOut,!0),globalThis.addEventListener("pointerup",this._onPointerUp,!0)):(globalThis.document.addEventListener("mousemove",this._onPointerMove,!0),this.domElement.addEventListener("mousedown",this._onPointerDown,!0),this.domElement.addEventListener("mouseout",this._onPointerOverOut,!0),this.domElement.addEventListener("mouseover",this._onPointerOverOut,!0),globalThis.addEventListener("mouseup",this._onPointerUp,!0),this.supportsTouchEvents&&(this.domElement.addEventListener("touchstart",this._onPointerDown,!0),this.domElement.addEventListener("touchend",this._onPointerUp,!0),this.domElement.addEventListener("touchmove",this._onPointerMove,!0))),this.domElement.addEventListener("wheel",this.onWheel,{passive:!0,capture:!0}),this._eventsAdded=!0}_removeEvents(){if(!this._eventsAdded||!this.domElement)return;ye.removeTickerListener();const t=this.domElement.style;t&&(globalThis.navigator.msPointerEnabled?(t.msContentZooming="",t.msTouchAction=""):this.supportsPointerEvents&&(t.touchAction="")),this.supportsPointerEvents?(globalThis.document.removeEventListener("pointermove",this._onPointerMove,!0),this.domElement.removeEventListener("pointerdown",this._onPointerDown,!0),this.domElement.removeEventListener("pointerleave",this._onPointerOverOut,!0),this.domElement.removeEventListener("pointerover",this._onPointerOverOut,!0),globalThis.removeEventListener("pointerup",this._onPointerUp,!0)):(globalThis.document.removeEventListener("mousemove",this._onPointerMove,!0),this.domElement.removeEventListener("mousedown",this._onPointerDown,!0),this.domElement.removeEventListener("mouseout",this._onPointerOverOut,!0),this.domElement.removeEventListener("mouseover",this._onPointerOverOut,!0),globalThis.removeEventListener("mouseup",this._onPointerUp,!0),this.supportsTouchEvents&&(this.domElement.removeEventListener("touchstart",this._onPointerDown,!0),this.domElement.removeEventListener("touchend",this._onPointerUp,!0),this.domElement.removeEventListener("touchmove",this._onPointerMove,!0))),this.domElement.removeEventListener("wheel",this.onWheel,!0),this.domElement=null,this._eventsAdded=!1}mapPositionToPoint(t,e,r){const s=this.domElement.isConnected?this.domElement.getBoundingClientRect():{x:0,y:0,width:this.domElement.width,height:this.domElement.height,left:0,top:0},i=1/this.resolution;t.x=(e-s.left)*(this.domElement.width/s.width)*i,t.y=(r-s.top)*(this.domElement.height/s.height)*i}_normalizeToPointerData(t){const e=[];if(this.supportsTouchEvents&&t instanceof TouchEvent)for(let r=0,s=t.changedTouches.length;r<s;r++){const s=t.changedTouches[r];void 0===s.button&&(s.button=0),void 0===s.buttons&&(s.buttons=1),void 0===s.isPrimary&&(s.isPrimary=1===t.touches.length&&"touchstart"===t.type),void 0===s.width&&(s.width=s.radiusX||1),void 0===s.height&&(s.height=s.radiusY||1),void 0===s.tiltX&&(s.tiltX=0),void 0===s.tiltY&&(s.tiltY=0),void 0===s.pointerType&&(s.pointerType="touch"),void 0===s.pointerId&&(s.pointerId=s.identifier||0),void 0===s.pressure&&(s.pressure=s.force||.5),void 0===s.twist&&(s.twist=0),void 0===s.tangentialPressure&&(s.tangentialPressure=0),void 0===s.layerX&&(s.layerX=s.offsetX=s.clientX),void 0===s.layerY&&(s.layerY=s.offsetY=s.clientY),s.isNormalized=!0,s.type=t.type,e.push(s)}else if(globalThis.MouseEvent&&(!(t instanceof MouseEvent)||this.supportsPointerEvents&&t instanceof globalThis.PointerEvent))e.push(t);else{const r=t;void 0===r.isPrimary&&(r.isPrimary=!0),void 0===r.width&&(r.width=1),void 0===r.height&&(r.height=1),void 0===r.tiltX&&(r.tiltX=0),void 0===r.tiltY&&(r.tiltY=0),void 0===r.pointerType&&(r.pointerType="mouse"),void 0===r.pointerId&&(r.pointerId=1),void 0===r.pressure&&(r.pressure=.5),void 0===r.twist&&(r.twist=0),void 0===r.tangentialPressure&&(r.tangentialPressure=0),r.isNormalized=!0,e.push(r)}return e}normalizeWheelEvent(t){const e=this._rootWheelEvent;return this._transferMouseData(e,t),e.deltaX=t.deltaX,e.deltaY=t.deltaY,e.deltaZ=t.deltaZ,e.deltaMode=t.deltaMode,this.mapPositionToPoint(e.screen,t.clientX,t.clientY),e.global.copyFrom(e.screen),e.offset.copyFrom(e.screen),e.nativeEvent=t,e.type=t.type,e}_bootstrapEvent(t,e){return t.originalEvent=null,t.nativeEvent=e,t.pointerId=e.pointerId,t.width=e.width,t.height=e.height,t.isPrimary=e.isPrimary,t.pointerType=e.pointerType,t.pressure=e.pressure,t.tangentialPressure=e.tangentialPressure,t.tiltX=e.tiltX,t.tiltY=e.tiltY,t.twist=e.twist,this._transferMouseData(t,e),this.mapPositionToPoint(t.screen,e.clientX,e.clientY),t.global.copyFrom(t.screen),t.offset.copyFrom(t.screen),t.isTrusted=e.isTrusted,"pointerleave"===t.type&&(t.type="pointerout"),t.type.startsWith("mouse")&&(t.type=t.type.replace("mouse","pointer")),t.type.startsWith("touch")&&(t.type=Ce[t.type]||t.type),t}_transferMouseData(t,e){t.isTrusted=e.isTrusted,t.srcElement=e.srcElement,t.timeStamp=performance.now(),t.type=e.type,t.altKey=e.altKey,t.button=e.button,t.buttons=e.buttons,t.client.x=e.clientX,t.client.y=e.clientY,t.ctrlKey=e.ctrlKey,t.metaKey=e.metaKey,t.movement.x=e.movementX,t.movement.y=e.movementY,t.page.x=e.pageX,t.page.y=e.pageY,t.relatedTarget=null,t.shiftKey=e.shiftKey}};Ie.extension={name:"events",type:[u.WebGLSystem,u.CanvasSystem,u.WebGPUSystem],priority:-1},Ie.defaultEventFeatures={move:!0,globalMove:!0,click:!0,wheel:!0};let Ge=Ie;const ke={onclick:null,onmousedown:null,onmouseenter:null,onmouseleave:null,onmousemove:null,onglobalmousemove:null,onmouseout:null,onmouseover:null,onmouseup:null,onmouseupoutside:null,onpointercancel:null,onpointerdown:null,onpointerenter:null,onpointerleave:null,onpointermove:null,onglobalpointermove:null,onpointerout:null,onpointerover:null,onpointertap:null,onpointerup:null,onpointerupoutside:null,onrightclick:null,onrightdown:null,onrightup:null,onrightupoutside:null,ontap:null,ontouchcancel:null,ontouchend:null,ontouchendoutside:null,ontouchmove:null,onglobaltouchmove:null,ontouchstart:null,onwheel:null,get interactive(){return"dynamic"===this.eventMode||"static"===this.eventMode},set interactive(t){this.eventMode=t?"static":"passive"},_internalEventMode:void 0,get eventMode(){var t;return null!=(t=this._internalEventMode)?t:Ge.defaultEventMode},set eventMode(t){this._internalEventMode=t},isInteractive(){return"static"===this.eventMode||"dynamic"===this.eventMode},interactiveChildren:!0,hitArea:null,addEventListener(t,e,r){const s="boolean"==typeof r&&r||"object"==typeof r&&r.capture,i="object"==typeof r?r.signal:void 0,n="object"==typeof r&&!0===r.once,o="function"==typeof e?void 0:e;t=s?`${t}capture`:t;const a="function"==typeof e?e:e.handleEvent,l=this;i&&i.addEventListener("abort",(()=>{l.off(t,a,o)})),n?l.once(t,a,o):l.on(t,a,o)},removeEventListener(t,e,r){const s="function"==typeof e?void 0:e;t="boolean"==typeof r&&r||"object"==typeof r&&r.capture?`${t}capture`:t,e="function"==typeof e?e:e.handleEvent,this.off(t,e,s)},dispatchEvent(t){if(!(t instanceof Vt))throw new Error("Container cannot propagate events outside of the Federated Events API");return t.defaultPrevented=!1,t.path=null,t.target=this,t.manager.dispatchEvent(t),!t.defaultPrevented}};p.add(Ge),jt.mixin(ke);var Be=(t=>(t[t.Low=0]="Low",t[t.Normal=1]="Normal",t[t.High=2]="High",t))(Be||{});const De={createCanvas:(t,e)=>{const r=document.createElement("canvas");return r.width=t,r.height=e,r},getCanvasRenderingContext2D:()=>CanvasRenderingContext2D,getWebGLRenderingContext:()=>WebGLRenderingContext,getNavigator:()=>navigator,getBaseUrl:()=>{var t;return null!=(t=document.baseURI)?t:window.location.href},getFontFaceSet:()=>document.fonts,fetch:(t,e)=>fetch(t,e),parseXML:t=>(new DOMParser).parseFromString(t,"text/xml")};let Fe=De;const Ne={get:()=>Fe,set(t){Fe=t}};function Ue(t){if("string"!=typeof t)throw new TypeError(`Path must be a string. Received ${JSON.stringify(t)}`)}function Le(t){return t.split("?")[0].split("#")[0]}const Xe={toPosix:t=>function(t,e,r){return t.replace(new RegExp(function(t){return t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}(e),"g"),r)}(t,"\\","/"),isUrl(t){return/^https?:/.test(this.toPosix(t))},isDataUrl:t=>/^data:([a-z]+\/[a-z0-9-+.]+(;[a-z0-9-.!#$%*+.{}|~`]+=[a-z0-9-.!#$%*+.{}()_|~`]+)*)?(;base64)?,([a-z0-9!$&',()*+;=\-._~:@\/?%\s<>]*?)$/i.test(t),isBlobUrl:t=>t.startsWith("blob:"),hasProtocol(t){return/^[^/:]+:/.test(this.toPosix(t))},getProtocol(t){Ue(t),t=this.toPosix(t);const e=/^file:\/\/\//.exec(t);if(e)return e[0];const r=/^[^/:]+:\/{0,2}/.exec(t);return r?r[0]:""},toAbsolute(t,e,r){if(Ue(t),this.isDataUrl(t)||this.isBlobUrl(t))return t;const s=Le(this.toPosix(null!=e?e:Ne.get().getBaseUrl())),i=Le(this.toPosix(null!=r?r:this.rootname(s)));return(t=this.toPosix(t)).startsWith("/")?Xe.join(i,t.slice(1)):this.isAbsolute(t)?t:this.join(s,t)},normalize(t){if(Ue(t),0===t.length)return".";if(this.isDataUrl(t)||this.isBlobUrl(t))return t;let e="";const r=(t=this.toPosix(t)).startsWith("/");this.hasProtocol(t)&&(e=this.rootname(t),t=t.slice(e.length));const s=t.endsWith("/");return t=function(t,e){let r="",s=0,i=-1,n=0,o=-1;for(let a=0;a<=t.length;++a){if(a<t.length)o=t.charCodeAt(a);else{if(47===o)break;o=47}if(47===o){if(i!==a-1&&1!==n)if(i!==a-1&&2===n){if(r.length<2||2!==s||46!==r.charCodeAt(r.length-1)||46!==r.charCodeAt(r.length-2))if(r.length>2){const t=r.lastIndexOf("/");if(t!==r.length-1){-1===t?(r="",s=0):(r=r.slice(0,t),s=r.length-1-r.lastIndexOf("/")),i=a,n=0;continue}}else if(2===r.length||1===r.length){r="",s=0,i=a,n=0;continue}e&&(r.length>0?r+="/..":r="..",s=2)}else r.length>0?r+=`/${t.slice(i+1,a)}`:r=t.slice(i+1,a),s=a-i-1;i=a,n=0}else 46===o&&-1!==n?++n:n=-1}return r}(t,!1),t.length>0&&s&&(t+="/"),r?`/${t}`:e+t},isAbsolute(t){return Ue(t),t=this.toPosix(t),!!this.hasProtocol(t)||t.startsWith("/")},join(...t){var e;if(0===t.length)return".";let r;for(let s=0;s<t.length;++s){const i=t[s];if(Ue(i),i.length>0)if(void 0===r)r=i;else{const n=null!=(e=t[s-1])?e:"";this.joinExtensions.includes(this.extname(n).toLowerCase())?r+=`/../${i}`:r+=`/${i}`}}return void 0===r?".":this.normalize(r)},dirname(t){if(Ue(t),0===t.length)return".";let e=(t=this.toPosix(t)).charCodeAt(0);const r=47===e;let s=-1,i=!0;const n=this.getProtocol(t),o=t;for(let r=(t=t.slice(n.length)).length-1;r>=1;--r)if(e=t.charCodeAt(r),47===e){if(!i){s=r;break}}else i=!1;return-1===s?r?"/":this.isUrl(o)?n+t:n:r&&1===s?"//":n+t.slice(0,s)},rootname(t){Ue(t);let e="";if(e=(t=this.toPosix(t)).startsWith("/")?"/":this.getProtocol(t),this.isUrl(t)){const r=t.indexOf("/",e.length);e=-1!==r?t.slice(0,r):t,e.endsWith("/")||(e+="/")}return e},basename(t,e){Ue(t),e&&Ue(e),t=Le(this.toPosix(t));let r,s=0,i=-1,n=!0;if(void 0!==e&&e.length>0&&e.length<=t.length){if(e.length===t.length&&e===t)return"";let o=e.length-1,a=-1;for(r=t.length-1;r>=0;--r){const l=t.charCodeAt(r);if(47===l){if(!n){s=r+1;break}}else-1===a&&(n=!1,a=r+1),o>=0&&(l===e.charCodeAt(o)?-1==--o&&(i=r):(o=-1,i=a))}return s===i?i=a:-1===i&&(i=t.length),t.slice(s,i)}for(r=t.length-1;r>=0;--r)if(47===t.charCodeAt(r)){if(!n){s=r+1;break}}else-1===i&&(n=!1,i=r+1);return-1===i?"":t.slice(s,i)},extname(t){Ue(t);let e=-1,r=0,s=-1,i=!0,n=0;for(let o=(t=Le(this.toPosix(t))).length-1;o>=0;--o){const a=t.charCodeAt(o);if(47!==a)-1===s&&(i=!1,s=o+1),46===a?-1===e?e=o:1!==n&&(n=1):-1!==e&&(n=-1);else if(!i){r=o+1;break}}return-1===e||-1===s||0===n||1===n&&e===s-1&&e===r+1?"":t.slice(e,s)},parse(t){Ue(t);const e={root:"",dir:"",base:"",ext:"",name:""};if(0===t.length)return e;let r=(t=Le(this.toPosix(t))).charCodeAt(0);const s=this.isAbsolute(t);let i;e.root=this.rootname(t),i=s||this.hasProtocol(t)?1:0;let n=-1,o=0,a=-1,l=!0,h=t.length-1,u=0;for(;h>=i;--h)if(r=t.charCodeAt(h),47!==r)-1===a&&(l=!1,a=h+1),46===r?-1===n?n=h:1!==u&&(u=1):-1!==n&&(u=-1);else if(!l){o=h+1;break}return-1===n||-1===a||0===u||1===u&&n===a-1&&n===o+1?-1!==a&&(e.base=e.name=0===o&&s?t.slice(1,a):t.slice(o,a)):(0===o&&s?(e.name=t.slice(1,n),e.base=t.slice(1,a)):(e.name=t.slice(o,n),e.base=t.slice(o,a)),e.ext=t.slice(n,a)),e.dir=this.dirname(t),e},sep:"/",delimiter:":",joinExtensions:[".html"]},ze=(t,e,r=!1)=>(Array.isArray(t)||(t=[t]),e?t.map((t=>"string"==typeof t||r?e(t):t)):t);function He(t,e,r,s,i){const n=e[r];for(let o=0;o<n.length;o++){const a=n[o];r<e.length-1?He(t.replace(s[r],a),e,r+1,s,i):i.push(t.replace(s[r],a))}}function je(t){const e=t.match(/\{(.*?)\}/g),r=[];if(e){const s=[];e.forEach((t=>{const e=t.substring(1,t.length-1).split(",");s.push(e)})),He(t,s,0,e,r)}else r.push(t);return r}const Ve=t=>!Array.isArray(t);var We=Object.defineProperty,$e=Object.defineProperties,Ye=Object.getOwnPropertyDescriptors,qe=Object.getOwnPropertySymbols,Ke=Object.prototype.hasOwnProperty,Ze=Object.prototype.propertyIsEnumerable,Qe=(t,e,r)=>e in t?We(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r,Je=(t,e)=>{for(var r in e||(e={}))Ke.call(e,r)&&Qe(t,r,e[r]);if(qe)for(var r of qe(e))Ze.call(e,r)&&Qe(t,r,e[r]);return t};class tr{constructor(){this._defaultBundleIdentifierOptions={connector:"-",createBundleAssetId:(t,e)=>`${t}${this._bundleIdConnector}${e}`,extractAssetIdFromBundle:(t,e)=>e.replace(`${t}${this._bundleIdConnector}`,"")},this._bundleIdConnector=this._defaultBundleIdentifierOptions.connector,this._createBundleAssetId=this._defaultBundleIdentifierOptions.createBundleAssetId,this._extractAssetIdFromBundle=this._defaultBundleIdentifierOptions.extractAssetIdFromBundle,this._assetMap={},this._preferredOrder=[],this._parsers=[],this._resolverHash={},this._bundles={}}setBundleIdentifier(t){var e,r,s;if(this._bundleIdConnector=null!=(e=t.connector)?e:this._bundleIdConnector,this._createBundleAssetId=null!=(r=t.createBundleAssetId)?r:this._createBundleAssetId,this._extractAssetIdFromBundle=null!=(s=t.extractAssetIdFromBundle)?s:this._extractAssetIdFromBundle,"bar"!==this._extractAssetIdFromBundle("foo",this._createBundleAssetId("foo","bar")))throw new Error("[Resolver] GenerateBundleAssetId are not working correctly")}prefer(...t){t.forEach((t=>{this._preferredOrder.push(t),t.priority||(t.priority=Object.keys(t.params))})),this._resolverHash={}}set basePath(t){this._basePath=t}get basePath(){return this._basePath}set rootPath(t){this._rootPath=t}get rootPath(){return this._rootPath}get parsers(){return this._parsers}reset(){this.setBundleIdentifier(this._defaultBundleIdentifierOptions),this._assetMap={},this._preferredOrder=[],this._resolverHash={},this._rootPath=null,this._basePath=null,this._manifest=null,this._bundles={},this._defaultSearchParams=null}setDefaultSearchParams(t){if("string"==typeof t)this._defaultSearchParams=t;else{const e=t;this._defaultSearchParams=Object.keys(e).map((t=>`${encodeURIComponent(t)}=${encodeURIComponent(e[t])}`)).join("&")}}getAlias(t){const{alias:e,src:r}=t;return ze(e||r,(t=>"string"==typeof t?t:Array.isArray(t)?t.map((t=>{var e;return null!=(e=null==t?void 0:t.src)?e:t})):null!=t&&t.src?t.src:t),!0)}addManifest(t){this._manifest,this._manifest=t,t.bundles.forEach((t=>{this.addBundle(t.name,t.assets)}))}addBundle(t,e){const r=[];let s=e;Array.isArray(e)||(s=Object.entries(e).map((([t,e])=>"string"==typeof e||Array.isArray(e)?{alias:t,src:e}:Je({alias:t},e)))),s.forEach((e=>{const s=e.src,i=e.alias;let n;if("string"==typeof i){const e=this._createBundleAssetId(t,i);r.push(e),n=[i,e]}else{const e=i.map((e=>this._createBundleAssetId(t,e)));r.push(...e),n=[...i,...e]}this.add(((t,e)=>$e(t,Ye(e)))(Je({},e),{alias:n,src:s}))})),this._bundles[t]=r}add(t){const e=[];Array.isArray(t)?e.push(...t):e.push(t),ze(e).forEach((t=>{const{src:e}=t;let{data:r,format:s,loadParser:i}=t;const n=ze(e).map((t=>"string"==typeof t?je(t):Array.isArray(t)?t:[t])),o=this.getAlias(t),a=[];n.forEach((t=>{t.forEach((t=>{var e,n,l;let h={};if("object"!=typeof t){h.src=t;for(let e=0;e<this._parsers.length;e++){const r=this._parsers[e];if(r.test(t)){h=r.parse(t);break}}}else r=null!=(e=t.data)?e:r,s=null!=(n=t.format)?n:s,i=null!=(l=t.loadParser)?l:i,h=Je(Je({},h),t);if(!o)throw new Error(`[Resolver] alias is undefined for this asset: ${h.src}`);h=this._buildResolvedAsset(h,{aliases:o,data:r,format:s,loadParser:i}),a.push(h)}))})),o.forEach((t=>{this._assetMap[t]=a}))}))}resolveBundle(t){const e=Ve(t);t=ze(t);const r={};return t.forEach((t=>{const e=this._bundles[t];if(e){const s=this.resolve(e),i={};for(const e in s){const r=s[e];i[this._extractAssetIdFromBundle(t,e)]=r}r[t]=i}})),e?r[t[0]]:r}resolveUrl(t){const e=this.resolve(t);if("string"!=typeof t){const t={};for(const r in e)t[r]=e[r].src;return t}return e.src}resolve(t){const e=Ve(t);t=ze(t);const r={};return t.forEach((t=>{if(!this._resolverHash[t])if(this._assetMap[t]){let e=this._assetMap[t];const r=this._getPreferredOrder(e);null==r||r.priority.forEach((t=>{r.params[t].forEach((r=>{const s=e.filter((e=>!!e[t]&&e[t]===r));s.length&&(e=s)}))})),this._resolverHash[t]=e[0]}else this._resolverHash[t]=this._buildResolvedAsset({alias:[t],src:t},{});r[t]=this._resolverHash[t]})),e?r[t[0]]:r}hasKey(t){return!!this._assetMap[t]}hasBundle(t){return!!this._bundles[t]}_getPreferredOrder(t){for(let e=0;e<t.length;e++){const e=t[0],r=this._preferredOrder.find((t=>t.params.format.includes(e.format)));if(r)return r}return this._preferredOrder[0]}_appendDefaultSearchParams(t){if(!this._defaultSearchParams)return t;return`${t}${/\?/.test(t)?"&":"?"}${this._defaultSearchParams}`}_buildResolvedAsset(t,e){var r,s;const{aliases:i,data:n,loadParser:o,format:a}=e;return(this._basePath||this._rootPath)&&(t.src=Xe.toAbsolute(t.src,this._basePath,this._rootPath)),t.alias=null!=(r=null!=i?i:t.alias)?r:[t.src],t.src=this._appendDefaultSearchParams(t.src),t.data=Je(Je({},n||{}),t.data),t.loadParser=null!=o?o:t.loadParser,t.format=null!=(s=null!=a?a:t.format)?s:er(t.src),t}}function er(t){return t.split(".").pop().split("?").shift().split("#").shift()}tr.RETINA_PREFIX=/@([0-9\.]+)x/;const rr=(t,e)=>{const r=e.split("?")[1];return r&&(t+=`?${r}`),t},sr=[1,1,0,-1,-1,-1,0,1,1,1,0,-1,-1,-1,0,1],ir=[0,1,1,1,0,-1,-1,-1,0,1,1,1,0,-1,-1,-1],nr=[0,-1,-1,-1,0,1,1,1,0,1,1,1,0,-1,-1,-1],or=[1,1,0,-1,-1,-1,0,1,-1,-1,0,1,1,1,0,-1],ar=[],lr=[],hr=Math.sign;!function(){for(let t=0;t<16;t++){const e=[];ar.push(e);for(let r=0;r<16;r++){const s=hr(sr[t]*sr[r]+nr[t]*ir[r]),i=hr(ir[t]*sr[r]+or[t]*ir[r]),n=hr(sr[t]*nr[r]+nr[t]*or[r]),o=hr(ir[t]*nr[r]+or[t]*or[r]);for(let t=0;t<16;t++)if(sr[t]===s&&ir[t]===i&&nr[t]===n&&or[t]===o){e.push(t);break}}}for(let t=0;t<16;t++){const e=new it;e.set(sr[t],ir[t],nr[t],or[t],0,0),lr.push(e)}}();const ur={E:0,SE:1,S:2,SW:3,W:4,NW:5,N:6,NE:7,MIRROR_VERTICAL:8,MAIN_DIAGONAL:10,MIRROR_HORIZONTAL:12,REVERSE_DIAGONAL:14,uX:t=>sr[t],uY:t=>ir[t],vX:t=>nr[t],vY:t=>or[t],inv:t=>8&t?15&t:7&-t,add:(t,e)=>ar[t][e],sub:(t,e)=>ar[t][ur.inv(e)],rotate180:t=>4^t,isVertical:t=>2==(3&t),byDirection:(t,e)=>2*Math.abs(t)<=Math.abs(e)?e>=0?ur.S:ur.N:2*Math.abs(e)<=Math.abs(t)?t>0?ur.E:ur.W:e>0?t>0?ur.SE:ur.SW:t>0?ur.NE:ur.NW,matrixAppendRotationInv:(t,e,r=0,s=0)=>{const i=lr[ur.inv(e)];i.tx=r,i.ty=s,t.append(i)}},cr=()=>{};function dr(t){return t+=0===t?1:0,--t,t|=t>>>1,t|=t>>>2,t|=t>>>4,t|=t>>>8,(t|=t>>>16)+1}function pr(t){return!(t&t-1||!t)}function fr(t){const e={};for(const r in t)void 0!==t[r]&&(e[r]=t[r]);return e}var gr=Object.defineProperty,mr=Object.getOwnPropertySymbols,_r=Object.prototype.hasOwnProperty,xr=Object.prototype.propertyIsEnumerable,yr=(t,e,r)=>e in t?gr(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r,br=(t,e)=>{for(var r in e||(e={}))_r.call(e,r)&&yr(t,r,e[r]);if(mr)for(var r of mr(e))xr.call(e,r)&&yr(t,r,e[r]);return t};const vr=Object.create(null);const Tr=class t extends m{constructor(e={}){var r,s,i,n,o,a,l;super(),this._resourceType="textureSampler",this._touched=0,this._maxAnisotropy=1,this.destroyed=!1,e=br(br({},t.defaultOptions),e),this.addressMode=e.addressMode,this.addressModeU=null!=(r=e.addressModeU)?r:this.addressModeU,this.addressModeV=null!=(s=e.addressModeV)?s:this.addressModeV,this.addressModeW=null!=(i=e.addressModeW)?i:this.addressModeW,this.scaleMode=e.scaleMode,this.magFilter=null!=(n=e.magFilter)?n:this.magFilter,this.minFilter=null!=(o=e.minFilter)?o:this.minFilter,this.mipmapFilter=null!=(a=e.mipmapFilter)?a:this.mipmapFilter,this.lodMinClamp=e.lodMinClamp,this.lodMaxClamp=e.lodMaxClamp,this.compare=e.compare,this.maxAnisotropy=null!=(l=e.maxAnisotropy)?l:1}set addressMode(t){this.addressModeU=t,this.addressModeV=t,this.addressModeW=t}get addressMode(){return this.addressModeU}set wrapMode(t){this.addressMode=t}get wrapMode(){return this.addressMode}set scaleMode(t){this.magFilter=t,this.minFilter=t,this.mipmapFilter=t}get scaleMode(){return this.magFilter}set maxAnisotropy(t){this._maxAnisotropy=Math.min(t,16),this._maxAnisotropy>1&&(this.scaleMode="linear")}get maxAnisotropy(){return this._maxAnisotropy}get _resourceId(){return this._sharedResourceId||this._generateResourceId()}update(){this.emit("change",this),this._sharedResourceId=null}_generateResourceId(){const t=`${this.addressModeU}-${this.addressModeV}-${this.addressModeW}-${this.magFilter}-${this.minFilter}-${this.mipmapFilter}-${this.lodMinClamp}-${this.lodMaxClamp}-${this.compare}-${this._maxAnisotropy}`;return this._sharedResourceId=function(t){const e=vr[t];return void 0===e&&(vr[t]=ht("resource")),e}(t),this._resourceId}destroy(){this.destroyed=!0,this.emit("destroy",this),this.emit("change",this),this.removeAllListeners()}};Tr.defaultOptions={addressMode:"clamp-to-edge",scaleMode:"linear"};let Sr=Tr;var wr=Object.defineProperty,Er=Object.getOwnPropertySymbols,Ar=Object.prototype.hasOwnProperty,Mr=Object.prototype.propertyIsEnumerable,Pr=(t,e,r)=>e in t?wr(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r,Rr=(t,e)=>{for(var r in e||(e={}))Ar.call(e,r)&&Pr(t,r,e[r]);if(Er)for(var r of Er(e))Mr.call(e,r)&&Pr(t,r,e[r]);return t};const Or=class t extends m{constructor(e={}){var r,s,i;super(),this.options=e,this.uid=ht("textureSource"),this._resourceType="textureSource",this._resourceId=ht("resource"),this.uploadMethodId="unknown",this._resolution=1,this.pixelWidth=1,this.pixelHeight=1,this.width=1,this.height=1,this.sampleCount=1,this.mipLevelCount=1,this.autoGenerateMipmaps=!1,this.format="rgba8unorm",this.dimension="2d",this.antialias=!1,this._touched=0,this._batchTick=-1,this._textureBindLocation=-1,e=Rr(Rr({},t.defaultOptions),e),this.label=null!=(r=e.label)?r:"",this.resource=e.resource,this.autoGarbageCollect=e.autoGarbageCollect,this._resolution=e.resolution,e.width?this.pixelWidth=e.width*this._resolution:this.pixelWidth=this.resource&&null!=(s=this.resourceWidth)?s:1,e.height?this.pixelHeight=e.height*this._resolution:this.pixelHeight=this.resource&&null!=(i=this.resourceHeight)?i:1,this.width=this.pixelWidth/this._resolution,this.height=this.pixelHeight/this._resolution,this.format=e.format,this.dimension=e.dimensions,this.mipLevelCount=e.mipLevelCount,this.autoGenerateMipmaps=e.autoGenerateMipmaps,this.sampleCount=e.sampleCount,this.antialias=e.antialias,this.alphaMode=e.alphaMode,this.style=new Sr(fr(e)),this.destroyed=!1,this._refreshPOT()}get source(){return this}get style(){return this._style}set style(t){var e,r;this.style!==t&&(null==(e=this._style)||e.off("change",this._onStyleChange,this),this._style=t,null==(r=this._style)||r.on("change",this._onStyleChange,this),this._onStyleChange())}get addressMode(){return this._style.addressMode}set addressMode(t){this._style.addressMode=t}get repeatMode(){return this._style.addressMode}set repeatMode(t){this._style.addressMode=t}get magFilter(){return this._style.magFilter}set magFilter(t){this._style.magFilter=t}get minFilter(){return this._style.minFilter}set minFilter(t){this._style.minFilter=t}get mipmapFilter(){return this._style.mipmapFilter}set mipmapFilter(t){this._style.mipmapFilter=t}get lodMinClamp(){return this._style.lodMinClamp}set lodMinClamp(t){this._style.lodMinClamp=t}get lodMaxClamp(){return this._style.lodMaxClamp}set lodMaxClamp(t){this._style.lodMaxClamp=t}_onStyleChange(){this.emit("styleChange",this)}update(){if(this.resource){const t=this._resolution;if(this.resize(this.resourceWidth/t,this.resourceHeight/t))return}this.emit("update",this)}destroy(){this.destroyed=!0,this.emit("destroy",this),this.emit("change",this),this._style&&(this._style.destroy(),this._style=null),this.uploadMethodId=null,this.resource=null,this.removeAllListeners()}unload(){this._resourceId=ht("resource"),this.emit("change",this),this.emit("unload",this)}get resourceWidth(){const{resource:t}=this;return t.naturalWidth||t.videoWidth||t.displayWidth||t.width}get resourceHeight(){const{resource:t}=this;return t.naturalHeight||t.videoHeight||t.displayHeight||t.height}get resolution(){return this._resolution}set resolution(t){this._resolution!==t&&(this._resolution=t,this.width=this.pixelWidth/t,this.height=this.pixelHeight/t)}resize(t,e,r){r=r||this._resolution,t=t||this.width,e=e||this.height;const s=Math.round(t*r),i=Math.round(e*r);return this.width=s/r,this.height=i/r,this._resolution=r,(this.pixelWidth!==s||this.pixelHeight!==i)&&(this._refreshPOT(),this.pixelWidth=s,this.pixelHeight=i,this.emit("resize",this),this._resourceId=ht("resource"),this.emit("change",this),!0)}updateMipmaps(){this.autoGenerateMipmaps&&this.mipLevelCount>1&&this.emit("updateMipmaps",this)}set wrapMode(t){this._style.wrapMode=t}get wrapMode(){return this._style.wrapMode}set scaleMode(t){this._style.scaleMode=t}get scaleMode(){return this._style.scaleMode}_refreshPOT(){this.isPowerOfTwo=pr(this.pixelWidth)&&pr(this.pixelHeight)}static test(t){throw new Error("Unimplemented")}};Or.defaultOptions={resolution:1,format:"bgra8unorm",alphaMode:"premultiply-alpha-on-upload",dimensions:"2d",mipLevelCount:1,autoGenerateMipmaps:!1,sampleCount:1,antialias:!1,autoGarbageCollect:!1};let Cr=Or;var Ir=Object.defineProperty,Gr=Object.defineProperties,kr=Object.getOwnPropertyDescriptors,Br=Object.getOwnPropertySymbols,Dr=Object.prototype.hasOwnProperty,Fr=Object.prototype.propertyIsEnumerable,Nr=(t,e,r)=>e in t?Ir(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r;class Ur extends Cr{constructor(t){const e=t.resource||new Float32Array(t.width*t.height*4);let r=t.format;r||(e instanceof Float32Array?r="rgba32float":e instanceof Int32Array||e instanceof Uint32Array?r="rgba32uint":e instanceof Int16Array||e instanceof Uint16Array?r="rgba16uint":(Int8Array,r="bgra8unorm")),super(((t,e)=>Gr(t,kr(e)))(((t,e)=>{for(var r in e||(e={}))Dr.call(e,r)&&Nr(t,r,e[r]);if(Br)for(var r of Br(e))Fr.call(e,r)&&Nr(t,r,e[r]);return t})({},t),{resource:e,format:r})),this.uploadMethodId="buffer"}static test(t){return t instanceof Int8Array||t instanceof Uint8Array||t instanceof Uint8ClampedArray||t instanceof Int16Array||t instanceof Uint16Array||t instanceof Int32Array||t instanceof Uint32Array||t instanceof Float32Array}}Ur.extension=u.TextureSource;const Lr=new it;class Xr{constructor(t,e){this.mapCoord=new it,this.uClampFrame=new Float32Array(4),this.uClampOffset=new Float32Array(2),this._textureID=-1,this._updateID=0,this.clampOffset=0,this.clampMargin=void 0===e?t.width<10?0:.5:e,this.isSimple=!1,this.texture=t}get texture(){return this._texture}set texture(t){var e;this.texture!==t&&(null==(e=this._texture)||e.removeListener("update",this.update,this),this._texture=t,this._texture.addListener("update",this.update,this),this.update())}multiplyUvs(t,e){void 0===e&&(e=t);const r=this.mapCoord;for(let s=0;s<t.length;s+=2){const i=t[s],n=t[s+1];e[s]=i*r.a+n*r.c+r.tx,e[s+1]=i*r.b+n*r.d+r.ty}return e}update(){const t=this._texture;this._updateID++;const e=t.uvs;this.mapCoord.set(e.x1-e.x0,e.y1-e.y0,e.x3-e.x0,e.y3-e.y0,e.x0,e.y0);const r=t.orig,s=t.trim;s&&(Lr.set(r.width/s.width,0,0,r.height/s.height,-s.x/s.width,-s.y/s.height),this.mapCoord.append(Lr));const i=t.source,n=this.uClampFrame,o=this.clampMargin/i._resolution,a=this.clampOffset;return n[0]=(t.frame.x+o+a)/i.width,n[1]=(t.frame.y+o+a)/i.height,n[2]=(t.frame.x+t.frame.width-o+a)/i.width,n[3]=(t.frame.y+t.frame.height-o+a)/i.height,this.uClampOffset[0]=a/i.pixelWidth,this.uClampOffset[1]=a/i.pixelHeight,this.isSimple=t.frame.width===i.width&&t.frame.height===i.height&&0===t.rotate,!0}}class zr extends m{constructor({source:t,label:e,frame:r,orig:s,trim:i,defaultAnchor:n,defaultBorders:o,rotate:a,dynamic:l}={}){var h;if(super(),this.uid=ht("texture"),this.uvs={x0:0,y0:0,x1:0,y1:0,x2:0,y2:0,x3:0,y3:0},this.frame=new vt,this.noFrame=!1,this.dynamic=!1,this.isTexture=!0,this.label=e,this.source=null!=(h=null==t?void 0:t.source)?h:new Cr,this.noFrame=!r,r)this.frame.copyFrom(r);else{const{width:t,height:e}=this._source;this.frame.width=t,this.frame.height=e}this.orig=s||this.frame,this.trim=i,this.rotate=null!=a?a:0,this.defaultAnchor=n,this.defaultBorders=o,this.destroyed=!1,this.dynamic=l||!1,this.updateUvs()}set source(t){this._source&&this._source.off("resize",this.update,this),this._source=t,t.on("resize",this.update,this),this.emit("update",this)}get source(){return this._source}get textureMatrix(){return this._textureMatrix||(this._textureMatrix=new Xr(this)),this._textureMatrix}get width(){return this.orig.width}get height(){return this.orig.height}updateUvs(){const{uvs:t,frame:e}=this,{width:r,height:s}=this._source,i=e.x/r,n=e.y/s,o=e.width/r,a=e.height/s;let l=this.rotate;if(l){const e=o/2,r=a/2,s=i+e,h=n+r;l=ur.add(l,ur.NW),t.x0=s+e*ur.uX(l),t.y0=h+r*ur.uY(l),l=ur.add(l,2),t.x1=s+e*ur.uX(l),t.y1=h+r*ur.uY(l),l=ur.add(l,2),t.x2=s+e*ur.uX(l),t.y2=h+r*ur.uY(l),l=ur.add(l,2),t.x3=s+e*ur.uX(l),t.y3=h+r*ur.uY(l)}else t.x0=i,t.y0=n,t.x1=i+o,t.y1=n,t.x2=i+o,t.y2=n+a,t.x3=i,t.y3=n+a}destroy(t=!1){this._source&&t&&(this._source.destroy(),this._source=null),this._textureMatrix=null,this.destroyed=!0,this.emit("destroy",this),this.removeAllListeners()}update(){this.noFrame&&(this.frame.width=this._source.width,this.frame.height=this._source.height),this.updateUvs(),this.emit("update",this)}get baseTexture(){return this._source}}zr.EMPTY=new zr({label:"EMPTY",source:new Cr({label:"EMPTY"})}),zr.EMPTY.destroy=cr,zr.WHITE=new zr({source:new Ur({resource:new Uint8Array([255,255,255,255]),width:1,height:1,alphaMode:"premultiply-alpha-on-upload",label:"WHITE"}),label:"WHITE"}),zr.WHITE.destroy=cr;const Hr=class t{constructor(t,e){this.linkedSheets=[],this._texture=t instanceof zr?t:null,this.textureSource=t.source,this.textures={},this.animations={},this.data=e;const r=parseFloat(e.meta.scale);r?(this.resolution=r,t.source.resolution=this.resolution):this.resolution=t.source._resolution,this._frames=this.data.frames,this._frameKeys=Object.keys(this._frames),this._batchIndex=0,this._callback=null}parse(){return new Promise((e=>{this._callback=e,this._batchIndex=0,this._frameKeys.length<=t.BATCH_SIZE?(this._processFrames(0),this._processAnimations(),this._parseComplete()):this._nextBatch()}))}_processFrames(e){let r=e;const s=t.BATCH_SIZE;for(;r-e<s&&r<this._frameKeys.length;){const t=this._frameKeys[r],e=this._frames[t],s=e.frame;if(s){let r=null,i=null;const n=!1!==e.trimmed&&e.sourceSize?e.sourceSize:e.frame,o=new vt(0,0,Math.floor(n.w)/this.resolution,Math.floor(n.h)/this.resolution);r=e.rotated?new vt(Math.floor(s.x)/this.resolution,Math.floor(s.y)/this.resolution,Math.floor(s.h)/this.resolution,Math.floor(s.w)/this.resolution):new vt(Math.floor(s.x)/this.resolution,Math.floor(s.y)/this.resolution,Math.floor(s.w)/this.resolution,Math.floor(s.h)/this.resolution),!1!==e.trimmed&&e.spriteSourceSize&&(i=new vt(Math.floor(e.spriteSourceSize.x)/this.resolution,Math.floor(e.spriteSourceSize.y)/this.resolution,Math.floor(s.w)/this.resolution,Math.floor(s.h)/this.resolution)),this.textures[t]=new zr({source:this.textureSource,frame:r,orig:o,trim:i,rotate:e.rotated?2:0,defaultAnchor:e.anchor,defaultBorders:e.borders,label:t.toString()})}r++}}_processAnimations(){const t=this.data.animations||{};for(const e in t){this.animations[e]=[];for(let r=0;r<t[e].length;r++){const s=t[e][r];this.animations[e].push(this.textures[s])}}}_parseComplete(){const t=this._callback;this._callback=null,this._batchIndex=0,t.call(this,this.textures)}_nextBatch(){this._processFrames(this._batchIndex*t.BATCH_SIZE),this._batchIndex++,setTimeout((()=>{this._batchIndex*t.BATCH_SIZE<this._frameKeys.length?this._nextBatch():(this._processAnimations(),this._parseComplete())}),0)}destroy(t=!1){var e;for(const t in this.textures)this.textures[t].destroy();this._frames=null,this._frameKeys=null,this.data=null,this.textures=null,t&&(null==(e=this._texture)||e.destroy(),this.textureSource.destroy()),this._texture=null,this.textureSource=null,this.linkedSheets=[]}};Hr.BATCH_SIZE=1e3;let jr=Hr;const Vr=["jpg","png","jpeg","avif","webp","basis","etc2","bc7","bc6h","bc5","bc4","bc3","bc2","bc1","eac","astc"];function Wr(t,e,r){const s={};if(t.forEach((t=>{s[t]=e})),Object.keys(e.textures).forEach((t=>{s[t]=e.textures[t]})),!r){const r=Xe.dirname(t[0]);e.linkedSheets.forEach(((t,i)=>{const n=Wr([`${r}/${e.data.meta.related_multi_packs[i]}`],t,!0);Object.assign(s,n)}))}return s}const $r={extension:u.Asset,cache:{test:t=>t instanceof jr,getCacheableAssets:(t,e)=>Wr(t,e,!1)},resolver:{test:t=>{const e=t.split("?")[0].split("."),r=e.pop(),s=e.pop();return"json"===r&&Vr.includes(s)},parse:t=>{var e,r;const s=t.split(".");return{resolution:parseFloat(null!=(r=null==(e=tr.RETINA_PREFIX.exec(t))?void 0:e[1])?r:"1"),format:s[s.length-2],src:t}}},loader:{name:"spritesheetLoader",extension:{type:u.LoadParser,priority:Be.Normal},testParse:async(t,e)=>".json"===Xe.extname(e.src).toLowerCase()&&!!t.frames,async parse(t,e,r){var s,i,n;const{texture:o,imageFilename:a}=null!=(s=null==e?void 0:e.data)?s:{};let l,h=Xe.dirname(e.src);if(h&&h.lastIndexOf("/")!==h.length-1&&(h+="/"),o instanceof zr)l=o;else{const s=rr(h+(null!=a?a:t.meta.image),e.src);l=(await r.load([s]))[s]}const u=new jr(l.source,t);await u.parse();const c=null==(i=null==t?void 0:t.meta)?void 0:i.related_multi_packs;if(Array.isArray(c)){const t=[];for(const s of c){if("string"!=typeof s)continue;let i=h+s;null!=(n=e.data)&&n.ignoreMultiPack||(i=rr(i,e.src),t.push(r.load({src:i,data:{ignoreMultiPack:!0}})))}const s=await Promise.all(t);u.linkedSheets=s,s.forEach((t=>{t.linkedSheets=[u].concat(u.linkedSheets.filter((e=>e!==t)))}))}return u},async unload(t,e,r){await r.unload(t.textureSource._sourceOrigin),t.destroy(!1)}}};function Yr(t,e,r,s){const{width:i,height:n}=r.orig,o=r.trim;if(o){const r=o.width,a=o.height;t.minX=o.x-e._x*i-s,t.maxX=t.minX+r,t.minY=o.y-e._y*n-s,t.maxY=t.minY+a}else t.minX=-e._x*i-s,t.maxX=t.minX+i,t.minY=-e._y*n-s,t.maxY=t.minY+n}p.add($r);var qr=Object.defineProperty,Kr=Object.getOwnPropertySymbols,Zr=Object.prototype.hasOwnProperty,Qr=Object.prototype.propertyIsEnumerable,Jr=(t,e,r)=>e in t?qr(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r;class ts extends jt{constructor(t=zr.EMPTY){t instanceof zr&&(t={texture:t});const e=t,{texture:r,anchor:s,roundPixels:i,width:n,height:o}=e,a=((t,e)=>{var r={};for(var s in t)Zr.call(t,s)&&e.indexOf(s)<0&&(r[s]=t[s]);if(null!=t&&Kr)for(var s of Kr(t))e.indexOf(s)<0&&Qr.call(t,s)&&(r[s]=t[s]);return r})(e,["texture","anchor","roundPixels","width","height"]);super(((t,e)=>{for(var r in e||(e={}))Zr.call(e,r)&&Jr(t,r,e[r]);if(Kr)for(var r of Kr(e))Qr.call(e,r)&&Jr(t,r,e[r]);return t})({label:"Sprite"},a)),this.renderPipeId="sprite",this.batched=!0,this._didSpriteUpdate=!1,this._bounds={minX:0,maxX:1,minY:0,maxY:0},this._sourceBounds={minX:0,maxX:1,minY:0,maxY:0},this._boundsDirty=!0,this._sourceBoundsDirty=!0,this._roundPixels=0,this._anchor=new at({_onUpdate:()=>{this.onViewUpdate()}}),s?this.anchor=s:r.defaultAnchor&&(this.anchor=r.defaultAnchor),this.texture=r,this.allowChildren=!1,this.roundPixels=null!=i&&i,n&&(this.width=n),o&&(this.height=o)}static from(t,e=!1){return new ts(t instanceof zr?t:zr.from(t,e))}set texture(t){t||(t=zr.EMPTY);const e=this._texture;e!==t&&(e&&e.dynamic&&e.off("update",this.onViewUpdate,this),t.dynamic&&t.on("update",this.onViewUpdate,this),this._texture=t,this.onViewUpdate())}get texture(){return this._texture}get bounds(){return this._boundsDirty&&(this._updateBounds(),this._boundsDirty=!1),this._bounds}get sourceBounds(){return this._sourceBoundsDirty&&(this._updateSourceBounds(),this._sourceBoundsDirty=!1),this._sourceBounds}containsPoint(t){const e=this.sourceBounds;return t.x>=e.maxX&&t.x<=e.minX&&t.y>=e.maxY&&t.y<=e.minY}addBounds(t){const e=this._texture.trim?this.sourceBounds:this.bounds;t.addFrame(e.minX,e.minY,e.maxX,e.maxY)}onViewUpdate(){this._didChangeId+=4096,this._didSpriteUpdate=!0,this._sourceBoundsDirty=this._boundsDirty=!0,!this.didViewUpdate&&(this.didViewUpdate=!0,this.renderGroup&&this.renderGroup.onChildViewUpdate(this))}_updateBounds(){Yr(this._bounds,this._anchor,this._texture,0)}_updateSourceBounds(){const t=this._anchor,e=this._texture,r=this._sourceBounds,{width:s,height:i}=e.orig;r.maxX=-t._x*s,r.minX=r.maxX+s,r.maxY=-t._y*i,r.minY=r.maxY+i}destroy(t=!1){if(super.destroy(t),"boolean"==typeof t?t:null==t?void 0:t.texture){const e="boolean"==typeof t?t:null==t?void 0:t.textureSource;this._texture.destroy(e)}this._texture=null,this._bounds=null,this._sourceBounds=null,this._anchor=null}get anchor(){return this._anchor}set anchor(t){"number"==typeof t?this._anchor.set(t):this._anchor.copyFrom(t)}get roundPixels(){return!!this._roundPixels}set roundPixels(t){this._roundPixels=t?1:0}get width(){return Math.abs(this.scale.x)*this._texture.orig.width}set width(t){this._setWidth(t,this._texture.orig.width)}get height(){return Math.abs(this.scale.y)*this._texture.orig.height}set height(t){this._setHeight(t,this._texture.orig.height)}getSize(t){return t||(t={}),t.width=Math.abs(this.scale.x)*this._texture.orig.width,t.height=Math.abs(this.scale.y)*this._texture.orig.height,t}setSize(t,e){var r;let s,i;"object"!=typeof t?(s=t,i=null!=e?e:t):(s=t.width,i=null!=(r=t.height)?r:t.width),void 0!==s&&this._setWidth(s,this._texture.orig.width),void 0!==i&&this._setHeight(i,this._texture.orig.height)}}const es=new St;function rs(t,e,r){const s=es;t.measurable=!0,At(t,r,s),e.addBoundsMask(s),t.measurable=!1}function ss(t,e,r){const s=Et.get();t.measurable=!0;const i=wt.get().identity();Rt(t,s,is(t,r,i)),t.measurable=!1,e.addBoundsMask(s),wt.return(i),Et.return(s)}function is(t,e,r){return t&&t!==e&&(is(t.parent,e,r),t.updateLocalTransform(),r.append(t.localTransform)),r}class ns{constructor(t){this.priority=0,this.pipe="alphaMask",null!=t&&t.mask&&this.init(t.mask)}init(t){this.mask=t,this.renderMaskToTexture=!(t instanceof ts),this.mask.renderable=this.renderMaskToTexture,this.mask.includeInBuild=!this.renderMaskToTexture,this.mask.measurable=!1}reset(){this.mask.measurable=!0,this.mask=null}addBounds(t,e){rs(this.mask,t,e)}addLocalBounds(t,e){ss(this.mask,t,e)}containsPoint(t,e){return e(this.mask,t)}destroy(){this.reset()}static test(t){return t instanceof ts}}ns.extension=u.MaskEffect;class os{constructor(t){this.priority=0,this.pipe="colorMask",null!=t&&t.mask&&this.init(t.mask)}init(t){this.mask=t}destroy(){}static test(t){return"number"==typeof t}}os.extension=u.MaskEffect;class as{constructor(t){this.priority=0,this.pipe="stencilMask",null!=t&&t.mask&&this.init(t.mask)}init(t){this.mask=t,this.mask.includeInBuild=!1,this.mask.measurable=!1}reset(){this.mask.measurable=!0,this.mask.includeInBuild=!0,this.mask=null}addBounds(t,e){rs(this.mask,t,e)}addLocalBounds(t,e){ss(this.mask,t,e)}containsPoint(t,e){return e(this.mask,t)}destroy(){this.reset()}static test(t){return t instanceof jt}}as.extension=u.MaskEffect;class ls extends Cr{constructor(t){t.resource||(t.resource=Ne.get().createCanvas()),t.width||(t.width=t.resource.width,t.autoDensity||(t.width/=t.resolution)),t.height||(t.height=t.resource.height,t.autoDensity||(t.height/=t.resolution)),super(t),this.uploadMethodId="image",this.autoDensity=t.autoDensity;const e=t.resource;(this.pixelWidth!==e.width||this.pixelWidth!==e.height)&&this.resizeCanvas(),this.transparent=!!t.transparent}resizeCanvas(){this.autoDensity&&(this.resource.style.width=`${this.width}px`,this.resource.style.height=`${this.height}px`),(this.resource.width!==this.pixelWidth||this.resource.height!==this.pixelHeight)&&(this.resource.width=this.pixelWidth,this.resource.height=this.pixelHeight)}resize(t=this.width,e=this.height,r=this._resolution){const s=super.resize(t,e,r);return s&&this.resizeCanvas(),s}static test(t){return globalThis.HTMLCanvasElement&&t instanceof HTMLCanvasElement||globalThis.OffscreenCanvas&&t instanceof OffscreenCanvas}}ls.extension=u.TextureSource;class hs extends Cr{constructor(t){if(t.resource&&globalThis.HTMLImageElement&&t.resource instanceof HTMLImageElement){const e=Ne.get().createCanvas(t.resource.width,t.resource.height);e.getContext("2d").drawImage(t.resource,0,0),t.resource=e}super(t),this.uploadMethodId="image",this.autoGarbageCollect=!0}static test(t){return globalThis.HTMLImageElement&&t instanceof HTMLImageElement||"undefined"!=typeof ImageBitmap&&t instanceof ImageBitmap}}let us;async function cs(){return null!=us||(us=(async()=>{var t;const e=document.createElement("canvas").getContext("webgl");if(!e)return"premultiply-alpha-on-upload";const r=await new Promise((t=>{const e=document.createElement("video");e.onloadeddata=()=>t(e),e.onerror=()=>t(null),e.autoplay=!1,e.crossOrigin="anonymous",e.preload="auto",e.src="data:video/webm;base64,GkXfo59ChoEBQveBAULygQRC84EIQoKEd2VibUKHgQJChYECGFOAZwEAAAAAAAHTEU2bdLpNu4tTq4QVSalmU6yBoU27i1OrhBZUrmtTrIHGTbuMU6uEElTDZ1OsggEXTbuMU6uEHFO7a1OsggG97AEAAAAAAABZAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAVSalmoCrXsYMPQkBNgIRMYXZmV0GETGF2ZkSJiEBEAAAAAAAAFlSua8yuAQAAAAAAAEPXgQFzxYgAAAAAAAAAAZyBACK1nIN1bmSIgQCGhVZfVlA5g4EBI+ODhAJiWgDglLCBArqBApqBAlPAgQFVsIRVuYEBElTDZ9Vzc9JjwItjxYgAAAAAAAAAAWfInEWjh0VOQ09ERVJEh49MYXZjIGxpYnZweC12cDlnyKJFo4hEVVJBVElPTkSHlDAwOjAwOjAwLjA0MDAwMDAwMAAAH0O2dcfngQCgwqGggQAAAIJJg0IAABAAFgA4JBwYSgAAICAAEb///4r+AAB1oZ2mm+6BAaWWgkmDQgAAEAAWADgkHBhKAAAgIABIQBxTu2uRu4+zgQC3iveBAfGCAXHwgQM=",e.load()}));if(!r)return"premultiply-alpha-on-upload";const s=e.createTexture();e.bindTexture(e.TEXTURE_2D,s);const i=e.createFramebuffer();e.bindFramebuffer(e.FRAMEBUFFER,i),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,s,0),e.pixelStorei(e.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),e.pixelStorei(e.UNPACK_COLORSPACE_CONVERSION_WEBGL,e.NONE),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,r);const n=new Uint8Array(4);return e.readPixels(0,0,1,1,e.RGBA,e.UNSIGNED_BYTE,n),e.deleteFramebuffer(i),e.deleteTexture(s),null==(t=e.getExtension("WEBGL_lose_context"))||t.loseContext(),n[0]<=n[3]?"premultiplied-alpha":"premultiply-alpha-on-upload"})()),us}hs.extension=u.TextureSource;var ds=Object.defineProperty,ps=Object.defineProperties,fs=Object.getOwnPropertyDescriptors,gs=Object.getOwnPropertySymbols,ms=Object.prototype.hasOwnProperty,_s=Object.prototype.propertyIsEnumerable,xs=(t,e,r)=>e in t?ds(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r,ys=(t,e)=>{for(var r in e||(e={}))ms.call(e,r)&&xs(t,r,e[r]);if(gs)for(var r of gs(e))_s.call(e,r)&&xs(t,r,e[r]);return t};const bs=class t extends Cr{constructor(e){var r;super(e),this.isReady=!1,this.uploadMethodId="video",e=ys(ys({},t.defaultOptions),e),this._autoUpdate=!0,this._isConnectedToTicker=!1,this._updateFPS=e.updateFPS||0,this._msToNextUpdate=0,this.autoPlay=!1!==e.autoPlay,this.alphaMode=null!=(r=e.alphaMode)?r:"premultiply-alpha-on-upload",this._videoFrameRequestCallback=this._videoFrameRequestCallback.bind(this),this._videoFrameRequestCallbackHandle=null,this._load=null,this._resolve=null,this._reject=null,this._onCanPlay=this._onCanPlay.bind(this),this._onCanPlayThrough=this._onCanPlayThrough.bind(this),this._onError=this._onError.bind(this),this._onPlayStart=this._onPlayStart.bind(this),this._onPlayStop=this._onPlayStop.bind(this),this._onSeeked=this._onSeeked.bind(this),!1!==e.autoLoad&&this.load()}updateFrame(){if(!this.destroyed){if(this._updateFPS){const t=_e.shared.elapsedMS*this.resource.playbackRate;this._msToNextUpdate=Math.floor(this._msToNextUpdate-t)}(!this._updateFPS||this._msToNextUpdate<=0)&&(this._msToNextUpdate=this._updateFPS?Math.floor(1e3/this._updateFPS):0),this.isValid&&this.update()}}_videoFrameRequestCallback(){this.updateFrame(),this.destroyed?this._videoFrameRequestCallbackHandle=null:this._videoFrameRequestCallbackHandle=this.resource.requestVideoFrameCallback(this._videoFrameRequestCallback)}get isValid(){return!!this.resource.videoWidth&&!!this.resource.videoHeight}async load(){if(this._load)return this._load;const t=this.resource,e=this.options;return(t.readyState===t.HAVE_ENOUGH_DATA||t.readyState===t.HAVE_FUTURE_DATA)&&t.width&&t.height&&(t.complete=!0),t.addEventListener("play",this._onPlayStart),t.addEventListener("pause",this._onPlayStop),t.addEventListener("seeked",this._onSeeked),this._isSourceReady()?this._mediaReady():(e.preload||t.addEventListener("canplay",this._onCanPlay),t.addEventListener("canplaythrough",this._onCanPlayThrough),t.addEventListener("error",this._onError,!0)),this.alphaMode=await cs(),this._load=new Promise(((r,s)=>{this.isValid?r(this):(this._resolve=r,this._reject=s,void 0!==e.preloadTimeoutMs&&(this._preloadTimeout=setTimeout((()=>{this._onError(new ErrorEvent(`Preload exceeded timeout of ${e.preloadTimeoutMs}ms`))}))),t.load())})),this._load}_onError(t){this.resource.removeEventListener("error",this._onError,!0),this.emit("error",t),this._reject&&(this._reject(t),this._reject=null,this._resolve=null)}_isSourcePlaying(){const t=this.resource;return!t.paused&&!t.ended}_isSourceReady(){return this.resource.readyState>2}_onPlayStart(){this.isValid||this._mediaReady(),this._configureAutoUpdate()}_onPlayStop(){this._configureAutoUpdate()}_onSeeked(){this._autoUpdate&&!this._isSourcePlaying()&&(this._msToNextUpdate=0,this.updateFrame(),this._msToNextUpdate=0)}_onCanPlay(){this.resource.removeEventListener("canplay",this._onCanPlay),this._mediaReady()}_onCanPlayThrough(){this.resource.removeEventListener("canplaythrough",this._onCanPlay),this._preloadTimeout&&(clearTimeout(this._preloadTimeout),this._preloadTimeout=void 0),this._mediaReady()}_mediaReady(){const t=this.resource;this.isValid&&(this.isReady=!0,this.resize(t.videoWidth,t.videoHeight)),this._msToNextUpdate=0,this.updateFrame(),this._msToNextUpdate=0,this._resolve&&(this._resolve(this),this._resolve=null,this._reject=null),this._isSourcePlaying()?this._onPlayStart():this.autoPlay&&this.resource.play()}destroy(){this._configureAutoUpdate();const t=this.resource;t&&(t.removeEventListener("play",this._onPlayStart),t.removeEventListener("pause",this._onPlayStop),t.removeEventListener("seeked",this._onSeeked),t.removeEventListener("canplay",this._onCanPlay),t.removeEventListener("canplaythrough",this._onCanPlayThrough),t.removeEventListener("error",this._onError,!0),t.pause(),t.src="",t.load()),super.destroy()}get autoUpdate(){return this._autoUpdate}set autoUpdate(t){t!==this._autoUpdate&&(this._autoUpdate=t,this._configureAutoUpdate())}get updateFPS(){return this._updateFPS}set updateFPS(t){t!==this._updateFPS&&(this._updateFPS=t,this._configureAutoUpdate())}_configureAutoUpdate(){this._autoUpdate&&this._isSourcePlaying()?!this._updateFPS&&this.resource.requestVideoFrameCallback?(this._isConnectedToTicker&&(_e.shared.remove(this.updateFrame,this),this._isConnectedToTicker=!1,this._msToNextUpdate=0),null===this._videoFrameRequestCallbackHandle&&(this._videoFrameRequestCallbackHandle=this.resource.requestVideoFrameCallback(this._videoFrameRequestCallback))):(null!==this._videoFrameRequestCallbackHandle&&(this.resource.cancelVideoFrameCallback(this._videoFrameRequestCallbackHandle),this._videoFrameRequestCallbackHandle=null),this._isConnectedToTicker||(_e.shared.add(this.updateFrame,this),this._isConnectedToTicker=!0,this._msToNextUpdate=0)):(null!==this._videoFrameRequestCallbackHandle&&(this.resource.cancelVideoFrameCallback(this._videoFrameRequestCallbackHandle),this._videoFrameRequestCallbackHandle=null),this._isConnectedToTicker&&(_e.shared.remove(this.updateFrame,this),this._isConnectedToTicker=!1,this._msToNextUpdate=0))}static test(t){return globalThis.HTMLVideoElement&&t instanceof HTMLVideoElement||globalThis.VideoFrame&&t instanceof VideoFrame}};bs.extension=u.TextureSource,bs.defaultOptions=((t,e)=>ps(t,fs(e)))(ys({},Cr.defaultOptions),{autoLoad:!0,autoPlay:!0,updateFPS:0,crossorigin:!0,loop:!1,muted:!0,playsinline:!0,preload:!1}),bs.MIME_TYPES={ogv:"video/ogg",mov:"video/quicktime",m4v:"video/mp4"};let vs=bs;const Ts=new class{constructor(){this._parsers=[],this._cache=new Map,this._cacheMap=new Map}reset(){this._cacheMap.clear(),this._cache.clear()}has(t){return this._cache.has(t)}get(t){return this._cache.get(t)}set(t,e){const r=ze(t);let s;for(let t=0;t<this.parsers.length;t++){const i=this.parsers[t];if(i.test(e)){s=i.getCacheableAssets(r,e);break}}const i=new Map(Object.entries(s||{}));s||r.forEach((t=>{i.set(t,e)}));const n=[...i.keys()],o={cacheKeys:n,keys:r};r.forEach((t=>{this._cacheMap.set(t,o)})),n.forEach((t=>{s&&s[t];this._cache.has(t)&&this._cache.get(t),this._cache.set(t,i.get(t))}))}remove(t){if(!this._cacheMap.has(t))return;const e=this._cacheMap.get(t);e.cacheKeys.forEach((t=>{this._cache.delete(t)})),e.keys.forEach((t=>{this._cacheMap.delete(t)}))}get parsers(){return this._parsers}},Ss=[];function ws(t={}){const e=t&&t.resource,r=e?t.resource:t,s=e?t:{resource:t};for(let t=0;t<Ss.length;t++){const e=Ss[t];if(e.test(r))return new e(s)}throw new Error(`Could not find a source type for resource: ${s.resource}`)}function Es(t={},e=!1){const r=t&&t.resource,s=r?t.resource:t,i=r?t:{resource:t};if(!e&&Ts.has(s))return Ts.get(s);const n=new zr({source:ws(i)});return n.on("destroy",(()=>{Ts.has(s)&&Ts.remove(s)})),e||Ts.set(s,n),n}function As(t,e=!1){return"string"==typeof t?Ts.get(t):t instanceof Cr?new zr({source:t}):Es(t,e)}p.handleByList(u.TextureSource,Ss),zr.from=As,p.add(ns,os,as,vs,hs,ls,Ur);var Ms=(t=>(t[t.MAP_READ=1]="MAP_READ",t[t.MAP_WRITE=2]="MAP_WRITE",t[t.COPY_SRC=4]="COPY_SRC",t[t.COPY_DST=8]="COPY_DST",t[t.INDEX=16]="INDEX",t[t.VERTEX=32]="VERTEX",t[t.UNIFORM=64]="UNIFORM",t[t.STORAGE=128]="STORAGE",t[t.INDIRECT=256]="INDIRECT",t[t.QUERY_RESOLVE=512]="QUERY_RESOLVE",t[t.STATIC=1024]="STATIC",t))(Ms||{});class Ps extends m{constructor(t){let{data:e,size:r}=t;const{usage:s,label:i,shrinkToFit:n}=t;super(),this.uid=ht("buffer"),this._resourceType="buffer",this._resourceId=ht("resource"),this._touched=0,this._updateID=1,this.shrinkToFit=!0,this.destroyed=!1,e instanceof Array&&(e=new Float32Array(e)),this._data=e,r=null!=r?r:null==e?void 0:e.byteLength;const o=!!e;this.descriptor={size:r,usage:s,mappedAtCreation:o,label:i},this.shrinkToFit=null==n||n}get data(){return this._data}set data(t){this.setDataWithSize(t,t.length,!0)}get static(){return!!(this.descriptor.usage&Ms.STATIC)}set static(t){t?this.descriptor.usage|=Ms.STATIC:this.descriptor.usage&=~Ms.STATIC}setDataWithSize(t,e,r){if(this._updateID++,this._updateSize=e*t.BYTES_PER_ELEMENT,this._data===t)return void(r&&this.emit("update",this));const s=this._data;this._data=t,s.length===t.length||!this.shrinkToFit&&t.byteLength<s.byteLength?r&&this.emit("update",this):(this.descriptor.size=t.byteLength,this._resourceId=ht("resource"),this.emit("change",this))}update(t){this._updateSize=null!=t?t:this._updateSize,this._updateID++,this.emit("update",this)}destroy(){this.destroyed=!0,this.emit("destroy",this),this.emit("change",this),this._data=null,this.descriptor=null,this.removeAllListeners()}}function Rs(t,e){if(!(t instanceof Ps)){let r=e?Ms.INDEX:Ms.VERTEX;t instanceof Array&&(e?(t=new Uint32Array(t),r=Ms.INDEX|Ms.COPY_DST):(t=new Float32Array(t),r=Ms.VERTEX|Ms.COPY_DST)),t=new Ps({data:t,label:e?"index-mesh-buffer":"vertex-mesh-buffer",usage:r})}return t}function Os(t,e,r){const s=t.getAttribute(e);if(!s)return r.minX=0,r.minY=0,r.maxX=0,r.maxY=0,r;const i=s.buffer.data;let n=1/0,o=1/0,a=-1/0,l=-1/0;const h=i.BYTES_PER_ELEMENT,u=(s.offset||0)/h,c=(s.stride||8)/h;for(let t=u;t<i.length;t+=c){const e=i[t],r=i[t+1];e>a&&(a=e),r>l&&(l=r),e<n&&(n=e),r<o&&(o=r)}return r.minX=n,r.minY=o,r.maxX=a,r.maxY=l,r}function Cs(t){return(t instanceof Ps||Array.isArray(t)||t.BYTES_PER_ELEMENT)&&(t={buffer:t}),t.buffer=Rs(t.buffer,!1),t}class Is extends m{constructor(t){const{attributes:e,indexBuffer:r,topology:s}=t;super(),this.uid=ht("geometry"),this._layoutKey=0,this.instanceCount=1,this._bounds=new St,this._boundsDirty=!0,this.attributes=e,this.buffers=[],this.instanceCount=t.instanceCount||1;for(const t in e){const r=e[t]=Cs(e[t]);-1===this.buffers.indexOf(r.buffer)&&(this.buffers.push(r.buffer),r.buffer.on("update",this.onBufferUpdate,this),r.buffer.on("change",this.onBufferUpdate,this))}r&&(this.indexBuffer=Rs(r,!0),this.buffers.push(this.indexBuffer)),this.topology=s||"triangle-list"}onBufferUpdate(){this._boundsDirty=!0,this.emit("update",this)}getAttribute(t){return this.attributes[t]}getIndex(){return this.indexBuffer}getBuffer(t){return this.getAttribute(t).buffer}getSize(){for(const t in this.attributes){const e=this.attributes[t];return e.buffer.data.length/(e.stride/4||e.size)}return 0}get bounds(){return this._boundsDirty?(this._boundsDirty=!1,Os(this,"aPosition",this._bounds)):this._bounds}destroy(t=!1){this.emit("destroy",this),this.removeAllListeners(),t&&this.buffers.forEach((t=>t.destroy())),this.attributes=null,this.buffers=null,this.indexBuffer=null,this._bounds=null}}const Gs=new Float32Array(1),ks=new Uint32Array(1);class Bs extends Is{constructor(){const t=new Ps({data:Gs,label:"attribute-batch-buffer",usage:Ms.VERTEX|Ms.COPY_DST,shrinkToFit:!1});super({attributes:{aPosition:{buffer:t,format:"float32x2",stride:24,offset:0,location:1},aUV:{buffer:t,format:"float32x2",stride:24,offset:8,location:3},aColor:{buffer:t,format:"unorm8x4",stride:24,offset:16,location:0},aTextureIdAndRound:{buffer:t,format:"uint16x2",stride:24,offset:20,location:2}},indexBuffer:new Ps({data:ks,label:"index-batch-buffer",usage:Ms.INDEX|Ms.COPY_DST,shrinkToFit:!1})})}}class Ds{constructor(t){this.resources=Object.create(null),this._dirty=!0;let e=0;for(const r in t){const s=t[r];this.setResource(s,e++)}this._updateKey()}_updateKey(){if(!this._dirty)return;this._dirty=!1;const t=[];let e=0;for(const r in this.resources)t[e++]=this.resources[r]._resourceId;this._key=t.join("|")}setResource(t,e){var r,s;const i=this.resources[e];t!==i&&(i&&(null==(r=t.off)||r.call(t,"change",this.onResourceChange,this)),null==(s=t.on)||s.call(t,"change",this.onResourceChange,this),this.resources[e]=t,this._dirty=!0)}getResource(t){return this.resources[t]}_touch(t){const e=this.resources;for(const r in e)e[r]._touched=t}destroy(){var t;const e=this.resources;for(const r in e){const s=e[r];null==(t=s.off)||t.call(s,"change",this.onResourceChange,this)}this.resources=null}onResourceChange(t){if(this._dirty=!0,t.destroyed){const e=this.resources;for(const r in e)e[r]===t&&(e[r]=null)}else this._updateKey()}}const Fs=16,Ns={};function Us(t,e){let r=0;for(let s=0;s<e;s++)r=31*r+t[s].uid>>>0;return Ns[r]||function(t,e){const r={};let s=0;for(let e=0;e<Fs;e++){const i=e<t.length?t[e]:zr.EMPTY.source;r[s++]=i.source,r[s++]=i.style}const i=new Ds(r);return Ns[e]=i,i}(t,r)}class Ls{constructor(t){"number"==typeof t?this.rawBinaryData=new ArrayBuffer(t):t instanceof Uint8Array?this.rawBinaryData=t.buffer:this.rawBinaryData=t,this.uint32View=new Uint32Array(this.rawBinaryData),this.float32View=new Float32Array(this.rawBinaryData),this.size=this.rawBinaryData.byteLength}get int8View(){return this._int8View||(this._int8View=new Int8Array(this.rawBinaryData)),this._int8View}get uint8View(){return this._uint8View||(this._uint8View=new Uint8Array(this.rawBinaryData)),this._uint8View}get int16View(){return this._int16View||(this._int16View=new Int16Array(this.rawBinaryData)),this._int16View}get int32View(){return this._int32View||(this._int32View=new Int32Array(this.rawBinaryData)),this._int32View}get float64View(){return this._float64Array||(this._float64Array=new Float64Array(this.rawBinaryData)),this._float64Array}get bigUint64View(){return this._bigUint64Array||(this._bigUint64Array=new BigUint64Array(this.rawBinaryData)),this._bigUint64Array}view(t){return this[`${t}View`]}destroy(){this.rawBinaryData=null,this._int8View=null,this._uint8View=null,this._int16View=null,this.uint16View=null,this._int32View=null,this.uint32View=null,this.float32View=null}static sizeOf(t){switch(t){case"int8":case"uint8":return 1;case"int16":case"uint16":return 2;case"int32":case"uint32":case"float32":return 4;default:throw new Error(`${t} isn't a valid view type`)}}}function Xs(t,e){const r=t.byteLength/8|0,s=new Float64Array(t,0,r);new Float64Array(e,0,r).set(s);const i=t.byteLength-8*r;if(i>0){const s=new Uint8Array(t,8*r,i);new Uint8Array(e,8*r,i).set(s)}}const zs={normal:"normal-npm",add:"add-npm",screen:"screen-npm"};var Hs=(t=>(t[t.DISABLED=0]="DISABLED",t[t.RENDERING_MASK_ADD=1]="RENDERING_MASK_ADD",t[t.MASK_ACTIVE=2]="MASK_ACTIVE",t[t.RENDERING_MASK_REMOVE=3]="RENDERING_MASK_REMOVE",t[t.NONE=4]="NONE",t))(Hs||{});function js(t,e){return"no-premultiply-alpha"===e.alphaMode&&zs[t]||t}class Vs{constructor(){this.ids=Object.create(null),this.textures=[],this.count=0}clear(){for(let t=0;t<this.count;t++){const e=this.textures[t];this.textures[t]=null,this.ids[e.uid]=null}this.count=0}}var Ws=Object.defineProperty,$s=Object.getOwnPropertySymbols,Ys=Object.prototype.hasOwnProperty,qs=Object.prototype.propertyIsEnumerable,Ks=(t,e,r)=>e in t?Ws(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r,Zs=(t,e)=>{for(var r in e||(e={}))Ys.call(e,r)&&Ks(t,r,e[r]);if($s)for(var r of $s(e))qs.call(e,r)&&Ks(t,r,e[r]);return t};class Qs{constructor(){this.renderPipeId="batch",this.action="startBatch",this.start=0,this.size=0,this.blendMode="normal",this.canBundle=!0}destroy(){this.textures=null,this.gpuBindGroup=null,this.bindGroup=null,this.batcher=null}}let Js=0;const ti=class t{constructor(e={}){this.uid=ht("batcher"),this.dirty=!0,this.batchIndex=0,this.batches=[],this._vertexSize=6,this._elements=[],this._batchPool=[],this._batchPoolIndex=0,this._textureBatchPool=[],this._textureBatchPoolIndex=0,e=Zs(Zs({},t.defaultOptions),e);const{vertexSize:r,indexSize:s}=e;this.attributeBuffer=new Ls(r*this._vertexSize*4),this.indexBuffer=new Uint16Array(s)}begin(){this.batchIndex=0,this.elementSize=0,this.elementStart=0,this.indexSize=0,this.attributeSize=0,this._batchPoolIndex=0,this._textureBatchPoolIndex=0,this._batchIndexStart=0,this._batchIndexSize=0,this.dirty=!0}add(t){this._elements[this.elementSize++]=t,t.indexStart=this.indexSize,t.location=this.attributeSize,t.batcher=this,this.indexSize+=t.indexSize,this.attributeSize+=t.vertexSize*this._vertexSize}checkAndUpdateTexture(t,e){const r=t.batch.textures.ids[e._source.uid];return!(!r&&0!==r)&&(t.textureId=r,t.texture=e,!0)}updateElement(t){this.dirty=!0,t.packAttributes(this.attributeBuffer.float32View,this.attributeBuffer.uint32View,t.location,t.textureId)}break(t){const e=this._elements;let r=this._textureBatchPool[this._textureBatchPoolIndex++]||new Vs;if(r.clear(),!e[this.elementStart])return;const s=e[this.elementStart];let i=js(s.blendMode,s.texture._source);4*this.attributeSize>this.attributeBuffer.size&&this._resizeAttributeBuffer(4*this.attributeSize),this.indexSize>this.indexBuffer.length&&this._resizeIndexBuffer(this.indexSize);const n=this.attributeBuffer.float32View,o=this.attributeBuffer.uint32View,a=this.indexBuffer;let l=this._batchIndexSize,h=this._batchIndexStart,u="startBatch",c=this._batchPool[this._batchPoolIndex++]||new Qs;for(let s=this.elementStart;s<this.elementSize;++s){const d=e[s];e[s]=null;const p=d.texture._source,f=js(d.blendMode,p),g=i!==f;p._batchTick!==Js||g?(p._batchTick=Js,(r.count>=Fs||g)&&(this._finishBatch(c,h,l-h,r,i,t,u),u="renderBatch",h=l,i=f,r=this._textureBatchPool[this._textureBatchPoolIndex++]||new Vs,r.clear(),c=this._batchPool[this._batchPoolIndex++]||new Qs,++Js),d.textureId=p._textureBindLocation=r.count,r.ids[p.uid]=r.count,r.textures[r.count++]=p,d.batch=c,l+=d.indexSize,d.packAttributes(n,o,d.location,d.textureId),d.packIndex(a,d.indexStart,d.location/this._vertexSize)):(d.textureId=p._textureBindLocation,l+=d.indexSize,d.packAttributes(n,o,d.location,d.textureId),d.packIndex(a,d.indexStart,d.location/this._vertexSize),d.batch=c)}r.count>0&&(this._finishBatch(c,h,l-h,r,i,t,u),h=l,++Js),this.elementStart=this.elementSize,this._batchIndexStart=h,this._batchIndexSize=l}_finishBatch(t,e,r,s,i,n,o){t.gpuBindGroup=null,t.action=o,t.batcher=this,t.textures=s,t.blendMode=i,t.start=e,t.size=r,++Js,n.add(t)}finish(t){this.break(t)}ensureAttributeBuffer(t){4*t<=this.attributeBuffer.size||this._resizeAttributeBuffer(4*t)}ensureIndexBuffer(t){t<=this.indexBuffer.length||this._resizeIndexBuffer(t)}_resizeAttributeBuffer(t){const e=Math.max(t,2*this.attributeBuffer.size),r=new Ls(e);Xs(this.attributeBuffer.rawBinaryData,r.rawBinaryData),this.attributeBuffer=r}_resizeIndexBuffer(t){const e=this.indexBuffer;let r=Math.max(t,1.5*e.length);r+=r%2;const s=r>65535?new Uint32Array(r):new Uint16Array(r);if(s.BYTES_PER_ELEMENT!==e.BYTES_PER_ELEMENT)for(let t=0;t<e.length;t++)s[t]=e[t];else Xs(e.buffer,s.buffer);this.indexBuffer=s}destroy(){for(let t=0;t<this.batches.length;t++)this.batches[t].destroy();this.batches=null;for(let t=0;t<this._elements.length;t++)this._elements[t].batch=null;this._elements=null,this.indexBuffer=null,this.attributeBuffer.destroy(),this.attributeBuffer=null}};ti.defaultOptions={vertexSize:4,indexSize:6};let ei=ti;function ri(t,e,r,s,i,n,o,a=null){let l=0;r*=e,i*=n;const h=a.a,u=a.b,c=a.c,d=a.d,p=a.tx,f=a.ty;for(;l<o;){const o=t[r],a=t[r+1];s[i]=h*o+c*a+p,s[i+1]=u*o+d*a+f,i+=n,r+=e,l++}}function si(t,e,r,s){let i=0;for(e*=r;i<s;)t[e]=0,t[e+1]=0,e+=r,i++}function ii(t,e,r,s,i){const n=e.a,o=e.b,a=e.c,l=e.d,h=e.tx,u=e.ty;r=r||0,s=s||2,i=i||t.length/s-r;let c=r*s;for(let e=0;e<i;e++){const e=t[c],r=t[c+1];t[c]=n*e+a*r+h,t[c+1]=o*e+l*r+u,c+=s}}function ni(t,e,r){const s=t>>16&255,i=t>>8&255,n=255&t;return(s+((e>>16&255)-s)*r<<16)+(i+((e>>8&255)-i)*r<<8)+(n+((255&e)-n)*r)}const oi=16777215;function ai(t,e){return t===oi||e===oi?t+e-oi:ni(t,e,.5)}class li{constructor(){this.batcher=null,this.batch=null,this.applyTransform=!0,this.roundPixels=0}get blendMode(){return this.applyTransform?this.renderable.groupBlendMode:"normal"}packIndex(t,e,r){const s=this.geometryData.indices;for(let i=0;i<this.indexSize;i++)t[e++]=s[i+this.indexOffset]+r-this.vertexOffset}packAttributes(t,e,r,s){const i=this.geometryData,n=this.renderable,o=i.vertices,a=i.uvs,l=2*this.vertexOffset,h=2*(this.vertexOffset+this.vertexSize),u=this.color,c=u>>16|65280&u|(255&u)<<16;if(this.applyTransform){const i=ai(c,n.groupColor)+(this.alpha*n.groupAlpha*255<<24),u=n.groupTransform,d=s<<16|65535&this.roundPixels,p=u.a,f=u.b,g=u.c,m=u.d,_=u.tx,x=u.ty;for(let s=l;s<h;s+=2){const n=o[s],l=o[s+1];t[r]=p*n+g*l+_,t[r+1]=f*n+m*l+x,t[r+2]=a[s],t[r+3]=a[s+1],e[r+4]=i,e[r+5]=d,r+=6}}else{const i=c+(255*this.alpha<<24);for(let n=l;n<h;n+=2)t[r]=o[n],t[r+1]=o[n+1],t[r+2]=a[n],t[r+3]=a[n+1],e[r+4]=i,e[r+5]=s<<16,r+=6}}get vertSize(){return this.vertexSize}copyTo(t){t.indexOffset=this.indexOffset,t.indexSize=this.indexSize,t.vertexOffset=this.vertexOffset,t.vertexSize=this.vertexSize,t.color=this.color,t.alpha=this.alpha,t.texture=this.texture,t.geometryData=this.geometryData}reset(){this.applyTransform=!0}}const hi={build(t,e){let r,s,i,n,o,a;if("circle"===t.type){const e=t;r=e.x,s=e.y,o=a=e.radius,i=n=0}else if("ellipse"===t.type){const e=t;r=e.x,s=e.y,o=e.halfWidth,a=e.halfHeight,i=n=0}else{const e=t,l=e.width/2,h=e.height/2;r=e.x+l,s=e.y+h,o=a=Math.max(0,Math.min(e.radius,Math.min(l,h))),i=l-o,n=h-a}if(!(o>=0&&a>=0&&i>=0&&n>=0))return e;const l=Math.ceil(2.3*Math.sqrt(o+a)),h=8*l+(i?4:0)+(n?4:0);if(0===h)return e;if(0===l)return e[0]=e[6]=r+i,e[1]=e[3]=s+n,e[2]=e[4]=r-i,e[5]=e[7]=s-n,e;let u=0,c=4*l+(i?2:0)+2,d=c,p=h,f=i+o,g=n,m=r+f,_=r-f,x=s+g;if(e[u++]=m,e[u++]=x,e[--c]=x,e[--c]=_,n){const t=s-g;e[d++]=_,e[d++]=t,e[--p]=t,e[--p]=m}for(let t=1;t<l;t++){const h=Math.PI/2*(t/l),f=i+Math.cos(h)*o,g=n+Math.sin(h)*a,m=r+f,_=r-f,x=s+g,y=s-g;e[u++]=m,e[u++]=x,e[--c]=x,e[--c]=_,e[d++]=_,e[d++]=y,e[--p]=y,e[--p]=m}f=i,g=n+a,m=r+f,_=r-f,x=s+g;const y=s-g;return e[u++]=m,e[u++]=x,e[--p]=y,e[--p]=m,i&&(e[u++]=_,e[u++]=x,e[--p]=y,e[--p]=_),e},triangulate(t,e,r,s,i,n){if(0===t.length)return;let o=0,a=0;for(let e=0;e<t.length;e+=2)o+=t[e],a+=t[e+1];o/=t.length/2,a/=t.length/2;let l=s;e[l*r]=o,e[l*r+1]=a;const h=l++;for(let s=0;s<t.length;s+=2)e[l*r]=t[s],e[l*r+1]=t[s+1],s>0&&(i[n++]=l,i[n++]=h,i[n++]=l-1),l++;i[n++]=h+1,i[n++]=h,i[n++]=l-1}},ui=1e-4,ci=1e-4;function di(t){const e=t.length;if(e<6)return 1;let r=0;for(let s=0,i=t[e-2],n=t[e-1];s<e;s+=2){const e=t[s],o=t[s+1];r+=(e-i)*(o+n),i=e,n=o}return r<0?-1:1}function pi(t,e,r,s,i,n,o,a){let l,h;o?(l=s,h=-r):(l=-s,h=r);const u=t-r*i+l,c=e-s*i+h,d=t+r*n+l,p=e+s*n+h;return a.push(u,c),a.push(d,p),2}function fi(t,e,r,s,i,n,o,a){const l=r-t,h=s-e;let u=Math.atan2(l,h),c=Math.atan2(i-t,n-e);a&&u<c?u+=2*Math.PI:!a&&u>c&&(c+=2*Math.PI);let d=u;const p=c-u,f=Math.abs(p),g=Math.sqrt(l*l+h*h),m=1+(15*f*Math.sqrt(g)/Math.PI>>0),_=p/m;if(d+=_,a){o.push(t,e),o.push(r,s);for(let r=1,s=d;r<m;r++,s+=_)o.push(t,e),o.push(t+Math.sin(s)*g,e+Math.cos(s)*g);o.push(t,e),o.push(i,n)}else{o.push(r,s),o.push(t,e);for(let r=1,s=d;r<m;r++,s+=_)o.push(t+Math.sin(s)*g,e+Math.cos(s)*g),o.push(t,e);o.push(i,n),o.push(t,e)}return 2*m}function gi(t,e,r,s,i,n,o,a,l){const h=ui;if(0===t.length)return;const u=e;let c=u.alignment;if(.5!==e.alignment){let e=di(t);r&&(e*=-1),c=(c-.5)*e+.5}const d=new rt(t[0],t[1]),p=new rt(t[t.length-2],t[t.length-1]),f=s,g=Math.abs(d.x-p.x)<h&&Math.abs(d.y-p.y)<h;if(f){t=t.slice(),g&&(t.pop(),t.pop(),p.set(t[t.length-2],t[t.length-1]));const e=.5*(d.x+p.x),r=.5*(p.y+d.y);t.unshift(e,r),t.push(e,r)}const m=i,_=t.length/2;let x=t.length;const y=m.length/2,b=u.width/2,v=b*b,T=u.miterLimit*u.miterLimit;let S=t[0],w=t[1],E=t[2],A=t[3],M=0,P=0,R=-(w-A),O=S-E,C=0,I=0,G=Math.sqrt(R*R+O*O);R/=G,O/=G,R*=b,O*=b;const k=2*(1-c),B=2*c;f||("round"===u.cap?x+=fi(S-R*(k-B)*.5,w-O*(k-B)*.5,S-R*k,w-O*k,S+R*B,w+O*B,m,!0)+2:"square"===u.cap&&(x+=pi(S,w,R,O,k,B,!0,m))),m.push(S-R*k,w-O*k),m.push(S+R*B,w+O*B);for(let e=1;e<_-1;++e){S=t[2*(e-1)],w=t[2*(e-1)+1],E=t[2*e],A=t[2*e+1],M=t[2*(e+1)],P=t[2*(e+1)+1],R=-(w-A),O=S-E,G=Math.sqrt(R*R+O*O),R/=G,O/=G,R*=b,O*=b,C=-(A-P),I=E-M,G=Math.sqrt(C*C+I*I),C/=G,I/=G,C*=b,I*=b;const r=E-S,s=w-A,i=E-M,n=P-A,o=r*i+s*n,a=s*i-n*r,l=a<0;if(Math.abs(a)<.001*Math.abs(o)){m.push(E-R*k,A-O*k),m.push(E+R*B,A+O*B),o>=0&&("round"===u.join?x+=fi(E,A,E-R*k,A-O*k,E-C*k,A-I*k,m,!1)+4:x+=2,m.push(E-C*B,A-I*B),m.push(E+C*k,A+I*k));continue}const h=(-R+S)*(-O+A)-(-R+E)*(-O+w),c=(-C+M)*(-I+A)-(-C+E)*(-I+P),d=(r*c-i*h)/a,p=(n*h-s*c)/a,f=(d-E)*(d-E)+(p-A)*(p-A),g=E+(d-E)*k,_=A+(p-A)*k,y=E-(d-E)*B,D=A-(p-A)*B,F=l?k:B;f<=Math.min(r*r+s*s,i*i+n*n)+F*F*v?"bevel"===u.join||f/v>T?(l?(m.push(g,_),m.push(E+R*B,A+O*B),m.push(g,_),m.push(E+C*B,A+I*B)):(m.push(E-R*k,A-O*k),m.push(y,D),m.push(E-C*k,A-I*k),m.push(y,D)),x+=2):"round"===u.join?l?(m.push(g,_),m.push(E+R*B,A+O*B),x+=fi(E,A,E+R*B,A+O*B,E+C*B,A+I*B,m,!0)+4,m.push(g,_),m.push(E+C*B,A+I*B)):(m.push(E-R*k,A-O*k),m.push(y,D),x+=fi(E,A,E-R*k,A-O*k,E-C*k,A-I*k,m,!1)+4,m.push(E-C*k,A-I*k),m.push(y,D)):(m.push(g,_),m.push(y,D)):(m.push(E-R*k,A-O*k),m.push(E+R*B,A+O*B),"round"===u.join?x+=l?fi(E,A,E+R*B,A+O*B,E+C*B,A+I*B,m,!0)+2:fi(E,A,E-R*k,A-O*k,E-C*k,A-I*k,m,!1)+2:"miter"===u.join&&f/v<=T&&(l?(m.push(y,D),m.push(y,D)):(m.push(g,_),m.push(g,_)),x+=2),m.push(E-C*k,A-I*k),m.push(E+C*B,A+I*B),x+=2)}S=t[2*(_-2)],w=t[2*(_-2)+1],E=t[2*(_-1)],A=t[2*(_-1)+1],R=-(w-A),O=S-E,G=Math.sqrt(R*R+O*O),R/=G,O/=G,R*=b,O*=b,m.push(E-R*k,A-O*k),m.push(E+R*B,A+O*B),f||("round"===u.cap?x+=fi(E-R*(k-B)*.5,A-O*(k-B)*.5,E-R*k,A-O*k,E+R*B,A+O*B,m,!1)+2:"square"===u.cap&&(x+=pi(E,A,R,O,k,B,!1,m)));for(let t=y;t<x+y-2;++t)S=m[2*t],w=m[2*t+1],E=m[2*(t+1)],A=m[2*(t+1)+1],M=m[2*(t+2)],P=m[2*(t+2)+1],!(Math.abs(S*(A-P)+E*(P-w)+M*(w-A))<1e-8)&&a.push(t,t+1,t+2)}var mi={exports:{}};mi.exports;mi.exports=_i;mi.exports.default=_i;function _i(t,e,r){r=r||2;var s,i,n,o,a,l,h,u=e&&e.length,c=u?e[0]*r:t.length,d=xi(t,0,c,r,!0),p=[];if(!d||d.next===d.prev)return p;if(u&&(d=function(t,e,r,s){var i,n,o,a,l,h=[];for(i=0,n=e.length;i<n;i++)o=e[i]*s,a=i<n-1?e[i+1]*s:t.length,(l=xi(t,o,a,s,!1))===l.next&&(l.steiner=!0),h.push(Ri(l));for(h.sort(Ei),i=0;i<h.length;i++)r=Ai(h[i],r);return r}(t,e,d,r)),t.length>80*r){s=n=t[0],i=o=t[1];for(var f=r;f<c;f+=r)(a=t[f])<s&&(s=a),(l=t[f+1])<i&&(i=l),a>n&&(n=a),l>o&&(o=l);h=0!==(h=Math.max(n-s,o-i))?32767/h:0}return bi(d,p,r,s,i,h,0),p}function xi(t,e,r,s,i){var n,o;if(i===zi(t,e,r,s)>0)for(n=e;n<r;n+=s)o=Ui(n,t[n],t[n+1],o);else for(n=r-s;n>=e;n-=s)o=Ui(n,t[n],t[n+1],o);return o&&Gi(o,o.next)&&(Li(o),o=o.next),o}function yi(t,e){if(!t)return t;e||(e=t);var r,s=t;do{if(r=!1,s.steiner||!Gi(s,s.next)&&0!==Ii(s.prev,s,s.next))s=s.next;else{if(Li(s),(s=e=s.prev)===s.next)break;r=!0}}while(r||s!==e);return e}function bi(t,e,r,s,i,n,o){if(t){!o&&n&&function(t,e,r,s){var i=t;do{0===i.z&&(i.z=Pi(i.x,i.y,e,r,s)),i.prevZ=i.prev,i.nextZ=i.next,i=i.next}while(i!==t);i.prevZ.nextZ=null,i.prevZ=null,function(t){var e,r,s,i,n,o,a,l,h=1;do{for(r=t,t=null,n=null,o=0;r;){for(o++,s=r,a=0,e=0;e<h&&(a++,s=s.nextZ);e++);for(l=h;a>0||l>0&&s;)0!==a&&(0===l||!s||r.z<=s.z)?(i=r,r=r.nextZ,a--):(i=s,s=s.nextZ,l--),n?n.nextZ=i:t=i,i.prevZ=n,n=i;r=s}n.nextZ=null,h*=2}while(o>1)}(i)}(t,s,i,n);for(var a,l,h=t;t.prev!==t.next;)if(a=t.prev,l=t.next,n?Ti(t,s,i,n):vi(t))e.push(a.i/r|0),e.push(t.i/r|0),e.push(l.i/r|0),Li(t),t=l.next,h=l.next;else if((t=l)===h){o?1===o?bi(t=Si(yi(t),e,r),e,r,s,i,n,2):2===o&&wi(t,e,r,s,i,n):bi(yi(t),e,r,s,i,n,1);break}}}function vi(t){var e=t.prev,r=t,s=t.next;if(Ii(e,r,s)>=0)return!1;for(var i=e.x,n=r.x,o=s.x,a=e.y,l=r.y,h=s.y,u=i<n?i<o?i:o:n<o?n:o,c=a<l?a<h?a:h:l<h?l:h,d=i>n?i>o?i:o:n>o?n:o,p=a>l?a>h?a:h:l>h?l:h,f=s.next;f!==e;){if(f.x>=u&&f.x<=d&&f.y>=c&&f.y<=p&&Oi(i,a,n,l,o,h,f.x,f.y)&&Ii(f.prev,f,f.next)>=0)return!1;f=f.next}return!0}function Ti(t,e,r,s){var i=t.prev,n=t,o=t.next;if(Ii(i,n,o)>=0)return!1;for(var a=i.x,l=n.x,h=o.x,u=i.y,c=n.y,d=o.y,p=a<l?a<h?a:h:l<h?l:h,f=u<c?u<d?u:d:c<d?c:d,g=a>l?a>h?a:h:l>h?l:h,m=u>c?u>d?u:d:c>d?c:d,_=Pi(p,f,e,r,s),x=Pi(g,m,e,r,s),y=t.prevZ,b=t.nextZ;y&&y.z>=_&&b&&b.z<=x;){if(y.x>=p&&y.x<=g&&y.y>=f&&y.y<=m&&y!==i&&y!==o&&Oi(a,u,l,c,h,d,y.x,y.y)&&Ii(y.prev,y,y.next)>=0||(y=y.prevZ,b.x>=p&&b.x<=g&&b.y>=f&&b.y<=m&&b!==i&&b!==o&&Oi(a,u,l,c,h,d,b.x,b.y)&&Ii(b.prev,b,b.next)>=0))return!1;b=b.nextZ}for(;y&&y.z>=_;){if(y.x>=p&&y.x<=g&&y.y>=f&&y.y<=m&&y!==i&&y!==o&&Oi(a,u,l,c,h,d,y.x,y.y)&&Ii(y.prev,y,y.next)>=0)return!1;y=y.prevZ}for(;b&&b.z<=x;){if(b.x>=p&&b.x<=g&&b.y>=f&&b.y<=m&&b!==i&&b!==o&&Oi(a,u,l,c,h,d,b.x,b.y)&&Ii(b.prev,b,b.next)>=0)return!1;b=b.nextZ}return!0}function Si(t,e,r){var s=t;do{var i=s.prev,n=s.next.next;!Gi(i,n)&&ki(i,s,s.next,n)&&Fi(i,n)&&Fi(n,i)&&(e.push(i.i/r|0),e.push(s.i/r|0),e.push(n.i/r|0),Li(s),Li(s.next),s=t=n),s=s.next}while(s!==t);return yi(s)}function wi(t,e,r,s,i,n){var o=t;do{for(var a=o.next.next;a!==o.prev;){if(o.i!==a.i&&Ci(o,a)){var l=Ni(o,a);return o=yi(o,o.next),l=yi(l,l.next),bi(o,e,r,s,i,n,0),void bi(l,e,r,s,i,n,0)}a=a.next}o=o.next}while(o!==t)}function Ei(t,e){return t.x-e.x}function Ai(t,e){var r=function(t,e){var r,s=e,i=t.x,n=t.y,o=-1/0;do{if(n<=s.y&&n>=s.next.y&&s.next.y!==s.y){var a=s.x+(n-s.y)*(s.next.x-s.x)/(s.next.y-s.y);if(a<=i&&a>o&&(o=a,r=s.x<s.next.x?s:s.next,a===i))return r}s=s.next}while(s!==e);if(!r)return null;var l,h=r,u=r.x,c=r.y,d=1/0;s=r;do{i>=s.x&&s.x>=u&&i!==s.x&&Oi(n<c?i:o,n,u,c,n<c?o:i,n,s.x,s.y)&&(l=Math.abs(n-s.y)/(i-s.x),Fi(s,t)&&(l<d||l===d&&(s.x>r.x||s.x===r.x&&Mi(r,s)))&&(r=s,d=l)),s=s.next}while(s!==h);return r}(t,e);if(!r)return e;var s=Ni(r,t);return yi(s,s.next),yi(r,r.next)}function Mi(t,e){return Ii(t.prev,t,e.prev)<0&&Ii(e.next,t,t.next)<0}function Pi(t,e,r,s,i){return(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=(t-r)*i|0)|t<<8))|t<<4))|t<<2))|t<<1))|(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=(e-s)*i|0)|e<<8))|e<<4))|e<<2))|e<<1))<<1}function Ri(t){var e=t,r=t;do{(e.x<r.x||e.x===r.x&&e.y<r.y)&&(r=e),e=e.next}while(e!==t);return r}function Oi(t,e,r,s,i,n,o,a){return(i-o)*(e-a)>=(t-o)*(n-a)&&(t-o)*(s-a)>=(r-o)*(e-a)&&(r-o)*(n-a)>=(i-o)*(s-a)}function Ci(t,e){return t.next.i!==e.i&&t.prev.i!==e.i&&!function(t,e){var r=t;do{if(r.i!==t.i&&r.next.i!==t.i&&r.i!==e.i&&r.next.i!==e.i&&ki(r,r.next,t,e))return!0;r=r.next}while(r!==t);return!1}(t,e)&&(Fi(t,e)&&Fi(e,t)&&function(t,e){var r=t,s=!1,i=(t.x+e.x)/2,n=(t.y+e.y)/2;do{r.y>n!=r.next.y>n&&r.next.y!==r.y&&i<(r.next.x-r.x)*(n-r.y)/(r.next.y-r.y)+r.x&&(s=!s),r=r.next}while(r!==t);return s}(t,e)&&(Ii(t.prev,t,e.prev)||Ii(t,e.prev,e))||Gi(t,e)&&Ii(t.prev,t,t.next)>0&&Ii(e.prev,e,e.next)>0)}function Ii(t,e,r){return(e.y-t.y)*(r.x-e.x)-(e.x-t.x)*(r.y-e.y)}function Gi(t,e){return t.x===e.x&&t.y===e.y}function ki(t,e,r,s){var i=Di(Ii(t,e,r)),n=Di(Ii(t,e,s)),o=Di(Ii(r,s,t)),a=Di(Ii(r,s,e));return!!(i!==n&&o!==a||0===i&&Bi(t,r,e)||0===n&&Bi(t,s,e)||0===o&&Bi(r,t,s)||0===a&&Bi(r,e,s))}function Bi(t,e,r){return e.x<=Math.max(t.x,r.x)&&e.x>=Math.min(t.x,r.x)&&e.y<=Math.max(t.y,r.y)&&e.y>=Math.min(t.y,r.y)}function Di(t){return t>0?1:t<0?-1:0}function Fi(t,e){return Ii(t.prev,t,t.next)<0?Ii(t,e,t.next)>=0&&Ii(t,t.prev,e)>=0:Ii(t,e,t.prev)<0||Ii(t,t.next,e)<0}function Ni(t,e){var r=new Xi(t.i,t.x,t.y),s=new Xi(e.i,e.x,e.y),i=t.next,n=e.prev;return t.next=e,e.prev=t,r.next=i,i.prev=r,s.next=r,r.prev=s,n.next=s,s.prev=n,s}function Ui(t,e,r,s){var i=new Xi(t,e,r);return s?(i.next=s.next,i.prev=s,s.next.prev=i,s.next=i):(i.prev=i,i.next=i),i}function Li(t){t.next.prev=t.prev,t.prev.next=t.next,t.prevZ&&(t.prevZ.nextZ=t.nextZ),t.nextZ&&(t.nextZ.prevZ=t.prevZ)}function Xi(t,e,r){this.i=t,this.x=e,this.y=r,this.prev=null,this.next=null,this.z=0,this.prevZ=null,this.nextZ=null,this.steiner=!1}function zi(t,e,r,s){for(var i=0,n=e,o=r-s;n<r;n+=s)i+=(t[o]-t[n])*(t[n+1]+t[o+1]),o=n;return i}_i.deviation=function(t,e,r,s){var i=e&&e.length,n=i?e[0]*r:t.length,o=Math.abs(zi(t,0,n,r));if(i)for(var a=0,l=e.length;a<l;a++){var h=e[a]*r,u=a<l-1?e[a+1]*r:t.length;o-=Math.abs(zi(t,h,u,r))}var c=0;for(a=0;a<s.length;a+=3){var d=s[a]*r,p=s[a+1]*r,f=s[a+2]*r;c+=Math.abs((t[d]-t[f])*(t[p+1]-t[d+1])-(t[d]-t[p])*(t[f+1]-t[d+1]))}return 0===o&&0===c?0:Math.abs((c-o)/o)},_i.flatten=function(t){for(var e=t[0][0].length,r={vertices:[],holes:[],dimensions:e},s=0,i=0;i<t.length;i++){for(var n=0;n<t[i].length;n++)for(var o=0;o<e;o++)r.vertices.push(t[i][n][o]);i>0&&(s+=t[i-1].length,r.holes.push(s))}return r};var Hi=f(mi.exports);function ji(t,e,r,s,i,n,o){const a=Hi(t,e,2);if(!a)return;for(let t=0;t<a.length;t+=3)n[o++]=a[t]+i,n[o++]=a[t+1]+i,n[o++]=a[t+2]+i;let l=i*s;for(let e=0;e<t.length;e+=2)r[l]=t[e],r[l+1]=t[e+1],l+=s}const Vi=[],Wi={build(t,e){for(let r=0;r<t.points.length;r++)e[r]=t.points[r];return e},triangulate(t,e,r,s,i,n){ji(t,Vi,e,r,s,i,n)}},$i={build(t,e){const r=t,s=r.x,i=r.y,n=r.width,o=r.height;return n>=0&&o>=0&&(e[0]=s,e[1]=i,e[2]=s+n,e[3]=i,e[4]=s+n,e[5]=i+o,e[6]=s,e[7]=i+o),e},triangulate(t,e,r,s,i,n){let o=0;e[(s*=r)+o]=t[0],e[s+o+1]=t[1],o+=r,e[s+o]=t[2],e[s+o+1]=t[3],o+=r,e[s+o]=t[6],e[s+o+1]=t[7],o+=r,e[s+o]=t[4],e[s+o+1]=t[5],o+=r;const a=s/r;i[n++]=a,i[n++]=a+1,i[n++]=a+2,i[n++]=a+1,i[n++]=a+3,i[n++]=a+2}},Yi={build:(t,e)=>(e[0]=t.x,e[1]=t.y,e[2]=t.x2,e[3]=t.y2,e[4]=t.x3,e[5]=t.y3,e),triangulate(t,e,r,s,i,n){let o=0;e[(s*=r)+o]=t[0],e[s+o+1]=t[1],o+=r,e[s+o]=t[2],e[s+o+1]=t[3],o+=r,e[s+o]=t[4],e[s+o+1]=t[5];const a=s/r;i[n++]=a,i[n++]=a+1,i[n++]=a+2}},qi={rectangle:$i,polygon:Wi,triangle:Yi,circle:hi,ellipse:hi,roundedRectangle:hi},Ki=new vt;function Zi(t,e){const{geometryData:r,batches:s}=e;s.length=0,r.indices.length=0,r.vertices.length=0,r.uvs.length=0;for(let e=0;e<t.instructions.length;e++){const i=t.instructions[e];if("texture"===i.action)Qi(i.data,s,r);else if("fill"===i.action||"stroke"===i.action){const t="stroke"===i.action,e=i.data.path.shapePath,n=i.data.style,o=i.data.hole;t&&o&&Ji(o.shapePath,n,null,!0,s,r),Ji(e,n,o,t,s,r)}}}function Qi(t,e,r){const{vertices:s,uvs:i,indices:n}=r,o=n.length,a=s.length/2,l=[],h=qi.rectangle,u=Ki,c=t.image;u.x=t.dx,u.y=t.dy,u.width=t.dw,u.height=t.dh;const d=t.transform;h.build(u,l),d&&ii(l,d),h.triangulate(l,s,2,a,n,o);const p=c.uvs;i.push(p.x0,p.y0,p.x1,p.y1,p.x3,p.y3,p.x2,p.y2);const f=gt.get(li);f.indexOffset=o,f.indexSize=n.length-o,f.vertexOffset=a,f.vertexSize=s.length/2-a,f.color=t.style,f.alpha=t.alpha,f.texture=c,f.geometryData=r,e.push(f)}function Ji(t,e,r,s,i,n){const{vertices:o,uvs:a,indices:l}=n,h=t.shapePrimitives.length-1;t.shapePrimitives.forEach((({shape:t,transform:u},c)=>{var d;const p=l.length,f=o.length/2,g=[],m=qi[t.type];if(m.build(t,g),u&&ii(g,u),s){const r=null==(d=t.closePath)||d;gi(g,e,!1,r,o,0,0,l)}else if(r&&h===c){0!==h&&console.warn("[Pixi Graphics] only the last shape have be cut out");const t=[],e=g.slice();(function(t){if(!t)return[];const e=t.shapePrimitives,r=[];for(let t=0;t<e.length;t++){const s=e[t].shape,i=[];qi[s.type].build(s,i),r.push(i)}return r})(r.shapePath).forEach((r=>{t.push(e.length/2),e.push(...r)})),ji(e,t,o,2,f,l,p)}else m.triangulate(g,o,2,f,l,p);const _=a.length/2,x=e.texture;if(x!==zr.WHITE){const t=e.matrix;u&&t.append(u.clone().invert()),ri(o,2,f,a,_,2,o.length/2-f,t)}else si(a,_,2,o.length/2-f);const y=gt.get(li);y.indexOffset=p,y.indexSize=l.length-p,y.vertexOffset=f,y.vertexSize=o.length/2-f,y.color=e.color,y.alpha=e.alpha,y.texture=x,y.geometryData=n,i.push(y)}))}class tn{constructor(){this.batches=[],this.geometryData={vertices:[],uvs:[],indices:[]}}}class en{constructor(){this.geometry=new Bs,this.instructions=new Nt}init(){this.instructions.reset()}}const rn=class t{constructor(){this._activeBatchers=[],this._gpuContextHash={},this._graphicsDataContextHash=Object.create(null),this._needsContextNeedsRebuild=[]}init(e){var r;t.defaultOptions.bezierSmoothness=null!=(r=null==e?void 0:e.bezierSmoothness)?r:t.defaultOptions.bezierSmoothness}prerender(){this._returnActiveBatchers()}getContextRenderData(t){return this._graphicsDataContextHash[t.uid]||this._initContextRenderData(t)}updateGpuContext(t){let e=this._gpuContextHash[t.uid]||this._initContext(t);if(t.dirty){e?this._cleanGraphicsContextData(t):e=this._initContext(t),Zi(t,e);const r=t.batchMode;t.customShader||"no-batch"===r?e.isBatchable=!1:"auto"===r&&(e.isBatchable=e.geometryData.vertices.length<400),t.dirty=!1}return e}getGpuContext(t){return this._gpuContextHash[t.uid]||this._initContext(t)}_returnActiveBatchers(){for(let t=0;t<this._activeBatchers.length;t++)gt.return(this._activeBatchers[t]);this._activeBatchers.length=0}_initContextRenderData(t){const e=gt.get(en),{batches:r,geometryData:s}=this._gpuContextHash[t.uid],i=s.vertices.length,n=s.indices.length;for(let t=0;t<r.length;t++)r[t].applyTransform=!1;const o=gt.get(ei);this._activeBatchers.push(o),o.ensureAttributeBuffer(i),o.ensureIndexBuffer(n),o.begin();for(let t=0;t<r.length;t++){const e=r[t];o.add(e)}o.finish(e.instructions);const a=e.geometry;a.indexBuffer.setDataWithSize(o.indexBuffer,o.indexSize,!0),a.buffers[0].setDataWithSize(o.attributeBuffer.float32View,o.attributeSize,!0);const l=o.batches;for(let t=0;t<l.length;t++){const e=l[t];e.bindGroup=Us(e.textures.textures,e.textures.count)}return this._graphicsDataContextHash[t.uid]=e,e}_initContext(t){const e=new tn;return this._gpuContextHash[t.uid]=e,t.on("update",this.onGraphicsContextUpdate,this),t.on("destroy",this.onGraphicsContextDestroy,this),this._gpuContextHash[t.uid]}onGraphicsContextUpdate(t){this._needsContextNeedsRebuild.push(t)}onGraphicsContextDestroy(t){this._cleanGraphicsContextData(t),t.off("update",this.onGraphicsContextUpdate,this),t.off("destroy",this.onGraphicsContextDestroy,this),this._gpuContextHash[t.uid]=null}_cleanGraphicsContextData(t){const e=this._gpuContextHash[t.uid];e.isBatchable||this._graphicsDataContextHash[t.uid]&&(gt.return(this.getContextRenderData(t)),this._graphicsDataContextHash[t.uid]=null),e.batches&&e.batches.forEach((t=>{gt.return(t)}))}destroy(){for(const t of this._needsContextNeedsRebuild)this._gpuContextHash[t.uid]&&this.onGraphicsContextDestroy(t);this._needsContextNeedsRebuild.length=0}};rn.extension={type:[u.WebGLSystem,u.WebGPUSystem,u.CanvasSystem],name:"graphicsContext"},rn.defaultOptions={bezierSmoothness:.5};let sn=rn;const nn={normal:0,add:1,multiply:2,screen:3,overlay:4,erase:5,"normal-npm":6,"add-npm":7,"screen-npm":8},on=class t{constructor(){this.data=0,this.blendMode="normal",this.polygonOffset=0,this.blend=!0,this.depthMask=!0}get blend(){return!!(1&this.data)}set blend(t){!!(1&this.data)!==t&&(this.data^=1)}get offsets(){return!!(2&this.data)}set offsets(t){!!(2&this.data)!==t&&(this.data^=2)}set cullMode(t){"none"!==t?(this.culling=!0,this.clockwiseFrontFace="front"===t):this.culling=!1}get cullMode(){return this.culling?this.clockwiseFrontFace?"front":"back":"none"}get culling(){return!!(4&this.data)}set culling(t){!!(4&this.data)!==t&&(this.data^=4)}get depthTest(){return!!(8&this.data)}set depthTest(t){!!(8&this.data)!==t&&(this.data^=8)}get depthMask(){return!!(32&this.data)}set depthMask(t){!!(32&this.data)!==t&&(this.data^=32)}get clockwiseFrontFace(){return!!(16&this.data)}set clockwiseFrontFace(t){!!(16&this.data)!==t&&(this.data^=16)}get blendMode(){return this._blendMode}set blendMode(t){this.blend="none"!==t,this._blendMode=t,this._blendModeId=nn[t]||0}get polygonOffset(){return this._polygonOffset}set polygonOffset(t){this.offsets=!!t,this._polygonOffset=t}static for2d(){const e=new t;return e.depthTest=!1,e.blend=!0,e}};on.default2d=on.for2d();let an=on;function ln(t,e,r){const s=(t>>24&255)/255;e[r++]=(255&t)/255*s,e[r++]=(t>>8&255)/255*s,e[r++]=(t>>16&255)/255*s,e[r++]=s}class hn{constructor(t,e){this.state=an.for2d(),this._graphicsBatchesHash=Object.create(null),this.renderer=t,this._adaptor=e,this._adaptor.init()}validateRenderable(t){const e=t.context,r=!!this._graphicsBatchesHash[t.uid],s=this.renderer.graphicsContext.updateGpuContext(e);return!(!s.isBatchable&&r===s.isBatchable)}addRenderable(t,e){const r=this.renderer.graphicsContext.updateGpuContext(t.context);t._didGraphicsUpdate&&(t._didGraphicsUpdate=!1,this._rebuild(t)),r.isBatchable?this._addToBatcher(t,e):(this.renderer.renderPipes.batch.break(e),e.add(t))}updateRenderable(t){const e=this._graphicsBatchesHash[t.uid];if(e)for(let t=0;t<e.length;t++){const r=e[t];r.batcher.updateElement(r)}}destroyRenderable(t){this._graphicsBatchesHash[t.uid]&&this._removeBatchForRenderable(t.uid)}execute(t){if(!t.isRenderable)return;const e=this.renderer,r=t.context;if(!e.graphicsContext.getGpuContext(r).batches.length)return;const s=r.customShader||this._adaptor.shader;this.state.blendMode=t.groupBlendMode;const i=s.resources.localUniforms.uniforms;i.uTransformMatrix=t.groupTransform,i.uRound=e._roundPixels|t._roundPixels,ln(t.groupColorAlpha,i.uColor,0),this._adaptor.execute(this,t)}_rebuild(t){const e=!!this._graphicsBatchesHash[t.uid],r=this.renderer.graphicsContext.updateGpuContext(t.context);e&&this._removeBatchForRenderable(t.uid),r.isBatchable&&this._initBatchesForRenderable(t),t.batched=r.isBatchable}_addToBatcher(t,e){const r=this.renderer.renderPipes.batch,s=this._getBatchesForRenderable(t);for(let t=0;t<s.length;t++){const i=s[t];r.addToBatch(i,e)}}_getBatchesForRenderable(t){return this._graphicsBatchesHash[t.uid]||this._initBatchesForRenderable(t)}_initBatchesForRenderable(t){const e=t.context,r=this.renderer.graphicsContext.getGpuContext(e),s=this.renderer._roundPixels|t._roundPixels,i=r.batches.map((e=>{const r=gt.get(li);return e.copyTo(r),r.renderable=t,r.roundPixels=s,r}));return this._graphicsBatchesHash[t.uid]=i,t.on("destroyed",(()=>{this.destroyRenderable(t)})),i}_removeBatchForRenderable(t){this._graphicsBatchesHash[t].forEach((t=>{gt.return(t)})),this._graphicsBatchesHash[t]=null}destroy(){this.renderer=null,this._adaptor.destroy(),this._adaptor=null,this.state=null;for(const t in this._graphicsBatchesHash)this._removeBatchForRenderable(t);this._graphicsBatchesHash=null}}hn.extension={type:[u.WebGLPipes,u.WebGPUPipes,u.CanvasPipes],name:"graphics"},p.add(hn),p.add(sn);const un=Object.create(null),cn=Object.create(null);function dn(t,e){let r=cn[t];return void 0===r&&(void 0===un[e]&&(un[e]=1),cn[t]=r=un[e]++),r}function pn(t,e){switch(t){case"f32":return 0;case"vec2<f32>":return new Float32Array(2*e);case"vec3<f32>":return new Float32Array(3*e);case"vec4<f32>":return new Float32Array(4*e);case"mat2x2<f32>":return new Float32Array([1,0,0,1]);case"mat3x3<f32>":return new Float32Array([1,0,0,0,1,0,0,0,1]);case"mat4x4<f32>":return new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])}return null}var fn=Object.defineProperty,gn=Object.getOwnPropertySymbols,mn=Object.prototype.hasOwnProperty,_n=Object.prototype.propertyIsEnumerable,xn=(t,e,r)=>e in t?fn(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r,yn=(t,e)=>{for(var r in e||(e={}))mn.call(e,r)&&xn(t,r,e[r]);if(gn)for(var r of gn(e))_n.call(e,r)&&xn(t,r,e[r]);return t};const bn=class t{constructor(e,r){var s;this._touched=0,this.uid=ht("uniform"),this._resourceType="uniformGroup",this._resourceId=ht("resource"),this.isUniformGroup=!0,this._dirtyId=0,this.destroyed=!1,r=yn(yn({},t.defaultOptions),r),this.uniformStructures=e;const i={};for(const t in e){const r=e[t];r.name=t,r.size=null!=(s=r.size)?s:1,null!=r.value||(r.value=pn(r.type,r.size)),i[t]=r.value}this.uniforms=i,this._dirtyId=1,this.ubo=r.ubo,this.isStatic=r.isStatic,this._signature=dn(Object.keys(i).map((t=>`${t}-${e[t].type}`)).join("-"),"uniform-group")}update(){this._dirtyId++}};bn.defaultOptions={ubo:!1,isStatic:!1};let vn=bn;class Tn{constructor(){this.batcher=null,this.batch=null,this.roundPixels=0,this._uvUpdateId=-1,this._textureMatrixUpdateId=-1}get blendMode(){return this.mesh.groupBlendMode}reset(){this.mesh=null,this.texture=null,this.batcher=null,this.batch=null}packIndex(t,e,r){const s=this.geometry.indices;for(let i=0;i<s.length;i++)t[e++]=s[i]+r}packAttributes(t,e,r,s){const i=this.mesh,n=this.geometry,o=i.groupTransform,a=s<<16|65535&this.roundPixels,l=o.a,h=o.b,u=o.c,c=o.d,d=o.tx,p=o.ty,f=n.positions,g=n.getBuffer("aUV"),m=g.data;let _=m;const x=this.texture.textureMatrix;x.isSimple||(_=this._transformedUvs,(this._textureMatrixUpdateId!==x._updateID||this._uvUpdateId!==g._updateID)&&((!_||_.length<m.length)&&(_=this._transformedUvs=new Float32Array(m.length)),this._textureMatrixUpdateId=x._updateID,this._uvUpdateId=g._updateID,x.multiplyUvs(m,_)));const y=i.groupColorAlpha;for(let s=0;s<f.length;s+=2){const i=f[s],n=f[s+1];t[r]=l*i+u*n+d,t[r+1]=h*i+c*n+p,t[r+2]=_[s],t[r+3]=_[s+1],e[r+4]=y,e[r+5]=a,r+=6}}get vertexSize(){return this.geometry.positions.length/2}get indexSize(){return this.geometry.indices.length}}class Sn{constructor(t,e){this.localUniforms=new vn({uTransformMatrix:{value:new it,type:"mat3x3<f32>"},uColor:{value:new Float32Array([1,1,1,1]),type:"vec4<f32>"},uRound:{value:0,type:"f32"}}),this.localUniformsBindGroup=new Ds({0:this.localUniforms}),this._meshDataHash=Object.create(null),this._gpuBatchableMeshHash=Object.create(null),this.renderer=t,this._adaptor=e,this._adaptor.init()}validateRenderable(t){const e=this._getMeshData(t),r=e.batched,s=t.batched;if(e.batched=s,r!==s)return!0;if(s){const r=t._geometry;if(r.indices.length!==e.indexSize||r.positions.length!==e.vertexSize)return e.indexSize=r.indices.length,e.vertexSize=r.positions.length,!0;const s=this._getBatchableMesh(t),i=t.texture;if(s.texture._source!==i._source&&s.texture._source!==i._source)return!s.batcher.checkAndUpdateTexture(s,i)}return!1}addRenderable(t,e){const r=this.renderer.renderPipes.batch,{batched:s}=this._getMeshData(t);if(s){const e=this._getBatchableMesh(t);e.texture=t._texture,e.geometry=t._geometry,r.addToBatch(e)}else r.break(e),e.add({renderPipeId:"mesh",mesh:t})}updateRenderable(t){if(t.batched){const e=this._gpuBatchableMeshHash[t.uid];e.texture=t._texture,e.geometry=t._geometry,e.batcher.updateElement(e)}}destroyRenderable(t){this._meshDataHash[t.uid]=null;const e=this._gpuBatchableMeshHash[t.uid];e&&(gt.return(e),this._gpuBatchableMeshHash[t.uid]=null)}execute({mesh:t}){if(!t.isRenderable)return;t.state.blendMode=t.groupBlendMode;const e=this.localUniforms;e.uniforms.uTransformMatrix=t.groupTransform,e.uniforms.uRound=this.renderer._roundPixels|t._roundPixels,e.update(),ln(t.groupColorAlpha,e.uniforms.uColor,0),this._adaptor.execute(this,t)}_getMeshData(t){return this._meshDataHash[t.uid]||this._initMeshData(t)}_initMeshData(t){var e,r;return this._meshDataHash[t.uid]={batched:t.batched,indexSize:null==(e=t._geometry.indices)?void 0:e.length,vertexSize:null==(r=t._geometry.positions)?void 0:r.length},t.on("destroyed",(()=>{this.destroyRenderable(t)})),this._meshDataHash[t.uid]}_getBatchableMesh(t){return this._gpuBatchableMeshHash[t.uid]||this._initBatchableMesh(t)}_initBatchableMesh(t){const e=gt.get(Tn);return e.mesh=t,e.texture=t._texture,e.roundPixels=this.renderer._roundPixels|t._roundPixels,this._gpuBatchableMeshHash[t.uid]=e,e.mesh=t,e}destroy(){for(const t in this._gpuBatchableMeshHash)this._gpuBatchableMeshHash[t]&&gt.return(this._gpuBatchableMeshHash[t]);this._gpuBatchableMeshHash=null,this._meshDataHash=null,this.localUniforms=null,this.localUniformsBindGroup=null,this._adaptor.destroy(),this._adaptor=null,this.renderer=null}}Sn.extension={type:[u.WebGLPipes,u.WebGPUPipes,u.CanvasPipes],name:"mesh"},p.add(Sn);class wn{constructor(){this.vertexSize=4,this.indexSize=6,this.location=0,this.batcher=null,this.batch=null,this.roundPixels=0}get blendMode(){return this.renderable.groupBlendMode}packAttributes(t,e,r,s){const i=this.renderable,n=this.texture,o=i.groupTransform,a=o.a,l=o.b,h=o.c,u=o.d,c=o.tx,d=o.ty,p=this.bounds,f=p.maxX,g=p.minX,m=p.maxY,_=p.minY,x=n.uvs,y=i.groupColorAlpha,b=s<<16|65535&this.roundPixels;t[r+0]=a*g+h*_+c,t[r+1]=u*_+l*g+d,t[r+2]=x.x0,t[r+3]=x.y0,e[r+4]=y,e[r+5]=b,t[r+6]=a*f+h*_+c,t[r+7]=u*_+l*f+d,t[r+8]=x.x1,t[r+9]=x.y1,e[r+10]=y,e[r+11]=b,t[r+12]=a*f+h*m+c,t[r+13]=u*m+l*f+d,t[r+14]=x.x2,t[r+15]=x.y2,e[r+16]=y,e[r+17]=b,t[r+18]=a*g+h*m+c,t[r+19]=u*m+l*g+d,t[r+20]=x.x3,t[r+21]=x.y3,e[r+22]=y,e[r+23]=b}packIndex(t,e,r){t[e]=r+0,t[e+1]=r+1,t[e+2]=r+2,t[e+3]=r+0,t[e+4]=r+2,t[e+5]=r+3}reset(){this.renderable=null,this.texture=null,this.batcher=null,this.batch=null,this.bounds=null}}class En{constructor(t){this._gpuText=Object.create(null),this._renderer=t}validateRenderable(t){var e;const r=this._getGpuText(t),s=t._getKey();if(r.currentKey!==s){const s=null!=(e=t.resolution)?e:this._renderer.resolution,{width:i,height:n}=this._renderer.canvasText.getTextureSize(t.text,s,t._style);return!(1===this._renderer.canvasText.getReferenceCount(r.currentKey)&&i===r.texture._source.width&&n===r.texture._source.height)}return!1}addRenderable(t,e){const r=this._getGpuText(t).batchableSprite;t._didTextUpdate&&this._updateText(t),this._renderer.renderPipes.batch.addToBatch(r)}updateRenderable(t){const e=this._getGpuText(t).batchableSprite;t._didTextUpdate&&this._updateText(t),e.batcher.updateElement(e)}destroyRenderable(t){this._destroyRenderableById(t.uid)}_destroyRenderableById(t){const e=this._gpuText[t];this._renderer.canvasText.decreaseReferenceCount(e.currentKey),gt.return(e.batchableSprite),this._gpuText[t]=null}_updateText(t){const e=t._getKey(),r=this._getGpuText(t),s=r.batchableSprite;r.currentKey!==e&&this._updateGpuText(t),t._didTextUpdate=!1;const i=t._style.padding;Yr(s.bounds,t._anchor,s.texture,i)}_updateGpuText(t){var e;const r=this._getGpuText(t),s=r.batchableSprite;r.texture&&this._renderer.canvasText.decreaseReferenceCount(r.currentKey);const i=null!=(e=t.resolution)?e:this._renderer.resolution;r.texture=s.texture=this._renderer.canvasText.getTexture(t.text,i,t._style,t._getKey()),r.currentKey=t._getKey(),s.texture=r.texture}_getGpuText(t){return this._gpuText[t.uid]||this.initGpuText(t)}initGpuText(t){const e={texture:null,currentKey:"--",batchableSprite:gt.get(wn)};return e.batchableSprite.renderable=t,e.batchableSprite.bounds={minX:0,maxX:1,minY:0,maxY:0},e.batchableSprite.roundPixels=this._renderer._roundPixels|t._roundPixels,this._gpuText[t.uid]=e,this._updateText(t),t.on("destroyed",(()=>{this.destroyRenderable(t)})),e}destroy(){for(const t in this._gpuText)this._destroyRenderableById(t);this._gpuText=null,this._renderer=null}}En.extension={type:[u.WebGLPipes,u.WebGPUPipes,u.CanvasPipes],name:"text"};class An{constructor(t){this._canvasPool=Object.create(null),this.canvasOptions=t||{},this.enableFullScreen=!1}_createCanvasAndContext(t,e){const r=Ne.get().createCanvas();r.width=t,r.height=e;const s=r.getContext("2d");return{canvas:r,context:s}}getOptimalCanvasAndContext(t,e,r=1){t=Math.ceil(t*r-1e-6),e=Math.ceil(e*r-1e-6);const s=((t=dr(t))<<17)+((e=dr(e))<<1);this._canvasPool[s]||(this._canvasPool[s]=[]);let i=this._canvasPool[s].pop();return i||(i=this._createCanvasAndContext(t,e)),i}returnCanvasAndContext(t){const{width:e,height:r}=t.canvas,s=(e<<17)+(r<<1);this._canvasPool[s].push(t)}clear(){this._canvasPool={}}}const Mn=new An;var Pn=Object.defineProperty,Rn=Object.defineProperties,On=Object.getOwnPropertyDescriptors,Cn=Object.getOwnPropertySymbols,In=Object.prototype.hasOwnProperty,Gn=Object.prototype.propertyIsEnumerable,kn=(t,e,r)=>e in t?Pn(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r;let Bn=0;class Dn{constructor(t){this._poolKeyHash=Object.create(null),this._texturePool={},this.textureOptions=t||{},this.enableFullScreen=!1}createTexture(t,e,r){const s=new Cr(((t,e)=>Rn(t,On(e)))(((t,e)=>{for(var r in e||(e={}))In.call(e,r)&&kn(t,r,e[r]);if(Cn)for(var r of Cn(e))Gn.call(e,r)&&kn(t,r,e[r]);return t})({},this.textureOptions),{width:t,height:e,resolution:1,antialias:r,autoGarbageCollect:!0}));return new zr({source:s,label:"texturePool_"+Bn++})}getOptimalTexture(t,e,r=1,s){let i=Math.ceil(t*r-1e-6),n=Math.ceil(e*r-1e-6);i=dr(i),n=dr(n);const o=(i<<17)+(n<<1)+(s?1:0);this._texturePool[o]||(this._texturePool[o]=[]);let a=this._texturePool[o].pop();return a||(a=this.createTexture(i,n,s)),a.source._resolution=r,a.source.width=i/r,a.source.height=n/r,a.source.pixelWidth=i,a.source.pixelHeight=n,a.frame.x=0,a.frame.y=0,a.frame.width=t,a.frame.height=e,a.updateUvs(),this._poolKeyHash[a.uid]=o,a}getSameSizeTexture(t,e=!1){const r=t.source;return this.getOptimalTexture(t.width,t.height,r._resolution,e)}returnTexture(t){const e=this._poolKeyHash[t.uid];this._texturePool[e].push(t)}clear(t){if(t=!1!==t)for(const t in this._texturePool){const e=this._texturePool[t];if(e)for(let t=0;t<e.length;t++)e[t].destroy(!0)}this._texturePool={}}}const Fn=new Dn;function Nn(t,e,r){for(let s=0,i=4*r*e;s<e;++s,i+=4)if(0!==t[i+3])return!1;return!0}function Un(t,e,r,s,i){const n=4*e;for(let e=s,o=s*n+4*r;e<=i;++e,o+=n)if(0!==t[o+3])return!1;return!0}function Ln(t,e=1){const{width:r,height:s}=t,i=t.getContext("2d",{willReadFrequently:!0});if(null===i)throw new TypeError("Failed to get canvas 2D context");const n=i.getImageData(0,0,r,s).data;let o=0,a=0,l=r-1,h=s-1;for(;a<s&&Nn(n,r,a);)++a;if(a===s)return vt.EMPTY;for(;Nn(n,r,h);)--h;for(;Un(n,r,o,a,h);)++o;for(;Un(n,r,l,a,h);)--l;return++l,++h,new vt(o/e,a/e,(l-o)/e,(h-a)/e)}const Xn=new St;function zn(t,e,r,s){const i=Xn;i.minX=0,i.minY=0,i.maxX=t.width/s|0,i.maxY=t.height/s|0;const n=Fn.getOptimalTexture(i.width,i.height,s,!1);return n.source.uploadMethodId="image",n.source.resource=t,n.source.alphaMode="premultiply-alpha-on-upload",n.frame.width=e/s,n.frame.height=r/s,n.source.emit("update",n.source),n.updateUvs(),n}const Hn=["serif","sans-serif","monospace","cursive","fantasy","system-ui"];function jn(t){const e="number"==typeof t.fontSize?`${t.fontSize}px`:t.fontSize;let r=t.fontFamily;Array.isArray(t.fontFamily)||(r=t.fontFamily.split(","));for(let t=r.length-1;t>=0;t--){let e=r[t].trim();!/([\"\'])[^\'\"]+\1/.test(e)&&!Hn.includes(e)&&(e=`"${e}"`),r[t]=e}return`${t.fontStyle} ${t.fontVariant} ${t.fontWeight} ${e} ${r.join(",")}`}const Vn={willReadFrequently:!0},Wn=class t{static get experimentalLetterSpacingSupported(){let e=t._experimentalLetterSpacingSupported;if(void 0!==e){const r=Ne.get().getCanvasRenderingContext2D().prototype;e=t._experimentalLetterSpacingSupported="letterSpacing"in r||"textLetterSpacing"in r}return e}constructor(t,e,r,s,i,n,o,a,l){this.text=t,this.style=e,this.width=r,this.height=s,this.lines=i,this.lineWidths=n,this.lineHeight=o,this.maxLineWidth=a,this.fontProperties=l}static measureText(e=" ",r,s=t._canvas,i=r.wordWrap){var n;const o=`${e}:${r.styleKey}`;if(t._measurementCache[o])return t._measurementCache[o];const a=jn(r),l=t.measureFont(a);0===l.fontSize&&(l.fontSize=r.fontSize,l.ascent=r.fontSize);const h=t.__context;h.font=a;const u=(i?t._wordWrap(e,r,s):e).split(/(?:\r\n|\r|\n)/),c=new Array(u.length);let d=0;for(let e=0;e<u.length;e++){const s=t._measureText(u[e],r.letterSpacing,h);c[e]=s,d=Math.max(d,s)}const p=(null==(n=r._stroke)?void 0:n.width)||0;let f=d+p;r.dropShadow&&(f+=r.dropShadow.distance);const g=r.lineHeight||l.fontSize+p;let m=Math.max(g,l.fontSize+2*p)+(u.length-1)*(g+r.leading);return r.dropShadow&&(m+=r.dropShadow.distance),new t(e,r,f,m,u,c,g+r.leading,d,l)}static _measureText(e,r,s){let i=!1;t.experimentalLetterSpacingSupported&&(t.experimentalLetterSpacing?(s.letterSpacing=`${r}px`,s.textLetterSpacing=`${r}px`,i=!0):(s.letterSpacing="0px",s.textLetterSpacing="0px"));let n=s.measureText(e).width;return n>0&&(i?n-=r:n+=(t.graphemeSegmenter(e).length-1)*r),n}static _wordWrap(e,r,s=t._canvas){const i=s.getContext("2d",Vn);let n=0,o="",a="";const l=Object.create(null),{letterSpacing:h,whiteSpace:u}=r,c=t._collapseSpaces(u),d=t._collapseNewlines(u);let p=!c;const f=r.wordWrapWidth+h,g=t._tokenize(e);for(let e=0;e<g.length;e++){let s=g[e];if(t._isNewline(s)){if(!d){a+=t._addLine(o),p=!c,o="",n=0;continue}s=" "}if(c){const e=t.isBreakingSpace(s),r=t.isBreakingSpace(o[o.length-1]);if(e&&r)continue}const u=t._getFromCache(s,h,l,i);if(u>f)if(""!==o&&(a+=t._addLine(o),o="",n=0),t.canBreakWords(s,r.breakWords)){const e=t.wordWrapSplit(s);for(let u=0;u<e.length;u++){let c=e[u],d=c,g=1;for(;e[u+g];){const i=e[u+g];if(t.canBreakChars(d,i,s,u,r.breakWords))break;c+=i,d=i,g++}u+=g-1;const m=t._getFromCache(c,h,l,i);m+n>f&&(a+=t._addLine(o),p=!1,o="",n=0),o+=c,n+=m}}else{o.length>0&&(a+=t._addLine(o),o="",n=0);const r=e===g.length-1;a+=t._addLine(s,!r),p=!1,o="",n=0}else u+n>f&&(p=!1,a+=t._addLine(o),o="",n=0),(o.length>0||!t.isBreakingSpace(s)||p)&&(o+=s,n+=u)}return a+=t._addLine(o,!1),a}static _addLine(e,r=!0){return e=t._trimRight(e),e=r?`${e}\n`:e}static _getFromCache(e,r,s,i){let n=s[e];return"number"!=typeof n&&(n=t._measureText(e,r,i)+r,s[e]=n),n}static _collapseSpaces(t){return"normal"===t||"pre-line"===t}static _collapseNewlines(t){return"normal"===t}static _trimRight(e){if("string"!=typeof e)return"";for(let r=e.length-1;r>=0;r--){const s=e[r];if(!t.isBreakingSpace(s))break;e=e.slice(0,-1)}return e}static _isNewline(e){return"string"==typeof e&&t._newlines.includes(e.charCodeAt(0))}static isBreakingSpace(e,r){return"string"==typeof e&&t._breakingSpaces.includes(e.charCodeAt(0))}static _tokenize(e){const r=[];let s="";if("string"!=typeof e)return r;for(let i=0;i<e.length;i++){const n=e[i],o=e[i+1];t.isBreakingSpace(n,o)||t._isNewline(n)?(""!==s&&(r.push(s),s=""),r.push(n)):s+=n}return""!==s&&r.push(s),r}static canBreakWords(t,e){return e}static canBreakChars(t,e,r,s,i){return!0}static wordWrapSplit(e){return t.graphemeSegmenter(e)}static measureFont(e){if(t._fonts[e])return t._fonts[e];const r=t._context;r.font=e;const s=r.measureText(t.METRICS_STRING+t.BASELINE_SYMBOL),i={ascent:s.actualBoundingBoxAscent,descent:s.actualBoundingBoxDescent,fontSize:s.actualBoundingBoxAscent+s.actualBoundingBoxDescent};return t._fonts[e]=i,i}static clearMetrics(e=""){e?delete t._fonts[e]:t._fonts={}}static get _canvas(){if(!t.__canvas){let e;try{const r=new OffscreenCanvas(0,0),s=r.getContext("2d",Vn);if(null!=s&&s.measureText)return t.__canvas=r,r;e=Ne.get().createCanvas()}catch(t){e=Ne.get().createCanvas()}e.width=e.height=10,t.__canvas=e}return t.__canvas}static get _context(){return t.__context||(t.__context=t._canvas.getContext("2d",Vn)),t.__context}};Wn.METRICS_STRING="|q",Wn.BASELINE_SYMBOL="M",Wn.BASELINE_MULTIPLIER=1.4,Wn.HEIGHT_MULTIPLIER=2,Wn.graphemeSegmenter=(()=>{if("function"==typeof(null==Intl?void 0:Intl.Segmenter)){const t=new Intl.Segmenter;return e=>[...t.segment(e)].map((t=>t.segment))}return t=>[...t]})(),Wn.experimentalLetterSpacing=!1,Wn._fonts={},Wn._newlines=[10,13],Wn._breakingSpaces=[9,32,8192,8193,8194,8195,8196,8197,8198,8200,8201,8202,8287,12288],Wn._measurementCache={};let $n=Wn;const Yn=class t{constructor(t,e,r,s){this.uid=ht("fillGradient"),this.type="linear",this.gradientStops=[],this.x0=t,this.y0=e,this.x1=r,this.y1=s}addColorStop(t,e){return this.gradientStops.push({offset:t,color:Z.shared.setValue(e).toHex()}),this}buildLinearGradient(){const e=t.defaultTextureSize,{gradientStops:r}=this,s=Ne.get().createCanvas();s.width=e,s.height=e;const i=s.getContext("2d"),n=i.createLinearGradient(0,0,t.defaultTextureSize,1);for(let t=0;t<r.length;t++){const e=r[t];n.addColorStop(e.offset,e.color)}i.fillStyle=n,i.fillRect(0,0,e,e),this.texture=new zr({source:new hs({resource:s,addressModeU:"clamp-to-edge",addressModeV:"repeat"})});const{x0:o,y0:a,x1:l,y1:h}=this,u=new it,c=l-o,d=h-a,p=Math.sqrt(c*c+d*d),f=Math.atan2(d,c);u.translate(-o,-a),u.scale(1/e,1/e),u.rotate(-f),u.scale(256/p,1),this.transform=u}};Yn.defaultTextureSize=256;let qn=Yn;const Kn={repeat:{addressModeU:"repeat",addressModeV:"repeat"},"repeat-x":{addressModeU:"repeat",addressModeV:"clamp-to-edge"},"repeat-y":{addressModeU:"clamp-to-edge",addressModeV:"repeat"},"no-repeat":{addressModeU:"clamp-to-edge",addressModeV:"clamp-to-edge"}};class Zn{constructor(t,e){this.uid=ht("fillPattern"),this.transform=new it,this.texture=t,this.transform.scale(1/t.frame.width,1/t.frame.height),e&&(t.source.style.addressModeU=Kn[e].addressModeU,t.source.style.addressModeV=Kn[e].addressModeV)}setTransform(t){const e=this.texture;this.transform.copyFrom(t),this.transform.invert(),this.transform.scale(1/e.frame.width,1/e.frame.height)}}function Qn(t,e){if(t.texture===zr.WHITE&&!t.fill)return Z.shared.setValue(t.color).toHex();if(!t.fill){const r=e.createPattern(t.texture.source.resource,"repeat"),s=t.matrix.copyTo(it.shared);return s.scale(t.texture.frame.width,t.texture.frame.height),r.setTransform(s),r}if(t.fill instanceof Zn){const r=t.fill,s=e.createPattern(r.texture.source.resource,"repeat"),i=r.transform.copyTo(it.shared);return i.scale(r.texture.frame.width,r.texture.frame.height),s.setTransform(i),s}if(t.fill instanceof qn){const r=t.fill;if("linear"===r.type){const t=e.createLinearGradient(r.x0,r.y0,r.x1,r.y1);return r.gradientStops.forEach((e=>{t.addColorStop(e.offset,Z.shared.setValue(e.color).toHex())})),t}}return"red"}class Jn{constructor(){this._activeTextures={}}getTextureSize(t,e,r){const s=$n.measureText(t||" ",r);let i=Math.ceil(Math.ceil(Math.max(1,s.width)+2*r.padding)*e),n=Math.ceil(Math.ceil(Math.max(1,s.height)+2*r.padding)*e);return i=Math.ceil(i-1e-6),n=Math.ceil(n-1e-6),i=dr(i),n=dr(n),{width:i,height:n}}getTexture(t,e,r,s){if(this._activeTextures[s])return this._increaseReferenceCount(s),this._activeTextures[s].texture;const i=$n.measureText(t||" ",r),n=Math.ceil(Math.ceil(Math.max(1,i.width)+2*r.padding)*e),o=Math.ceil(Math.ceil(Math.max(1,i.height)+2*r.padding)*e),a=Mn.getOptimalCanvasAndContext(n,o),{canvas:l}=a;this.renderTextToCanvas(t,r,e,a);const h=zn(l,n,o,e);if(r.trim){const t=Ln(l,e);h.frame.copyFrom(t),h.updateUvs()}return this._activeTextures[s]={canvasAndContext:a,texture:h,usageCount:1},h}_increaseReferenceCount(t){this._activeTextures[t].usageCount++}decreaseReferenceCount(t){const e=this._activeTextures[t];if(e.usageCount--,0===e.usageCount){Mn.returnCanvasAndContext(e.canvasAndContext),Fn.returnTexture(e.texture);const r=e.texture.source;r.resource=null,r.uploadMethodId="unknown",r.alphaMode="no-premultiply-alpha",this._activeTextures[t]=null}}getReferenceCount(t){return this._activeTextures[t].usageCount}renderTextToCanvas(t,e,r,s){var i,n,o,a,l,h;const{canvas:u,context:c}=s,d=jn(e),p=$n.measureText(t||" ",e),f=p.lines,g=p.lineHeight,m=p.lineWidths,_=p.maxLineWidth,x=p.fontProperties,y=u.height;if(c.resetTransform(),c.scale(r,r),c.clearRect(0,0,p.width+4,p.height+4),null!=(i=e._stroke)&&i.width){const t=e._stroke;c.lineWidth=t.width,c.miterLimit=t.miterLimit,c.lineJoin=t.join,c.lineCap=t.cap}let b,v;c.font=d;const T=e.dropShadow?2:1;for(let t=0;t<T;++t){const i=e.dropShadow&&0===t,u=i?Math.ceil(Math.max(1,y)+2*e.padding):0,d=u*r;if(i){c.fillStyle="black",c.strokeStyle="black";const t=e.dropShadow,s=t.color,i=t.alpha;c.shadowColor=Z.shared.setValue(s).setAlpha(i).toRgbaString();const n=t.blur*r,o=t.distance*r;c.shadowBlur=n,c.shadowOffsetX=Math.cos(t.angle)*o,c.shadowOffsetY=Math.sin(t.angle)*o+d}else c.globalAlpha=null!=(o=null==(n=e._fill)?void 0:n.alpha)?o:1,c.fillStyle=e._fill?Qn(e._fill,c):null,null!=(a=e._stroke)&&a.width&&(c.strokeStyle=Qn(e._stroke,c)),c.shadowColor="black";let p=(g-x.fontSize)/2;g-x.fontSize<0&&(p=0);const T=null!=(h=null==(l=e._stroke)?void 0:l.width)?h:0;for(let t=0;t<f.length;t++)b=T/2,v=T/2+t*g+x.ascent+p,"right"===e.align?b+=_-m[t]:"center"===e.align&&(b+=(_-m[t])/2),e._stroke&&this._drawLetterSpacing(f[t],e,s,b+e.padding,v+e.padding-u,!0),void 0!==e._fill&&this._drawLetterSpacing(f[t],e,s,b+e.padding,v+e.padding-u)}}_drawLetterSpacing(t,e,r,s,i,n=!1){const{context:o}=r,a=e.letterSpacing;let l=!1;if($n.experimentalLetterSpacingSupported&&($n.experimentalLetterSpacing?(o.letterSpacing=`${a}px`,o.textLetterSpacing=`${a}px`,l=!0):(o.letterSpacing="0px",o.textLetterSpacing="0px")),0===a||l)return void(n?o.strokeText(t,s,i):o.fillText(t,s,i));let h=s;const u=$n.graphemeSegmenter(t);let c=o.measureText(t).width,d=0;for(let t=0;t<u.length;++t){const e=u[t];n?o.strokeText(e,h,i):o.fillText(e,h,i);let r="";for(let e=t+1;e<u.length;++e)r+=u[e];d=o.measureText(r).width,h+=c-d+a,c=d}}destroy(){this._activeTextures=null}}Jn.extension={type:[u.WebGLSystem,u.WebGPUSystem,u.CanvasSystem],name:"canvasText"},p.add(Jn),p.add(En);class to extends m{constructor(){super(...arguments),this.chars=Object.create(null),this.lineHeight=0,this.fontFamily="",this.fontMetrics={fontSize:0,ascent:0,descent:0},this.baseLineOffset=0,this.distanceField={type:"none",range:0},this.pages=[],this.baseMeasurementFontSize=100,this.baseRenderedFontSize=100}get font(){return this.fontFamily}get pageTextures(){return this.pages}get size(){return this.fontMetrics.fontSize}get distanceFieldRange(){return this.distanceField.range}get distanceFieldType(){return this.distanceField.type}destroy(t=!1){this.emit("destroy",this),this.removeAllListeners();for(const t in this.chars)this.chars[t].texture.destroy();this.chars=null,t&&(this.pages.forEach((t=>t.texture.destroy(!0))),this.pages=null)}}var eo=function(t){var e=[];return t.replace(so,(function(t,r,s){var i=r.toLowerCase();for(s=function(t){var e=t.match(io);return e?e.map(Number):[]}(s),"m"==i&&s.length>2&&(e.push([r].concat(s.splice(0,2))),i="l",r="m"==r?"l":"L");;){if(s.length==ro[i])return s.unshift(r),e.push(s);if(s.length<ro[i])throw new Error("malformed path data");e.push([r].concat(s.splice(0,ro[i])))}})),e},ro={a:7,c:6,h:1,l:2,m:2,q:4,s:4,t:2,v:1,z:0},so=/([astvzqmhlc])([^astvzqmhlc]*)/gi;var io=/-?[0-9]*\.?[0-9]+(?:e[-+]?\d+)?/gi;var no=f(eo);function oo(t,e){const r=no(t),s=[];let i=null,n=0,o=0;for(let t=0;t<r.length;t++){const a=r[t],l=a[0],h=a;switch(l){case"M":n=h[1],o=h[2],e.moveTo(n,o);break;case"m":n+=h[1],o+=h[2],e.moveTo(n,o);break;case"H":n=h[1],e.lineTo(n,o);break;case"h":n+=h[1],e.lineTo(n,o);break;case"V":o=h[1],e.lineTo(n,o);break;case"v":o+=h[1],e.lineTo(n,o);break;case"L":n=h[1],o=h[2],e.lineTo(n,o);break;case"l":n+=h[1],o+=h[2],e.lineTo(n,o);break;case"C":n=h[5],o=h[6],e.bezierCurveTo(h[1],h[2],h[3],h[4],n,o);break;case"c":e.bezierCurveTo(n+h[1],o+h[2],n+h[3],o+h[4],n+h[5],o+h[6]),n+=h[5],o+=h[6];break;case"S":n=h[3],o=h[4],e.bezierCurveToShort(h[1],h[2],n,o);break;case"s":e.bezierCurveToShort(n+h[1],o+h[2],n+h[3],o+h[4]),n+=h[3],o+=h[4];break;case"Q":n=h[3],o=h[4],e.quadraticCurveTo(h[1],h[2],n,o);break;case"q":e.quadraticCurveTo(n+h[1],o+h[2],n+h[3],o+h[4]),n+=h[3],o+=h[4];break;case"T":n=h[1],o=h[2],e.quadraticCurveToShort(n,o);break;case"t":n+=h[1],o+=h[2],e.quadraticCurveToShort(n,o);break;case"A":n=h[6],o=h[7],e.arcToSvg(h[1],h[2],h[3],h[4],h[5],n,o);break;case"a":n+=h[6],o+=h[7],e.arcToSvg(h[1],h[2],h[3],h[4],h[5],n,o);break;case"Z":case"z":e.closePath(),s.length>0&&(i=s.pop(),i?(n=i.startX,o=i.startY):(n=0,o=0)),i=null}"Z"!==l&&"z"!==l&&null===i&&(i={startX:n,startY:o},s.push(i))}return e}class ao{constructor(t=0,e=0,r=0){this.type="circle",this.x=t,this.y=e,this.radius=r}clone(){return new ao(this.x,this.y,this.radius)}contains(t,e){if(this.radius<=0)return!1;const r=this.radius*this.radius;let s=this.x-t,i=this.y-e;return s*=s,i*=i,s+i<=r}strokeContains(t,e,r){if(0===this.radius)return!1;const s=this.x-t,i=this.y-e,n=this.radius,o=r/2,a=Math.sqrt(s*s+i*i);return a<n+o&&a>n-o}getBounds(t){return(t=t||new vt).x=this.x-this.radius,t.y=this.y-this.radius,t.width=2*this.radius,t.height=2*this.radius,t}copyFrom(t){return this.x=t.x,this.y=t.y,this.radius=t.radius,this}copyTo(t){return t.copyFrom(this),t}}class lo{constructor(t=0,e=0,r=0,s=0){this.type="ellipse",this.x=t,this.y=e,this.halfWidth=r,this.halfHeight=s}clone(){return new lo(this.x,this.y,this.halfWidth,this.halfHeight)}contains(t,e){if(this.halfWidth<=0||this.halfHeight<=0)return!1;let r=(t-this.x)/this.halfWidth,s=(e-this.y)/this.halfHeight;return r*=r,s*=s,r+s<=1}strokeContains(t,e,r){const{halfWidth:s,halfHeight:i}=this;if(s<=0||i<=0)return!1;const n=r/2,o=s-n,a=i-n,l=s+n,h=i+n,u=t-this.x,c=e-this.y;return u*u/(o*o)+c*c/(a*a)>1&&u*u/(l*l)+c*c/(h*h)<=1}getBounds(){return new vt(this.x-this.halfWidth,this.y-this.halfHeight,2*this.halfWidth,2*this.halfHeight)}copyFrom(t){return this.x=t.x,this.y=t.y,this.halfWidth=t.halfWidth,this.halfHeight=t.halfHeight,this}copyTo(t){return t.copyFrom(this),t}}function ho(t,e,r,s,i,n){const o=i-r,a=n-s,l=o*o+a*a;let h,u,c=-1;0!==l&&(c=((t-r)*o+(e-s)*a)/l),c<0?(h=r,u=s):c>1?(h=i,u=n):(h=r+c*o,u=s+c*a);const d=t-h,p=e-u;return d*d+p*p}class uo{constructor(...t){this.type="polygon";let e=Array.isArray(t[0])?t[0]:t;if("number"!=typeof e[0]){const t=[];for(let r=0,s=e.length;r<s;r++)t.push(e[r].x,e[r].y);e=t}this.points=e,this.closePath=!0}clone(){const t=this.points.slice(),e=new uo(t);return e.closePath=this.closePath,e}contains(t,e){let r=!1;const s=this.points.length/2;for(let i=0,n=s-1;i<s;n=i++){const s=this.points[2*i],o=this.points[2*i+1],a=this.points[2*n],l=this.points[2*n+1];o>e!=l>e&&t<(e-o)/(l-o)*(a-s)+s&&(r=!r)}return r}strokeContains(t,e,r){const s=r/2,i=s*s,{points:n}=this,o=n.length-(this.closePath?0:2);for(let r=0;r<o;r+=2){if(ho(t,e,n[r],n[r+1],n[(r+2)%n.length],n[(r+3)%n.length])<=i)return!0}return!1}getBounds(t){t=t||new vt;const e=this.points;let r=1/0,s=-1/0,i=1/0,n=-1/0;for(let t=0,o=e.length;t<o;t+=2){const o=e[t],a=e[t+1];r=o<r?o:r,s=o>s?o:s,i=a<i?a:i,n=a>n?a:n}return t.x=r,t.width=s-r,t.y=i,t.height=n-i,t}copyFrom(t){return this.points=t.points.slice(),this.closePath=t.closePath,this}copyTo(t){return t.copyFrom(this),t}get lastX(){return this.points[this.points.length-2]}get lastY(){return this.points[this.points.length-1]}get x(){return this.points[this.points.length-2]}get y(){return this.points[this.points.length-1]}}const co=(t,e,r,s,i,n)=>{const o=t-r,a=e-s,l=Math.sqrt(o*o+a*a);return l>=i-n&&l<=i+n};class po{constructor(t=0,e=0,r=0,s=0,i=20){this.type="roundedRectangle",this.x=t,this.y=e,this.width=r,this.height=s,this.radius=i}getBounds(t){return(t=t||new vt).x=this.x,t.y=this.y,t.width=this.width,t.height=this.height,t}clone(){return new po(this.x,this.y,this.width,this.height,this.radius)}copyFrom(t){return this.x=t.x,this.y=t.y,this.width=t.width,this.height=t.height,this}copyTo(t){return t.copyFrom(this),t}contains(t,e){if(this.width<=0||this.height<=0)return!1;if(t>=this.x&&t<=this.x+this.width&&e>=this.y&&e<=this.y+this.height){const r=Math.max(0,Math.min(this.radius,Math.min(this.width,this.height)/2));if(e>=this.y+r&&e<=this.y+this.height-r||t>=this.x+r&&t<=this.x+this.width-r)return!0;let s=t-(this.x+r),i=e-(this.y+r);const n=r*r;if(s*s+i*i<=n||(s=t-(this.x+this.width-r),s*s+i*i<=n)||(i=e-(this.y+this.height-r),s*s+i*i<=n)||(s=t-(this.x+r),s*s+i*i<=n))return!0}return!1}strokeContains(t,e,r){const{x:s,y:i,width:n,height:o,radius:a}=this,l=r/2,h=s+a,u=i+a,c=s+n,d=i+o;return(t>=s-l&&t<=s+l||t>=c-l&&t<=c+l)&&e>=u&&e<=u+(o-2*a)||(e>=i-l&&e<=i+l||e>=d-l&&e<=d+l)&&t>=h&&t<=h+(n-2*a)||(t<h&&e<u&&co(t,e,h,u,a,l)||t>c-a&&e<u&&co(t,e,c-a,u,a,l)||t>c-a&&e>d-a&&co(t,e,c-a,d-a,a,l)||t<h&&e>d-a&&co(t,e,h,d-a,a,l))}}const fo=1.1920929e-7;function go(t,e,r,s,i,n,o,a,l,h){let u=(1-Math.min(.99,Math.max(0,null!=h?h:sn.defaultOptions.bezierSmoothness)))/1;return u*=u,function(t,e,r,s,i,n,o,a,l,h){mo(t,e,r,s,i,n,o,a,l,h,0),l.push(o,a)}(e,r,s,i,n,o,a,l,t,u),t}function mo(t,e,r,s,i,n,o,a,l,h,u){if(u>8)return;Math.PI;const c=(t+r)/2,d=(e+s)/2,p=(r+i)/2,f=(s+n)/2,g=(i+o)/2,m=(n+a)/2,_=(c+p)/2,x=(d+f)/2,y=(p+g)/2,b=(f+m)/2,v=(_+y)/2,T=(x+b)/2;if(u>0){let u=o-t,c=a-e;const d=Math.abs((r-o)*c-(s-a)*u),p=Math.abs((i-o)*c-(n-a)*u);if(d>fo&&p>fo){if((d+p)*(d+p)<=h*(u*u+c*c))return void l.push(v,T)}else if(d>fo){if(d*d<=h*(u*u+c*c))return void l.push(v,T)}else if(p>fo){if(p*p<=h*(u*u+c*c))return void l.push(v,T)}else if(u=v-(t+o)/2,c=T-(e+a)/2,u*u+c*c<=h)return void l.push(v,T)}mo(t,e,c,d,_,x,v,T,l,h,u+1),mo(v,T,y,b,g,m,o,a,l,h,u+1)}function _o(t,e,r,s,i,n,o,a){let l=(1-Math.min(.99,Math.max(0,null!=a?a:sn.defaultOptions.bezierSmoothness)))/1;return l*=l,function(t,e,r,s,i,n,o,a){xo(o,t,e,r,s,i,n,a,0),o.push(i,n)}(e,r,s,i,n,o,t,l),t}function xo(t,e,r,s,i,n,o,a,l){if(l>8)return;Math.PI;const h=(e+s)/2,u=(r+i)/2,c=(s+n)/2,d=(i+o)/2,p=(h+c)/2,f=(u+d)/2;let g=n-e,m=o-r;const _=Math.abs((s-n)*m-(i-o)*g);if(_>1.1920929e-7){if(_*_<=a*(g*g+m*m))return void t.push(p,f)}else if(g=p-(e+n)/2,m=f-(r+o)/2,g*g+m*m<=a)return void t.push(p,f);xo(t,e,r,h,u,p,f,a,l+1),xo(t,p,f,c,d,n,o,a,l+1)}function yo(t,e,r,s,i,n,o,a){let l=Math.abs(i-n);(!o&&i>n||o&&n>i)&&(l=2*Math.PI-l),a=a||Math.max(6,Math.floor(6*Math.pow(s,.3333333333333333)*(l/Math.PI)));let h=l/(a=Math.max(a,3)),u=i;h*=o?-1:1;for(let i=0;i<a+1;i++){const i=e+Math.cos(u)*s,n=r+Math.sin(u)*s;t.push(i,n),u+=h}}function bo(t,e,r,s,i,n){const o=t[t.length-2],a=t[t.length-1]-r,l=o-e,h=i-r,u=s-e,c=Math.abs(a*u-l*h);if(c<1e-8||0===n)return void((t[t.length-2]!==e||t[t.length-1]!==r)&&t.push(e,r));const d=a*a+l*l,p=h*h+u*u,f=a*h+l*u,g=n*Math.sqrt(d)/c,m=n*Math.sqrt(p)/c,_=g*f/d,x=m*f/p,y=g*u+m*l,b=g*h+m*a,v=l*(m+_),T=a*(m+_),S=u*(g+x),w=h*(g+x);yo(t,y+e,b+r,n,Math.atan2(T-b,v-y),Math.atan2(w-b,S-y),l*h>u*a)}const vo=2*Math.PI,To={centerX:0,centerY:0,ang1:0,ang2:0},So=({x:t,y:e},r,s,i,n,o,a,l)=>{const h=i*(t*=r)-n*(e*=s),u=n*t+i*e;return l.x=h+o,l.y=u+a,l};function wo(t,e){const r=-1.5707963267948966===e?-.551915024494:1.3333333333333333*Math.tan(e/4),s=1.5707963267948966===e?.551915024494:r,i=Math.cos(t),n=Math.sin(t),o=Math.cos(t+e),a=Math.sin(t+e);return[{x:i-n*s,y:n+i*s},{x:o+a*s,y:a-o*s},{x:o,y:a}]}const Eo=(t,e,r,s)=>{let i=t*r+e*s;return i>1&&(i=1),i<-1&&(i=-1),(t*s-e*r<0?-1:1)*Math.acos(i)};function Ao(t,e,r,s,i,n,o,a=0,l=0,h=0){if(0===n||0===o)return;const u=Math.sin(a*vo/360),c=Math.cos(a*vo/360),d=c*(e-s)/2+u*(r-i)/2,p=-u*(e-s)/2+c*(r-i)/2;if(0===d&&0===p)return;n=Math.abs(n),o=Math.abs(o);const f=Math.pow(d,2)/Math.pow(n,2)+Math.pow(p,2)/Math.pow(o,2);f>1&&(n*=Math.sqrt(f),o*=Math.sqrt(f)),((t,e,r,s,i,n,o,a,l,h,u,c,d)=>{const p=Math.pow(i,2),f=Math.pow(n,2),g=Math.pow(u,2),m=Math.pow(c,2);let _=p*f-p*m-f*g;_<0&&(_=0),_/=p*m+f*g,_=Math.sqrt(_)*(o===a?-1:1);const x=_*i/n*c,y=_*-n/i*u,b=h*x-l*y+(t+r)/2,v=l*x+h*y+(e+s)/2,T=(u-x)/i,S=(c-y)/n,w=(-u-x)/i,E=(-c-y)/n,A=Eo(1,0,T,S);let M=Eo(T,S,w,E);0===a&&M>0&&(M-=vo),1===a&&M<0&&(M+=vo),d.centerX=b,d.centerY=v,d.ang1=A,d.ang2=M})(e,r,s,i,n,o,l,h,u,c,d,p,To);let{ang1:g,ang2:m}=To;const{centerX:_,centerY:x}=To;let y=Math.abs(m)/(vo/4);Math.abs(1-y)<1e-7&&(y=1);const b=Math.max(Math.ceil(y),1);m/=b;let v=t[t.length-2],T=t[t.length-1];const S={x:0,y:0};for(let e=0;e<b;e++){const e=wo(g,m),{x:r,y:s}=So(e[0],n,o,c,u,_,x,S),{x:i,y:a}=So(e[1],n,o,c,u,_,x,S),{x:l,y:h}=So(e[2],n,o,c,u,_,x,S);go(t,v,T,r,s,i,a,l,h),v=l,T=h,g+=m}}function Mo(t,e,r){var s;const i=(t,e)=>{const r=e.x-t.x,s=e.y-t.y,i=Math.sqrt(r*r+s*s);return{len:i,nx:r/i,ny:s/i}},n=(e,r)=>{0===e?t.moveTo(r.x,r.y):t.lineTo(r.x,r.y)};let o=e[e.length-1];for(let a=0;a<e.length;a++){const l=e[a%e.length],h=null!=(s=l.radius)?s:r;if(h<=0){n(a,l),o=l;continue}const u=e[(a+1)%e.length],c=i(l,o),d=i(l,u);if(c.len<1e-4||d.len<1e-4){n(a,l),o=l;continue}let p=Math.asin(c.nx*d.ny-c.ny*d.nx),f=1,g=!1;c.nx*d.nx-c.ny*-d.ny<0?p<0?p=Math.PI+p:(p=Math.PI-p,f=-1,g=!0):p>0&&(f=-1,g=!0);const m=p/2;let _,x=Math.abs(Math.cos(m)*h/Math.sin(m));x>Math.min(c.len/2,d.len/2)?(x=Math.min(c.len/2,d.len/2),_=Math.abs(x*Math.sin(m)/Math.cos(m))):_=h;const y=l.x+d.nx*x+-d.ny*_*f,b=l.y+d.ny*x+d.nx*_*f,v=Math.atan2(c.ny,c.nx)+Math.PI/2*f,T=Math.atan2(d.ny,d.nx)-Math.PI/2*f;0===a&&t.moveTo(y+Math.cos(v)*_,b+Math.sin(v)*_),t.arc(y,b,_,v,T,g),o=l}}function Po(t,e,r,s){var i;const n=(t,e)=>Math.sqrt((t.x-e.x)**2+(t.y-e.y)**2),o=(t,e,r)=>({x:t.x+(e.x-t.x)*r,y:t.y+(e.y-t.y)*r}),a=e.length;for(let l=0;l<a;l++){const h=e[(l+1)%a],u=null!=(i=h.radius)?i:r;if(u<=0){0===l?t.moveTo(h.x,h.y):t.lineTo(h.x,h.y);continue}const c=e[l],d=e[(l+2)%a],p=n(c,h);let f;if(p<1e-4)f=h;else{f=o(h,c,Math.min(p/2,u)/p)}const g=n(d,h);let m;if(g<1e-4)m=h;else{m=o(h,d,Math.min(g/2,u)/g)}0===l?t.moveTo(f.x,f.y):t.lineTo(f.x,f.y),t.quadraticCurveTo(h.x,h.y,m.x,m.y,s)}}const Ro=new vt;class Oo{constructor(t){this.shapePrimitives=[],this._currentPoly=null,this._bounds=new St,this._graphicsPath2D=t}moveTo(t,e){return this.startPoly(t,e),this}lineTo(t,e){this._ensurePoly();const r=this._currentPoly.points,s=r[r.length-2],i=r[r.length-1];return(s!==t||i!==e)&&r.push(t,e),this}arc(t,e,r,s,i,n){this._ensurePoly(!1);return yo(this._currentPoly.points,t,e,r,s,i,n),this}arcTo(t,e,r,s,i){this._ensurePoly();return bo(this._currentPoly.points,t,e,r,s,i),this}arcToSvg(t,e,r,s,i,n,o){return Ao(this._currentPoly.points,this._currentPoly.lastX,this._currentPoly.lastY,n,o,t,e,r,s,i),this}bezierCurveTo(t,e,r,s,i,n,o){this._ensurePoly();const a=this._currentPoly;return go(this._currentPoly.points,a.lastX,a.lastY,t,e,r,s,i,n,o),this}quadraticCurveTo(t,e,r,s,i){this._ensurePoly();const n=this._currentPoly;return _o(this._currentPoly.points,n.lastX,n.lastY,t,e,r,s,i),this}closePath(){return this.endPoly(!0),this}addPath(t,e){this.endPoly(),e&&!e.isIdentity()&&(t=t.clone(!0)).transform(e);for(let e=0;e<t.instructions.length;e++){const r=t.instructions[e];this[r.action](...r.data)}return this}finish(t=!1){this.endPoly(t)}rect(t,e,r,s,i){return this.drawShape(new vt(t,e,r,s),i),this}circle(t,e,r,s){return this.drawShape(new ao(t,e,r),s),this}poly(t,e,r){const s=new uo(t);return s.closePath=e,this.drawShape(s,r),this}regularPoly(t,e,r,s,i=0,n){s=Math.max(0|s,3);const o=-1*Math.PI/2+i,a=2*Math.PI/s,l=[];for(let i=0;i<s;i++){const s=i*a+o;l.push(t+r*Math.cos(s),e+r*Math.sin(s))}return this.poly(l,!0,n),this}roundPoly(t,e,r,s,i,n=0,o){if(s=Math.max(0|s,3),i<=0)return this.regularPoly(t,e,r,s,n);const a=r*Math.sin(Math.PI/s)-.001;i=Math.min(i,a);const l=-1*Math.PI/2+n,h=2*Math.PI/s,u=(s-2)*Math.PI/s/2;for(let n=0;n<s;n++){const s=n*h+l,a=t+r*Math.cos(s),c=e+r*Math.sin(s),d=s+Math.PI+u,p=s-Math.PI-u,f=a+i*Math.cos(d),g=c+i*Math.sin(d),m=a+i*Math.cos(p),_=c+i*Math.sin(p);0===n?this.moveTo(f,g):this.lineTo(f,g),this.quadraticCurveTo(a,c,m,_,o)}return this.closePath()}roundShape(t,e,r=!1,s){return t.length<3?this:(r?Po(this,t,e,s):Mo(this,t,e),this.closePath())}filletRect(t,e,r,s,i){if(0===i)return this.rect(t,e,r,s);const n=Math.min(r,s)/2,o=Math.min(n,Math.max(-n,i)),a=t+r,l=e+s,h=o<0?-o:0,u=Math.abs(o);return this.moveTo(t,e+u).arcTo(t+h,e+h,t+u,e,u).lineTo(a-u,e).arcTo(a-h,e+h,a,e+u,u).lineTo(a,l-u).arcTo(a-h,l-h,t+r-u,l,u).lineTo(t+u,l).arcTo(t+h,l-h,t,l-u,u).closePath()}chamferRect(t,e,r,s,i,n){if(i<=0)return this.rect(t,e,r,s);const o=Math.min(i,Math.min(r,s)/2),a=t+r,l=e+s,h=[t+o,e,a-o,e,a,e+o,a,l-o,a-o,l,t+o,l,t,l-o,t,e+o];for(let t=h.length-1;t>=2;t-=2)h[t]===h[t-2]&&h[t-1]===h[t-3]&&h.splice(t-1,2);return this.poly(h,!0,n)}ellipse(t,e,r,s,i){return this.drawShape(new lo(t,e,r,s),i),this}roundRect(t,e,r,s,i,n){return this.drawShape(new po(t,e,r,s,i),n),this}drawShape(t,e){return this.endPoly(),this.shapePrimitives.push({shape:t,transform:e}),this}startPoly(t,e){let r=this._currentPoly;return r&&this.endPoly(),r=new uo,r.points.push(t,e),this._currentPoly=r,this}endPoly(t=!1){const e=this._currentPoly;return e&&e.points.length>2&&(e.closePath=t,this.shapePrimitives.push({shape:e})),this._currentPoly=null,this}_ensurePoly(t=!0){if(!this._currentPoly&&(this._currentPoly=new uo,t)){const t=this.shapePrimitives[this.shapePrimitives.length-1];if(t){let e=t.shape.x,r=t.shape.y;if(!t.transform.isIdentity()){const s=t.transform,i=e;e=s.a*e+s.c*r+s.tx,r=s.b*i+s.d*r+s.ty}this._currentPoly.points.push(e,r)}else this._currentPoly.points.push(0,0)}}buildPath(){const t=this._graphicsPath2D;this.shapePrimitives.length=0,this._currentPoly=null;for(let e=0;e<t.instructions.length;e++){const r=t.instructions[e];this[r.action](...r.data)}this.finish()}get bounds(){const t=this._bounds;t.clear();const e=this.shapePrimitives;for(let r=0;r<e.length;r++){const s=e[r],i=s.shape.getBounds(Ro);s.transform?t.addRect(i,s.transform):t.addRect(i)}return t}}class Co{constructor(t){var e;this.instructions=[],this.uid=ht("graphicsPath"),this._dirty=!0,"string"==typeof t?oo(t,this):this.instructions=null!=(e=null==t?void 0:t.slice())?e:[]}get shapePath(){return this._shapePath||(this._shapePath=new Oo(this)),this._dirty&&(this._dirty=!1,this._shapePath.buildPath()),this._shapePath}addPath(t,e){return t=t.clone(),this.instructions.push({action:"addPath",data:[t,e]}),this._dirty=!0,this}arc(...t){return this.instructions.push({action:"arc",data:t}),this._dirty=!0,this}arcTo(...t){return this.instructions.push({action:"arcTo",data:t}),this._dirty=!0,this}arcToSvg(...t){return this.instructions.push({action:"arcToSvg",data:t}),this._dirty=!0,this}bezierCurveTo(...t){return this.instructions.push({action:"bezierCurveTo",data:t}),this._dirty=!0,this}bezierCurveToShort(t,e,r,s,i){const n=this.instructions[this.instructions.length-1],o=this.getLastPoint(rt.shared);let a=0,l=0;if(n&&"bezierCurveTo"===n.action){a=n.data[2],l=n.data[3];const t=o.x,e=o.y;a=t+(t-a),l=e+(e-l)}else a=o.x,l=o.y;return this.instructions.push({action:"bezierCurveTo",data:[a,l,t,e,r,s,i]}),this._dirty=!0,this}closePath(){return this.instructions.push({action:"closePath",data:[]}),this._dirty=!0,this}ellipse(...t){return this.instructions.push({action:"ellipse",data:t}),this._dirty=!0,this}lineTo(...t){return this.instructions.push({action:"lineTo",data:t}),this._dirty=!0,this}moveTo(...t){return this.instructions.push({action:"moveTo",data:t}),this}quadraticCurveTo(...t){return this.instructions.push({action:"quadraticCurveTo",data:t}),this._dirty=!0,this}quadraticCurveToShort(t,e,r){const s=this.instructions[this.instructions.length-1],i=this.getLastPoint(rt.shared);let n=0,o=0;if(s&&"quadraticCurveTo"===s.action){n=s.data[0],o=s.data[1];const t=i.x,e=i.y;n=t+(t-n),o=e+(e-o)}else n=i.x,o=i.y;return this.instructions.push({action:"quadraticCurveTo",data:[n,o,t,e,r]}),this._dirty=!0,this}rect(t,e,r,s,i){return this.instructions.push({action:"rect",data:[t,e,r,s,i]}),this._dirty=!0,this}circle(t,e,r,s){return this.instructions.push({action:"circle",data:[t,e,r,s]}),this._dirty=!0,this}roundRect(...t){return this.instructions.push({action:"roundRect",data:t}),this._dirty=!0,this}poly(...t){return this.instructions.push({action:"poly",data:t}),this._dirty=!0,this}regularPoly(...t){return this.instructions.push({action:"regularPoly",data:t}),this._dirty=!0,this}roundPoly(...t){return this.instructions.push({action:"roundPoly",data:t}),this._dirty=!0,this}roundShape(...t){return this.instructions.push({action:"roundShape",data:t}),this._dirty=!0,this}filletRect(...t){return this.instructions.push({action:"filletRect",data:t}),this._dirty=!0,this}chamferRect(...t){return this.instructions.push({action:"chamferRect",data:t}),this._dirty=!0,this}star(t,e,r,s,i,n,o){i=i||s/2;const a=-1*Math.PI/2+n,l=2*r,h=2*Math.PI/l,u=[];for(let r=0;r<l;r++){const n=r%2?i:s,o=r*h+a;u.push(t+n*Math.cos(o),e+n*Math.sin(o))}return this.poly(u,!0,o),this}clone(t=!1){const e=new Co;if(t)for(let t=0;t<this.instructions.length;t++){const r=this.instructions[t];e.instructions.push({action:r.action,data:r.data.slice()})}else e.instructions=this.instructions.slice();return e}clear(){return this.instructions.length=0,this._dirty=!0,this}transform(t){if(t.isIdentity())return this;const e=t.a,r=t.b,s=t.c,i=t.d,n=t.tx,o=t.ty;let a=0,l=0,h=0,u=0,c=0,d=0,p=0,f=0;for(let g=0;g<this.instructions.length;g++){const m=this.instructions[g],_=m.data;switch(m.action){case"moveTo":case"lineTo":a=_[0],l=_[1],_[0]=e*a+s*l+n,_[1]=r*a+i*l+o;break;case"bezierCurveTo":h=_[0],u=_[1],c=_[2],d=_[3],a=_[4],l=_[5],_[0]=e*h+s*u+n,_[1]=r*h+i*u+o,_[2]=e*c+s*d+n,_[3]=r*c+i*d+o,_[4]=e*a+s*l+n,_[5]=r*a+i*l+o;break;case"quadraticCurveTo":h=_[0],u=_[1],a=_[2],l=_[3],_[0]=e*h+s*u+n,_[1]=r*h+i*u+o,_[2]=e*a+s*l+n,_[3]=r*a+i*l+o;break;case"arcToSvg":a=_[5],l=_[6],p=_[0],f=_[1],_[0]=e*p+s*f,_[1]=r*p+i*f,_[5]=e*a+s*l+n,_[6]=r*a+i*l+o;break;case"circle":_[4]=Io(_[3],t);break;case"rect":_[4]=Io(_[4],t);break;case"ellipse":_[8]=Io(_[8],t);break;case"roundRect":_[5]=Io(_[5],t);break;case"addPath":_[0].transform(t);break;case"poly":_[2]=Io(_[2],t)}}return this._dirty=!0,this}get bounds(){return this.shapePath.bounds}getLastPoint(t){let e=this.instructions.length-1,r=this.instructions[e];if(!r)return t.x=0,t.y=0,t;for(;"closePath"===r.action;){if(e--,e<0)return t.x=0,t.y=0,t;r=this.instructions[e]}switch(r.action){case"moveTo":case"lineTo":t.x=r.data[0],t.y=r.data[1];break;case"quadraticCurveTo":t.x=r.data[2],t.y=r.data[3];break;case"bezierCurveTo":t.x=r.data[4],t.y=r.data[5];break;case"arc":case"arcToSvg":t.x=r.data[5],t.y=r.data[6];break;case"addPath":r.data[0].getLastPoint(t)}return t}}function Io(t,e){return t?t.prepend(e):e.clone()}var Go=Object.defineProperty,ko=Object.getOwnPropertySymbols,Bo=Object.prototype.hasOwnProperty,Do=Object.prototype.propertyIsEnumerable,Fo=(t,e,r)=>e in t?Go(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r,No=(t,e)=>{for(var r in e||(e={}))Bo.call(e,r)&&Fo(t,r,e[r]);if(ko)for(var r of ko(e))Do.call(e,r)&&Fo(t,r,e[r]);return t};function Uo(t,e){if("string"==typeof t){const e=document.createElement("div");e.innerHTML=t.trim(),t=e.querySelector("svg")}return Lo(t,{context:e,path:new Co},null,null),e}function Lo(t,e,r,s){const i=t.children,{fillStyle:n,strokeStyle:o}=function(t){const e=t.getAttribute("style"),r={},s={};let i=!1,n=!1;if(e){const t=e.split(";");for(let e=0;e<t.length;e++){const o=t[e],[a,l]=o.split(":");switch(a){case"stroke":"none"!==l&&(r.color=Z.shared.setValue(l).toNumber(),n=!0);break;case"stroke-width":r.width=Number(l);break;case"fill":"none"!==l&&(i=!0,s.color=Z.shared.setValue(l).toNumber());break;case"fill-opacity":s.alpha=Number(l);break;case"stroke-opacity":r.alpha=Number(l);break;case"opacity":s.alpha=Number(l),r.alpha=Number(l)}}}else{const e=t.getAttribute("stroke");e&&"none"!==e&&(n=!0,r.color=Z.shared.setValue(e).toNumber(),r.width=Xo(t,"stroke-width",1));const o=t.getAttribute("fill");o&&"none"!==o&&(i=!0,s.color=Z.shared.setValue(o).toNumber())}return{strokeStyle:n?r:null,fillStyle:i?s:null}}(t);let a,l,h,u,c,d,p,f,g,m,_,x,y,b,v,T,S;switch(n&&r?r=No(No({},r),n):n&&(r=n),o&&s?s=No(No({},s),o):o&&(s=o),e.context.fillStyle=r,e.context.strokeStyle=s,t.nodeName.toLowerCase()){case"path":b=t.getAttribute("d"),v=new Co(b),e.context.path(v),r&&e.context.fill(),s&&e.context.stroke();break;case"circle":p=Xo(t,"cx",0),f=Xo(t,"cy",0),g=Xo(t,"r",0),e.context.ellipse(p,f,g,g),r&&e.context.fill(),s&&e.context.stroke();break;case"rect":a=Xo(t,"x",0),l=Xo(t,"y",0),T=Xo(t,"width",0),S=Xo(t,"height",0),m=Xo(t,"rx",0),_=Xo(t,"ry",0),m||_?e.context.roundRect(a,l,T,S,m||_):e.context.rect(a,l,T,S),r&&e.context.fill(),s&&e.context.stroke();break;case"ellipse":p=Xo(t,"cx",0),f=Xo(t,"cy",0),m=Xo(t,"rx",0),_=Xo(t,"ry",0),e.context.beginPath(),e.context.ellipse(p,f,m,_),r&&e.context.fill(),s&&e.context.stroke();break;case"line":h=Xo(t,"x1",0),u=Xo(t,"y1",0),c=Xo(t,"x2",0),d=Xo(t,"y2",0),e.context.beginPath(),e.context.moveTo(h,u),e.context.lineTo(c,d),s&&e.context.stroke();break;case"polygon":y=t.getAttribute("points"),x=y.match(/\d+/g).map((t=>parseInt(t,10))),e.context.poly(x,!0),r&&e.context.fill(),s&&e.context.stroke();break;case"polyline":y=t.getAttribute("points"),x=y.match(/\d+/g).map((t=>parseInt(t,10))),e.context.poly(x,!1),s&&e.context.stroke();break;case"g":case"svg":break;default:console.info(`[SVG parser] <${t.nodeName}> elements unsupported`)}for(let t=0;t<i.length;t++)Lo(i[t],e,r,s)}function Xo(t,e,r){const s=t.getAttribute(e);return s?Number(s):r}var zo=Object.defineProperty,Ho=Object.defineProperties,jo=Object.getOwnPropertyDescriptors,Vo=Object.getOwnPropertySymbols,Wo=Object.prototype.hasOwnProperty,$o=Object.prototype.propertyIsEnumerable,Yo=(t,e,r)=>e in t?zo(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r,qo=(t,e)=>{for(var r in e||(e={}))Wo.call(e,r)&&Yo(t,r,e[r]);if(Vo)for(var r of Vo(e))$o.call(e,r)&&Yo(t,r,e[r]);return t},Ko=(t,e)=>Ho(t,jo(e));function Zo(t,e){var r,s;if(null==t)return null;let i,n;if(null!=t&&t.fill?(n=t.fill,i=qo(qo({},e),t)):(n=t,i=e),Z.isColorLike(n)){const t=Z.shared.setValue(null!=n?n:0);return Ko(qo({},i),{color:t.toNumber(),alpha:1===t.alpha?i.alpha:t.alpha,texture:zr.WHITE})}if(n instanceof Zn){const t=n;return Ko(qo({},i),{color:16777215,texture:t.texture,matrix:t.transform,fill:null!=(r=i.fill)?r:null})}if(n instanceof qn){const t=n;return t.buildLinearGradient(),Ko(qo({},i),{color:16777215,texture:t.texture,matrix:t.transform})}const o=qo(qo({},e),t);if(o.texture){if(o.texture!==zr.WHITE){const t=(null==(s=o.matrix)?void 0:s.invert())||new it;t.scale(1/o.texture.frame.width,1/o.texture.frame.height),o.matrix=t}const t=o.texture.source.style;"clamp-to-edge"===t.addressMode&&(t.addressMode="repeat")}const a=Z.shared.setValue(o.color);return o.alpha*=a.alpha,o.color=a.toNumber(),o.matrix=o.matrix?o.matrix.clone():null,o}var Qo=Object.defineProperty,Jo=Object.getOwnPropertySymbols,ta=Object.prototype.hasOwnProperty,ea=Object.prototype.propertyIsEnumerable,ra=(t,e,r)=>e in t?Qo(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r,sa=(t,e)=>{for(var r in e||(e={}))ta.call(e,r)&&ra(t,r,e[r]);if(Jo)for(var r of Jo(e))ea.call(e,r)&&ra(t,r,e[r]);return t};const ia=new rt,na=new it,oa=class t extends m{constructor(){super(...arguments),this.uid=ht("graphicsContext"),this.dirty=!0,this.batchMode="auto",this.instructions=[],this._activePath=new Co,this._transform=new it,this._fillStyle=sa({},t.defaultFillStyle),this._strokeStyle=sa({},t.defaultStrokeStyle),this._stateStack=[],this._tick=0,this._bounds=new St,this._boundsDirty=!0}clone(){const e=new t;return e.batchMode=this.batchMode,e.instructions=this.instructions.slice(),e._activePath=this._activePath.clone(),e._transform=this._transform.clone(),e._fillStyle=sa({},this._fillStyle),e._strokeStyle=sa({},this._strokeStyle),e._stateStack=this._stateStack.slice(),e._bounds=this._bounds.clone(),e._boundsDirty=!0,e}get fillStyle(){return this._fillStyle}set fillStyle(e){this._fillStyle=Zo(e,t.defaultFillStyle)}get strokeStyle(){return this._strokeStyle}set strokeStyle(e){this._strokeStyle=Zo(e,t.defaultStrokeStyle)}setFillStyle(e){return this._fillStyle=Zo(e,t.defaultFillStyle),this}setStrokeStyle(e){return this._strokeStyle=Zo(e,t.defaultStrokeStyle),this}texture(t,e,r,s,i,n){return this.instructions.push({action:"texture",data:{image:t,dx:r||0,dy:s||0,dw:i||t.frame.width,dh:n||t.frame.height,transform:this._transform.clone(),alpha:this._fillStyle.alpha,style:e?Z.shared.setValue(e).toNumber():16777215}}),this.onUpdate(),this}beginPath(){return this._activePath=new Co,this}fill(e,r){let s;const i=this.instructions[this.instructions.length-1];return s=0===this._tick&&i&&"stroke"===i.action?i.data.path:this._activePath.clone(),s?(null!=e&&(void 0!==r&&"number"==typeof e&&(e={color:e,alpha:r}),this._fillStyle=Zo(e,t.defaultFillStyle)),this.instructions.push({action:"fill",data:{style:this.fillStyle,path:s}}),this.onUpdate(),this._initNextPathLocation(),this._tick=0,this):this}_initNextPathLocation(){const{x:t,y:e}=this._activePath.getLastPoint(rt.shared);this._activePath.clear(),this._activePath.moveTo(t,e)}stroke(e){let r;const s=this.instructions[this.instructions.length-1];return r=0===this._tick&&s&&"fill"===s.action?s.data.path:this._activePath.clone(),r?(null!=e&&(this._strokeStyle=Zo(e,t.defaultStrokeStyle)),this.instructions.push({action:"stroke",data:{style:this.strokeStyle,path:r}}),this.onUpdate(),this._initNextPathLocation(),this._tick=0,this):this}cut(){for(let t=0;t<2;t++){const e=this.instructions[this.instructions.length-1-t],r=this._activePath.clone();if(e&&("stroke"===e.action||"fill"===e.action)){if(!e.data.hole){e.data.hole=r;break}e.data.hole.addPath(r)}}return this._initNextPathLocation(),this}arc(t,e,r,s,i,n){this._tick++;const o=this._transform;return this._activePath.arc(o.a*t+o.c*e+o.tx,o.b*t+o.d*e+o.ty,r,s,i,n),this}arcTo(t,e,r,s,i){this._tick++;const n=this._transform;return this._activePath.arcTo(n.a*t+n.c*e+n.tx,n.b*t+n.d*e+n.ty,n.a*r+n.c*s+n.tx,n.b*r+n.d*s+n.ty,i),this}arcToSvg(t,e,r,s,i,n,o){this._tick++;const a=this._transform;return this._activePath.arcToSvg(t,e,r,s,i,a.a*n+a.c*o+a.tx,a.b*n+a.d*o+a.ty),this}bezierCurveTo(t,e,r,s,i,n,o){this._tick++;const a=this._transform;return this._activePath.bezierCurveTo(a.a*t+a.c*e+a.tx,a.b*t+a.d*e+a.ty,a.a*r+a.c*s+a.tx,a.b*r+a.d*s+a.ty,a.a*i+a.c*n+a.tx,a.b*i+a.d*n+a.ty,o),this}closePath(){var t;return this._tick++,null==(t=this._activePath)||t.closePath(),this}ellipse(t,e,r,s){return this._tick++,this._activePath.ellipse(t,e,r,s,this._transform.clone()),this}circle(t,e,r){return this._tick++,this._activePath.circle(t,e,r,this._transform.clone()),this}path(t){return this._tick++,this._activePath.addPath(t,this._transform.clone()),this}lineTo(t,e){this._tick++;const r=this._transform;return this._activePath.lineTo(r.a*t+r.c*e+r.tx,r.b*t+r.d*e+r.ty),this}moveTo(t,e){this._tick++;const r=this._transform,s=this._activePath.instructions,i=r.a*t+r.c*e+r.tx,n=r.b*t+r.d*e+r.ty;return 1===s.length&&"moveTo"===s[0].action?(s[0].data[0]=i,s[0].data[1]=n,this):(this._activePath.moveTo(i,n),this)}quadraticCurveTo(t,e,r,s,i){this._tick++;const n=this._transform;return this._activePath.quadraticCurveTo(n.a*t+n.c*e+n.tx,n.b*t+n.d*e+n.ty,n.a*r+n.c*s+n.tx,n.b*r+n.d*s+n.ty,i),this}rect(t,e,r,s){return this._tick++,this._activePath.rect(t,e,r,s,this._transform.clone()),this}roundRect(t,e,r,s,i){return this._tick++,this._activePath.roundRect(t,e,r,s,i,this._transform.clone()),this}poly(t,e){return this._tick++,this._activePath.poly(t,e,this._transform.clone()),this}regularPoly(t,e,r,s,i=0,n){return this._tick++,this._activePath.regularPoly(t,e,r,s,i,n),this}roundPoly(t,e,r,s,i,n){return this._tick++,this._activePath.roundPoly(t,e,r,s,i,n),this}roundShape(t,e,r,s){return this._tick++,this._activePath.roundShape(t,e,r,s),this}filletRect(t,e,r,s,i){return this._tick++,this._activePath.filletRect(t,e,r,s,i),this}chamferRect(t,e,r,s,i,n){return this._tick++,this._activePath.chamferRect(t,e,r,s,i,n),this}star(t,e,r,s,i=0,n=0){return this._tick++,this._activePath.star(t,e,r,s,i,n,this._transform.clone()),this}svg(t){return this._tick++,Uo(t,this),this}restore(){const t=this._stateStack.pop();return t&&(this._transform=t.transform,this._fillStyle=t.fillStyle,this._strokeStyle=t.strokeStyle),this}save(){return this._stateStack.push({transform:this._transform.clone(),fillStyle:sa({},this._fillStyle),strokeStyle:sa({},this._strokeStyle)}),this}getTransform(){return this._transform}resetTransform(){return this._transform.identity(),this}rotate(t){return this._transform.rotate(t),this}scale(t,e=t){return this._transform.scale(t,e),this}setTransform(t,e,r,s,i,n){return t instanceof it?(this._transform.set(t.a,t.b,t.c,t.d,t.tx,t.ty),this):(this._transform.set(t,e,r,s,i,n),this)}transform(t,e,r,s,i,n){return t instanceof it?(this._transform.append(t),this):(na.set(t,e,r,s,i,n),this._transform.append(na),this)}translate(t,e=t){return this._transform.translate(t,e),this}clear(){return this.instructions.length=0,this.resetTransform(),this.onUpdate(),this}onUpdate(){this.dirty||(this.emit("update",this,16),this.dirty=!0,this._boundsDirty=!0)}get bounds(){if(!this._boundsDirty)return this._bounds;const t=this._bounds;t.clear();for(let e=0;e<this.instructions.length;e++){const r=this.instructions[e],s=r.action;if("fill"===s){const e=r.data;t.addBounds(e.path.bounds)}else if("texture"===s){const e=r.data;t.addFrame(e.dx,e.dy,e.dx+e.dw,e.dy+e.dh,e.transform)}if("stroke"===s){const e=r.data,s=e.style.width/2,i=e.path.bounds;t.addFrame(i.minX-s,i.minY-s,i.maxX+s,i.maxY+s)}}return t}containsPoint(t){var e;if(!this.bounds.containsPoint(t.x,t.y))return!1;const r=this.instructions;let s=!1;for(let i=0;i<r.length;i++){const n=r[i],o=n.data,a=o.path;if(!n.action||!a)continue;const l=o.style,h=a.shapePath.shapePrimitives;for(let r=0;r<h.length;r++){const i=h[r].shape;if(!l||!i)continue;const a=h[r].transform,u=a?a.applyInverse(t,ia):t;s="fill"===n.action?i.contains(u.x,u.y):i.strokeContains(u.x,u.y,l.width);const c=o.hole;if(c){const t=null==(e=c.shapePath)?void 0:e.shapePrimitives;if(t)for(let e=0;e<t.length;e++)t[e].shape.contains(u.x,u.y)&&(s=!1)}if(s)return!0}}return s}destroy(t=!1){if(this._stateStack.length=0,this._transform=null,this.emit("destroy",this),this.removeAllListeners(),"boolean"==typeof t?t:null==t?void 0:t.texture){const e="boolean"==typeof t?t:null==t?void 0:t.textureSource;this._fillStyle.texture&&this._fillStyle.texture.destroy(e),this._strokeStyle.texture&&this._strokeStyle.texture.destroy(e)}this._fillStyle=null,this._strokeStyle=null,this.instructions=null,this._activePath=null,this._bounds=null,this._stateStack=null,this.customShader=null,this._transform=null}};oa.defaultFillStyle={color:16777215,alpha:1,texture:zr.WHITE,matrix:null,fill:null},oa.defaultStrokeStyle={width:1,color:16777215,alpha:1,alignment:.5,miterLimit:10,cap:"butt",join:"miter",texture:zr.WHITE,matrix:null,fill:null};let aa=oa;const la=["_fontFamily","_fontStyle","_fontSize","_fontVariant","_fontWeight","_breakWords","_align","_leading","_letterSpacing","_lineHeight","_textBaseline","_whiteSpace","_wordWrap","_wordWrapWidth","_padding","_cssOverrides","_trim"];function ha(t){const e=[];let r=0;for(let s=0;s<la.length;s++){const i=la[s];e[r++]=t[i]}return r=ua(t._fill,e,r),r=function(t,e,r){return t&&(r=ua(t,e,r),e[r++]=t.width,e[r++]=t.alignment,e[r++]=t.cap,e[r++]=t.join,e[r++]=t.miterLimit),r}(t._stroke,e,r),e.join("-")}function ua(t,e,r){var s;return t&&(e[r++]=t.color,e[r++]=t.alpha,e[r++]=null==(s=t.fill)?void 0:s.uid),r}var ca=Object.defineProperty,da=Object.getOwnPropertySymbols,pa=Object.prototype.hasOwnProperty,fa=Object.prototype.propertyIsEnumerable,ga=(t,e,r)=>e in t?ca(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r,ma=(t,e)=>{for(var r in e||(e={}))pa.call(e,r)&&ga(t,r,e[r]);if(da)for(var r of da(e))fa.call(e,r)&&ga(t,r,e[r]);return t};const _a=class t extends m{constructor(e={}){super(),function(t){var e,r,s,i,n;const o=t;if("boolean"==typeof o.dropShadow&&o.dropShadow){const a=xa.defaultDropShadow;t.dropShadow={alpha:null!=(e=o.dropShadowAlpha)?e:a.alpha,angle:null!=(r=o.dropShadowAngle)?r:a.angle,blur:null!=(s=o.dropShadowBlur)?s:a.blur,color:null!=(i=o.dropShadowColor)?i:a.color,distance:null!=(n=o.dropShadowDistance)?n:a.distance}}if(o.strokeThickness){const e=o.stroke;t.stroke={color:e,width:o.strokeThickness}}if(Array.isArray(o.fill)){const e=new qn(0,0,0,1.7*t.fontSize),r=o.fill.map((t=>Z.shared.setValue(t).toNumber()));r.forEach(((t,s)=>{var i;const n=null!=(i=o.fillGradientStops[s])?i:s/r.length;e.addColorStop(n,t)})),t.fill={fill:e}}}(e);const r=ma(ma({},t.defaultTextStyle),e);for(const t in r){this[t]=r[t]}this.update()}get align(){return this._align}set align(t){this._align=t,this.update()}get breakWords(){return this._breakWords}set breakWords(t){this._breakWords=t,this.update()}get dropShadow(){return this._dropShadow}set dropShadow(e){this._dropShadow=null!==e&&"object"==typeof e?ma(ma({},t.defaultDropShadow),e):e?ma({},t.defaultDropShadow):null,this.update()}get fontFamily(){return this._fontFamily}set fontFamily(t){this._fontFamily=t,this.update()}get fontSize(){return this._fontSize}set fontSize(t){this._fontSize="string"==typeof t?parseInt(t,10):t,this.update()}get fontStyle(){return this._fontStyle}set fontStyle(t){this._fontStyle=t,this.update()}get fontVariant(){return this._fontVariant}set fontVariant(t){this._fontVariant=t,this.update()}get fontWeight(){return this._fontWeight}set fontWeight(t){this._fontWeight=t,this.update()}get leading(){return this._leading}set leading(t){this._leading=t,this.update()}get letterSpacing(){return this._letterSpacing}set letterSpacing(t){this._letterSpacing=t,this.update()}get lineHeight(){return this._lineHeight}set lineHeight(t){this._lineHeight=t,this.update()}get padding(){return this._padding}set padding(t){this._padding=t,this.update()}get trim(){return this._trim}set trim(t){this._trim=t,this.update()}get textBaseline(){return this._textBaseline}set textBaseline(t){this._textBaseline=t,this.update()}get whiteSpace(){return this._whiteSpace}set whiteSpace(t){this._whiteSpace=t,this.update()}get wordWrap(){return this._wordWrap}set wordWrap(t){this._wordWrap=t,this.update()}get wordWrapWidth(){return this._wordWrapWidth}set wordWrapWidth(t){this._wordWrapWidth=t,this.update()}get fill(){return this._originalFill}set fill(t){t!==this._originalFill&&(this._originalFill=t,this._fill=Zo(0===t?"black":t,aa.defaultFillStyle),this.update())}get stroke(){return this._originalStroke}set stroke(t){t!==this._originalStroke&&(this._originalStroke=t,this._stroke=Zo(t,aa.defaultStrokeStyle),this.update())}_generateKey(){return this._styleKey=ha(this),this._styleKey}update(){this._styleKey=null,this.emit("update",this)}reset(){const e=t.defaultTextStyle;for(const t in e)this[t]=e[t]}get styleKey(){return this._styleKey||this._generateKey()}clone(){return new t({align:this.align,breakWords:this.breakWords,dropShadow:this.dropShadow,fill:this._fill,fontFamily:this.fontFamily,fontSize:this.fontSize,fontStyle:this.fontStyle,fontVariant:this.fontVariant,fontWeight:this.fontWeight,leading:this.leading,letterSpacing:this.letterSpacing,lineHeight:this.lineHeight,padding:this.padding,stroke:this._stroke,textBaseline:this.textBaseline,whiteSpace:this.whiteSpace,wordWrap:this.wordWrap,wordWrapWidth:this.wordWrapWidth})}destroy(t=!1){var e,r,s,i;if(this.removeAllListeners(),"boolean"==typeof t?t:null==t?void 0:t.texture){const n="boolean"==typeof t?t:null==t?void 0:t.textureSource;null!=(e=this._fill)&&e.texture&&this._fill.texture.destroy(n),null!=(r=this._originalFill)&&r.texture&&this._originalFill.texture.destroy(n),null!=(s=this._stroke)&&s.texture&&this._stroke.texture.destroy(n),null!=(i=this._originalStroke)&&i.texture&&this._originalStroke.texture.destroy(n)}this._fill=null,this._stroke=null,this.dropShadow=null,this._originalStroke=null,this._originalFill=null}};_a.defaultDropShadow={alpha:1,angle:Math.PI/6,blur:0,color:"black",distance:5},_a.defaultTextStyle={align:"left",breakWords:!1,dropShadow:null,fill:"black",fontFamily:"Arial",fontSize:26,fontStyle:"normal",fontVariant:"normal",fontWeight:"normal",leading:0,letterSpacing:0,lineHeight:0,padding:0,stroke:null,textBaseline:"alphabetic",trim:!1,whiteSpace:"pre",wordWrap:!1,wordWrapWidth:100};let xa=_a;function ya(t){if(""===t)return[];"string"==typeof t&&(t=[t]);const e=[];for(let r=0,s=t.length;r<s;r++){const s=t[r];if(Array.isArray(s)){if(2!==s.length)throw new Error(`[BitmapFont]: Invalid character range length, expecting 2 got ${s.length}.`);if(0===s[0].length||0===s[1].length)throw new Error("[BitmapFont]: Invalid character delimiter.");const t=s[0].charCodeAt(0),r=s[1].charCodeAt(0);if(r<t)throw new Error("[BitmapFont]: Invalid character range.");for(let s=t,i=r;s<=i;s++)e.push(String.fromCharCode(s))}else e.push(...Array.from(s))}if(0===e.length)throw new Error("[BitmapFont]: Empty set when resolving characters.");return e}class ba extends to{constructor(t){var e,r,s;super(),this.resolution=1,this.pages=[],this._padding=4,this._measureCache=Object.create(null),this._currentChars=[],this._currentX=0,this._currentY=0,this._currentPageIndex=-1,this._skipKerning=!1;const i=t,n=i.style.clone();i.overrideFill&&(n._fill.color=16777215,n._fill.alpha=1,n._fill.texture=zr.WHITE,n._fill.fill=null);const o=n.fontSize;n.fontSize=this.baseMeasurementFontSize;const a=jn(n);i.overrideSize?n._stroke&&(n._stroke.width*=this.baseRenderedFontSize/o):n.fontSize=this.baseRenderedFontSize=o,this._style=n,this._skipKerning=null!=(e=i.skipKerning)&&e,this.resolution=null!=(r=i.resolution)?r:1,this._padding=null!=(s=i.padding)?s:4,this.fontMetrics=$n.measureFont(a),this.lineHeight=n.lineHeight||this.fontMetrics.fontSize||n.fontSize}ensureCharacters(t){var e,r,s,i;const n=ya(t).filter((t=>!this._currentChars.includes(t))).filter(((t,e,r)=>r.indexOf(t)===e));if(!n.length)return;let o;this._currentChars=[...this._currentChars,...n],o=-1===this._currentPageIndex?this._nextPage():this.pages[this._currentPageIndex];let{canvas:a,context:l}=o.canvasAndContext,h=o.texture.source;const u=this._style;let c=this._currentX,d=this._currentY;const p=this.baseRenderedFontSize/this.baseMeasurementFontSize,f=this._padding*p,g="italic"===u.fontStyle?2:1;let m=0,_=!1;for(let t=0;t<n.length;t++){const o=n[t],x=$n.measureText(o,u,a,!1);x.lineHeight=x.height;const y=g*x.width*p,b=y+2*f,v=x.height*p+2*f;if(_=!1,"\n"!==o&&"\r"!==o&&"\t"!==o&&" "!==o&&(_=!0,m=Math.ceil(Math.max(v,m))),c+b>512&&(d+=m,m=v,c=0,d+m>512)){h.update();const t=this._nextPage();a=t.canvasAndContext.canvas,l=t.canvasAndContext.context,h=t.texture.source,d=0}const T=y/p-(null!=(r=null==(e=u.dropShadow)?void 0:e.distance)?r:0)-(null!=(i=null==(s=u._stroke)?void 0:s.width)?i:0);if(this.chars[o]={id:o.codePointAt(0),xOffset:-this._padding,yOffset:-this._padding,xAdvance:T,kerning:{}},_){this._drawGlyph(l,x,c+f,d+f,p,u);const t=h.width*p,e=h.height*p,r=new vt(c/t*h.width,d/e*h.height,b/t*h.width,v/e*h.height);this.chars[o].texture=new zr({source:h,frame:r}),c+=Math.ceil(b)}}h.update(),this._currentX=c,this._currentY=d,this._skipKerning&&this._applyKerning(n,l)}get pageTextures(){return this.pages}_applyKerning(t,e){const r=this._measureCache;for(let s=0;s<t.length;s++){const i=t[s];for(let t=0;t<this._currentChars.length;t++){const s=this._currentChars[t];let n=r[i];n||(n=r[i]=e.measureText(i).width);let o=r[s];o||(o=r[s]=e.measureText(s).width);let a=e.measureText(i+s).width,l=a-(n+o);l&&(this.chars[i].kerning[s]=l),a=e.measureText(i+s).width,l=a-(n+o),l&&(this.chars[s].kerning[i]=l)}}}_nextPage(){this._currentPageIndex++;const t=this.resolution,e=Mn.getOptimalCanvasAndContext(512,512,t);this._setupContext(e.context,this._style,t);const r=t*(this.baseRenderedFontSize/this.baseMeasurementFontSize),s={canvasAndContext:e,texture:new zr({source:new hs({resource:e.canvas,resolution:r,alphaMode:"premultiply-alpha-on-upload"})})};return this.pages[this._currentPageIndex]=s,s}_setupContext(t,e,r){var s;e.fontSize=this.baseRenderedFontSize,t.scale(r,r),t.font=jn(e),e.fontSize=this.baseMeasurementFontSize,t.textBaseline=e.textBaseline;const i=e._stroke,n=null!=(s=null==i?void 0:i.width)?s:0;if(i&&(t.lineWidth=n,t.lineJoin=i.join,t.miterLimit=i.miterLimit,t.strokeStyle=Qn(i,t)),e._fill&&(t.fillStyle=Qn(e._fill,t)),e.dropShadow){const s=e.dropShadow,i=Z.shared.setValue(s.color).toArray(),n=s.blur*r,o=s.distance*r;t.shadowColor=`rgba(${255*i[0]},${255*i[1]},${255*i[2]},${s.alpha})`,t.shadowBlur=n,t.shadowOffsetX=Math.cos(s.angle)*o,t.shadowOffsetY=Math.sin(s.angle)*o}else t.shadowColor="black",t.shadowBlur=0,t.shadowOffsetX=0,t.shadowOffsetY=0}_drawGlyph(t,e,r,s,i,n){var o;const a=e.text,l=e.fontProperties,h=n._stroke,u=(null!=(o=null==h?void 0:h.width)?o:0)*i,c=r+u/2,d=s-u/2,p=l.descent*i,f=e.lineHeight*i;n.stroke&&u&&t.strokeText(a,c,d+f-p),n._fill&&t.fillText(a,c,d+f-p)}destroy(){super.destroy();for(let t=0;t<this.pages.length;t++){const{canvasAndContext:e,texture:r}=this.pages[t];Mn.returnCanvasAndContext(e),r.destroy(!0)}this.pages=null}}function va(t,e,r){const s={width:0,height:0,offsetY:0,scale:e.fontSize/r.baseMeasurementFontSize,lines:[{width:0,charPositions:[],spaceWidth:0,spacesIndex:[],chars:[]}]};s.offsetY=r.baseLineOffset;let i=s.lines[0],n=null,o=!0;const a={spaceWord:!1,width:0,start:0,index:0,positions:[],chars:[]},l=t=>{const e=i.width;for(let r=0;r<a.index;r++){const s=t.positions[r];i.chars.push(t.chars[r]),i.charPositions.push(s+e)}i.width+=t.width,o=!1,a.width=0,a.index=0,a.chars.length=0},h=()=>{let t=i.chars.length-1,e=i.chars[t];for(;" "===e;)i.width-=r.chars[e].xAdvance,e=i.chars[--t];s.width=Math.max(s.width,i.width),i={width:0,charPositions:[],chars:[],spaceWidth:0,spacesIndex:[]},o=!0,s.lines.push(i),s.height+=r.lineHeight},u=r.baseMeasurementFontSize/e.fontSize,c=e.letterSpacing*u,d=e.wordWrapWidth*u;for(let s=0;s<t.length+1;s++){let u;const p=s===t.length;p||(u=t[s]);const f=r.chars[u]||r.chars[" "];if(/(?:\s)/.test(u)||"\r"===u||"\n"===u||p){if(!o&&e.wordWrap&&i.width+a.width-c>d?(h(),l(a),p||i.charPositions.push(0)):(a.start=i.width,l(a),p||i.charPositions.push(0)),"\r"===u||"\n"===u)0!==i.width&&h();else if(!p){const t=f.xAdvance+(f.kerning[n]||0)+c;i.width+=t,i.spaceWidth=t,i.spacesIndex.push(i.charPositions.length),i.chars.push(u)}}else{const t=f.kerning[n]||0,e=f.xAdvance+t+c;a.positions[a.index++]=a.width+t,a.chars.push(u),a.width+=e}n=u}return h(),"center"===e.align?function(t){for(let e=0;e<t.lines.length;e++){const r=t.lines[e],s=t.width/2-r.width/2;for(let t=0;t<r.charPositions.length;t++)r.charPositions[t]+=s}}(s):"right"===e.align?function(t){for(let e=0;e<t.lines.length;e++){const r=t.lines[e],s=t.width-r.width;for(let t=0;t<r.charPositions.length;t++)r.charPositions[t]+=s}}(s):"justify"===e.align&&function(t){const e=t.width;for(let r=0;r<t.lines.length;r++){const s=t.lines[r];let i=0,n=s.spacesIndex[i++],o=0;const a=s.spacesIndex.length,l=(e-s.width)/a;for(let t=0;t<s.charPositions.length;t++)t===n&&(n=s.spacesIndex[i++],o+=l),s.charPositions[t]+=o}}(s),s}var Ta=Object.defineProperty,Sa=Object.getOwnPropertySymbols,wa=Object.prototype.hasOwnProperty,Ea=Object.prototype.propertyIsEnumerable,Aa=(t,e,r)=>e in t?Ta(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r,Ma=(t,e)=>{for(var r in e||(e={}))wa.call(e,r)&&Aa(t,r,e[r]);if(Sa)for(var r of Sa(e))Ea.call(e,r)&&Aa(t,r,e[r]);return t};const Pa=new class{constructor(){this.ALPHA=[["a","z"],["A","Z"]," "],this.NUMERIC=[["0","9"]],this.ALPHANUMERIC=[["a","z"],["A","Z"],["0","9"]," "],this.ASCII=[[" ","~"]],this.defaultOptions={chars:this.ALPHANUMERIC,resolution:1,padding:4,skipKerning:!1}}getFont(t,e){var r;let s=`${e.fontFamily}-bitmap`,i=!0;if(e._fill.fill&&(s+=e._fill.fill.uid,i=!1),!Ts.has(s)){const t=new ba(Ma({style:e,overrideFill:i,overrideSize:!0},this.defaultOptions));t.once("destroy",(()=>Ts.remove(s))),Ts.set(s,t)}const n=Ts.get(s);return null==(r=n.ensureCharacters)||r.call(n,t),n}getLayout(t,e){const r=this.getFont(t,e);return va(t.split(""),e,r)}measureText(t,e){return this.getLayout(t,e)}install(...t){var e,r,s,i;let n=t[0];"string"==typeof n&&(n={name:n,style:t[1],chars:null==(e=t[2])?void 0:e.chars,resolution:null==(r=t[2])?void 0:r.resolution,padding:null==(s=t[2])?void 0:s.padding,skipKerning:null==(i=t[2])?void 0:i.skipKerning});const o=null==n?void 0:n.name;if(!o)throw new Error("[BitmapFontManager] Property `name` is required.");n=Ma(Ma({},this.defaultOptions),n);const a=n.style,l=a instanceof xa?a:new xa(a),h=null!==l._fill.fill&&void 0!==l._fill.fill,u=new ba({style:l,overrideFill:h,skipKerning:n.skipKerning,padding:n.padding,resolution:n.resolution,overrideSize:!1}),c=ya(n.chars);return u.ensureCharacters(c.join("")),Ts.set(`${o}-bitmap`,u),u.once("destroy",(()=>Ts.remove(`${o}-bitmap`))),u}uninstall(t){const e=`${t}-bitmap`,r=Ts.get(e);r&&(Ts.remove(e),r.destroy())}};class Ra extends to{constructor(t,e){var r;super();const{textures:s,data:i}=t;Object.keys(i.pages).forEach((t=>{const e=i.pages[parseInt(t,10)],r=s[e.id];this.pages.push({texture:r})})),Object.keys(i.chars).forEach((t=>{var e;const r=i.chars[t],n=s[r.page].source,o=new vt(r.x,r.y,r.width,r.height),a=new zr({source:n,frame:o});this.chars[t]={id:t.codePointAt(0),xOffset:r.xOffset,yOffset:r.yOffset,xAdvance:r.xAdvance,kerning:null!=(e=r.kerning)?e:{},texture:a}})),this.baseRenderedFontSize=i.fontSize,this.baseMeasurementFontSize=i.fontSize,this.fontMetrics={ascent:0,descent:0,fontSize:i.fontSize},this.baseLineOffset=i.baseLineOffset,this.lineHeight=i.lineHeight,this.fontFamily=i.fontFamily,this.distanceField=null!=(r=i.distanceField)?r:{type:"none",range:0},this.url=e}destroy(){super.destroy();for(let t=0;t<this.pages.length;t++){const{texture:e}=this.pages[t];e.destroy(!0)}this.pages=null}static install(t){Pa.install(t)}static uninstall(t){Pa.uninstall(t)}}const Oa={test:t=>"string"==typeof t&&t.startsWith("info face="),parse(t){var e,r,s;const i=t.match(/^[a-z]+\s+.+$/gm),n={info:[],common:[],page:[],char:[],chars:[],kerning:[],kernings:[],distanceField:[]};for(const t in i){const e=i[t].match(/^[a-z]+/gm)[0],r=i[t].match(/[a-zA-Z]+=([^\s"']+|"([^"]*)")/gm),s={};for(const t in r){const e=r[t].split("="),i=e[0],n=e[1].replace(/"/gm,""),o=parseFloat(n),a=isNaN(o)?n:o;s[i]=a}n[e].push(s)}const o={chars:{},pages:[],lineHeight:0,fontSize:0,fontFamily:"",distanceField:null,baseLineOffset:0},[a]=n.info,[l]=n.common,[h]=null!=(e=n.distanceField)?e:[];h&&(o.distanceField={range:parseInt(h.distanceRange,10),type:h.fieldType}),o.fontSize=parseInt(a.size,10),o.fontFamily=a.face,o.lineHeight=parseInt(l.lineHeight,10);const u=n.page;for(let t=0;t<u.length;t++)o.pages.push({id:parseInt(u[t].id,10)||0,file:u[t].file});const c={};o.baseLineOffset=o.lineHeight-parseInt(l.base,10);const d=n.char;for(let t=0;t<d.length;t++){const e=d[t],i=parseInt(e.id,10);let n=null!=(s=null!=(r=e.letter)?r:e.char)?s:String.fromCharCode(i);"space"===n&&(n=" "),c[i]=n,o.chars[n]={id:i,page:parseInt(e.page,10)||0,x:parseInt(e.x,10),y:parseInt(e.y,10),width:parseInt(e.width,10),height:parseInt(e.height,10),xOffset:parseInt(e.xoffset,10),yOffset:parseInt(e.yoffset,10),xAdvance:parseInt(e.xadvance,10),kerning:{}}}const p=n.kerning||[];for(let t=0;t<p.length;t++){const e=parseInt(p[t].first,10),r=parseInt(p[t].second,10),s=parseInt(p[t].amount,10);o.chars[c[r]].kerning[c[e]]=s}return o}},Ca={test(t){const e=t;return"string"!=typeof e&&"getElementsByTagName"in e&&e.getElementsByTagName("page").length&&null!==e.getElementsByTagName("info")[0].getAttribute("face")},parse(t){var e,r;const s={chars:{},pages:[],lineHeight:0,fontSize:0,fontFamily:"",distanceField:null,baseLineOffset:0},i=t.getElementsByTagName("info")[0],n=t.getElementsByTagName("common")[0],o=t.getElementsByTagName("distanceField")[0];o&&(s.distanceField={type:o.getAttribute("fieldType"),range:parseInt(o.getAttribute("distanceRange"),10)});const a=t.getElementsByTagName("page"),l=t.getElementsByTagName("char"),h=t.getElementsByTagName("kerning");s.fontSize=parseInt(i.getAttribute("size"),10),s.fontFamily=i.getAttribute("face"),s.lineHeight=parseInt(n.getAttribute("lineHeight"),10);for(let t=0;t<a.length;t++)s.pages.push({id:parseInt(a[t].getAttribute("id"),10)||0,file:a[t].getAttribute("file")});const u={};s.baseLineOffset=s.lineHeight-parseInt(n.getAttribute("base"),10);for(let t=0;t<l.length;t++){const i=l[t],n=parseInt(i.getAttribute("id"),10);let o=null!=(r=null!=(e=i.getAttribute("letter"))?e:i.getAttribute("char"))?r:String.fromCharCode(n);"space"===o&&(o=" "),u[n]=o,s.chars[o]={id:n,page:parseInt(i.getAttribute("page"),10)||0,x:parseInt(i.getAttribute("x"),10),y:parseInt(i.getAttribute("y"),10),width:parseInt(i.getAttribute("width"),10),height:parseInt(i.getAttribute("height"),10),xOffset:parseInt(i.getAttribute("xoffset"),10),yOffset:parseInt(i.getAttribute("yoffset"),10),xAdvance:parseInt(i.getAttribute("xadvance"),10),kerning:{}}}for(let t=0;t<h.length;t++){const e=parseInt(h[t].getAttribute("first"),10),r=parseInt(h[t].getAttribute("second"),10),i=parseInt(h[t].getAttribute("amount"),10);s.chars[u[r]].kerning[u[e]]=i}return s}},Ia={test:t=>!("string"!=typeof t||!t.includes("<font>"))&&Ca.test(Ne.get().parseXML(t)),parse:t=>Ca.parse(Ne.get().parseXML(t))},Ga=[".xml",".fnt"],ka={extension:u.CacheParser,test:t=>t instanceof Ra,getCacheableAssets(t,e){const r={};return t.forEach((t=>{r[t]=e})),r[`${e.fontFamily}-bitmap`]=e,r}},Ba={extension:{type:u.LoadParser,priority:Be.Normal},test:t=>Ga.includes(Xe.extname(t).toLowerCase()),testParse:async t=>Oa.test(t)||Ia.test(t),async parse(t,e,r){const s=Oa.test(t)?Oa.parse(t):Ia.parse(t),{src:i}=e,{pages:n}=s,o=[];for(let t=0;t<n.length;++t){const e=n[t].file;let r=Xe.join(Xe.dirname(i),e);r=rr(r,i),o.push(r)}const a=await r.load(o),l=o.map((t=>a[t]));return new Ra({data:s,textures:l},i)},load:async(t,e)=>await(await Ne.get().fetch(t)).text(),async unload(t,e,r){await Promise.all(t.pages.map((t=>r.unload(t.texture.source._sourceOrigin)))),t.destroy()}};var Da=Object.defineProperty,Fa=Object.getOwnPropertySymbols,Na=Object.prototype.hasOwnProperty,Ua=Object.prototype.propertyIsEnumerable,La=(t,e,r)=>e in t?Da(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r;class Xa extends jt{constructor(t){t instanceof aa&&(t={context:t});const e=t||{},{context:r,roundPixels:s}=e,i=((t,e)=>{var r={};for(var s in t)Na.call(t,s)&&e.indexOf(s)<0&&(r[s]=t[s]);if(null!=t&&Fa)for(var s of Fa(t))e.indexOf(s)<0&&Ua.call(t,s)&&(r[s]=t[s]);return r})(e,["context","roundPixels"]);super(((t,e)=>{for(var r in e||(e={}))Na.call(e,r)&&La(t,r,e[r]);if(Fa)for(var r of Fa(e))Ua.call(e,r)&&La(t,r,e[r]);return t})({label:"Graphics"},i)),this.canBundle=!0,this.renderPipeId="graphics",this._roundPixels=0,this._context=r||(this._ownedContext=new aa),this._context.on("update",this.onViewUpdate,this),this.allowChildren=!1,this.roundPixels=null!=s&&s}set context(t){t!==this._context&&(this._context.off("update",this.onViewUpdate,this),this._context=t,this._context.on("update",this.onViewUpdate,this),this.onViewUpdate())}get context(){return this._context}get bounds(){return this._context.bounds}addBounds(t){t.addBounds(this._context.bounds)}containsPoint(t){return this._context.containsPoint(t)}get roundPixels(){return!!this._roundPixels}set roundPixels(t){this._roundPixels=t?1:0}onViewUpdate(){this._didChangeId+=4096,this._didGraphicsUpdate=!0,!this.didViewUpdate&&(this.didViewUpdate=!0,this.renderGroup&&this.renderGroup.onChildViewUpdate(this))}destroy(t){this._ownedContext&&!t?this._ownedContext.destroy(t):(!0===t||!0===(null==t?void 0:t.context))&&this._context.destroy(t),this._ownedContext=null,this._context=null,super.destroy(t)}_callContextMethod(t,e){return this.context[t](...e),this}setFillStyle(...t){return this._callContextMethod("setFillStyle",t)}setStrokeStyle(...t){return this._callContextMethod("setStrokeStyle",t)}fill(...t){return this._callContextMethod("fill",t)}stroke(...t){return this._callContextMethod("stroke",t)}texture(...t){return this._callContextMethod("texture",t)}beginPath(){return this._callContextMethod("beginPath",[])}cut(){return this._callContextMethod("cut",[])}arc(...t){return this._callContextMethod("arc",t)}arcTo(...t){return this._callContextMethod("arcTo",t)}arcToSvg(...t){return this._callContextMethod("arcToSvg",t)}bezierCurveTo(...t){return this._callContextMethod("bezierCurveTo",t)}closePath(){return this._callContextMethod("closePath",[])}ellipse(...t){return this._callContextMethod("ellipse",t)}circle(...t){return this._callContextMethod("circle",t)}path(...t){return this._callContextMethod("path",t)}lineTo(...t){return this._callContextMethod("lineTo",t)}moveTo(...t){return this._callContextMethod("moveTo",t)}quadraticCurveTo(...t){return this._callContextMethod("quadraticCurveTo",t)}rect(...t){return this._callContextMethod("rect",t)}roundRect(...t){return this._callContextMethod("roundRect",t)}poly(...t){return this._callContextMethod("poly",t)}regularPoly(...t){return this._callContextMethod("regularPoly",t)}roundPoly(...t){return this._callContextMethod("roundPoly",t)}roundShape(...t){return this._callContextMethod("roundShape",t)}filletRect(...t){return this._callContextMethod("filletRect",t)}chamferRect(...t){return this._callContextMethod("chamferRect",t)}star(...t){return this._callContextMethod("star",t)}svg(...t){return this._callContextMethod("svg",t)}restore(...t){return this._callContextMethod("restore",t)}save(){return this._callContextMethod("save",[])}getTransform(){return this.context.getTransform()}resetTransform(){return this._callContextMethod("resetTransform",[])}rotateTransform(...t){return this._callContextMethod("rotate",t)}scaleTransform(...t){return this._callContextMethod("scale",t)}setTransform(...t){return this._callContextMethod("setTransform",t)}transform(...t){return this._callContextMethod("transform",t)}translateTransform(...t){return this._callContextMethod("translate",t)}clear(){return this._callContextMethod("clear",[])}get fillStyle(){return this._context.fillStyle}set fillStyle(t){this._context.fillStyle=t}get strokeStyle(){return this._context.strokeStyle}set strokeStyle(t){this._context.strokeStyle=t}clone(t=!1){return t?new Xa(this._context.clone()):(this._ownedContext=null,new Xa(this._context))}lineStyle(t,e,r){const s={};return t&&(s.width=t),e&&(s.color=e),r&&(s.alpha=r),this.context.strokeStyle=s,this}beginFill(t,e){const r={};return t&&(r.color=t),e&&(r.alpha=e),this.context.fillStyle=r,this}endFill(){this.context.fill();const t=this.context.strokeStyle;return(t.width!==aa.defaultStrokeStyle.width||t.color!==aa.defaultStrokeStyle.color||t.alpha!==aa.defaultStrokeStyle.alpha)&&this.context.stroke(),this}drawCircle(...t){return this._callContextMethod("circle",t)}drawEllipse(...t){return this._callContextMethod("ellipse",t)}drawPolygon(...t){return this._callContextMethod("poly",t)}drawRect(...t){return this._callContextMethod("rect",t)}drawRoundedRect(...t){return this._callContextMethod("roundRect",t)}drawStar(...t){return this._callContextMethod("star",t)}}let za,Ha;function ja(){return(!za||null!=za&&za.isContextLost())&&(za=Ne.get().createCanvas().getContext("webgl",{})),za}function Va(){if(!Ha){Ha="mediump";const t=ja();t&&t.getShaderPrecisionFormat&&(Ha=t.getShaderPrecisionFormat(t.FRAGMENT_SHADER,t.HIGH_FLOAT).precision?"highp":"mediump")}return Ha}function Wa(t,e,r){return e?t:r?`\n        \n        #ifdef GL_ES // This checks if it is WebGL1\n        #define in varying\n        #define finalColor gl_FragColor\n        #define texture texture2D\n        #endif\n        ${t=t.replace("out vec4 finalColor;","")}\n        `:`\n        \n        #ifdef GL_ES // This checks if it is WebGL1\n        #define in attribute\n        #define out varying\n        #endif\n        ${t}\n        `}function $a(t,e,r){const s=r?e.maxSupportedFragmentPrecision:e.maxSupportedVertexPrecision;if("precision"!==t.substring(0,9)){let i=r?e.requestedFragmentPrecision:e.requestedVertexPrecision;return"highp"===i&&"highp"!==s&&(i="mediump"),`precision ${i} float;\n${t}`}return"highp"!==s&&"precision highp"===t.substring(0,15)?t.replace("precision highp","precision mediump"):t}function Ya(t,e){return e?`#version 300 es\n${t}`:t}const qa={},Ka={};function Za(t,{name:e="pixi-program"},r=!0){e=e.replace(/\s+/g,"-");const s=r?qa:Ka;return s[e+=r?"-fragment":"-vertex"]?(s[e]++,e+=`-${s[e]}`):s[e]=1,-1!==t.indexOf("#define SHADER_NAME")?t:`#define SHADER_NAME ${e}\n${t}`}function Qa(t,e){return e?t.replace("#version 300 es",""):t}var Ja=Object.defineProperty,tl=Object.getOwnPropertySymbols,el=Object.prototype.hasOwnProperty,rl=Object.prototype.propertyIsEnumerable,sl=(t,e,r)=>e in t?Ja(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r,il=(t,e)=>{for(var r in e||(e={}))el.call(e,r)&&sl(t,r,e[r]);if(tl)for(var r of tl(e))rl.call(e,r)&&sl(t,r,e[r]);return t};const nl={stripVersion:Qa,ensurePrecision:$a,addProgramDefines:Wa,setProgramName:Za,insertVersion:Ya},ol=Object.create(null),al=class t{constructor(e){const r=-1!==(e=il(il({},t.defaultOptions),e)).fragment.indexOf("#version 300 es"),s={stripVersion:r,ensurePrecision:{requestedFragmentPrecision:e.preferredFragmentPrecision,requestedVertexPrecision:e.preferredVertexPrecision,maxSupportedVertexPrecision:"highp",maxSupportedFragmentPrecision:Va()},setProgramName:{name:e.name},addProgramDefines:r,insertVersion:r};let i=e.fragment,n=e.vertex;Object.keys(nl).forEach((t=>{const e=s[t];i=nl[t](i,e,!0),n=nl[t](n,e,!1)})),this.fragment=i,this.vertex=n,this._key=dn(`${this.vertex}:${this.fragment}`,"gl-program")}destroy(){this.fragment=null,this.vertex=null,this._attributeData=null,this._uniformData=null,this._uniformBlockData=null,this.transformFeedbackVaryings=null}static from(e){const r=`${e.vertex}:${e.fragment}`;return ol[r]||(ol[r]=new t(e)),ol[r]}};al.defaultOptions={preferredVertexPrecision:"highp",preferredFragmentPrecision:"mediump"};let ll=al;const hl={uint8x2:{size:2,stride:2,normalised:!1},uint8x4:{size:4,stride:4,normalised:!1},sint8x2:{size:2,stride:2,normalised:!1},sint8x4:{size:4,stride:4,normalised:!1},unorm8x2:{size:2,stride:2,normalised:!0},unorm8x4:{size:4,stride:4,normalised:!0},snorm8x2:{size:2,stride:2,normalised:!0},snorm8x4:{size:4,stride:4,normalised:!0},uint16x2:{size:2,stride:4,normalised:!1},uint16x4:{size:4,stride:8,normalised:!1},sint16x2:{size:2,stride:4,normalised:!1},sint16x4:{size:4,stride:8,normalised:!1},unorm16x2:{size:2,stride:4,normalised:!0},unorm16x4:{size:4,stride:8,normalised:!0},snorm16x2:{size:2,stride:4,normalised:!0},snorm16x4:{size:4,stride:8,normalised:!0},float16x2:{size:2,stride:4,normalised:!1},float16x4:{size:4,stride:8,normalised:!1},float32:{size:1,stride:4,normalised:!1},float32x2:{size:2,stride:8,normalised:!1},float32x3:{size:3,stride:12,normalised:!1},float32x4:{size:4,stride:16,normalised:!1},uint32:{size:1,stride:4,normalised:!1},uint32x2:{size:2,stride:8,normalised:!1},uint32x3:{size:3,stride:12,normalised:!1},uint32x4:{size:4,stride:16,normalised:!1},sint32:{size:1,stride:4,normalised:!1},sint32x2:{size:2,stride:8,normalised:!1},sint32x3:{size:3,stride:12,normalised:!1},sint32x4:{size:4,stride:16,normalised:!1}};function ul(t){var e;return null!=(e=hl[t])?e:hl.float32}const cl={f32:"float32","vec2<f32>":"float32x2","vec3<f32>":"float32x3","vec4<f32>":"float32x4",vec2f:"float32x2",vec3f:"float32x3",vec4f:"float32x4",i32:"sint32","vec2<i32>":"sint32x2","vec3<i32>":"sint32x3","vec4<i32>":"sint32x4",u32:"uint32","vec2<u32>":"uint32x2","vec3<u32>":"uint32x3","vec4<u32>":"uint32x4",bool:"uint32","vec2<bool>":"uint32x2","vec3<bool>":"uint32x3","vec4<bool>":"uint32x4"};function dl({source:t,entryPoint:e}){var r;const s={},i=t.indexOf(`fn ${e}`);if(-1!==i){const e=t.indexOf("->",i);if(-1!==e){const n=t.substring(i,e),o=/@location\((\d+)\)\s+([a-zA-Z0-9_]+)\s*:\s*([a-zA-Z0-9_<>]+)(?:,|\s|$)/g;let a;for(;null!==(a=o.exec(n));){const t=null!=(r=cl[a[3]])?r:"float32";s[a[2]]={location:parseInt(a[1],10),format:t,stride:ul(t).stride,offset:0,instance:!1,start:0}}}}return s}function pl(t){var e,r,s;const i=/@group\((\d+)\)/,n=/@binding\((\d+)\)/,o=/var(<[^>]+>)? (\w+)/,a=/:\s*(\w+)/,l=/(\w+)\s*:\s*([\w\<\>]+)/g,h=/struct\s+(\w+)/,u=null==(e=t.match(/(^|[^/])@(group|binding)\(\d+\)[^;]+;/g))?void 0:e.map((t=>({group:parseInt(t.match(i)[1],10),binding:parseInt(t.match(n)[1],10),name:t.match(o)[2],isUniform:"<uniform>"===t.match(o)[1],type:t.match(a)[1]})));if(!u)return{groups:[],structs:[]};const c=null!=(s=null==(r=t.match(/struct\s+(\w+)\s*{([^}]+)}/g))?void 0:r.map((t=>{const e=t.match(h)[1],r=t.match(l).reduce(((t,e)=>{const[r,s]=e.split(":");return t[r.trim()]=s.trim(),t}),{});return r?{name:e,members:r}:null})).filter((({name:t})=>u.some((e=>e.type===t)))))?s:[];return{groups:u,structs:c}}var fl=(t=>(t[t.VERTEX=1]="VERTEX",t[t.FRAGMENT=2]="FRAGMENT",t[t.COMPUTE=4]="COMPUTE",t))(fl||{});function gl({groups:t}){const e=[];for(let r=0;r<t.length;r++){const s=t[r];e[s.group]||(e[s.group]=[]),s.isUniform?e[s.group].push({binding:s.binding,visibility:fl.VERTEX|fl.FRAGMENT,buffer:{type:"uniform"}}):"sampler"===s.type?e[s.group].push({binding:s.binding,visibility:fl.FRAGMENT,sampler:{type:"filtering"}}):"texture_2d"===s.type&&e[s.group].push({binding:s.binding,visibility:fl.FRAGMENT,texture:{sampleType:"float",viewDimension:"2d",multisampled:!1}})}return e}function ml({groups:t}){const e=[];for(let r=0;r<t.length;r++){const s=t[r];e[s.group]||(e[s.group]={}),e[s.group][s.name]=s.binding}return e}function _l(t,e){const r=new Set,s=new Set;return{structs:[...t.structs,...e.structs].filter((t=>!r.has(t.name)&&(r.add(t.name),!0))),groups:[...t.groups,...e.groups].filter((t=>{const e=`${t.name}-${t.binding}`;return!s.has(e)&&(s.add(e),!0)}))}}const xl=Object.create(null);class yl{constructor(t){var e,r;this._layoutKey=0;const{fragment:s,vertex:i,layout:n,gpuLayout:o,name:a}=t;if(this.name=a,this.fragment=s,this.vertex=i,s.source===i.source){const t=pl(s.source);this.structsAndGroups=t}else{const t=pl(i.source),e=pl(s.source);this.structsAndGroups=_l(t,e)}this.layout=null!=n?n:ml(this.structsAndGroups),this.gpuLayout=null!=o?o:gl(this.structsAndGroups),this.autoAssignGlobalUniforms=void 0!==(null==(e=this.layout[0])?void 0:e.globalUniforms),this.autoAssignLocalUniforms=void 0!==(null==(r=this.layout[1])?void 0:r.localUniforms),this._generateProgramKey()}_generateProgramKey(){const{vertex:t,fragment:e}=this,r=t.source+e.source+t.entryPoint+e.entryPoint;this._layoutKey=dn(r,"program")}get attributeData(){return null!=this._attributeData||(this._attributeData=dl(this.vertex)),this._attributeData}destroy(){this.gpuLayout=null,this.layout=null,this.structsAndGroups=null,this.fragment=null,this.vertex=null}static from(t){const e=`${t.vertex.source}:${t.fragment.source}:${t.fragment.entryPoint}:${t.vertex.entryPoint}`;return xl[e]||(xl[e]=new yl(t)),xl[e]}}function bl(t,e,r){if(t)for(const s in t){const i=e[s.toLocaleLowerCase()];if(i){let e=t[s];"header"===s&&(e=e.replace(/@in\s+[^;]+;\s*/g,"").replace(/@out\s+[^;]+;\s*/g,"")),r&&i.push(`//----${r}----//`),i.push(e)}}}const vl=/\{\{(.*?)\}\}/g;function Tl(t){var e,r;const s={};return(null!=(r=null==(e=t.match(vl))?void 0:e.map((t=>t.replace(/[{()}]/g,""))))?r:[]).forEach((t=>{s[t]=[]})),s}function Sl(t,e){let r;const s=/@in\s+([^;]+);/g;for(;null!==(r=s.exec(t));)e.push(r[1])}function wl(t,e,r=!1){const s=[];Sl(e,s),t.forEach((t=>{t.header&&Sl(t.header,s)}));const i=s;r&&i.sort();const n=i.map(((t,e)=>`       @location(${e}) ${t},`)).join("\n");let o=e.replace(/@in\s+[^;]+;\s*/g,"");return o=o.replace("{{in}}",`\n${n}\n`),o}function El(t,e){let r;const s=/@out\s+([^;]+);/g;for(;null!==(r=s.exec(t));)e.push(r[1])}function Al(t,e){const r=[];El(e,r),t.forEach((t=>{t.header&&El(t.header,r)}));let s=0;const i=r.sort().map((t=>t.indexOf("builtin")>-1?t:`@location(${s++}) ${t}`)).join(",\n"),n=r.sort().map((t=>`       var ${function(t){return t.replace(/@.*?\s+/g,"")}(t)};`)).join("\n"),o=`return VSOutput(\n                ${r.sort().map((t=>` ${function(t){const e=/\b(\w+)\s*:/g.exec(t);return e?e[1]:""}(t)}`)).join(",\n")});`;let a=e.replace(/@out\s+[^;]+;\s*/g,"");return a=a.replace("{{struct}}",`\n${i}\n`),a=a.replace("{{start}}",`\n${n}\n`),a=a.replace("{{return}}",`\n${o}\n`),a}function Ml(t,e){let r=t;for(const t in e){const s=e[t];r=s.join("\n").length?r.replace(`{{${t}}}`,`//-----${t} START-----//\n${s.join("\n")}\n//----${t} FINISH----//`):r.replace(`{{${t}}}`,"")}return r}const Pl=Object.create(null),Rl=new Map;let Ol=0;function Cl({template:t,bits:e}){const r=Gl(t,e);if(Pl[r])return Pl[r];const{vertex:s,fragment:i}=function(t,e){const r=e.map((t=>t.vertex)).filter((t=>!!t)),s=e.map((t=>t.fragment)).filter((t=>!!t));let i=wl(r,t.vertex,!0);i=Al(r,i);const n=wl(s,t.fragment,!0);return{vertex:i,fragment:n}}(t,e);return Pl[r]=kl(s,i,e),Pl[r]}function Il({template:t,bits:e}){const r=Gl(t,e);return Pl[r]||(Pl[r]=kl(t.vertex,t.fragment,e)),Pl[r]}function Gl(t,e){return e.map((t=>(Rl.has(t)||Rl.set(t,Ol++),Rl.get(t)))).sort(((t,e)=>t-e)).join("-")+t.vertex+t.fragment}function kl(t,e,r){const s=Tl(t),i=Tl(e);return r.forEach((t=>{bl(t.vertex,s,t.name),bl(t.fragment,i,t.name)})),{vertex:Ml(t,s),fragment:Ml(e,i)}}const Bl="\n    @in aPosition: vec2<f32>;\n    @in aUV: vec2<f32>;\n\n    @out @builtin(position) vPosition: vec4<f32>;\n    @out vUV : vec2<f32>;\n    @out vColor : vec4<f32>;\n\n    {{header}}\n\n    struct VSOutput {\n        {{struct}}\n    };\n\n    @vertex\n    fn main( {{in}} ) -> VSOutput {\n\n        var worldTransformMatrix = globalUniforms.uWorldTransformMatrix;\n        var modelMatrix = mat3x3<f32>(\n            1.0, 0.0, 0.0,\n            0.0, 1.0, 0.0,\n            0.0, 0.0, 1.0\n          );\n        var position = aPosition;\n        var uv = aUV;\n\n        {{start}}\n        \n        vColor = vec4<f32>(1., 1., 1., 1.);\n\n        {{main}}\n\n        vUV = uv;\n\n        var modelViewProjectionMatrix = globalUniforms.uProjectionMatrix * worldTransformMatrix * modelMatrix;\n\n        vPosition =  vec4<f32>((modelViewProjectionMatrix *  vec3<f32>(position, 1.0)).xy, 0.0, 1.0);\n       \n        vColor *= globalUniforms.uWorldColorAlpha;\n\n        {{end}}\n\n        {{return}}\n    };\n",Dl="\n    @in vUV : vec2<f32>;\n    @in vColor : vec4<f32>;\n   \n    {{header}}\n\n    @fragment\n    fn main(\n        {{in}}\n      ) -> @location(0) vec4<f32> {\n        \n        {{start}}\n\n        var outColor:vec4<f32>;\n      \n        {{main}}\n        \n        return outColor * vColor;\n      };\n",Fl="\n    in vec2 aPosition;\n    in vec2 aUV;\n\n    out vec4 vColor;\n    out vec2 vUV;\n\n    {{header}}\n\n    void main(void){\n\n        mat3 worldTransformMatrix = uWorldTransformMatrix;\n        mat3 modelMatrix = mat3(\n            1.0, 0.0, 0.0,\n            0.0, 1.0, 0.0,\n            0.0, 0.0, 1.0\n          );\n        vec2 position = aPosition;\n        vec2 uv = aUV;\n        \n        {{start}}\n        \n        vColor = vec4(1.);\n        \n        {{main}}\n        \n        vUV = uv;\n        \n        mat3 modelViewProjectionMatrix = uProjectionMatrix * worldTransformMatrix * modelMatrix;\n\n        gl_Position = vec4((modelViewProjectionMatrix * vec3(position, 1.0)).xy, 0.0, 1.0);\n\n        vColor *= uWorldColorAlpha;\n\n        {{end}}\n    }\n",Nl="\n   \n    in vec4 vColor;\n    in vec2 vUV;\n\n    out vec4 finalColor;\n\n    {{header}}\n\n    void main(void) {\n        \n        {{start}}\n\n        vec4 outColor;\n      \n        {{main}}\n        \n        finalColor = outColor * vColor;\n    }\n",Ul={name:"global-uniforms-bit",vertex:{header:"\n        struct GlobalUniforms {\n            uProjectionMatrix:mat3x3<f32>,\n            uWorldTransformMatrix:mat3x3<f32>,\n            uWorldColorAlpha: vec4<f32>,\n            uResolution: vec2<f32>,\n        }\n\n        @group(0) @binding(0) var<uniform> globalUniforms : GlobalUniforms;\n        "}},Ll={name:"global-uniforms-ubo-bit",vertex:{header:"\n          uniform globalUniforms {\n            mat3 uProjectionMatrix;\n            mat3 uWorldTransformMatrix;\n            vec4 uWorldColorAlpha;\n            vec2 uResolution;\n          };\n        "}},Xl={name:"global-uniforms-bit",vertex:{header:"\n          uniform mat3 uProjectionMatrix;\n          uniform mat3 uWorldTransformMatrix;\n          uniform vec4 uWorldColorAlpha;\n          uniform vec2 uResolution;\n        "}};var zl=Object.defineProperty,Hl=Object.getOwnPropertySymbols,jl=Object.prototype.hasOwnProperty,Vl=Object.prototype.propertyIsEnumerable,Wl=(t,e,r)=>e in t?zl(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r;function $l({bits:t,name:e}){const r=Cl({template:{fragment:Dl,vertex:Bl},bits:[Ul,...t]});return yl.from({name:e,vertex:{source:r.vertex,entryPoint:"main"},fragment:{source:r.fragment,entryPoint:"main"}})}function Yl({bits:t,name:e}){return new ll(((t,e)=>{for(var r in e||(e={}))jl.call(e,r)&&Wl(t,r,e[r]);if(Hl)for(var r of Hl(e))Vl.call(e,r)&&Wl(t,r,e[r]);return t})({name:e},Il({template:{vertex:Fl,fragment:Nl},bits:[Xl,...t]})))}const ql={name:"color-bit",vertex:{header:"\n            @in aColor: vec4<f32>;\n        ",main:"\n            vColor *= vec4<f32>(aColor.rgb * aColor.a, aColor.a);\n        "}},Kl={name:"color-bit",vertex:{header:"\n            in vec4 aColor;\n        ",main:"\n            vColor *= vec4(aColor.rgb * aColor.a, aColor.a);\n        "}},Zl={};function Ql(t){const e=[];if(1===t)e.push("@group(1) @binding(0) var textureSource1: texture_2d<f32>;"),e.push("@group(1) @binding(1) var textureSampler1: sampler;");else{let r=0;for(let s=0;s<t;s++)e.push(`@group(1) @binding(${r++}) var textureSource${s+1}: texture_2d<f32>;`),e.push(`@group(1) @binding(${r++}) var textureSampler${s+1}: sampler;`)}return e.join("\n")}function Jl(t){const e=[];if(1===t)e.push("outColor = textureSampleGrad(textureSource1, textureSampler1, vUV, uvDx, uvDy);");else{e.push("switch vTextureId {");for(let r=0;r<t;r++)r===t-1?e.push("  default:{"):e.push(`  case ${r}:{`),e.push(`      outColor = textureSampleGrad(textureSource${r+1}, textureSampler${r+1}, vUV, uvDx, uvDy);`),e.push("      break;}");e.push("}")}return e.join("\n")}function th(t){return Zl[t]||(Zl[t]={name:"texture-batch-bit",vertex:{header:"\n                @in aTextureIdAndRound: vec2<u32>;\n                @out @interpolate(flat) vTextureId : u32;\n            ",main:"\n                vTextureId = aTextureIdAndRound.y;\n            ",end:"\n                if(aTextureIdAndRound.x == 1)\n                {\n                    vPosition = vec4<f32>(roundPixels(vPosition.xy, globalUniforms.uResolution), vPosition.zw);\n                }\n            "},fragment:{header:`\n                @in @interpolate(flat) vTextureId: u32;\n    \n                ${Ql(16)}\n            `,main:`\n                var uvDx = dpdx(vUV);\n                var uvDy = dpdy(vUV);\n    \n                ${Jl(16)}\n            `}}),Zl[t]}const eh={};function rh(t){const e=[];for(let r=0;r<t;r++)r>0&&e.push("else"),r<t-1&&e.push(`if(vTextureId < ${r}.5)`),e.push("{"),e.push(`\toutColor = texture(uTextures[${r}], vUV);`),e.push("}");return e.join("\n")}function sh(t){return eh[t]||(eh[t]={name:"texture-batch-bit",vertex:{header:"\n                in vec2 aTextureIdAndRound;\n                out float vTextureId;\n              \n            ",main:"\n                vTextureId = aTextureIdAndRound.y;\n            ",end:"\n                if(aTextureIdAndRound.x == 1.)\n                {\n                    gl_Position.xy = roundPixels(gl_Position.xy, uResolution);\n                }\n            "},fragment:{header:`\n                in float vTextureId;\n    \n                uniform sampler2D uTextures[${t}];\n              \n            `,main:`\n    \n                ${rh(16)}\n            `}}),eh[t]}const ih={name:"round-pixels-bit",vertex:{header:"\n            fn roundPixels(position: vec2<f32>, targetSize: vec2<f32>) -> vec2<f32> \n            {\n                return (floor(((position * 0.5 + 0.5) * targetSize) + 0.5) / targetSize) * 2.0 - 1.0;\n            }\n        "}},nh={name:"round-pixels-bit",vertex:{header:"   \n            vec2 roundPixels(vec2 position, vec2 targetSize)\n            {       \n                return (floor(((position * 0.5 + 0.5) * targetSize) + 0.5) / targetSize) * 2.0 - 1.0;\n            }\n        "}},oh=new Int32Array(Fs);for(let t=0;t<Fs;t++)oh[t]=t;const ah=new vn({uTextures:{value:oh,type:"i32",size:Fs}},{isStatic:!0});var lh=(t=>(t[t.WEBGL=1]="WEBGL",t[t.WEBGPU=2]="WEBGPU",t[t.BOTH=3]="BOTH",t))(lh||{}),hh=Object.defineProperty,uh=Object.getOwnPropertySymbols,ch=Object.prototype.hasOwnProperty,dh=Object.prototype.propertyIsEnumerable,ph=(t,e,r)=>e in t?hh(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r;class fh extends m{constructor(t){super(),this._uniformBindMap=Object.create(null),this._ownedBindGroups=[];let{gpuProgram:e,glProgram:r,groups:s,resources:i,compatibleRenderers:n,groupMap:o}=t;this.gpuProgram=e,this.glProgram=r,void 0===n&&(n=0,e&&(n|=lh.WEBGPU),r&&(n|=lh.WEBGL)),this.compatibleRenderers=n;const a={};if(!i&&!s&&(i={}),i&&s)throw new Error("[Shader] Cannot have both resources and groups");if(!e&&s&&!o)throw new Error("[Shader] No group map or WebGPU shader provided - consider using resources instead.");if(!e&&s&&o)for(const t in o)for(const e in o[t]){const r=o[t][e];a[r]={group:t,binding:e,name:r}}else if(e&&s&&!o){const t=e.structsAndGroups.groups;o={},t.forEach((t=>{o[t.group]=o[t.group]||{},o[t.group][t.binding]=t.name,a[t.name]=t}))}else if(i){if(e){const t=e.structsAndGroups.groups;o={},t.forEach((t=>{o[t.group]=o[t.group]||{},o[t.group][t.binding]=t.name,a[t.name]=t}))}else{o={},s={99:new Ds},this._ownedBindGroups.push(s[99]);let t=0;for(const e in i)a[e]={group:99,binding:t,name:e},o[99]=o[99]||{},o[99][t]=e,t++}s={};for(const t in i){const e=t;let r=i[t];!r.source&&!r._resourceType&&(r=new vn(r));const n=a[e];n&&(s[n.group]||(s[n.group]=new Ds,this._ownedBindGroups.push(s[n.group])),s[n.group].setResource(r,n.binding))}}this.groups=s,this._uniformBindMap=o,this.resources=this._buildResourceAccessor(s,a)}addResource(t,e,r){var s,i;(s=this._uniformBindMap)[e]||(s[e]={}),(i=this._uniformBindMap[e])[r]||(i[r]=t),this.groups[e]||(this.groups[e]=new Ds,this._ownedBindGroups.push(this.groups[e]))}_buildResourceAccessor(t,e){const r={};for(const s in e){const i=e[s];Object.defineProperty(r,i.name,{get:()=>t[i.group].getResource(i.binding),set(e){t[i.group].setResource(e,i.binding)}})}return r}destroy(t=!1){var e,r;this.emit("destroy",this),t&&(null==(e=this.gpuProgram)||e.destroy(),null==(r=this.glProgram)||r.destroy()),this.gpuProgram=null,this.glProgram=null,this.removeAllListeners(),this._uniformBindMap=null,this._ownedBindGroups.forEach((t=>{t.destroy()})),this._ownedBindGroups=null,this.resources=null,this.groups=null}static from(t){const e=t,{gpu:r,gl:s}=e,i=((t,e)=>{var r={};for(var s in t)ch.call(t,s)&&e.indexOf(s)<0&&(r[s]=t[s]);if(null!=t&&uh)for(var s of uh(t))e.indexOf(s)<0&&dh.call(t,s)&&(r[s]=t[s]);return r})(e,["gpu","gl"]);let n,o;return r&&(n=yl.from(r)),s&&(o=ll.from(s)),new fh(((t,e)=>{for(var r in e||(e={}))ch.call(e,r)&&ph(t,r,e[r]);if(uh)for(var r of uh(e))dh.call(e,r)&&ph(t,r,e[r]);return t})({gpuProgram:n,glProgram:o},i))}}const gh={name:"local-uniform-msdf-bit",vertex:{header:"\n            struct LocalUniforms {\n                uColor:vec4<f32>,\n                uTransformMatrix:mat3x3<f32>,\n                uDistance: f32,\n                uRound:f32,\n            }\n\n            @group(2) @binding(0) var<uniform> localUniforms : LocalUniforms;\n        ",main:"\n            vColor *= localUniforms.uColor;\n            modelMatrix *= localUniforms.uTransformMatrix;\n        ",end:"\n            if(localUniforms.uRound == 1)\n            {\n                vPosition = vec4(roundPixels(vPosition.xy, globalUniforms.uResolution), vPosition.zw);\n            }\n        "},fragment:{header:"\n            struct LocalUniforms {\n                uColor:vec4<f32>,\n                uTransformMatrix:mat3x3<f32>,\n                uDistance: f32\n            }\n\n            @group(2) @binding(0) var<uniform> localUniforms : LocalUniforms;\n         ",main:" \n            outColor = vColor * calculateMSDFAlpha(outColor, localUniforms.uDistance);\n        "}},mh={name:"local-uniform-msdf-bit",vertex:{header:"\n            uniform mat3 uTransformMatrix;\n            uniform vec4 uColor;\n            uniform float uRound;\n        ",main:"\n            vColor *= uColor;\n            modelMatrix *= uTransformMatrix;\n        ",end:"\n            if(uRound == 1.)\n            {\n                gl_Position.xy = roundPixels(gl_Position.xy, uResolution);\n            }\n        "},fragment:{header:"\n            uniform float uDistance;\n         ",main:" \n            outColor = vColor * calculateMSDFAlpha(outColor, uDistance);\n        "}},_h={name:"msdf-bit",fragment:{header:"\n            fn calculateMSDFAlpha(msdfColor:vec4<f32>, distance:f32) -> f32 {\n                \n                // MSDF\n                var median = msdfColor.r + msdfColor.g + msdfColor.b -\n                    min(msdfColor.r, min(msdfColor.g, msdfColor.b)) -\n                    max(msdfColor.r, max(msdfColor.g, msdfColor.b));\n            \n                // SDF\n                median = min(median, msdfColor.a);\n\n                var screenPxDistance = distance * (median - 0.5);\n                var alpha = clamp(screenPxDistance + 0.5, 0.0, 1.0);\n                if (median < 0.01) {\n                    alpha = 0.0;\n                } else if (median > 0.99) {\n                    alpha = 1.0;\n                }\n\n                return alpha;\n            }\n        "}},xh={name:"msdf-bit",fragment:{header:"\n            float calculateMSDFAlpha(vec4 msdfColor, float distance) {\n                \n                // MSDF\n                float median = msdfColor.r + msdfColor.g + msdfColor.b -\n                                min(msdfColor.r, min(msdfColor.g, msdfColor.b)) -\n                                max(msdfColor.r, max(msdfColor.g, msdfColor.b));\n               \n                // SDF\n                median = min(median, msdfColor.a);\n            \n                float screenPxDistance = distance * (median - 0.5);\n                float alpha = clamp(screenPxDistance + 0.5, 0.0, 1.0);\n           \n                if (median < 0.01) {\n                    alpha = 0.0;\n                } else if (median > 0.99) {\n                    alpha = 1.0;\n                }\n\n                return alpha;\n            }\n        "}};class yh extends fh{constructor(){const t=new vn({uColor:{value:new Float32Array([1,1,1,1]),type:"vec4<f32>"},uTransformMatrix:{value:new it,type:"mat3x3<f32>"},uDistance:{value:4,type:"f32"},uRound:{value:0,type:"f32"}}),e=$l({name:"sdf-shader",bits:[ql,th(Fs),gh,_h,ih]});super({glProgram:Yl({name:"sdf-shader",bits:[Kl,sh(Fs),mh,xh,nh]}),gpuProgram:e,resources:{localUniforms:t,batchSamplers:ah}})}}class bh{constructor(t){this._gpuBitmapText={},this._renderer=t}validateRenderable(t){const e=this._getGpuBitmapText(t);return t._didTextUpdate&&(t._didTextUpdate=!1,this._updateContext(t,e)),this._renderer.renderPipes.graphics.validateRenderable(e)}addRenderable(t,e){const r=this._getGpuBitmapText(t);vh(t,r),t._didTextUpdate&&(t._didTextUpdate=!1,this._updateContext(t,r)),this._renderer.renderPipes.graphics.addRenderable(r,e),r.context.customShader&&this._updateDistanceField(t)}destroyRenderable(t){this._destroyRenderableByUid(t.uid)}_destroyRenderableByUid(t){gt.return(this._gpuBitmapText[t]),this._gpuBitmapText[t]=null}updateRenderable(t){const e=this._getGpuBitmapText(t);vh(t,e),this._renderer.renderPipes.graphics.updateRenderable(e),e.context.customShader&&this._updateDistanceField(t)}_updateContext(t,e){var r;const{context:s}=e,i=Pa.getFont(t.text,t._style);s.clear(),"none"!==i.distanceField.type&&(s.customShader||(this._sdfShader||(this._sdfShader=new yh),s.customShader=this._sdfShader));const n=Array.from(t.text),o=t._style;let a=((null==(r=o._stroke)?void 0:r.width)||0)/2;a+=i.baseLineOffset;const l=va(n,o,i);let h=0;const u=o.padding,c=l.scale;s.translate(-t._anchor._x*l.width-u,-t._anchor._y*(l.height+l.offsetY)-u).scale(c,c);const d=o._fill.color;for(let t=0;t<l.lines.length;t++){const e=l.lines[t];for(let t=0;t<e.charPositions.length;t++){const r=n[h++],o=i.chars[r];null!=o&&o.texture&&s.texture(o.texture,d||"black",Math.round(e.charPositions[t]+o.xOffset),Math.round(a+o.yOffset))}a+=i.lineHeight}}_getGpuBitmapText(t){return this._gpuBitmapText[t.uid]||this.initGpuText(t)}initGpuText(t){const e=gt.get(Xa);return this._gpuBitmapText[t.uid]=e,this._updateContext(t,e),t.on("destroyed",(()=>{this.destroyRenderable(t)})),this._gpuBitmapText[t.uid]}_updateDistanceField(t){var e;const r=this._getGpuBitmapText(t).context,s=t._style.fontFamily,i=Ts.get(`${s}-bitmap`),{a:n,b:o,c:a,d:l}=t.groupTransform,h=Math.sqrt(n*n+o*o),u=Math.sqrt(a*a+l*l),c=(Math.abs(h)+Math.abs(u))/2,d=i.baseRenderedFontSize/t._style.fontSize,p=null!=(e=t.resolution)?e:this._renderer.resolution,f=c*i.distanceField.range*(1/d)*p;r.customShader.resources.localUniforms.uniforms.uDistance=f}destroy(){var t;for(const t in this._gpuBitmapText)this._destroyRenderableByUid(t);this._gpuBitmapText=null,null==(t=this._sdfShader)||t.destroy(!0),this._sdfShader=null,this._renderer=null}}function vh(t,e){e.groupTransform=t.groupTransform,e.groupColorAlpha=t.groupColorAlpha,e.groupColor=t.groupColor,e.groupBlendMode=t.groupBlendMode,e.globalDisplayStatus=t.globalDisplayStatus,e.groupTransform=t.groupTransform,e.localDisplayStatus=t.localDisplayStatus,e.groupAlpha=t.groupAlpha,e._roundPixels=t._roundPixels}bh.extension={type:[u.WebGLPipes,u.WebGPUPipes,u.CanvasPipes],name:"bitmapText"},p.add(bh,Ba,ka);class Th{constructor(t){this._gpuText=Object.create(null),this._renderer=t}validateRenderable(t){const e=this._getGpuText(t),r=t._getKey();return e.textureNeedsUploading?(e.textureNeedsUploading=!1,!0):e.currentKey!==r}addRenderable(t){const e=this._getGpuText(t).batchableSprite;t._didTextUpdate&&this._updateText(t),this._renderer.renderPipes.batch.addToBatch(e)}updateRenderable(t){const e=this._getGpuText(t).batchableSprite;t._didTextUpdate&&this._updateText(t),e.batcher.updateElement(e)}destroyRenderable(t){this._destroyRenderableById(t.uid)}_destroyRenderableById(t){const e=this._gpuText[t];this._renderer.htmlText.decreaseReferenceCount(e.currentKey),gt.return(e.batchableSprite),this._gpuText[t]=null}_updateText(t){const e=t._getKey(),r=this._getGpuText(t),s=r.batchableSprite;r.currentKey!==e&&this._updateGpuText(t).catch((t=>{console.error(t)})),t._didTextUpdate=!1;const i=t._style.padding;Yr(s.bounds,t._anchor,s.texture,i)}async _updateGpuText(t){var e;t._didTextUpdate=!1;const r=this._getGpuText(t);if(r.generatingTexture)return;const s=t._getKey();this._renderer.htmlText.decreaseReferenceCount(r.currentKey),r.generatingTexture=!0,r.currentKey=s;const i=null!=(e=t.resolution)?e:this._renderer.resolution,n=await this._renderer.htmlText.getManagedTexture(t.text,i,t._style,t._getKey()),o=r.batchableSprite;o.texture=r.texture=n,r.generatingTexture=!1,r.textureNeedsUploading=!0,t.onViewUpdate();const a=t._style.padding;Yr(o.bounds,t._anchor,o.texture,a)}_getGpuText(t){return this._gpuText[t.uid]||this.initGpuText(t)}initGpuText(t){const e={texture:zr.EMPTY,currentKey:"--",batchableSprite:gt.get(wn),textureNeedsUploading:!1,generatingTexture:!1},r=e.batchableSprite;return r.renderable=t,r.texture=zr.EMPTY,r.bounds={minX:0,maxX:1,minY:0,maxY:0},r.roundPixels=this._renderer._roundPixels|t._roundPixels,this._gpuText[t.uid]=e,t.on("destroyed",(()=>{this.destroyRenderable(t)})),e}destroy(){for(const t in this._gpuText)this._destroyRenderableById(t);this._gpuText=null,this._renderer=null}}function Sh(){const{userAgent:t}=Ne.get().getNavigator();return/^((?!chrome|android).)*safari/i.test(t)}Th.extension={type:[u.WebGLPipes,u.WebGPUPipes,u.CanvasPipes],name:"htmlText"};const wh="http://www.w3.org/2000/svg",Eh="http://www.w3.org/1999/xhtml";class Ah{constructor(){this.svgRoot=document.createElementNS(wh,"svg"),this.foreignObject=document.createElementNS(wh,"foreignObject"),this.domElement=document.createElementNS(Eh,"div"),this.styleElement=document.createElementNS(Eh,"style"),this.image=new Image;const{foreignObject:t,svgRoot:e,styleElement:r,domElement:s}=this;t.setAttribute("width","10000"),t.setAttribute("height","10000"),t.style.overflow="hidden",e.appendChild(t),t.appendChild(r),t.appendChild(s)}}function Mh(t){const e=t._stroke,r=t._fill,s=[`div { ${[`color: ${Z.shared.setValue(r.color).toHex()}`,`font-size: ${t.fontSize}px`,`font-family: ${t.fontFamily}`,`font-weight: ${t.fontWeight}`,`font-style: ${t.fontStyle}`,`font-variant: ${t.fontVariant}`,`letter-spacing: ${t.letterSpacing}px`,`text-align: ${t.align}`,`padding: ${t.padding}px`,`white-space: ${"pre"===t.whiteSpace&&t.wordWrap?"pre-wrap":t.whiteSpace}`,...t.lineHeight?[`line-height: ${t.lineHeight}px`]:[],...t.wordWrap?["word-wrap: "+(t.breakWords?"break-all":"break-word"),`max-width: ${t.wordWrapWidth}px`]:[],...e?[Rh(e)]:[],...t.dropShadow?[Ph(t.dropShadow)]:[],...t.cssOverrides].join(";")} }`];return function(t,e){for(const r in t){const s=t[r],i=[];for(const t in s)Ch[t]?i.push(Ch[t](s[t])):Oh[t]&&i.push(Oh[t].replace("{{VALUE}}",s[t]));e.push(`${r} { ${i.join(";")} }`)}}(t.tagStyles,s),s.join(" ")}function Ph(t){const e=Z.shared.setValue(t.color).setAlpha(t.alpha).toHexa(),r=`${Math.round(Math.cos(t.angle)*t.distance)}px ${Math.round(Math.sin(t.angle)*t.distance)}px`;return t.blur>0?`text-shadow: ${r} ${t.blur}px ${e}`:`text-shadow: ${r} ${e}`}function Rh(t){return[`-webkit-text-stroke-width: ${t.width}px`,`-webkit-text-stroke-color: ${Z.shared.setValue(t.color).toHex()}`,`text-stroke-width: ${t.width}px`,`text-stroke-color: ${Z.shared.setValue(t.color).toHex()}`,"paint-order: stroke"].join(";")}const Oh={fontSize:"font-size: {{VALUE}}px",fontFamily:"font-family: {{VALUE}}",fontWeight:"font-weight: {{VALUE}}",fontStyle:"font-style: {{VALUE}}",fontVariant:"font-variant: {{VALUE}}",letterSpacing:"letter-spacing: {{VALUE}}px",align:"text-align: {{VALUE}}",padding:"padding: {{VALUE}}px",whiteSpace:"white-space: {{VALUE}}",lineHeight:"line-height: {{VALUE}}px",wordWrapWidth:"max-width: {{VALUE}}px"},Ch={fill:t=>`color: ${Z.shared.setValue(t).toHex()}`,breakWords:t=>"word-wrap: "+(t?"break-all":"break-word"),stroke:Rh,dropShadow:Ph};class Ih extends xa{constructor(t={}){var e;super(t),this._cssOverrides=[],null!=this.cssOverrides||(this.cssOverrides=t.cssOverrides),this.tagStyles=null!=(e=t.tagStyles)?e:{}}set cssOverrides(t){this._cssOverrides=t instanceof Array?t:[t],this.update()}get cssOverrides(){return this._cssOverrides}_generateKey(){return this._styleKey=ha(this)+this._cssOverrides.join("-"),this._styleKey}update(){this._cssStyle=null,super.update()}clone(){return new Ih({align:this.align,breakWords:this.breakWords,dropShadow:this.dropShadow,fill:this._fill,fontFamily:this.fontFamily,fontSize:this.fontSize,fontStyle:this.fontStyle,fontVariant:this.fontVariant,fontWeight:this.fontWeight,letterSpacing:this.letterSpacing,lineHeight:this.lineHeight,padding:this.padding,stroke:this._stroke,whiteSpace:this.whiteSpace,wordWrap:this.wordWrap,wordWrapWidth:this.wordWrapWidth,cssOverrides:this.cssOverrides})}get cssStyle(){return this._cssStyle||(this._cssStyle=Mh(this)),this._cssStyle}addOverride(...t){const e=t.filter((t=>!this.cssOverrides.includes(t)));e.length>0&&(this.cssOverrides.push(...e),this.update())}removeOverride(...t){const e=t.filter((t=>this.cssOverrides.includes(t)));e.length>0&&(this.cssOverrides=this.cssOverrides.filter((t=>!e.includes(t))),this.update())}set fill(t){super.fill=t}set stroke(t){super.stroke=t}}function Gh(t,e){const r=e.fontFamily,s=[],i={},n=t.match(/font-family:([^;"\s]+)/g);function o(t){i[t]||(s.push(t),i[t]=!0)}if(Array.isArray(r))for(let t=0;t<r.length;t++)o(r[t]);else o(r);n&&n.forEach((t=>{o(t.split(":")[1].trim())}));for(const t in e.tagStyles){o(e.tagStyles[t].fontFamily)}return s}async function kh(t){const e=await(await Ne.get().fetch(t)).blob(),r=new FileReader;return await new Promise(((t,s)=>{r.onloadend=()=>t(r.result),r.onerror=s,r.readAsDataURL(e)}))}async function Bh(t,e){const r=await kh(e);return`@font-face {\n        font-family: "${t.fontFamily}";\n        src: url('${r}');\n        font-weight: ${t.fontWeight};\n        font-style: ${t.fontStyle};\n    }`}const Dh=new Map;async function Fh(t,e,r){const s=t.filter((t=>Ts.has(`${t}-and-url`))).map(((t,s)=>{if(!Dh.has(t)){const{url:i}=Ts.get(`${t}-and-url`);0===s?Dh.set(t,Bh(e,i)):Dh.set(t,Bh({fontWeight:r.fontWeight,fontStyle:r.fontStyle,fontFamily:t},i))}return Dh.get(t)}));return(await Promise.all(s)).join("\n")}function Nh(t,e,r,s,i){const{domElement:n,styleElement:o,svgRoot:a}=i;n.innerHTML=`<style>${e.cssStyle}</style><div>${t}</div>`,n.setAttribute("style",`transform: scale(${r});transform-origin: top left; display: inline-block`),o.textContent=s;const{width:l,height:h}=i.image;return a.setAttribute("width",l.toString()),a.setAttribute("height",h.toString()),(new XMLSerializer).serializeToString(a)}function Uh(t,e){const r=Mn.getOptimalCanvasAndContext(t.width,t.height,e),{context:s}=r;return s.clearRect(0,0,t.width,t.height),s.drawImage(t,0,0),Mn.returnCanvasAndContext(r),r.canvas}function Lh(t,e,r){return new Promise((async s=>{r&&await new Promise((t=>setTimeout(t,100))),t.onload=()=>{s()},t.src=`data:image/svg+xml;charset=utf8,${encodeURIComponent(e)}`,t.crossOrigin="anonymous"}))}let Xh;function zh(t,e,r,s){s=s||Xh||(Xh=new Ah);const{domElement:i,styleElement:n,svgRoot:o}=s;i.innerHTML=`<style>${e.cssStyle}</style><div>${t}</div>`,i.setAttribute("style","transform-origin: top left; display: inline-block"),r&&(n.textContent=r),document.body.appendChild(o);const a=i.getBoundingClientRect();o.remove();const l=$n.measureFont(e.fontStyle).descent;return{width:a.width,height:a.height+l}}class Hh{constructor(t){this._activeTextures={},this._renderer=t,this._createCanvas=t.type===lh.WEBGPU}getTexture(t){return this._buildTexturePromise(t.text,t.resolution,t.style)}getManagedTexture(t,e,r,s){if(this._activeTextures[s])return this._increaseReferenceCount(s),this._activeTextures[s].promise;const i=this._buildTexturePromise(t,e,r).then((t=>(this._activeTextures[s].texture=t,t)));return this._activeTextures[s]={texture:null,promise:i,usageCount:1},i}async _buildTexturePromise(t,e,r){const s=gt.get(Ah),i=Gh(t,r),n=await Fh(i,r,Ih.defaultTextStyle),o=zh(t,r,n,s),a=Math.ceil(Math.ceil(Math.max(1,o.width)+2*r.padding)*e),l=Math.ceil(Math.ceil(Math.max(1,o.height)+2*r.padding)*e),h=s.image;h.width=0|a,h.height=0|l;const u=Nh(t,r,e,n,s);await Lh(h,u,Sh()&&i.length>0);let c=h;this._createCanvas&&(c=Uh(h,e));const d=zn(c,h.width,h.height,e);return this._createCanvas&&this._renderer.texture.initSource(d.source),gt.return(s),d}_increaseReferenceCount(t){this._activeTextures[t].usageCount++}decreaseReferenceCount(t){const e=this._activeTextures[t];e&&(e.usageCount--,0===e.usageCount&&(e.texture?this._cleanUp(e):e.promise.then((t=>{e.texture=t,this._cleanUp(e)})).catch((()=>{})),this._activeTextures[t]=null))}_cleanUp(t){Fn.returnTexture(t.texture),t.texture.source.resource=null,t.texture.source.uploadMethodId="unknown"}getReferenceCount(t){return this._activeTextures[t].usageCount}destroy(){this._activeTextures=null}}Hh.extension={type:[u.WebGLSystem,u.WebGPUSystem,u.CanvasSystem],name:"htmlText"},Hh.defaultFontOptions={fontFamily:"Arial",fontStyle:"normal",fontWeight:"normal"},p.add(Hh),p.add(Th);var jh=Object.defineProperty,Vh=Object.getOwnPropertySymbols,Wh=Object.prototype.hasOwnProperty,$h=Object.prototype.propertyIsEnumerable,Yh=(t,e,r)=>e in t?jh(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r,qh=(t,e)=>{for(var r in e||(e={}))Wh.call(e,r)&&Yh(t,r,e[r]);if(Vh)for(var r of Vh(e))$h.call(e,r)&&Yh(t,r,e[r]);return t};const Kh=class t extends Is{constructor(...e){var r;let s=null!=(r=e[0])?r:{};s instanceof Float32Array&&(s={positions:s,uvs:e[1],indices:e[2]}),s=qh(qh({},t.defaultOptions),s);const i=s.positions||new Float32Array([0,0,1,0,1,1,0,1]),n=s.uvs||new Float32Array([0,0,1,0,1,1,0,1]),o=s.indices||new Uint32Array([0,1,2,0,2,3]),a=s.shrinkBuffersToFit;super({attributes:{aPosition:{buffer:new Ps({data:i,label:"attribute-mesh-positions",shrinkToFit:a,usage:Ms.VERTEX|Ms.COPY_DST}),format:"float32x2",stride:8,offset:0},aUV:{buffer:new Ps({data:n,label:"attribute-mesh-uvs",shrinkToFit:a,usage:Ms.VERTEX|Ms.COPY_DST}),format:"float32x2",stride:8,offset:0}},indexBuffer:new Ps({data:o,label:"index-mesh-buffer",shrinkToFit:a,usage:Ms.INDEX|Ms.COPY_DST}),topology:s.topology}),this.batchMode="auto"}get positions(){return this.attributes.aPosition.buffer.data}set positions(t){this.attributes.aPosition.buffer.data=t}get uvs(){return this.attributes.aUV.buffer.data}set uvs(t){this.attributes.aUV.buffer.data=t}get indices(){return this.indexBuffer.data}set indices(t){this.indexBuffer.data=t}};Kh.defaultOptions={topology:"triangle-list",shrinkBuffersToFit:!1};let Zh=Kh;var Qh=Object.defineProperty,Jh=Object.defineProperties,tu=Object.getOwnPropertyDescriptors,eu=Object.getOwnPropertySymbols,ru=Object.prototype.hasOwnProperty,su=Object.prototype.propertyIsEnumerable,iu=(t,e,r)=>e in t?Qh(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r,nu=(t,e)=>{for(var r in e||(e={}))ru.call(e,r)&&iu(t,r,e[r]);if(eu)for(var r of eu(e))su.call(e,r)&&iu(t,r,e[r]);return t},ou=(t,e)=>Jh(t,tu(e));const au={name:"local-uniform-bit",vertex:{header:"\n\n            struct LocalUniforms {\n                uTransformMatrix:mat3x3<f32>,\n                uColor:vec4<f32>,\n                uRound:f32,\n            }\n\n            @group(1) @binding(0) var<uniform> localUniforms : LocalUniforms;\n        ",main:"\n            vColor *= localUniforms.uColor;\n            modelMatrix *= localUniforms.uTransformMatrix;\n        ",end:"\n            if(localUniforms.uRound == 1)\n            {\n                vPosition = vec4(roundPixels(vPosition.xy, globalUniforms.uResolution), vPosition.zw);\n            }\n        "}},lu=ou(nu({},au),{vertex:ou(nu({},au.vertex),{header:au.vertex.header.replace("group(1)","group(2)")})}),hu={name:"local-uniform-bit",vertex:{header:"\n\n            uniform mat3 uTransformMatrix;\n            uniform vec4 uColor;\n            uniform float uRound;\n        ",main:"\n            vColor *= uColor;\n            modelMatrix = uTransformMatrix;\n        ",end:"\n            if(uRound == 1.)\n            {\n                gl_Position.xy = roundPixels(gl_Position.xy, uResolution);\n            }\n        "}},uu={name:"tiling-bit",vertex:{header:"\n            struct TilingUniforms {\n                uMapCoord:mat3x3<f32>,\n                uClampFrame:vec4<f32>,\n                uClampOffset:vec2<f32>,\n                uTextureTransform:mat3x3<f32>,\n                uSizeAnchor:vec4<f32>\n            };\n\n            @group(2) @binding(0) var<uniform> tilingUniforms: TilingUniforms;\n            @group(2) @binding(1) var uTexture: texture_2d<f32>;\n            @group(2) @binding(2) var uSampler: sampler;\n        ",main:"\n            uv = (tilingUniforms.uTextureTransform * vec3(uv, 1.0)).xy;\n\n            position = (position - tilingUniforms.uSizeAnchor.zw) * tilingUniforms.uSizeAnchor.xy;\n        "},fragment:{header:"\n            struct TilingUniforms {\n                uMapCoord:mat3x3<f32>,\n                uClampFrame:vec4<f32>,\n                uClampOffset:vec2<f32>,\n                uTextureTransform:mat3x3<f32>,\n                uSizeAnchor:vec4<f32>\n            };\n\n            @group(2) @binding(0) var<uniform> tilingUniforms: TilingUniforms;\n            @group(2) @binding(1) var uTexture: texture_2d<f32>;\n            @group(2) @binding(2) var uSampler: sampler;\n        ",main:"\n\n            var coord = vUV + ceil(tilingUniforms.uClampOffset - vUV);\n            coord = (tilingUniforms.uMapCoord * vec3(coord, 1.0)).xy;\n            var unclamped = coord;\n            coord = clamp(coord, tilingUniforms.uClampFrame.xy, tilingUniforms.uClampFrame.zw);\n\n            var bias = 0.;\n\n            if(unclamped.x == coord.x && unclamped.y == coord.y)\n            {\n                bias = -32.;\n            } \n\n            outColor = textureSampleBias(uTexture, uSampler, coord, bias);\n        "}},cu={name:"tiling-bit",vertex:{header:"\n            uniform mat3 uTextureTransform;\n            uniform vec4 uSizeAnchor;\n        \n        ",main:"\n            uv = (uTextureTransform * vec3(aUV, 1.0)).xy;\n\n            position = (position - uSizeAnchor.zw) * uSizeAnchor.xy;\n        "},fragment:{header:"\n            uniform sampler2D uTexture;\n            uniform mat3 uMapCoord;\n            uniform vec4 uClampFrame;\n            uniform vec2 uClampOffset;\n        ",main:"\n\n        vec2 coord = vUV + ceil(uClampOffset - vUV);\n        coord = (uMapCoord * vec3(coord, 1.0)).xy;\n        vec2 unclamped = coord;\n        coord = clamp(coord, uClampFrame.xy, uClampFrame.zw);\n        \n        outColor = texture(uTexture, coord, unclamped == coord ? 0.0 : -32.0);// lod-bias very negative to force lod 0\n    \n        "}};let du,pu;class fu extends fh{constructor(){null!=du||(du=$l({name:"tiling-sprite-shader",bits:[au,uu,ih]})),null!=pu||(pu=Yl({name:"tiling-sprite-shader",bits:[hu,cu,nh]}));const t=new vn({uMapCoord:{value:new it,type:"mat3x3<f32>"},uClampFrame:{value:new Float32Array([0,0,1,1]),type:"vec4<f32>"},uClampOffset:{value:new Float32Array([0,0]),type:"vec2<f32>"},uTextureTransform:{value:new it,type:"mat3x3<f32>"},uSizeAnchor:{value:new Float32Array([100,100,.5,.5]),type:"vec4<f32>"}});super({glProgram:pu,gpuProgram:du,resources:{localUniforms:new vn({uTransformMatrix:{value:new it,type:"mat3x3<f32>"},uColor:{value:new Float32Array([1,1,1,1]),type:"vec4<f32>"},uRound:{value:0,type:"f32"}}),tilingUniforms:t,uTexture:zr.EMPTY.source,uSampler:zr.EMPTY.source.style}})}updateUniforms(t,e,r,s,i,n){const o=this.resources.tilingUniforms,a=n.width,l=n.height,h=n.textureMatrix,u=o.uniforms.uTextureTransform;u.set(r.a*a/t,r.b*a/e,r.c*l/t,r.d*l/e,r.tx/t,r.ty/e),u.invert(),o.uniforms.uMapCoord=h.mapCoord,o.uniforms.uClampFrame=h.uClampFrame,o.uniforms.uClampOffset=h.uClampOffset,o.uniforms.uTextureTransform=u,o.uniforms.uSizeAnchor[0]=t,o.uniforms.uSizeAnchor[1]=e,o.uniforms.uSizeAnchor[2]=s,o.uniforms.uSizeAnchor[3]=i,n&&(this.resources.uTexture=n.source,this.resources.uSampler=n.source.style)}}class gu extends Zh{constructor(){super({positions:new Float32Array([0,0,1,0,1,1,0,1]),uvs:new Float32Array([0,0,1,0,1,1,0,1]),indices:new Uint32Array([0,1,2,0,2,3])})}}function mu(t,e){const r=t.anchor.x,s=t.anchor.y;e[0]=-r*t.width,e[1]=-s*t.height,e[2]=(1-r)*t.width,e[3]=-s*t.height,e[4]=(1-r)*t.width,e[5]=(1-s)*t.height,e[6]=-r*t.width,e[7]=(1-s)*t.height}function _u(t,e,r,s){let i=0;const n=t.length/(e||2),o=s.a,a=s.b,l=s.c,h=s.d,u=s.tx,c=s.ty;for(r*=e;i<n;){const s=t[r],n=t[r+1];t[r]=o*s+l*n+u,t[r+1]=a*s+h*n+c,r+=e,i++}}function xu(t,e){const r=t.texture,s=r.frame.width,i=r.frame.height;let n=0,o=0;t._applyAnchorToTexture&&(n=t.anchor.x,o=t.anchor.y),e[0]=e[6]=-n,e[2]=e[4]=1-n,e[1]=e[3]=-o,e[5]=e[7]=1-o;const a=it.shared;a.copyFrom(t._tileTransform.matrix),a.tx/=t.width,a.ty/=t.height,a.invert(),a.scale(t.width/s,t.height/i),_u(e,2,0,a)}const yu=new gu;class bu{constructor(t){this._tilingSpriteDataHash=Object.create(null),this._renderer=t}validateRenderable(t){const e=this._getTilingSpriteData(t),r=e.canBatch;this._updateCanBatch(t);const s=e.canBatch;if(s&&s===r){const{batchableMesh:r}=e;if(r.texture._source!==t.texture._source)return!r.batcher.checkAndUpdateTexture(r,t.texture)}return r!==s}addRenderable(t,e){const r=this._renderer.renderPipes.batch;this._updateCanBatch(t);const s=this._getTilingSpriteData(t),{geometry:i,canBatch:n}=s;if(n){s.batchableMesh||(s.batchableMesh=new Tn);const e=s.batchableMesh;t._didTilingSpriteUpdate&&(t._didTilingSpriteUpdate=!1,this._updateBatchableMesh(t),e.geometry=i,e.mesh=t,e.texture=t._texture),e.roundPixels=this._renderer._roundPixels|t._roundPixels,r.addToBatch(e)}else r.break(e),s.shader||(s.shader=new fu),this.updateRenderable(t),e.add(t)}execute(t){const{shader:e}=this._tilingSpriteDataHash[t.uid];e.groups[0]=this._renderer.globalUniforms.bindGroup;const r=e.resources.localUniforms.uniforms;r.uTransformMatrix=t.groupTransform,r.uRound=this._renderer._roundPixels|t._roundPixels,ln(t.groupColorAlpha,r.uColor,0),this._renderer.encoder.draw({geometry:yu,shader:e,state:an.default2d})}updateRenderable(t){const e=this._getTilingSpriteData(t),{canBatch:r}=e;if(r){const{batchableMesh:r}=e;t._didTilingSpriteUpdate&&this._updateBatchableMesh(t),r.batcher.updateElement(r)}else if(t._didTilingSpriteUpdate){const{shader:r}=e;r.updateUniforms(t.width,t.height,t._tileTransform.matrix,t.anchor.x,t.anchor.y,t.texture)}t._didTilingSpriteUpdate=!1}destroyRenderable(t){var e;const r=this._getTilingSpriteData(t);r.batchableMesh=null,null==(e=r.shader)||e.destroy(),this._tilingSpriteDataHash[t.uid]=null}_getTilingSpriteData(t){return this._tilingSpriteDataHash[t.uid]||this._initTilingSpriteData(t)}_initTilingSpriteData(t){const e=new Zh({indices:yu.indices,positions:yu.positions.slice(),uvs:yu.uvs.slice()});return this._tilingSpriteDataHash[t.uid]={canBatch:!0,renderable:t,geometry:e},t.on("destroyed",(()=>{this.destroyRenderable(t)})),this._tilingSpriteDataHash[t.uid]}_updateBatchableMesh(t){const e=this._getTilingSpriteData(t),{geometry:r}=e,s=t.texture.source.style;"repeat"!==s.addressMode&&(s.addressMode="repeat",s.update()),xu(t,r.uvs),mu(t,r.positions)}destroy(){for(const t in this._tilingSpriteDataHash)this.destroyRenderable(this._tilingSpriteDataHash[t].renderable);this._tilingSpriteDataHash=null,this._renderer=null}_updateCanBatch(t){const e=this._getTilingSpriteData(t),r=t.texture;let s=!0;return this._renderer.type===lh.WEBGL&&(s=this._renderer.context.supports.nonPowOf2wrapping),e.canBatch=r.textureMatrix.isSimple&&(s||r.source.isPowerOfTwo),e.canBatch}}bu.extension={type:[u.WebGLPipes,u.WebGPUPipes,u.CanvasPipes],name:"tilingSprite"},p.add(bu);var vu=Object.defineProperty,Tu=Object.getOwnPropertySymbols,Su=Object.prototype.hasOwnProperty,wu=Object.prototype.propertyIsEnumerable,Eu=(t,e,r)=>e in t?vu(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r,Au=(t,e)=>{for(var r in e||(e={}))Su.call(e,r)&&Eu(t,r,e[r]);if(Tu)for(var r of Tu(e))wu.call(e,r)&&Eu(t,r,e[r]);return t};const Mu=class t extends Zh{constructor(...t){var e;super({});let r=null!=(e=t[0])?e:{};"number"==typeof r&&(r={width:r,height:t[1],verticesX:t[2],verticesY:t[3]}),this.build(r)}build(e){var r,s,i,n;e=Au(Au({},t.defaultOptions),e),this.verticesX=null!=(r=this.verticesX)?r:e.verticesX,this.verticesY=null!=(s=this.verticesY)?s:e.verticesY,this.width=null!=(i=this.width)?i:e.width,this.height=null!=(n=this.height)?n:e.height;const o=this.verticesX*this.verticesY,a=[],l=[],h=[],u=this.verticesX-1,c=this.verticesY-1,d=this.width/u,p=this.height/c;for(let t=0;t<o;t++){const e=t%this.verticesX,r=t/this.verticesX|0;a.push(e*d,r*p),l.push(e/u,r/c)}const f=u*c;for(let t=0;t<f;t++){const e=t%u,r=t/u|0,s=r*this.verticesX+e,i=r*this.verticesX+e+1,n=(r+1)*this.verticesX+e,o=(r+1)*this.verticesX+e+1;h.push(s,i,n,i,o,n)}this.buffers[0].data=new Float32Array(a),this.buffers[1].data=new Float32Array(l),this.indexBuffer.data=new Uint32Array(h),this.buffers[0].update(),this.buffers[1].update(),this.indexBuffer.update()}};Mu.defaultOptions={width:100,height:100,verticesX:10,verticesY:10};let Pu=Mu;var Ru=Object.defineProperty,Ou=Object.getOwnPropertySymbols,Cu=Object.prototype.hasOwnProperty,Iu=Object.prototype.propertyIsEnumerable,Gu=(t,e,r)=>e in t?Ru(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r,ku=(t,e)=>{for(var r in e||(e={}))Cu.call(e,r)&&Gu(t,r,e[r]);if(Ou)for(var r of Ou(e))Iu.call(e,r)&&Gu(t,r,e[r]);return t};const Bu=class t extends Pu{constructor(e={}){super({width:(e=ku(ku({},t.defaultOptions),e)).width,height:e.height,verticesX:4,verticesY:4}),this.update(e)}update(t){var e,r,s,i,n,o,a,l;this.width=null!=(e=t.width)?e:this.width,this.height=null!=(r=t.height)?r:this.height,this._originalWidth=null!=(s=t.originalWidth)?s:this._originalWidth,this._originalHeight=null!=(i=t.originalHeight)?i:this._originalHeight,this._leftWidth=null!=(n=t.leftWidth)?n:this._leftWidth,this._rightWidth=null!=(o=t.rightWidth)?o:this._rightWidth,this._topHeight=null!=(a=t.topHeight)?a:this._topHeight,this._bottomHeight=null!=(l=t.bottomHeight)?l:this._bottomHeight,this.updateUvs(),this.updatePositions()}updatePositions(){const t=this.positions,e=this._leftWidth+this._rightWidth,r=this.width>e?1:this.width/e,s=this._topHeight+this._bottomHeight,i=this.height>s?1:this.height/s,n=Math.min(r,i);t[9]=t[11]=t[13]=t[15]=this._topHeight*n,t[17]=t[19]=t[21]=t[23]=this.height-this._bottomHeight*n,t[25]=t[27]=t[29]=t[31]=this.height,t[2]=t[10]=t[18]=t[26]=this._leftWidth*n,t[4]=t[12]=t[20]=t[28]=this.width-this._rightWidth*n,t[6]=t[14]=t[22]=t[30]=this.width,this.getBuffer("aPosition").update()}updateUvs(){const t=this.uvs;t[0]=t[8]=t[16]=t[24]=0,t[1]=t[3]=t[5]=t[7]=0,t[6]=t[14]=t[22]=t[30]=1,t[25]=t[27]=t[29]=t[31]=1;const e=1/this._originalWidth,r=1/this._originalHeight;t[2]=t[10]=t[18]=t[26]=e*this._leftWidth,t[9]=t[11]=t[13]=t[15]=r*this._topHeight,t[4]=t[12]=t[20]=t[28]=1-e*this._rightWidth,t[17]=t[19]=t[21]=t[23]=1-r*this._bottomHeight,this.getBuffer("aUV").update()}};Bu.defaultOptions={width:100,height:100,leftWidth:10,topHeight:10,rightWidth:10,bottomHeight:10,originalWidth:100,originalHeight:100};let Du=Bu;class Fu{constructor(t){this._gpuSpriteHash=Object.create(null),this._renderer=t}addRenderable(t,e){const r=this._getGpuSprite(t);t._didSpriteUpdate&&this._updateBatchableSprite(t,r),this._renderer.renderPipes.batch.addToBatch(r)}updateRenderable(t){const e=this._gpuSpriteHash[t.uid];t._didSpriteUpdate&&this._updateBatchableSprite(t,e),e.batcher.updateElement(e)}validateRenderable(t){const e=t._texture,r=this._getGpuSprite(t);return r.texture._source!==e._source&&!r.batcher.checkAndUpdateTexture(r,e)}destroyRenderable(t){const e=this._gpuSpriteHash[t.uid];gt.return(e),this._gpuSpriteHash[t.uid]=null}_updateBatchableSprite(t,e){t._didSpriteUpdate=!1,e.geometry.update(t),e.texture=t._texture}_getGpuSprite(t){return this._gpuSpriteHash[t.uid]||this._initGPUSprite(t)}_initGPUSprite(t){const e=new Tn;return e.geometry=new Du,e.mesh=t,e.texture=t._texture,e.roundPixels=this._renderer._roundPixels|t._roundPixels,this._gpuSpriteHash[t.uid]=e,t.on("destroyed",(()=>{this.destroyRenderable(t)})),e}destroy(){for(const t in this._gpuSpriteHash)this._gpuSpriteHash[t].geometry.destroy();this._gpuSpriteHash=null,this._renderer=null}}Fu.extension={type:[u.WebGLPipes,u.WebGPUPipes,u.CanvasPipes],name:"nineSliceSprite"},p.add(Fu);class Nu{constructor(t){this._renderer=t}push(t,e,r){this._renderer.renderPipes.batch.break(r),r.add({renderPipeId:"filter",canBundle:!1,action:"pushFilter",container:e,filterEffect:t})}pop(t,e,r){this._renderer.renderPipes.batch.break(r),r.add({renderPipeId:"filter",action:"popFilter",canBundle:!1})}execute(t){"pushFilter"===t.action?this._renderer.filter.push(t):"popFilter"===t.action&&this._renderer.filter.pop()}destroy(){this._renderer=null}}Nu.extension={type:[u.WebGLPipes,u.WebGPUPipes,u.CanvasPipes],name:"filter"};const Uu=new it;function Lu(t,e){return e.clear(),Xu(t,e),e.isValid||e.set(0,0,0,0),t.isRenderGroupRoot?e.applyMatrix(t.renderGroup.localTransform):e.applyMatrix(t.renderGroup.worldTransform),e}function Xu(t,e){if(7!==t.localDisplayStatus||!t.measurable)return;const r=!!t.effects.length;let s=e;if((t.isRenderGroupRoot||r)&&(s=Et.get().clear()),t.boundsArea)e.addRect(t.boundsArea,t.worldTransform);else{if(t.renderPipeId){const e=t.bounds;s.addFrame(e.minX,e.minY,e.maxX,e.maxY,t.groupTransform)}const e=t.children;for(let t=0;t<e.length;t++)Xu(e[t],s)}if(r){let r=!1;for(let e=0;e<t.effects.length;e++)t.effects[e].addBounds&&(r||(r=!0,s.applyMatrix(t.renderGroup.worldTransform)),t.effects[e].addBounds(s,!0));r&&(s.applyMatrix(t.renderGroup.worldTransform.copyTo(Uu).invert()),e.addBounds(s,t.relativeGroupTransform)),e.addBounds(s),Et.return(s)}else t.isRenderGroupRoot&&(e.addBounds(s,t.relativeGroupTransform),Et.return(s))}function zu(t,e){e.clear();const r=e.matrix;for(let r=0;r<t.length;r++){const s=t[r];s.globalDisplayStatus<7||(e.matrix=s.worldTransform,s.addBounds(e))}return e.matrix=r,e}const Hu=new Is({attributes:{aPosition:{buffer:new Float32Array([0,0,1,0,1,1,0,1]),location:0,format:"float32x2",stride:8,offset:0}},indexBuffer:new Uint32Array([0,1,2,0,2,3])});class ju{constructor(t){this._filterStackIndex=0,this._filterStack=[],this._filterGlobalUniforms=new vn({uInputSize:{value:new Float32Array(4),type:"vec4<f32>"},uInputPixel:{value:new Float32Array(4),type:"vec4<f32>"},uInputClamp:{value:new Float32Array(4),type:"vec4<f32>"},uOutputFrame:{value:new Float32Array(4),type:"vec4<f32>"},uGlobalFrame:{value:new Float32Array(4),type:"vec4<f32>"},uOutputTexture:{value:new Float32Array(4),type:"vec4<f32>"}}),this._globalFilterBindGroup=new Ds({}),this.renderer=t}get activeBackTexture(){var t;return null==(t=this._activeFilterData)?void 0:t.backTexture}push(t){var e,r;const s=this.renderer,i=t.filterEffect.filters;this._filterStack[this._filterStackIndex]||(this._filterStack[this._filterStackIndex]=this._getFilterData());const n=this._filterStack[this._filterStackIndex];if(this._filterStackIndex++,0===i.length)return void(n.skip=!0);const o=n.bounds;t.renderables?zu(t.renderables,o):t.filterEffect.filterArea?(o.clear(),o.addRect(t.filterEffect.filterArea),o.applyMatrix(t.container.worldTransform)):Lu(t.container,o);const a=s.renderTarget.rootRenderTarget.colorTexture.source;let l=a._resolution,h=0,u=a.antialias,c=!1,d=!1;for(let t=0;t<i.length;t++){const n=i[t];if(l=Math.min(l,n.resolution),h+=n.padding,"inherit"!==n.antialias&&(u="on"===n.antialias),!(n.compatibleRenderers&s.type)){d=!1;break}if(n.blendRequired&&null!=(r=null==(e=s.backBuffer)?void 0:e.useBackBuffer)&&!r){d=!1;break}d=n.enabled||d,c=c||n.blendRequired}if(!d)return void(n.skip=!0);const p=s.renderTarget.rootViewPort;o.scale(l).fitBounds(0,p.width,0,p.height).scale(1/l).pad(h).ceil(),o.isPositive?(n.skip=!1,n.bounds=o,n.blendRequired=c,n.container=t.container,n.filterEffect=t.filterEffect,n.previousRenderSurface=s.renderTarget.renderSurface,n.inputTexture=Fn.getOptimalTexture(o.width,o.height,l,u),s.renderTarget.bind(n.inputTexture,!0),s.globalUniforms.push({offset:o})):n.skip=!0}pop(){const t=this.renderer;this._filterStackIndex--;const e=this._filterStack[this._filterStackIndex];if(e.skip)return;this._activeFilterData=e;const r=e.inputTexture,s=e.bounds;let i=zr.EMPTY;if(t.renderTarget.finishRenderPass(),e.blendRequired){const r=this._filterStackIndex>0?this._filterStack[this._filterStackIndex-1].bounds:null,n=t.renderTarget.getRenderTarget(e.previousRenderSurface);i=this.getBackTexture(n,s,r)}e.backTexture=i;const n=e.filterEffect.filters;if(this._globalFilterBindGroup.setResource(r.source.style,2),this._globalFilterBindGroup.setResource(i.source,3),t.globalUniforms.pop(),1===n.length)n[0].apply(this,r,e.previousRenderSurface,!1),Fn.returnTexture(r);else{let t=e.inputTexture,r=Fn.getOptimalTexture(s.width,s.height,t.source._resolution,!1),i=0;for(i=0;i<n.length-1;++i){n[i].apply(this,t,r,!0);const e=t;t=r,r=e}n[i].apply(this,t,e.previousRenderSurface,!1),Fn.returnTexture(t),Fn.returnTexture(r)}e.blendRequired&&Fn.returnTexture(i)}getBackTexture(t,e,r){const s=t.colorTexture.source._resolution,i=Fn.getOptimalTexture(e.width,e.height,s,!1);let n=e.minX,o=e.minY;r&&(n-=r.minX,o-=r.minY),n=Math.floor(n*s),o=Math.floor(o*s);const a=Math.ceil(e.width*s),l=Math.ceil(e.height*s);return this.renderer.renderTarget.copyToTexture(t,i,{x:n,y:o},{width:a,height:l},{x:0,y:0}),i}applyFilter(t,e,r,s){const i=this.renderer,n=this._filterStack[this._filterStackIndex],o=n.bounds,a=rt.shared,l=n.previousRenderSurface===r;let h=this.renderer.renderTarget.rootRenderTarget.colorTexture.source._resolution,u=this._filterStackIndex-1;for(;u>0&&this._filterStack[u].skip;)--u;u>0&&(h=this._filterStack[u].inputTexture.source._resolution);const c=this._filterGlobalUniforms,d=c.uniforms,p=d.uOutputFrame,f=d.uInputSize,g=d.uInputPixel,m=d.uInputClamp,_=d.uGlobalFrame,x=d.uOutputTexture;if(l){let t=this._filterStackIndex;for(;t>0;){t--;const e=this._filterStack[this._filterStackIndex-1];if(!e.skip){a.x=e.bounds.minX,a.y=e.bounds.minY;break}}p[0]=o.minX-a.x,p[1]=o.minY-a.y}else p[0]=0,p[1]=0;p[2]=e.frame.width,p[3]=e.frame.height,f[0]=e.source.width,f[1]=e.source.height,f[2]=1/f[0],f[3]=1/f[1],g[0]=e.source.pixelWidth,g[1]=e.source.pixelHeight,g[2]=1/g[0],g[3]=1/g[1],m[0]=.5*g[2],m[1]=.5*g[3],m[2]=e.frame.width*f[2]-.5*g[2],m[3]=e.frame.height*f[3]-.5*g[3];const y=this.renderer.renderTarget.rootRenderTarget.colorTexture;_[0]=a.x*h,_[1]=a.y*h,_[2]=y.source.width*h,_[3]=y.source.height*h;const b=this.renderer.renderTarget.getRenderTarget(r);if(i.renderTarget.bind(r,!!s),r instanceof zr?(x[0]=r.frame.width,x[1]=r.frame.height):(x[0]=b.width,x[1]=b.height),x[2]=b.isRoot?-1:1,c.update(),i.renderPipes.uniformBatch){const t=i.renderPipes.uniformBatch.getUboResource(c);this._globalFilterBindGroup.setResource(t,0)}else this._globalFilterBindGroup.setResource(c,0);this._globalFilterBindGroup.setResource(e.source,1),this._globalFilterBindGroup.setResource(e.source.style,2),t.groups[0]=this._globalFilterBindGroup,i.encoder.draw({geometry:Hu,shader:t,state:t._state,topology:"triangle-list"}),i.type===lh.WEBGL&&i.renderTarget.finishRenderPass()}_getFilterData(){return{skip:!1,inputTexture:null,bounds:new St,container:null,filterEffect:null,blendRequired:!1,previousRenderSurface:null}}calculateSpriteMatrix(t,e){const r=this._activeFilterData,s=t.set(r.inputTexture._source.width,0,0,r.inputTexture._source.height,r.bounds.minX,r.bounds.minY),i=e.worldTransform.copyTo(it.shared);return i.invert(),s.prepend(i),s.scale(1/e.texture.frame.width,1/e.texture.frame.height),s.translate(e.anchor.x,e.anchor.y),s}}ju.extension={type:[u.WebGLSystem,u.WebGPUSystem],name:"filter"},p.add(ju),p.add(Nu);var Vu={__proto__:null};const Wu=[];async function $u(t){if(t)for(let t=0;t<Wu.length;t++){const e=Wu[t];if(e.value.test())return void await e.value.load()}}let Yu;function qu(){if("boolean"==typeof Yu)return Yu;try{Yu=!0===new Function("param1","param2","param3","return param1[param2] === param3;")({a:"b"},"a","b")}catch(t){Yu=!1}return Yu}p.handleByNamedList(u.Environment,Wu);var Ku=(t=>(t[t.NONE=0]="NONE",t[t.COLOR=16384]="COLOR",t[t.STENCIL=1024]="STENCIL",t[t.DEPTH=256]="DEPTH",t[t.COLOR_DEPTH=16640]="COLOR_DEPTH",t[t.COLOR_STENCIL=17408]="COLOR_STENCIL",t[t.DEPTH_STENCIL=1280]="DEPTH_STENCIL",t[t.ALL=17664]="ALL",t))(Ku||{});class Zu{constructor(t){this.items=[],this._name=t}emit(t,e,r,s,i,n,o,a){const{name:l,items:h}=this;for(let u=0,c=h.length;u<c;u++)h[u][l](t,e,r,s,i,n,o,a);return this}add(t){return t[this._name]&&(this.remove(t),this.items.push(t)),this}remove(t){const e=this.items.indexOf(t);return-1!==e&&this.items.splice(e,1),this}contains(t){return-1!==this.items.indexOf(t)}removeAll(){return this.items.length=0,this}destroy(){this.removeAll(),this.items=null,this._name=null}get empty(){return 0===this.items.length}get name(){return this._name}}var Qu=Object.defineProperty,Ju=Object.getOwnPropertySymbols,tc=Object.prototype.hasOwnProperty,ec=Object.prototype.propertyIsEnumerable,rc=(t,e,r)=>e in t?Qu(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r,sc=(t,e)=>{for(var r in e||(e={}))tc.call(e,r)&&rc(t,r,e[r]);if(Ju)for(var r of Ju(e))ec.call(e,r)&&rc(t,r,e[r]);return t};const ic=["init","destroy","contextChange","resolutionChange","reset","renderEnd","renderStart","render","update","postrender","prerender"],nc=class t extends m{constructor(t){var e;super(),this.runners=Object.create(null),this.renderPipes=Object.create(null),this._initOptions={},this._systemsHash=Object.create(null),this.type=t.type,this.name=t.name;const r=[...ic,...null!=(e=t.runners)?e:[]];this._addRunners(...r),this._addSystems(t.systems),this._addPipes(t.renderPipes,t.renderPipeAdaptors),this._unsafeEvalCheck()}async init(e={}){for(const t in this._systemsHash){const r=this._systemsHash[t].constructor.defaultOptions;e=sc(sc({},r),e)}e=sc(sc({},t.defaultOptions),e),this._roundPixels=e.roundPixels?1:0;for(let t=0;t<this.runners.init.items.length;t++)await this.runners.init.items[t].init(e);this._initOptions=e}render(t,e){let r=t;if(r instanceof jt&&(r={container:r},e&&(r.target=e.renderTexture)),r.target||(r.target=this.view.renderTarget),r.target===this.view.renderTarget&&(this._lastObjectRendered=r.container,r.clearColor=this.background.colorRgba),r.clearColor){const t=Array.isArray(r.clearColor)&&4===r.clearColor.length;r.clearColor=t?r.clearColor:Z.shared.setValue(r.clearColor).toArray()}r.transform||(r.container.updateLocalTransform(),r.transform=r.container.localTransform),this.runners.prerender.emit(r),this.runners.renderStart.emit(r),this.runners.render.emit(r),this.runners.renderEnd.emit(r),this.runners.postrender.emit(r)}resize(t,e,r){this.view.resize(t,e,r),this.emit("resize",this.view.screen.width,this.view.screen.height)}clear(t={}){t.target||(t.target=this.renderTarget.renderTarget),t.clearColor||(t.clearColor=this.background.colorRgba),null!=t.clear||(t.clear=Ku.ALL);const{clear:e,clearColor:r,target:s}=t;Z.shared.setValue(null!=r?r:this.background.colorRgba),this.renderTarget.clear(s,e,Z.shared.toArray())}get resolution(){return this.view.resolution}set resolution(t){this.view.resolution=t,this.runners.resolutionChange.emit(t)}get width(){return this.view.texture.frame.width}get height(){return this.view.texture.frame.height}get canvas(){return this.view.canvas}get lastObjectRendered(){return this._lastObjectRendered}get renderingToScreen(){return this.renderTarget.renderingToScreen}get screen(){return this.view.screen}_addRunners(...t){t.forEach((t=>{this.runners[t]=new Zu(t)}))}_addSystems(t){let e;for(e in t){const r=t[e];this._addSystem(r.value,r.name)}}_addSystem(t,e){const r=new t(this);if(this[e])throw new Error(`Whoops! The name "${e}" is already in use`);this[e]=r,this._systemsHash[e]=r;for(const t in this.runners)this.runners[t].add(r);return this}_addPipes(t,e){const r=e.reduce(((t,e)=>(t[e.name]=e.value,t)),{});t.forEach((t=>{const e=t.value,s=t.name,i=r[s];this.renderPipes[s]=new e(this,i?new i:null)}))}destroy(t=!1){this.runners.destroy.items.reverse(),this.runners.destroy.emit(t),Object.values(this.runners).forEach((t=>{t.destroy()})),this._systemsHash=null,this.renderPipes=null}generateTexture(t){return this.textureGenerator.generateTexture(t)}get roundPixels(){return!!this._roundPixels}_unsafeEvalCheck(){if(!qu())throw new Error("Current environment does not allow unsafe-eval, please use pixi.js/unsafe-eval module to enable support.")}};nc.defaultOptions={resolution:1,failIfMajorPerformanceCaveat:!1,roundPixels:!1};let oc,ac,lc=nc;function hc(t){return void 0!==oc||(oc=(()=>{var e;const r={stencil:!0,failIfMajorPerformanceCaveat:null!=t?t:lc.defaultOptions.failIfMajorPerformanceCaveat};try{if(!Ne.get().getWebGLRenderingContext())return!1;let t=Ne.get().createCanvas().getContext("webgl",r);const s=!(null==(e=null==t?void 0:t.getContextAttributes())||!e.stencil);if(t){const e=t.getExtension("WEBGL_lose_context");e&&e.loseContext()}return t=null,s}catch(t){return!1}})()),oc}async function uc(t={}){return void 0!==ac||(ac=await(async()=>{if(!Ne.get().getNavigator().gpu)return!1;try{return await(await navigator.gpu.requestAdapter(t)).requestDevice(),!0}catch(t){return!1}})()),ac}var cc=Object.defineProperty,dc=Object.getOwnPropertySymbols,pc=Object.prototype.hasOwnProperty,fc=Object.prototype.propertyIsEnumerable,gc=(t,e,r)=>e in t?cc(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r,mc=(t,e)=>{for(var r in e||(e={}))pc.call(e,r)&&gc(t,r,e[r]);if(dc)for(var r of dc(e))fc.call(e,r)&&gc(t,r,e[r]);return t};const _c=["webgl","webgpu","canvas"];async function xc(t){var e,r;let s,i=[];t.preference?(i.push(t.preference),_c.forEach((e=>{e!==t.preference&&i.push(e)}))):i=_c.slice(),await $u(null==(e=t.manageImports)||e);let n={};for(let e=0;e<i.length;e++){const o=i[e];if("webgpu"===o&&await uc()){const{WebGPURenderer:e}=await Promise.resolve().then((function(){return Iv}));s=e,n=mc(mc({},t),t.webgpu);break}if("webgl"===o&&hc(null!=(r=t.failIfMajorPerformanceCaveat)?r:lc.defaultOptions.failIfMajorPerformanceCaveat)){const{WebGLRenderer:e}=await Promise.resolve().then((function(){return Gb}));s=e,n=mc(mc({},t),t.webgl);break}if("canvas"===o){n=mc({},t);break}}delete n.webgpu,delete n.webgl;const o=new s;return await o.init(n),o}var yc=Object.defineProperty,bc=Object.getOwnPropertySymbols,vc=Object.prototype.hasOwnProperty,Tc=Object.prototype.propertyIsEnumerable,Sc=(t,e,r)=>e in t?yc(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r;const wc=class t{constructor(...t){this.stage=new jt}async init(e){e=((t,e)=>{for(var r in e||(e={}))vc.call(e,r)&&Sc(t,r,e[r]);if(bc)for(var r of bc(e))Tc.call(e,r)&&Sc(t,r,e[r]);return t})({},e),this.renderer=await xc(e),t._plugins.forEach((t=>{t.init.call(this,e)}))}render(){this.renderer.render({container:this.stage})}get canvas(){return this.renderer.canvas}get view(){return this.renderer.canvas}get screen(){return this.renderer.screen}destroy(e=!1,r=!1){const s=t._plugins.slice(0);s.reverse(),s.forEach((t=>{t.destroy.call(this)})),this.stage.destroy(r),this.stage=null,this.renderer.destroy(e),this.renderer=null}};wc._plugins=[];let Ec=wc;p.handleByList(u.Application,Ec._plugins);class Ac{constructor(t,e=!1){this._loader=t,this._assetList=[],this._isLoading=!1,this._maxConcurrent=1,this.verbose=e}add(t){t.forEach((t=>{this._assetList.push(t)})),this.verbose&&console.log("[BackgroundLoader] assets: ",this._assetList),this._isActive&&!this._isLoading&&this._next()}async _next(){if(this._assetList.length&&this._isActive){this._isLoading=!0;const t=[],e=Math.min(this._assetList.length,this._maxConcurrent);for(let r=0;r<e;r++)t.push(this._assetList.pop());await this._loader.load(t),this._isLoading=!1,this._next()}}get active(){return this._isActive}set active(t){this._isActive!==t&&(this._isActive=t,t&&!this._isLoading&&this._next())}}const Mc={extension:u.CacheParser,test:t=>Array.isArray(t)&&t.every((t=>t instanceof zr)),getCacheableAssets:(t,e)=>{const r={};return t.forEach((t=>{e.forEach(((e,s)=>{r[t+(0===s?"":s+1)]=e}))})),r}};async function Pc(t){if("Image"in globalThis)return new Promise((e=>{const r=new Image;r.onload=()=>{e(!0)},r.onerror=()=>{e(!1)},r.src=t}));if("createImageBitmap"in globalThis&&"fetch"in globalThis){try{const e=await(await fetch(t)).blob();await createImageBitmap(e)}catch(t){return!1}return!0}return!1}const Rc={extension:{type:u.DetectionParser,priority:1},test:async()=>Pc("data:image/avif;base64,AAAAIGZ0eXBhdmlmAAAAAGF2aWZtaWYxbWlhZk1BMUIAAADybWV0YQAAAAAAAAAoaGRscgAAAAAAAAAAcGljdAAAAAAAAAAAAAAAAGxpYmF2aWYAAAAADnBpdG0AAAAAAAEAAAAeaWxvYwAAAABEAAABAAEAAAABAAABGgAAAB0AAAAoaWluZgAAAAAAAQAAABppbmZlAgAAAAABAABhdjAxQ29sb3IAAAAAamlwcnAAAABLaXBjbwAAABRpc3BlAAAAAAAAAAIAAAACAAAAEHBpeGkAAAAAAwgICAAAAAxhdjFDgQ0MAAAAABNjb2xybmNseAACAAIAAYAAAAAXaXBtYQAAAAAAAAABAAEEAQKDBAAAACVtZGF0EgAKCBgANogQEAwgMg8f8D///8WfhwB8+ErK42A="),add:async t=>[...t,"avif"],remove:async t=>t.filter((t=>"avif"!==t))},Oc=["png","jpg","jpeg"],Cc={extension:{type:u.DetectionParser,priority:-1},test:()=>Promise.resolve(!0),add:async t=>[...t,...Oc],remove:async t=>t.filter((t=>!Oc.includes(t)))},Ic="WorkerGlobalScope"in globalThis&&globalThis instanceof globalThis.WorkerGlobalScope;function Gc(t){return!Ic&&""!==document.createElement("video").canPlayType(t)}const kc={extension:{type:u.DetectionParser,priority:0},test:async()=>Gc("video/mp4"),add:async t=>[...t,"mp4","m4v"],remove:async t=>t.filter((t=>"mp4"!==t&&"m4v"!==t))},Bc={extension:{type:u.DetectionParser,priority:0},test:async()=>Gc("video/ogg"),add:async t=>[...t,"ogv"],remove:async t=>t.filter((t=>"ogv"!==t))},Dc={extension:{type:u.DetectionParser,priority:0},test:async()=>Gc("video/webm"),add:async t=>[...t,"webm"],remove:async t=>t.filter((t=>"webm"!==t))},Fc={extension:{type:u.DetectionParser,priority:0},test:async()=>Pc("data:image/webp;base64,UklGRh4AAABXRUJQVlA4TBEAAAAvAAAAAAfQ//73v/+BiOh/AAA="),add:async t=>[...t,"webp"],remove:async t=>t.filter((t=>"webp"!==t))};var Nc=Object.defineProperty,Uc=Object.defineProperties,Lc=Object.getOwnPropertyDescriptors,Xc=Object.getOwnPropertySymbols,zc=Object.prototype.hasOwnProperty,Hc=Object.prototype.propertyIsEnumerable,jc=(t,e,r)=>e in t?Nc(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r;class Vc{constructor(){this._parsers=[],this._parsersValidated=!1,this.parsers=new Proxy(this._parsers,{set:(t,e,r)=>(this._parsersValidated=!1,t[e]=r,!0)}),this.promiseCache={}}reset(){this._parsersValidated=!1,this.promiseCache={}}_getLoadPromiseAndParser(t,e){const r={promise:null,parser:null};return r.promise=(async()=>{var s,i;let n=null,o=null;if(e.loadParser&&(o=this._parserHash[e.loadParser]),!o){for(let r=0;r<this.parsers.length;r++){const i=this.parsers[r];if(i.load&&null!=(s=i.test)&&s.call(i,t,e,this)){o=i;break}}if(!o)return null}n=await o.load(t,e,this),r.parser=o;for(let t=0;t<this.parsers.length;t++){const s=this.parsers[t];s.parse&&s.parse&&await(null==(i=s.testParse)?void 0:i.call(s,n,e,this))&&(n=await s.parse(n,e,this)||n,r.parser=s)}return n})(),r}async load(t,e){this._parsersValidated||this._validateParsers();let r=0;const s={},i=Ve(t),n=ze(t,(t=>({alias:[t],src:t}))),o=n.length,a=n.map((async t=>{const i=Xe.toAbsolute(t.src);if(!s[t.src])try{this.promiseCache[i]||(this.promiseCache[i]=this._getLoadPromiseAndParser(i,t)),s[t.src]=await this.promiseCache[i].promise,e&&e(++r/o)}catch(e){throw delete this.promiseCache[i],delete s[t.src],new Error(`[Loader.load] Failed to load ${i}.\n${e}`)}}));return await Promise.all(a),i?s[n[0].src]:s}async unload(t){const e=ze(t,(t=>({alias:[t],src:t}))).map((async t=>{var e,r;const s=Xe.toAbsolute(t.src),i=this.promiseCache[s];if(i){const n=await i.promise;delete this.promiseCache[s],await(null==(r=null==(e=i.parser)?void 0:e.unload)?void 0:r.call(e,n,t,this))}}));await Promise.all(e)}_validateParsers(){this._parsersValidated=!0,this._parserHash=this._parsers.filter((t=>t.name)).reduce(((t,e)=>(e.name&&t[e.name],((t,e)=>Uc(t,Lc(e)))(((t,e)=>{for(var r in e||(e={}))zc.call(e,r)&&jc(t,r,e[r]);if(Xc)for(var r of Xc(e))Hc.call(e,r)&&jc(t,r,e[r]);return t})({},t),{[e.name]:e}))),{})}}function Wc(t,e){if(Array.isArray(e)){for(const r of e)if(t.startsWith(`data:${r}`))return!0;return!1}return t.startsWith(`data:${e}`)}function $c(t,e){const r=t.split("?")[0],s=Xe.extname(r).toLowerCase();return Array.isArray(e)?e.includes(s):s===e}const Yc={extension:{type:u.LoadParser,priority:Be.Low},name:"loadJson",test:t=>Wc(t,"application/json")||$c(t,".json"),load:async t=>await(await Ne.get().fetch(t)).json()},qc={name:"loadTxt",extension:{type:u.LoadParser,priority:Be.Low},test:t=>Wc(t,"text/plain")||$c(t,".txt"),load:async t=>await(await Ne.get().fetch(t)).text()};var Kc=Object.defineProperty,Zc=Object.defineProperties,Qc=Object.getOwnPropertyDescriptors,Jc=Object.getOwnPropertySymbols,td=Object.prototype.hasOwnProperty,ed=Object.prototype.propertyIsEnumerable,rd=(t,e,r)=>e in t?Kc(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r,sd=(t,e)=>{for(var r in e||(e={}))td.call(e,r)&&rd(t,r,e[r]);if(Jc)for(var r of Jc(e))ed.call(e,r)&&rd(t,r,e[r]);return t},id=(t,e)=>Zc(t,Qc(e));const nd=["normal","bold","100","200","300","400","500","600","700","800","900"],od=[".ttf",".otf",".woff",".woff2"],ad=["font/ttf","font/otf","font/woff","font/woff2"],ld=/^(--|-?[A-Z_])[0-9A-Z_-]*$/i;function hd(t){const e=Xe.extname(t),r=Xe.basename(t,e).replace(/(-|_)/g," ").toLowerCase().split(" ").map((t=>t.charAt(0).toUpperCase()+t.slice(1)));let s=r.length>0;for(const t of r)if(!t.match(ld)){s=!1;break}let i=r.join(" ");return s||(i=`"${i.replace(/[\\"]/g,"\\$&")}"`),i}const ud=/^[0-9A-Za-z%:/?#\[\]@!\$&'()\*\+,;=\-._~]*$/;function cd(t){return ud.test(t)?t:encodeURI(t)}const dd={extension:{type:u.LoadParser,priority:Be.Low},name:"loadWebFont",test:t=>Wc(t,ad)||$c(t,od),async load(t,e){var r,s,i,n,o,a;const l=Ne.get().getFontFaceSet();if(l){const h=[],u=null!=(s=null==(r=e.data)?void 0:r.family)?s:hd(t),c=null!=(o=null==(n=null==(i=e.data)?void 0:i.weights)?void 0:n.filter((t=>nd.includes(t))))?o:["normal"],d=null!=(a=e.data)?a:{};for(let e=0;e<c.length;e++){const r=c[e],s=new FontFace(u,`url(${cd(t)})`,id(sd({},d),{weight:r}));await s.load(),l.add(s),h.push(s)}return Ts.set(`${u}-and-url`,{url:t,fontFaces:h}),1===h.length?h[0]:h}return null},unload(t){(Array.isArray(t)?t:[t]).forEach((t=>{Ts.remove(t.family),Ne.get().getFontFaceSet().delete(t)}))}};function pd(t,e=1){var r;const s=null==(r=tr.RETINA_PREFIX)?void 0:r.exec(t);return s?parseFloat(s[1]):e}function fd(t,e,r){t.label=r,t._sourceOrigin=r;const s=new zr({source:t,label:r}),i=()=>{delete e.promiseCache[r],Ts.has(r)&&Ts.remove(r)};return s.source.once("destroy",(()=>{e.promiseCache[r]&&i()})),s.once("destroy",(()=>{t.destroyed||i()})),s}var gd=Object.defineProperty,md=Object.getOwnPropertySymbols,_d=Object.prototype.hasOwnProperty,xd=Object.prototype.propertyIsEnumerable,yd=(t,e,r)=>e in t?gd(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r;const bd={extension:{type:u.LoadParser,priority:Be.Low},name:"loadSVG",config:{crossOrigin:"anonymous",parseAsGraphicsContext:!1},test:t=>Wc(t,"image/svg+xml")||$c(t,".svg"),async load(t,e,r){var s;return(null!=(s=e.data.parseAsGraphicsContext)?s:this.config.parseAsGraphicsContext)?async function(t){const e=await(await Ne.get().fetch(t)).text(),r=new aa;return r.svg(e),r}(t):async function(t,e,r,s){var i,n,o,a,l;const h=await(await Ne.get().fetch(t)).blob(),u=URL.createObjectURL(h),c=new Image;c.src=u,c.crossOrigin=s,await c.decode(),URL.revokeObjectURL(u);const d=document.createElement("canvas"),p=d.getContext("2d"),f=(null==(i=e.data)?void 0:i.resolution)||pd(t),g=null!=(o=null==(n=e.data)?void 0:n.width)?o:c.width,m=null!=(l=null==(a=e.data)?void 0:a.height)?l:c.height;d.width=g*f,d.height=m*f,p.drawImage(c,0,0,g*f,m*f);const _=e.data,{parseAsGraphicsContext:x}=_,y=((t,e)=>{var r={};for(var s in t)_d.call(t,s)&&e.indexOf(s)<0&&(r[s]=t[s]);if(null!=t&&md)for(var s of md(t))e.indexOf(s)<0&&xd.call(t,s)&&(r[s]=t[s]);return r})(_,["parseAsGraphicsContext"]);return fd(new hs(((t,e)=>{for(var r in e||(e={}))_d.call(e,r)&&yd(t,r,e[r]);if(md)for(var r of md(e))xd.call(e,r)&&yd(t,r,e[r]);return t})({resource:d,alphaMode:"premultiply-alpha-on-upload",resolution:f},y)),r,t)}(t,e,r,this.config.crossOrigin)},unload(t){t.destroy(!0)}};let vd=null,Td=class{constructor(){vd||(vd=URL.createObjectURL(new Blob(['(function(){"use strict";const e="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mP8/x8AAwMCAO+ip1sAAAAASUVORK5CYII=";async function a(){try{if(typeof createImageBitmap!="function")return!1;const A=await(await fetch(e)).blob(),t=await createImageBitmap(A);return t.width===1&&t.height===1}catch(A){return!1}}a().then(A=>{self.postMessage(A)})})();\n'],{type:"application/javascript"}))),this.worker=new Worker(vd)}};Td.revokeObjectURL=function(){vd&&(URL.revokeObjectURL(vd),vd=null)};let Sd=null,wd=class{constructor(){Sd||(Sd=URL.createObjectURL(new Blob(['(function(){"use strict";async function e(t){const a=await fetch(t);if(!a.ok)throw new Error(`[WorkerManager.loadImageBitmap] Failed to fetch ${t}: ${a.status} ${a.statusText}`);const s=await a.blob();return await createImageBitmap(s)}self.onmessage=async t=>{try{const a=await e(t.data.data[0]);self.postMessage({data:a,uuid:t.data.uuid,id:t.data.id},[a])}catch(a){self.postMessage({error:a,uuid:t.data.uuid,id:t.data.id})}}})();\n'],{type:"application/javascript"}))),this.worker=new Worker(Sd)}};wd.revokeObjectURL=function(){Sd&&(URL.revokeObjectURL(Sd),Sd=null)};let Ed,Ad=0;const Md=new class{constructor(){this._initialized=!1,this._createdWorkers=0,this._workerPool=[],this._queue=[],this._resolveHash={}}isImageBitmapSupported(){return void 0!==this._isImageBitmapSupported||(this._isImageBitmapSupported=new Promise((t=>{const{worker:e}=new Td;e.addEventListener("message",(r=>{e.terminate(),Td.revokeObjectURL(),t(r.data)}))}))),this._isImageBitmapSupported}loadImageBitmap(t){return this._run("loadImageBitmap",[t])}async _initWorkers(){this._initialized||(this._initialized=!0)}_getWorker(){void 0===Ed&&(Ed=navigator.hardwareConcurrency||4);let t=this._workerPool.pop();return!t&&this._createdWorkers<Ed&&(this._createdWorkers++,t=(new wd).worker,t.addEventListener("message",(t=>{this._complete(t.data),this._returnWorker(t.target),this._next()}))),t}_returnWorker(t){this._workerPool.push(t)}_complete(t){void 0!==t.error?this._resolveHash[t.uuid].reject(t.error):this._resolveHash[t.uuid].resolve(t.data),this._resolveHash[t.uuid]=null}async _run(t,e){await this._initWorkers();const r=new Promise(((r,s)=>{this._queue.push({id:t,arguments:e,resolve:r,reject:s})}));return this._next(),r}_next(){if(!this._queue.length)return;const t=this._getWorker();if(!t)return;const e=this._queue.pop(),r=e.id;this._resolveHash[Ad]={resolve:e.resolve,reject:e.reject},t.postMessage({data:e.arguments,uuid:Ad++,id:r})}};var Pd=Object.defineProperty,Rd=Object.getOwnPropertySymbols,Od=Object.prototype.hasOwnProperty,Cd=Object.prototype.propertyIsEnumerable,Id=(t,e,r)=>e in t?Pd(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r;const Gd=[".jpeg",".jpg",".png",".webp",".avif"],kd=["image/jpeg","image/png","image/webp","image/avif"];async function Bd(t){const e=await Ne.get().fetch(t);if(!e.ok)throw new Error(`[loadImageBitmap] Failed to fetch ${t}: ${e.status} ${e.statusText}`);const r=await e.blob();return await createImageBitmap(r)}const Dd={name:"loadTextures",extension:{type:u.LoadParser,priority:Be.High},config:{preferWorkers:!0,preferCreateImageBitmap:!0,crossOrigin:"anonymous"},test:t=>Wc(t,kd)||$c(t,Gd),async load(t,e,r){var s;let i=null;i=globalThis.createImageBitmap&&this.config.preferCreateImageBitmap?this.config.preferWorkers&&await Md.isImageBitmapSupported()?await Md.loadImageBitmap(t):await Bd(t):await new Promise((e=>{i=new Image,i.crossOrigin=this.config.crossOrigin,i.src=t,i.complete?e(i):i.onload=()=>{e(i)}}));const n=new hs(((t,e)=>{for(var r in e||(e={}))Od.call(e,r)&&Id(t,r,e[r]);if(Rd)for(var r of Rd(e))Cd.call(e,r)&&Id(t,r,e[r]);return t})({resource:i,alphaMode:"premultiply-alpha-on-upload",resolution:(null==(s=e.data)?void 0:s.resolution)||pd(t)},e.data));return fd(n,r,t)},unload(t){t.destroy(!0)}};var Fd=Object.defineProperty,Nd=Object.defineProperties,Ud=Object.getOwnPropertyDescriptors,Ld=Object.getOwnPropertySymbols,Xd=Object.prototype.hasOwnProperty,zd=Object.prototype.propertyIsEnumerable,Hd=(t,e,r)=>e in t?Fd(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r,jd=(t,e)=>{for(var r in e||(e={}))Xd.call(e,r)&&Hd(t,r,e[r]);if(Ld)for(var r of Ld(e))zd.call(e,r)&&Hd(t,r,e[r]);return t},Vd=(t,e)=>Nd(t,Ud(e));const Wd=[".mp4",".m4v",".webm",".ogg",".ogv",".h264",".avi",".mov"],$d=Wd.map((t=>`video/${t.substring(1)}`));function Yd(t,e,r){void 0!==r||e.startsWith("data:")?!1!==r&&(t.crossOrigin="string"==typeof r?r:"anonymous"):t.crossOrigin=Kd(e)}function qd(t){return new Promise(((e,r)=>{function s(){n(),e()}function i(t){n(),r(t)}function n(){t.removeEventListener("canplaythrough",s),t.removeEventListener("error",i)}t.addEventListener("canplaythrough",s),t.addEventListener("error",i),t.load()}))}function Kd(t,e=globalThis.location){if(t.startsWith("data:"))return"";e=e||globalThis.location;const r=new URL(t,document.baseURI);return r.hostname!==e.hostname||r.port!==e.port||r.protocol!==e.protocol?"anonymous":""}const Zd={name:"loadVideo",extension:{type:u.LoadParser},config:null,test(t){const e=Wc(t,$d),r=$c(t,Wd);return e||r},async load(t,e,r){var s,i;const n=jd(Vd(jd({},vs.defaultOptions),{resolution:(null==(s=e.data)?void 0:s.resolution)||pd(t),alphaMode:(null==(i=e.data)?void 0:i.alphaMode)||await cs()}),e.data),o=document.createElement("video"),a={preload:!1!==n.autoLoad?"auto":void 0,"webkit-playsinline":!1!==n.playsinline?"":void 0,playsinline:!1!==n.playsinline?"":void 0,muted:!0===n.muted?"":void 0,loop:!0===n.loop?"":void 0,autoplay:!1!==n.autoPlay?"":void 0};Object.keys(a).forEach((t=>{const e=a[t];void 0!==e&&o.setAttribute(t,e)})),!0===n.muted&&(o.muted=!0),Yd(o,t,n.crossorigin);const l=document.createElement("source");let h;if(t.startsWith("data:"))h=t.slice(5,t.indexOf(";"));else if(!t.startsWith("blob:")){const e=t.split("?")[0].slice(t.lastIndexOf(".")+1).toLowerCase();h=vs.MIME_TYPES[e]||`video/${e}`}return l.src=t,h&&(l.type=h),new Promise((s=>{const i=async()=>{const a=new vs(Vd(jd({},n),{resource:o}));o.removeEventListener("canplay",i),e.data.preload&&await qd(o),s(fd(a,r,t))};o.addEventListener("canplay",i),o.appendChild(l)}))},unload(t){t.destroy(!0)}},Qd={extension:u.ResolveParser,test:Dd.test,parse:t=>{var e,r;return{resolution:parseFloat(null!=(r=null==(e=tr.RETINA_PREFIX.exec(t))?void 0:e[1])?r:"1"),format:t.split(".").pop(),src:t}}},Jd={extension:u.ResolveParser,test:t=>tr.RETINA_PREFIX.test(t)&&t.endsWith(".json"),parse:Qd.parse};class tp{constructor(){this._detections=[],this._initialized=!1,this.resolver=new tr,this.loader=new Vc,this.cache=Ts,this._backgroundLoader=new Ac(this.loader),this._backgroundLoader.active=!0,this.reset()}async init(t={}){var e,r,s;if(this._initialized)return;if(this._initialized=!0,t.defaultSearchParams&&this.resolver.setDefaultSearchParams(t.defaultSearchParams),t.basePath&&(this.resolver.basePath=t.basePath),t.bundleIdentifier&&this.resolver.setBundleIdentifier(t.bundleIdentifier),t.manifest){let e=t.manifest;"string"==typeof e&&(e=await this.load(e)),this.resolver.addManifest(e)}const i=null!=(r=null==(e=t.texturePreference)?void 0:e.resolution)?r:1,n="number"==typeof i?[i]:i,o=await this._detectFormats({preferredFormats:null==(s=t.texturePreference)?void 0:s.format,skipDetections:t.skipDetections,detections:this._detections});this.resolver.prefer({params:{format:o,resolution:n}}),t.preferences&&this.setPreferences(t.preferences)}add(t){this.resolver.add(t)}async load(t,e){this._initialized||await this.init();const r=Ve(t),s=ze(t).map((t=>{if("string"!=typeof t){const e=this.resolver.getAlias(t);return e.some((t=>!this.resolver.hasKey(t)))&&this.add(t),Array.isArray(e)?e[0]:e}return this.resolver.hasKey(t)||this.add({alias:t,src:t}),t})),i=this.resolver.resolve(s),n=await this._mapLoadToResolve(i,e);return r?n[s[0]]:n}addBundle(t,e){this.resolver.addBundle(t,e)}async loadBundle(t,e){this._initialized||await this.init();let r=!1;"string"==typeof t&&(r=!0,t=[t]);const s=this.resolver.resolveBundle(t),i={},n=Object.keys(s);let o=0,a=0;const l=()=>{null==e||e(++o/a)},h=n.map((t=>{const e=s[t];return a+=Object.keys(e).length,this._mapLoadToResolve(e,l).then((e=>{i[t]=e}))}));return await Promise.all(h),r?i[t[0]]:i}async backgroundLoad(t){this._initialized||await this.init(),"string"==typeof t&&(t=[t]);const e=this.resolver.resolve(t);this._backgroundLoader.add(Object.values(e))}async backgroundLoadBundle(t){this._initialized||await this.init(),"string"==typeof t&&(t=[t]);const e=this.resolver.resolveBundle(t);Object.values(e).forEach((t=>{this._backgroundLoader.add(Object.values(t))}))}reset(){this.resolver.reset(),this.loader.reset(),this.cache.reset(),this._initialized=!1}get(t){if("string"==typeof t)return Ts.get(t);const e={};for(let r=0;r<t.length;r++)e[r]=Ts.get(t[r]);return e}async _mapLoadToResolve(t,e){const r=[...new Set(Object.values(t))];this._backgroundLoader.active=!1;const s=await this.loader.load(r,e);this._backgroundLoader.active=!0;const i={};return r.forEach((t=>{const e=s[t.src],r=[t.src];t.alias&&r.push(...t.alias),r.forEach((t=>{i[t]=e})),Ts.set(r,e)})),i}async unload(t){this._initialized||await this.init();const e=ze(t).map((t=>"string"!=typeof t?t.src:t)),r=this.resolver.resolve(e);await this._unloadFromResolved(r)}async unloadBundle(t){this._initialized||await this.init(),t=ze(t);const e=this.resolver.resolveBundle(t),r=Object.keys(e).map((t=>this._unloadFromResolved(e[t])));await Promise.all(r)}async _unloadFromResolved(t){const e=Object.values(t);e.forEach((t=>{Ts.remove(t.src)})),await this.loader.unload(e)}async _detectFormats(t){let e=[];t.preferredFormats&&(e=Array.isArray(t.preferredFormats)?t.preferredFormats:[t.preferredFormats]);for(const r of t.detections)t.skipDetections||await r.test()?e=await r.add(e):t.skipDetections||(e=await r.remove(e));return e=e.filter(((t,r)=>e.indexOf(t)===r)),e}get detections(){return this._detections}setPreferences(t){this.loader.parsers.forEach((e=>{e.config&&Object.keys(e.config).filter((e=>e in t)).forEach((r=>{e.config[r]=t[r]}))}))}}const ep=new tp;p.handleByList(u.LoadParser,ep.loader.parsers).handleByList(u.ResolveParser,ep.resolver.parsers).handleByList(u.CacheParser,ep.cache.parsers).handleByList(u.DetectionParser,ep.detections),p.add(Mc,Cc,Rc,Fc,kc,Bc,Dc,Yc,qc,dd,bd,Dd,Zd,Qd,Jd);const rp={loader:u.LoadParser,resolver:u.ResolveParser,cache:u.CacheParser,detection:u.DetectionParser};p.handle(u.Asset,(t=>{const e=t.ref;Object.entries(rp).filter((([t])=>!!e[t])).forEach((([t,r])=>{var s;return p.add(Object.assign(e[t],{extension:null!=(s=e[t].extension)?s:r}))}))}),(t=>{const e=t.ref;Object.keys(rp).filter((t=>!!e[t])).forEach((t=>p.remove(e[t])))}));const sp={extension:{type:u.DetectionParser,priority:3},test:async()=>!(!await uc()&&!hc()),add:async t=>[...t,"basis"],remove:async t=>t.filter((t=>"basis"!==t))};class ip extends Cr{constructor(t){super(t),this.uploadMethodId="compressed",this.resource=t.resource,this.mipLevelCount=this.resource.length}}let np,op,ap;function lp(){if(np)return np;const t=document.createElement("canvas").getContext("webgl");return t?(np=[...t.getExtension("EXT_texture_compression_bptc")?["bc6h-rgb-ufloat","bc6h-rgb-float","bc7-rgba-unorm","bc7-rgba-unorm-srgb"]:[],...t.getExtension("WEBGL_compressed_texture_s3tc")?["bc1-rgba-unorm","bc2-rgba-unorm","bc3-rgba-unorm"]:[],...t.getExtension("WEBGL_compressed_texture_s3tc_srgb")?["bc1-rgba-unorm-srgb","bc2-rgba-unorm-srgb","bc3-rgba-unorm-srgb"]:[],...t.getExtension("EXT_texture_compression_rgtc")?["bc4-r-unorm","bc4-r-snorm","bc5-rg-unorm","bc5-rg-snorm"]:[],...t.getExtension("WEBGL_compressed_texture_etc")?["etc2-rgb8unorm","etc2-rgb8unorm-srgb","etc2-rgba8unorm","etc2-rgba8unorm-srgb","etc2-rgb8a1unorm","etc2-rgb8a1unorm-srgb","eac-r11unorm","eac-rg11unorm"]:[],...t.getExtension("WEBGL_compressed_texture_astc")?["astc-4x4-unorm","astc-4x4-unorm-srgb","astc-5x4-unorm","astc-5x4-unorm-srgb","astc-5x5-unorm","astc-5x5-unorm-srgb","astc-6x5-unorm","astc-6x5-unorm-srgb","astc-6x6-unorm","astc-6x6-unorm-srgb","astc-8x5-unorm","astc-8x5-unorm-srgb","astc-8x6-unorm","astc-8x6-unorm-srgb","astc-8x8-unorm","astc-8x8-unorm-srgb","astc-10x5-unorm","astc-10x5-unorm-srgb","astc-10x6-unorm","astc-10x6-unorm-srgb","astc-10x8-unorm","astc-10x8-unorm-srgb","astc-10x10-unorm","astc-10x10-unorm-srgb","astc-12x10-unorm","astc-12x10-unorm-srgb","astc-12x12-unorm","astc-12x12-unorm-srgb"]:[]],np):[]}async function hp(){if(op)return op;const t=await navigator.gpu.requestAdapter();return op=[...t.features.has("texture-compression-bc")?["bc1-rgba-unorm","bc1-rgba-unorm-srgb","bc2-rgba-unorm","bc2-rgba-unorm-srgb","bc3-rgba-unorm","bc3-rgba-unorm-srgb","bc4-r-unorm","bc4-r-snorm","bc5-rg-unorm","bc5-rg-snorm","bc6h-rgb-ufloat","bc6h-rgb-float","bc7-rgba-unorm","bc7-rgba-unorm-srgb"]:[],...t.features.has("texture-compression-etc2")?["etc2-rgb8unorm","etc2-rgb8unorm-srgb","etc2-rgb8a1unorm","etc2-rgb8a1unorm-srgb","etc2-rgba8unorm","etc2-rgba8unorm-srgb","eac-r11unorm","eac-r11snorm","eac-rg11unorm","eac-rg11snorm"]:[],...t.features.has("texture-compression-astc")?["astc-4x4-unorm","astc-4x4-unorm-srgb","astc-5x4-unorm","astc-5x4-unorm-srgb","astc-5x5-unorm","astc-5x5-unorm-srgb","astc-6x5-unorm","astc-6x5-unorm-srgb","astc-6x6-unorm","astc-6x6-unorm-srgb","astc-8x5-unorm","astc-8x5-unorm-srgb","astc-8x6-unorm","astc-8x6-unorm-srgb","astc-8x8-unorm","astc-8x8-unorm-srgb","astc-10x5-unorm","astc-10x5-unorm-srgb","astc-10x6-unorm","astc-10x6-unorm-srgb","astc-10x8-unorm","astc-10x8-unorm-srgb","astc-10x10-unorm","astc-10x10-unorm-srgb","astc-12x10-unorm","astc-12x10-unorm-srgb","astc-12x12-unorm","astc-12x12-unorm-srgb"]:[]],op}async function up(){return void 0!==ap||(ap=await(async()=>{const t=await uc(),e=hc();if(t&&e){const t=await hp(),e=lp();return t.filter((t=>e.includes(t)))}return t?await hp():e?lp():[]})()),ap}const cp=["r8unorm","r8snorm","r8uint","r8sint","r16uint","r16sint","r16float","rg8unorm","rg8snorm","rg8uint","rg8sint","r32uint","r32sint","r32float","rg16uint","rg16sint","rg16float","rgba8unorm","rgba8unorm-srgb","rgba8snorm","rgba8uint","rgba8sint","bgra8unorm","bgra8unorm-srgb","rgb9e5ufloat","rgb10a2unorm","rg11b10ufloat","rg32uint","rg32sint","rg32float","rgba16uint","rgba16sint","rgba16float","rgba32uint","rgba32sint","rgba32float","stencil8","depth16unorm","depth24plus","depth24plus-stencil8","depth32float","depth32float-stencil8"];let dp;async function pp(){if(void 0!==dp)return dp;const t=await up();return dp=[...cp,...t],dp}let fp=null,gp=class{constructor(){fp||(fp=URL.createObjectURL(new Blob(['(function(){"use strict";function g(r,a){const t=r.getNumImages(),s=r.getNumLevels(0);if(!r.startTranscoding())throw new Error("startTranscoding failed");const m=[];for(let e=0;e<s;++e)for(let o=0;o<t;++o){const B=r.getImageTranscodedSizeInBytes(o,e,a),f=new Uint8Array(B);if(!r.transcodeImage(f,o,e,a,1,0))throw new Error("transcodeImage failed");m.push(f)}return m}const w={"bc3-rgba-unorm":3,"bc7-rgba-unorm":6,"etc2-rgba8unorm":1,"astc-4x4-unorm":10,rgba8unorm:13,rgba4unorm:16};function d(r){const a=w[r];if(a)return a;throw new Error(`Unsupported transcoderFormat: ${r}`)}const n={jsUrl:"basis/basis_transcoder.js",wasmUrl:"basis/basis_transcoder.wasm"};let u,i,c;async function l(){if(!c){const r=new URL(n.jsUrl,location.origin).href,a=new URL(n.wasmUrl,location.origin).href;importScripts(r),c=new Promise(t=>{BASIS({locateFile:s=>a}).then(s=>{s.initializeBasis(),t(s.BasisFile)})})}return c}async function b(r,a){const t=await fetch(r);if(t.ok){const s=await t.arrayBuffer();return new a(new Uint8Array(s))}throw new Error(`Failed to load Basis texture: ${r}`)}const h=["bc7-rgba-unorm","astc-4x4-unorm","etc2-rgba8unorm","bc3-rgba-unorm","rgba8unorm"];async function p(r){const a=await l(),t=await b(r,a),s=g(t,u);return{width:t.getImageWidth(0,0),height:t.getImageHeight(0,0),format:i,resource:s,alphaMode:"no-premultiply-alpha"}}async function y(r,a,t){r&&(n.jsUrl=r),a&&(n.wasmUrl=a),i=h.filter(s=>t.includes(s))[0],u=d(i),await l()}const U={init:async r=>{const{jsUrl:a,wasmUrl:t,supportedTextures:s}=r;await y(a,t,s)},load:async r=>{var a;try{const t=await p(r.url);return{type:"load",url:r.url,success:!0,textureOptions:t,transferables:(a=t.resource)==null?void 0:a.map(s=>s.buffer)}}catch(t){throw t}}};self.onmessage=async r=>{const a=r.data,t=await U[a.type](a);t&&self.postMessage(t,t.transferables)}})();\n'],{type:"application/javascript"}))),this.worker=new Worker(fp)}};gp.revokeObjectURL=function(){fp&&(URL.revokeObjectURL(fp),fp=null)};const mp={jsUrl:"https://files.pixijs.download/transcoders/basis/basis_transcoder.js",wasmUrl:"https://files.pixijs.download/transcoders/basis/basis_transcoder.wasm"};let _p;const xp={};function yp(t,e){const r=function(t){return _p||(_p=(new gp).worker,_p.onmessage=t=>{const{success:e,url:r,textureOptions:s}=t.data;e||console.warn("Failed to load Basis texture",r),xp[r](s)},_p.postMessage({type:"init",jsUrl:mp.jsUrl,wasmUrl:mp.wasmUrl,supportedTextures:t})),_p}(e);return new Promise((e=>{xp[t]=e,r.postMessage({type:"load",url:t})}))}const bp={extension:{type:u.LoadParser,priority:Be.High},name:"loadBasis",test:t=>$c(t,[".basis"]),async load(t,e,r){const s=await pp(),i=await yp(t,s);return fd(new ip(i),r,t)},unload(t){Array.isArray(t)?t.forEach((t=>t.destroy(!0))):t.destroy(!0)}};const vp={"bc3-rgba-unorm":3,"bc7-rgba-unorm":6,"etc2-rgba8unorm":1,"astc-4x4-unorm":10,rgba8unorm:13,rgba4unorm:16};var Tp=(t=>(t[t.DXGI_FORMAT_UNKNOWN=0]="DXGI_FORMAT_UNKNOWN",t[t.DXGI_FORMAT_R32G32B32A32_TYPELESS=1]="DXGI_FORMAT_R32G32B32A32_TYPELESS",t[t.DXGI_FORMAT_R32G32B32A32_FLOAT=2]="DXGI_FORMAT_R32G32B32A32_FLOAT",t[t.DXGI_FORMAT_R32G32B32A32_UINT=3]="DXGI_FORMAT_R32G32B32A32_UINT",t[t.DXGI_FORMAT_R32G32B32A32_SINT=4]="DXGI_FORMAT_R32G32B32A32_SINT",t[t.DXGI_FORMAT_R32G32B32_TYPELESS=5]="DXGI_FORMAT_R32G32B32_TYPELESS",t[t.DXGI_FORMAT_R32G32B32_FLOAT=6]="DXGI_FORMAT_R32G32B32_FLOAT",t[t.DXGI_FORMAT_R32G32B32_UINT=7]="DXGI_FORMAT_R32G32B32_UINT",t[t.DXGI_FORMAT_R32G32B32_SINT=8]="DXGI_FORMAT_R32G32B32_SINT",t[t.DXGI_FORMAT_R16G16B16A16_TYPELESS=9]="DXGI_FORMAT_R16G16B16A16_TYPELESS",t[t.DXGI_FORMAT_R16G16B16A16_FLOAT=10]="DXGI_FORMAT_R16G16B16A16_FLOAT",t[t.DXGI_FORMAT_R16G16B16A16_UNORM=11]="DXGI_FORMAT_R16G16B16A16_UNORM",t[t.DXGI_FORMAT_R16G16B16A16_UINT=12]="DXGI_FORMAT_R16G16B16A16_UINT",t[t.DXGI_FORMAT_R16G16B16A16_SNORM=13]="DXGI_FORMAT_R16G16B16A16_SNORM",t[t.DXGI_FORMAT_R16G16B16A16_SINT=14]="DXGI_FORMAT_R16G16B16A16_SINT",t[t.DXGI_FORMAT_R32G32_TYPELESS=15]="DXGI_FORMAT_R32G32_TYPELESS",t[t.DXGI_FORMAT_R32G32_FLOAT=16]="DXGI_FORMAT_R32G32_FLOAT",t[t.DXGI_FORMAT_R32G32_UINT=17]="DXGI_FORMAT_R32G32_UINT",t[t.DXGI_FORMAT_R32G32_SINT=18]="DXGI_FORMAT_R32G32_SINT",t[t.DXGI_FORMAT_R32G8X24_TYPELESS=19]="DXGI_FORMAT_R32G8X24_TYPELESS",t[t.DXGI_FORMAT_D32_FLOAT_S8X24_UINT=20]="DXGI_FORMAT_D32_FLOAT_S8X24_UINT",t[t.DXGI_FORMAT_R32_FLOAT_X8X24_TYPELESS=21]="DXGI_FORMAT_R32_FLOAT_X8X24_TYPELESS",t[t.DXGI_FORMAT_X32_TYPELESS_G8X24_UINT=22]="DXGI_FORMAT_X32_TYPELESS_G8X24_UINT",t[t.DXGI_FORMAT_R10G10B10A2_TYPELESS=23]="DXGI_FORMAT_R10G10B10A2_TYPELESS",t[t.DXGI_FORMAT_R10G10B10A2_UNORM=24]="DXGI_FORMAT_R10G10B10A2_UNORM",t[t.DXGI_FORMAT_R10G10B10A2_UINT=25]="DXGI_FORMAT_R10G10B10A2_UINT",t[t.DXGI_FORMAT_R11G11B10_FLOAT=26]="DXGI_FORMAT_R11G11B10_FLOAT",t[t.DXGI_FORMAT_R8G8B8A8_TYPELESS=27]="DXGI_FORMAT_R8G8B8A8_TYPELESS",t[t.DXGI_FORMAT_R8G8B8A8_UNORM=28]="DXGI_FORMAT_R8G8B8A8_UNORM",t[t.DXGI_FORMAT_R8G8B8A8_UNORM_SRGB=29]="DXGI_FORMAT_R8G8B8A8_UNORM_SRGB",t[t.DXGI_FORMAT_R8G8B8A8_UINT=30]="DXGI_FORMAT_R8G8B8A8_UINT",t[t.DXGI_FORMAT_R8G8B8A8_SNORM=31]="DXGI_FORMAT_R8G8B8A8_SNORM",t[t.DXGI_FORMAT_R8G8B8A8_SINT=32]="DXGI_FORMAT_R8G8B8A8_SINT",t[t.DXGI_FORMAT_R16G16_TYPELESS=33]="DXGI_FORMAT_R16G16_TYPELESS",t[t.DXGI_FORMAT_R16G16_FLOAT=34]="DXGI_FORMAT_R16G16_FLOAT",t[t.DXGI_FORMAT_R16G16_UNORM=35]="DXGI_FORMAT_R16G16_UNORM",t[t.DXGI_FORMAT_R16G16_UINT=36]="DXGI_FORMAT_R16G16_UINT",t[t.DXGI_FORMAT_R16G16_SNORM=37]="DXGI_FORMAT_R16G16_SNORM",t[t.DXGI_FORMAT_R16G16_SINT=38]="DXGI_FORMAT_R16G16_SINT",t[t.DXGI_FORMAT_R32_TYPELESS=39]="DXGI_FORMAT_R32_TYPELESS",t[t.DXGI_FORMAT_D32_FLOAT=40]="DXGI_FORMAT_D32_FLOAT",t[t.DXGI_FORMAT_R32_FLOAT=41]="DXGI_FORMAT_R32_FLOAT",t[t.DXGI_FORMAT_R32_UINT=42]="DXGI_FORMAT_R32_UINT",t[t.DXGI_FORMAT_R32_SINT=43]="DXGI_FORMAT_R32_SINT",t[t.DXGI_FORMAT_R24G8_TYPELESS=44]="DXGI_FORMAT_R24G8_TYPELESS",t[t.DXGI_FORMAT_D24_UNORM_S8_UINT=45]="DXGI_FORMAT_D24_UNORM_S8_UINT",t[t.DXGI_FORMAT_R24_UNORM_X8_TYPELESS=46]="DXGI_FORMAT_R24_UNORM_X8_TYPELESS",t[t.DXGI_FORMAT_X24_TYPELESS_G8_UINT=47]="DXGI_FORMAT_X24_TYPELESS_G8_UINT",t[t.DXGI_FORMAT_R8G8_TYPELESS=48]="DXGI_FORMAT_R8G8_TYPELESS",t[t.DXGI_FORMAT_R8G8_UNORM=49]="DXGI_FORMAT_R8G8_UNORM",t[t.DXGI_FORMAT_R8G8_UINT=50]="DXGI_FORMAT_R8G8_UINT",t[t.DXGI_FORMAT_R8G8_SNORM=51]="DXGI_FORMAT_R8G8_SNORM",t[t.DXGI_FORMAT_R8G8_SINT=52]="DXGI_FORMAT_R8G8_SINT",t[t.DXGI_FORMAT_R16_TYPELESS=53]="DXGI_FORMAT_R16_TYPELESS",t[t.DXGI_FORMAT_R16_FLOAT=54]="DXGI_FORMAT_R16_FLOAT",t[t.DXGI_FORMAT_D16_UNORM=55]="DXGI_FORMAT_D16_UNORM",t[t.DXGI_FORMAT_R16_UNORM=56]="DXGI_FORMAT_R16_UNORM",t[t.DXGI_FORMAT_R16_UINT=57]="DXGI_FORMAT_R16_UINT",t[t.DXGI_FORMAT_R16_SNORM=58]="DXGI_FORMAT_R16_SNORM",t[t.DXGI_FORMAT_R16_SINT=59]="DXGI_FORMAT_R16_SINT",t[t.DXGI_FORMAT_R8_TYPELESS=60]="DXGI_FORMAT_R8_TYPELESS",t[t.DXGI_FORMAT_R8_UNORM=61]="DXGI_FORMAT_R8_UNORM",t[t.DXGI_FORMAT_R8_UINT=62]="DXGI_FORMAT_R8_UINT",t[t.DXGI_FORMAT_R8_SNORM=63]="DXGI_FORMAT_R8_SNORM",t[t.DXGI_FORMAT_R8_SINT=64]="DXGI_FORMAT_R8_SINT",t[t.DXGI_FORMAT_A8_UNORM=65]="DXGI_FORMAT_A8_UNORM",t[t.DXGI_FORMAT_R1_UNORM=66]="DXGI_FORMAT_R1_UNORM",t[t.DXGI_FORMAT_R9G9B9E5_SHAREDEXP=67]="DXGI_FORMAT_R9G9B9E5_SHAREDEXP",t[t.DXGI_FORMAT_R8G8_B8G8_UNORM=68]="DXGI_FORMAT_R8G8_B8G8_UNORM",t[t.DXGI_FORMAT_G8R8_G8B8_UNORM=69]="DXGI_FORMAT_G8R8_G8B8_UNORM",t[t.DXGI_FORMAT_BC1_TYPELESS=70]="DXGI_FORMAT_BC1_TYPELESS",t[t.DXGI_FORMAT_BC1_UNORM=71]="DXGI_FORMAT_BC1_UNORM",t[t.DXGI_FORMAT_BC1_UNORM_SRGB=72]="DXGI_FORMAT_BC1_UNORM_SRGB",t[t.DXGI_FORMAT_BC2_TYPELESS=73]="DXGI_FORMAT_BC2_TYPELESS",t[t.DXGI_FORMAT_BC2_UNORM=74]="DXGI_FORMAT_BC2_UNORM",t[t.DXGI_FORMAT_BC2_UNORM_SRGB=75]="DXGI_FORMAT_BC2_UNORM_SRGB",t[t.DXGI_FORMAT_BC3_TYPELESS=76]="DXGI_FORMAT_BC3_TYPELESS",t[t.DXGI_FORMAT_BC3_UNORM=77]="DXGI_FORMAT_BC3_UNORM",t[t.DXGI_FORMAT_BC3_UNORM_SRGB=78]="DXGI_FORMAT_BC3_UNORM_SRGB",t[t.DXGI_FORMAT_BC4_TYPELESS=79]="DXGI_FORMAT_BC4_TYPELESS",t[t.DXGI_FORMAT_BC4_UNORM=80]="DXGI_FORMAT_BC4_UNORM",t[t.DXGI_FORMAT_BC4_SNORM=81]="DXGI_FORMAT_BC4_SNORM",t[t.DXGI_FORMAT_BC5_TYPELESS=82]="DXGI_FORMAT_BC5_TYPELESS",t[t.DXGI_FORMAT_BC5_UNORM=83]="DXGI_FORMAT_BC5_UNORM",t[t.DXGI_FORMAT_BC5_SNORM=84]="DXGI_FORMAT_BC5_SNORM",t[t.DXGI_FORMAT_B5G6R5_UNORM=85]="DXGI_FORMAT_B5G6R5_UNORM",t[t.DXGI_FORMAT_B5G5R5A1_UNORM=86]="DXGI_FORMAT_B5G5R5A1_UNORM",t[t.DXGI_FORMAT_B8G8R8A8_UNORM=87]="DXGI_FORMAT_B8G8R8A8_UNORM",t[t.DXGI_FORMAT_B8G8R8X8_UNORM=88]="DXGI_FORMAT_B8G8R8X8_UNORM",t[t.DXGI_FORMAT_R10G10B10_XR_BIAS_A2_UNORM=89]="DXGI_FORMAT_R10G10B10_XR_BIAS_A2_UNORM",t[t.DXGI_FORMAT_B8G8R8A8_TYPELESS=90]="DXGI_FORMAT_B8G8R8A8_TYPELESS",t[t.DXGI_FORMAT_B8G8R8A8_UNORM_SRGB=91]="DXGI_FORMAT_B8G8R8A8_UNORM_SRGB",t[t.DXGI_FORMAT_B8G8R8X8_TYPELESS=92]="DXGI_FORMAT_B8G8R8X8_TYPELESS",t[t.DXGI_FORMAT_B8G8R8X8_UNORM_SRGB=93]="DXGI_FORMAT_B8G8R8X8_UNORM_SRGB",t[t.DXGI_FORMAT_BC6H_TYPELESS=94]="DXGI_FORMAT_BC6H_TYPELESS",t[t.DXGI_FORMAT_BC6H_UF16=95]="DXGI_FORMAT_BC6H_UF16",t[t.DXGI_FORMAT_BC6H_SF16=96]="DXGI_FORMAT_BC6H_SF16",t[t.DXGI_FORMAT_BC7_TYPELESS=97]="DXGI_FORMAT_BC7_TYPELESS",t[t.DXGI_FORMAT_BC7_UNORM=98]="DXGI_FORMAT_BC7_UNORM",t[t.DXGI_FORMAT_BC7_UNORM_SRGB=99]="DXGI_FORMAT_BC7_UNORM_SRGB",t[t.DXGI_FORMAT_AYUV=100]="DXGI_FORMAT_AYUV",t[t.DXGI_FORMAT_Y410=101]="DXGI_FORMAT_Y410",t[t.DXGI_FORMAT_Y416=102]="DXGI_FORMAT_Y416",t[t.DXGI_FORMAT_NV12=103]="DXGI_FORMAT_NV12",t[t.DXGI_FORMAT_P010=104]="DXGI_FORMAT_P010",t[t.DXGI_FORMAT_P016=105]="DXGI_FORMAT_P016",t[t.DXGI_FORMAT_420_OPAQUE=106]="DXGI_FORMAT_420_OPAQUE",t[t.DXGI_FORMAT_YUY2=107]="DXGI_FORMAT_YUY2",t[t.DXGI_FORMAT_Y210=108]="DXGI_FORMAT_Y210",t[t.DXGI_FORMAT_Y216=109]="DXGI_FORMAT_Y216",t[t.DXGI_FORMAT_NV11=110]="DXGI_FORMAT_NV11",t[t.DXGI_FORMAT_AI44=111]="DXGI_FORMAT_AI44",t[t.DXGI_FORMAT_IA44=112]="DXGI_FORMAT_IA44",t[t.DXGI_FORMAT_P8=113]="DXGI_FORMAT_P8",t[t.DXGI_FORMAT_A8P8=114]="DXGI_FORMAT_A8P8",t[t.DXGI_FORMAT_B4G4R4A4_UNORM=115]="DXGI_FORMAT_B4G4R4A4_UNORM",t[t.DXGI_FORMAT_P208=116]="DXGI_FORMAT_P208",t[t.DXGI_FORMAT_V208=117]="DXGI_FORMAT_V208",t[t.DXGI_FORMAT_V408=118]="DXGI_FORMAT_V408",t[t.DXGI_FORMAT_SAMPLER_FEEDBACK_MIN_MIP_OPAQUE=119]="DXGI_FORMAT_SAMPLER_FEEDBACK_MIN_MIP_OPAQUE",t[t.DXGI_FORMAT_SAMPLER_FEEDBACK_MIP_REGION_USED_OPAQUE=120]="DXGI_FORMAT_SAMPLER_FEEDBACK_MIP_REGION_USED_OPAQUE",t[t.DXGI_FORMAT_FORCE_UINT=121]="DXGI_FORMAT_FORCE_UINT",t))(Tp||{}),Sp=(t=>(t[t.DDS_DIMENSION_TEXTURE1D=2]="DDS_DIMENSION_TEXTURE1D",t[t.DDS_DIMENSION_TEXTURE2D=3]="DDS_DIMENSION_TEXTURE2D",t[t.DDS_DIMENSION_TEXTURE3D=6]="DDS_DIMENSION_TEXTURE3D",t))(Sp||{});function wp(t){return t.charCodeAt(0)+(t.charCodeAt(1)<<8)+(t.charCodeAt(2)<<16)+(t.charCodeAt(3)<<24)}var Ep=(t=>(t[t.UNKNOWN=0]="UNKNOWN",t[t.R8G8B8=20]="R8G8B8",t[t.A8R8G8B8=21]="A8R8G8B8",t[t.X8R8G8B8=22]="X8R8G8B8",t[t.R5G6B5=23]="R5G6B5",t[t.X1R5G5B5=24]="X1R5G5B5",t[t.A1R5G5B5=25]="A1R5G5B5",t[t.A4R4G4B4=26]="A4R4G4B4",t[t.R3G3B2=27]="R3G3B2",t[t.A8=28]="A8",t[t.A8R3G3B2=29]="A8R3G3B2",t[t.X4R4G4B4=30]="X4R4G4B4",t[t.A2B10G10R10=31]="A2B10G10R10",t[t.A8B8G8R8=32]="A8B8G8R8",t[t.X8B8G8R8=33]="X8B8G8R8",t[t.G16R16=34]="G16R16",t[t.A2R10G10B10=35]="A2R10G10B10",t[t.A16B16G16R16=36]="A16B16G16R16",t[t.A8P8=40]="A8P8",t[t.P8=41]="P8",t[t.L8=50]="L8",t[t.A8L8=51]="A8L8",t[t.A4L4=52]="A4L4",t[t.V8U8=60]="V8U8",t[t.L6V5U5=61]="L6V5U5",t[t.X8L8V8U8=62]="X8L8V8U8",t[t.Q8W8V8U8=63]="Q8W8V8U8",t[t.V16U16=64]="V16U16",t[t.A2W10V10U10=67]="A2W10V10U10",t[t.Q16W16V16U16=110]="Q16W16V16U16",t[t.R16F=111]="R16F",t[t.G16R16F=112]="G16R16F",t[t.A16B16G16R16F=113]="A16B16G16R16F",t[t.R32F=114]="R32F",t[t.G32R32F=115]="G32R32F",t[t.A32B32G32R32F=116]="A32B32G32R32F",t[t.UYVY=wp("UYVY")]="UYVY",t[t.R8G8_B8G8=wp("RGBG")]="R8G8_B8G8",t[t.YUY2=wp("YUY2")]="YUY2",t[t.D3DFMT_G8R8_G8B8=wp("GRGB")]="D3DFMT_G8R8_G8B8",t[t.DXT1=wp("DXT1")]="DXT1",t[t.DXT2=wp("DXT2")]="DXT2",t[t.DXT3=wp("DXT3")]="DXT3",t[t.DXT4=wp("DXT4")]="DXT4",t[t.DXT5=wp("DXT5")]="DXT5",t[t.ATI1=wp("ATI1")]="ATI1",t[t.AT1N=wp("AT1N")]="AT1N",t[t.ATI2=wp("ATI2")]="ATI2",t[t.AT2N=wp("AT2N")]="AT2N",t[t.BC4U=wp("BC4U")]="BC4U",t[t.BC4S=wp("BC4S")]="BC4S",t[t.BC5U=wp("BC5U")]="BC5U",t[t.BC5S=wp("BC5S")]="BC5S",t[t.DX10=wp("DX10")]="DX10",t))(Ep||{});const Ap={[Ep.DXT1]:"bc1-rgba-unorm",[Ep.DXT2]:"bc2-rgba-unorm",[Ep.DXT3]:"bc2-rgba-unorm",[Ep.DXT4]:"bc3-rgba-unorm",[Ep.DXT5]:"bc3-rgba-unorm",[Ep.ATI1]:"bc4-r-unorm",[Ep.BC4U]:"bc4-r-unorm",[Ep.BC4S]:"bc4-r-snorm",[Ep.ATI2]:"bc5-rg-unorm",[Ep.BC5U]:"bc5-rg-unorm",[Ep.BC5S]:"bc5-rg-snorm",36:"rgba16uint",110:"rgba16sint",111:"r16float",112:"rg16float",113:"rgba16float",114:"r32float",115:"rg32float",116:"rgba32float"},Mp={70:"bc1-rgba-unorm",71:"bc1-rgba-unorm",72:"bc1-rgba-unorm-srgb",73:"bc2-rgba-unorm",74:"bc2-rgba-unorm",75:"bc2-rgba-unorm-srgb",76:"bc3-rgba-unorm",77:"bc3-rgba-unorm",78:"bc3-rgba-unorm-srgb",79:"bc4-r-unorm",80:"bc4-r-unorm",81:"bc4-r-snorm",82:"bc5-rg-unorm",83:"bc5-rg-unorm",84:"bc5-rg-snorm",94:"bc6h-rgb-ufloat",95:"bc6h-rgb-ufloat",96:"bc6h-rgb-float",97:"bc7-rgba-unorm",98:"bc7-rgba-unorm",99:"bc7-rgba-unorm-srgb",28:"rgba8unorm",29:"rgba8unorm-srgb",87:"bgra8unorm",91:"bgra8unorm-srgb",41:"r32float",49:"rg8unorm",56:"r16uint",61:"r8unorm",24:"rgb10a2unorm",11:"rgba16uint",13:"rgba16sint",10:"rgba16float",54:"r16float",34:"rg16float",16:"rg32float",2:"rgba32float"},Pp={MAGIC_VALUE:542327876,MAGIC_SIZE:4,HEADER_SIZE:124,HEADER_DX10_SIZE:20,PIXEL_FORMAT_FLAGS:{ALPHAPIXELS:1,ALPHA:2,FOURCC:4,RGB:64,RGBA:65,YUV:512,LUMINANCE:131072,LUMINANCEA:131073},RESOURCE_MISC_TEXTURECUBE:4,HEADER_FIELDS:{MAGIC:0,SIZE:1,FLAGS:2,HEIGHT:3,WIDTH:4,MIPMAP_COUNT:7,PIXEL_FORMAT:19,PF_FLAGS:20,FOURCC:21,RGB_BITCOUNT:22,R_BIT_MASK:23,G_BIT_MASK:24,B_BIT_MASK:25,A_BIT_MASK:26},HEADER_DX10_FIELDS:{DXGI_FORMAT:0,RESOURCE_DIMENSION:1,MISC_FLAG:2,ARRAY_SIZE:3,MISC_FLAGS2:4},DXGI_FORMAT:Tp,D3D10_RESOURCE_DIMENSION:Sp,D3DFMT:Ep},Rp={"bc1-rgba-unorm":8,"bc1-rgba-unorm-srgb":8,"bc2-rgba-unorm":16,"bc2-rgba-unorm-srgb":16,"bc3-rgba-unorm":16,"bc3-rgba-unorm-srgb":16,"bc4-r-unorm":8,"bc4-r-snorm":8,"bc5-rg-unorm":16,"bc5-rg-snorm":16,"bc6h-rgb-ufloat":16,"bc6h-rgb-float":16,"bc7-rgba-unorm":16,"bc7-rgba-unorm-srgb":16};function Op(t,e){const{format:r,fourCC:s,width:i,height:n,dataOffset:o,mipmapCount:a}=function(t){const e=new Uint32Array(t,0,Pp.HEADER_SIZE/Uint32Array.BYTES_PER_ELEMENT);if(e[Pp.HEADER_FIELDS.MAGIC]!==Pp.MAGIC_VALUE)throw new Error("Invalid magic number in DDS header");const r=e[Pp.HEADER_FIELDS.HEIGHT],s=e[Pp.HEADER_FIELDS.WIDTH],i=Math.max(1,e[Pp.HEADER_FIELDS.MIPMAP_COUNT]),n=e[Pp.HEADER_FIELDS.PF_FLAGS],o=e[Pp.HEADER_FIELDS.FOURCC],a=function(t,e,r,s){if(e&Pp.PIXEL_FORMAT_FLAGS.FOURCC){if(r===Pp.D3DFMT.DX10){const t=new Uint32Array(s,Pp.MAGIC_SIZE+Pp.HEADER_SIZE,Pp.HEADER_DX10_SIZE/Uint32Array.BYTES_PER_ELEMENT);if(t[Pp.HEADER_DX10_FIELDS.MISC_FLAG]===Pp.RESOURCE_MISC_TEXTURECUBE)throw new Error("DDSParser does not support cubemap textures");if(t[Pp.HEADER_DX10_FIELDS.RESOURCE_DIMENSION]===Pp.D3D10_RESOURCE_DIMENSION.DDS_DIMENSION_TEXTURE3D)throw new Error("DDSParser does not supported 3D texture data");const e=t[Pp.HEADER_DX10_FIELDS.DXGI_FORMAT];if(e in Mp)return Mp[e];throw new Error(`DDSParser cannot parse texture data with DXGI format ${e}`)}if(r in Ap)return Ap[r];throw new Error(`DDSParser cannot parse texture data with fourCC format ${r}`)}if(e&Pp.PIXEL_FORMAT_FLAGS.RGB||e&Pp.PIXEL_FORMAT_FLAGS.RGBA)return function(t){const e=t[Pp.HEADER_FIELDS.RGB_BITCOUNT],r=t[Pp.HEADER_FIELDS.R_BIT_MASK],s=t[Pp.HEADER_FIELDS.G_BIT_MASK],i=t[Pp.HEADER_FIELDS.B_BIT_MASK],n=t[Pp.HEADER_FIELDS.A_BIT_MASK];switch(e){case 32:if(255===r&&65280===s&&16711680===i&&4278190080===n)return Mp[Pp.DXGI_FORMAT.DXGI_FORMAT_R8G8B8A8_UNORM];if(16711680===r&&65280===s&&255===i&&4278190080===n)return Mp[Pp.DXGI_FORMAT.DXGI_FORMAT_B8G8R8A8_UNORM];if(1072693248===r&&1047552===s&&1023===i&&3221225472===n)return Mp[Pp.DXGI_FORMAT.DXGI_FORMAT_R10G10B10A2_UNORM];if(65535===r&&4294901760===s&&0===i&&0===n)return Mp[Pp.DXGI_FORMAT.DXGI_FORMAT_R16G16_UNORM];if(4294967295===r&&0===s&&0===i&&0===n)return Mp[Pp.DXGI_FORMAT.DXGI_FORMAT_R32_FLOAT];break;case 24:break;case 16:if(31744===r&&992===s&&31===i&&32768===n)return Mp[Pp.DXGI_FORMAT.DXGI_FORMAT_B5G5R5A1_UNORM];if(63488===r&&2016===s&&31===i&&0===n)return Mp[Pp.DXGI_FORMAT.DXGI_FORMAT_B5G6R5_UNORM];if(3840===r&&240===s&&15===i&&61440===n)return Mp[Pp.DXGI_FORMAT.DXGI_FORMAT_B4G4R4A4_UNORM];if(255===r&&0===s&&0===i&&65280===n)return Mp[Pp.DXGI_FORMAT.DXGI_FORMAT_R8G8_UNORM];if(65535===r&&0===s&&0===i&&0===n)return Mp[Pp.DXGI_FORMAT.DXGI_FORMAT_R16_UNORM];break;case 8:if(255===r&&0===s&&0===i&&0===n)return Mp[Pp.DXGI_FORMAT.DXGI_FORMAT_R8_UNORM]}throw new Error(`DDSParser does not support uncompressed texture with configuration:\n                bitCount = ${e}, rBitMask = ${r}, gBitMask = ${s}, aBitMask = ${n}`)}(t);throw e&Pp.PIXEL_FORMAT_FLAGS.YUV?new Error("DDSParser does not supported YUV uncompressed texture data."):e&Pp.PIXEL_FORMAT_FLAGS.LUMINANCE||e&Pp.PIXEL_FORMAT_FLAGS.LUMINANCEA?new Error("DDSParser does not support single-channel (lumninance) texture data!"):e&Pp.PIXEL_FORMAT_FLAGS.ALPHA||e&Pp.PIXEL_FORMAT_FLAGS.ALPHAPIXELS?new Error("DDSParser does not support single-channel (alpha) texture data!"):new Error("DDSParser failed to load a texture file due to an unknown reason!")}(e,n,o,t),l=Pp.MAGIC_SIZE+Pp.HEADER_SIZE+(o===Pp.D3DFMT.DX10?Pp.HEADER_DX10_SIZE:0);return{format:a,fourCC:o,width:s,height:r,dataOffset:l,mipmapCount:i}}(t);if(!e.includes(r))throw new Error(`Unsupported texture format: ${s} ${r}, supported: ${e}`);if(a<=1)return{format:r,width:i,height:n,resource:[new Uint8Array(t,o)],alphaMode:"no-premultiply-alpha"};const l=function(t,e,r,s,i,n){const o=[],a=Rp[t];let l=e,h=r,u=s;for(let t=0;t<i;++t){const t=a?Math.max(4,l)/4*Math.max(4,h)/4*a:l*h*4,e=new Uint8Array(n,u,t);o.push(e),u+=t,l=Math.max(l>>1,1),h=Math.max(h>>1,1)}return o}(r,i,n,o,a,t);return{format:r,width:i,height:n,resource:l,alphaMode:"no-premultiply-alpha"}}const Cp={extension:{type:u.LoadParser,priority:Be.High},name:"loadDDS",test:t=>$c(t,[".dds"]),async load(t,e,r){const s=await pp(),i=Op(await(await fetch(t)).arrayBuffer(),s);return fd(new ip(i),r,t)},unload(t){Array.isArray(t)?t.forEach((t=>t.destroy(!0))):t.destroy(!0)}};var Ip=(t=>(t[t.RGBA8_SNORM=36759]="RGBA8_SNORM",t[t.RGBA=6408]="RGBA",t[t.RGBA8UI=36220]="RGBA8UI",t[t.SRGB8_ALPHA8=35907]="SRGB8_ALPHA8",t[t.RGBA8I=36238]="RGBA8I",t[t.RGBA8=32856]="RGBA8",t[t.COMPRESSED_RGB_S3TC_DXT1_EXT=33776]="COMPRESSED_RGB_S3TC_DXT1_EXT",t[t.COMPRESSED_RGBA_S3TC_DXT1_EXT=33777]="COMPRESSED_RGBA_S3TC_DXT1_EXT",t[t.COMPRESSED_RGBA_S3TC_DXT3_EXT=33778]="COMPRESSED_RGBA_S3TC_DXT3_EXT",t[t.COMPRESSED_RGBA_S3TC_DXT5_EXT=33779]="COMPRESSED_RGBA_S3TC_DXT5_EXT",t[t.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT=35917]="COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT",t[t.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT=35918]="COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT",t[t.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT=35919]="COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT",t[t.COMPRESSED_SRGB_S3TC_DXT1_EXT=35916]="COMPRESSED_SRGB_S3TC_DXT1_EXT",t[t.COMPRESSED_RED_RGTC1_EXT=36283]="COMPRESSED_RED_RGTC1_EXT",t[t.COMPRESSED_SIGNED_RED_RGTC1_EXT=36284]="COMPRESSED_SIGNED_RED_RGTC1_EXT",t[t.COMPRESSED_RED_GREEN_RGTC2_EXT=36285]="COMPRESSED_RED_GREEN_RGTC2_EXT",t[t.COMPRESSED_SIGNED_RED_GREEN_RGTC2_EXT=36286]="COMPRESSED_SIGNED_RED_GREEN_RGTC2_EXT",t[t.COMPRESSED_R11_EAC=37488]="COMPRESSED_R11_EAC",t[t.COMPRESSED_SIGNED_R11_EAC=37489]="COMPRESSED_SIGNED_R11_EAC",t[t.COMPRESSED_RG11_EAC=37490]="COMPRESSED_RG11_EAC",t[t.COMPRESSED_SIGNED_RG11_EAC=37491]="COMPRESSED_SIGNED_RG11_EAC",t[t.COMPRESSED_RGB8_ETC2=37492]="COMPRESSED_RGB8_ETC2",t[t.COMPRESSED_RGBA8_ETC2_EAC=37496]="COMPRESSED_RGBA8_ETC2_EAC",t[t.COMPRESSED_SRGB8_ETC2=37493]="COMPRESSED_SRGB8_ETC2",t[t.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC=37497]="COMPRESSED_SRGB8_ALPHA8_ETC2_EAC",t[t.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2=37494]="COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2",t[t.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2=37495]="COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2",t[t.COMPRESSED_RGBA_ASTC_4x4_KHR=37808]="COMPRESSED_RGBA_ASTC_4x4_KHR",t[t.COMPRESSED_RGBA_ASTC_5x4_KHR=37809]="COMPRESSED_RGBA_ASTC_5x4_KHR",t[t.COMPRESSED_RGBA_ASTC_5x5_KHR=37810]="COMPRESSED_RGBA_ASTC_5x5_KHR",t[t.COMPRESSED_RGBA_ASTC_6x5_KHR=37811]="COMPRESSED_RGBA_ASTC_6x5_KHR",t[t.COMPRESSED_RGBA_ASTC_6x6_KHR=37812]="COMPRESSED_RGBA_ASTC_6x6_KHR",t[t.COMPRESSED_RGBA_ASTC_8x5_KHR=37813]="COMPRESSED_RGBA_ASTC_8x5_KHR",t[t.COMPRESSED_RGBA_ASTC_8x6_KHR=37814]="COMPRESSED_RGBA_ASTC_8x6_KHR",t[t.COMPRESSED_RGBA_ASTC_8x8_KHR=37815]="COMPRESSED_RGBA_ASTC_8x8_KHR",t[t.COMPRESSED_RGBA_ASTC_10x5_KHR=37816]="COMPRESSED_RGBA_ASTC_10x5_KHR",t[t.COMPRESSED_RGBA_ASTC_10x6_KHR=37817]="COMPRESSED_RGBA_ASTC_10x6_KHR",t[t.COMPRESSED_RGBA_ASTC_10x8_KHR=37818]="COMPRESSED_RGBA_ASTC_10x8_KHR",t[t.COMPRESSED_RGBA_ASTC_10x10_KHR=37819]="COMPRESSED_RGBA_ASTC_10x10_KHR",t[t.COMPRESSED_RGBA_ASTC_12x10_KHR=37820]="COMPRESSED_RGBA_ASTC_12x10_KHR",t[t.COMPRESSED_RGBA_ASTC_12x12_KHR=37821]="COMPRESSED_RGBA_ASTC_12x12_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR=37840]="COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR=37841]="COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR=37842]="COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR=37843]="COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR=37844]="COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR=37845]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR=37846]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR=37847]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR=37848]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR=37849]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR=37850]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR=37851]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR=37852]="COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR=37853]="COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR",t[t.COMPRESSED_RGBA_BPTC_UNORM_EXT=36492]="COMPRESSED_RGBA_BPTC_UNORM_EXT",t[t.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT=36493]="COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT",t[t.COMPRESSED_RGB_BPTC_SIGNED_FLOAT_EXT=36494]="COMPRESSED_RGB_BPTC_SIGNED_FLOAT_EXT",t[t.COMPRESSED_RGB_BPTC_UNSIGNED_FLOAT_EXT=36495]="COMPRESSED_RGB_BPTC_UNSIGNED_FLOAT_EXT",t))(Ip||{}),Gp=(t=>(t[t.RGBA=6408]="RGBA",t[t.RGB=6407]="RGB",t[t.RG=33319]="RG",t[t.RED=6403]="RED",t[t.RGBA_INTEGER=36249]="RGBA_INTEGER",t[t.RGB_INTEGER=36248]="RGB_INTEGER",t[t.RG_INTEGER=33320]="RG_INTEGER",t[t.RED_INTEGER=36244]="RED_INTEGER",t[t.ALPHA=6406]="ALPHA",t[t.LUMINANCE=6409]="LUMINANCE",t[t.LUMINANCE_ALPHA=6410]="LUMINANCE_ALPHA",t[t.DEPTH_COMPONENT=6402]="DEPTH_COMPONENT",t[t.DEPTH_STENCIL=34041]="DEPTH_STENCIL",t))(Gp||{}),kp=(t=>(t[t.UNSIGNED_BYTE=5121]="UNSIGNED_BYTE",t[t.UNSIGNED_SHORT=5123]="UNSIGNED_SHORT",t[t.UNSIGNED_SHORT_5_6_5=33635]="UNSIGNED_SHORT_5_6_5",t[t.UNSIGNED_SHORT_4_4_4_4=32819]="UNSIGNED_SHORT_4_4_4_4",t[t.UNSIGNED_SHORT_5_5_5_1=32820]="UNSIGNED_SHORT_5_5_5_1",t[t.UNSIGNED_INT=5125]="UNSIGNED_INT",t[t.UNSIGNED_INT_10F_11F_11F_REV=35899]="UNSIGNED_INT_10F_11F_11F_REV",t[t.UNSIGNED_INT_2_10_10_10_REV=33640]="UNSIGNED_INT_2_10_10_10_REV",t[t.UNSIGNED_INT_24_8=34042]="UNSIGNED_INT_24_8",t[t.UNSIGNED_INT_5_9_9_9_REV=35902]="UNSIGNED_INT_5_9_9_9_REV",t[t.BYTE=5120]="BYTE",t[t.SHORT=5122]="SHORT",t[t.INT=5124]="INT",t[t.FLOAT=5126]="FLOAT",t[t.FLOAT_32_UNSIGNED_INT_24_8_REV=36269]="FLOAT_32_UNSIGNED_INT_24_8_REV",t[t.HALF_FLOAT=36193]="HALF_FLOAT",t))(kp||{});const Bp={FILE_HEADER_SIZE:64,FILE_IDENTIFIER:[171,75,84,88,32,49,49,187,13,10,26,10],FORMATS_TO_COMPONENTS:{6408:4,6407:3,33319:2,6403:1,6409:1,6410:2,6406:1},INTERNAL_FORMAT_TO_BYTES_PER_PIXEL:{33776:.5,33777:.5,33778:1,33779:1,35916:.5,35917:.5,35918:1,35919:1,36283:.5,36284:.5,36285:1,36286:1,37488:.5,37489:.5,37490:1,37491:1,37492:.5,37496:1,37493:.5,37497:1,37494:.5,37495:.5,37808:1,37840:1,37809:.8,37841:.8,37810:.64,37842:.64,37811:.53375,37843:.53375,37812:.445,37844:.445,37813:.4,37845:.4,37814:.33375,37846:.33375,37815:.25,37847:.25,37816:.32,37848:.32,37817:.26625,37849:.26625,37818:.2,37850:.2,37819:.16,37851:.16,37820:.13375,37852:.13375,37821:.11125,37853:.11125,36492:1,36493:1,36494:1,36495:1},INTERNAL_FORMAT_TO_TEXTURE_FORMATS:{33776:"bc1-rgba-unorm",33777:"bc1-rgba-unorm",33778:"bc2-rgba-unorm",33779:"bc3-rgba-unorm",35916:"bc1-rgba-unorm-srgb",35917:"bc1-rgba-unorm-srgb",35918:"bc2-rgba-unorm-srgb",35919:"bc3-rgba-unorm-srgb",36283:"bc4-r-unorm",36284:"bc4-r-snorm",36285:"bc5-rg-unorm",36286:"bc5-rg-snorm",37488:"eac-r11unorm",37490:"eac-rg11snorm",37492:"etc2-rgb8unorm",37496:"etc2-rgba8unorm",37493:"etc2-rgb8unorm-srgb",37497:"etc2-rgba8unorm-srgb",37494:"etc2-rgb8a1unorm",37495:"etc2-rgb8a1unorm-srgb",37808:"astc-4x4-unorm",37840:"astc-4x4-unorm-srgb",37809:"astc-5x4-unorm",37841:"astc-5x4-unorm-srgb",37810:"astc-5x5-unorm",37842:"astc-5x5-unorm-srgb",37811:"astc-6x5-unorm",37843:"astc-6x5-unorm-srgb",37812:"astc-6x6-unorm",37844:"astc-6x6-unorm-srgb",37813:"astc-8x5-unorm",37845:"astc-8x5-unorm-srgb",37814:"astc-8x6-unorm",37846:"astc-8x6-unorm-srgb",37815:"astc-8x8-unorm",37847:"astc-8x8-unorm-srgb",37816:"astc-10x5-unorm",37848:"astc-10x5-unorm-srgb",37817:"astc-10x6-unorm",37849:"astc-10x6-unorm-srgb",37818:"astc-10x8-unorm",37850:"astc-10x8-unorm-srgb",37819:"astc-10x10-unorm",37851:"astc-10x10-unorm-srgb",37820:"astc-12x10-unorm",37852:"astc-12x10-unorm-srgb",37821:"astc-12x12-unorm",37853:"astc-12x12-unorm-srgb",36492:"bc7-rgba-unorm",36493:"bc7-rgba-unorm-srgb",36494:"bc6h-rgb-float",36495:"bc6h-rgb-ufloat",35907:"rgba8unorm-srgb",36759:"rgba8snorm",36220:"rgba8uint",36238:"rgba8sint",6408:"rgba8unorm"},FIELDS:{FILE_IDENTIFIER:0,ENDIANNESS:12,GL_TYPE:16,GL_TYPE_SIZE:20,GL_FORMAT:24,GL_INTERNAL_FORMAT:28,GL_BASE_INTERNAL_FORMAT:32,PIXEL_WIDTH:36,PIXEL_HEIGHT:40,PIXEL_DEPTH:44,NUMBER_OF_ARRAY_ELEMENTS:48,NUMBER_OF_FACES:52,NUMBER_OF_MIPMAP_LEVELS:56,BYTES_OF_KEY_VALUE_DATA:60},TYPES_TO_BYTES_PER_COMPONENT:{5121:1,5123:2,5124:4,5125:4,5126:4,36193:8},TYPES_TO_BYTES_PER_PIXEL:{32819:2,32820:2,33635:2},ENDIANNESS:67305985};function Dp(t,e){const r=new DataView(t);if(!function(t){for(let e=0;e<Bp.FILE_IDENTIFIER.length;e++)if(t.getUint8(e)!==Bp.FILE_IDENTIFIER[e])return!1;return!0}(r))throw new Error("Invalid KTX identifier in header");const{littleEndian:s,glType:i,glFormat:n,glInternalFormat:o,pixelWidth:a,pixelHeight:l,numberOfMipmapLevels:h,offset:u}=function(t){const e=t.getUint32(Bp.FIELDS.ENDIANNESS,!0)===Bp.ENDIANNESS,r=t.getUint32(Bp.FIELDS.GL_TYPE,e),s=t.getUint32(Bp.FIELDS.GL_FORMAT,e),i=t.getUint32(Bp.FIELDS.GL_INTERNAL_FORMAT,e),n=t.getUint32(Bp.FIELDS.PIXEL_WIDTH,e),o=t.getUint32(Bp.FIELDS.PIXEL_HEIGHT,e)||1,a=t.getUint32(Bp.FIELDS.PIXEL_DEPTH,e)||1,l=t.getUint32(Bp.FIELDS.NUMBER_OF_ARRAY_ELEMENTS,e)||1,h=t.getUint32(Bp.FIELDS.NUMBER_OF_FACES,e),u=t.getUint32(Bp.FIELDS.NUMBER_OF_MIPMAP_LEVELS,e),c=t.getUint32(Bp.FIELDS.BYTES_OF_KEY_VALUE_DATA,e);if(0===o||1!==a)throw new Error("Only 2D textures are supported");if(1!==h)throw new Error("CubeTextures are not supported by KTXLoader yet!");if(1!==l)throw new Error("WebGL does not support array textures");return{littleEndian:e,glType:r,glFormat:s,glInternalFormat:i,pixelWidth:n,pixelHeight:o,numberOfMipmapLevels:u,offset:Bp.FILE_HEADER_SIZE+c}}(r),c=Bp.INTERNAL_FORMAT_TO_TEXTURE_FORMATS[o];if(!c)throw new Error(`Unknown texture format ${o}`);if(!e.includes(c))throw new Error(`Unsupported texture format: ${c}, supportedFormats: ${e}`);const d=function(t,e,r){let s=Bp.INTERNAL_FORMAT_TO_BYTES_PER_PIXEL[r];if(0!==t&&(s=Bp.TYPES_TO_BYTES_PER_COMPONENT[t]?Bp.TYPES_TO_BYTES_PER_COMPONENT[t]*Bp.FORMATS_TO_COMPONENTS[e]:Bp.TYPES_TO_BYTES_PER_PIXEL[t]),void 0===s)throw new Error("Unable to resolve the pixel format stored in the *.ktx file!");return s}(i,n,o),p=function(t,e,r,s,i,n,o,a){const l=s+3&-4,h=i+3&-4;let u=s*i;0===e&&(u=l*h);let c=u*r,d=s,p=i,f=l,g=h,m=n;const _=new Array(o);for(let e=0;e<o;e++){const s=t.getUint32(m,a);let i=m+4;_[e]=new Uint8Array(t.buffer,i,c),i+=c,m+=s+4,m=m%4!=0?m+4-m%4:m,d=d>>1||1,p=p>>1||1,f=d+4-1&-4,g=p+4-1&-4,c=f*g*r}return _}(r,i,d,a,l,u,h,s);return{format:c,width:a,height:l,resource:p,alphaMode:"no-premultiply-alpha"}}const Fp={extension:{type:u.LoadParser,priority:Be.High},name:"loadKTX",test:t=>$c(t,".ktx"),async load(t,e,r){const s=await pp(),i=Dp(await(await fetch(t)).arrayBuffer(),s);return fd(new ip(i),r,t)},unload(t){Array.isArray(t)?t.forEach((t=>t.destroy(!0))):t.destroy(!0)}};let Np=null;class Up{constructor(){Np||(Np=URL.createObjectURL(new Blob(['(function(){"use strict";const s={rgb8unorm:{convertedFormat:"rgba8unorm",convertFunction:i},"rgb8unorm-srgb":{convertedFormat:"rgba8unorm-srgb",convertFunction:i}};function f(r){const t=r.format;if(s[t]){const n=s[t].convertFunction,o=r.resource;for(let e=0;e<o.length;e++)o[e]=n(o[e]);r.format=s[t].convertedFormat}}function i(r){const t=r.byteLength/3,n=new Uint32Array(t);for(let o=0;o<t;++o)n[o]=r[o*3]+(r[o*3+1]<<8)+(r[o*3+2]<<16)+4278190080;return new Uint8Array(n.buffer)}function d(r){const t=[];for(let n=0;n<r.numLevels;n++){const o=r.getImageData(n,0,0),e=new Uint8Array(o.byteLength);e.set(o),t.push(e)}return t}const w={6408:"rgba8unorm",32856:"bgra8unorm",32857:"rgb10a2unorm",33189:"depth16unorm",33190:"depth24plus",33321:"r8unorm",33323:"rg8unorm",33325:"r16float",33326:"r32float",33327:"rg16float",33328:"rg32float",33329:"r8sint",33330:"r8uint",33331:"r16sint",33332:"r16uint",33333:"r32sint",33334:"r32uint",33335:"rg8sint",33336:"rg8uint",33337:"rg16sint",33338:"rg16uint",33339:"rg32sint",33340:"rg32uint",33778:"bc2-rgba-unorm",33779:"bc3-rgba-unorm",34836:"rgba32float",34842:"rgba16float",35056:"depth24plus-stencil8",35898:"rg11b10ufloat",35901:"rgb9e5ufloat",35907:"rgba8unorm-srgb",36012:"depth32float",36013:"depth32float-stencil8",36168:"stencil8",36208:"rgba32uint",36214:"rgba16uint",36220:"rgba8uint",36226:"rgba32sint",36232:"rgba16sint",36238:"rgba8sint",36492:"bc7-rgba-unorm",36756:"r8snorm",36757:"rg8snorm",36759:"rgba8snorm",37496:"etc2-rgba8unorm",37808:"astc-4x4-unorm"};function p(r){const t=w[r];if(t)return t;throw new Error(`Unsupported glInternalFormat: ${r}`)}const h={23:"rgb8unorm",37:"rgba8unorm",43:"rgba8unorm-srgb"};function F(r){const t=h[r];if(t)return t;throw new Error(`Unsupported VkFormat: ${r}`)}function U(r){return r.classId===2?F(r.vkFormat):p(r.glInternalformat)}const T={"bc3-rgba-unorm":"BC3_RGBA","bc7-rgba-unorm":"BC7_M5_RGBA","etc2-rgba8unorm":"ETC2_RGBA","astc-4x4-unorm":"ASTC_4x4_RGBA",rgba8unorm:"RGBA32",rg11b10ufloat:"R11F_G11F_B10F"};function y(r){const t=T[r];if(t)return t;throw new Error(`Unsupported transcoderFormat: ${r}`)}const a={jsUrl:"",wasmUrl:""};let l,u,c;async function g(){if(!c){const r=new URL(a.jsUrl,location.origin).href,t=new URL(a.wasmUrl,location.origin).href;importScripts(r),c=new Promise(n=>{LIBKTX({locateFile:o=>t}).then(o=>{n(o)})})}return c}async function v(r,t){const n=await fetch(r);if(n.ok){const o=await n.arrayBuffer();return new t.ktxTexture(new Uint8Array(o))}throw new Error(`Failed to load KTX(2) texture: ${r}`)}const x=["bc7-rgba-unorm","astc-4x4-unorm","etc2-rgba8unorm","bc3-rgba-unorm","rgba8unorm"];async function B(r){const t=await g(),n=await v(r,t);let o;if(n.needsTranscoding){o=u;const R=t.TranscodeTarget[l];if(n.transcodeBasis(R,0)!==t.ErrorCode.SUCCESS)throw new Error("Unable to transcode basis texture.")}else o=U(n);const e=d(n),b={width:n.baseWidth,height:n.baseHeight,format:o,mipLevelCount:n.numLevels,resource:e,alphaMode:"no-premultiply-alpha"};return f(b),b}async function A(r,t,n){r&&(a.jsUrl=r),t&&(a.wasmUrl=t),u=x.filter(o=>n.includes(o))[0],l=y(u),await g()}const m={init:async r=>{const{jsUrl:t,wasmUrl:n,supportedTextures:o}=r;await A(t,n,o)},load:async r=>{var t;try{const n=await B(r.url);return{type:"load",url:r.url,success:!0,textureOptions:n,transferables:(t=n.resource)==null?void 0:t.map(o=>o.buffer)}}catch(n){throw n}}};self.onmessage=async r=>{var t;const n=r.data,o=await((t=m[n.type])==null?void 0:t.call(m,n));o&&self.postMessage(o,o.transferables)}})();\n'],{type:"application/javascript"}))),this.worker=new Worker(Np)}}Up.revokeObjectURL=function(){Np&&(URL.revokeObjectURL(Np),Np=null)};const Lp={jsUrl:"https://files.pixijs.download/transcoders/ktx/libktx.js",wasmUrl:"https://files.pixijs.download/transcoders/ktx/libktx.wasm"};let Xp;const zp={};function Hp(t,e){const r=function(t){return Xp||(Xp=(new Up).worker,Xp.onmessage=t=>{const{success:e,url:r,textureOptions:s}=t.data;e||console.warn("Failed to load KTX texture",r),zp[r](s)},Xp.postMessage({type:"init",jsUrl:Lp.jsUrl,wasmUrl:Lp.wasmUrl,supportedTextures:t})),Xp}(e);return new Promise((e=>{zp[t]=e,r.postMessage({type:"load",url:t})}))}const jp={extension:{type:u.LoadParser,priority:Be.High},name:"loadKTX2",test:t=>$c(t,".ktx2"),async load(t,e,r){const s=await pp(),i=await Hp(t,s);return fd(new ip(i),r,t)},unload(t){Array.isArray(t)?t.forEach((t=>t.destroy(!0))):t.destroy(!0)}},Vp={rgb8unorm:{convertedFormat:"rgba8unorm",convertFunction:Wp},"rgb8unorm-srgb":{convertedFormat:"rgba8unorm-srgb",convertFunction:Wp}};function Wp(t){const e=t.byteLength/3,r=new Uint32Array(e);for(let s=0;s<e;++s)r[s]=t[3*s]+(t[3*s+1]<<8)+(t[3*s+2]<<16)+4278190080;return new Uint8Array(r.buffer)}const $p={6408:"rgba8unorm",32856:"bgra8unorm",32857:"rgb10a2unorm",33189:"depth16unorm",33190:"depth24plus",33321:"r8unorm",33323:"rg8unorm",33325:"r16float",33326:"r32float",33327:"rg16float",33328:"rg32float",33329:"r8sint",33330:"r8uint",33331:"r16sint",33332:"r16uint",33333:"r32sint",33334:"r32uint",33335:"rg8sint",33336:"rg8uint",33337:"rg16sint",33338:"rg16uint",33339:"rg32sint",33340:"rg32uint",33778:"bc2-rgba-unorm",33779:"bc3-rgba-unorm",34836:"rgba32float",34842:"rgba16float",35056:"depth24plus-stencil8",35898:"rg11b10ufloat",35901:"rgb9e5ufloat",35907:"rgba8unorm-srgb",36012:"depth32float",36013:"depth32float-stencil8",36168:"stencil8",36208:"rgba32uint",36214:"rgba16uint",36220:"rgba8uint",36226:"rgba32sint",36232:"rgba16sint",36238:"rgba8sint",36492:"bc7-rgba-unorm",36756:"r8snorm",36757:"rg8snorm",36759:"rgba8snorm",37496:"etc2-rgba8unorm",37808:"astc-4x4-unorm"};function Yp(t){const e=$p[t];if(e)return e;throw new Error(`Unsupported glInternalFormat: ${t}`)}const qp={23:"rgb8unorm",37:"rgba8unorm",43:"rgba8unorm-srgb"};function Kp(t){const e=qp[t];if(e)return e;throw new Error(`Unsupported VkFormat: ${t}`)}const Zp={"bc3-rgba-unorm":"BC3_RGBA","bc7-rgba-unorm":"BC7_M5_RGBA","etc2-rgba8unorm":"ETC2_RGBA","astc-4x4-unorm":"ASTC_4x4_RGBA",rgba8unorm:"RGBA32",rg11b10ufloat:"R11F_G11F_B10F"};const Qp=["basis","bc7","bc6h","astc","etc2","bc5","bc4","bc3","bc2","bc1","eac"],Jp={extension:u.ResolveParser,test:t=>$c(t,[".ktx",".ktx2",".dds"]),parse:t=>{var e,r;let s;const i=t.split(".");if(i.length>2){const t=i[i.length-2];Qp.includes(t)&&(s=t)}else s=i[i.length-1];return{resolution:parseFloat(null!=(r=null==(e=tr.RETINA_PREFIX.exec(t))?void 0:e[1])?r:"1"),format:s,src:t}}};let tf;const ef={extension:{type:u.DetectionParser,priority:2},test:async()=>!(!await uc()&&!hc()),add:async t=>{const e=await up();return tf=function(t){const e=["basis"],r={};return t.forEach((t=>{const s=t.split("-")[0];s&&!r[s]&&(r[s]=!0,e.push(s))})),e.sort(((t,e)=>{const r=Qp.indexOf(t),s=Qp.indexOf(e);return-1===r?1:-1===s?-1:r-s})),e}(e),[...tf,...t]},remove:async t=>tf?t.filter((t=>!(t in tf))):t};const rf=new St,sf=class{cull(t,e,r=!0){this._cullRecursive(t,e,r)}_cullRecursive(t,e,r=!0){var s;if(t.cullable&&t.measurable&&t.includeInBuild){const i=null!=(s=t.cullArea)?s:At(t,r,rf);t.culled=!(i.x>=e.x+e.width||i.y>=e.y+e.height||i.x+i.width<=e.x||i.y+i.height<=e.y)}if(t.cullableChildren&&!t.culled&&t.renderable&&t.measurable&&t.includeInBuild)for(let s=0;s<t.children.length;s++)this._cullRecursive(t.children[s],e,r)}};sf.shared=new sf;let nf=sf;class of{static init(){this._renderRef=this.render.bind(this),this.render=()=>{nf.shared.cull(this.stage,this.renderer.screen),this.renderer.render({container:this.stage})}}static destroy(){this.render=this._renderRef}}of.extension={priority:10,type:u.Application,name:"culler"};const af={extension:{type:u.Environment,name:"browser",priority:-1},test:()=>!0,load:async()=>{await Promise.resolve().then((function(){return Vu}))}};var lf=Object.defineProperty,hf=Object.getOwnPropertySymbols,uf=Object.prototype.hasOwnProperty,cf=Object.prototype.propertyIsEnumerable,df=(t,e,r)=>e in t?lf(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r,pf=(t,e)=>{for(var r in e||(e={}))uf.call(e,r)&&df(t,r,e[r]);if(hf)for(var r of hf(e))cf.call(e,r)&&df(t,r,e[r]);return t};const ff=class t extends fh{constructor(e){super(e=pf(pf({},t.defaultOptions),e)),this.enabled=!0,this._state=an.for2d(),this.padding=e.padding,"boolean"==typeof e.antialias?this.antialias=e.antialias?"on":"off":this.antialias=e.antialias,this.resolution=e.resolution,this.blendRequired=e.blendRequired,this.addResource("uTexture",0,1)}apply(t,e,r,s){t.applyFilter(this,e,r,s)}get blendMode(){return this._state.blendMode}set blendMode(t){this._state.blendMode=t}static from(e){const r=e,{gpu:s,gl:i}=r,n=((t,e)=>{var r={};for(var s in t)uf.call(t,s)&&e.indexOf(s)<0&&(r[s]=t[s]);if(null!=t&&hf)for(var s of hf(t))e.indexOf(s)<0&&cf.call(t,s)&&(r[s]=t[s]);return r})(r,["gpu","gl"]);let o,a;return s&&(o=yl.from(s)),i&&(a=ll.from(i)),new t(pf({gpuProgram:o,glProgram:a},n))}};ff.defaultOptions={blendMode:"normal",resolution:1,padding:0,antialias:"off",blendRequired:!1};let gf=ff;var mf="\nin vec2 vTextureCoord;\nin vec4 vColor;\n\nout vec4 finalColor;\n\nuniform float uBlend;\n\nuniform sampler2D uTexture;\nuniform sampler2D uBackTexture;\n\n{FUNCTIONS}\n\nvoid main()\n{ \n    vec4 back = texture(uBackTexture, vTextureCoord);\n    vec4 front = texture(uTexture, vTextureCoord);\n\n    {MAIN}\n}\n",_f="in vec2 aPosition;\nout vec2 vTextureCoord;\nout vec2 backgroundUv;\n\nuniform vec4 uInputSize;\nuniform vec4 uOutputFrame;\nuniform vec4 uOutputTexture;\n\nvec4 filterVertexPosition( void )\n{\n    vec2 position = aPosition * uOutputFrame.zw + uOutputFrame.xy;\n    \n    position.x = position.x * (2.0 / uOutputTexture.x) - 1.0;\n    position.y = position.y * (2.0*uOutputTexture.z / uOutputTexture.y) - uOutputTexture.z;\n\n    return vec4(position, 0.0, 1.0);\n}\n\nvec2 filterTextureCoord( void )\n{\n    return aPosition * (uOutputFrame.zw * uInputSize.zw);\n}\n\nvoid main(void)\n{\n    gl_Position = filterVertexPosition();\n    vTextureCoord = filterTextureCoord();\n}\n",xf="\nstruct GlobalFilterUniforms {\n  uInputSize:vec4<f32>,\n  uInputPixel:vec4<f32>,\n  uInputClamp:vec4<f32>,\n  uOutputFrame:vec4<f32>,\n  uGlobalFrame:vec4<f32>,\n  uOutputTexture:vec4<f32>,\n};\n\nstruct BlendUniforms {\n  uBlend:f32,\n};\n\n@group(0) @binding(0) var<uniform> gfu: GlobalFilterUniforms;\n@group(0) @binding(1) var uTexture: texture_2d<f32>;\n@group(0) @binding(2) var uSampler : sampler;\n@group(0) @binding(3) var uBackTexture: texture_2d<f32>;\n\n@group(1) @binding(0) var<uniform> blendUniforms : BlendUniforms;\n\n\nstruct VSOutput {\n    @builtin(position) position: vec4<f32>,\n    @location(0) uv : vec2<f32>\n  };\n\nfn filterVertexPosition(aPosition:vec2<f32>) -> vec4<f32>\n{\n    var position = aPosition * gfu.uOutputFrame.zw + gfu.uOutputFrame.xy;\n\n    position.x = position.x * (2.0 / gfu.uOutputTexture.x) - 1.0;\n    position.y = position.y * (2.0*gfu.uOutputTexture.z / gfu.uOutputTexture.y) - gfu.uOutputTexture.z;\n\n    return vec4(position, 0.0, 1.0);\n}\n\nfn filterTextureCoord( aPosition:vec2<f32> ) -> vec2<f32>\n{\n    return aPosition * (gfu.uOutputFrame.zw * gfu.uInputSize.zw);\n}\n\nfn globalTextureCoord( aPosition:vec2<f32> ) -> vec2<f32>\n{\n  return  (aPosition.xy / gfu.uGlobalFrame.zw) + (gfu.uGlobalFrame.xy / gfu.uGlobalFrame.zw);  \n}\n  \n@vertex\nfn mainVertex(\n  @location(0) aPosition : vec2<f32>, \n) -> VSOutput {\n  return VSOutput(\n   filterVertexPosition(aPosition),\n   filterTextureCoord(aPosition)\n  );\n}\n\n{FUNCTIONS}\n\n@fragment\nfn mainFragment(\n  @location(0) uv: vec2<f32>\n) -> @location(0) vec4<f32> {\n\n\n   var back =  textureSample(uBackTexture, uSampler, uv);\n   var front = textureSample(uTexture, uSampler, uv);\n   \n   var out = vec4<f32>(0.0,0.0,0.0,0.0);\n\n   {MAIN}\n\n   return out;\n}",yf=Object.defineProperty,bf=Object.getOwnPropertySymbols,vf=Object.prototype.hasOwnProperty,Tf=Object.prototype.propertyIsEnumerable,Sf=(t,e,r)=>e in t?yf(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r,wf=(t,e)=>{for(var r in e||(e={}))vf.call(e,r)&&Sf(t,r,e[r]);if(bf)for(var r of bf(e))Tf.call(e,r)&&Sf(t,r,e[r]);return t};function Ef(t){const{source:e,functions:r,main:s}=t;return e.replace("{FUNCTIONS}",r).replace("{MAIN}",s)}var Af="in vec2 aPosition;\nout vec2 vTextureCoord;\n\nuniform vec4 uInputSize;\nuniform vec4 uOutputFrame;\nuniform vec4 uOutputTexture;\n\nvec4 filterVertexPosition( void )\n{\n    vec2 position = aPosition * uOutputFrame.zw + uOutputFrame.xy;\n    \n    position.x = position.x * (2.0 / uOutputTexture.x) - 1.0;\n    position.y = position.y * (2.0*uOutputTexture.z / uOutputTexture.y) - uOutputTexture.z;\n\n    return vec4(position, 0.0, 1.0);\n}\n\nvec2 filterTextureCoord( void )\n{\n    return aPosition * (uOutputFrame.zw * uInputSize.zw);\n}\n\nvoid main(void)\n{\n    gl_Position = filterVertexPosition();\n    vTextureCoord = filterTextureCoord();\n}\n",Mf="\nin vec2 vTextureCoord;\n\nout vec4 finalColor;\n\nuniform float uAlpha;\nuniform sampler2D uTexture;\n\nvoid main()\n{\n    finalColor =  texture(uTexture, vTextureCoord) * uAlpha;\n}\n",Pf="struct GlobalFilterUniforms {\n  uInputSize:vec4<f32>,\n  uInputPixel:vec4<f32>,\n  uInputClamp:vec4<f32>,\n  uOutputFrame:vec4<f32>,\n  uGlobalFrame:vec4<f32>,\n  uOutputTexture:vec4<f32>,\n};\n\nstruct AlphaUniforms {\n  uAlpha:f32,\n};\n\n@group(0) @binding(0) var<uniform> gfu: GlobalFilterUniforms;\n@group(0) @binding(1) var uTexture: texture_2d<f32>;\n@group(0) @binding(2) var uSampler : sampler;\n\n@group(1) @binding(0) var<uniform> alphaUniforms : AlphaUniforms;\n\nstruct VSOutput {\n    @builtin(position) position: vec4<f32>,\n    @location(0) uv : vec2<f32>\n  };\n\nfn filterVertexPosition(aPosition:vec2<f32>) -> vec4<f32>\n{\n    var position = aPosition * gfu.uOutputFrame.zw + gfu.uOutputFrame.xy;\n\n    position.x = position.x * (2.0 / gfu.uOutputTexture.x) - 1.0;\n    position.y = position.y * (2.0*gfu.uOutputTexture.z / gfu.uOutputTexture.y) - gfu.uOutputTexture.z;\n\n    return vec4(position, 0.0, 1.0);\n}\n\nfn filterTextureCoord( aPosition:vec2<f32> ) -> vec2<f32>\n{\n    return aPosition * (gfu.uOutputFrame.zw * gfu.uInputSize.zw);\n}\n\nfn globalTextureCoord( aPosition:vec2<f32> ) -> vec2<f32>\n{\n  return  (aPosition.xy / gfu.uGlobalFrame.zw) + (gfu.uGlobalFrame.xy / gfu.uGlobalFrame.zw);  \n}\n\nfn getSize() -> vec2<f32>\n{\n  return gfu.uGlobalFrame.zw;\n}\n  \n@vertex\nfn mainVertex(\n  @location(0) aPosition : vec2<f32>, \n) -> VSOutput {\n  return VSOutput(\n   filterVertexPosition(aPosition),\n   filterTextureCoord(aPosition)\n  );\n}\n\n@fragment\nfn mainFragment(\n  @location(0) uv: vec2<f32>,\n  @builtin(position) position: vec4<f32>\n) -> @location(0) vec4<f32> {\n \n    var sample = textureSample(uTexture, uSampler, uv);\n    \n    return sample * alphaUniforms.uAlpha;\n}",Rf=Object.defineProperty,Of=Object.defineProperties,Cf=Object.getOwnPropertyDescriptors,If=Object.getOwnPropertySymbols,Gf=Object.prototype.hasOwnProperty,kf=Object.prototype.propertyIsEnumerable,Bf=(t,e,r)=>e in t?Rf(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r,Df=(t,e)=>{for(var r in e||(e={}))Gf.call(e,r)&&Bf(t,r,e[r]);if(If)for(var r of If(e))kf.call(e,r)&&Bf(t,r,e[r]);return t};const Ff=class t extends gf{constructor(e){e=Df(Df({},t.defaultOptions),e);const r=yl.from({vertex:{source:Pf,entryPoint:"mainVertex"},fragment:{source:Pf,entryPoint:"mainFragment"}}),s=ll.from({vertex:Af,fragment:Mf,name:"alpha-filter"}),i=e,{alpha:n}=i,o=((t,e)=>{var r={};for(var s in t)Gf.call(t,s)&&e.indexOf(s)<0&&(r[s]=t[s]);if(null!=t&&If)for(var s of If(t))e.indexOf(s)<0&&kf.call(t,s)&&(r[s]=t[s]);return r})(i,["alpha"]),a=new vn({uAlpha:{value:n,type:"f32"}});super(((t,e)=>Of(t,Cf(e)))(Df({},o),{gpuProgram:r,glProgram:s,resources:{alphaUniforms:a}}))}get alpha(){return this.resources.alphaUniforms.uniforms.uAlpha}set alpha(t){this.resources.alphaUniforms.uniforms.uAlpha=t}};Ff.defaultOptions={alpha:1};let Nf=Ff;const Uf={5:[.153388,.221461,.250301],7:[.071303,.131514,.189879,.214607],9:[.028532,.067234,.124009,.179044,.20236],11:[.0093,.028002,.065984,.121703,.175713,.198596],13:[.002406,.009255,.027867,.065666,.121117,.174868,.197641],15:[489e-6,.002403,.009246,.02784,.065602,.120999,.174697,.197448]},Lf=["in vec2 vBlurTexCoords[%size%];","uniform sampler2D uTexture;","out vec4 finalColor;","void main(void)","{","    finalColor = vec4(0.0);","    %blur%","}"].join("\n");function Xf(t){const e=Uf[t],r=e.length;let s=Lf,i="";let n;for(let s=0;s<t;s++){let o="finalColor += texture(uTexture, vBlurTexCoords[%index%]) * %value%;".replace("%index%",s.toString());n=s,s>=r&&(n=t-s-1),o=o.replace("%value%",e[n].toString()),i+=o,i+="\n"}return s=s.replace("%blur%",i),s=s.replace("%size%",t.toString()),s}function zf(t,e){const r=Math.ceil(t/2);let s,i="\n    in vec2 aPosition;\n\n    uniform float uStrength;\n\n    out vec2 vBlurTexCoords[%size%];\n\n    uniform vec4 uInputSize;\n    uniform vec4 uOutputFrame;\n    uniform vec4 uOutputTexture;\n\n    vec4 filterVertexPosition( void )\n{\n    vec2 position = aPosition * uOutputFrame.zw + uOutputFrame.xy;\n    \n    position.x = position.x * (2.0 / uOutputTexture.x) - 1.0;\n    position.y = position.y * (2.0*uOutputTexture.z / uOutputTexture.y) - uOutputTexture.z;\n\n    return vec4(position, 0.0, 1.0);\n}\n\n    vec2 filterTextureCoord( void )\n    {\n        return aPosition * (uOutputFrame.zw * uInputSize.zw);\n    }\n\n    void main(void)\n    {\n        gl_Position = filterVertexPosition();\n\n        float pixelStrength = uInputSize.%dimension% * uStrength;\n\n        vec2 textureCoord = filterTextureCoord();\n        %blur%\n    }",n="";s=e?"vBlurTexCoords[%index%] =  textureCoord + vec2(%sampleIndex% * pixelStrength, 0.0);":"vBlurTexCoords[%index%] =  textureCoord + vec2(0.0, %sampleIndex% * pixelStrength);";for(let e=0;e<t;e++){let t=s.replace("%index%",e.toString());t=t.replace("%sampleIndex%",e-(r-1)+".0"),n+=t,n+="\n"}return i=i.replace("%blur%",n),i=i.replace("%size%",t.toString()),i=i.replace("%dimension%",e?"z":"w"),i}function Hf(t,e){const r=zf(e,t),s=Xf(e);return ll.from({vertex:r,fragment:s,name:`blur-${t?"horizontal":"vertical"}-pass-filter`})}var jf="\n\nstruct GlobalFilterUniforms {\n  uInputSize:vec4<f32>,\n  uInputPixel:vec4<f32>,\n  uInputClamp:vec4<f32>,\n  uOutputFrame:vec4<f32>,\n  uGlobalFrame:vec4<f32>,\n  uOutputTexture:vec4<f32>,\n};\n\nstruct BlurUniforms {\n  uStrength:f32,\n};\n\n@group(0) @binding(0) var<uniform> gfu: GlobalFilterUniforms;\n@group(0) @binding(1) var uTexture: texture_2d<f32>;\n@group(0) @binding(2) var uSampler : sampler;\n\n@group(1) @binding(0) var<uniform> blurUniforms : BlurUniforms;\n\n\nstruct VSOutput {\n    @builtin(position) position: vec4<f32>,\n    %blur-struct%\n  };\n\nfn filterVertexPosition(aPosition:vec2<f32>) -> vec4<f32>\n{\n    var position = aPosition * gfu.uOutputFrame.zw + gfu.uOutputFrame.xy;\n\n    position.x = position.x * (2.0 / gfu.uOutputTexture.x) - 1.0;\n    position.y = position.y * (2.0*gfu.uOutputTexture.z / gfu.uOutputTexture.y) - gfu.uOutputTexture.z;\n\n    return vec4(position, 0.0, 1.0);\n}\n\nfn filterTextureCoord( aPosition:vec2<f32> ) -> vec2<f32>\n{\n    return aPosition * (gfu.uOutputFrame.zw * gfu.uInputSize.zw);\n}\n\nfn globalTextureCoord( aPosition:vec2<f32> ) -> vec2<f32>\n{\n  return  (aPosition.xy / gfu.uGlobalFrame.zw) + (gfu.uGlobalFrame.xy / gfu.uGlobalFrame.zw);  \n}\n\nfn getSize() -> vec2<f32>\n{\n  return gfu.uGlobalFrame.zw;\n}\n\n\n@vertex\nfn mainVertex(\n  @location(0) aPosition : vec2<f32>, \n) -> VSOutput {\n\n  let filteredCord = filterTextureCoord(aPosition);\n\n  let strength = gfu.uInputSize.w * blurUniforms.uStrength;\n\n  return VSOutput(\n   filterVertexPosition(aPosition),\n    %blur-vertex-out%\n  );\n}\n\n@fragment\nfn mainFragment(\n  @builtin(position) position: vec4<f32>,\n  %blur-fragment-in%\n) -> @location(0) vec4<f32> {\n\n    var   finalColor = vec4(0.0);\n\n    %blur-sampling%\n\n    return finalColor;\n}";function Vf(t,e){const r=Uf[e],s=r.length,i=[],n=[],o=[];for(let a=0;a<e;a++){i[a]=`@location(${a}) offset${a}: vec2<f32>,`,n[a]=t?`filteredCord + vec2(${a-s+1} * strength, 0.0),`:`filteredCord + vec2(0.0, ${a-s+1} * strength),`;const l=r[a<s?a:e-a-1].toString();o[a]=`finalColor += textureSample(uTexture, uSampler, offset${a}) * ${l};`}const a=i.join("\n"),l=n.join("\n"),h=o.join("\n"),u=jf.replace("%blur-struct%",a).replace("%blur-vertex-out%",l).replace("%blur-fragment-in%",a).replace("%blur-sampling%",h);return yl.from({vertex:{source:u,entryPoint:"mainVertex"},fragment:{source:u,entryPoint:"mainFragment"}})}var Wf=Object.defineProperty,$f=Object.getOwnPropertySymbols,Yf=Object.prototype.hasOwnProperty,qf=Object.prototype.propertyIsEnumerable,Kf=(t,e,r)=>e in t?Wf(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r,Zf=(t,e)=>{for(var r in e||(e={}))Yf.call(e,r)&&Kf(t,r,e[r]);if($f)for(var r of $f(e))qf.call(e,r)&&Kf(t,r,e[r]);return t};const Qf=class t extends gf{constructor(e){const r=Hf((e=Zf(Zf({},t.defaultOptions),e)).horizontal,e.kernelSize),s=Vf(e.horizontal,e.kernelSize);super(Zf({glProgram:r,gpuProgram:s,resources:{blurUniforms:{uStrength:{value:0,type:"f32"}}}},e)),this.horizontal=e.horizontal,this._quality=0,this.quality=e.quality,this.blur=e.strength,this._uniforms=this.resources.blurUniforms.uniforms}apply(t,e,r,s){if(this._uniforms.uStrength=this.strength/this.passes,1===this.passes)t.applyFilter(this,e,r,s);else{const i=Fn.getSameSizeTexture(e);let n=e,o=i;this._state.blend=!1;for(let e=0;e<this.passes-1;e++){t.applyFilter(this,n,o,t.renderer.type===lh.WEBGPU);const e=o;o=n,n=e}this._state.blend=!0,t.applyFilter(this,n,r,s),Fn.returnTexture(i)}}get blur(){return this.strength}set blur(t){this.padding=1+2*Math.abs(t),this.strength=t}get quality(){return this._quality}set quality(t){this._quality=t,this.passes=t}};Qf.defaultOptions={strength:8,quality:4,kernelSize:5};let Jf=Qf;var tg=Object.defineProperty,eg=Object.defineProperties,rg=Object.getOwnPropertyDescriptors,sg=Object.getOwnPropertySymbols,ig=Object.prototype.hasOwnProperty,ng=Object.prototype.propertyIsEnumerable,og=(t,e,r)=>e in t?tg(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r,ag=(t,e)=>{for(var r in e||(e={}))ig.call(e,r)&&og(t,r,e[r]);if(sg)for(var r of sg(e))ng.call(e,r)&&og(t,r,e[r]);return t};class lg extends gf{constructor(...t){var e;let r=null!=(e=t[0])?e:{};"number"==typeof r&&(r={strength:r},t[1]&&(r.quality=t[1]),t[2]&&(r.resolution=t[2]),t[3]&&(r.kernelSize=t[3])),r=ag(ag({},Jf.defaultOptions),r);const s=r,{strength:i,quality:n}=s,o=((t,e)=>{var r={};for(var s in t)ig.call(t,s)&&e.indexOf(s)<0&&(r[s]=t[s]);if(null!=t&&sg)for(var s of sg(t))e.indexOf(s)<0&&ng.call(t,s)&&(r[s]=t[s]);return r})(s,["strength","quality"]);super(((t,e)=>eg(t,rg(e)))(ag({},o),{compatibleRenderers:lh.BOTH,resources:{}})),this._repeatEdgePixels=!1,this.blurXFilter=new Jf(ag({horizontal:!1},r)),this.blurYFilter=new Jf(ag({horizontal:!0},r)),this.quality=n,this.blur=i,this.repeatEdgePixels=!1}apply(t,e,r,s){const i=Math.abs(this.blurXFilter.strength),n=Math.abs(this.blurYFilter.strength);if(i&&n){const i=Fn.getSameSizeTexture(e);this.blurXFilter.apply(t,e,i,!0),this.blurYFilter.apply(t,i,r,s),Fn.returnTexture(i)}else n?this.blurYFilter.apply(t,e,r,s):this.blurXFilter.apply(t,e,r,s)}updatePadding(){this._repeatEdgePixels?this.padding=0:this.padding=2*Math.max(Math.abs(this.blurXFilter.blur),Math.abs(this.blurYFilter.blur))}get blur(){return this.blurXFilter.blur}set blur(t){this.blurXFilter.blur=this.blurYFilter.blur=t,this.updatePadding()}get quality(){return this.blurXFilter.quality}set quality(t){this.blurXFilter.quality=this.blurYFilter.quality=t}get blurX(){return this.blurXFilter.blur}set blurX(t){this.blurXFilter.blur=t,this.updatePadding()}get blurY(){return this.blurYFilter.blur}set blurY(t){this.blurYFilter.blur=t,this.updatePadding()}get blendMode(){return this.blurYFilter.blendMode}set blendMode(t){this.blurYFilter.blendMode=t}get repeatEdgePixels(){return this._repeatEdgePixels}set repeatEdgePixels(t){this._repeatEdgePixels=t,this.updatePadding()}}lg.defaultOptions={strength:8,quality:4,kernelSize:5};var hg="\nin vec2 vTextureCoord;\nin vec4 vColor;\n\nout vec4 finalColor;\n\nuniform float uColorMatrix[20];\nuniform float uAlpha;\n\nuniform sampler2D uTexture;\n\nfloat rand(vec2 co)\n{\n    return fract(sin(dot(co.xy, vec2(12.9898, 78.233))) * 43758.5453);\n}\n\nvoid main()\n{\n    vec4 color = texture(uTexture, vTextureCoord);\n    float randomValue = rand(gl_FragCoord.xy * 0.2);\n    float diff = (randomValue - 0.5) *  0.5;\n\n    if (uAlpha == 0.0) {\n        finalColor = color;\n        return;\n    }\n\n    if (color.a > 0.0) {\n        color.rgb /= color.a;\n    }\n\n    vec4 result;\n\n    result.r = (uColorMatrix[0] * color.r);\n        result.r += (uColorMatrix[1] * color.g);\n        result.r += (uColorMatrix[2] * color.b);\n        result.r += (uColorMatrix[3] * color.a);\n        result.r += uColorMatrix[4];\n\n    result.g = (uColorMatrix[5] * color.r);\n        result.g += (uColorMatrix[6] * color.g);\n        result.g += (uColorMatrix[7] * color.b);\n        result.g += (uColorMatrix[8] * color.a);\n        result.g += uColorMatrix[9];\n\n    result.b = (uColorMatrix[10] * color.r);\n       result.b += (uColorMatrix[11] * color.g);\n       result.b += (uColorMatrix[12] * color.b);\n       result.b += (uColorMatrix[13] * color.a);\n       result.b += uColorMatrix[14];\n\n    result.a = (uColorMatrix[15] * color.r);\n       result.a += (uColorMatrix[16] * color.g);\n       result.a += (uColorMatrix[17] * color.b);\n       result.a += (uColorMatrix[18] * color.a);\n       result.a += uColorMatrix[19];\n\n    vec3 rgb = mix(color.rgb, result.rgb, uAlpha);\n\n    // Premultiply alpha again.\n    rgb *= result.a;\n\n    finalColor = vec4(rgb, result.a);\n}\n",ug="struct GlobalFilterUniforms {\n  uInputSize:vec4<f32>,\n  uInputPixel:vec4<f32>,\n  uInputClamp:vec4<f32>,\n  uOutputFrame:vec4<f32>,\n  uGlobalFrame:vec4<f32>,\n  uOutputTexture:vec4<f32>,\n};\n\nstruct ColorMatrixUniforms {\n  uColorMatrix:array<vec4<f32>, 5>,\n  uAlpha:f32,\n};\n\n\n@group(0) @binding(0) var<uniform> gfu: GlobalFilterUniforms;\n@group(0) @binding(1) var uTexture: texture_2d<f32>;\n@group(0) @binding(2) var uSampler : sampler;\n@group(1) @binding(0) var<uniform> colorMatrixUniforms : ColorMatrixUniforms;\n\n\nstruct VSOutput {\n    @builtin(position) position: vec4<f32>,\n    @location(0) uv : vec2<f32>,\n  };\n  \nfn filterVertexPosition(aPosition:vec2<f32>) -> vec4<f32>\n{\n    var position = aPosition * gfu.uOutputFrame.zw + gfu.uOutputFrame.xy;\n\n    position.x = position.x * (2.0 / gfu.uOutputTexture.x) - 1.0;\n    position.y = position.y * (2.0*gfu.uOutputTexture.z / gfu.uOutputTexture.y) - gfu.uOutputTexture.z;\n\n    return vec4(position, 0.0, 1.0);\n}\n\nfn filterTextureCoord( aPosition:vec2<f32> ) -> vec2<f32>\n{\n  return aPosition * (gfu.uOutputFrame.zw * gfu.uInputSize.zw);\n}\n\n@vertex\nfn mainVertex(\n  @location(0) aPosition : vec2<f32>, \n) -> VSOutput {\n  return VSOutput(\n   filterVertexPosition(aPosition),\n   filterTextureCoord(aPosition),\n  );\n}\n\n\n@fragment\nfn mainFragment(\n  @location(0) uv: vec2<f32>,\n) -> @location(0) vec4<f32> {\n\n\n  var c = textureSample(uTexture, uSampler, uv);\n  \n  if (colorMatrixUniforms.uAlpha == 0.0) {\n    return c;\n  }\n\n \n    // Un-premultiply alpha before applying the color matrix. See issue #3539.\n    if (c.a > 0.0) {\n      c.r /= c.a;\n      c.g /= c.a;\n      c.b /= c.a;\n    }\n\n    var cm = colorMatrixUniforms.uColorMatrix;\n\n\n    var result = vec4<f32>(0.);\n\n    result.r = (cm[0][0] * c.r);\n    result.r += (cm[0][1] * c.g);\n    result.r += (cm[0][2] * c.b);\n    result.r += (cm[0][3] * c.a);\n    result.r += cm[1][0];\n\n    result.g = (cm[1][1] * c.r);\n    result.g += (cm[1][2] * c.g);\n    result.g += (cm[1][3] * c.b);\n    result.g += (cm[2][0] * c.a);\n    result.g += cm[2][1];\n\n    result.b = (cm[2][2] * c.r);\n    result.b += (cm[2][3] * c.g);\n    result.b += (cm[3][0] * c.b);\n    result.b += (cm[3][1] * c.a);\n    result.b += cm[3][2];\n\n    result.a = (cm[3][3] * c.r);\n    result.a += (cm[4][0] * c.g);\n    result.a += (cm[4][1] * c.b);\n    result.a += (cm[4][2] * c.a);\n    result.a += cm[4][3];\n\n    var rgb = mix(c.rgb, result.rgb, colorMatrixUniforms.uAlpha);\n\n    rgb.r *= result.a;\n    rgb.g *= result.a;\n    rgb.b *= result.a;\n\n    return vec4(rgb, result.a);\n}",cg=Object.defineProperty,dg=Object.defineProperties,pg=Object.getOwnPropertyDescriptors,fg=Object.getOwnPropertySymbols,gg=Object.prototype.hasOwnProperty,mg=Object.prototype.propertyIsEnumerable,_g=(t,e,r)=>e in t?cg(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r;var xg="\nin vec2 vTextureCoord;\nin vec2 vFilterUv;\n\nout vec4 finalColor;\n\nuniform sampler2D uTexture;\nuniform sampler2D uMapTexture;\n\nuniform vec4 uInputClamp;\nuniform highp vec4 uInputSize;\nuniform mat2 uRotation;\nuniform vec2 uScale;\n\nvoid main()\n{\n    vec4 map = texture(uMapTexture, vFilterUv);\n    \n    vec2 offset = uInputSize.zw * (uRotation * (map.xy - 0.5)) * uScale; \n\n    finalColor = texture(uTexture, clamp(vTextureCoord + offset, uInputClamp.xy, uInputClamp.zw));\n}\n",yg="in vec2 aPosition;\nout vec2 vTextureCoord;\nout vec2 vFilterUv;\n\n\nuniform vec4 uInputSize;\nuniform vec4 uOutputFrame;\nuniform vec4 uOutputTexture;\n\nuniform mat3 uFilterMatrix;\n\nvec4 filterVertexPosition( void )\n{\n    vec2 position = aPosition * uOutputFrame.zw + uOutputFrame.xy;\n    \n    position.x = position.x * (2.0 / uOutputTexture.x) - 1.0;\n    position.y = position.y * (2.0*uOutputTexture.z / uOutputTexture.y) - uOutputTexture.z;\n\n    return vec4(position, 0.0, 1.0);\n}\n\nvec2 filterTextureCoord( void )\n{\n    return aPosition * (uOutputFrame.zw * uInputSize.zw);\n}\n\nvec2 getFilterCoord( void )\n{\n  return ( uFilterMatrix * vec3( filterTextureCoord(), 1.0)  ).xy;\n}\n\n\nvoid main(void)\n{\n    gl_Position = filterVertexPosition();\n    vTextureCoord = filterTextureCoord();\n    vFilterUv = getFilterCoord();\n}\n",bg="\nstruct GlobalFilterUniforms {\n  uInputSize:vec4<f32>,\n  uInputPixel:vec4<f32>,\n  uInputClamp:vec4<f32>,\n  uOutputFrame:vec4<f32>,\n  uGlobalFrame:vec4<f32>,\n  uOutputTexture:vec4<f32>,\n};\n\nstruct DisplacementUniforms {\n  uFilterMatrix:mat3x3<f32>,\n  uScale:vec2<f32>,\n  uRotation:mat2x2<f32>\n};\n\n\n\n@group(0) @binding(0) var<uniform> gfu: GlobalFilterUniforms;\n@group(0) @binding(1) var uTexture: texture_2d<f32>;\n@group(0) @binding(2) var uSampler : sampler;\n\n@group(1) @binding(0) var<uniform> filterUniforms : DisplacementUniforms;\n@group(1) @binding(1) var uMapTexture: texture_2d<f32>;\n@group(1) @binding(2) var uMapSampler : sampler;\n\nstruct VSOutput {\n    @builtin(position) position: vec4<f32>,\n    @location(0) uv : vec2<f32>,\n    @location(1) filterUv : vec2<f32>,\n  };\n\nfn filterVertexPosition(aPosition:vec2<f32>) -> vec4<f32>\n{\n    var position = aPosition * gfu.uOutputFrame.zw + gfu.uOutputFrame.xy;\n\n    position.x = position.x * (2.0 / gfu.uOutputTexture.x) - 1.0;\n    position.y = position.y * (2.0*gfu.uOutputTexture.z / gfu.uOutputTexture.y) - gfu.uOutputTexture.z;\n\n    return vec4(position, 0.0, 1.0);\n}\n\nfn filterTextureCoord( aPosition:vec2<f32> ) -> vec2<f32>\n{\n    return aPosition * (gfu.uOutputFrame.zw * gfu.uInputSize.zw);\n}\n\nfn globalTextureCoord( aPosition:vec2<f32> ) -> vec2<f32>\n{\n  return  (aPosition.xy / gfu.uGlobalFrame.zw) + (gfu.uGlobalFrame.xy / gfu.uGlobalFrame.zw);  \n}\n\nfn getFilterCoord(aPosition:vec2<f32> ) -> vec2<f32>\n{\n  return ( filterUniforms.uFilterMatrix * vec3( filterTextureCoord(aPosition), 1.0)  ).xy;\n}\n\nfn getSize() -> vec2<f32>\n{\n\n  \n  return gfu.uGlobalFrame.zw;\n}\n  \n@vertex\nfn mainVertex(\n  @location(0) aPosition : vec2<f32>, \n) -> VSOutput {\n  return VSOutput(\n   filterVertexPosition(aPosition),\n   filterTextureCoord(aPosition),\n   getFilterCoord(aPosition)\n  );\n}\n\n@fragment\nfn mainFragment(\n  @location(0) uv: vec2<f32>,\n  @location(1) filterUv: vec2<f32>,\n  @builtin(position) position: vec4<f32>\n) -> @location(0) vec4<f32> {\n\n    var map = textureSample(uMapTexture, uMapSampler, filterUv);\n\n    var offset =  gfu.uInputSize.zw * (filterUniforms.uRotation * (map.xy - 0.5)) * filterUniforms.uScale; \n   \n    return textureSample(uTexture, uSampler, clamp(uv + offset, gfu.uInputClamp.xy, gfu.uInputClamp.zw));\n}",vg=Object.defineProperty,Tg=Object.defineProperties,Sg=Object.getOwnPropertyDescriptors,wg=Object.getOwnPropertySymbols,Eg=Object.prototype.hasOwnProperty,Ag=Object.prototype.propertyIsEnumerable,Mg=(t,e,r)=>e in t?vg(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r;var Pg="\nin vec2 vTextureCoord;\nin vec4 vColor;\n\nout vec4 finalColor;\n\nuniform float uNoise;\nuniform float uSeed;\nuniform sampler2D uTexture;\n\nfloat rand(vec2 co)\n{\n    return fract(sin(dot(co.xy, vec2(12.9898, 78.233))) * 43758.5453);\n}\n\nvoid main()\n{\n    vec4 color = texture(uTexture, vTextureCoord);\n    float randomValue = rand(gl_FragCoord.xy * uSeed);\n    float diff = (randomValue - 0.5) *  uNoise;\n\n    // Un-premultiply alpha before applying the color matrix. See issue #3539.\n    if (color.a > 0.0) {\n        color.rgb /= color.a;\n    }\n\n    color.r += diff;\n    color.g += diff;\n    color.b += diff;\n\n    // Premultiply alpha again.\n    color.rgb *= color.a;\n\n    finalColor = color;\n}\n",Rg="\n\nstruct GlobalFilterUniforms {\n  uInputSize:vec4<f32>,\n  uInputPixel:vec4<f32>,\n  uInputClamp:vec4<f32>,\n  uOutputFrame:vec4<f32>,\n  uGlobalFrame:vec4<f32>,\n  uOutputTexture:vec4<f32>,\n};\n\nstruct NoiseUniforms {\n  uNoise:f32,\n  uSeed:f32,\n};\n\n@group(0) @binding(0) var<uniform> gfu: GlobalFilterUniforms;\n@group(0) @binding(1) var uTexture: texture_2d<f32>;\n@group(0) @binding(2) var uSampler : sampler;\n\n@group(1) @binding(0) var<uniform> noiseUniforms : NoiseUniforms;\n\nstruct VSOutput {\n    @builtin(position) position: vec4<f32>,\n    @location(0) uv : vec2<f32>\n  };\n\nfn filterVertexPosition(aPosition:vec2<f32>) -> vec4<f32>\n{\n    var position = aPosition * gfu.uOutputFrame.zw + gfu.uOutputFrame.xy;\n\n    position.x = position.x * (2.0 / gfu.uOutputTexture.x) - 1.0;\n    position.y = position.y * (2.0*gfu.uOutputTexture.z / gfu.uOutputTexture.y) - gfu.uOutputTexture.z;\n\n    return vec4(position, 0.0, 1.0);\n}\n\nfn filterTextureCoord( aPosition:vec2<f32> ) -> vec2<f32>\n{\n    return aPosition * (gfu.uOutputFrame.zw * gfu.uInputSize.zw);\n}\n\nfn globalTextureCoord( aPosition:vec2<f32> ) -> vec2<f32>\n{\n  return  (aPosition.xy / gfu.uGlobalFrame.zw) + (gfu.uGlobalFrame.xy / gfu.uGlobalFrame.zw);  \n}\n\nfn getSize() -> vec2<f32>\n{\n  return gfu.uGlobalFrame.zw;\n}\n  \n@vertex\nfn mainVertex(\n  @location(0) aPosition : vec2<f32>, \n) -> VSOutput {\n  return VSOutput(\n   filterVertexPosition(aPosition),\n   filterTextureCoord(aPosition)\n  );\n}\n\nfn rand(co:vec2<f32>) -> f32\n{\n  return fract(sin(dot(co.xy, vec2(12.9898, 78.233))) * 43758.5453);\n}\n\n\n\n@fragment\nfn mainFragment(\n  @location(0) uv: vec2<f32>,\n  @builtin(position) position: vec4<f32>\n) -> @location(0) vec4<f32> {\n\n    var pixelPosition =  globalTextureCoord(position.xy);// / (getSize());//-  gfu.uOutputFrame.xy);\n  \n    \n    var sample = textureSample(uTexture, uSampler, uv);\n    var randomValue =  rand(pixelPosition.xy * noiseUniforms.uSeed);\n    var diff = (randomValue - 0.5) * noiseUniforms.uNoise;\n  \n    // Un-premultiply alpha before applying the color matrix. See issue #3539.\n    if (sample.a > 0.0) {\n      sample.r /= sample.a;\n      sample.g /= sample.a;\n      sample.b /= sample.a;\n    }\n\n    sample.r += diff;\n    sample.g += diff;\n    sample.b += diff;\n\n    // Premultiply alpha again.\n    sample.r *= sample.a;\n    sample.g *= sample.a;\n    sample.b *= sample.a;\n    \n    return sample;\n}",Og=Object.defineProperty,Cg=Object.defineProperties,Ig=Object.getOwnPropertyDescriptors,Gg=Object.getOwnPropertySymbols,kg=Object.prototype.hasOwnProperty,Bg=Object.prototype.propertyIsEnumerable,Dg=(t,e,r)=>e in t?Og(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r,Fg=(t,e)=>{for(var r in e||(e={}))kg.call(e,r)&&Dg(t,r,e[r]);if(Gg)for(var r of Gg(e))Bg.call(e,r)&&Dg(t,r,e[r]);return t};const Ng=class t extends gf{constructor(e={}){e=Fg(Fg({},t.defaultOptions),e);const r=yl.from({vertex:{source:Rg,entryPoint:"mainVertex"},fragment:{source:Rg,entryPoint:"mainFragment"}}),s=ll.from({vertex:Af,fragment:Pg,name:"noise-filter"}),i=e,{noise:n,seed:o}=i,a=((t,e)=>{var r={};for(var s in t)kg.call(t,s)&&e.indexOf(s)<0&&(r[s]=t[s]);if(null!=t&&Gg)for(var s of Gg(t))e.indexOf(s)<0&&Bg.call(t,s)&&(r[s]=t[s]);return r})(i,["noise","seed"]);super(((t,e)=>Cg(t,Ig(e)))(Fg({},a),{gpuProgram:r,glProgram:s,resources:{noiseUniforms:new vn({uNoise:{value:1,type:"f32"},uSeed:{value:1,type:"f32"}})}})),this.noise=n,this.seed=null!=o?o:Math.random()}get noise(){return this.resources.noiseUniforms.uniforms.uNoise}set noise(t){this.resources.noiseUniforms.uniforms.uNoise=t}get seed(){return this.resources.noiseUniforms.uniforms.uSeed}set seed(t){this.resources.noiseUniforms.uniforms.uSeed=t}};Ng.defaultOptions={noise:.5};let Ug=Ng;var Lg="in vec2 vMaskCoord;\nin vec2 vTextureCoord;\n\nuniform sampler2D uTexture;\nuniform sampler2D uMaskTexture;\n\nuniform float uAlpha;\nuniform vec4 uMaskClamp;\n\nout vec4 finalColor;\n\nvoid main(void)\n{\n    float clip = step(3.5,\n        step(uMaskClamp.x, vMaskCoord.x) +\n        step(uMaskClamp.y, vMaskCoord.y) +\n        step(vMaskCoord.x, uMaskClamp.z) +\n        step(vMaskCoord.y, uMaskClamp.w));\n\n    // TODO look into why this is needed\n    float npmAlpha = uAlpha; \n    vec4 original = texture(uTexture, vTextureCoord);\n    vec4 masky = texture(uMaskTexture, vMaskCoord);\n    float alphaMul = 1.0 - npmAlpha * (1.0 - masky.a);\n\n    original *= (alphaMul * masky.r * uAlpha * clip);\n\n    finalColor = original;\n}\n",Xg="in vec2 aPosition;\n\nout vec2 vTextureCoord;\nout vec2 vMaskCoord;\n\n\nuniform vec4 uInputSize;\nuniform vec4 uOutputFrame;\nuniform vec4 uOutputTexture;\nuniform mat3 uFilterMatrix;\n\nvec4 filterVertexPosition(  vec2 aPosition )\n{\n    vec2 position = aPosition * uOutputFrame.zw + uOutputFrame.xy;\n       \n    position.x = position.x * (2.0 / uOutputTexture.x) - 1.0;\n    position.y = position.y * (2.0*uOutputTexture.z / uOutputTexture.y) - uOutputTexture.z;\n\n    return vec4(position, 0.0, 1.0);\n}\n\nvec2 filterTextureCoord(  vec2 aPosition )\n{\n    return aPosition * (uOutputFrame.zw * uInputSize.zw);\n}\n\nvec2 getFilterCoord( vec2 aPosition )\n{\n    return  ( uFilterMatrix * vec3( filterTextureCoord(aPosition), 1.0)  ).xy;\n}   \n\nvoid main(void)\n{\n    gl_Position = filterVertexPosition(aPosition);\n    vTextureCoord = filterTextureCoord(aPosition);\n    vMaskCoord = getFilterCoord(aPosition);\n}\n",zg="struct GlobalFilterUniforms {\n  uInputSize:vec4<f32>,\n  uInputPixel:vec4<f32>,\n  uInputClamp:vec4<f32>,\n  uOutputFrame:vec4<f32>,\n  uGlobalFrame:vec4<f32>,\n  uOutputTexture:vec4<f32>,  \n};\n\nstruct MaskUniforms {\n  uFilterMatrix:mat3x3<f32>,\n  uMaskClamp:vec4<f32>,\n  uAlpha:f32,\n};\n\n\n@group(0) @binding(0) var<uniform> gfu: GlobalFilterUniforms;\n@group(0) @binding(1) var uTexture: texture_2d<f32>;\n@group(0) @binding(2) var uSampler : sampler;\n\n@group(1) @binding(0) var<uniform> filterUniforms : MaskUniforms;\n@group(1) @binding(1) var uMaskTexture: texture_2d<f32>;\n\nstruct VSOutput {\n    @builtin(position) position: vec4<f32>,\n    @location(0) uv : vec2<f32>,\n    @location(1) filterUv : vec2<f32>,\n  };\n\nfn filterVertexPosition(aPosition:vec2<f32>) -> vec4<f32>\n{\n    var position = aPosition * gfu.uOutputFrame.zw + gfu.uOutputFrame.xy;\n\n    position.x = position.x * (2.0 / gfu.uOutputTexture.x) - 1.0;\n    position.y = position.y * (2.0*gfu.uOutputTexture.z / gfu.uOutputTexture.y) - gfu.uOutputTexture.z;\n\n    return vec4(position, 0.0, 1.0);\n}\n\nfn filterTextureCoord( aPosition:vec2<f32> ) -> vec2<f32>\n{\n    return aPosition * (gfu.uOutputFrame.zw * gfu.uInputSize.zw);\n}\n\nfn globalTextureCoord( aPosition:vec2<f32> ) -> vec2<f32>\n{\n  return  (aPosition.xy / gfu.uGlobalFrame.zw) + (gfu.uGlobalFrame.xy / gfu.uGlobalFrame.zw);  \n}\n\nfn getFilterCoord(aPosition:vec2<f32> ) -> vec2<f32>\n{\n  return ( filterUniforms.uFilterMatrix * vec3( filterTextureCoord(aPosition), 1.0)  ).xy;\n}\n\nfn getSize() -> vec2<f32>\n{\n\n  \n  return gfu.uGlobalFrame.zw;\n}\n  \n@vertex\nfn mainVertex(\n  @location(0) aPosition : vec2<f32>, \n) -> VSOutput {\n  return VSOutput(\n   filterVertexPosition(aPosition),\n   filterTextureCoord(aPosition),\n   getFilterCoord(aPosition)\n  );\n}\n\n@fragment\nfn mainFragment(\n  @location(0) uv: vec2<f32>,\n  @location(1) filterUv: vec2<f32>,\n  @builtin(position) position: vec4<f32>\n) -> @location(0) vec4<f32> {\n\n    var maskClamp = filterUniforms.uMaskClamp;\n\n     var clip = step(3.5,\n        step(maskClamp.x, filterUv.x) +\n        step(maskClamp.y, filterUv.y) +\n        step(filterUv.x, maskClamp.z) +\n        step(filterUv.y, maskClamp.w));\n\n    var mask = textureSample(uMaskTexture, uSampler, filterUv);\n    var source = textureSample(uTexture, uSampler, uv);\n    \n    var npmAlpha = 0.0;\n\n    var alphaMul = 1.0 - npmAlpha * (1.0 - mask.a);\n\n    var a = (alphaMul * mask.r) * clip;\n\n    return vec4(source.rgb, source.a) * a;\n}",Hg=Object.defineProperty,jg=Object.defineProperties,Vg=Object.getOwnPropertyDescriptors,Wg=Object.getOwnPropertySymbols,$g=Object.prototype.hasOwnProperty,Yg=Object.prototype.propertyIsEnumerable,qg=(t,e,r)=>e in t?Hg(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r;class Kg extends gf{constructor(t){const e=t,{sprite:r}=e,s=((t,e)=>{var r={};for(var s in t)$g.call(t,s)&&e.indexOf(s)<0&&(r[s]=t[s]);if(null!=t&&Wg)for(var s of Wg(t))e.indexOf(s)<0&&Yg.call(t,s)&&(r[s]=t[s]);return r})(e,["sprite"]),i=new Xr(r.texture),n=new vn({uFilterMatrix:{value:new it,type:"mat3x3<f32>"},uMaskClamp:{value:i.uClampFrame,type:"vec4<f32>"},uAlpha:{value:1,type:"f32"}}),o=yl.from({vertex:{source:zg,entryPoint:"mainVertex"},fragment:{source:zg,entryPoint:"mainFragment"}}),a=ll.from({vertex:Xg,fragment:Lg,name:"mask-filter"});super(((t,e)=>jg(t,Vg(e)))(((t,e)=>{for(var r in e||(e={}))$g.call(e,r)&&qg(t,r,e[r]);if(Wg)for(var r of Wg(e))Yg.call(e,r)&&qg(t,r,e[r]);return t})({},s),{gpuProgram:o,glProgram:a,resources:{filterUniforms:n,uMaskTexture:r.texture.source}})),this.sprite=r,this._textureMatrix=i}apply(t,e,r,s){this._textureMatrix.texture=this.sprite.texture,t.calculateSpriteMatrix(this.resources.filterUniforms.uniforms.uFilterMatrix,this.sprite).prepend(this._textureMatrix.mapCoord),this.resources.uMaskTexture=this.sprite.texture.source,t.applyFilter(this,e,r,s)}}class Zg{constructor(t=0,e=0,r=0,s=0,i=0,n=0){this.type="triangle",this.x=t,this.y=e,this.x2=r,this.y2=s,this.x3=i,this.y3=n}contains(t,e){const r=(this.x-this.x3)*(e-this.y3)-(this.y-this.y3)*(t-this.x3),s=(this.x2-this.x)*(e-this.y)-(this.y2-this.y)*(t-this.x);if(r<0!=s<0&&0!==r&&0!==s)return!1;const i=(this.x3-this.x2)*(e-this.y2)-(this.y3-this.y2)*(t-this.x2);return 0===i||i<0==r+s<=0}strokeContains(t,e,r){const s=r/2,i=s*s,{x:n,x2:o,x3:a,y:l,y2:h,y3:u}=this;return ho(t,e,n,l,o,u)<=i||ho(t,e,o,h,a,u)<=i||ho(t,e,a,u,n,l)<=i}clone(){return new Zg(this.x,this.y,this.x2,this.y2,this.x3,this.y3)}copyFrom(t){return this.x=t.x,this.y=t.y,this.x2=t.x2,this.y2=t.y2,this.x3=t.x3,this.y3=t.y3,this}copyTo(t){return t.copyFrom(this),t}getBounds(t){t=t||new vt;const e=Math.min(this.x,this.x2,this.x3),r=Math.max(this.x,this.x2,this.x3),s=Math.min(this.y,this.y2,this.y3),i=Math.max(this.y,this.y2,this.y3);return t.x=e,t.y=s,t.width=r-e,t.height=i-s,t}}const Qg=class t{constructor(e){this._tick=()=>{this.timeout=setTimeout(this._processQueue,0)},this._processQueue=()=>{const{queue:e}=this;let r=0;for(;e.length&&r<t.uploadsPerFrame;){const t=e.shift();this.uploadQueueItem(t),r++}e.length?_e.system.addOnce(this._tick,this,fe.UTILITY):this._resolve()},this.renderer=e,this.queue=[],this.resolves=[]}getQueue(){return[...this.queue]}add(t){const e=Array.isArray(t)?t:[t];for(const t of e)t instanceof jt?this._addContainer(t):this.resolveQueueItem(t,this.queue);return this}_addContainer(t){this.resolveQueueItem(t,this.queue);for(const e of t.children)this._addContainer(e)}upload(t){return t&&this.add(t),new Promise((t=>{this.queue.length?(this.resolves.push(t),this.dedupeQueue(),_e.system.addOnce(this._tick,this,fe.UTILITY)):t()}))}dedupeQueue(){const t=Object.create(null);let e=0;for(let r=0;r<this.queue.length;r++){const s=this.queue[r];t[s.uid]||(t[s.uid]=!0,this.queue[e++]=s)}this.queue.length=e}_resolve(){const{resolves:t}=this,e=t.slice(0);t.length=0;for(const t of e)t()}};Qg.uploadsPerFrame=4;let Jg=Qg;var tm=Object.defineProperty,em=Object.getOwnPropertySymbols,rm=Object.prototype.hasOwnProperty,sm=Object.prototype.propertyIsEnumerable,im=(t,e,r)=>e in t?tm(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r;const nm=new uo;class om extends jt{constructor(...t){var e;let r=t[0];r instanceof Is&&(r={geometry:r,shader:t[1]},t[3]&&(r.geometry.topology=t[3]));const s=r,{geometry:i,shader:n,texture:o,roundPixels:a,state:l}=s,h=((t,e)=>{var r={};for(var s in t)rm.call(t,s)&&e.indexOf(s)<0&&(r[s]=t[s]);if(null!=t&&em)for(var s of em(t))e.indexOf(s)<0&&sm.call(t,s)&&(r[s]=t[s]);return r})(s,["geometry","shader","texture","roundPixels","state"]);super(((t,e)=>{for(var r in e||(e={}))rm.call(e,r)&&im(t,r,e[r]);if(em)for(var r of em(e))sm.call(e,r)&&im(t,r,e[r]);return t})({label:"Mesh"},h)),this.renderPipeId="mesh",this.canBundle=!0,this._roundPixels=0,this.allowChildren=!1,this.shader=n,this.texture=null!=(e=null!=o?o:null==n?void 0:n.texture)?e:zr.WHITE,this.state=null!=l?l:an.for2d(),this._geometry=i,this._geometry.on("update",this.onViewUpdate,this),this.roundPixels=null!=a&&a}get roundPixels(){return!!this._roundPixels}set roundPixels(t){this._roundPixels=t?1:0}get material(){return this._shader}set shader(t){this._shader!==t&&(this._shader=t,this.onViewUpdate())}get shader(){return this._shader}set geometry(t){var e;this._geometry!==t&&(null==(e=this._geometry)||e.off("update",this.onViewUpdate,this),t.on("update",this.onViewUpdate,this),this._geometry=t,this.onViewUpdate())}get geometry(){return this._geometry}set texture(t){t||(t=zr.EMPTY);const e=this._texture;e!==t&&(e&&e.dynamic&&e.off("update",this.onViewUpdate,this),t.dynamic&&t.on("update",this.onViewUpdate,this),this.shader&&(this.shader.texture=t),this._texture=t,this.onViewUpdate())}get texture(){return this._texture}get batched(){return!this._shader&&(this._geometry instanceof Zh&&("auto"===this._geometry.batchMode?this._geometry.positions.length/2<=100:"batch"===this._geometry.batchMode))}get bounds(){return this._geometry.bounds}addBounds(t){t.addBounds(this.geometry.bounds)}containsPoint(t){const{x:e,y:r}=t;if(!this.bounds.containsPoint(e,r))return!1;const s=this.geometry.getBuffer("aPosition").data,i=nm.points,n=this.geometry.getIndex().data,o=n.length,a="triangle-strip"===this.geometry.topology?3:1;for(let t=0;t+2<o;t+=a){const o=2*n[t],a=2*n[t+1],l=2*n[t+2];if(i[0]=s[o],i[1]=s[o+1],i[2]=s[a],i[3]=s[a+1],i[4]=s[l],i[5]=s[l+1],nm.contains(e,r))return!0}return!1}onViewUpdate(){this._didChangeId+=4096,!this.didViewUpdate&&(this.didViewUpdate=!0,this.renderGroup&&this.renderGroup.onChildViewUpdate(this))}destroy(t){var e;if(super.destroy(t),"boolean"==typeof t?t:null==t?void 0:t.texture){const e="boolean"==typeof t?t:null==t?void 0:t.textureSource;this._texture.destroy(e)}null==(e=this._geometry)||e.off("update",this.onViewUpdate,this),this._texture=null,this._geometry=null,this._shader=null}}class am extends ts{constructor(t,e=!0){super(t[0]instanceof zr?t[0]:t[0].texture),this._textures=null,this._durations=null,this._autoUpdate=e,this._isConnectedToTicker=!1,this.animationSpeed=1,this.loop=!0,this.updateAnchor=!1,this.onComplete=null,this.onFrameChange=null,this.onLoop=null,this._currentTime=0,this._playing=!1,this._previousFrame=null,this.textures=t}stop(){this._playing&&(this._playing=!1,this._autoUpdate&&this._isConnectedToTicker&&(_e.shared.remove(this.update,this),this._isConnectedToTicker=!1))}play(){this._playing||(this._playing=!0,this._autoUpdate&&!this._isConnectedToTicker&&(_e.shared.add(this.update,this,fe.HIGH),this._isConnectedToTicker=!0))}gotoAndStop(t){this.stop(),this.currentFrame=t}gotoAndPlay(t){this.currentFrame=t,this.play()}update(t){if(!this._playing)return;const e=t.deltaTime,r=this.animationSpeed*e,s=this.currentFrame;if(null!==this._durations){let t=this._currentTime%1*this._durations[this.currentFrame];for(t+=r/60*1e3;t<0;)this._currentTime--,t+=this._durations[this.currentFrame];const s=Math.sign(this.animationSpeed*e);for(this._currentTime=Math.floor(this._currentTime);t>=this._durations[this.currentFrame];)t-=this._durations[this.currentFrame]*s,this._currentTime+=s;this._currentTime+=t/this._durations[this.currentFrame]}else this._currentTime+=r;this._currentTime<0&&!this.loop?(this.gotoAndStop(0),this.onComplete&&this.onComplete()):this._currentTime>=this._textures.length&&!this.loop?(this.gotoAndStop(this._textures.length-1),this.onComplete&&this.onComplete()):s!==this.currentFrame&&(this.loop&&this.onLoop&&(this.animationSpeed>0&&this.currentFrame<s||this.animationSpeed<0&&this.currentFrame>s)&&this.onLoop(),this._updateTexture())}_updateTexture(){const t=this.currentFrame;this._previousFrame!==t&&(this._previousFrame=t,this.texture=this._textures[t],this.updateAnchor&&this.anchor.copyFrom(this.texture.defaultAnchor),this.onFrameChange&&this.onFrameChange(this.currentFrame))}destroy(){this.stop(),super.destroy(),this.onComplete=null,this.onFrameChange=null,this.onLoop=null}static fromFrames(t){const e=[];for(let r=0;r<t.length;++r)e.push(zr.from(t[r]));return new am(e)}static fromImages(t){const e=[];for(let r=0;r<t.length;++r)e.push(zr.from(t[r]));return new am(e)}get totalFrames(){return this._textures.length}get textures(){return this._textures}set textures(t){if(t[0]instanceof zr)this._textures=t,this._durations=null;else{this._textures=[],this._durations=[];for(let e=0;e<t.length;e++)this._textures.push(t[e].texture),this._durations.push(t[e].time)}this._previousFrame=null,this.gotoAndStop(0),this._updateTexture()}get currentFrame(){let t=Math.floor(this._currentTime)%this._textures.length;return t<0&&(t+=this._textures.length),t}set currentFrame(t){if(t<0||t>this.totalFrames-1)throw new Error(`[AnimatedSprite]: Invalid frame index value ${t}, expected to be between 0 and totalFrames ${this.totalFrames}.`);const e=this.currentFrame;this._currentTime=t,e!==this.currentFrame&&this._updateTexture()}get playing(){return this._playing}get autoUpdate(){return this._autoUpdate}set autoUpdate(t){t!==this._autoUpdate&&(this._autoUpdate=t,!this._autoUpdate&&this._isConnectedToTicker?(_e.shared.remove(this.update,this),this._isConnectedToTicker=!1):this._autoUpdate&&!this._isConnectedToTicker&&this._playing&&(_e.shared.add(this.update,this),this._isConnectedToTicker=!0))}}class lm{constructor({matrix:t,observer:e}={}){this.dirty=!0,this._matrix=null!=t?t:new it,this.observer=e,this.position=new at(this,0,0),this.scale=new at(this,1,1),this.pivot=new at(this,0,0),this.skew=new at(this,0,0),this._rotation=0,this._cx=1,this._sx=0,this._cy=0,this._sy=1}get matrix(){const t=this._matrix;return this.dirty&&(t.a=this._cx*this.scale.x,t.b=this._sx*this.scale.x,t.c=this._cy*this.scale.y,t.d=this._sy*this.scale.y,t.tx=this.position.x-(this.pivot.x*t.a+this.pivot.y*t.c),t.ty=this.position.y-(this.pivot.x*t.b+this.pivot.y*t.d),this.dirty=!1),t}_onUpdate(t){var e;this.dirty=!0,t===this.skew&&this.updateSkew(),null==(e=this.observer)||e._onUpdate(this)}updateSkew(){this._cx=Math.cos(this._rotation+this.skew.y),this._sx=Math.sin(this._rotation+this.skew.y),this._cy=-Math.sin(this._rotation-this.skew.x),this._sy=Math.cos(this._rotation-this.skew.x),this.dirty=!0}setFromMatrix(t){t.decompose(this),this.dirty=!0}get rotation(){return this._rotation}set rotation(t){this._rotation!==t&&(this._rotation=t,this._onUpdate(this.skew))}}var hm=Object.defineProperty,um=Object.getOwnPropertySymbols,cm=Object.prototype.hasOwnProperty,dm=Object.prototype.propertyIsEnumerable,pm=(t,e,r)=>e in t?hm(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r,fm=(t,e)=>{for(var r in e||(e={}))cm.call(e,r)&&pm(t,r,e[r]);if(um)for(var r of um(e))dm.call(e,r)&&pm(t,r,e[r]);return t};const gm=class t extends jt{constructor(...e){let r=e[0]||{};r instanceof zr&&(r={texture:r}),e.length>1&&(r.width=e[1],r.height=e[2]),r=fm(fm({},t.defaultOptions),r);const s=null!=r?r:{},{texture:i,anchor:n,tilePosition:o,tileScale:a,tileRotation:l,width:h,height:u,applyAnchorToTexture:c,roundPixels:d}=s,p=((t,e)=>{var r={};for(var s in t)cm.call(t,s)&&e.indexOf(s)<0&&(r[s]=t[s]);if(null!=t&&um)for(var s of um(t))e.indexOf(s)<0&&dm.call(t,s)&&(r[s]=t[s]);return r})(s,["texture","anchor","tilePosition","tileScale","tileRotation","width","height","applyAnchorToTexture","roundPixels"]);super(fm({label:"TilingSprite"},p)),this.renderPipeId="tilingSprite",this.canBundle=!0,this.batched=!0,this._roundPixels=0,this._bounds={minX:0,maxX:1,minY:0,maxY:0},this._boundsDirty=!0,this.allowChildren=!1,this._anchor=new at(this),this._applyAnchorToTexture=c,this.texture=i,this._width=null!=h?h:i.width,this._height=null!=u?u:i.height,this._tileTransform=new lm({observer:{_onUpdate:()=>this.onViewUpdate()}}),n&&(this.anchor=n),this.tilePosition=o,this.tileScale=a,this.tileRotation=l,this.roundPixels=null!=d&&d}static from(e,r={}){return new t(fm("string"==typeof e?{texture:Ts.get(e)}:{texture:e},r))}get clampMargin(){return this._texture.textureMatrix.clampMargin}set clampMargin(t){this._texture.textureMatrix.clampMargin=t}get anchor(){return this._anchor}set anchor(t){"number"==typeof t?this._anchor.set(t):this._anchor.copyFrom(t)}get tilePosition(){return this._tileTransform.position}set tilePosition(t){this._tileTransform.position.copyFrom(t)}get tileScale(){return this._tileTransform.scale}set tileScale(t){"number"==typeof t?this._tileTransform.scale.set(t):this._tileTransform.scale.copyFrom(t)}set tileRotation(t){this._tileTransform.rotation=t}get tileRotation(){return this._tileTransform.rotation}get tileTransform(){return this._tileTransform}get roundPixels(){return!!this._roundPixels}set roundPixels(t){this._roundPixels=t?1:0}get bounds(){return this._boundsDirty&&(this._updateBounds(),this._boundsDirty=!1),this._bounds}set texture(t){t||(t=zr.EMPTY);const e=this._texture;e!==t&&(e&&e.dynamic&&e.off("update",this.onViewUpdate,this),t.dynamic&&t.on("update",this.onViewUpdate,this),this._texture=t,this.onViewUpdate())}get texture(){return this._texture}set width(t){this._width=t,this.onViewUpdate()}get width(){return this._width}set height(t){this._height=t,this.onViewUpdate()}get height(){return this._height}_updateBounds(){const t=this._bounds,e=this._anchor,r=this._width,s=this._height;t.maxX=-e._x*r,t.minX=t.maxX+r,t.maxY=-e._y*s,t.minY=t.maxY+s}addBounds(t){const e=this.bounds;t.addFrame(e.minX,e.minY,e.maxX,e.maxY)}containsPoint(t){const e=this.bounds.minX,r=this.bounds.minY,s=-e*this._anchor._x;let i=0;return t.x>=s&&t.x<=s+e&&(i=-r*this._anchor._y,t.y>=i&&t.y<=i+r)}onViewUpdate(){this._boundsDirty=!0,this._didTilingSpriteUpdate=!0,this._didChangeId+=4096,!this.didViewUpdate&&(this.didViewUpdate=!0,this.renderGroup&&this.renderGroup.onChildViewUpdate(this))}destroy(t=!1){if(super.destroy(t),this._anchor=null,this._tileTransform=null,this._bounds=null,"boolean"==typeof t?t:null==t?void 0:t.texture){const e="boolean"==typeof t?t:null==t?void 0:t.textureSource;this._texture.destroy(e)}this._texture=null}};gm.defaultOptions={texture:zr.EMPTY,anchor:{x:0,y:0},tilePosition:{x:0,y:0},tileScale:{x:1,y:1},tileRotation:0,applyAnchorToTexture:!1};let mm=gm;var _m=Object.defineProperty,xm=Object.getOwnPropertySymbols,ym=Object.prototype.hasOwnProperty,bm=Object.prototype.propertyIsEnumerable,vm=(t,e,r)=>e in t?_m(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r;class Tm extends jt{constructor(t,e){const r=t,{text:s,resolution:i,style:n,anchor:o,width:a,height:l,roundPixels:h}=r,u=((t,e)=>{var r={};for(var s in t)ym.call(t,s)&&e.indexOf(s)<0&&(r[s]=t[s]);if(null!=t&&xm)for(var s of xm(t))e.indexOf(s)<0&&bm.call(t,s)&&(r[s]=t[s]);return r})(r,["text","resolution","style","anchor","width","height","roundPixels"]);super(((t,e)=>{for(var r in e||(e={}))ym.call(e,r)&&vm(t,r,e[r]);if(xm)for(var r of xm(e))bm.call(e,r)&&vm(t,r,e[r]);return t})({},u)),this.batched=!0,this.resolution=null,this._didTextUpdate=!0,this._roundPixels=0,this._bounds=new St,this._boundsDirty=!0,this._styleClass=e,this.text=null!=s?s:"",this.style=n,this.resolution=null!=i?i:null,this.allowChildren=!1,this._anchor=new at({_onUpdate:()=>{this.onViewUpdate()}}),o&&(this.anchor=o),this.roundPixels=null!=h&&h,a&&(this.width=a),l&&(this.height=l)}get anchor(){return this._anchor}set anchor(t){"number"==typeof t?this._anchor.set(t):this._anchor.copyFrom(t)}get roundPixels(){return!!this._roundPixels}set roundPixels(t){this._roundPixels=t?1:0}set text(t){t=t.toString(),this._text!==t&&(this._text=t,this.onViewUpdate())}get text(){return this._text}get style(){return this._style}set style(t){var e;t=t||{},null==(e=this._style)||e.off("update",this.onViewUpdate,this),t instanceof this._styleClass?this._style=t:this._style=new this._styleClass(t),this._style.on("update",this.onViewUpdate,this),this.onViewUpdate()}get bounds(){return this._boundsDirty&&(this._updateBounds(),this._boundsDirty=!1),this._bounds}get width(){return Math.abs(this.scale.x)*this.bounds.width}set width(t){this._setWidth(t,this.bounds.width)}get height(){return Math.abs(this.scale.y)*this.bounds.height}set height(t){this._setHeight(t,this.bounds.height)}getSize(t){return t||(t={}),t.width=Math.abs(this.scale.x)*this.bounds.width,t.height=Math.abs(this.scale.y)*this.bounds.height,t}setSize(t,e){var r;let s,i;"object"!=typeof t?(s=t,i=null!=e?e:t):(s=t.width,i=null!=(r=t.height)?r:t.width),void 0!==s&&this._setWidth(s,this.bounds.width),void 0!==i&&this._setHeight(i,this.bounds.height)}addBounds(t){const e=this.bounds;t.addFrame(e.minX,e.minY,e.maxX,e.maxY)}containsPoint(t){const e=this.bounds.maxX,r=this.bounds.maxY,s=-e*this.anchor.x;let i=0;return t.x>=s&&t.x<=s+e&&(i=-r*this.anchor.y,t.y>=i&&t.y<=i+r)}onViewUpdate(){this._didChangeId+=4096,this._boundsDirty=!0,!this.didViewUpdate&&(this.didViewUpdate=!0,this._didTextUpdate=!0,this.renderGroup&&this.renderGroup.onChildViewUpdate(this))}_getKey(){return`${this.text}:${this._style.styleKey}`}destroy(t=!1){super.destroy(t),this.owner=null,this._bounds=null,this._anchor=null,("boolean"==typeof t?t:null!=t&&t.style)&&this._style.destroy(t),this._style=null,this._text=null}}function Sm(t,e){var r;let s=null!=(r=t[0])?r:{};return("string"==typeof s||t[1])&&(s={text:s,style:t[1]}),s}class wm extends Tm{constructor(...t){super(Sm(t),xa),this.renderPipeId="text"}_updateBounds(){const t=this._bounds,e=this._style.padding,r=this._anchor,s=$n.measureText(this._text,this._style),{width:i,height:n}=s;t.minX=-r._x*i-e,t.maxX=t.minX+i,t.minY=-r._y*n-e,t.maxY=t.minY+n}}class Em extends Jg{resolveQueueItem(t,e){return t instanceof jt?this.resolveContainerQueueItem(t,e):t instanceof Cr||t instanceof zr?e.push(t.source):t instanceof aa&&e.push(t),null}resolveContainerQueueItem(t,e){t instanceof ts||t instanceof mm||t instanceof om?e.push(t.texture.source):t instanceof wm?e.push(t):t instanceof Xa?e.push(t.context):t instanceof am&&t.textures.forEach((t=>{t.source?e.push(t.source):e.push(t.texture.source)}))}resolveGraphicsContextQueueItem(t){this.renderer.graphicsContext.getContextRenderData(t);const{instructions:e}=t;for(const t of e){if("texture"===t.action){const{image:e}=t.data;return e.source}if("fill"===t.action){const{texture:e}=t.data.style;return e.source}}return null}}class Am extends Tm{constructor(...t){var e;const r=Sm(t);null!=r.style||(r.style=r.style||{}),null!=(e=r.style).fill||(e.fill=16777215),super(r,xa),this.renderPipeId="bitmapText"}_updateBounds(){const t=this._bounds,e=this._style.padding,r=this._anchor,s=Pa.measureText(this.text,this._style),i=s.scale,n=s.offsetY*i,o=s.width*i,a=s.height*i;t.minX=-r._x*o-e,t.maxX=t.minX+o,t.minY=-r._y*(a+n)-e,t.maxY=t.minY+a}}class Mm extends Tm{constructor(...t){super(Sm(t),Ih),this.renderPipeId="htmlText"}_updateBounds(){const t=this._bounds,e=this._style.padding,r=this._anchor,s=zh(this.text,this._style),{width:i,height:n}=s;t.minX=-r._x*i-e,t.maxX=t.minX+i,t.minY=-r._y*n-e,t.maxY=t.minY+n}}class Pm extends Em{uploadQueueItem(t){t instanceof Cr?this.uploadTextureSource(t):t instanceof wm?this.uploadText(t):t instanceof Mm?this.uploadHTMLText(t):t instanceof Am?this.uploadBitmapText(t):t instanceof aa&&this.uploadGraphicsContext(t)}uploadTextureSource(t){this.renderer.texture.initSource(t)}uploadText(t){this.renderer.renderPipes.text.initGpuText(t)}uploadBitmapText(t){this.renderer.renderPipes.bitmapText.initGpuText(t)}uploadHTMLText(t){this.renderer.renderPipes.htmlText.initGpuText(t)}uploadGraphicsContext(t){this.renderer.graphicsContext.getContextRenderData(t);const{instructions:e}=t;for(const t of e)if("texture"===t.action){const{image:e}=t.data;this.uploadTextureSource(e.source)}else if("fill"===t.action){const{texture:e}=t.data.style;this.uploadTextureSource(e.source)}return null}}class Rm extends Pm{destroy(){clearTimeout(this.timeout),this.renderer=null,this.queue=null,this.resolves=null}}Rm.extension={type:[u.WebGLSystem,u.WebGPUSystem],name:"prepare"};class Om{constructor(){this._didUpload=!1,this._tempState=an.for2d()}init(t){const e=Yl({name:"batch",bits:[Kl,sh(Fs),nh]});this._shader=new fh({glProgram:e,resources:{batchSamplers:ah}}),t.renderer.runners.contextChange.add(this)}contextChange(){this._didUpload=!1}start(t,e){const r=t.renderer;r.shader.bind(this._shader,this._didUpload),r.shader.updateUniformGroup(r.globalUniforms.uniformGroup),r.geometry.bind(e,this._shader.glProgram)}execute(t,e){const r=t.renderer;this._didUpload=!0,this._tempState.blendMode=e.blendMode,r.state.set(this._tempState);const s=e.textures.textures;for(let t=0;t<s.length;t++)r.texture.bind(s[t],t);r.geometry.draw("triangle-list",e.size,e.start)}destroy(){this._shader.destroy(!0),this._shader=null}}Om.extension={type:[u.WebGLPipesAdaptor],name:"batch"};const Cm=an.for2d();class Im{init(){const t=$l({name:"batch",bits:[ql,th(Fs),ih]});this._shader=new fh({gpuProgram:t,groups:{}})}start(t,e){const r=t.renderer,s=r.encoder,i=this._shader.gpuProgram;this._geometry=e,s.setGeometry(e),Cm.blendMode="normal",r.pipeline.getPipeline(e,i,Cm);const n=r.globalUniforms.bindGroup;s.resetBindGroup(1),s.setBindGroup(0,n,i)}execute(t,e){const r=this._shader.gpuProgram,s=t.renderer,i=s.encoder;if(!e.bindGroup){const t=e.textures;e.bindGroup=Us(t.textures,t.count)}Cm.blendMode=e.blendMode;const n=s.bindGroup.getBindGroup(e.bindGroup,r,1),o=s.pipeline.getPipeline(this._geometry,r,Cm);e.bindGroup._touch(s.textureGC.count),i.setPipeline(o),i.renderPassEncoder.setBindGroup(1,n),i.renderPassEncoder.drawIndexed(e.size,1,e.start)}destroy(){this._shader.destroy(!0),this._shader=null}}Im.extension={type:[u.WebGPUPipesAdaptor],name:"batch"};class Gm{constructor(t,e){this.state=an.for2d(),this._batches=Object.create(null),this._geometries=Object.create(null),this.renderer=t,this._adaptor=e,this._adaptor.init(this)}buildStart(t){if(!this._batches[t.uid]){const e=new ei;this._batches[t.uid]=e,this._geometries[e.uid]=new Bs}this._activeBatch=this._batches[t.uid],this._activeGeometry=this._geometries[this._activeBatch.uid],this._activeBatch.begin()}addToBatch(t){this._activeBatch.add(t)}break(t){this._activeBatch.break(t)}buildEnd(t){const e=this._activeBatch,r=this._activeGeometry;e.finish(t),r.indexBuffer.setDataWithSize(e.indexBuffer,e.indexSize,!0),r.buffers[0].setDataWithSize(e.attributeBuffer.float32View,e.attributeSize,!1)}upload(t){const e=this._batches[t.uid],r=this._geometries[e.uid];e.dirty&&(e.dirty=!1,r.buffers[0].update(4*e.attributeSize))}execute(t){if("startBatch"===t.action){const e=t.batcher,r=this._geometries[e.uid];this._adaptor.start(this,r)}this._adaptor.execute(this,t)}destroy(){this.state=null,this.renderer=null,this._adaptor.destroy(),this._adaptor=null;for(const t in this._batches)this._batches[t].destroy();this._batches=null;for(const t in this._geometries)this._geometries[t].destroy();this._geometries=null}}Gm.extension={type:[u.WebGLPipes,u.WebGPUPipes,u.CanvasPipes],name:"batch"};const km={name:"texture-bit",vertex:{header:"\n\n        struct TextureUniforms {\n            uTextureMatrix:mat3x3<f32>,\n        }\n\n        @group(2) @binding(2) var<uniform> textureUniforms : TextureUniforms;\n        ",main:"\n            uv = (textureUniforms.uTextureMatrix * vec3(uv, 1.0)).xy;\n        "},fragment:{header:"\n            @group(2) @binding(0) var uTexture: texture_2d<f32>;\n            @group(2) @binding(1) var uSampler: sampler;\n\n         \n        ",main:"\n            outColor = textureSample(uTexture, uSampler, vUV);\n        "}},Bm={name:"texture-bit",vertex:{header:"\n            uniform mat3 uTextureMatrix;\n        ",main:"\n            uv = (uTextureMatrix * vec3(uv, 1.0)).xy;\n        "},fragment:{header:"\n        uniform sampler2D uTexture;\n\n         \n        ",main:"\n            outColor = texture(uTexture, vUV);\n        "}};function Dm(t,e){const r=t.root,s=t.instructionSet;s.reset(),e.batch.buildStart(s),e.blendMode.buildStart(),e.colorMask.buildStart(),r.sortableChildren&&r.sortChildren(),Nm(r,s,e,!0),e.batch.buildEnd(s),e.blendMode.buildEnd(s)}function Fm(t,e,r){t.globalDisplayStatus<7||!t.includeInBuild||(t.sortableChildren&&t.sortChildren(),t.isSimple?function(t,e,r){if(t.renderPipeId&&(r.blendMode.setBlendMode(t,t.groupBlendMode,e),t.didViewUpdate=!1,r[t.renderPipeId].addRenderable(t,e)),!t.isRenderGroupRoot){const s=t.children,i=s.length;for(let t=0;t<i;t++)Fm(s[t],e,r)}}(t,e,r):Nm(t,e,r,!1))}function Nm(t,e,r,s){if(!s&&t.isRenderGroupRoot)r.renderGroup.addRenderGroup(t.renderGroup,e);else{for(let s=0;s<t.effects.length;s++){const i=t.effects[s];r[i.pipe].push(i,t,e)}const s=t.renderPipeId;s&&(r.blendMode.setBlendMode(t,t.groupBlendMode,e),t.didViewUpdate=!1,r[s].addRenderable(t,e));const i=t.children;if(i.length)for(let t=0;t<i.length;t++)Fm(i[t],e,r);for(let s=t.effects.length-1;s>=0;s--){const i=t.effects[s];r[i.pipe].pop(i,t,e)}}}const Um=new St;class Lm extends dt{constructor(){super({filters:[new Kg({sprite:new ts(zr.EMPTY)})]})}get sprite(){return this.filters[0].sprite}set sprite(t){this.filters[0].sprite=t}}class Xm{constructor(t){this._activeMaskStage=[],this._renderer=t}push(t,e,r){const s=this._renderer;if(s.renderPipes.batch.break(r),r.add({renderPipeId:"alphaMask",action:"pushMaskBegin",mask:t,canBundle:!1,maskedContainer:e}),t.renderMaskToTexture){const e=t.mask;e.includeInBuild=!0,Fm(e,r,s.renderPipes),e.includeInBuild=!1}s.renderPipes.batch.break(r),r.add({renderPipeId:"alphaMask",action:"pushMaskEnd",mask:t,maskedContainer:e,canBundle:!1})}pop(t,e,r){this._renderer.renderPipes.batch.break(r),r.add({renderPipeId:"alphaMask",action:"popMaskEnd",mask:t,canBundle:!1})}execute(t){const e=this._renderer,r=t.mask.renderMaskToTexture;if("pushMaskBegin"===t.action){const s=gt.get(Lm);if(r){t.mask.mask.measurable=!0;const r=At(t.mask.mask,!0,Um);t.mask.mask.measurable=!1,r.ceil();const i=Fn.getOptimalTexture(r.width,r.height,1,!1);e.renderTarget.push(i,!0),e.globalUniforms.push({offset:r,worldColor:4294967295});const n=s.sprite;n.texture=i,n.worldTransform.tx=r.minX,n.worldTransform.ty=r.minY,this._activeMaskStage.push({filterEffect:s,maskedContainer:t.maskedContainer,filterTexture:i})}else s.sprite=t.mask.mask,this._activeMaskStage.push({filterEffect:s,maskedContainer:t.maskedContainer})}else if("pushMaskEnd"===t.action){const t=this._activeMaskStage[this._activeMaskStage.length-1];r&&(e.renderTarget.pop(),e.globalUniforms.pop()),e.filter.push({renderPipeId:"filter",action:"pushFilter",container:t.maskedContainer,filterEffect:t.filterEffect,canBundle:!1})}else if("popMaskEnd"===t.action){e.filter.pop();const t=this._activeMaskStage.pop();r&&Fn.returnTexture(t.filterTexture),gt.return(t.filterEffect)}}destroy(){this._renderer=null,this._activeMaskStage=null}}Xm.extension={type:[u.WebGLPipes,u.WebGPUPipes,u.CanvasPipes],name:"alphaMask"};class zm{constructor(t){this._colorStack=[],this._colorStackIndex=0,this._currentColor=0,this._renderer=t}buildStart(){this._colorStack[0]=15,this._colorStackIndex=1,this._currentColor=15}push(t,e,r){this._renderer.renderPipes.batch.break(r);const s=this._colorStack;s[this._colorStackIndex]=s[this._colorStackIndex-1]&t.mask;const i=this._colorStack[this._colorStackIndex];i!==this._currentColor&&(this._currentColor=i,r.add({renderPipeId:"colorMask",colorMask:i,canBundle:!1})),this._colorStackIndex++}pop(t,e,r){this._renderer.renderPipes.batch.break(r);const s=this._colorStack;this._colorStackIndex--;const i=s[this._colorStackIndex-1];i!==this._currentColor&&(this._currentColor=i,r.add({renderPipeId:"colorMask",colorMask:i,canBundle:!1}))}execute(t){this._renderer.colorMask.setMask(t.colorMask)}destroy(){this._colorStack=null}}zm.extension={type:[u.WebGLPipes,u.WebGPUPipes,u.CanvasPipes],name:"colorMask"};class Hm{constructor(t){this._maskStackHash={},this._maskHash=new WeakMap,this._renderer=t}push(t,e,r){var s;const i=t,n=this._renderer;n.renderPipes.batch.break(r),n.renderPipes.blendMode.setBlendMode(i.mask,"none",r),r.add({renderPipeId:"stencilMask",action:"pushMaskBegin",mask:t,canBundle:!1});const o=i.mask;o.includeInBuild=!0,this._maskHash.has(i)||this._maskHash.set(i,{instructionsStart:0,instructionsLength:0});const a=this._maskHash.get(i);a.instructionsStart=r.instructionSize,Fm(o,r,n.renderPipes),o.includeInBuild=!1,n.renderPipes.batch.break(r),r.add({renderPipeId:"stencilMask",action:"pushMaskEnd",mask:t,canBundle:!1});const l=r.instructionSize-a.instructionsStart-1;a.instructionsLength=l;const h=n.renderTarget.renderTarget.uid;null!=(s=this._maskStackHash)[h]||(s[h]=0)}pop(t,e,r){const s=t,i=this._renderer;i.renderPipes.batch.break(r),i.renderPipes.blendMode.setBlendMode(s.mask,"none",r),r.add({renderPipeId:"stencilMask",action:"popMaskBegin",canBundle:!1});const n=this._maskHash.get(t);for(let t=0;t<n.instructionsLength;t++)r.instructions[r.instructionSize++]=r.instructions[n.instructionsStart++];r.add({renderPipeId:"stencilMask",action:"popMaskEnd",canBundle:!1})}execute(t){var e,r;const s=this._renderer,i=s.renderTarget.renderTarget.uid;let n=null!=(r=(e=this._maskStackHash)[i])?r:e[i]=0;"pushMaskBegin"===t.action?(s.renderTarget.ensureDepthStencil(),s.stencil.setStencilMode(Hs.RENDERING_MASK_ADD,n),n++,s.colorMask.setMask(0)):"pushMaskEnd"===t.action?(s.stencil.setStencilMode(Hs.MASK_ACTIVE,n),s.colorMask.setMask(15)):"popMaskBegin"===t.action?(s.colorMask.setMask(0),0!==n?s.stencil.setStencilMode(Hs.RENDERING_MASK_REMOVE,n):(s.renderTarget.clear(null,Ku.STENCIL),s.stencil.setStencilMode(Hs.DISABLED,n)),n--):"popMaskEnd"===t.action&&(s.stencil.setStencilMode(Hs.MASK_ACTIVE,n),s.colorMask.setMask(15)),this._maskStackHash[i]=n}destroy(){this._renderer=null,this._maskStackHash=null,this._maskHash=null}}Hm.extension={type:[u.WebGLPipes,u.WebGPUPipes,u.CanvasPipes],name:"stencilMask"};var jm=(t=>(t[t.ELEMENT_ARRAY_BUFFER=34963]="ELEMENT_ARRAY_BUFFER",t[t.ARRAY_BUFFER=34962]="ARRAY_BUFFER",t[t.UNIFORM_BUFFER=35345]="UNIFORM_BUFFER",t))(jm||{});class Vm{constructor(t,e){this.buffer=t||null,this.updateID=-1,this.byteLength=-1,this.type=e}}class Wm{constructor(t){this._gpuBuffers=Object.create(null),this._boundBufferBases=Object.create(null),this._renderer=t}destroy(){this._renderer=null,this._gl=null,this._gpuBuffers=null,this._boundBufferBases=null}contextChange(){this._gpuBuffers=Object.create(null),this._gl=this._renderer.gl}getGlBuffer(t){return this._gpuBuffers[t.uid]||this.createGLBuffer(t)}bind(t){const{_gl:e}=this,r=this.getGlBuffer(t);e.bindBuffer(r.type,r.buffer)}bindBufferBase(t,e){const{_gl:r}=this;if(this._boundBufferBases[e]!==t){const s=this.getGlBuffer(t);this._boundBufferBases[e]=t,r.bindBufferBase(r.UNIFORM_BUFFER,e,s.buffer)}}bindBufferRange(t,e,r){const{_gl:s}=this;r=r||0;const i=this.getGlBuffer(t);s.bindBufferRange(s.UNIFORM_BUFFER,e||0,i.buffer,256*r,256)}updateBuffer(t){const{_gl:e}=this,r=this.getGlBuffer(t);if(t._updateID===r.updateID)return r;r.updateID=t._updateID,e.bindBuffer(r.type,r.buffer);const s=t.data;if(r.byteLength>=t.data.byteLength)e.bufferSubData(r.type,0,s,0,t._updateSize/s.BYTES_PER_ELEMENT);else{const i=t.descriptor.usage&Ms.STATIC?e.STATIC_DRAW:e.DYNAMIC_DRAW;r.byteLength=s.byteLength,e.bufferData(r.type,s,i)}return r}destroyAll(){const t=this._gl;for(const e in this._gpuBuffers)t.deleteBuffer(this._gpuBuffers[e].buffer);this._gpuBuffers=Object.create(null)}onBufferDestroy(t,e){const r=this._gpuBuffers[t.uid],s=this._gl;e||s.deleteBuffer(r.buffer),this._gpuBuffers[t.uid]=null}createGLBuffer(t){const{_gl:e}=this;let r=jm.ARRAY_BUFFER;t.descriptor.usage&Ms.INDEX?r=jm.ELEMENT_ARRAY_BUFFER:t.descriptor.usage&Ms.UNIFORM&&(r=jm.UNIFORM_BUFFER);const s=new Vm(e.createBuffer(),r);return this._gpuBuffers[t.uid]=s,t.on("destroy",this.onBufferDestroy,this),s}}Wm.extension={type:[u.WebGLSystem],name:"buffer"};var $m=Object.defineProperty,Ym=Object.defineProperties,qm=Object.getOwnPropertyDescriptors,Km=Object.getOwnPropertySymbols,Zm=Object.prototype.hasOwnProperty,Qm=Object.prototype.propertyIsEnumerable,Jm=(t,e,r)=>e in t?$m(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r,t_=(t,e)=>{for(var r in e||(e={}))Zm.call(e,r)&&Jm(t,r,e[r]);if(Km)for(var r of Km(e))Qm.call(e,r)&&Jm(t,r,e[r]);return t},e_=(t,e)=>Ym(t,qm(e));const r_=class t{constructor(t){this.supports={uint32Indices:!0,uniformBufferObject:!0,vertexArrayObject:!0,srgbTextures:!0,nonPowOf2wrapping:!0,msaa:!0,nonPowOf2mipmaps:!0},this._renderer=t,this.extensions=Object.create(null),this.handleContextLost=this.handleContextLost.bind(this),this.handleContextRestored=this.handleContextRestored.bind(this)}get isLost(){return!this.gl||this.gl.isContextLost()}contextChange(t){this.gl=t,this._renderer.gl=t}init(e){var r,s;if((e=t_(t_({},t.defaultOptions),e)).context)this.initFromContext(e.context);else{const t=this._renderer.background.alpha<1,i=null==(r=e.premultipliedAlpha)||r,n=e.antialias&&!this._renderer.backBuffer.useBackBuffer;this.createContext(e.preferWebGLVersion,{alpha:t,premultipliedAlpha:i,antialias:n,stencil:!0,preserveDrawingBuffer:e.preserveDrawingBuffer,powerPreference:null!=(s=e.powerPreference)?s:"default"})}}initFromContext(t){this.gl=t,this.webGLVersion=t instanceof Ne.get().getWebGLRenderingContext()?1:2,this.getExtensions(),this.validateContext(t),this._renderer.runners.contextChange.emit(t);const e=this._renderer.view.canvas;e.addEventListener("webglcontextlost",this.handleContextLost,!1),e.addEventListener("webglcontextrestored",this.handleContextRestored,!1)}createContext(t,e){let r;const s=this._renderer.view.canvas;if(2===t&&(r=s.getContext("webgl2",e)),!r&&(r=s.getContext("webgl",e),!r))throw new Error("This browser does not support WebGL. Try using the canvas renderer");this.gl=r,this.initFromContext(this.gl)}getExtensions(){const{gl:t}=this,e={anisotropicFiltering:t.getExtension("EXT_texture_filter_anisotropic"),floatTextureLinear:t.getExtension("OES_texture_float_linear"),s3tc:t.getExtension("WEBGL_compressed_texture_s3tc"),s3tc_sRGB:t.getExtension("WEBGL_compressed_texture_s3tc_srgb"),etc:t.getExtension("WEBGL_compressed_texture_etc"),etc1:t.getExtension("WEBGL_compressed_texture_etc1"),pvrtc:t.getExtension("WEBGL_compressed_texture_pvrtc")||t.getExtension("WEBKIT_WEBGL_compressed_texture_pvrtc"),atc:t.getExtension("WEBGL_compressed_texture_atc"),astc:t.getExtension("WEBGL_compressed_texture_astc"),bptc:t.getExtension("EXT_texture_compression_bptc"),rgtc:t.getExtension("EXT_texture_compression_rgtc"),loseContext:t.getExtension("WEBGL_lose_context")};if(1===this.webGLVersion)this.extensions=e_(t_({},e),{drawBuffers:t.getExtension("WEBGL_draw_buffers"),depthTexture:t.getExtension("WEBGL_depth_texture"),vertexArrayObject:t.getExtension("OES_vertex_array_object")||t.getExtension("MOZ_OES_vertex_array_object")||t.getExtension("WEBKIT_OES_vertex_array_object"),uint32ElementIndex:t.getExtension("OES_element_index_uint"),floatTexture:t.getExtension("OES_texture_float"),floatTextureLinear:t.getExtension("OES_texture_float_linear"),textureHalfFloat:t.getExtension("OES_texture_half_float"),textureHalfFloatLinear:t.getExtension("OES_texture_half_float_linear"),vertexAttribDivisorANGLE:t.getExtension("ANGLE_instanced_arrays"),srgb:t.getExtension("EXT_sRGB")});else{this.extensions=e_(t_({},e),{colorBufferFloat:t.getExtension("EXT_color_buffer_float")});const r=t.getExtension("WEBGL_provoking_vertex");r&&r.provokingVertexWEBGL(r.FIRST_VERTEX_CONVENTION_WEBGL)}}handleContextLost(t){t.preventDefault(),this._contextLossForced&&(this._contextLossForced=!1,setTimeout((()=>{var t;this.gl.isContextLost()&&(null==(t=this.extensions.loseContext)||t.restoreContext())}),0))}handleContextRestored(){this._renderer.runners.contextChange.emit(this.gl)}destroy(){var t;const e=this._renderer.view.canvas;this._renderer=null,e.removeEventListener("webglcontextlost",this.handleContextLost),e.removeEventListener("webglcontextrestored",this.handleContextRestored),this.gl.useProgram(null),null==(t=this.extensions.loseContext)||t.loseContext()}forceContextLoss(){var t;null==(t=this.extensions.loseContext)||t.loseContext(),this._contextLossForced=!0}validateContext(t){const e=t.getContextAttributes();e&&e.stencil;const r=this.supports,s=2===this.webGLVersion,i=this.extensions;r.uint32Indices=s||!!i.uint32ElementIndex,r.uniformBufferObject=s,r.vertexArrayObject=s||!!i.vertexArrayObject,r.srgbTextures=s||!!i.srgb,r.nonPowOf2wrapping=s,r.nonPowOf2mipmaps=s,r.msaa=s,r.uint32Indices}};r_.extension={type:[u.WebGLSystem],name:"context"},r_.defaultOptions={context:null,premultipliedAlpha:!0,preserveDrawingBuffer:!1,powerPreference:void 0,preferWebGLVersion:2};let s_=r_,i_=0;function n_(...t){500!==i_&&(i_++,500===i_?console.warn("PixiJS Warning: too many warnings, no more warnings will be reported to the console by PixiJS."):console.warn("PixiJS Warning: ",...t))}function o_(t,e){for(const r in t.attributes){const s=t.attributes[r],i=e[r];i?(null!=s.location||(s.location=i.location),null!=s.format||(s.format=i.format),null!=s.offset||(s.offset=i.offset),null!=s.instance||(s.instance=i.instance)):n_(`Attribute ${r} is not present in the shader, but is present in the geometry. Unable to infer attribute details.`)}!function(t){const{buffers:e,attributes:r}=t,s={},i={};for(const t in e){const r=e[t];s[r.uid]=0,i[r.uid]=0}for(const t in r){const e=r[t];s[e.buffer.uid]+=ul(e.format).stride}for(const t in r){const e=r[t];null!=e.stride||(e.stride=s[e.buffer.uid]),null!=e.start||(e.start=i[e.buffer.uid]),i[e.buffer.uid]+=ul(e.format).stride}}(t)}var a_=(t=>(t[t.RGBA=6408]="RGBA",t[t.RGB=6407]="RGB",t[t.RG=33319]="RG",t[t.RED=6403]="RED",t[t.RGBA_INTEGER=36249]="RGBA_INTEGER",t[t.RGB_INTEGER=36248]="RGB_INTEGER",t[t.RG_INTEGER=33320]="RG_INTEGER",t[t.RED_INTEGER=36244]="RED_INTEGER",t[t.ALPHA=6406]="ALPHA",t[t.LUMINANCE=6409]="LUMINANCE",t[t.LUMINANCE_ALPHA=6410]="LUMINANCE_ALPHA",t[t.DEPTH_COMPONENT=6402]="DEPTH_COMPONENT",t[t.DEPTH_STENCIL=34041]="DEPTH_STENCIL",t))(a_||{}),l_=(t=>(t[t.TEXTURE_2D=3553]="TEXTURE_2D",t[t.TEXTURE_CUBE_MAP=34067]="TEXTURE_CUBE_MAP",t[t.TEXTURE_2D_ARRAY=35866]="TEXTURE_2D_ARRAY",t[t.TEXTURE_CUBE_MAP_POSITIVE_X=34069]="TEXTURE_CUBE_MAP_POSITIVE_X",t[t.TEXTURE_CUBE_MAP_NEGATIVE_X=34070]="TEXTURE_CUBE_MAP_NEGATIVE_X",t[t.TEXTURE_CUBE_MAP_POSITIVE_Y=34071]="TEXTURE_CUBE_MAP_POSITIVE_Y",t[t.TEXTURE_CUBE_MAP_NEGATIVE_Y=34072]="TEXTURE_CUBE_MAP_NEGATIVE_Y",t[t.TEXTURE_CUBE_MAP_POSITIVE_Z=34073]="TEXTURE_CUBE_MAP_POSITIVE_Z",t[t.TEXTURE_CUBE_MAP_NEGATIVE_Z=34074]="TEXTURE_CUBE_MAP_NEGATIVE_Z",t))(l_||{}),h_=(t=>(t[t.CLAMP=33071]="CLAMP",t[t.REPEAT=10497]="REPEAT",t[t.MIRRORED_REPEAT=33648]="MIRRORED_REPEAT",t))(h_||{}),u_=(t=>(t[t.UNSIGNED_BYTE=5121]="UNSIGNED_BYTE",t[t.UNSIGNED_SHORT=5123]="UNSIGNED_SHORT",t[t.UNSIGNED_SHORT_5_6_5=33635]="UNSIGNED_SHORT_5_6_5",t[t.UNSIGNED_SHORT_4_4_4_4=32819]="UNSIGNED_SHORT_4_4_4_4",t[t.UNSIGNED_SHORT_5_5_5_1=32820]="UNSIGNED_SHORT_5_5_5_1",t[t.UNSIGNED_INT=5125]="UNSIGNED_INT",t[t.UNSIGNED_INT_10F_11F_11F_REV=35899]="UNSIGNED_INT_10F_11F_11F_REV",t[t.UNSIGNED_INT_2_10_10_10_REV=33640]="UNSIGNED_INT_2_10_10_10_REV",t[t.UNSIGNED_INT_24_8=34042]="UNSIGNED_INT_24_8",t[t.UNSIGNED_INT_5_9_9_9_REV=35902]="UNSIGNED_INT_5_9_9_9_REV",t[t.BYTE=5120]="BYTE",t[t.SHORT=5122]="SHORT",t[t.INT=5124]="INT",t[t.FLOAT=5126]="FLOAT",t[t.FLOAT_32_UNSIGNED_INT_24_8_REV=36269]="FLOAT_32_UNSIGNED_INT_24_8_REV",t[t.HALF_FLOAT=36193]="HALF_FLOAT",t))(u_||{});const c_={uint8x2:u_.UNSIGNED_BYTE,uint8x4:u_.UNSIGNED_BYTE,sint8x2:u_.BYTE,sint8x4:u_.BYTE,unorm8x2:u_.UNSIGNED_BYTE,unorm8x4:u_.UNSIGNED_BYTE,snorm8x2:u_.BYTE,snorm8x4:u_.BYTE,uint16x2:u_.UNSIGNED_SHORT,uint16x4:u_.UNSIGNED_SHORT,sint16x2:u_.SHORT,sint16x4:u_.SHORT,unorm16x2:u_.UNSIGNED_SHORT,unorm16x4:u_.UNSIGNED_SHORT,snorm16x2:u_.SHORT,snorm16x4:u_.SHORT,float16x2:u_.HALF_FLOAT,float16x4:u_.HALF_FLOAT,float32:u_.FLOAT,float32x2:u_.FLOAT,float32x3:u_.FLOAT,float32x4:u_.FLOAT,uint32:u_.UNSIGNED_INT,uint32x2:u_.UNSIGNED_INT,uint32x3:u_.UNSIGNED_INT,uint32x4:u_.UNSIGNED_INT,sint32:u_.INT,sint32x2:u_.INT,sint32x3:u_.INT,sint32x4:u_.INT};function d_(t){var e;return null!=(e=c_[t])?e:c_.float32}const p_={"point-list":0,"line-list":1,"line-strip":3,"triangle-list":4,"triangle-strip":5};class f_{constructor(t){this._geometryVaoHash=Object.create(null),this._renderer=t,this._activeGeometry=null,this._activeVao=null,this.hasVao=!0,this.hasInstance=!0}contextChange(){const t=this.gl=this._renderer.gl;if(!this._renderer.context.supports.vertexArrayObject)throw new Error("[PixiJS] Vertex Array Objects are not supported on this device");const e=this._renderer.context.extensions.vertexArrayObject;e&&(t.createVertexArray=()=>e.createVertexArrayOES(),t.bindVertexArray=t=>e.bindVertexArrayOES(t),t.deleteVertexArray=t=>e.deleteVertexArrayOES(t));const r=this._renderer.context.extensions.vertexAttribDivisorANGLE;r&&(t.drawArraysInstanced=(t,e,s,i)=>{r.drawArraysInstancedANGLE(t,e,s,i)},t.drawElementsInstanced=(t,e,s,i,n)=>{r.drawElementsInstancedANGLE(t,e,s,i,n)},t.vertexAttribDivisor=(t,e)=>r.vertexAttribDivisorANGLE(t,e)),this._activeGeometry=null,this._activeVao=null,this._geometryVaoHash=Object.create(null)}bind(t,e){const r=this.gl;this._activeGeometry=t;const s=this.getVao(t,e);this._activeVao!==s&&(this._activeVao=s,r.bindVertexArray(s)),this.updateBuffers()}reset(){this.unbind()}updateBuffers(){const t=this._activeGeometry,e=this._renderer.buffer;for(let r=0;r<t.buffers.length;r++){const s=t.buffers[r];e.updateBuffer(s)}}checkCompatibility(t,e){const r=t.attributes,s=e._attributeData;for(const t in s)if(!r[t])throw new Error(`shader and geometry incompatible, geometry missing the "${t}" attribute`)}getSignature(t,e){const r=t.attributes,s=e._attributeData,i=["g",t.uid];for(const t in r)s[t]&&i.push(t,s[t].location);return i.join("-")}getVao(t,e){var r;return(null==(r=this._geometryVaoHash[t.uid])?void 0:r[e._key])||this.initGeometryVao(t,e)}initGeometryVao(t,e,r=!0){const s=this._renderer.gl,i=this._renderer.buffer;this._renderer.shader._getProgramData(e),this.checkCompatibility(t,e);const n=this.getSignature(t,e);this._geometryVaoHash[t.uid]||(this._geometryVaoHash[t.uid]=Object.create(null),t.on("destroy",this.onGeometryDestroy,this));const o=this._geometryVaoHash[t.uid];let a=o[n];if(a)return o[e._key]=a,a;o_(t,e._attributeData);const l=t.buffers;a=s.createVertexArray(),s.bindVertexArray(a);for(let t=0;t<l.length;t++){const e=l[t];i.bind(e)}return this.activateVao(t,e),o[e._key]=a,o[n]=a,s.bindVertexArray(null),a}onGeometryDestroy(t,e){const r=this._geometryVaoHash[t.uid],s=this.gl;if(r){if(e)for(const t in r)this._activeVao!==r[t]&&this.unbind(),s.deleteVertexArray(r[t]);this._geometryVaoHash[t.uid]=null}}destroyAll(t=!1){const e=this.gl;for(const r in this._geometryVaoHash){if(t)for(const t in this._geometryVaoHash[r]){const s=this._geometryVaoHash[r];this._activeVao!==s&&this.unbind(),e.deleteVertexArray(s[t])}this._geometryVaoHash[r]=null}}activateVao(t,e){var r;const s=this._renderer.gl,i=this._renderer.buffer,n=t.attributes;t.indexBuffer&&i.bind(t.indexBuffer);let o=null;for(const t in n){const a=n[t],l=a.buffer,h=i.getGlBuffer(l),u=e._attributeData[t];if(u){o!==h&&(i.bind(l),o=h);const t=a.location;s.enableVertexAttribArray(t);const e=ul(a.format),n=d_(a.format);if("int"===(null==(r=u.format)?void 0:r.substring(1,4))?s.vertexAttribIPointer(t,e.size,n,a.stride,a.offset):s.vertexAttribPointer(t,e.size,n,e.normalised,a.stride,a.offset),a.instance){if(!this.hasInstance)throw new Error("geometry error, GPU Instancing is not supported on this device");s.vertexAttribDivisor(t,1)}}}}draw(t,e,r,s){const{gl:i}=this._renderer,n=this._activeGeometry,o=p_[n.topology||t];if(s||(s=n.instanceCount),n.indexBuffer){const t=n.indexBuffer.data.BYTES_PER_ELEMENT,a=2===t?i.UNSIGNED_SHORT:i.UNSIGNED_INT;s>1?i.drawElementsInstanced(o,e||n.indexBuffer.data.length,a,(r||0)*t,s):i.drawElements(o,e||n.indexBuffer.data.length,a,(r||0)*t)}else s>1?i.drawArraysInstanced(o,r||0,e||n.getSize(),s):i.drawArrays(o,r||0,e||n.getSize());return this}unbind(){this.gl.bindVertexArray(null),this._activeVao=null,this._activeGeometry=null}destroy(){this._renderer=null,this.gl=null,this._activeVao=null,this._activeGeometry=null}}f_.extension={type:[u.WebGLSystem],name:"geometry"};var g_=Object.defineProperty,m_=Object.getOwnPropertySymbols,__=Object.prototype.hasOwnProperty,x_=Object.prototype.propertyIsEnumerable,y_=(t,e,r)=>e in t?g_(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r,b_=(t,e)=>{for(var r in e||(e={}))__.call(e,r)&&y_(t,r,e[r]);if(m_)for(var r of m_(e))x_.call(e,r)&&y_(t,r,e[r]);return t};const v_=new Is({attributes:{aPosition:[-1,-1,3,-1,-1,3]}}),T_=class t{constructor(t){this.useBackBuffer=!1,this._useBackBufferThisRender=!1,this._renderer=t}init(e={}){const{useBackBuffer:r,antialias:s}=b_(b_({},t.defaultOptions),e);this.useBackBuffer=r,this._antialias=s,this._renderer.context.supports.msaa||(n_("antialiasing, is not supported on when using the back buffer"),this._antialias=!1),this._state=an.for2d();const i=new ll({vertex:"\n                attribute vec2 aPosition;\n                out vec2 vUv;\n\n                void main() {\n                    gl_Position = vec4(aPosition, 0.0, 1.0);\n\n                    vUv = (aPosition + 1.0) / 2.0;\n\n                    // flip dem UVs\n                    vUv.y = 1.0 - vUv.y;\n                }",fragment:"\n                in vec2 vUv;\n                out vec4 finalColor;\n\n                uniform sampler2D uTexture;\n\n                void main() {\n                    finalColor = texture(uTexture, vUv);\n                }",name:"big-triangle"});this._bigTriangleShader=new fh({glProgram:i,resources:{uTexture:zr.WHITE.source}})}renderStart(t){const e=this._renderer.renderTarget.getRenderTarget(t.target);if(this._useBackBufferThisRender=this.useBackBuffer&&!!e.isRoot,this._useBackBufferThisRender){const e=this._renderer.renderTarget.getRenderTarget(t.target);this._targetTexture=e.colorTexture,t.target=this._getBackBufferTexture(e.colorTexture)}}renderEnd(){this._presentBackBuffer()}_presentBackBuffer(){const t=this._renderer;t.renderTarget.finishRenderPass(),this._useBackBufferThisRender&&(t.renderTarget.bind(this._targetTexture,!1),this._bigTriangleShader.resources.uTexture=this._backBufferTexture.source,t.encoder.draw({geometry:v_,shader:this._bigTriangleShader,state:this._state}))}_getBackBufferTexture(t){return this._backBufferTexture=this._backBufferTexture||new zr({source:new Cr({width:t.width,height:t.height,resolution:t._resolution,antialias:this._antialias})}),this._backBufferTexture.source.resize(t.width,t.height,t._resolution),this._backBufferTexture}destroy(){this._backBufferTexture&&(this._backBufferTexture.destroy(),this._backBufferTexture=null)}};T_.extension={type:[u.WebGLSystem],name:"backBuffer",priority:1},T_.defaultOptions={useBackBuffer:!1};let S_=T_;class w_{constructor(t){this._colorMaskCache=15,this._renderer=t}setMask(t){this._colorMaskCache!==t&&(this._colorMaskCache=t,this._renderer.gl.colorMask(!!(8&t),!!(4&t),!!(2&t),!!(1&t)))}}w_.extension={type:[u.WebGLSystem],name:"colorMask"};class E_{constructor(t){this.commandFinished=Promise.resolve(),this._renderer=t}setGeometry(t,e){this._renderer.geometry.bind(t,e.glProgram)}finishRenderPass(){}draw(t){const e=this._renderer,{geometry:r,shader:s,state:i,skipSync:n,topology:o,size:a,start:l,instanceCount:h}=t;e.shader.bind(s,n),e.geometry.bind(r,e.shader._activeProgram),i&&e.state.set(i),e.geometry.draw(o,a,l,null!=h?h:r.instanceCount)}destroy(){this._renderer=null}}E_.extension={type:[u.WebGLSystem],name:"encoder"};class A_{constructor(){this.width=-1,this.height=-1,this.msaa=!1,this.msaaRenderBuffer=[]}}const M_=[];M_[Hs.NONE]=void 0,M_[Hs.DISABLED]={stencilWriteMask:0,stencilReadMask:0},M_[Hs.RENDERING_MASK_ADD]={stencilFront:{compare:"equal",passOp:"increment-clamp"},stencilBack:{compare:"equal",passOp:"increment-clamp"}},M_[Hs.RENDERING_MASK_REMOVE]={stencilFront:{compare:"equal",passOp:"decrement-clamp"},stencilBack:{compare:"equal",passOp:"decrement-clamp"}},M_[Hs.MASK_ACTIVE]={stencilWriteMask:0,stencilFront:{compare:"equal",passOp:"keep"},stencilBack:{compare:"equal",passOp:"keep"}};class P_{constructor(t){this._stencilCache={enabled:!1,stencilReference:0,stencilMode:Hs.NONE},this._renderTargetStencilState=Object.create(null),t.renderTarget.onRenderTargetChange.add(this)}contextChange(t){this._gl=t,this._comparisonFuncMapping={always:t.ALWAYS,never:t.NEVER,equal:t.EQUAL,"not-equal":t.NOTEQUAL,less:t.LESS,"less-equal":t.LEQUAL,greater:t.GREATER,"greater-equal":t.GEQUAL},this._stencilOpsMapping={keep:t.KEEP,zero:t.ZERO,replace:t.REPLACE,invert:t.INVERT,"increment-clamp":t.INCR,"decrement-clamp":t.DECR,"increment-wrap":t.INCR_WRAP,"decrement-wrap":t.DECR_WRAP},this._stencilCache.enabled=!1,this._stencilCache.stencilMode=Hs.NONE,this._stencilCache.stencilReference=0}onRenderTargetChange(t){if(this._activeRenderTarget===t)return;this._activeRenderTarget=t;let e=this._renderTargetStencilState[t.uid];e||(e=this._renderTargetStencilState[t.uid]={stencilMode:Hs.DISABLED,stencilReference:0}),this.setStencilMode(e.stencilMode,e.stencilReference)}setStencilMode(t,e){const r=this._renderTargetStencilState[this._activeRenderTarget.uid],s=this._gl,i=M_[t],n=this._stencilCache;r.stencilMode=t,r.stencilReference=e,t!==Hs.DISABLED?(this._stencilCache.enabled||(this._stencilCache.enabled=!0,s.enable(s.STENCIL_TEST)),(t!==n.stencilMode||n.stencilReference!==e)&&(n.stencilMode=t,n.stencilReference=e,s.stencilFunc(this._comparisonFuncMapping[i.stencilBack.compare],e,255),s.stencilOp(s.KEEP,s.KEEP,this._stencilOpsMapping[i.stencilBack.passOp]))):this._stencilCache.enabled&&(this._stencilCache.enabled=!1,s.disable(s.STENCIL_TEST))}}P_.extension={type:[u.WebGLSystem],name:"stencil"};class R_{constructor(t){this._syncFunctionHash=Object.create(null),this._adaptor=t,this._systemCheck()}_systemCheck(){if(!qu())throw new Error("Current environment does not allow unsafe-eval, please use pixi.js/unsafe-eval module to enable support.")}ensureUniformGroup(t){const e=this.getUniformGroupData(t);t.buffer||(t.buffer=new Ps({data:new Float32Array(e.layout.size/4),usage:Ms.UNIFORM|Ms.COPY_DST}))}getUniformGroupData(t){return this._syncFunctionHash[t._signature]||this._initUniformGroup(t)}_initUniformGroup(t){const e=t._signature;let r=this._syncFunctionHash[e];if(!r){const s=Object.keys(t.uniformStructures).map((e=>t.uniformStructures[e])),i=this._adaptor.createUboElements(s),n=this._generateUboSync(i.uboElements);r=this._syncFunctionHash[e]={layout:i,syncFunction:n}}return this._syncFunctionHash[e]}_generateUboSync(t){return this._adaptor.generateUboSync(t)}syncUniformGroup(t,e,r){const s=this.getUniformGroupData(t);return t.buffer||(t.buffer=new Ps({data:new Float32Array(s.layout.size/4),usage:Ms.UNIFORM|Ms.COPY_DST})),e||(e=t.buffer.data),r||(r=0),s.syncFunction(t.uniforms,e,r),!0}updateUniformGroup(t){if(t.isStatic&&!t._dirtyId)return!1;t._dirtyId=0;const e=this.syncUniformGroup(t);return t.buffer.update(),e}destroy(){this._syncFunctionHash=null}}const O_={f32:4,"vec2<f32>":8,"vec3<f32>":12,"vec4<f32>":16,"mat2x2<f32>":32,"mat3x3<f32>":48,"mat4x4<f32>":64};function C_(t){const e=t.map((t=>({data:t,offset:0,size:0})));let r=0,s=0,i=0;for(let t=0;t<e.length;t++){const n=e[t];if(r=O_[n.data.type],!r)throw new Error(`Unknown type ${n.data.type}`);if(n.data.size>1&&(r=Math.max(r,16)*n.data.size),n.size=r,s%r!=0&&s<16){const t=s%r%16;s+=t,i+=t}s+r>16?(i=16*Math.ceil(i/16),n.offset=i,i+=r,s=r):(n.offset=i,s+=r,i+=r)}return i=16*Math.ceil(i/16),{uboElements:e,size:i}}const I_=[{type:"mat3x3<f32>",test:t=>void 0!==t.value.a,ubo:"\n            var matrix = uv[name].toArray(true);\n            data[offset] = matrix[0];\n            data[offset + 1] = matrix[1];\n            data[offset + 2] = matrix[2];\n            data[offset + 4] = matrix[3];\n            data[offset + 5] = matrix[4];\n            data[offset + 6] = matrix[5];\n            data[offset + 8] = matrix[6];\n            data[offset + 9] = matrix[7];\n            data[offset + 10] = matrix[8];\n        ",uniform:" \n            gl.uniformMatrix3fv(ud[name].location, false, uv[name].toArray(true));\n        "},{type:"vec4<f32>",test:t=>"vec4<f32>"===t.type&&1===t.size&&void 0!==t.value.width,ubo:"\n            v = uv[name];\n            data[offset] = v.x;\n            data[offset + 1] = v.y;\n            data[offset + 2] = v.width;\n            data[offset + 3] = v.height;\n        ",uniform:"\n            cv = ud[name].value;\n            v = uv[name];\n            if (cv[0] !== v.x || cv[1] !== v.y || cv[2] !== v.width || cv[3] !== v.height) {\n                cv[0] = v.x;\n                cv[1] = v.y;\n                cv[2] = v.width;\n                cv[3] = v.height;\n                gl.uniform4f(ud[name].location, v.x, v.y, v.width, v.height);\n            }\n        "},{type:"vec2<f32>",test:t=>"vec2<f32>"===t.type&&1===t.size&&void 0!==t.value.x,ubo:"\n            v = uv[name];\n            data[offset] = v.x;\n            data[offset + 1] = v.y;\n        ",uniform:"\n            cv = ud[name].value;\n            v = uv[name];\n            if (cv[0] !== v.x || cv[1] !== v.y) {\n                cv[0] = v.x;\n                cv[1] = v.y;\n                gl.uniform2f(ud[name].location, v.x, v.y);\n            }\n        "},{type:"vec4<f32>",test:t=>"vec4<f32>"===t.type&&1===t.size&&void 0!==t.value.red,ubo:"\n            v = uv[name];\n            data[offset] = v.red;\n            data[offset + 1] = v.green;\n            data[offset + 2] = v.blue;\n            data[offset + 3] = v.alpha;\n        ",uniform:"\n            cv = ud[name].value;\n            v = uv[name];\n            if (cv[0] !== v.red || cv[1] !== v.green || cv[2] !== v.blue || cv[3] !== v.alpha) {\n                cv[0] = v.red;\n                cv[1] = v.green;\n                cv[2] = v.blue;\n                cv[3] = v.alpha;\n                gl.uniform4f(ud[name].location, v.red, v.green, v.blue, v.alpha);\n            }\n        "},{type:"vec3<f32>",test:t=>"vec3<f32>"===t.type&&1===t.size&&void 0!==t.value.red,ubo:"\n            v = uv[name];\n            data[offset] = v.red;\n            data[offset + 1] = v.green;\n            data[offset + 2] = v.blue;\n        ",uniform:"\n            cv = ud[name].value;\n            v = uv[name];\n            if (cv[0] !== v.red || cv[1] !== v.green || cv[2] !== v.blue) {\n                cv[0] = v.red;\n                cv[1] = v.green;\n                cv[2] = v.blue;\n                gl.uniform3f(ud[name].location, v.red, v.green, v.blue);\n            }\n        "}];function G_(t,e,r,s){const i=["\n        var v = null;\n        var v2 = null;\n        var t = 0;\n        var index = 0;\n        var name = null;\n        var arrayOffset = null;\n    "];let n=0;for(let o=0;o<t.length;o++){const a=t[o],l=a.data.name;let h=!1,u=0;for(let t=0;t<I_.length;t++)if(I_[t].test(a.data)){u=a.offset/4,i.push(`name = "${l}";`,`offset += ${u-n};`,I_[t][e]||I_[t].ubo),h=!0;break}if(!h)if(a.data.size>1)u=a.offset/4,i.push(r(a,u-n));else{const t=s[a.data.type];u=a.offset/4,i.push(`\n                    v = uv.${l};\n                    offset += ${u-n};\n                    ${t};\n                `)}n=u}const o=i.join("\n");return new Function("uv","data","offset",o)}var k_=Object.defineProperty,B_=Object.defineProperties,D_=Object.getOwnPropertyDescriptors,F_=Object.getOwnPropertySymbols,N_=Object.prototype.hasOwnProperty,U_=Object.prototype.propertyIsEnumerable,L_=(t,e,r)=>e in t?k_(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r;function X_(t,e){return`\n        for (let i = 0; i < ${t*e}; i++) {\n            data[offset + (((i / ${t})|0) * 4) + (i % ${t})] = v[i];\n        }\n    `}const z_={f32:"\n        data[offset] = v;",i32:"\n        data[offset] = v;","vec2<f32>":"\n        data[offset] = v[0];\n        data[offset + 1] = v[1];","vec3<f32>":"\n        data[offset] = v[0];\n        data[offset + 1] = v[1];\n        data[offset + 2] = v[2];","vec4<f32>":"\n        data[offset] = v[0];\n        data[offset + 1] = v[1];\n        data[offset + 2] = v[2];\n        data[offset + 3] = v[3];","mat2x2<f32>":"\n        data[offset] = v[0];\n        data[offset + 1] = v[1];\n        data[offset + 4] = v[2];\n        data[offset + 5] = v[3];","mat3x3<f32>":"\n        data[offset] = v[0];\n        data[offset + 1] = v[1];\n        data[offset + 2] = v[2];\n        data[offset + 4] = v[3];\n        data[offset + 5] = v[4];\n        data[offset + 6] = v[5];\n        data[offset + 8] = v[6];\n        data[offset + 9] = v[7];\n        data[offset + 10] = v[8];","mat4x4<f32>":"\n        for (let i = 0; i < 16; i++) {\n            data[offset + i] = v[i];\n        }","mat3x2<f32>":X_(3,2),"mat4x2<f32>":X_(4,2),"mat2x3<f32>":X_(2,3),"mat4x3<f32>":X_(4,3),"mat2x4<f32>":X_(2,4),"mat3x4<f32>":X_(3,4)},H_=((t,e)=>B_(t,D_(e)))(((t,e)=>{for(var r in e||(e={}))N_.call(e,r)&&L_(t,r,e[r]);if(F_)for(var r of F_(e))U_.call(e,r)&&L_(t,r,e[r]);return t})({},z_),{"mat2x2<f32>":"\n        data[offset] = v[0];\n        data[offset + 1] = v[1];\n        data[offset + 2] = v[2];\n        data[offset + 3] = v[3];\n    "});function j_(t,e){const r=Math.max(O_[t.data.type]/16,1),s=t.data.value.length/t.data.size,i=(4-s%4)%4;return`\n        v = uv.${t.data.name};\n        offset += ${e};\n\n        arrayOffset = offset;\n\n        t = 0;\n\n        for(var i=0; i < ${t.data.size*r}; i++)\n        {\n            for(var j = 0; j < ${s}; j++)\n            {\n                data[arrayOffset++] = v[t++];\n            }\n            ${0!==i?`arrayOffset += ${i};`:""}\n        }\n    `}function V_(t){return G_(t,"uboStd40",j_,z_)}class W_ extends R_{constructor(){super({createUboElements:C_,generateUboSync:V_})}}W_.extension={type:[u.WebGLSystem],name:"ubo"};class $_{constructor(){this._clearColorCache=[0,0,0,0],this._viewPortCache=new vt}init(t,e){this._renderer=t,this._renderTargetSystem=e,t.runners.contextChange.add(this)}contextChange(){this._clearColorCache=[0,0,0,0],this._viewPortCache=new vt}copyToTexture(t,e,r,s,i){const n=this._renderTargetSystem,o=this._renderer,a=n.getGpuRenderTarget(t),l=o.gl;return this.finishRenderPass(t),l.bindFramebuffer(l.FRAMEBUFFER,a.resolveTargetFramebuffer),o.texture.bind(e,0),l.copyTexSubImage2D(l.TEXTURE_2D,0,i.x,i.y,r.x,r.y,s.width,s.height),e}startRenderPass(t,e=!0,r,s){const i=this._renderTargetSystem,n=t.colorTexture,o=i.getGpuRenderTarget(t);let a=s.y;t.isRoot&&(a=n.pixelHeight-s.height),t.colorTextures.forEach((t=>{this._renderer.texture.unbind(t)}));const l=this._renderer.gl;l.bindFramebuffer(l.FRAMEBUFFER,o.framebuffer);const h=this._viewPortCache;(h.x!==s.x||h.y!==a||h.width!==s.width||h.height!==s.height)&&(h.x=s.x,h.y=a,h.width=s.width,h.height=s.height,l.viewport(s.x,a,s.width,s.height)),!o.depthStencilRenderBuffer&&(t.stencil||t.depth)&&this._initStencil(o),this.clear(t,e,r)}finishRenderPass(t){const e=this._renderTargetSystem.getGpuRenderTarget(t);if(!e.msaa)return;const r=this._renderer.gl;r.bindFramebuffer(r.FRAMEBUFFER,e.resolveTargetFramebuffer),r.bindFramebuffer(r.READ_FRAMEBUFFER,e.framebuffer),r.blitFramebuffer(0,0,e.width,e.height,0,0,e.width,e.height,r.COLOR_BUFFER_BIT,r.NEAREST),r.bindFramebuffer(r.FRAMEBUFFER,e.framebuffer)}initGpuRenderTarget(t){const e=this._renderer.gl,r=new A_;return ls.test(t.colorTexture.resource)?(r.framebuffer=null,r):(this._initColor(t,r),e.bindFramebuffer(e.FRAMEBUFFER,null),r)}clear(t,e,r){if(!e)return;const s=this._renderTargetSystem;"boolean"==typeof e&&(e=e?Ku.ALL:Ku.NONE);const i=this._renderer.gl;if(e&Ku.COLOR){null!=r||(r=s.defaultClearColor);const t=this._clearColorCache,e=r;(t[0]!==e[0]||t[1]!==e[1]||t[2]!==e[2]||t[3]!==e[3])&&(t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],i.clearColor(e[0],e[1],e[2],e[3]))}i.clear(e)}resizeGpuRenderTarget(t){if(t.isRoot)return;const e=this._renderTargetSystem.getGpuRenderTarget(t);this._resizeColor(t,e),t.stencil&&this._resizeStencil(e)}_initColor(t,e){const r=this._renderer,s=r.gl,i=s.createFramebuffer();if(e.resolveTargetFramebuffer=i,s.bindFramebuffer(s.FRAMEBUFFER,i),e.width=t.colorTexture.source.pixelWidth,e.height=t.colorTexture.source.pixelHeight,t.colorTextures.forEach(((t,i)=>{const n=t.source;n.antialias&&(r.context.supports.msaa?e.msaa=!0:n_("[RenderTexture] Antialiasing on textures is not supported in WebGL1")),r.texture.bindSource(n,0);const o=r.texture.getGlSource(n).texture;s.framebufferTexture2D(s.FRAMEBUFFER,s.COLOR_ATTACHMENT0+i,3553,o,0)})),e.msaa){const r=s.createFramebuffer();e.framebuffer=r,s.bindFramebuffer(s.FRAMEBUFFER,r),t.colorTextures.forEach(((t,r)=>{const i=s.createRenderbuffer();e.msaaRenderBuffer[r]=i}))}else e.framebuffer=i;this._resizeColor(t,e)}_resizeColor(t,e){const r=t.colorTexture.source;if(e.width=r.pixelWidth,e.height=r.pixelHeight,t.colorTextures.forEach(((t,e)=>{0!==e&&t.source.resize(r.width,r.height,r._resolution)})),e.msaa){const r=this._renderer,s=r.gl,i=e.framebuffer;s.bindFramebuffer(s.FRAMEBUFFER,i),t.colorTextures.forEach(((t,i)=>{const n=t.source;r.texture.bindSource(n,0);const o=r.texture.getGlSource(n).internalFormat,a=e.msaaRenderBuffer[i];s.bindRenderbuffer(s.RENDERBUFFER,a),s.renderbufferStorageMultisample(s.RENDERBUFFER,4,o,n.pixelWidth,n.pixelHeight),s.framebufferRenderbuffer(s.FRAMEBUFFER,s.COLOR_ATTACHMENT0+i,s.RENDERBUFFER,a)}))}}_initStencil(t){if(null===t.framebuffer)return;const e=this._renderer.gl,r=e.createRenderbuffer();t.depthStencilRenderBuffer=r,e.bindRenderbuffer(e.RENDERBUFFER,r),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.DEPTH_STENCIL_ATTACHMENT,e.RENDERBUFFER,r),this._resizeStencil(t)}_resizeStencil(t){const e=this._renderer.gl;e.bindRenderbuffer(e.RENDERBUFFER,t.depthStencilRenderBuffer),t.msaa?e.renderbufferStorageMultisample(e.RENDERBUFFER,4,e.DEPTH24_STENCIL8,t.width,t.height):e.renderbufferStorage(e.RENDERBUFFER,2===this._renderer.context.webGLVersion?e.DEPTH24_STENCIL8:e.DEPTH_STENCIL,t.width,t.height)}}function Y_(t,e,r,s,i,n){const o=n?1:-1;return t.identity(),t.a=1/s*2,t.d=o*(1/i*2),t.tx=-1-e*t.a,t.ty=-o-r*t.d,t}var q_=Object.defineProperty,K_=Object.getOwnPropertySymbols,Z_=Object.prototype.hasOwnProperty,Q_=Object.prototype.propertyIsEnumerable,J_=(t,e,r)=>e in t?q_(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r,tx=(t,e)=>{for(var r in e||(e={}))Z_.call(e,r)&&J_(t,r,e[r]);if(K_)for(var r of K_(e))Q_.call(e,r)&&J_(t,r,e[r]);return t};const ex=new Map;function rx(t,e){if(!ex.has(t)){const r=new zr({source:new ls(tx({resource:t},e))}),s=()=>{ex.get(t)===r&&ex.delete(t)};r.once("destroy",s),r.source.once("destroy",s),ex.set(t,r)}return ex.get(t)}function sx(t){const e=t.colorTexture.source.resource;return globalThis.HTMLCanvasElement&&e instanceof HTMLCanvasElement&&document.body.contains(e)}var ix=Object.defineProperty,nx=Object.getOwnPropertySymbols,ox=Object.prototype.hasOwnProperty,ax=Object.prototype.propertyIsEnumerable,lx=(t,e,r)=>e in t?ix(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r,hx=(t,e)=>{for(var r in e||(e={}))ox.call(e,r)&&lx(t,r,e[r]);if(nx)for(var r of nx(e))ax.call(e,r)&&lx(t,r,e[r]);return t};const ux=class t{constructor(e={}){if(this.uid=ht("renderTarget"),this.colorTextures=[],this.dirtyId=0,this.isRoot=!1,this._size=new Float32Array(2),e=hx(hx({},t.defaultOptions),e),this.stencil=e.stencil,this.depth=e.depth,this.isRoot=e.isRoot,"number"==typeof e.colorTextures)for(let t=0;t<e.colorTextures;t++)this.colorTextures.push(new Cr({width:e.width,height:e.height,resolution:e.resolution,antialias:e.antialias}));else{this.colorTextures=[...e.colorTextures.map((t=>t.source))];const t=this.colorTexture.source;this.resize(t.width,t.height,t._resolution)}this.colorTexture.source.on("resize",this.onSourceResize,this),(e.depthStencilTexture||this.stencil)&&(e.depthStencilTexture instanceof zr||e.depthStencilTexture instanceof Cr?this.depthStencilTexture=e.depthStencilTexture.source:this.ensureDepthStencilTexture())}get size(){const t=this._size;return t[0]=this.pixelWidth,t[1]=this.pixelHeight,t}get width(){return this.colorTexture.source.width}get height(){return this.colorTexture.source.height}get pixelWidth(){return this.colorTexture.source.pixelWidth}get pixelHeight(){return this.colorTexture.source.pixelHeight}get resolution(){return this.colorTexture.source._resolution}get colorTexture(){return this.colorTextures[0]}onSourceResize(t){this.resize(t.width,t.height,t._resolution,!0)}ensureDepthStencilTexture(){this.depthStencilTexture||(this.depthStencilTexture=new Cr({width:this.width,height:this.height,resolution:this.resolution,format:"depth24plus-stencil8",autoGenerateMipmaps:!1,antialias:!1,mipLevelCount:1}))}resize(t,e,r=this.resolution,s=!1){this.dirtyId++,this.colorTextures.forEach(((i,n)=>{s&&0===n||i.source.resize(t,e,r)})),this.depthStencilTexture&&this.depthStencilTexture.source.resize(t,e,r)}destroy(){this.colorTexture.source.off("resize",this.onSourceResize,this),this.depthStencilTexture&&(this.depthStencilTexture.destroy(),delete this.depthStencilTexture)}};ux.defaultOptions={width:0,height:0,resolution:1,colorTextures:1,stencil:!1,depth:!1,antialias:!1,isRoot:!1};let cx=ux;class dx{constructor(t){this.rootViewPort=new vt,this.viewport=new vt,this.onRenderTargetChange=new Zu("onRenderTargetChange"),this.projectionMatrix=new it,this.defaultClearColor=[0,0,0,0],this._renderSurfaceToRenderTargetHash=new Map,this._gpuRenderTargetHash=Object.create(null),this._renderTargetStack=[],this._renderer=t}finishRenderPass(){this.adaptor.finishRenderPass(this.renderTarget)}renderStart({target:t,clear:e,clearColor:r,frame:s}){this._renderTargetStack.length=0,this.push(t,e,r,s),this.rootViewPort.copyFrom(this.viewport),this.rootRenderTarget=this.renderTarget,this.renderingToScreen=sx(this.rootRenderTarget)}bind(t,e=!0,r,s){const i=this.getRenderTarget(t),n=this.renderTarget!==i;this.renderTarget=i,this.renderSurface=t;const o=this.getGpuRenderTarget(i);(i.pixelWidth!==o.width||i.pixelHeight!==o.height)&&(this.adaptor.resizeGpuRenderTarget(i),o.width=i.pixelWidth,o.height=i.pixelHeight);const a=i.colorTexture,l=this.viewport,h=a.pixelWidth,u=a.pixelHeight;if(!s&&t instanceof zr&&(s=t.frame),s){const t=a._resolution;l.x=s.x*t+.5|0,l.y=s.y*t+.5|0,l.width=s.width*t+.5|0,l.height=s.height*t+.5|0}else l.x=0,l.y=0,l.width=h,l.height=u;return Y_(this.projectionMatrix,0,0,l.width/a.resolution,l.height/a.resolution,!i.isRoot),this.adaptor.startRenderPass(i,e,r,l),n&&this.onRenderTargetChange.emit(i),i}clear(t,e=Ku.ALL,r){e&&(t&&(t=this.getRenderTarget(t)),this.adaptor.clear(t||this.renderTarget,e,r,this.viewport))}contextChange(){this._gpuRenderTargetHash=Object.create(null)}push(t,e=Ku.ALL,r,s){const i=this.bind(t,e,r,s);return this._renderTargetStack.push({renderTarget:i,frame:s}),i}pop(){this._renderTargetStack.pop();const t=this._renderTargetStack[this._renderTargetStack.length-1];this.bind(t.renderTarget,!1,null,t.frame)}getRenderTarget(t){var e;return t.isTexture&&(t=t.source),null!=(e=this._renderSurfaceToRenderTargetHash.get(t))?e:this._initRenderTarget(t)}copyToTexture(t,e,r,s,i){r.x<0&&(s.width+=r.x,i.x-=r.x,r.x=0),r.y<0&&(s.height+=r.y,i.y-=r.y,r.y=0);const{pixelWidth:n,pixelHeight:o}=t;return s.width=Math.min(s.width,n-r.x),s.height=Math.min(s.height,o-r.y),this.adaptor.copyToTexture(t,e,r,s,i)}ensureDepthStencil(){this.renderTarget.stencil||(this.renderTarget.stencil=!0,this.adaptor.startRenderPass(this.renderTarget,!1,null,this.viewport))}destroy(){this._renderer=null,this._renderSurfaceToRenderTargetHash.forEach(((t,e)=>{t!==e&&t.destroy()})),this._renderSurfaceToRenderTargetHash.clear(),this._gpuRenderTargetHash=Object.create(null)}_initRenderTarget(t){let e=null;return ls.test(t)&&(t=rx(t)),t instanceof cx?e=t:t instanceof Cr&&(e=new cx({colorTextures:[t]}),ls.test(t.source.resource)&&(e.isRoot=!0),t.on("destroy",(()=>{e.destroy()}))),this._renderSurfaceToRenderTargetHash.set(t,e),e}getGpuRenderTarget(t){return this._gpuRenderTargetHash[t.uid]||(this._gpuRenderTargetHash[t.uid]=this.adaptor.initGpuRenderTarget(t))}}class px extends dx{constructor(t){super(t),this.adaptor=new $_,this.adaptor.init(t,this)}}px.extension={type:[u.WebGLSystem],name:"renderTarget"};class fx extends m{constructor({buffer:t,offset:e,size:r}){super(),this.uid=ht("buffer"),this._resourceType="bufferResource",this._touched=0,this._resourceId=ht("resource"),this._bufferResource=!0,this.destroyed=!1,this.buffer=t,this.offset=0|e,this.size=r,this.buffer.on("change",this.onBufferChange,this)}onBufferChange(){this._resourceId=ht("resource"),this.emit("change",this)}destroy(t=!1){this.destroyed=!0,t&&this.buffer.destroy(),this.emit("change",this),this.buffer=null}}function gx(t,e){const r=[],s=["\n        var g = s.groups;\n        var sS = r.shader;\n        var p = s.glProgram;\n        var ugS = r.uniformGroup;\n        var resources;\n    "];let i=!1,n=0,o=0;const a=e._getProgramData(t.glProgram);for(const l in t.groups){const h=t.groups[l];r.push(`\n            resources = g[${l}].resources;\n        `);for(const u in h.resources){const c=h.resources[u];if(c instanceof vn)c.ubo?r.push(`\n                        sS.bindUniformBlock(\n                            resources[${u}],\n                            sS._uniformBindMap[${l}[${u}],\n                            ${n++}\n                        );\n                    `):r.push(`\n                        ugS.updateUniformGroup(resources[${u}], p, sD);\n                    `);else if(c instanceof fx)r.push(`\n                    sS.bindUniformBlock(\n                        resources[${u}],\n                        sS._uniformBindMap[${l}[${u}],\n                        ${n++}\n                    );\n                `);else if(c instanceof Cr){const n=t._uniformBindMap[l][u],h=a.uniformData[n];h&&(i||(i=!0,s.push("\n                        var tS = r.texture;\n                        ")),e._gl.uniform1i(h.location,o),r.push(`\n                        tS.bind(resources[${u}], ${o});\n                    `),o++)}}}const l=[...s,...r].join("\n");return new Function("r","s","sD",l)}class mx{constructor(t,e){this.program=t,this.uniformData=e,this.uniformGroups={},this.uniformDirtyGroups={},this.uniformBlockBindings={}}destroy(){this.uniformData=null,this.uniformGroups=null,this.uniformDirtyGroups=null,this.uniformBlockBindings=null,this.program=null}}function _x(t,e,r){const s=t.createShader(e);return t.shaderSource(s,r),t.compileShader(s),s}function xx(t){const e=new Array(t);for(let t=0;t<e.length;t++)e[t]=!1;return e}function yx(t,e){switch(t){case"float":case"int":case"uint":case"sampler2D":case"sampler2DArray":return 0;case"vec2":return new Float32Array(2*e);case"vec3":return new Float32Array(3*e);case"vec4":return new Float32Array(4*e);case"ivec2":return new Int32Array(2*e);case"ivec3":return new Int32Array(3*e);case"ivec4":return new Int32Array(4*e);case"uvec2":return new Uint32Array(2*e);case"uvec3":return new Uint32Array(3*e);case"uvec4":return new Uint32Array(4*e);case"bool":return!1;case"bvec2":return xx(2*e);case"bvec3":return xx(3*e);case"bvec4":return xx(4*e);case"mat2":return new Float32Array([1,0,0,1]);case"mat3":return new Float32Array([1,0,0,0,1,0,0,0,1]);case"mat4":return new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])}return null}let bx=null;const vx={FLOAT:"float",FLOAT_VEC2:"vec2",FLOAT_VEC3:"vec3",FLOAT_VEC4:"vec4",INT:"int",INT_VEC2:"ivec2",INT_VEC3:"ivec3",INT_VEC4:"ivec4",UNSIGNED_INT:"uint",UNSIGNED_INT_VEC2:"uvec2",UNSIGNED_INT_VEC3:"uvec3",UNSIGNED_INT_VEC4:"uvec4",BOOL:"bool",BOOL_VEC2:"bvec2",BOOL_VEC3:"bvec3",BOOL_VEC4:"bvec4",FLOAT_MAT2:"mat2",FLOAT_MAT3:"mat3",FLOAT_MAT4:"mat4",SAMPLER_2D:"sampler2D",INT_SAMPLER_2D:"sampler2D",UNSIGNED_INT_SAMPLER_2D:"sampler2D",SAMPLER_CUBE:"samplerCube",INT_SAMPLER_CUBE:"samplerCube",UNSIGNED_INT_SAMPLER_CUBE:"samplerCube",SAMPLER_2D_ARRAY:"sampler2DArray",INT_SAMPLER_2D_ARRAY:"sampler2DArray",UNSIGNED_INT_SAMPLER_2D_ARRAY:"sampler2DArray"},Tx={float:"float32",vec2:"float32x2",vec3:"float32x3",vec4:"float32x4",int:"sint32",ivec2:"sint32x2",ivec3:"sint32x3",ivec4:"sint32x4",uint:"uint32",uvec2:"uint32x2",uvec3:"uint32x3",uvec4:"uint32x4",bool:"uint32",bvec2:"uint32x2",bvec3:"uint32x3",bvec4:"uint32x4"};function Sx(t,e){if(!bx){const e=Object.keys(vx);bx={};for(let r=0;r<e.length;++r){const s=e[r];bx[t[s]]=vx[s]}}return bx[e]}function wx(t,e){const r=Sx(t,e);return Tx[r]||"float32"}function Ex(t,e,r=!1){const s={},i=e.getProgramParameter(t,e.ACTIVE_ATTRIBUTES);for(let r=0;r<i;r++){const i=e.getActiveAttrib(t,r);if(i.name.startsWith("gl_"))continue;const n=wx(e,i.type);s[i.name]={location:0,format:n,stride:ul(n).stride,offset:0,instance:!1,start:0}}const n=Object.keys(s);if(r){n.sort(((t,e)=>t>e?1:-1));for(let r=0;r<n.length;r++)s[n[r]].location=r,e.bindAttribLocation(t,r,n[r]);e.linkProgram(t)}else for(let r=0;r<n.length;r++)s[n[r]].location=e.getAttribLocation(t,n[r]);return s}function Ax(t,e){if(!e.ACTIVE_UNIFORM_BLOCKS)return{};const r={},s=e.getProgramParameter(t,e.ACTIVE_UNIFORM_BLOCKS);for(let i=0;i<s;i++){const s=e.getActiveUniformBlockName(t,i),n=e.getUniformBlockIndex(t,s),o=e.getActiveUniformBlockParameter(t,i,e.UNIFORM_BLOCK_DATA_SIZE);r[s]={name:s,index:n,size:o}}return r}function Mx(t,e){const r={},s=e.getProgramParameter(t,e.ACTIVE_UNIFORMS);for(let i=0;i<s;i++){const s=e.getActiveUniform(t,i),n=s.name.replace(/\[.*?\]$/,""),o=!!s.name.match(/\[.*?\]$/),a=Sx(e,s.type);r[n]={name:n,index:i,type:a,size:s.size,isArray:o,value:yx(a,s.size)}}return r}function Px(t,e){const r=t.getShaderSource(e).split("\n").map(((t,e)=>`${e}: ${t}`)),s=t.getShaderInfoLog(e),i=s.split("\n"),n={},o=i.map((t=>parseFloat(t.replace(/^ERROR\: 0\:([\d]+)\:.*$/,"$1")))).filter((t=>!(!t||n[t])&&(n[t]=!0,!0))),a=[""];o.forEach((t=>{r[t-1]=`%c${r[t-1]}%c`,a.push("background: #FF0000; color:#FFFFFF; font-size: 10px","font-size: 10px")}));const l=r.join("\n");a[0]=l,console.error(s),console.groupCollapsed("click to view full shader code"),console.warn(...a),console.groupEnd()}function Rx(t,e,r,s){t.getProgramParameter(e,t.LINK_STATUS)||(t.getShaderParameter(r,t.COMPILE_STATUS)||Px(t,r),t.getShaderParameter(s,t.COMPILE_STATUS)||Px(t,s),console.error("PixiJS Error: Could not initialize shader."),""!==t.getProgramInfoLog(e)&&console.warn("PixiJS Warning: gl.getProgramInfoLog()",t.getProgramInfoLog(e)))}function Ox(t,e){const r=_x(t,t.VERTEX_SHADER,e.vertex),s=_x(t,t.FRAGMENT_SHADER,e.fragment),i=t.createProgram();t.attachShader(i,r),t.attachShader(i,s);const n=e.transformFeedbackVaryings;n&&("function"!=typeof t.transformFeedbackVaryings||t.transformFeedbackVaryings(i,n.names,"separate"===n.bufferMode?t.SEPARATE_ATTRIBS:t.INTERLEAVED_ATTRIBS)),t.linkProgram(i),t.getProgramParameter(i,t.LINK_STATUS)||Rx(t,i,r,s),e._attributeData=Ex(i,t,!/^[ \t]*#[ \t]*version[ \t]+300[ \t]+es[ \t]*$/m.test(e.vertex)),e._uniformData=Mx(i,t),e._uniformBlockData=Ax(i,t),t.deleteShader(r),t.deleteShader(s);const o={};for(const r in e._uniformData){const s=e._uniformData[r];o[r]={location:t.getUniformLocation(i,r),value:yx(s.type,s.size)}}return new mx(i,o)}const Cx={textureCount:0,blockIndex:0};class Ix{constructor(t){this._activeProgram=null,this._programDataHash=Object.create(null),this._nextIndex=0,this._boundUniformsIdsToIndexHash=Object.create(null),this._boundIndexToUniformsHash=Object.create(null),this._shaderSyncFunctions=Object.create(null),this._renderer=t}contextChange(t){this._gl=t,this._maxBindings=t.MAX_UNIFORM_BUFFER_BINDINGS?t.getParameter(t.MAX_UNIFORM_BUFFER_BINDINGS):0,this._programDataHash=Object.create(null),this._boundUniformsIdsToIndexHash=Object.create(null),this._boundIndexToUniformsHash=Object.create(null),this._activeProgram=null}bind(t,e){if(this._setProgram(t.glProgram),e)return;Cx.textureCount=0,Cx.blockIndex=0;let r=this._shaderSyncFunctions[t.glProgram._key];r||(r=this._shaderSyncFunctions[t.glProgram._key]=this._generateShaderSync(t,this)),r(this._renderer,t,Cx)}updateUniformGroup(t){this._renderer.uniformGroup.updateUniformGroup(t,this._activeProgram,Cx)}bindUniformBlock(t,e,r=0){const s=this._renderer.buffer,i=this._getProgramData(this._activeProgram),n=t._bufferResource;n&&this._renderer.ubo.updateUniformGroup(t),s.updateBuffer(t.buffer);let o=this._boundUniformsIdsToIndexHash[t.uid];if(void 0===o){const e=this._nextIndex++%this._maxBindings,r=this._boundIndexToUniformsHash[e];r&&(this._boundUniformsIdsToIndexHash[r.uid]=void 0),o=this._boundUniformsIdsToIndexHash[t.uid]=e,this._boundIndexToUniformsHash[e]=t,n?s.bindBufferRange(t.buffer,e,t.offset):s.bindBufferBase(t.buffer,e)}const a=this._gl,l=this._activeProgram._uniformBlockData[e].index;i.uniformBlockBindings[r]!==o&&(i.uniformBlockBindings[r]=o,a.uniformBlockBinding(i.program,l,o))}_setProgram(t){if(this._activeProgram===t)return;this._activeProgram=t;const e=this._getProgramData(t);this._gl.useProgram(e.program)}_getProgramData(t){return this._programDataHash[t._key]||this._createProgramData(t)}_createProgramData(t){const e=t._key;return this._programDataHash[e]=Ox(this._gl,t),this._programDataHash[e]}destroy(){for(const t of Object.keys(this._programDataHash))this._programDataHash[t].destroy(),this._programDataHash[t]=null;this._programDataHash=null,this._boundUniformsIdsToIndexHash=null}_generateShaderSync(t,e){return gx(t,e)}}Ix.extension={type:[u.WebGLSystem],name:"shader"};const Gx={f32:"if (cv !== v) {\n            cu.value = v;\n            gl.uniform1f(location, v);\n        }","vec2<f32>":"if (cv[0] !== v[0] || cv[1] !== v[1]) {\n            cv[0] = v[0];\n            cv[1] = v[1];\n            gl.uniform2f(location, v[0], v[1]);\n        }","vec3<f32>":"if (cv[0] !== v[0] || cv[1] !== v[1] || cv[2] !== v[2]) {\n            cv[0] = v[0];\n            cv[1] = v[1];\n            cv[2] = v[2];\n            gl.uniform3f(location, v[0], v[1], v[2]);\n        }","vec4<f32>":"if (cv[0] !== v[0] || cv[1] !== v[1] || cv[2] !== v[2] || cv[3] !== v[3]) {\n            cv[0] = v[0];\n            cv[1] = v[1];\n            cv[2] = v[2];\n            cv[3] = v[3];\n            gl.uniform4f(location, v[0], v[1], v[2], v[3]);\n        }",i32:"if (cv !== v) {\n            cu.value = v;\n            gl.uniform1i(location, v);\n        }","vec2<i32>":"if (cv[0] !== v[0] || cv[1] !== v[1]) {\n            cv[0] = v[0];\n            cv[1] = v[1];\n            gl.uniform2i(location, v[0], v[1]);\n        }","vec3<i32>":"if (cv[0] !== v[0] || cv[1] !== v[1] || cv[2] !== v[2]) {\n            cv[0] = v[0];\n            cv[1] = v[1];\n            cv[2] = v[2];\n            gl.uniform3i(location, v[0], v[1], v[2]);\n        }","vec4<i32>":"if (cv[0] !== v[0] || cv[1] !== v[1] || cv[2] !== v[2] || cv[3] !== v[3]) {\n            cv[0] = v[0];\n            cv[1] = v[1];\n            cv[2] = v[2];\n            cv[3] = v[3];\n            gl.uniform4i(location, v[0], v[1], v[2], v[3]);\n        }",u32:"if (cv !== v) {\n            cu.value = v;\n            gl.uniform1ui(location, v);\n        }","vec2<u32>":"if (cv[0] !== v[0] || cv[1] !== v[1]) {\n            cv[0] = v[0];\n            cv[1] = v[1];\n            gl.uniform2ui(location, v[0], v[1]);\n        }","vec3<u32>":"if (cv[0] !== v[0] || cv[1] !== v[1] || cv[2] !== v[2]) {\n            cv[0] = v[0];\n            cv[1] = v[1];\n            cv[2] = v[2];\n            gl.uniform3ui(location, v[0], v[1], v[2]);\n        }","vec4<u32>":"if (cv[0] !== v[0] || cv[1] !== v[1] || cv[2] !== v[2] || cv[3] !== v[3]) {\n            cv[0] = v[0];\n            cv[1] = v[1];\n            cv[2] = v[2];\n            cv[3] = v[3];\n            gl.uniform4ui(location, v[0], v[1], v[2], v[3]);\n        }",bool:"if (cv !== v) {\n            cu.value = v;\n            gl.uniform1i(location, v);\n        }","vec2<bool>":"if (cv[0] !== v[0] || cv[1] !== v[1]) {\n            cv[0] = v[0];\n            cv[1] = v[1];\n            gl.uniform2i(location, v[0], v[1]);\n        }","vec3<bool>":"if (cv[0] !== v[0] || cv[1] !== v[1] || cv[2] !== v[2]) {\n            cv[0] = v[0];\n            cv[1] = v[1];\n            cv[2] = v[2];\n            gl.uniform3i(location, v[0], v[1], v[2]);\n        }","vec4<bool>":"if (cv[0] !== v[0] || cv[1] !== v[1] || cv[2] !== v[2] || cv[3] !== v[3]) {\n            cv[0] = v[0];\n            cv[1] = v[1];\n            cv[2] = v[2];\n            cv[3] = v[3];\n            gl.uniform4i(location, v[0], v[1], v[2], v[3]);\n        }","mat2x2<f32>":"gl.uniformMatrix2fv(location, false, v);","mat3x3<f32>":"gl.uniformMatrix3fv(location, false, v);","mat4x4<f32>":"gl.uniformMatrix4fv(location, false, v);"},kx={f32:"gl.uniform1fv(location, v);","vec2<f32>":"gl.uniform2fv(location, v);","vec3<f32>":"gl.uniform3fv(location, v);","vec4<f32>":"gl.uniform4fv(location, v);","mat2x2<f32>":"gl.uniformMatrix2fv(location, false, v);","mat3x3<f32>":"gl.uniformMatrix3fv(location, false, v);","mat4x4<f32>":"gl.uniformMatrix4fv(location, false, v);",i32:"gl.uniform1iv(location, v);","vec2<i32>":"gl.uniform2iv(location, v);","vec3<i32>":"gl.uniform3iv(location, v);","vec4<i32>":"gl.uniform4iv(location, v);",u32:"gl.uniform1iv(location, v);","vec2<u32>":"gl.uniform2iv(location, v);","vec3<u32>":"gl.uniform3iv(location, v);","vec4<u32>":"gl.uniform4iv(location, v);",bool:"gl.uniform1iv(location, v);","vec2<bool>":"gl.uniform2iv(location, v);","vec3<bool>":"gl.uniform3iv(location, v);","vec4<bool>":"gl.uniform4iv(location, v);"};function Bx(t,e){const r=["\n        var v = null;\n        var cv = null;\n        var cu = null;\n        var t = 0;\n        var gl = renderer.gl;\n        var name = null;\n    "];for(const s in t.uniforms){if(!e[s]){t.uniforms[s]instanceof vn?t.uniforms[s].ubo?r.push(`\n                        renderer.shader.bindUniformBlock(uv.${s}, "${s}");\n                    `):r.push(`\n                        renderer.shader.updateUniformGroup(uv.${s});\n                    `):t.uniforms[s]instanceof fx&&r.push(`\n                        renderer.shader.bindBufferResource(uv.${s}, "${s}");\n                    `);continue}const i=t.uniformStructures[s];let n=!1;for(let t=0;t<I_.length;t++){const e=I_[t];if(i.type===e.type&&e.test(i)){r.push(`name = "${s}";`,I_[t].uniform),n=!0;break}}if(!n){const t=(1===i.size?Gx:kx)[i.type].replace("location",`ud["${s}"].location`);r.push(`\n            cu = ud["${s}"];\n            cv = cu.value;\n            v = uv["${s}"];\n            ${t};`)}}return new Function("ud","uv","renderer","syncData",r.join("\n"))}class Dx{constructor(t){this._cache={},this._uniformGroupSyncHash={},this._renderer=t,this.gl=null,this._cache={}}contextChange(t){this.gl=t}updateUniformGroup(t,e,r){const s=this._renderer.shader._getProgramData(e);(!t.isStatic||t._dirtyId!==s.uniformDirtyGroups[t.uid])&&(s.uniformDirtyGroups[t.uid]=t._dirtyId,this._getUniformSyncFunction(t,e)(s.uniformData,t.uniforms,this._renderer,r))}_getUniformSyncFunction(t,e){var r;return(null==(r=this._uniformGroupSyncHash[t._signature])?void 0:r[e._key])||this._createUniformSyncFunction(t,e)}_createUniformSyncFunction(t,e){const r=this._uniformGroupSyncHash[t._signature]||(this._uniformGroupSyncHash[t._signature]={}),s=this._getSignature(t,e._uniformData,"u");return this._cache[s]||(this._cache[s]=this._generateUniformsSync(t,e._uniformData)),r[e._key]=this._cache[s],r[e._key]}_generateUniformsSync(t,e){return Bx(t,e)}_getSignature(t,e,r){const s=t.uniforms,i=[`${r}-`];for(const t in s)i.push(t),e[t]&&i.push(e[t].type);return i.join("-")}destroy(){this._renderer=null,this._cache=null}}Dx.extension={type:[u.WebGLSystem],name:"uniformGroup"};const Fx={float:1,vec2:2,vec3:3,vec4:4,int:1,ivec2:2,ivec3:3,ivec4:4,uint:1,uvec2:2,uvec3:3,uvec4:4,bool:1,bvec2:2,bvec3:3,bvec4:4,mat2:4,mat3:9,mat4:16,sampler2D:1};function Nx(t){const e={};return e.normal=[t.ONE,t.ONE_MINUS_SRC_ALPHA],e.add=[t.ONE,t.ONE],e.multiply=[t.DST_COLOR,t.ONE_MINUS_SRC_ALPHA,t.ONE,t.ONE_MINUS_SRC_ALPHA],e.screen=[t.ONE,t.ONE_MINUS_SRC_COLOR,t.ONE,t.ONE_MINUS_SRC_ALPHA],e.none=[0,0],e["normal-npm"]=[t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA,t.ONE,t.ONE_MINUS_SRC_ALPHA],e["add-npm"]=[t.SRC_ALPHA,t.ONE,t.ONE,t.ONE],e["screen-npm"]=[t.SRC_ALPHA,t.ONE_MINUS_SRC_COLOR,t.ONE,t.ONE_MINUS_SRC_ALPHA],e.erase=[t.ZERO,t.ONE_MINUS_SRC_ALPHA],e}const Ux=class t{constructor(){this.gl=null,this.stateId=0,this.polygonOffset=0,this.blendMode="none",this._blendEq=!1,this.map=[],this.map[0]=this.setBlend,this.map[1]=this.setOffset,this.map[2]=this.setCullFace,this.map[3]=this.setDepthTest,this.map[4]=this.setFrontFace,this.map[5]=this.setDepthMask,this.checks=[],this.defaultState=an.for2d()}contextChange(t){this.gl=t,this.blendModesMap=Nx(t),this.reset()}set(t){if(t=t||this.defaultState,this.stateId!==t.data){let e=this.stateId^t.data,r=0;for(;e;)1&e&&this.map[r].call(this,!!(t.data&1<<r)),e>>=1,r++;this.stateId=t.data}for(let e=0;e<this.checks.length;e++)this.checks[e](this,t)}forceState(t){t=t||this.defaultState;for(let e=0;e<this.map.length;e++)this.map[e].call(this,!!(t.data&1<<e));for(let e=0;e<this.checks.length;e++)this.checks[e](this,t);this.stateId=t.data}setBlend(e){this._updateCheck(t._checkBlendMode,e),this.gl[e?"enable":"disable"](this.gl.BLEND)}setOffset(e){this._updateCheck(t._checkPolygonOffset,e),this.gl[e?"enable":"disable"](this.gl.POLYGON_OFFSET_FILL)}setDepthTest(t){this.gl[t?"enable":"disable"](this.gl.DEPTH_TEST)}setDepthMask(t){this.gl.depthMask(t)}setCullFace(t){this.gl[t?"enable":"disable"](this.gl.CULL_FACE)}setFrontFace(t){this.gl.frontFace(this.gl[t?"CW":"CCW"])}setBlendMode(t){if(this.blendModesMap[t]||(t="normal"),t===this.blendMode)return;this.blendMode=t;const e=this.blendModesMap[t],r=this.gl;2===e.length?r.blendFunc(e[0],e[1]):r.blendFuncSeparate(e[0],e[1],e[2],e[3]),6===e.length?(this._blendEq=!0,r.blendEquationSeparate(e[4],e[5])):this._blendEq&&(this._blendEq=!1,r.blendEquationSeparate(r.FUNC_ADD,r.FUNC_ADD))}setPolygonOffset(t,e){this.gl.polygonOffset(t,e)}reset(){this.gl.pixelStorei(this.gl.UNPACK_FLIP_Y_WEBGL,!1),this.forceState(this.defaultState),this._blendEq=!0,this.blendMode="",this.setBlendMode("normal")}_updateCheck(t,e){const r=this.checks.indexOf(t);e&&-1===r?this.checks.push(t):!e&&-1!==r&&this.checks.splice(r,1)}static _checkBlendMode(t,e){t.setBlendMode(e.blendMode)}static _checkPolygonOffset(t,e){t.setPolygonOffset(1,e.polygonOffset)}destroy(){this.gl=null,this.checks.length=0}};Ux.extension={type:[u.WebGLSystem],name:"state"};let Lx=Ux;class Xx{constructor(t){this.target=l_.TEXTURE_2D,this.texture=t,this.width=-1,this.height=-1,this.type=u_.UNSIGNED_BYTE,this.internalFormat=a_.RGBA,this.format=a_.RGBA,this.samplerType=0}}const zx={id:"image",upload(t,e,r){e.width===t.width||e.height===t.height?r.texSubImage2D(r.TEXTURE_2D,0,0,0,e.format,e.type,t.resource):r.texImage2D(e.target,0,e.internalFormat,t.width,t.height,0,e.format,e.type,t.resource),e.width=t.width,e.height=t.height}},Hx={"bc1-rgba-unorm":!0,"bc1-rgba-unorm-srgb":!0,"bc2-rgba-unorm":!0,"bc2-rgba-unorm-srgb":!0,"bc3-rgba-unorm":!0,"bc3-rgba-unorm-srgb":!0,"bc4-r-unorm":!0,"bc4-r-snorm":!0,"bc5-rg-unorm":!0,"bc5-rg-snorm":!0,"bc6h-rgb-ufloat":!0,"bc6h-rgb-float":!0,"bc7-rgba-unorm":!0,"bc7-rgba-unorm-srgb":!0,"etc2-rgb8unorm":!0,"etc2-rgb8unorm-srgb":!0,"etc2-rgb8a1unorm":!0,"etc2-rgb8a1unorm-srgb":!0,"etc2-rgba8unorm":!0,"etc2-rgba8unorm-srgb":!0,"eac-r11unorm":!0,"eac-r11snorm":!0,"eac-rg11unorm":!0,"eac-rg11snorm":!0,"astc-4x4-unorm":!0,"astc-4x4-unorm-srgb":!0,"astc-5x4-unorm":!0,"astc-5x4-unorm-srgb":!0,"astc-5x5-unorm":!0,"astc-5x5-unorm-srgb":!0,"astc-6x5-unorm":!0,"astc-6x5-unorm-srgb":!0,"astc-6x6-unorm":!0,"astc-6x6-unorm-srgb":!0,"astc-8x5-unorm":!0,"astc-8x5-unorm-srgb":!0,"astc-8x6-unorm":!0,"astc-8x6-unorm-srgb":!0,"astc-8x8-unorm":!0,"astc-8x8-unorm-srgb":!0,"astc-10x5-unorm":!0,"astc-10x5-unorm-srgb":!0,"astc-10x6-unorm":!0,"astc-10x6-unorm-srgb":!0,"astc-10x8-unorm":!0,"astc-10x8-unorm-srgb":!0,"astc-10x10-unorm":!0,"astc-10x10-unorm-srgb":!0,"astc-12x10-unorm":!0,"astc-12x10-unorm-srgb":!0,"astc-12x12-unorm":!0,"astc-12x12-unorm-srgb":!0},jx={id:"compressed",upload(t,e,r){r.pixelStorei(r.UNPACK_ALIGNMENT,4);let s=t.pixelWidth,i=t.pixelHeight;const n=!!Hx[t.format];for(let o=0;o<t.resource.length;o++){const a=t.resource[o];n?r.compressedTexImage2D(r.TEXTURE_2D,o,e.internalFormat,s,i,0,a):r.texImage2D(r.TEXTURE_2D,o,e.internalFormat,s,i,0,e.format,e.type,a),s=Math.max(s>>1,1),i=Math.max(i>>1,1)}}},Vx={id:"image",upload(t,e,r,s){const i="premultiply-alpha-on-upload"===t.alphaMode;r.pixelStorei(r.UNPACK_PREMULTIPLY_ALPHA_WEBGL,i);const n=e.width,o=e.height,a=t.pixelWidth,l=t.pixelHeight,h=t.resourceWidth,u=t.resourceHeight;h<a||u<l?((n!==a||o!==l)&&r.texImage2D(e.target,0,e.internalFormat,a,l,0,e.format,e.type,null),2===s?r.texSubImage2D(r.TEXTURE_2D,0,0,0,h,u,e.format,e.type,t.resource):r.texSubImage2D(r.TEXTURE_2D,0,0,0,e.format,e.type,t.resource)):n===a||o===l?r.texSubImage2D(r.TEXTURE_2D,0,0,0,e.format,e.type,t.resource):2===s?r.texImage2D(e.target,0,e.internalFormat,a,l,0,e.format,e.type,t.resource):r.texImage2D(e.target,0,e.internalFormat,e.format,e.type,t.resource),e.width=a,e.height=l}},Wx={id:"video",upload(t,e,r,s){t.isValid?Vx.upload(t,e,r,s):r.texImage2D(e.target,0,e.internalFormat,1,1,0,e.format,e.type,null)}},$x={linear:9729,nearest:9728},Yx={linear:{linear:9987,nearest:9985},nearest:{linear:9986,nearest:9984}},qx={"clamp-to-edge":33071,repeat:10497,"mirror-repeat":33648},Kx={never:512,less:513,equal:514,"less-equal":515,greater:516,"not-equal":517,"greater-equal":518,always:519};function Zx(t,e,r,s,i,n,o,a){const l=n;if(!a||"repeat"!==t.addressModeU||"repeat"!==t.addressModeV||"repeat"!==t.addressModeW){const r=qx[o?"clamp-to-edge":t.addressModeU],s=qx[o?"clamp-to-edge":t.addressModeV],n=qx[o?"clamp-to-edge":t.addressModeW];e[i](l,e.TEXTURE_WRAP_S,r),e[i](l,e.TEXTURE_WRAP_T,s),e.TEXTURE_WRAP_R&&e[i](l,e.TEXTURE_WRAP_R,n)}if((!a||"linear"!==t.magFilter)&&e[i](l,e.TEXTURE_MAG_FILTER,$x[t.magFilter]),r){if(!a||"linear"!==t.mipmapFilter){const r=Yx[t.minFilter][t.mipmapFilter];e[i](l,e.TEXTURE_MIN_FILTER,r)}}else e[i](l,e.TEXTURE_MIN_FILTER,$x[t.minFilter]);if(s&&t.maxAnisotropy>1){const r=Math.min(t.maxAnisotropy,e.getParameter(s.MAX_TEXTURE_MAX_ANISOTROPY_EXT));e[i](l,s.TEXTURE_MAX_ANISOTROPY_EXT,r)}t.compare&&e[i](l,e.TEXTURE_COMPARE_FUNC,Kx[t.compare])}function Qx(t){return{r8unorm:t.RED,r8snorm:t.RED,r8uint:t.RED,r8sint:t.RED,r16uint:t.RED,r16sint:t.RED,r16float:t.RED,rg8unorm:t.RG,rg8snorm:t.RG,rg8uint:t.RG,rg8sint:t.RG,r32uint:t.RED,r32sint:t.RED,r32float:t.RED,rg16uint:t.RG,rg16sint:t.RG,rg16float:t.RG,rgba8unorm:t.RGBA,"rgba8unorm-srgb":t.RGBA,rgba8snorm:t.RGBA,rgba8uint:t.RGBA,rgba8sint:t.RGBA,bgra8unorm:t.RGBA,"bgra8unorm-srgb":t.RGBA,rgb9e5ufloat:t.RGB,rgb10a2unorm:t.RGBA,rg11b10ufloat:t.RGB,rg32uint:t.RG,rg32sint:t.RG,rg32float:t.RG,rgba16uint:t.RGBA,rgba16sint:t.RGBA,rgba16float:t.RGBA,rgba32uint:t.RGBA,rgba32sint:t.RGBA,rgba32float:t.RGBA,stencil8:t.STENCIL_INDEX8,depth16unorm:t.DEPTH_COMPONENT,depth24plus:t.DEPTH_COMPONENT,"depth24plus-stencil8":t.DEPTH_STENCIL,depth32float:t.DEPTH_COMPONENT,"depth32float-stencil8":t.DEPTH_STENCIL}}var Jx=Object.defineProperty,ty=Object.defineProperties,ey=Object.getOwnPropertyDescriptors,ry=Object.getOwnPropertySymbols,sy=Object.prototype.hasOwnProperty,iy=Object.prototype.propertyIsEnumerable,ny=(t,e,r)=>e in t?Jx(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r,oy=(t,e)=>{for(var r in e||(e={}))sy.call(e,r)&&ny(t,r,e[r]);if(ry)for(var r of ry(e))iy.call(e,r)&&ny(t,r,e[r]);return t};function ay(t,e){let r={},s=t.RGBA;return t instanceof Ne.get().getWebGLRenderingContext()?e.srgb&&(r={"rgba8unorm-srgb":e.srgb.SRGB8_ALPHA8_EXT,"bgra8unorm-srgb":e.srgb.SRGB8_ALPHA8_EXT}):(r={"rgba8unorm-srgb":t.SRGB8_ALPHA8,"bgra8unorm-srgb":t.SRGB8_ALPHA8},s=t.RGBA8),oy(oy(oy(oy(oy(oy(((t,e)=>ty(t,ey(e)))(oy({r8unorm:t.R8,r8snorm:t.R8_SNORM,r8uint:t.R8UI,r8sint:t.R8I,r16uint:t.R16UI,r16sint:t.R16I,r16float:t.R16F,rg8unorm:t.RG8,rg8snorm:t.RG8_SNORM,rg8uint:t.RG8UI,rg8sint:t.RG8I,r32uint:t.R32UI,r32sint:t.R32I,r32float:t.R32F,rg16uint:t.RG16UI,rg16sint:t.RG16I,rg16float:t.RG16F,rgba8unorm:t.RGBA},r),{rgba8snorm:t.RGBA8_SNORM,rgba8uint:t.RGBA8UI,rgba8sint:t.RGBA8I,bgra8unorm:s,rgb9e5ufloat:t.RGB9_E5,rgb10a2unorm:t.RGB10_A2,rg11b10ufloat:t.R11F_G11F_B10F,rg32uint:t.RG32UI,rg32sint:t.RG32I,rg32float:t.RG32F,rgba16uint:t.RGBA16UI,rgba16sint:t.RGBA16I,rgba16float:t.RGBA16F,rgba32uint:t.RGBA32UI,rgba32sint:t.RGBA32I,rgba32float:t.RGBA32F,stencil8:t.STENCIL_INDEX8,depth16unorm:t.DEPTH_COMPONENT16,depth24plus:t.DEPTH_COMPONENT24,"depth24plus-stencil8":t.DEPTH24_STENCIL8,depth32float:t.DEPTH_COMPONENT32F,"depth32float-stencil8":t.DEPTH32F_STENCIL8}),e.s3tc?{"bc1-rgba-unorm":e.s3tc.COMPRESSED_RGBA_S3TC_DXT1_EXT,"bc2-rgba-unorm":e.s3tc.COMPRESSED_RGBA_S3TC_DXT3_EXT,"bc3-rgba-unorm":e.s3tc.COMPRESSED_RGBA_S3TC_DXT5_EXT}:{}),e.s3tc_sRGB?{"bc1-rgba-unorm-srgb":e.s3tc_sRGB.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT,"bc2-rgba-unorm-srgb":e.s3tc_sRGB.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT,"bc3-rgba-unorm-srgb":e.s3tc_sRGB.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT}:{}),e.rgtc?{"bc4-r-unorm":e.rgtc.COMPRESSED_RED_RGTC1_EXT,"bc4-r-snorm":e.rgtc.COMPRESSED_SIGNED_RED_RGTC1_EXT,"bc5-rg-unorm":e.rgtc.COMPRESSED_RED_GREEN_RGTC2_EXT,"bc5-rg-snorm":e.rgtc.COMPRESSED_SIGNED_RED_GREEN_RGTC2_EXT}:{}),e.bptc?{"bc6h-rgb-float":e.bptc.COMPRESSED_RGB_BPTC_SIGNED_FLOAT_EXT,"bc6h-rgb-ufloat":e.bptc.COMPRESSED_RGB_BPTC_UNSIGNED_FLOAT_EXT,"bc7-rgba-unorm":e.bptc.COMPRESSED_RGBA_BPTC_UNORM_EXT,"bc7-rgba-unorm-srgb":e.bptc.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT}:{}),e.etc?{"etc2-rgb8unorm":e.etc.COMPRESSED_RGB8_ETC2,"etc2-rgb8unorm-srgb":e.etc.COMPRESSED_SRGB8_ETC2,"etc2-rgb8a1unorm":e.etc.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2,"etc2-rgb8a1unorm-srgb":e.etc.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2,"etc2-rgba8unorm":e.etc.COMPRESSED_RGBA8_ETC2_EAC,"etc2-rgba8unorm-srgb":e.etc.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC,"eac-r11unorm":e.etc.COMPRESSED_R11_EAC,"eac-rg11unorm":e.etc.COMPRESSED_SIGNED_RG11_EAC}:{}),e.astc?{"astc-4x4-unorm":e.astc.COMPRESSED_RGBA_ASTC_4x4_KHR,"astc-4x4-unorm-srgb":e.astc.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR,"astc-5x4-unorm":e.astc.COMPRESSED_RGBA_ASTC_5x4_KHR,"astc-5x4-unorm-srgb":e.astc.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR,"astc-5x5-unorm":e.astc.COMPRESSED_RGBA_ASTC_5x5_KHR,"astc-5x5-unorm-srgb":e.astc.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR,"astc-6x5-unorm":e.astc.COMPRESSED_RGBA_ASTC_6x5_KHR,"astc-6x5-unorm-srgb":e.astc.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR,"astc-6x6-unorm":e.astc.COMPRESSED_RGBA_ASTC_6x6_KHR,"astc-6x6-unorm-srgb":e.astc.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR,"astc-8x5-unorm":e.astc.COMPRESSED_RGBA_ASTC_8x5_KHR,"astc-8x5-unorm-srgb":e.astc.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR,"astc-8x6-unorm":e.astc.COMPRESSED_RGBA_ASTC_8x6_KHR,"astc-8x6-unorm-srgb":e.astc.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR,"astc-8x8-unorm":e.astc.COMPRESSED_RGBA_ASTC_8x8_KHR,"astc-8x8-unorm-srgb":e.astc.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR,"astc-10x5-unorm":e.astc.COMPRESSED_RGBA_ASTC_10x5_KHR,"astc-10x5-unorm-srgb":e.astc.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR,"astc-10x6-unorm":e.astc.COMPRESSED_RGBA_ASTC_10x6_KHR,"astc-10x6-unorm-srgb":e.astc.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR,"astc-10x8-unorm":e.astc.COMPRESSED_RGBA_ASTC_10x8_KHR,"astc-10x8-unorm-srgb":e.astc.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR,"astc-10x10-unorm":e.astc.COMPRESSED_RGBA_ASTC_10x10_KHR,"astc-10x10-unorm-srgb":e.astc.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR,"astc-12x10-unorm":e.astc.COMPRESSED_RGBA_ASTC_12x10_KHR,"astc-12x10-unorm-srgb":e.astc.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR,"astc-12x12-unorm":e.astc.COMPRESSED_RGBA_ASTC_12x12_KHR,"astc-12x12-unorm-srgb":e.astc.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR}:{})}function ly(t){return{r8unorm:t.UNSIGNED_BYTE,r8snorm:t.BYTE,r8uint:t.UNSIGNED_BYTE,r8sint:t.BYTE,r16uint:t.UNSIGNED_SHORT,r16sint:t.SHORT,r16float:t.HALF_FLOAT,rg8unorm:t.UNSIGNED_BYTE,rg8snorm:t.BYTE,rg8uint:t.UNSIGNED_BYTE,rg8sint:t.BYTE,r32uint:t.UNSIGNED_INT,r32sint:t.INT,r32float:t.FLOAT,rg16uint:t.UNSIGNED_SHORT,rg16sint:t.SHORT,rg16float:t.HALF_FLOAT,rgba8unorm:t.UNSIGNED_BYTE,"rgba8unorm-srgb":t.UNSIGNED_BYTE,rgba8snorm:t.BYTE,rgba8uint:t.UNSIGNED_BYTE,rgba8sint:t.BYTE,bgra8unorm:t.UNSIGNED_BYTE,"bgra8unorm-srgb":t.UNSIGNED_BYTE,rgb9e5ufloat:t.UNSIGNED_INT_5_9_9_9_REV,rgb10a2unorm:t.UNSIGNED_INT_2_10_10_10_REV,rg11b10ufloat:t.UNSIGNED_INT_10F_11F_11F_REV,rg32uint:t.UNSIGNED_INT,rg32sint:t.INT,rg32float:t.FLOAT,rgba16uint:t.UNSIGNED_SHORT,rgba16sint:t.SHORT,rgba16float:t.HALF_FLOAT,rgba32uint:t.UNSIGNED_INT,rgba32sint:t.INT,rgba32float:t.FLOAT,stencil8:t.UNSIGNED_BYTE,depth16unorm:t.UNSIGNED_SHORT,depth24plus:t.UNSIGNED_INT,"depth24plus-stencil8":t.UNSIGNED_INT_24_8,depth32float:t.FLOAT,"depth32float-stencil8":t.FLOAT_32_UNSIGNED_INT_24_8_REV}}class hy{constructor(t){this.managedTextures=[],this._glTextures=Object.create(null),this._glSamplers=Object.create(null),this._boundTextures=[],this._activeTextureLocation=-1,this._boundSamplers=Object.create(null),this._uploads={image:Vx,buffer:zx,video:Wx,compressed:jx},this._useSeparateSamplers=!1,this._renderer=t}contextChange(t){this._gl=t,this._mapFormatToInternalFormat||(this._mapFormatToInternalFormat=ay(t,this._renderer.context.extensions),this._mapFormatToType=ly(t),this._mapFormatToFormat=Qx(t)),this._glTextures=Object.create(null),this._glSamplers=Object.create(null),this._boundSamplers=Object.create(null);for(let t=0;t<16;t++)this.bind(zr.EMPTY,t)}initSource(t){this.bind(t)}bind(t,e=0){const r=t.source;t?(this.bindSource(r,e),this._useSeparateSamplers&&this._bindSampler(r.style,e)):(this.bindSource(null,e),this._useSeparateSamplers&&this._bindSampler(null,e))}bindSource(t,e=0){const r=this._gl;if(t._touched=this._renderer.textureGC.count,this._boundTextures[e]!==t){this._boundTextures[e]=t,this._activateLocation(e),t=t||zr.EMPTY.source;const s=this.getGlSource(t);r.bindTexture(s.target,s.texture)}}_bindSampler(t,e=0){const r=this._gl;if(!t)return this._boundSamplers[e]=null,void r.bindSampler(e,null);const s=this._getGlSampler(t);this._boundSamplers[e]!==s&&(this._boundSamplers[e]=s,r.bindSampler(e,s))}unbind(t){const e=t.source,r=this._boundTextures,s=this._gl;for(let t=0;t<r.length;t++)if(r[t]===e){this._activateLocation(t);const i=this.getGlSource(e);s.bindTexture(i.target,null),r[t]=null}}_activateLocation(t){this._activeTextureLocation!==t&&(this._activeTextureLocation=t,this._gl.activeTexture(this._gl.TEXTURE0+t))}_initSource(t){const e=this._gl,r=new Xx(e.createTexture());if(r.type=this._mapFormatToType[t.format],r.internalFormat=this._mapFormatToInternalFormat[t.format],r.format=this._mapFormatToFormat[t.format],t.autoGenerateMipmaps&&(this._renderer.context.supports.nonPowOf2mipmaps||t.isPowerOfTwo)){const e=Math.max(t.width,t.height);t.mipLevelCount=Math.floor(Math.log2(e))+1}return this._glTextures[t.uid]=r,this.managedTextures.includes(t)||(t.on("update",this.onSourceUpdate,this),t.on("resize",this.onSourceUpdate,this),t.on("styleChange",this.onStyleChange,this),t.on("destroy",this.onSourceDestroy,this),t.on("unload",this.onSourceUnload,this),t.on("updateMipmaps",this.onUpdateMipmaps,this),this.managedTextures.push(t)),this.onSourceUpdate(t),this.updateStyle(t,!1),r}onStyleChange(t){this.updateStyle(t,!1)}updateStyle(t,e){const r=this._gl,s=this.getGlSource(t);r.bindTexture(r.TEXTURE_2D,s.texture),this._boundTextures[this._activeTextureLocation]=t,Zx(t.style,r,t.mipLevelCount>1,this._renderer.context.extensions.anisotropicFiltering,"texParameteri",r.TEXTURE_2D,!this._renderer.context.supports.nonPowOf2wrapping&&!t.isPowerOfTwo,e)}onSourceUnload(t){const e=this._glTextures[t.uid];e&&(this.unbind(t),this._glTextures[t.uid]=null,this._gl.deleteTexture(e.texture))}onSourceUpdate(t){const e=this._gl,r=this.getGlSource(t);e.bindTexture(e.TEXTURE_2D,r.texture),this._boundTextures[this._activeTextureLocation]=t,this._uploads[t.uploadMethodId]?this._uploads[t.uploadMethodId].upload(t,r,e,this._renderer.context.webGLVersion):e.texImage2D(e.TEXTURE_2D,0,e.RGBA,t.pixelWidth,t.pixelHeight,0,e.RGBA,e.UNSIGNED_BYTE,null),t.autoGenerateMipmaps&&t.mipLevelCount>1&&this.onUpdateMipmaps(t,!1)}onUpdateMipmaps(t,e=!0){e&&this.bindSource(t,0);const r=this.getGlSource(t);this._gl.generateMipmap(r.target)}onSourceDestroy(t){t.off("destroy",this.onSourceDestroy,this),t.off("update",this.onSourceUpdate,this),t.off("resize",this.onSourceUpdate,this),t.off("unload",this.onSourceUnload,this),t.off("styleChange",this.onStyleChange,this),t.off("updateMipmaps",this.onUpdateMipmaps,this),this.managedTextures.splice(this.managedTextures.indexOf(t),1),this.onSourceUnload(t)}_initSampler(t){const e=this._gl,r=this._gl.createSampler();return this._glSamplers[t._resourceId]=r,Zx(t,e,this._boundTextures[this._activeTextureLocation].mipLevelCount>1,this._renderer.context.extensions.anisotropicFiltering,"samplerParameteri",r,!1,!0),this._glSamplers[t._resourceId]}_getGlSampler(t){return this._glSamplers[t._resourceId]||this._initSampler(t)}getGlSource(t){return this._glTextures[t.uid]||this._initSource(t)}generateCanvas(t){const{pixels:e,width:r,height:s}=this.getPixels(t),i=Ne.get().createCanvas();i.width=r,i.height=s;const n=i.getContext("2d");if(n){const t=n.createImageData(r,s);t.data.set(e),n.putImageData(t,0,0)}return i}getPixels(t){const e=t.source.resolution,r=t.frame,s=Math.max(Math.round(r.width*e),1),i=Math.max(Math.round(r.height*e),1),n=new Uint8Array(4*s*i),o=this._renderer,a=o.renderTarget.getRenderTarget(t),l=o.renderTarget.getGpuRenderTarget(a),h=o.gl;return h.bindFramebuffer(h.FRAMEBUFFER,l.resolveTargetFramebuffer),h.readPixels(Math.round(r.x*e),Math.round(r.y*e),s,i,h.RGBA,h.UNSIGNED_BYTE,n),{pixels:new Uint8ClampedArray(n.buffer),width:s,height:i}}destroy(){this.managedTextures.slice().forEach((t=>this.onSourceDestroy(t))),this.managedTextures=null,this._renderer=null}}hy.extension={type:[u.WebGLSystem],name:"texture"};class uy{init(){const t=new vn({uColor:{value:new Float32Array([1,1,1,1]),type:"vec4<f32>"},uTransformMatrix:{value:new it,type:"mat3x3<f32>"},uRound:{value:0,type:"f32"}}),e=Yl({name:"graphics",bits:[Kl,sh(Fs),hu,nh]});this.shader=new fh({glProgram:e,resources:{localUniforms:t,batchSamplers:ah}})}execute(t,e){const r=e.context,s=r.customShader||this.shader,i=t.renderer,n=i.graphicsContext,{geometry:o,instructions:a}=n.getContextRenderData(r);s.groups[0]=i.globalUniforms.bindGroup,i.shader.bind(s),i.geometry.bind(o,s.glProgram);const l=a.instructions;for(let t=0;t<a.instructionSize;t++){const e=l[t];if(e.size){for(let t=0;t<e.textures.textures.length;t++)i.texture.bind(e.textures.textures[t],t);i.geometry.draw("triangle-list",e.size,e.start)}}}destroy(){this.shader.destroy(!0),this.shader=null}}uy.extension={type:[u.WebGLPipesAdaptor],name:"graphics"};class cy{init(){const t=Yl({name:"mesh",bits:[hu,Bm,nh]});this._shader=new fh({glProgram:t,resources:{uTexture:zr.EMPTY.source,textureUniforms:{uTextureMatrix:{type:"mat3x3<f32>",value:new it}}}})}execute(t,e){const r=t.renderer;let s=e._shader;if(s){if(!s.glProgram)return}else{s=this._shader;const t=e.texture,r=t.source;s.resources.uTexture=r,s.resources.uSampler=r.style,s.resources.textureUniforms.uniforms.uTextureMatrix=t.textureMatrix.mapCoord}s.groups[100]=r.globalUniforms.bindGroup,s.groups[101]=t.localUniformsBindGroup,r.encoder.draw({geometry:e._geometry,shader:s,state:e.state})}destroy(){this._shader.destroy(!0),this._shader=null}}cy.extension={type:[u.WebGLPipesAdaptor],name:"mesh"};class dy{constructor(t){this._renderer=t}addRenderable(t,e){this._renderer.renderPipes.batch.break(e),e.add(t)}execute(t){t.isRenderable&&t.render(this._renderer)}destroy(){this._renderer=null}}function py(t,e){const r=t.instructionSet,s=r.instructions;for(let t=0;t<r.instructionSize;t++){const r=s[t];e[r.renderPipeId].execute(r)}}dy.extension={type:[u.WebGLPipes,u.WebGPUPipes,u.CanvasPipes],name:"customRender"};class fy{constructor(t){this._renderer=t}addRenderGroup(t,e){this._renderer.renderPipes.batch.break(e),e.add(t)}execute(t){t.isRenderable&&(this._renderer.globalUniforms.push({worldTransformMatrix:t.worldTransform,worldColor:t.worldColorAlpha}),py(t,this._renderer.renderPipes),this._renderer.globalUniforms.pop())}destroy(){this._renderer=null}}function gy(t,e=[]){e.push(t);for(let r=0;r<t.renderGroupChildren.length;r++)gy(t.renderGroupChildren[r],e);return e}fy.extension={type:[u.WebGLPipes,u.WebGPUPipes,u.CanvasPipes],name:"renderGroup"};const my=new jt;function _y(t,e=!1){xy(t);const r=t.childrenToUpdate,s=t.updateTick;t.updateTick++;for(const t in r){const e=r[t],i=e.list,n=e.index;for(let t=0;t<n;t++)yy(i[t],s,0);e.index=0}if(e)for(let r=0;r<t.renderGroupChildren.length;r++)_y(t.renderGroupChildren[r],e)}function xy(t){const e=t.root;let r;if(t.renderGroupParent){const s=t.renderGroupParent;t.worldTransform.appendFrom(e.relativeGroupTransform,s.worldTransform),t.worldColor=ai(e.groupColor,s.worldColor),r=e.groupAlpha*s.worldAlpha}else t.worldTransform.copyFrom(e.localTransform),t.worldColor=e.localColor,r=e.localAlpha;r=r<0?0:r>1?1:r,t.worldAlpha=r,t.worldColorAlpha=t.worldColor+((255*r|0)<<24)}function yy(t,e,r){if(e===t.updateTick)return;t.updateTick=e,t.didChange=!1;const s=t.localTransform;t.updateLocalTransform();const i=t.parent;if(i&&!i.isRenderGroupRoot?(r|=t._updateFlags,t.relativeGroupTransform.appendFrom(s,i.relativeGroupTransform),r&&by(t,i,r)):(r=t._updateFlags,t.relativeGroupTransform.copyFrom(s),r&&by(t,my,r)),!t.isRenderGroupRoot){const s=t.children,i=s.length;for(let t=0;t<i;t++)yy(s[t],e,r);const n=t.renderGroup;t.renderPipeId&&!n.structureDidChange&&n.updateRenderable(t)}}function by(t,e,r){if(1&r){t.groupColor=ai(t.localColor,e.groupColor);let r=t.localAlpha*e.groupAlpha;r=r<0?0:r>1?1:r,t.groupAlpha=r,t.groupColorAlpha=t.groupColor+((255*r|0)<<24)}2&r&&(t.groupBlendMode="inherit"===t.localBlendMode?e.groupBlendMode:t.localBlendMode),4&r&&(t.globalDisplayStatus=t.localDisplayStatus&e.globalDisplayStatus),t._updateFlags=0}function vy(t,e){const{list:r,index:s}=t.childrenRenderablesToUpdate;let i=!1;for(let t=0;t<s;t++){const s=r[t];if(i=e[s.renderPipeId].validateRenderable(s),i)break}return t.structureDidChange=i,i}const Ty=new it;class Sy{constructor(t){this._renderer=t}render({container:t,transform:e}){t.isRenderGroup=!0;const r=t.parent,s=t.renderGroup.renderGroupParent;t.parent=null,t.renderGroup.renderGroupParent=null;const i=this._renderer,n=gy(t.renderGroup,[]);let o=Ty;e&&(o=o.copyFrom(t.renderGroup.localTransform),t.renderGroup.localTransform.copyFrom(e));const a=i.renderPipes;for(let t=0;t<n.length;t++){const e=n[t];e.runOnRender(),e.instructionSet.renderPipes=a,e.structureDidChange||vy(e,a),_y(e),e.structureDidChange?(e.structureDidChange=!1,Dm(e,a)):wy(e),e.childrenRenderablesToUpdate.index=0,i.renderPipes.batch.upload(e.instructionSet)}i.globalUniforms.start({worldTransformMatrix:e?t.renderGroup.localTransform:t.renderGroup.worldTransform,worldColor:t.renderGroup.worldColorAlpha}),py(t.renderGroup,a),a.uniformBatch&&a.uniformBatch.renderEnd(),e&&t.renderGroup.localTransform.copyFrom(o),t.parent=r,t.renderGroup.renderGroupParent=s}destroy(){this._renderer=null}}function wy(t){const{list:e,index:r}=t.childrenRenderablesToUpdate;for(let s=0;s<r;s++){const r=e[s];r.didViewUpdate&&t.updateRenderable(r)}}Sy.extension={type:[u.WebGLSystem,u.WebGPUSystem,u.CanvasSystem],name:"renderGroup"};class Ey{constructor(t){this._gpuSpriteHash=Object.create(null),this._renderer=t}addRenderable(t,e){const r=this._getGpuSprite(t);t._didSpriteUpdate&&this._updateBatchableSprite(t,r),this._renderer.renderPipes.batch.addToBatch(r)}updateRenderable(t){const e=this._gpuSpriteHash[t.uid];t._didSpriteUpdate&&this._updateBatchableSprite(t,e),e.batcher.updateElement(e)}validateRenderable(t){const e=t._texture,r=this._getGpuSprite(t);return r.texture._source!==e._source&&!r.batcher.checkAndUpdateTexture(r,e)}destroyRenderable(t){const e=this._gpuSpriteHash[t.uid];gt.return(e),this._gpuSpriteHash[t.uid]=null}_updateBatchableSprite(t,e){t._didSpriteUpdate=!1,e.bounds=t.bounds,e.texture=t._texture}_getGpuSprite(t){return this._gpuSpriteHash[t.uid]||this._initGPUSprite(t)}_initGPUSprite(t){const e=gt.get(wn);return e.renderable=t,e.texture=t._texture,e.bounds=t.bounds,e.roundPixels=this._renderer._roundPixels|t._roundPixels,this._gpuSpriteHash[t.uid]=e,t._didSpriteUpdate=!1,t.on("destroyed",(()=>{this.destroyRenderable(t)})),e}destroy(){for(const t in this._gpuSpriteHash)gt.return(this._gpuSpriteHash[t]);this._gpuSpriteHash=null,this._renderer=null}}Ey.extension={type:[u.WebGLPipes,u.WebGPUPipes,u.CanvasPipes],name:"sprite"};var Ay=Object.defineProperty,My=Object.getOwnPropertySymbols,Py=Object.prototype.hasOwnProperty,Ry=Object.prototype.propertyIsEnumerable,Oy=(t,e,r)=>e in t?Ay(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r,Cy=(t,e)=>{for(var r in e||(e={}))Py.call(e,r)&&Oy(t,r,e[r]);if(My)for(var r of My(e))Ry.call(e,r)&&Oy(t,r,e[r]);return t};const Iy=class t{constructor(){this.clearBeforeRender=!0,this._backgroundColor=new Z(0),this.color=this._backgroundColor,this.alpha=1}init(e){e=Cy(Cy({},t.defaultOptions),e),this.clearBeforeRender=e.clearBeforeRender,this.color=e.background||e.backgroundColor||this._backgroundColor,this.alpha=e.backgroundAlpha,this._backgroundColor.setAlpha(e.backgroundAlpha)}get color(){return this._backgroundColor}set color(t){this._backgroundColor.setValue(t)}get alpha(){return this._backgroundColor.alpha}set alpha(t){this._backgroundColor.setAlpha(t)}get colorRgba(){return this._backgroundColor.toArray()}destroy(){}};Iy.extension={type:[u.WebGLSystem,u.WebGPUSystem,u.CanvasSystem],name:"background",priority:0},Iy.defaultOptions={backgroundAlpha:1,backgroundColor:0,clearBeforeRender:!0};let Gy=Iy;const ky={};p.handle(u.BlendMode,(t=>{if(!t.name)throw new Error("BlendMode extension must have a name property");ky[t.name]=t.ref}),(t=>{delete ky[t.name]}));class By{constructor(t){this._isAdvanced=!1,this._filterHash=Object.create(null),this._renderer=t}setBlendMode(t,e,r){this._activeBlendMode!==e?(this._activeBlendMode=e,this._isAdvanced&&this._endAdvancedBlendMode(r),this._isAdvanced=!!ky[e],this._isAdvanced&&(this._beginAdvancedBlendMode(r),this._renderableList.push(t))):this._isAdvanced&&this._renderableList.push(t)}_beginAdvancedBlendMode(t){this._renderer.renderPipes.batch.break(t);const e=this._activeBlendMode;if(!ky[e])return;this._filterHash[e]||(this._filterHash[e]=new dt({filters:[new ky[e]]}));const r={renderPipeId:"filter",action:"pushFilter",renderables:[],filterEffect:this._filterHash[e],canBundle:!1};this._renderableList=r.renderables,t.add(r)}_endAdvancedBlendMode(t){this._renderableList=null,this._renderer.renderPipes.batch.break(t),t.add({renderPipeId:"filter",action:"popFilter",canBundle:!1})}buildStart(){this._isAdvanced=!1}buildEnd(t){this._isAdvanced&&this._endAdvancedBlendMode(t)}destroy(){this._renderer=null,this._renderableList=null;for(const t in this._filterHash)this._filterHash[t].destroy();this._filterHash=null}}By.extension={type:[u.WebGLPipes,u.WebGPUPipes,u.CanvasPipes],name:"blendMode"};var Dy=Object.defineProperty,Fy=Object.getOwnPropertySymbols,Ny=Object.prototype.hasOwnProperty,Uy=Object.prototype.propertyIsEnumerable,Ly=(t,e,r)=>e in t?Dy(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r,Xy=(t,e)=>{for(var r in e||(e={}))Ny.call(e,r)&&Ly(t,r,e[r]);if(Fy)for(var r of Fy(e))Uy.call(e,r)&&Ly(t,r,e[r]);return t};const zy={png:"image/png",jpg:"image/jpeg",webp:"image/webp"},Hy=class t{constructor(t){this._renderer=t}_normalizeOptions(t,e={}){return t instanceof jt||t instanceof zr?Xy({target:t},e):Xy(Xy({},e),t)}async image(t){const e=new Image;return e.src=await this.base64(t),e}async base64(e){e=this._normalizeOptions(e,t.defaultImageOptions);const{format:r,quality:s}=e,i=this.canvas(e);if(void 0!==i.toBlob)return new Promise(((t,e)=>{i.toBlob((r=>{if(!r)return void e(new Error("ICanvas.toBlob failed!"));const s=new FileReader;s.onload=()=>t(s.result),s.onerror=e,s.readAsDataURL(r)}),zy[r],s)}));if(void 0!==i.toDataURL)return i.toDataURL(zy[r],s);if(void 0!==i.convertToBlob){const t=await i.convertToBlob({type:zy[r],quality:s});return new Promise(((e,r)=>{const s=new FileReader;s.onload=()=>e(s.result),s.onerror=r,s.readAsDataURL(t)}))}throw new Error("Extract.base64() requires ICanvas.toDataURL, ICanvas.toBlob, or ICanvas.convertToBlob to be implemented")}canvas(t){const e=(t=this._normalizeOptions(t)).target,r=this._renderer;if(e instanceof zr)return r.texture.generateCanvas(e);const s=r.textureGenerator.generateTexture(t),i=r.texture.generateCanvas(s);return s.destroy(),i}pixels(t){const e=(t=this._normalizeOptions(t)).target,r=this._renderer,s=e instanceof zr?e:r.textureGenerator.generateTexture(t),i=r.texture.getPixels(s);return e instanceof jt&&s.destroy(),i}texture(t){return(t=this._normalizeOptions(t)).target instanceof zr?t.target:this._renderer.textureGenerator.generateTexture(t)}download(t){var e;t=this._normalizeOptions(t);const r=this.canvas(t),s=document.createElement("a");s.download=null!=(e=t.filename)?e:"image.png",s.href=r.toDataURL("image/png"),document.body.appendChild(s),s.click(),document.body.removeChild(s)}log(t){var e;const r=null!=(e=t.width)?e:200;t=this._normalizeOptions(t);const s=this.canvas(t),i=s.toDataURL();console.log(`[Pixi Texture] ${s.width}px ${s.height}px`);const n=["font-size: 1px;",`padding: ${r}px 300px;`,`background: url(${i}) no-repeat;`,"background-size: contain;"].join(" ");console.log("%c ",n)}destroy(){this._renderer=null}};Hy.extension={type:[u.WebGLSystem,u.WebGPUSystem],name:"extract"},Hy.defaultImageOptions={format:"png",quality:1};let jy=Hy;class Vy extends zr{static create(t){return new zr({source:new Cr(t)})}resize(t,e,r){return this.source.resize(t,e,r),this}}var Wy=Object.defineProperty,$y=Object.defineProperties,Yy=Object.getOwnPropertyDescriptors,qy=Object.getOwnPropertySymbols,Ky=Object.prototype.hasOwnProperty,Zy=Object.prototype.propertyIsEnumerable,Qy=(t,e,r)=>e in t?Wy(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r;const Jy=new vt,tb=new St,eb=[0,0,0,0];class rb{constructor(t){this._renderer=t}generateTexture(t){var e;t instanceof jt&&(t={target:t,frame:void 0,textureSourceOptions:{},resolution:void 0});const r=t.resolution||this._renderer.resolution,s=t.antialias||this._renderer.view.antialias,i=t.target;let n=t.clearColor;n=n?Array.isArray(n)&&4===n.length?n:Z.shared.setValue(n).toArray():eb;const o=(null==(e=t.frame)?void 0:e.copyTo(Jy))||Rt(i,tb).rectangle;o.width=0|Math.max(o.width,1/r),o.height=0|Math.max(o.height,1/r);const a=Vy.create(((t,e)=>$y(t,Yy(e)))(((t,e)=>{for(var r in e||(e={}))Ky.call(e,r)&&Qy(t,r,e[r]);if(qy)for(var r of qy(e))Zy.call(e,r)&&Qy(t,r,e[r]);return t})({},t.textureSourceOptions),{width:o.width,height:o.height,resolution:r,antialias:s})),l=it.shared.translate(-o.x,-o.y);return this._renderer.render({container:i,transform:l,target:a,clearColor:n}),a}destroy(){this._renderer=null}}rb.extension={type:[u.WebGLSystem,u.WebGPUSystem],name:"textureGenerator"};class sb{constructor(t){this._stackIndex=0,this._globalUniformDataStack=[],this._uniformsPool=[],this._activeUniforms=[],this._bindGroupPool=[],this._activeBindGroups=[],this._renderer=t}reset(){this._stackIndex=0;for(let t=0;t<this._activeUniforms.length;t++)this._uniformsPool.push(this._activeUniforms[t]);for(let t=0;t<this._activeBindGroups.length;t++)this._bindGroupPool.push(this._activeBindGroups[t]);this._activeUniforms.length=0,this._activeBindGroups.length=0}start(t){this.reset(),this.push(t)}bind({size:t,projectionMatrix:e,worldTransformMatrix:r,worldColor:s,offset:i}){const n=this._renderer.renderTarget.renderTarget,o=this._stackIndex?this._globalUniformDataStack[this._stackIndex-1]:{projectionData:n,worldTransformMatrix:new it,worldColor:4294967295,offset:new rt},a={projectionMatrix:e||this._renderer.renderTarget.projectionMatrix,resolution:t||n.size,worldTransformMatrix:r||o.worldTransformMatrix,worldColor:s||o.worldColor,offset:i||o.offset,bindGroup:null},l=this._uniformsPool.pop()||this._createUniforms();this._activeUniforms.push(l);const h=l.uniforms;let u;h.uProjectionMatrix=a.projectionMatrix,h.uResolution=a.resolution,h.uWorldTransformMatrix.copyFrom(a.worldTransformMatrix),h.uWorldTransformMatrix.tx-=a.offset.x,h.uWorldTransformMatrix.ty-=a.offset.y,ln(a.worldColor,h.uWorldColorAlpha,0),l.update(),this._renderer.renderPipes.uniformBatch?u=this._renderer.renderPipes.uniformBatch.getUniformBindGroup(l,!1):(u=this._bindGroupPool.pop()||new Ds,this._activeBindGroups.push(u),u.setResource(l,0)),a.bindGroup=u,this._currentGlobalUniformData=a}push(t){this.bind(t),this._globalUniformDataStack[this._stackIndex++]=this._currentGlobalUniformData}pop(){this._currentGlobalUniformData=this._globalUniformDataStack[--this._stackIndex-1],this._renderer.type===lh.WEBGL&&this._currentGlobalUniformData.bindGroup.resources[0].update()}get bindGroup(){return this._currentGlobalUniformData.bindGroup}get uniformGroup(){return this._currentGlobalUniformData.bindGroup.resources[0]}_createUniforms(){return new vn({uProjectionMatrix:{value:new it,type:"mat3x3<f32>"},uWorldTransformMatrix:{value:new it,type:"mat3x3<f32>"},uWorldColorAlpha:{value:new Float32Array(4),type:"vec4<f32>"},uResolution:{value:[0,0],type:"vec2<f32>"}},{isStatic:!0})}destroy(){this._renderer=null}}sb.extension={type:[u.WebGLSystem,u.WebGPUSystem,u.CanvasSystem],name:"globalUniforms"};let ib=!1;const nb="8.1.0";function ob(t){if(!ib){if(Ne.get().getNavigator().userAgent.toLowerCase().indexOf("chrome")>-1){const e=[`%c  %c  %c  %c  %c PixiJS %c v8.1.0 (${t}) http://www.pixijs.com/\n\n`,"background: #E72264; padding:5px 0;","background: #6CA2EA; padding:5px 0;","background: #B5D33D; padding:5px 0;","background: #FED23F; padding:5px 0;","color: #FFFFFF; background: #E72264; padding:5px 0;","color: #E72264; background: #FFFFFF; padding:5px 0;"];globalThis.console.log(...e)}else globalThis.console&&globalThis.console.log(`PixiJS 8.1.0 - ${t} - http://www.pixijs.com/`);ib=!0}}class ab{constructor(t){this._renderer=t}init(t){if(t.hello){let t=this._renderer.name;this._renderer.type===lh.WEBGL&&(t+=` ${this._renderer.context.webGLVersion}`),ob(t)}}}ab.extension={type:[u.WebGLSystem,u.WebGPUSystem,u.CanvasSystem],name:"hello",priority:-2},ab.defaultOptions={hello:!1};var lb=Object.defineProperty,hb=Object.getOwnPropertySymbols,ub=Object.prototype.hasOwnProperty,cb=Object.prototype.propertyIsEnumerable,db=(t,e,r)=>e in t?lb(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r,pb=(t,e)=>{for(var r in e||(e={}))ub.call(e,r)&&db(t,r,e[r]);if(hb)for(var r of hb(e))cb.call(e,r)&&db(t,r,e[r]);return t};const fb=class t{constructor(t){this._renderer=t,this.count=0,this.checkCount=0}init(e){e=pb(pb({},t.defaultOptions),e),this.checkCountMax=e.textureGCCheckCountMax,this.maxIdle=e.textureGCAMaxIdle,this.active=e.textureGCActive}postrender(){this._renderer.renderingToScreen&&(this.count++,this.active&&(this.checkCount++,this.checkCount>this.checkCountMax&&(this.checkCount=0,this.run())))}run(){const t=this._renderer.texture.managedTextures;for(let e=0;e<t.length;e++){const r=t[e];r.autoGarbageCollect&&r.resource&&r._touched>-1&&this.count-r._touched>this.maxIdle&&(r._touched=-1,r.unload())}}destroy(){this._renderer=null}};fb.extension={type:[u.WebGLSystem,u.WebGPUSystem],name:"textureGC"},fb.defaultOptions={textureGCActive:!0,textureGCAMaxIdle:3600,textureGCCheckCountMax:600};let gb=fb;p.add(gb);var mb=Object.defineProperty,_b=Object.getOwnPropertySymbols,xb=Object.prototype.hasOwnProperty,yb=Object.prototype.propertyIsEnumerable,bb=(t,e,r)=>e in t?mb(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r,vb=(t,e)=>{for(var r in e||(e={}))xb.call(e,r)&&bb(t,r,e[r]);if(_b)for(var r of _b(e))yb.call(e,r)&&bb(t,r,e[r]);return t};const Tb=class t{get resolution(){return this.texture.source._resolution}set resolution(t){this.texture.source.resize(this.texture.source.width,this.texture.source.height,t)}init(e){(e=vb(vb({},t.defaultOptions),e)).view&&(e.canvas=e.view),this.screen=new vt(0,0,e.width,e.height),this.canvas=e.canvas||Ne.get().createCanvas(),this.antialias=!!e.antialias,this.texture=rx(this.canvas,e),this.renderTarget=new cx({colorTextures:[this.texture],depth:!!e.depth,isRoot:!0}),this.texture.source.transparent=e.backgroundAlpha<1,this.multiView=!!e.multiView,this.autoDensity&&(this.canvas.style.width=`${this.texture.width}px`,this.canvas.style.height=`${this.texture.height}px`),this.resolution=e.resolution}resize(t,e,r){this.texture.source.resize(t,e,r),this.screen.width=this.texture.frame.width,this.screen.height=this.texture.frame.height,this.autoDensity&&(this.canvas.style.width=`${t}px`,this.canvas.style.height=`${e}px`)}destroy(t=!1){("boolean"==typeof t?t:null!=t&&t.removeView)&&this.canvas.parentNode&&this.canvas.parentNode.removeChild(this.canvas)}};Tb.extension={type:[u.WebGLSystem,u.WebGPUSystem,u.CanvasSystem],name:"view",priority:0},Tb.defaultOptions={width:800,height:600,autoDensity:!1,antialias:!1};let Sb=Tb;const wb=[Gy,sb,ab,Sb,Sy,gb,rb,jy],Eb=[By,Gm,Ey,fy,Xm,Hm,zm,dy],Ab=[...wb,W_,S_,s_,Wm,hy,px,f_,Dx,Ix,E_,Lx,P_,w_],Mb=[...Eb],Pb=[Om,cy,uy],Rb=[],Ob=[],Cb=[];p.handleByNamedList(u.WebGLSystem,Rb),p.handleByNamedList(u.WebGLPipes,Ob),p.handleByNamedList(u.WebGLPipesAdaptor,Cb),p.add(...Ab,...Mb,...Pb);class Ib extends lc{constructor(){super({name:"webgl",type:lh.WEBGL,systems:Rb,renderPipes:Ob,renderPipeAdaptors:Cb})}}var Gb={__proto__:null,WebGLRenderer:Ib};class kb{constructor(t){this._hash=Object.create(null),this._renderer=t}contextChange(t){this._gpu=t}getBindGroup(t,e,r){return t._updateKey(),this._hash[t._key]||this._createBindGroup(t,e,r)}_createBindGroup(t,e,r){var s;const i=this._gpu.device,n=e.layout[r],o=[],a=this._renderer;for(const e in n){const r=null!=(s=t.resources[e])?s:t.resources[n[e]];let i;if("uniformGroup"===r._resourceType){const t=r;a.ubo.updateUniformGroup(t);const e=t.buffer;i={buffer:a.buffer.getGPUBuffer(e),offset:0,size:e.descriptor.size}}else if("buffer"===r._resourceType){const t=r;i={buffer:a.buffer.getGPUBuffer(t),offset:0,size:t.descriptor.size}}else if("bufferResource"===r._resourceType){const t=r;i={buffer:a.buffer.getGPUBuffer(t.buffer),offset:t.offset,size:t.size}}else if("textureSampler"===r._resourceType){const t=r;i=a.texture.getGpuSampler(t)}else if("textureSource"===r._resourceType){const t=r;i=a.texture.getGpuSource(t).createView({})}o.push({binding:n[e],resource:i})}const l=a.shader.getProgramData(e).bindGroups[r],h=i.createBindGroup({layout:l,entries:o});return this._hash[t._key]=h,h}destroy(){for(const t of Object.keys(this._hash))this._hash[t]=null;this._hash=null,this._renderer=null}}kb.extension={type:[u.WebGPUSystem],name:"bindGroup"};class Bb{constructor(){this._gpuBuffers=Object.create(null),this._managedBuffers=[]}contextChange(t){this._gpu=t}getGPUBuffer(t){return this._gpuBuffers[t.uid]||this.createGPUBuffer(t)}updateBuffer(t){const e=this._gpuBuffers[t.uid]||this.createGPUBuffer(t),r=t.data;return t._updateID&&r&&(t._updateID=0,this._gpu.device.queue.writeBuffer(e,0,r.buffer,0,(t._updateSize||r.byteLength)+3&-4)),e}destroyAll(){for(const t in this._gpuBuffers)this._gpuBuffers[t].destroy();this._gpuBuffers={}}createGPUBuffer(t){this._gpuBuffers[t.uid]||(t.on("update",this.updateBuffer,this),t.on("change",this.onBufferChange,this),t.on("destroy",this.onBufferDestroy,this));const e=this._gpu.device.createBuffer(t.descriptor);return t._updateID=0,t.data&&(Xs(t.data.buffer,e.getMappedRange()),e.unmap()),this._gpuBuffers[t.uid]=e,this._managedBuffers.push(t),e}onBufferChange(t){this._gpuBuffers[t.uid].destroy(),t._updateID=0,this._gpuBuffers[t.uid]=this.createGPUBuffer(t)}onBufferDestroy(t){this._managedBuffers.splice(this._managedBuffers.indexOf(t),1),this._destroyBuffer(t)}destroy(){this._managedBuffers.forEach((t=>this._destroyBuffer(t))),this._managedBuffers=null,this._gpuBuffers=null}_destroyBuffer(t){this._gpuBuffers[t.uid].destroy(),t.off("update",this.updateBuffer,this),t.off("change",this.onBufferChange,this),t.off("destroy",this.onBufferDestroy,this),this._gpuBuffers[t.uid]=null}}Bb.extension={type:[u.WebGPUSystem],name:"buffer"};class Db{constructor({minUniformOffsetAlignment:t}){this._minUniformOffsetAlignment=256,this.byteIndex=0,this._minUniformOffsetAlignment=t,this.data=new Float32Array(65535)}clear(){this.byteIndex=0}addEmptyGroup(t){if(t>this._minUniformOffsetAlignment/4)throw new Error("UniformBufferBatch: array is too large: "+4*t);const e=this.byteIndex;let r=e+4*t;if(r=Math.ceil(r/this._minUniformOffsetAlignment)*this._minUniformOffsetAlignment,r>4*this.data.length)throw new Error("UniformBufferBatch: ubo batch got too big");return this.byteIndex=r,e}addGroup(t){const e=this.addEmptyGroup(t.length);for(let r=0;r<t.length;r++)this.data[e/4+r]=t[r];return e}destroy(){this._buffer.destroy(),this._buffer=null,this.data=null}}class Fb{constructor(t){this._colorMaskCache=15,this._renderer=t}setMask(t){this._colorMaskCache!==t&&(this._colorMaskCache=t,this._renderer.pipeline.setColorMask(t))}destroy(){this._renderer=null,this._colorMaskCache=null}}Fb.extension={type:[u.WebGPUSystem],name:"colorMask"};class Nb{constructor(t){this._renderer=t}async init(t){return this._initPromise||(this._initPromise=this._createDeviceAndAdaptor(t).then((t=>{this.gpu=t,this._renderer.runners.contextChange.emit(this.gpu)}))),this._initPromise}contextChange(t){this._renderer.gpu=t}async _createDeviceAndAdaptor(t){const e=await navigator.gpu.requestAdapter({powerPreference:t.powerPreference,forceFallbackAdapter:t.forceFallbackAdapter}),r=["texture-compression-bc","texture-compression-astc","texture-compression-etc2"].filter((t=>e.features.has(t))),s=await e.requestDevice({requiredFeatures:r});return{adapter:e,device:s}}destroy(){this.gpu=null,this._renderer=null}}Nb.extension={type:[u.WebGPUSystem],name:"device"},Nb.defaultOptions={powerPreference:void 0,forceFallbackAdapter:!1};var Ub=Object.defineProperty,Lb=Object.getOwnPropertySymbols,Xb=Object.prototype.hasOwnProperty,zb=Object.prototype.propertyIsEnumerable,Hb=(t,e,r)=>e in t?Ub(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r,jb=(t,e)=>{for(var r in e||(e={}))Xb.call(e,r)&&Hb(t,r,e[r]);if(Lb)for(var r of Lb(e))zb.call(e,r)&&Hb(t,r,e[r]);return t};class Vb{constructor(t){this._boundBindGroup=Object.create(null),this._boundVertexBuffer=Object.create(null),this._renderer=t}renderStart(){this.commandFinished=new Promise((t=>{this._resolveCommandFinished=t})),this.commandEncoder=this._renderer.gpu.device.createCommandEncoder()}beginRenderPass(t){this.endRenderPass(),this._clearCache(),this.renderPassEncoder=this.commandEncoder.beginRenderPass(t.descriptor)}endRenderPass(){this.renderPassEncoder&&this.renderPassEncoder.end(),this.renderPassEncoder=null}setViewport(t){this.renderPassEncoder.setViewport(t.x,t.y,t.width,t.height,0,1)}setPipelineFromGeometryProgramAndState(t,e,r,s){const i=this._renderer.pipeline.getPipeline(t,e,r,s);this.setPipeline(i)}setPipeline(t){this._boundPipeline!==t&&(this._boundPipeline=t,this.renderPassEncoder.setPipeline(t))}_setVertexBuffer(t,e){this._boundVertexBuffer[t]!==e&&(this._boundVertexBuffer[t]=e,this.renderPassEncoder.setVertexBuffer(t,this._renderer.buffer.updateBuffer(e)))}_setIndexBuffer(t){if(this._boundIndexBuffer===t)return;this._boundIndexBuffer=t;const e=2===t.data.BYTES_PER_ELEMENT?"uint16":"uint32";this.renderPassEncoder.setIndexBuffer(this._renderer.buffer.updateBuffer(t),e)}resetBindGroup(t){this._boundBindGroup[t]=null}setBindGroup(t,e,r){if(this._boundBindGroup[t]===e)return;this._boundBindGroup[t]=e,e._touch(this._renderer.textureGC.count);const s=this._renderer.bindGroup.getBindGroup(e,r,t);this.renderPassEncoder.setBindGroup(t,s)}setGeometry(t){for(const e in t.attributes){const r=t.attributes[e];this._setVertexBuffer(r.location,r.buffer)}t.indexBuffer&&this._setIndexBuffer(t.indexBuffer)}_setShaderBindGroups(t,e){for(const r in t.groups){const s=t.groups[r];e||this._syncBindGroup(s),this.setBindGroup(r,s,t.gpuProgram)}}_syncBindGroup(t){for(const e in t.resources){const r=t.resources[e];r.isUniformGroup&&this._renderer.ubo.updateUniformGroup(r)}}draw(t){const{geometry:e,shader:r,state:s,topology:i,size:n,start:o,instanceCount:a,skipSync:l}=t;this.setPipelineFromGeometryProgramAndState(e,r.gpuProgram,s,i),this.setGeometry(e),this._setShaderBindGroups(r,l),e.indexBuffer?this.renderPassEncoder.drawIndexed(n||e.indexBuffer.data.length,a||e.instanceCount,o||0):this.renderPassEncoder.draw(n||e.getSize(),a||e.instanceCount,o||0)}finishRenderPass(){this.renderPassEncoder&&(this.renderPassEncoder.end(),this.renderPassEncoder=null)}postrender(){this.finishRenderPass(),this._gpu.device.queue.submit([this.commandEncoder.finish()]),this._resolveCommandFinished(),this.commandEncoder=null}restoreRenderPass(){const t=this._renderer.renderTarget.adaptor.getDescriptor(this._renderer.renderTarget.renderTarget,!1,[0,0,0,1]);this.renderPassEncoder=this.commandEncoder.beginRenderPass(t);const e=this._boundPipeline,r=jb({},this._boundVertexBuffer),s=this._boundIndexBuffer,i=jb({},this._boundBindGroup);this._clearCache();const n=this._renderer.renderTarget.viewport;this.renderPassEncoder.setViewport(n.x,n.y,n.width,n.height,0,1),this.setPipeline(e);for(const t in r)this._setVertexBuffer(t,r[t]);for(const t in i)this.setBindGroup(t,i[t],null);this._setIndexBuffer(s)}_clearCache(){for(let t=0;t<16;t++)this._boundBindGroup[t]=null,this._boundVertexBuffer[t]=null;this._boundIndexBuffer=null,this._boundPipeline=null}destroy(){this._renderer=null,this._gpu=null,this._boundBindGroup=null,this._boundVertexBuffer=null,this._boundIndexBuffer=null,this._boundPipeline=null}contextChange(t){this._gpu=t}}Vb.extension={type:[u.WebGPUSystem],name:"encoder",priority:1};class Wb{constructor(t){this._renderTargetStencilState=Object.create(null),this._renderer=t,t.renderTarget.onRenderTargetChange.add(this)}onRenderTargetChange(t){let e=this._renderTargetStencilState[t.uid];e||(e=this._renderTargetStencilState[t.uid]={stencilMode:Hs.DISABLED,stencilReference:0}),this._activeRenderTarget=t,this.setStencilMode(e.stencilMode,e.stencilReference)}setStencilMode(t,e){const r=this._renderTargetStencilState[this._activeRenderTarget.uid];r.stencilMode=t,r.stencilReference=e;const s=this._renderer;s.pipeline.setStencilMode(t),s.encoder.renderPassEncoder.setStencilReference(e)}destroy(){this._renderer.renderTarget.onRenderTargetChange.remove(this),this._renderer=null,this._activeRenderTarget=null,this._renderTargetStencilState=null}}Wb.extension={type:[u.WebGPUSystem],name:"stencil"};const $b={i32:{align:4,size:4},u32:{align:4,size:4},f32:{align:4,size:4},f16:{align:2,size:2},"vec2<i32>":{align:8,size:8},"vec2<u32>":{align:8,size:8},"vec2<f32>":{align:8,size:8},"vec2<f16>":{align:4,size:4},"vec3<i32>":{align:16,size:12},"vec3<u32>":{align:16,size:12},"vec3<f32>":{align:16,size:12},"vec3<f16>":{align:8,size:6},"vec4<i32>":{align:16,size:16},"vec4<u32>":{align:16,size:16},"vec4<f32>":{align:16,size:16},"vec4<f16>":{align:8,size:8},"mat2x2<f32>":{align:8,size:16},"mat2x2<f16>":{align:4,size:8},"mat3x2<f32>":{align:8,size:24},"mat3x2<f16>":{align:4,size:12},"mat4x2<f32>":{align:8,size:32},"mat4x2<f16>":{align:4,size:16},"mat2x3<f32>":{align:16,size:32},"mat2x3<f16>":{align:8,size:16},"mat3x3<f32>":{align:16,size:48},"mat3x3<f16>":{align:8,size:24},"mat4x3<f32>":{align:16,size:64},"mat4x3<f16>":{align:8,size:32},"mat2x4<f32>":{align:16,size:32},"mat2x4<f16>":{align:8,size:16},"mat3x4<f32>":{align:16,size:48},"mat3x4<f16>":{align:8,size:24},"mat4x4<f32>":{align:16,size:64},"mat4x4<f16>":{align:8,size:32}};function Yb(t){const e=t.map((t=>({data:t,offset:0,size:0})));let r=0;for(let t=0;t<e.length;t++){const s=e[t];let i=$b[s.data.type].size;const n=$b[s.data.type].align;if(!$b[s.data.type])throw new Error(`[Pixi.js] WebGPU UniformBuffer: Unknown type ${s.data.type}`);s.data.size>1&&(i=Math.max(i,n)*s.data.size),r=Math.ceil(r/n)*n,s.size=i,s.offset=r,r+=i}return r=16*Math.ceil(r/16),{uboElements:e,size:r}}function qb(t,e){const{size:r,align:s}=$b[t.data.type],i=(s-r)/4;return`\n         v = uv.${t.data.name};\n         ${0!==e?`offset += ${e};`:""}\n\n         arrayOffset = offset;\n\n         t = 0;\n\n         for(var i=0; i < ${t.data.size*(r/4)}; i++)\n         {\n             for(var j = 0; j < ${r/4}; j++)\n             {\n                 data[arrayOffset++] = v[t++];\n             }\n             ${0!==i?`arrayOffset += ${i};`:""}\n         }\n     `}function Kb(t){return G_(t,"uboWgsl",qb,H_)}class Zb extends R_{constructor(){super({createUboElements:Yb,generateUboSync:Kb})}}Zb.extension={type:[u.WebGPUSystem],name:"ubo"};const Qb=128;class Jb{constructor(t){this._bindGroupHash=Object.create(null),this._buffers=[],this._bindGroups=[],this._bufferResources=[],this._renderer=t,this._batchBuffer=new Db({minUniformOffsetAlignment:Qb});for(let t=0;t<2;t++){let e=Ms.UNIFORM|Ms.COPY_DST;0===t&&(e|=Ms.COPY_SRC),this._buffers.push(new Ps({data:this._batchBuffer.data,usage:e}))}}renderEnd(){this._uploadBindGroups(),this._resetBindGroups()}_resetBindGroups(){for(const t in this._bindGroupHash)this._bindGroupHash[t]=null;this._batchBuffer.clear()}getUniformBindGroup(t,e){if(!e&&this._bindGroupHash[t.uid])return this._bindGroupHash[t.uid];this._renderer.ubo.ensureUniformGroup(t);const r=t.buffer.data,s=this._batchBuffer.addEmptyGroup(r.length);return this._renderer.ubo.syncUniformGroup(t,this._batchBuffer.data,s/4),this._bindGroupHash[t.uid]=this._getBindGroup(s/Qb),this._bindGroupHash[t.uid]}getUboResource(t){this._renderer.ubo.updateUniformGroup(t);const e=t.buffer.data,r=this._batchBuffer.addGroup(e);return this._getBufferResource(r/Qb)}getArrayBindGroup(t){const e=this._batchBuffer.addGroup(t);return this._getBindGroup(e/Qb)}getArrayBufferResource(t){const e=this._batchBuffer.addGroup(t)/Qb;return this._getBufferResource(e)}_getBufferResource(t){if(!this._bufferResources[t]){const e=this._buffers[t%2];this._bufferResources[t]=new fx({buffer:e,offset:256*(t/2|0),size:Qb})}return this._bufferResources[t]}_getBindGroup(t){if(!this._bindGroups[t]){const e=new Ds({0:this._getBufferResource(t)});this._bindGroups[t]=e}return this._bindGroups[t]}_uploadBindGroups(){const t=this._renderer.buffer,e=this._buffers[0];e.update(this._batchBuffer.byteIndex),t.updateBuffer(e);const r=this._renderer.gpu.device.createCommandEncoder();for(let s=1;s<this._buffers.length;s++){const i=this._buffers[s];r.copyBufferToBuffer(t.getGPUBuffer(e),Qb,t.getGPUBuffer(i),0,this._batchBuffer.byteIndex)}this._renderer.gpu.device.queue.submit([r.finish()])}destroy(){for(let t=0;t<this._bindGroups.length;t++)this._bindGroups[t].destroy();this._bindGroups=null,this._bindGroupHash=null;for(let t=0;t<this._buffers.length;t++)this._buffers[t].destroy();this._buffers=null;for(let t=0;t<this._bufferResources.length;t++)this._bufferResources[t].destroy();this._bufferResources=null,this._batchBuffer.destroy(),this._bindGroupHash=null,this._renderer=null}}Jb.extension={type:[u.WebGPUPipes],name:"uniformBatch"};var tv=Object.defineProperty,ev=Object.defineProperties,rv=Object.getOwnPropertyDescriptors,sv=Object.getOwnPropertySymbols,iv=Object.prototype.hasOwnProperty,nv=Object.prototype.propertyIsEnumerable,ov=(t,e,r)=>e in t?tv(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r;const av={"point-list":0,"line-list":1,"line-strip":2,"triangle-list":3,"triangle-strip":4};class lv{constructor(t){this._moduleCache=Object.create(null),this._bufferLayoutsCache=Object.create(null),this._pipeCache=Object.create(null),this._pipeStateCaches=Object.create(null),this._colorMask=15,this._multisampleCount=1,this._renderer=t}contextChange(t){this._gpu=t,this.setStencilMode(Hs.DISABLED),this._updatePipeHash()}setMultisampleCount(t){this._multisampleCount!==t&&(this._multisampleCount=t,this._updatePipeHash())}setRenderTarget(t){this._multisampleCount=t.msaaSamples,this._depthStencilAttachment=t.descriptor.depthStencilAttachment?1:0,this._updatePipeHash()}setColorMask(t){this._colorMask!==t&&(this._colorMask=t,this._updatePipeHash())}setStencilMode(t){this._stencilMode!==t&&(this._stencilMode=t,this._stencilState=M_[t],this._updatePipeHash())}setPipeline(t,e,r,s){const i=this.getPipeline(t,e,r);s.setPipeline(i)}getPipeline(t,e,r,s){t._layoutKey||(o_(t,e.attributeData),this._generateBufferKey(t)),s=s||t.topology;const i=function(t,e,r,s,i){return t<<24|e<<16|r<<10|s<<5|i}(t._layoutKey,e._layoutKey,r.data,r._blendModeId,av[s]);return this._pipeCache[i]||(this._pipeCache[i]=this._createPipeline(t,e,r,s)),this._pipeCache[i]}_createPipeline(t,e,r,s){const i=this._gpu.device,n=this._createVertexBufferLayouts(t),o=this._renderer.state.getColorTargets(r);o[0].writeMask=this._stencilMode===Hs.RENDERING_MASK_ADD?0:this._colorMask;const a=this._renderer.shader.getProgramData(e).pipeline,l={vertex:{module:this._getModule(e.vertex.source),entryPoint:e.vertex.entryPoint,buffers:n},fragment:{module:this._getModule(e.fragment.source),entryPoint:e.fragment.entryPoint,targets:o},primitive:{topology:s,cullMode:r.cullMode},layout:a,multisample:{count:this._multisampleCount},label:"PIXI Pipeline"};return this._depthStencilAttachment&&(l.depthStencil=((t,e)=>ev(t,rv(e)))(((t,e)=>{for(var r in e||(e={}))iv.call(e,r)&&ov(t,r,e[r]);if(sv)for(var r of sv(e))nv.call(e,r)&&ov(t,r,e[r]);return t})({},this._stencilState),{format:"depth24plus-stencil8",depthWriteEnabled:r.depthTest,depthCompare:r.depthTest?"less":"always"})),i.createRenderPipeline(l)}_getModule(t){return this._moduleCache[t]||this._createModule(t)}_createModule(t){const e=this._gpu.device;return this._moduleCache[t]=e.createShaderModule({code:t}),this._moduleCache[t]}_generateBufferKey(t){const e=[];let r=0;const s=Object.keys(t.attributes).sort();for(let i=0;i<s.length;i++){const n=t.attributes[s[i]];e[r++]=n.location,e[r++]=n.offset,e[r++]=n.format,e[r++]=n.stride}const i=e.join("");return t._layoutKey=dn(i,"geometry"),t._layoutKey}_createVertexBufferLayouts(t){if(this._bufferLayoutsCache[t._layoutKey])return this._bufferLayoutsCache[t._layoutKey];const e=[];return t.buffers.forEach((r=>{const s={arrayStride:0,stepMode:"vertex",attributes:[]},i=s.attributes;for(const e in t.attributes){const n=t.attributes[e];n.buffer===r&&(s.arrayStride=n.stride,s.stepMode=n.instance?"instance":"vertex",i.push({shaderLocation:n.location,offset:n.offset,format:n.format}))}i.length&&e.push(s)})),this._bufferLayoutsCache[t._layoutKey]=e,e}_updatePipeHash(){const t=function(t,e,r,s){return r<<6|t<<3|s<<1|e}(this._stencilMode,this._multisampleCount,this._colorMask,this._depthStencilAttachment);this._pipeStateCaches[t]||(this._pipeStateCaches[t]=Object.create(null)),this._pipeCache=this._pipeStateCaches[t]}destroy(){this._renderer=null,this._bufferLayoutsCache=null}}lv.extension={type:[u.WebGPUSystem],name:"pipeline"};class hv{constructor(){this.contexts=[],this.msaaTextures=[],this.msaaSamples=1}}class uv{init(t,e){this._renderer=t,this._renderTargetSystem=e}copyToTexture(t,e,r,s,i){const n=this._renderer,o=this._getGpuColorTexture(t),a=n.texture.getGpuSource(e.source);return n.encoder.commandEncoder.copyTextureToTexture({texture:o,origin:r},{texture:a,origin:i},s),e}startRenderPass(t,e=!0,r,s){const i=this._renderTargetSystem.getGpuRenderTarget(t),n=this.getDescriptor(t,e,r);i.descriptor=n,this._renderer.pipeline.setRenderTarget(i),this._renderer.encoder.beginRenderPass(i),this._renderer.encoder.setViewport(s)}finishRenderPass(){this._renderer.encoder.endRenderPass()}_getGpuColorTexture(t){const e=this._renderTargetSystem.getGpuRenderTarget(t);return e.contexts[0]?e.contexts[0].getCurrentTexture():this._renderer.texture.getGpuSource(t.colorTextures[0].source)}getDescriptor(t,e,r){"boolean"==typeof e&&(e=e?Ku.ALL:Ku.NONE);const s=this._renderTargetSystem,i=s.getGpuRenderTarget(t),n=t.colorTextures.map(((t,n)=>{const o=i.contexts[n];let a,l;a=o?o.getCurrentTexture().createView():this._renderer.texture.getGpuSource(t).createView({mipLevelCount:1}),i.msaaTextures[n]&&(l=a,a=this._renderer.texture.getTextureView(i.msaaTextures[n]));const h=e&Ku.COLOR?"clear":"load";return null!=r||(r=s.defaultClearColor),{view:a,resolveTarget:l,clearValue:r,storeOp:"store",loadOp:h}}));let o;if((t.stencil||t.depth)&&!t.depthStencilTexture&&(t.ensureDepthStencilTexture(),t.depthStencilTexture.source.sampleCount=i.msaa?4:1),t.depthStencilTexture){const r=e&Ku.STENCIL?"clear":"load",s=e&Ku.DEPTH?"clear":"load";o={view:this._renderer.texture.getGpuSource(t.depthStencilTexture.source).createView(),stencilStoreOp:"store",stencilLoadOp:r,depthClearValue:1,depthLoadOp:s,depthStoreOp:"store"}}return{colorAttachments:n,depthStencilAttachment:o}}clear(t,e=!0,r,s){if(!e)return;const{gpu:i,encoder:n}=this._renderer,o=i.device;if(null===n.commandEncoder){const i=o.createCommandEncoder(),n=this.getDescriptor(t,e,r),a=i.beginRenderPass(n);a.setViewport(s.x,s.y,s.width,s.height,0,1),a.end();const l=i.finish();o.queue.submit([l])}else this.startRenderPass(t,e,r,s)}initGpuRenderTarget(t){t.isRoot=!0;const e=new hv;return t.colorTextures.forEach(((t,r)=>{if(ls.test(t.resource)){const s=t.resource.getContext("webgpu"),i=t.transparent?"premultiplied":"opaque";try{s.configure({device:this._renderer.gpu.device,usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST|GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.COPY_SRC,format:"bgra8unorm",alphaMode:i})}catch(t){console.error(t)}e.contexts[r]=s}if(e.msaa=t.source.antialias,t.source.antialias){const t=new Cr({width:0,height:0,sampleCount:4});e.msaaTextures[r]=t}})),e.msaa&&(e.msaaSamples=4,t.depthStencilTexture&&(t.depthStencilTexture.source.sampleCount=4)),e}ensureDepthStencilTexture(t){const e=this._renderTargetSystem.getGpuRenderTarget(t);t.depthStencilTexture&&e.msaa&&(t.depthStencilTexture.source.sampleCount=4)}resizeGpuRenderTarget(t){const e=this._renderTargetSystem.getGpuRenderTarget(t);e.width=t.width,e.height=t.height,e.msaa&&t.colorTextures.forEach(((t,r)=>{const s=e.msaaTextures[r];null==s||s.resize(t.source.width,t.source.height,t.source._resolution)}))}}class cv extends dx{constructor(t){super(t),this.adaptor=new uv,this.adaptor.init(t,this)}}cv.extension={type:[u.WebGPUSystem],name:"renderTarget"};class dv{constructor(){this._gpuProgramData=Object.create(null)}contextChange(t){this._gpu=t}getProgramData(t){return this._gpuProgramData[t._layoutKey]||this._createGPUProgramData(t)}_createGPUProgramData(t){const e=this._gpu.device,r=t.gpuLayout.map((t=>e.createBindGroupLayout({entries:t}))),s={bindGroupLayouts:r};return this._gpuProgramData[t._layoutKey]={bindGroups:r,pipeline:e.createPipelineLayout(s)},this._gpuProgramData[t._layoutKey]}destroy(){this._gpu=null,this._gpuProgramData=null}}dv.extension={type:[u.WebGPUSystem],name:"shader"};const pv={normal:{alpha:{srcFactor:"one",dstFactor:"one-minus-src-alpha",operation:"add"},color:{srcFactor:"one",dstFactor:"one-minus-src-alpha",operation:"add"}},add:{alpha:{srcFactor:"src-alpha",dstFactor:"one-minus-src-alpha",operation:"add"},color:{srcFactor:"one",dstFactor:"one",operation:"add"}},multiply:{alpha:{srcFactor:"one",dstFactor:"one-minus-src-alpha",operation:"add"},color:{srcFactor:"dst",dstFactor:"one-minus-src-alpha",operation:"add"}},screen:{alpha:{srcFactor:"one",dstFactor:"one-minus-src-alpha",operation:"add"},color:{srcFactor:"one",dstFactor:"one-minus-src",operation:"add"}},overlay:{alpha:{srcFactor:"one",dstFactor:"one-minus-src-alpha",operation:"add"},color:{srcFactor:"one",dstFactor:"one-minus-src",operation:"add"}},none:{alpha:{srcFactor:"one",dstFactor:"one-minus-src-alpha",operation:"add"},color:{srcFactor:"zero",dstFactor:"zero",operation:"add"}},"normal-npm":{alpha:{srcFactor:"one",dstFactor:"one-minus-src-alpha",operation:"add"},color:{srcFactor:"src-alpha",dstFactor:"one-minus-src-alpha",operation:"add"}},"add-npm":{alpha:{srcFactor:"one",dstFactor:"one",operation:"add"},color:{srcFactor:"src-alpha",dstFactor:"one",operation:"add"}},"screen-npm":{alpha:{srcFactor:"one",dstFactor:"one-minus-src-alpha",operation:"add"},color:{srcFactor:"src-alpha",dstFactor:"one-minus-src",operation:"add"}},erase:{alpha:{srcFactor:"zero",dstFactor:"one-minus-src-alpha",operation:"add"},color:{srcFactor:"zero",dstFactor:"one-minus-src",operation:"add"}}};class fv{constructor(){this.defaultState=new an,this.defaultState.blend=!0}contextChange(t){this.gpu=t}getColorTargets(t){return[{format:"bgra8unorm",writeMask:0,blend:pv[t.blendMode]||pv.normal}]}destroy(){this.gpu=null}}fv.extension={type:[u.WebGPUSystem],name:"state"};const gv={type:"image",upload(t,e,r){const s=t.resource,i=(0|t.pixelWidth)*(0|t.pixelHeight),n=s.byteLength/i;r.device.queue.writeTexture({texture:e},s,{offset:0,rowsPerImage:t.pixelHeight,bytesPerRow:t.pixelHeight*n},{width:t.pixelWidth,height:t.pixelHeight,depthOrArrayLayers:1})}},mv={"bc1-rgba-unorm":{blockBytes:8,blockWidth:4,blockHeight:4},"bc2-rgba-unorm":{blockBytes:16,blockWidth:4,blockHeight:4},"bc3-rgba-unorm":{blockBytes:16,blockWidth:4,blockHeight:4},"bc7-rgba-unorm":{blockBytes:16,blockWidth:4,blockHeight:4},"etc1-rgb-unorm":{blockBytes:8,blockWidth:4,blockHeight:4},"etc2-rgba8unorm":{blockBytes:16,blockWidth:4,blockHeight:4},"astc-4x4-unorm":{blockBytes:16,blockWidth:4,blockHeight:4}},_v={blockBytes:4,blockWidth:1,blockHeight:1},xv={type:"compressed",upload(t,e,r){let s=t.pixelWidth,i=t.pixelHeight;const n=mv[t.format]||_v;for(let o=0;o<t.resource.length;o++){const a=t.resource[o],l=Math.ceil(s/n.blockWidth)*n.blockBytes;r.device.queue.writeTexture({texture:e,mipLevel:o},a,{offset:0,bytesPerRow:l},{width:Math.ceil(s/n.blockWidth)*n.blockWidth,height:Math.ceil(i/n.blockHeight)*n.blockHeight,depthOrArrayLayers:1}),s=Math.max(s>>1,1),i=Math.max(i>>1,1)}}},yv={type:"image",upload(t,e,r){const s=t.resource;if(!s)return;const i=Math.min(e.width,t.resourceWidth||t.pixelWidth),n=Math.min(e.height,t.resourceHeight||t.pixelHeight),o="premultiply-alpha-on-upload"===t.alphaMode;r.device.queue.copyExternalImageToTexture({source:s},{texture:e,premultipliedAlpha:o},{width:i,height:n})}},bv={type:"video",upload(t,e,r){yv.upload(t,e,r)}};class vv{constructor(t){this.device=t,this.sampler=t.createSampler({minFilter:"linear"}),this.pipelines={}}_getMipmapPipeline(t){let e=this.pipelines[t];return e||(this.mipmapShaderModule||(this.mipmapShaderModule=this.device.createShaderModule({code:"\n                        var<private> pos : array<vec2<f32>, 3> = array<vec2<f32>, 3>(\n                        vec2<f32>(-1.0, -1.0), vec2<f32>(-1.0, 3.0), vec2<f32>(3.0, -1.0));\n\n                        struct VertexOutput {\n                        @builtin(position) position : vec4<f32>,\n                        @location(0) texCoord : vec2<f32>,\n                        };\n\n                        @vertex\n                        fn vertexMain(@builtin(vertex_index) vertexIndex : u32) -> VertexOutput {\n                        var output : VertexOutput;\n                        output.texCoord = pos[vertexIndex] * vec2<f32>(0.5, -0.5) + vec2<f32>(0.5);\n                        output.position = vec4<f32>(pos[vertexIndex], 0.0, 1.0);\n                        return output;\n                        }\n\n                        @group(0) @binding(0) var imgSampler : sampler;\n                        @group(0) @binding(1) var img : texture_2d<f32>;\n\n                        @fragment\n                        fn fragmentMain(@location(0) texCoord : vec2<f32>) -> @location(0) vec4<f32> {\n                        return textureSample(img, imgSampler, texCoord);\n                        }\n                    "})),e=this.device.createRenderPipeline({layout:"auto",vertex:{module:this.mipmapShaderModule,entryPoint:"vertexMain"},fragment:{module:this.mipmapShaderModule,entryPoint:"fragmentMain",targets:[{format:t}]}}),this.pipelines[t]=e),e}generateMipmap(t){const e=this._getMipmapPipeline(t.format);if("3d"===t.dimension||"1d"===t.dimension)throw new Error("Generating mipmaps for non-2d textures is currently unsupported!");let r=t;const s=t.depthOrArrayLayers||1,i=t.usage&GPUTextureUsage.RENDER_ATTACHMENT;if(!i){const e={size:{width:Math.ceil(t.width/2),height:Math.ceil(t.height/2),depthOrArrayLayers:s},format:t.format,usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_SRC|GPUTextureUsage.RENDER_ATTACHMENT,mipLevelCount:t.mipLevelCount-1};r=this.device.createTexture(e)}const n=this.device.createCommandEncoder({}),o=e.getBindGroupLayout(0);for(let a=0;a<s;++a){let s=t.createView({baseMipLevel:0,mipLevelCount:1,dimension:"2d",baseArrayLayer:a,arrayLayerCount:1}),l=i?1:0;for(let i=1;i<t.mipLevelCount;++i){const t=r.createView({baseMipLevel:l++,mipLevelCount:1,dimension:"2d",baseArrayLayer:a,arrayLayerCount:1}),i=n.beginRenderPass({colorAttachments:[{view:t,storeOp:"store",loadOp:"clear",clearValue:{r:0,g:0,b:0,a:0}}]}),h=this.device.createBindGroup({layout:o,entries:[{binding:0,resource:this.sampler},{binding:1,resource:s}]});i.setPipeline(e),i.setBindGroup(0,h),i.draw(3,1,0,0),i.end(),s=t}}if(!i){const e={width:Math.ceil(t.width/2),height:Math.ceil(t.height/2),depthOrArrayLayers:s};for(let s=1;s<t.mipLevelCount;++s)n.copyTextureToTexture({texture:r,mipLevel:s-1},{texture:t,mipLevel:s},e),e.width=Math.ceil(e.width/2),e.height=Math.ceil(e.height/2)}return this.device.queue.submit([n.finish()]),i||r.destroy(),t}}class Tv{constructor(t){this.managedTextures=[],this._gpuSources=Object.create(null),this._gpuSamplers=Object.create(null),this._bindGroupHash=Object.create(null),this._textureViewHash=Object.create(null),this._uploads={image:yv,buffer:gv,video:bv,compressed:xv},this._renderer=t}contextChange(t){this._gpu=t}initSource(t){if(t.autoGenerateMipmaps){const e=Math.max(t.pixelWidth,t.pixelHeight);t.mipLevelCount=Math.floor(Math.log2(e))+1}let e=GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST;"compressed"!==t.uploadMethodId&&(e|=GPUTextureUsage.RENDER_ATTACHMENT,e|=GPUTextureUsage.COPY_SRC);const r=mv[t.format]||{blockBytes:4,blockWidth:1,blockHeight:1},s=Math.ceil(t.pixelWidth/r.blockWidth)*r.blockWidth,i=Math.ceil(t.pixelHeight/r.blockHeight)*r.blockHeight,n={label:t.label,size:{width:s,height:i},format:t.format,sampleCount:t.sampleCount,mipLevelCount:t.mipLevelCount,dimension:t.dimension,usage:e},o=this._gpu.device.createTexture(n);return this._gpuSources[t.uid]=o,this.managedTextures.includes(t)||(t.on("update",this.onSourceUpdate,this),t.on("resize",this.onSourceResize,this),t.on("destroy",this.onSourceDestroy,this),t.on("unload",this.onSourceUnload,this),t.on("updateMipmaps",this.onUpdateMipmaps,this),this.managedTextures.push(t)),this.onSourceUpdate(t),o}onSourceUpdate(t){const e=this.getGpuSource(t);e&&(this._uploads[t.uploadMethodId]&&this._uploads[t.uploadMethodId].upload(t,e,this._gpu),t.autoGenerateMipmaps&&t.mipLevelCount>1&&this.onUpdateMipmaps(t))}onSourceUnload(t){const e=this._gpuSources[t.uid];e&&(this._gpuSources[t.uid]=null,e.destroy())}onUpdateMipmaps(t){this._mipmapGenerator||(this._mipmapGenerator=new vv(this._gpu.device));const e=this.getGpuSource(t);this._mipmapGenerator.generateMipmap(e)}onSourceDestroy(t){t.off("update",this.onSourceUpdate,this),t.off("unload",this.onSourceUnload,this),t.off("destroy",this.onSourceDestroy,this),t.off("resize",this.onSourceResize,this),t.off("updateMipmaps",this.onUpdateMipmaps,this),this.managedTextures.splice(this.managedTextures.indexOf(t),1),this.onSourceUnload(t)}onSourceResize(t){const e=this._gpuSources[t.uid];e?(e.width!==t.pixelWidth||e.height!==t.pixelHeight)&&(this._textureViewHash[t.uid]=null,this._bindGroupHash[t.uid]=null,this.onSourceUnload(t),this.initSource(t)):this.initSource(t)}_initSampler(t){return this._gpuSamplers[t._resourceId]=this._gpu.device.createSampler(t),this._gpuSamplers[t._resourceId]}getGpuSampler(t){return this._gpuSamplers[t._resourceId]||this._initSampler(t)}getGpuSource(t){return this._gpuSources[t.uid]||this.initSource(t)}getTextureBindGroup(t){var e;return null!=(e=this._bindGroupHash[t.uid])?e:this._createTextureBindGroup(t)}_createTextureBindGroup(t){const e=t.source,r=e.uid;return this._bindGroupHash[r]=new Ds({0:e,1:e.style}),this._bindGroupHash[r]}getTextureView(t){var e;const r=t.source;return null!=(e=this._textureViewHash[r.uid])?e:this._createTextureView(r)}_createTextureView(t){return this._textureViewHash[t.uid]=this.getGpuSource(t).createView(),this._textureViewHash[t.uid]}generateCanvas(t){const e=this._renderer,r=e.gpu.device.createCommandEncoder(),s=Ne.get().createCanvas();s.width=t.source.pixelWidth,s.height=t.source.pixelHeight;const i=s.getContext("webgpu");return i.configure({device:e.gpu.device,usage:GPUTextureUsage.COPY_DST|GPUTextureUsage.COPY_SRC,format:navigator.gpu.getPreferredCanvasFormat(),alphaMode:"premultiplied"}),r.copyTextureToTexture({texture:e.texture.getGpuSource(t.source),origin:{x:0,y:0}},{texture:i.getCurrentTexture()},{width:s.width,height:s.height}),e.gpu.device.queue.submit([r.finish()]),s}getPixels(t){const e=this.generateCanvas(t),r=Mn.getOptimalCanvasAndContext(e.width,e.height),s=r.context;s.drawImage(e,0,0);const{width:i,height:n}=e,o=s.getImageData(0,0,i,n),a=new Uint8ClampedArray(o.data.buffer);return Mn.returnCanvasAndContext(r),{pixels:a,width:i,height:n}}destroy(){this.managedTextures.slice().forEach((t=>this.onSourceDestroy(t))),this.managedTextures=null;for(const t of Object.keys(this._bindGroupHash)){const e=Number(t),r=this._bindGroupHash[e];null==r||r.destroy(),this._bindGroupHash[e]=null}this._gpu=null,this._mipmapGenerator=null,this._gpuSources=null,this._bindGroupHash=null,this._textureViewHash=null,this._gpuSamplers=null}}Tv.extension={type:[u.WebGPUSystem],name:"texture"};class Sv{init(){const t=new vn({uTransformMatrix:{value:new it,type:"mat3x3<f32>"},uColor:{value:new Float32Array([1,1,1,1]),type:"vec4<f32>"},uRound:{value:0,type:"f32"}}),e=$l({name:"graphics",bits:[ql,th(Fs),lu,ih]});this.shader=new fh({gpuProgram:e,resources:{localUniforms:t}})}execute(t,e){const r=e.context,s=r.customShader||this.shader,i=t.renderer,n=i.graphicsContext,{geometry:o,instructions:a}=n.getContextRenderData(r),l=i.encoder;l.setPipelineFromGeometryProgramAndState(o,s.gpuProgram,t.state),l.setGeometry(o);const h=i.globalUniforms.bindGroup;l.setBindGroup(0,h,s.gpuProgram);const u=i.renderPipes.uniformBatch.getUniformBindGroup(s.resources.localUniforms,!0);l.setBindGroup(2,u,s.gpuProgram);const c=a.instructions;for(let t=0;t<a.instructionSize;t++){const e=c[t];if(s.groups[1]=e.bindGroup,!e.gpuBindGroup){const t=e.textures;e.bindGroup=Us(t.textures,t.count),e.gpuBindGroup=i.bindGroup.getBindGroup(e.bindGroup,s.gpuProgram,1)}l.setBindGroup(1,e.bindGroup,s.gpuProgram),l.renderPassEncoder.drawIndexed(e.size,1,e.start)}}destroy(){this.shader.destroy(!0),this.shader=null}}Sv.extension={type:[u.WebGPUPipesAdaptor],name:"graphics"};class wv{init(){const t=$l({name:"mesh",bits:[au,km,ih]});this._shader=new fh({gpuProgram:t,resources:{uTexture:zr.EMPTY._source,uSampler:zr.EMPTY._source.style,textureUniforms:{uTextureMatrix:{type:"mat3x3<f32>",value:new it}}}})}execute(t,e){const r=t.renderer;let s=e._shader;if(s){if(!s.gpuProgram)return}else s=this._shader,s.resources.uTexture=e.texture.source,s.resources.uSampler=e.texture.source.style,s.resources.textureUniforms.uniforms.uTextureMatrix=e.texture.textureMatrix.mapCoord;const i=s.gpuProgram;if(i.autoAssignGlobalUniforms&&(s.groups[0]=r.globalUniforms.bindGroup),i.autoAssignLocalUniforms){const e=t.localUniforms;s.groups[1]=r.renderPipes.uniformBatch.getUniformBindGroup(e,!0)}r.encoder.draw({geometry:e._geometry,shader:s,state:e.state})}destroy(){this._shader.destroy(!0),this._shader=null}}wv.extension={type:[u.WebGPUPipesAdaptor],name:"mesh"};const Ev=[...wb,Zb,Vb,Nb,Bb,Tv,cv,dv,fv,lv,Fb,Wb,kb],Av=[...Eb,Jb],Mv=[Im,wv,Sv],Pv=[],Rv=[],Ov=[];p.handleByNamedList(u.WebGPUSystem,Pv),p.handleByNamedList(u.WebGPUPipes,Rv),p.handleByNamedList(u.WebGPUPipesAdaptor,Ov),p.add(...Ev,...Av,...Mv);class Cv extends lc{constructor(){super({name:"webgpu",type:lh.WEBGPU,systems:Pv,renderPipes:Rv,renderPipeAdaptors:Ov})}}var Iv={__proto__:null,WebGPURenderer:Cv};const Gv=new Proxy({POINTS:"point-list",LINES:"line-list",LINE_STRIP:"line-strip",TRIANGLES:"triangle-list",TRIANGLE_STRIP:"triangle-strip"},{get:(t,e)=>t[e]}),kv=new vt(0,0,1,1);var Bv=(t=>(t[t.NONE=0]="NONE",t[t.LOW=2]="LOW",t[t.MEDIUM=4]="MEDIUM",t[t.HIGH=8]="HIGH",t))(Bv||{}),Dv=(t=>(t.CLAMP="clamp-to-edge",t.REPEAT="repeat",t.MIRRORED_REPEAT="mirror-repeat",t))(Dv||{});const Fv=new Proxy(Dv,{get:(t,e)=>t[e]});var Nv=(t=>(t.NEAREST="nearest",t.LINEAR="linear",t))(Nv||{});const Uv=new Proxy(Nv,{get:(t,e)=>t[e]});let Lv=0;var Xv=Object.defineProperty,zv=Object.getOwnPropertySymbols,Hv=Object.prototype.hasOwnProperty,jv=Object.prototype.propertyIsEnumerable,Vv=(t,e,r)=>e in t?Xv(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r;const Wv={rectangle:$i,polygon:Wi,triangle:Yi,circle:hi,ellipse:hi,roundedRectangle:hi};var $v=Object.defineProperty,Yv=Object.defineProperties,qv=Object.getOwnPropertyDescriptors,Kv=Object.getOwnPropertySymbols,Zv=Object.prototype.hasOwnProperty,Qv=Object.prototype.propertyIsEnumerable,Jv=(t,e,r)=>e in t?$v(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r;var tT=Object.defineProperty,eT=Object.getOwnPropertySymbols,rT=Object.prototype.hasOwnProperty,sT=Object.prototype.propertyIsEnumerable,iT=(t,e,r)=>e in t?tT(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r,nT=(t,e)=>{for(var r in e||(e={}))rT.call(e,r)&&iT(t,r,e[r]);if(eT)for(var r of eT(e))sT.call(e,r)&&iT(t,r,e[r]);return t};const oT=class t extends Zh{constructor(e){const{width:r,points:s,textureScale:i}=nT(nT({},t.defaultOptions),e);super({positions:new Float32Array(4*s.length),uvs:new Float32Array(4*s.length),indices:new Uint32Array(6*(s.length-1))}),this.points=s,this._width=r,this.textureScale=i,this._build()}get width(){return this._width}_build(){const t=this.points;if(!t)return;const e=this.getBuffer("aPosition"),r=this.getBuffer("aUV"),s=this.getIndex();if(t.length<1)return;e.data.length/4!==t.length&&(e.data=new Float32Array(4*t.length),r.data=new Float32Array(4*t.length),s.data=new Uint16Array(6*(t.length-1)));const i=r.data,n=s.data;i[0]=0,i[1]=0,i[2]=0,i[3]=1;let o=0,a=t[0];const l=this._width*this.textureScale,h=t.length;for(let e=0;e<h;e++){const r=4*e;if(this.textureScale>0){const r=a.x-t[e].x,s=a.y-t[e].y,i=Math.sqrt(r*r+s*s);a=t[e],o+=i/l}else o=e/(h-1);i[r]=o,i[r+1]=0,i[r+2]=o,i[r+3]=1}let u=0;for(let t=0;t<h-1;t++){const e=2*t;n[u++]=e,n[u++]=e+1,n[u++]=e+2,n[u++]=e+2,n[u++]=e+1,n[u++]=e+3}r.update(),s.update(),this.updateVertices()}updateVertices(){const t=this.points;if(t.length<1)return;let e,r=t[0],s=0,i=0;const n=this.buffers[0].data,o=t.length,a=this.textureScale>0?this.textureScale*this._width/2:this._width/2;for(let l=0;l<o;l++){const h=t[l],u=4*l;e=l<t.length-1?t[l+1]:h,i=-(e.x-r.x),s=e.y-r.y;let c=10*(1-l/(o-1));c>1&&(c=1);const d=Math.sqrt(s*s+i*i);d<1e-6?(s=0,i=0):(s/=d,i/=d,s*=a,i*=a),n[u]=h.x+s,n[u+1]=h.y+i,n[u+2]=h.x-s,n[u+3]=h.y-i,r=h}this.buffers[0].update()}update(){this.textureScale>0?this._build():this.updateVertices()}};oT.defaultOptions={width:200,points:[],textureScale:0};let aT=oT;var lT=Object.defineProperty,hT=Object.defineProperties,uT=Object.getOwnPropertyDescriptors,cT=Object.getOwnPropertySymbols,dT=Object.prototype.hasOwnProperty,pT=Object.prototype.propertyIsEnumerable,fT=(t,e,r)=>e in t?lT(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r,gT=(t,e)=>{for(var r in e||(e={}))dT.call(e,r)&&fT(t,r,e[r]);if(cT)for(var r of cT(e))pT.call(e,r)&&fT(t,r,e[r]);return t};const mT=class t extends om{constructor(e){const r=gT(gT({},t.defaultOptions),e),{texture:s,points:i,textureScale:n}=r,o=((t,e)=>{var r={};for(var s in t)dT.call(t,s)&&e.indexOf(s)<0&&(r[s]=t[s]);if(null!=t&&cT)for(var s of cT(t))e.indexOf(s)<0&&pT.call(t,s)&&(r[s]=t[s]);return r})(r,["texture","points","textureScale"]),a=new aT(fr({width:s.height,points:i,textureScale:n}));n>0&&(s.source.style.addressMode="repeat"),super(fr(((t,e)=>hT(t,uT(e)))(gT({},o),{texture:s,geometry:a}))),this.autoUpdate=!0,this.onRender=this._render}_render(){const t=this.geometry;(this.autoUpdate||t._width!==this.texture.height)&&(t._width=this.texture.height,t.update())}};mT.defaultOptions={textureScale:0};let _T=mT;var xT=Object.defineProperty,yT=Object.defineProperties,bT=Object.getOwnPropertyDescriptors,vT=Object.getOwnPropertySymbols,TT=Object.prototype.hasOwnProperty,ST=Object.prototype.propertyIsEnumerable,wT=(t,e,r)=>e in t?xT(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r;var ET=Object.defineProperty,AT=Object.getOwnPropertySymbols,MT=Object.prototype.hasOwnProperty,PT=Object.prototype.propertyIsEnumerable,RT=(t,e,r)=>e in t?ET(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r;const OT=class t extends jt{constructor(e){var r,s,i,n,o,a,l,h,u,c;e instanceof zr&&(e={texture:e});const d=e,{width:p,height:f,leftWidth:g,rightWidth:m,topHeight:_,bottomHeight:x,texture:y,roundPixels:b}=d,v=((t,e)=>{var r={};for(var s in t)MT.call(t,s)&&e.indexOf(s)<0&&(r[s]=t[s]);if(null!=t&&AT)for(var s of AT(t))e.indexOf(s)<0&&PT.call(t,s)&&(r[s]=t[s]);return r})(d,["width","height","leftWidth","rightWidth","topHeight","bottomHeight","texture","roundPixels"]);super(((t,e)=>{for(var r in e||(e={}))MT.call(e,r)&&RT(t,r,e[r]);if(AT)for(var r of AT(e))PT.call(e,r)&&RT(t,r,e[r]);return t})({label:"NineSliceSprite"},v)),this._roundPixels=0,this.renderPipeId="nineSliceSprite",this.batched=!0,this._didSpriteUpdate=!0,this.bounds={minX:0,minY:0,maxX:0,maxY:0},this._leftWidth=null!=(s=null!=g?g:null==(r=null==y?void 0:y.defaultBorders)?void 0:r.left)?s:Du.defaultOptions.leftWidth,this._topHeight=null!=(n=null!=_?_:null==(i=null==y?void 0:y.defaultBorders)?void 0:i.top)?n:Du.defaultOptions.topHeight,this._rightWidth=null!=(a=null!=m?m:null==(o=null==y?void 0:y.defaultBorders)?void 0:o.right)?a:Du.defaultOptions.rightWidth,this._bottomHeight=null!=(h=null!=x?x:null==(l=null==y?void 0:y.defaultBorders)?void 0:l.bottom)?h:Du.defaultOptions.bottomHeight,this.bounds.maxX=this._width=null!=(u=null!=p?p:y.width)?u:Du.defaultOptions.width,this.bounds.maxY=this._height=null!=(c=null!=f?f:y.height)?c:Du.defaultOptions.height,this.allowChildren=!1,this.texture=null!=y?y:t.defaultOptions.texture,this.roundPixels=null!=b&&b}get width(){return this._width}set width(t){this.bounds.maxX=this._width=t,this.onViewUpdate()}get height(){return this._height}set height(t){this.bounds.maxY=this._height=t,this.onViewUpdate()}get leftWidth(){return this._leftWidth}set leftWidth(t){this._leftWidth=t,this.onViewUpdate()}get topHeight(){return this._topHeight}set topHeight(t){this._topHeight=t,this.onViewUpdate()}get rightWidth(){return this._rightWidth}set rightWidth(t){this._rightWidth=t,this.onViewUpdate()}get bottomHeight(){return this._bottomHeight}set bottomHeight(t){this._bottomHeight=t,this.onViewUpdate()}get texture(){return this._texture}set texture(t){t||(t=zr.EMPTY);const e=this._texture;e!==t&&(e&&e.dynamic&&e.off("update",this.onViewUpdate,this),t.dynamic&&t.on("update",this.onViewUpdate,this),this._texture=t,this.onViewUpdate())}get roundPixels(){return!!this._roundPixels}set roundPixels(t){this._roundPixels=t?1:0}get originalWidth(){return this._texture.width}get originalHeight(){return this._texture.height}onViewUpdate(){this._didChangeId+=4096,this._didSpriteUpdate=!0,!this.didViewUpdate&&(this.didViewUpdate=!0,this.renderGroup&&this.renderGroup.onChildViewUpdate(this))}addBounds(t){const e=this.bounds;t.addFrame(e.minX,e.minY,e.maxX,e.maxY)}containsPoint(t){const e=this.bounds;return t.x>=e.minX&&t.x<=e.maxX&&t.y>=e.minY&&t.y<=e.maxY}destroy(t){if(super.destroy(t),"boolean"==typeof t?t:null==t?void 0:t.texture){const e="boolean"==typeof t?t:null==t?void 0:t.textureSource;this._texture.destroy(e)}this._texture=null,this.bounds=null}};OT.defaultOptions={texture:zr.EMPTY};let CT=OT;const IT={};var GT=Object.defineProperty,kT=Object.defineProperties,BT=Object.getOwnPropertyDescriptors,DT=Object.getOwnPropertySymbols,FT=Object.prototype.hasOwnProperty,NT=Object.prototype.propertyIsEnumerable,UT=(t,e,r)=>e in t?GT(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r,LT=(t,e)=>{for(var r in e||(e={}))FT.call(e,r)&&UT(t,r,e[r]);if(DT)for(var r of DT(e))NT.call(e,r)&&UT(t,r,e[r]);return t},XT=(t,e)=>kT(t,BT(e));const zT=["#000080","#228B22","#8B0000","#4169E1","#008080","#800000","#9400D3","#FF8C00","#556B2F","#8B008B"];let HT=0;return t.AbstractBitmapFont=to,t.AbstractRenderer=lc,t.AbstractText=Tm,t.AccessibilitySystem=ce,t.AlphaFilter=Nf,t.AlphaMask=ns,t.AlphaMaskPipe=Xm,t.AnimatedSprite=am,t.Application=Ec,t.Assets=ep,t.AssetsClass=tp,t.BLEND_TO_NPM=zs,t.BUFFER_TYPE=jm,t.BackgroundLoader=Ac,t.BackgroundSystem=Gy,t.Batch=Qs,t.BatchGeometry=Bs,t.BatchTextureArray=Vs,t.BatchableGraphics=li,t.BatchableMesh=Tn,t.BatchableSprite=wn,t.Batcher=ei,t.BatcherPipe=Gm,t.BigPool=gt,t.BindGroup=Ds,t.BindGroupSystem=kb,t.BitmapFont=Ra,t.BitmapFontManager=Pa,t.BitmapText=Am,t.BitmapTextPipe=bh,t.BlendModeFilter=class extends gf{constructor(t){const e=t.gpu,r=Ef(wf({source:xf},e)),s=yl.from({vertex:{source:r,entryPoint:"mainVertex"},fragment:{source:r,entryPoint:"mainFragment"}}),i=t.gl,n=Ef(wf({source:mf},i));super({gpuProgram:s,glProgram:ll.from({vertex:_f,fragment:n}),blendRequired:!0,resources:{blendUniforms:new vn({uBlend:{value:1,type:"f32"}}),uBackTexture:zr.EMPTY}})}},t.BlendModePipe=By,t.BlurFilter=lg,t.BlurFilterPass=Jf,t.Bounds=St,t.BrowserAdapter=De,t.Buffer=Ps,t.BufferImageSource=Ur,t.BufferResource=fx,t.BufferUsage=Ms,t.CLEAR=Ku,t.Cache=Ts,t.CanvasPool=Mn,t.CanvasPoolClass=An,t.CanvasSource=ls,t.CanvasTextMetrics=$n,t.CanvasTextPipe=En,t.CanvasTextSystem=Jn,t.Circle=ao,t.Color=Z,t.ColorMask=os,t.ColorMaskPipe=zm,t.ColorMatrixFilter=class extends gf{constructor(t={}){const e=new vn({uColorMatrix:{value:[1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1,0],type:"f32",size:20},uAlpha:{value:1,type:"f32"}}),r=yl.from({vertex:{source:ug,entryPoint:"mainVertex"},fragment:{source:ug,entryPoint:"mainFragment"}}),s=ll.from({vertex:Af,fragment:hg,name:"color-matrix-filter"});super(((t,e)=>dg(t,pg(e)))(((t,e)=>{for(var r in e||(e={}))gg.call(e,r)&&_g(t,r,e[r]);if(fg)for(var r of fg(e))mg.call(e,r)&&_g(t,r,e[r]);return t})({},t),{gpuProgram:r,glProgram:s,resources:{colorMatrixUniforms:e}})),this.alpha=1}_loadMatrix(t,e=!1){let r=t;e&&(this._multiply(r,this.matrix,t),r=this._colorMatrix(r)),this.resources.colorMatrixUniforms.uniforms.uColorMatrix=r,this.resources.colorMatrixUniforms.update()}_multiply(t,e,r){return t[0]=e[0]*r[0]+e[1]*r[5]+e[2]*r[10]+e[3]*r[15],t[1]=e[0]*r[1]+e[1]*r[6]+e[2]*r[11]+e[3]*r[16],t[2]=e[0]*r[2]+e[1]*r[7]+e[2]*r[12]+e[3]*r[17],t[3]=e[0]*r[3]+e[1]*r[8]+e[2]*r[13]+e[3]*r[18],t[4]=e[0]*r[4]+e[1]*r[9]+e[2]*r[14]+e[3]*r[19]+e[4],t[5]=e[5]*r[0]+e[6]*r[5]+e[7]*r[10]+e[8]*r[15],t[6]=e[5]*r[1]+e[6]*r[6]+e[7]*r[11]+e[8]*r[16],t[7]=e[5]*r[2]+e[6]*r[7]+e[7]*r[12]+e[8]*r[17],t[8]=e[5]*r[3]+e[6]*r[8]+e[7]*r[13]+e[8]*r[18],t[9]=e[5]*r[4]+e[6]*r[9]+e[7]*r[14]+e[8]*r[19]+e[9],t[10]=e[10]*r[0]+e[11]*r[5]+e[12]*r[10]+e[13]*r[15],t[11]=e[10]*r[1]+e[11]*r[6]+e[12]*r[11]+e[13]*r[16],t[12]=e[10]*r[2]+e[11]*r[7]+e[12]*r[12]+e[13]*r[17],t[13]=e[10]*r[3]+e[11]*r[8]+e[12]*r[13]+e[13]*r[18],t[14]=e[10]*r[4]+e[11]*r[9]+e[12]*r[14]+e[13]*r[19]+e[14],t[15]=e[15]*r[0]+e[16]*r[5]+e[17]*r[10]+e[18]*r[15],t[16]=e[15]*r[1]+e[16]*r[6]+e[17]*r[11]+e[18]*r[16],t[17]=e[15]*r[2]+e[16]*r[7]+e[17]*r[12]+e[18]*r[17],t[18]=e[15]*r[3]+e[16]*r[8]+e[17]*r[13]+e[18]*r[18],t[19]=e[15]*r[4]+e[16]*r[9]+e[17]*r[14]+e[18]*r[19]+e[19],t}_colorMatrix(t){const e=new Float32Array(t);return e[4]/=255,e[9]/=255,e[14]/=255,e[19]/=255,e}brightness(t,e){const r=[t,0,0,0,0,0,t,0,0,0,0,0,t,0,0,0,0,0,1,0];this._loadMatrix(r,e)}tint(t,e){const[r,s,i]=Z.shared.setValue(t).toArray(),n=[r,0,0,0,0,0,s,0,0,0,0,0,i,0,0,0,0,0,1,0];this._loadMatrix(n,e)}greyscale(t,e){const r=[t,t,t,0,0,t,t,t,0,0,t,t,t,0,0,0,0,0,1,0];this._loadMatrix(r,e)}grayscale(t,e){this.greyscale(t,e)}blackAndWhite(t){this._loadMatrix([.3,.6,.1,0,0,.3,.6,.1,0,0,.3,.6,.1,0,0,0,0,0,1,0],t)}hue(t,e){t=(t||0)/180*Math.PI;const r=Math.cos(t),s=Math.sin(t),i=1/3,n=(0,Math.sqrt)(i),o=[r+(1-r)*i,i*(1-r)-n*s,i*(1-r)+n*s,0,0,i*(1-r)+n*s,r+i*(1-r),i*(1-r)-n*s,0,0,i*(1-r)-n*s,i*(1-r)+n*s,r+i*(1-r),0,0,0,0,0,1,0];this._loadMatrix(o,e)}contrast(t,e){const r=(t||0)+1,s=-.5*(r-1),i=[r,0,0,0,s,0,r,0,0,s,0,0,r,0,s,0,0,0,1,0];this._loadMatrix(i,e)}saturate(t=0,e){const r=2*t/3+1,s=-.5*(r-1),i=[r,s,s,0,0,s,r,s,0,0,s,s,r,0,0,0,0,0,1,0];this._loadMatrix(i,e)}desaturate(){this.saturate(-1)}negative(t){this._loadMatrix([-1,0,0,1,0,0,-1,0,1,0,0,0,-1,1,0,0,0,0,1,0],t)}sepia(t){this._loadMatrix([.393,.7689999,.18899999,0,0,.349,.6859999,.16799999,0,0,.272,.5339999,.13099999,0,0,0,0,0,1,0],t)}technicolor(t){this._loadMatrix([1.9125277891456083,-.8545344976951645,-.09155508482755585,0,11.793603434377337,-.3087833385928097,1.7658908555458428,-.10601743074722245,0,-70.35205161461398,-.231103377548616,-.7501899197440212,1.847597816108189,0,30.950940869491138,0,0,0,1,0],t)}polaroid(t){this._loadMatrix([1.438,-.062,-.062,0,0,-.122,1.378,-.122,0,0,-.016,-.016,1.483,0,0,0,0,0,1,0],t)}toBGR(t){this._loadMatrix([0,0,1,0,0,0,1,0,0,0,1,0,0,0,0,0,0,0,1,0],t)}kodachrome(t){this._loadMatrix([1.1285582396593525,-.3967382283601348,-.03992559172921793,0,63.72958762196502,-.16404339962244616,1.0835251566291304,-.05498805115633132,0,24.732407896706203,-.16786010706155763,-.5603416277695248,1.6014850761964943,0,35.62982807460946,0,0,0,1,0],t)}browni(t){this._loadMatrix([.5997023498159715,.34553243048391263,-.2708298674538042,0,47.43192855600873,-.037703249837783157,.8609577587992641,.15059552388459913,0,-36.96841498319127,.24113635128153335,-.07441037908422492,.44972182064877153,0,-7.562075277591283,0,0,0,1,0],t)}vintage(t){this._loadMatrix([.6279345635605994,.3202183420819367,-.03965408211312453,0,9.651285835294123,.02578397704808868,.6441188644374771,.03259127616149294,0,7.462829176470591,.0466055556782719,-.0851232987247891,.5241648018700465,0,5.159190588235296,0,0,0,1,0],t)}colorTone(t,e,r,s,i){t=t||.2,e=e||.15,r=r||16770432,s=s||3375104;const n=Z.shared,[o,a,l]=n.setValue(r).toArray(),[h,u,c]=n.setValue(s).toArray(),d=[.3,.59,.11,0,0,o,a,l,t,0,h,u,c,e,0,o-h,a-u,l-c,0,0];this._loadMatrix(d,i)}night(t,e){const r=[-2*(t=t||.1),-t,0,0,0,-t,0,t,0,0,0,t,2*t,0,0,0,0,0,1,0];this._loadMatrix(r,e)}predator(t,e){const r=[11.224130630493164*t,-4.794486999511719*t,-2.8746118545532227*t,0*t,.40342438220977783*t,-3.6330697536468506*t,9.193157196044922*t,-2.951810836791992*t,0*t,-1.316135048866272*t,-3.2184197902679443*t,-4.2375030517578125*t,7.476448059082031*t,0*t,.8044459223747253*t,0,0,0,1,0];this._loadMatrix(r,e)}lsd(t){this._loadMatrix([2,-.4,.5,0,0,-.5,2,-.4,0,0,-.4,-.5,3,0,0,0,0,0,1,0],t)}reset(){this._loadMatrix([1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1,0],!1)}get matrix(){return this.resources.colorMatrixUniforms.uniforms.uColorMatrix}set matrix(t){this.resources.colorMatrixUniforms.uniforms.uColorMatrix=t}get alpha(){return this.resources.colorMatrixUniforms.uniforms.uAlpha}set alpha(t){this.resources.colorMatrixUniforms.uniforms.uAlpha=t}},t.CompressedSource=ip,t.Container=jt,t.Culler=nf,t.CullerPlugin=of,t.CustomRenderPipe=dy,t.DATA_URI=/^\s*data:(?:([\w-]+)\/([\w+.-]+))?(?:;charset=([\w-]+))?(?:;(base64))?,(.*)/i,t.DDS=Pp,t.DEG_TO_RAD=et,t.DEPRECATED_SCALE_MODES=Nv,t.DEPRECATED_WRAP_MODES=Dv,t.DOMAdapter=Ne,t.DRAW_MODES=Gv,t.DXGI_TO_TEXTURE_FORMAT=Mp,t.DisplacementFilter=class extends gf{constructor(...t){let e=t[0];e instanceof ts&&(e={sprite:e,scale:t[1]});const r=e,{sprite:s,scale:i}=r,n=((t,e)=>{var r={};for(var s in t)Eg.call(t,s)&&e.indexOf(s)<0&&(r[s]=t[s]);if(null!=t&&wg)for(var s of wg(t))e.indexOf(s)<0&&Ag.call(t,s)&&(r[s]=t[s]);return r})(r,["sprite","scale"]);let o=null!=i?i:20;"number"==typeof o&&(o=new rt(o,o));const a=new vn({uFilterMatrix:{value:new it,type:"mat3x3<f32>"},uScale:{value:o,type:"vec2<f32>"},uRotation:{value:new Float32Array([0,0,0,0]),type:"mat2x2<f32>"}}),l=ll.from({vertex:yg,fragment:xg,name:"displacement-filter"}),h=yl.from({vertex:{source:bg,entryPoint:"mainVertex"},fragment:{source:bg,entryPoint:"mainFragment"}}),u=s.texture.source;super(((t,e)=>Tg(t,Sg(e)))(((t,e)=>{for(var r in e||(e={}))Eg.call(e,r)&&Mg(t,r,e[r]);if(wg)for(var r of wg(e))Ag.call(e,r)&&Mg(t,r,e[r]);return t})({},n),{gpuProgram:h,glProgram:l,resources:{filterUniforms:a,uMapTexture:u,uMapSampler:u.style}})),this._sprite=e.sprite,this._sprite.renderable=!1}apply(t,e,r,s){const i=this.resources.filterUniforms.uniforms;t.calculateSpriteMatrix(i.uFilterMatrix,this._sprite);const n=this._sprite.worldTransform,o=Math.sqrt(n.a*n.a+n.b*n.b),a=Math.sqrt(n.c*n.c+n.d*n.d);0!==o&&0!==a&&(i.uRotation[0]=n.a/o,i.uRotation[1]=n.b/o,i.uRotation[2]=n.c/a,i.uRotation[3]=n.d/a),this.resources.uMapTexture=this._sprite.texture.source,t.applyFilter(this,e,r,s)}get scale(){return this.resources.filterUniforms.uniforms.uScale}},t.DynamicBitmapFont=ba,t.Ellipse=lo,t.EventBoundary=Ee,t.EventEmitter=m,t.EventSystem=Ge,t.EventsTicker=ye,t.ExtensionType=u,t.ExtractSystem=jy,t.FOURCC_TO_TEXTURE_FORMAT=Ap,t.FederatedContainer=ke,t.FederatedEvent=Vt,t.FederatedMouseEvent=be,t.FederatedPointerEvent=ve,t.FederatedWheelEvent=Te,t.FillGradient=qn,t.FillPattern=Zn,t.Filter=gf,t.FilterEffect=dt,t.FilterPipe=Nu,t.FilterSystem=ju,t.FontStylePromiseCache=Dh,t.GAUSSIAN_VALUES=Uf,t.GL_FORMATS=a_,t.GL_INTERNAL_FORMAT=Ip,t.GL_TARGETS=l_,t.GL_TYPES=u_,t.GL_WRAP_MODES=h_,t.GenerateTextureSystem=rb,t.Geometry=Is,t.GlBackBufferSystem=S_,t.GlBatchAdaptor=Om,t.GlBuffer=Vm,t.GlBufferSystem=Wm,t.GlColorMaskSystem=w_,t.GlContextSystem=s_,t.GlEncoderSystem=E_,t.GlGeometrySystem=f_,t.GlGraphicsAdaptor=uy,t.GlMeshAdaptor=cy,t.GlProgram=ll,t.GlProgramData=mx,t.GlRenderTarget=A_,t.GlRenderTargetAdaptor=$_,t.GlRenderTargetSystem=px,t.GlShaderSystem=Ix,t.GlStateSystem=Lx,t.GlStencilSystem=P_,t.GlTexture=Xx,t.GlTextureSystem=hy,t.GlUboSystem=W_,t.GlUniformGroupSystem=Dx,t.GlobalUniformSystem=sb,t.GpuBatchAdaptor=Im,t.GpuBlendModesToPixi=pv,t.GpuBufferSystem=Bb,t.GpuColorMaskSystem=Fb,t.GpuDeviceSystem=Nb,t.GpuEncoderSystem=Vb,t.GpuGraphicsAdaptor=Sv,t.GpuGraphicsContext=tn,t.GpuMeshAdapter=wv,t.GpuMipmapGenerator=vv,t.GpuProgram=yl,t.GpuReadBuffer=function(t,e){const r=t.descriptor.size,s=e.gpu.device,i=new Ps({data:new Float32Array(24e5),usage:Ms.MAP_READ|Ms.COPY_DST}),n=e.buffer.createGPUBuffer(i),o=s.createCommandEncoder();o.copyBufferToBuffer(e.buffer.getGPUBuffer(t),0,n,0,r),s.queue.submit([o.finish()]),n.mapAsync(GPUMapMode.READ,0,r).then((()=>{n.getMappedRange(0,r),n.unmap()}))},t.GpuRenderTarget=hv,t.GpuRenderTargetAdaptor=uv,t.GpuRenderTargetSystem=cv,t.GpuShaderSystem=dv,t.GpuStateSystem=fv,t.GpuStencilModesToPixi=M_,t.GpuStencilSystem=Wb,t.GpuTextureSystem=Tv,t.GpuUboSystem=Zb,t.GpuUniformBatchPipe=Jb,t.Graphics=Xa,t.GraphicsContext=aa,t.GraphicsContextRenderData=en,t.GraphicsContextSystem=sn,t.GraphicsPath=Co,t.GraphicsPipe=hn,t.HTMLText=Mm,t.HTMLTextPipe=Th,t.HTMLTextRenderData=Ah,t.HTMLTextStyle=Ih,t.HTMLTextSystem=Hh,t.HelloSystem=ab,t.IGLUniformData=class{},t.ImageSource=hs,t.InstructionSet=Nt,t.KTX=Bp,t.Loader=Vc,t.LoaderParserPriority=Be,t.MAX_TEXTURES=Fs,t.MSAA_QUALITY=Bv,t.MaskEffectManager=_t,t.MaskEffectManagerClass=mt,t.MaskFilter=Kg,t.Matrix=it,t.Mesh=om,t.MeshGeometry=Zh,t.MeshPipe=Sn,t.MeshPlane=class extends om{constructor(t){const e=t,{texture:r,verticesX:s,verticesY:i}=e,n=((t,e)=>{var r={};for(var s in t)Zv.call(t,s)&&e.indexOf(s)<0&&(r[s]=t[s]);if(null!=t&&Kv)for(var s of Kv(t))e.indexOf(s)<0&&Qv.call(t,s)&&(r[s]=t[s]);return r})(e,["texture","verticesX","verticesY"]),o=new Pu(fr({width:r.width,height:r.height,verticesX:s,verticesY:i}));super(fr(((t,e)=>Yv(t,qv(e)))(((t,e)=>{for(var r in e||(e={}))Zv.call(e,r)&&Jv(t,r,e[r]);if(Kv)for(var r of Kv(e))Qv.call(e,r)&&Jv(t,r,e[r]);return t})({},n),{geometry:o,texture:r}))),this.texture=r,this.autoResize=!0}textureUpdated(){const t=this.geometry,{width:e,height:r}=this.texture;this.autoResize&&(t.width!==e||t.height!==r)&&(t.width=e,t.height=r,t.build({}))}set texture(t){var e;null==(e=this._texture)||e.off("update",this.textureUpdated,this),super.texture=t,t.on("update",this.textureUpdated,this),this.textureUpdated()}get texture(){return this._texture}destroy(t){this.texture.off("update",this.textureUpdated,this),super.destroy(t)}},t.MeshRope=_T,t.MeshSimple=class extends om{constructor(t){const e=t,{texture:r,vertices:s,uvs:i,indices:n,topology:o}=e,a=((t,e)=>{var r={};for(var s in t)TT.call(t,s)&&e.indexOf(s)<0&&(r[s]=t[s]);if(null!=t&&vT)for(var s of vT(t))e.indexOf(s)<0&&ST.call(t,s)&&(r[s]=t[s]);return r})(e,["texture","vertices","uvs","indices","topology"]),l=new Zh(fr({positions:s,uvs:i,indices:n,topology:o}));super(fr(((t,e)=>yT(t,bT(e)))(((t,e)=>{for(var r in e||(e={}))TT.call(e,r)&&wT(t,r,e[r]);if(vT)for(var r of vT(e))ST.call(e,r)&&wT(t,r,e[r]);return t})({},a),{texture:r,geometry:l}))),this.autoUpdate=!0,this.onRender=this._render}get vertices(){return this.geometry.getBuffer("aPosition").data}set vertices(t){this.geometry.getBuffer("aPosition").data=t}_render(){this.autoUpdate&&this.geometry.getBuffer("aPosition").update()}},t.NOOP=cr,t.NineSliceGeometry=Du,t.NineSlicePlane=class extends CT{constructor(...t){let e=t[0];e instanceof zr&&(e={texture:e,leftWidth:t[1],topHeight:t[2],rightWidth:t[3],bottomHeight:t[4]}),super(e)}},t.NineSliceSprite=CT,t.NineSliceSpritePipe=Fu,t.NoiseFilter=Ug,t.ObservablePoint=at,t.PI_2=J,t.PipelineSystem=lv,t.PlaneGeometry=Pu,t.Point=rt,t.Polygon=uo,t.Pool=pt,t.PoolGroupClass=ft,t.PrepareBase=Jg,t.PrepareQueue=Em,t.PrepareSystem=Rm,t.PrepareUpload=Pm,t.QuadGeometry=gu,t.RAD_TO_DEG=tt,t.Rectangle=vt,t.RenderContainer=class extends jt{constructor(t){var e,r;"function"==typeof t&&(t={render:t});const s=t,{render:i}=s,n=((t,e)=>{var r={};for(var s in t)Hv.call(t,s)&&e.indexOf(s)<0&&(r[s]=t[s]);if(null!=t&&zv)for(var s of zv(t))e.indexOf(s)<0&&jv.call(t,s)&&(r[s]=t[s]);return r})(s,["render"]);super(((t,e)=>{for(var r in e||(e={}))Hv.call(e,r)&&Vv(t,r,e[r]);if(zv)for(var r of zv(e))jv.call(e,r)&&Vv(t,r,e[r]);return t})({label:"RenderContainer"},n)),this.batched=!1,this.bounds=new St,this.canBundle=!1,this.renderPipeId="customRender",i&&(this.render=i),this.containsPoint=null!=(e=t.containsPoint)?e:()=>!1,this.addBounds=null!=(r=t.addBounds)?r:()=>!1}render(t){}},t.RenderGroup=Ut,t.RenderGroupPipe=fy,t.RenderGroupSystem=Sy,t.RenderTarget=cx,t.RenderTargetSystem=dx,t.RenderTexture=Vy,t.RendererType=lh,t.ResizePlugin=pe,t.Resolver=tr,t.RopeGeometry=aT,t.RoundedRectangle=po,t.SCALE_MODES=Uv,t.STENCIL_MODES=Hs,t.SVGParser=Uo,t.SVGToGraphicsPath=oo,t.ScissorMask=class{constructor(t){this.priority=0,this.pipe="scissorMask",this.mask=t,this.mask.renderable=!1,this.mask.measurable=!1}addBounds(t,e){rs(this.mask,t,e)}addLocalBounds(t,e){ss(this.mask,t,e)}containsPoint(t,e){return e(this.mask,t)}reset(){this.mask.measurable=!0,this.mask=null}destroy(){this.reset()}},t.SdfShader=yh,t.Shader=fh,t.ShaderStage=fl,t.ShapePath=Oo,t.SharedRenderPipes=Eb,t.SharedSystems=wb,t.Sprite=ts,t.SpritePipe=Ey,t.Spritesheet=jr,t.State=an,t.StencilMask=as,t.StencilMaskPipe=Hm,t.SystemRunner=Zu,t.TEXTURE_FORMAT_BLOCK_SIZE=Rp,t.Text=wm,t.TextStyle=xa,t.Texture=zr,t.TextureGCSystem=gb,t.TextureMatrix=Xr,t.TexturePool=Fn,t.TexturePoolClass=Dn,t.TextureSource=Cr,t.TextureStyle=Sr,t.TextureUvs=class{constructor(){this.x0=0,this.y0=0,this.x1=1,this.y1=0,this.x2=1,this.y2=1,this.x3=0,this.y3=1,this.uvsFloat32=new Float32Array(8)}set(t,e,r){const s=e.width,i=e.height;if(r){const e=t.width/2/s,n=t.height/2/i,o=t.x/s+e,a=t.y/i+n;r=ur.add(r,ur.NW),this.x0=o+e*ur.uX(r),this.y0=a+n*ur.uY(r),r=ur.add(r,2),this.x1=o+e*ur.uX(r),this.y1=a+n*ur.uY(r),r=ur.add(r,2),this.x2=o+e*ur.uX(r),this.y2=a+n*ur.uY(r),r=ur.add(r,2),this.x3=o+e*ur.uX(r),this.y3=a+n*ur.uY(r)}else this.x0=t.x/s,this.y0=t.y/i,this.x1=(t.x+t.width)/s,this.y1=t.y/i,this.x2=(t.x+t.width)/s,this.y2=(t.y+t.height)/i,this.x3=t.x/s,this.y3=(t.y+t.height)/i;this.uvsFloat32[0]=this.x0,this.uvsFloat32[1]=this.y0,this.uvsFloat32[2]=this.x1,this.uvsFloat32[3]=this.y1,this.uvsFloat32[4]=this.x2,this.uvsFloat32[5]=this.y2,this.uvsFloat32[6]=this.x3,this.uvsFloat32[7]=this.y3}},t.Ticker=_e,t.TickerListener=ge,t.TickerPlugin=xe,t.TilingSprite=mm,t.TilingSpritePipe=bu,t.TilingSpriteShader=fu,t.Transform=lm,t.Triangle=Zg,t.UNIFORM_TO_ARRAY_SETTERS=kx,t.UNIFORM_TO_SINGLE_SETTERS=Gx,t.UPDATE_BLEND=2,t.UPDATE_COLOR=1,t.UPDATE_PRIORITY=fe,t.UPDATE_TRANSFORM=8,t.UPDATE_VISIBLE=4,t.UboBatch=Db,t.UboSystem=R_,t.UniformGroup=vn,t.VERSION=nb,t.VideoSource=vs,t.ViewSystem=Sb,t.ViewableBuffer=Ls,t.WGSL_ALIGN_SIZE_DATA=$b,t.WGSL_TO_STD40_SIZE=O_,t.WRAP_MODES=Fv,t.WebGLRenderer=Ib,t.WebGPURenderer=Cv,t.WorkerManager=Md,t._getGlobalBounds=Mt,t._getGlobalBoundsRecursive=Xu,t.accessibilityTarget=de,t.addBits=bl,t.addMaskBounds=rs,t.addMaskLocalBounds=ss,t.addProgramDefines=Wa,t.alphaFrag=Mf,t.alphaWgsl=Pf,t.applyMatrix=_u,t.applyStyleParams=Zx,t.assignWithIgnore=Lt,t.autoDetectEnvironment=$u,t.autoDetectRenderer=xc,t.autoDetectSource=ws,t.basisTranscoderUrls=mp,t.batchSamplersUniformGroup=ah,t.bitmapFontCachePlugin=ka,t.bitmapFontTextParser=Oa,t.bitmapFontXMLParser=Ca,t.bitmapFontXMLStringParser=Ia,t.blendTemplateFrag=mf,t.blendTemplateVert=_f,t.blendTemplateWgsl=xf,t.blockDataMap=mv,t.blurTemplateWgsl=jf,t.boundsPool=Et,t.browserExt=af,t.buildAdaptiveBezier=go,t.buildAdaptiveQuadratic=_o,t.buildArc=yo,t.buildArcTo=bo,t.buildArcToSvg=Ao,t.buildCircle=hi,t.buildContextBatches=Zi,t.buildGeometryFromPath=function(t){t instanceof Co&&(t={path:t,textureMatrix:null,out:null});const e=[],r=[],s=[],i=t.path.shapePath,n=t.textureMatrix;i.shapePrimitives.forEach((({shape:t,transform:i})=>{const o=s.length,a=e.length/2,l=[],h=Wv[t.type];h.build(t,l),i&&ii(l,i),h.triangulate(l,e,2,a,s,o);const u=r.length/2;n?(i&&n.append(i.clone().invert()),ri(e,2,a,r,u,2,e.length/2-a,n)):si(r,u,2,e.length/2-a)}));const o=t.out;return o?(o.positions=new Float32Array(e),o.uvs=new Float32Array(r),o.indices=new Uint32Array(s),o):new Zh({positions:new Float32Array(e),uvs:new Float32Array(r),indices:new Uint32Array(s)})},t.buildInstructions=Dm,t.buildLine=gi,t.buildPolygon=Wi,t.buildRectangle=$i,t.buildSimpleUvs=si,t.buildTriangle=Yi,t.buildUvs=ri,t.cacheTextureArray=Mc,t.calculateProjection=Y_,t.checkChildrenDidChange=Ct,t.checkDataUrl=Wc,t.checkExtension=$c,t.childrenHelperMixin=ct,t.closePointEps=ui,t.collectAllRenderables=Fm,t.collectRenderGroups=gy,t.color32BitToUniform=ln,t.colorBit=ql,t.colorBitGl=Kl,t.colorMatrixFilterFrag=hg,t.colorMatrixFilterWgsl=ug,t.colorToUniform=function(t,e,r,s){r[s++]=(t>>16&255)/255,r[s++]=(t>>8&255)/255,r[s++]=(255&t)/255,r[s++]=e},t.compareModeToGlCompare=Kx,t.compileHighShader=Cl,t.compileHighShaderGl=Il,t.compileHighShaderGlProgram=Yl,t.compileHighShaderGpuProgram=$l,t.compileHooks=Tl,t.compileInputs=wl,t.compileOutputs=Al,t.compileShader=_x,t.convertFillInputToFillStyle=Zo,t.convertFormatIfRequired=function(t){const e=t.format;if(Vp[e]){const r=Vp[e].convertFunction,s=t.resource;for(let t=0;t<s.length;t++)s[t]=r(s[t]);t.format=Vp[e].convertedFormat}},t.convertToList=ze,t.copySearchParams=rr,t.createIdFromString=dn,t.createLevelBuffers=function(t,e){const r=t.getNumImages(),s=t.getNumLevels(0);if(!t.startTranscoding())throw new Error("startTranscoding failed");const i=[];for(let n=0;n<s;++n)for(let s=0;s<r;++s){const r=t.getImageTranscodedSizeInBytes(s,n,e),o=new Uint8Array(r);if(!t.transcodeImage(o,s,n,e,1,0))throw new Error("transcodeImage failed");i.push(o)}return i},t.createLevelBuffersFromKTX=function(t){const e=[];for(let r=0;r<t.numLevels;r++){const s=t.getImageData(r,0,0),i=new Uint8Array(s.byteLength);i.set(s),e.push(i)}return e},t.createStringVariations=je,t.createTexture=fd,t.createUboElementsSTD40=C_,t.createUboElementsWGSL=Yb,t.createUboSyncFunction=G_,t.createUboSyncFunctionSTD40=V_,t.createUboSyncFunctionWGSL=Kb,t.crossOrigin=Yd,t.cullingMixin=Q,t.curveEps=ci,t.defaultFilterVert=Af,t.defaultValue=yx,t.definedProps=fr,t.deprecation=function(t,e,r=3){if(IT[e])return;let s=(new Error).stack;void 0===s?console.warn("PixiJS Deprecation Warning: ",`${e}\nDeprecated since v${t}`):(s=s.split("\n").splice(r).join("\n"),console.groupCollapsed?(console.groupCollapsed("%cPixiJS Deprecation Warning: %c%s","color:#614108;background:#fffbe6","font-weight:normal;color:#614108;background:#fffbe6",`${e}\nDeprecated since v${t}`),console.warn(s),console.groupEnd()):(console.warn("PixiJS Deprecation Warning: ",`${e}\nDeprecated since v${t}`),console.warn(s))),IT[e]=!0},t.detectAvif=Rc,t.detectBasis=sp,t.detectCompressed=ef,t.detectDefaults=Cc,t.detectMp4=kc,t.detectOgv=Bc,t.detectVideoAlphaMode=cs,t.detectWebm=Dc,t.detectWebp=Fc,t.determineCrossOrigin=Kd,t.displacementFrag=xg,t.displacementVert=yg,t.displacementWgsl=bg,t.earcut=Hi,t.effectsMixin=xt,t.ensureAttributes=o_,t.ensureIsBuffer=Rs,t.ensureOptions=Sm,t.ensurePrecision=$a,t.ensureTextStyle=function(t,e){return e instanceof xa||e instanceof Ih?e:"html"===t?new Ih(e):new xa(e)},t.executeInstructions=py,t.extensions=p,t.extractAttributesFromGlProgram=Ex,t.extractAttributesFromGpuProgram=dl,t.extractFontFamilies=Gh,t.extractStructAndGroups=pl,t.fastCopy=Xs,t.findHooksRx=vl,t.findMixin=yt,t.fontStringFromTextStyle=jn,t.formatShader=function(t){const e=t.split(/([\n{}])/g).map((t=>t.trim())).filter((t=>t.length));let r="";return e.map((t=>{let e=r+t;return"{"===t?r+="    ":"}"===t&&(r=r.substr(0,r.length-4),e=r+t),e})).join("\n")},t.fragmentGPUTemplate=Dl,t.fragmentGlTemplate=Nl,t.generateArraySyncSTD40=j_,t.generateArraySyncWGSL=qb,t.generateBlurFragSource=Xf,t.generateBlurGlProgram=Hf,t.generateBlurProgram=Vf,t.generateBlurVertSource=zf,t.generateGPULayout=function(t){const e=[];let r=0;for(let s=0;s<t;s++)e[r]={texture:{sampleType:"float",viewDimension:"2d",multisampled:!1},binding:r,visibility:GPUShaderStage.FRAGMENT},r++,e[r]={sampler:{type:"filtering"},binding:r,visibility:GPUShaderStage.FRAGMENT},r++;return e},t.generateGpuLayoutGroups=gl,t.generateLayout=function(t){const e={};let r=0;for(let s=0;s<t;s++)e[`textureSource${s+1}`]=r++,e[`textureSampler${s+1}`]=r++;return e},t.generateLayoutHash=ml,t.generateProgram=Ox,t.generateShaderSyncCode=gx,t.generateTextStyleKey=ha,t.generateTextureBatchBit=th,t.generateTextureBatchBitGl=sh,t.generateUID=function(){return Lv++},t.generateUniformsSync=Bx,t.getAdjustedBlendModeBlend=js,t.getAttributeInfoFromFormat=ul,t.getBitmapTextLayout=va,t.getCanvasBoundingBox=Ln,t.getCanvasFillStyle=Qn,t.getCanvasTexture=rx,t.getDefaultUniformValue=pn,t.getFastGlobalBounds=Lu,t.getFontCss=Fh,t.getFontFamilyName=hd,t.getGeometryBounds=Os,t.getGlTypeFromFormat=d_,t.getGlobalBounds=At,t.getGlobalRenderableBounds=zu,t.getLocalBounds=Rt,t.getMatrixRelativeToParent=is,t.getMaxFragmentPrecision=Va,t.getOrientationOfPoints=di,t.getParent=function t(e,r,s){const i=e.parent;i&&i!==r&&(t(i,r,s),i.updateLocalTransform(),s.append(i.localTransform))},t.getPo2TextureFromSource=zn,t.getResolutionOfUrl=pd,t.getSVGUrl=Nh,t.getSupportedCompressedTextureFormats=up,t.getSupportedGPUCompressedTextureFormats=hp,t.getSupportedGlCompressedTextureFormats=lp,t.getSupportedTextureFormats=pp,t.getTemporaryCanvasFromImage=Uh,t.getTestContext=ja,t.getTextureBatchBindGroup=Us,t.getTextureDefaultMatrix=function(t,e){const{width:r,height:s}=t.frame;return e.scale(1/r,1/s),e},t.getTextureFormatFromKTXTexture=function(t){return 2===t.classId?Kp(t.vkFormat):Yp(t.glInternalformat)},t.getUboData=Ax,t.getUniformData=Mx,t.getUrlExtension=er,t.glFormatToGPUFormat=Yp,t.glUploadBufferImageResource=zx,t.glUploadCompressedTextureResource=jx,t.glUploadImageResource=Vx,t.glUploadVideoResource=Wx,t.globalUniformsBit=Ul,t.globalUniformsBitGl=Xl,t.globalUniformsUBOBitGl=Ll,t.gpuFormatToBasisTranscoderFormat=function(t){const e=vp[t];if(e)return e;throw new Error(`Unsupported transcoderFormat: ${t}`)},t.gpuFormatToKTXBasisTranscoderFormat=function(t){const e=Zp[t];if(e)return e;throw new Error(`Unsupported transcoderFormat: ${t}`)},t.gpuUploadBufferImageResource=gv,t.gpuUploadCompressedTextureResource=xv,t.gpuUploadImageResource=yv,t.gpuUploadVideoResource=bv,t.groupD8=ur,t.hasCachedCanvasTexture=function(t){return ex.has(t)},t.hslWgsl="fn getLuminosity(c: vec3<f32>) -> f32 {\n  return 0.3 * c.r + 0.59 * c.g + 0.11 * c.b;\n}\n\nfn setLuminosity(c: vec3<f32>, lum: f32) -> vec3<f32> {\n  let d: f32 = lum - getLuminosity(c);\n  let newColor: vec3<f32> = c.rgb + vec3<f32>(d, d, d);\n\n  // clip back into legal range\n  let newLum: f32 = getLuminosity(newColor);\n  let cMin: f32 = min(newColor.r, min(newColor.g, newColor.b));\n  let cMax: f32 = max(newColor.r, max(newColor.g, newColor.b));\n\n  let t1: f32 = newLum / (newLum - cMin);\n  let t2: f32 = (1.0 - newLum) / (cMax - newLum);\n\n  let finalColor = mix(vec3<f32>(newLum, newLum, newLum), newColor, select(select(1.0, t2, cMax > 1.0), t1, cMin < 0.0));\n\n  return finalColor;\n}\n\nfn getSaturation(c: vec3<f32>) -> f32 {\n  return max(c.r, max(c.g, c.b)) - min(c.r, min(c.g, c.b));\n}\n\n// Set saturation if color components are sorted in ascending order.\nfn setSaturationMinMidMax(cSorted: vec3<f32>, s: f32) -> vec3<f32> {\n  var result: vec3<f32>;\n  if (cSorted.z > cSorted.x) {\n    let newY = (((cSorted.y - cSorted.x) * s) / (cSorted.z - cSorted.x));\n    result = vec3<f32>(0.0, newY, s);\n  } else {\n    result = vec3<f32>(0.0, 0.0, 0.0);\n  }\n  return vec3<f32>(result.x, result.y, result.z);\n}\n\nfn setSaturation(c: vec3<f32>, s: f32) -> vec3<f32> {\n    var result: vec3<f32> = c;\n\n    if (c.r <= c.g && c.r <= c.b) {\n        if (c.g <= c.b) {\n            result = setSaturationMinMidMax(result, s);\n        } else {\n            var temp: vec3<f32> = vec3<f32>(result.r, result.b, result.g);\n            temp = setSaturationMinMidMax(temp, s);\n            result = vec3<f32>(temp.r, temp.b, temp.g);\n        }\n    } else if (c.g <= c.r && c.g <= c.b) {\n        if (c.r <= c.b) {\n            var temp: vec3<f32> = vec3<f32>(result.g, result.r, result.b);\n            temp = setSaturationMinMidMax(temp, s);\n            result = vec3<f32>(temp.g, temp.r, temp.b);\n        } else {\n            var temp: vec3<f32> = vec3<f32>(result.g, result.b, result.r);\n            temp = setSaturationMinMidMax(temp, s);\n            result = vec3<f32>(temp.g, temp.b, temp.r);\n        }\n    } else {\n        if (c.r <= c.g) {\n            var temp: vec3<f32> = vec3<f32>(result.b, result.r, result.g);\n            temp = setSaturationMinMidMax(temp, s);\n            result = vec3<f32>(temp.b, temp.r, temp.g);\n        } else {\n            var temp: vec3<f32> = vec3<f32>(result.b, result.g, result.r);\n            temp = setSaturationMinMidMax(temp, s);\n            result = vec3<f32>(temp.b, temp.g, temp.r);\n        }\n    }\n\n    return result;\n}",t.hslgl="\n\tfloat getLuminosity(vec3 c) {\n\t\treturn 0.3 * c.r + 0.59 * c.g + 0.11 * c.b;\n\t}\n\n\tvec3 setLuminosity(vec3 c, float lum) {\n\t\tfloat modLum = lum - getLuminosity(c);\n\t\tvec3 color = c.rgb + vec3(modLum);\n\n\t\t// clip back into legal range\n\t\tmodLum = getLuminosity(color);\n\t\tvec3 modLumVec = vec3(modLum);\n\n\t\tfloat cMin = min(color.r, min(color.g, color.b));\n\t\tfloat cMax = max(color.r, max(color.g, color.b));\n\n\t\tif(cMin < 0.0) {\n\t\t\tcolor = mix(modLumVec, color, modLum / (modLum - cMin));\n\t\t}\n\n\t\tif(cMax > 1.0) {\n\t\t\tcolor = mix(modLumVec, color, (1.0 - modLum) / (cMax - modLum));\n\t\t}\n\n\t\treturn color;\n\t}\n\n\tfloat getSaturation(vec3 c) {\n\t\treturn max(c.r, max(c.g, c.b)) - min(c.r, min(c.g, c.b));\n\t}\n\n\tvec3 setSaturationMinMidMax(vec3 cSorted, float s) {\n\t\tvec3 colorSorted = cSorted;\n\n\t\tif(colorSorted.z > colorSorted.x) {\n\t\t\tcolorSorted.y = (((colorSorted.y - colorSorted.x) * s) / (colorSorted.z - colorSorted.x));\n\t\t\tcolorSorted.z = s;\n\t\t}\n\t\telse {\n\t\t\tcolorSorted.y = 0.0;\n\t\t\tcolorSorted.z = 0.0;\n\t\t}\n\n\t\tcolorSorted.x = 0.0;\n\n\t\treturn colorSorted;\n\t}\n\n\tvec3 setSaturation(vec3 c, float s) {\n\t\tvec3 color = c;\n\n\t\tif(color.r <= color.g && color.r <= color.b) {\n\t\t\tif(color.g <= color.b) {\n\t\t\t\tcolor = setSaturationMinMidMax(color.rgb, s).rgb;\n\t\t\t}\n\t\t\telse {\n\t\t\t\tcolor = setSaturationMinMidMax(color.rbg, s).rbg;\n\t\t\t}\n\t\t}\n\t\telse if(color.g <= color.r && color.g <= color.b) {\n\t\t\tif(color.r <= color.b) {\n\t\t\t\tcolor = setSaturationMinMidMax(color.grb, s).grb;\n\t\t\t}\n\t\t\telse {\n\t\t\t\tcolor = setSaturationMinMidMax(color.gbr, s).gbr;\n\t\t\t}\n\t\t}\n\t\telse {\n\t\t\t// Using bgr for both fixes part of hue\n\t\t\tif(color.r <= color.g) {\n\t\t\t\tcolor = setSaturationMinMidMax(color.brg, s).brg;\n\t\t\t}\n\t\t\telse {\n\t\t\t\tcolor = setSaturationMinMidMax(color.bgr, s).bgr;\n\t\t\t}\n\t\t}\n\n\t\treturn color;\n\t}\n    ",t.hslgpu="\n\tfn getLuminosity(c: vec3<f32>) -> f32\n\t{\n\t\treturn 0.3*c.r + 0.59*c.g + 0.11*c.b;\n\t}\n\n\tfn setLuminosity(c: vec3<f32>, lum: f32) -> vec3<f32>\n\t{\n\t\tvar modLum: f32 = lum - getLuminosity(c);\n\t\tvar color: vec3<f32> = c.rgb + modLum;\n\n\t\t// clip back into legal range\n\t\tmodLum = getLuminosity(color);\n\t\tlet modLumVec = vec3<f32>(modLum);\n\n\t\tlet cMin: f32 = min(color.r, min(color.g, color.b));\n\t\tlet cMax: f32 = max(color.r, max(color.g, color.b));\n\n\t\tif(cMin < 0.0)\n\t\t{\n\t\t\tcolor = mix(modLumVec, color, modLum / (modLum - cMin));\n\t\t}\n\n\t\tif(cMax > 1.0)\n\t\t{\n\t\t\tcolor = mix(modLumVec, color, (1 - modLum) / (cMax - modLum));\n\t\t}\n\n\t\treturn color;\n\t}\n\n\tfn getSaturation(c: vec3<f32>) -> f32\n\t{\n\t\treturn max(c.r, max(c.g, c.b)) - min(c.r, min(c.g, c.b));\n\t}\n\n\tfn setSaturationMinMidMax(cSorted: vec3<f32>, s: f32) -> vec3<f32>\n\t{\n\t\tvar colorSorted = cSorted;\n\n\t\tif(colorSorted.z > colorSorted.x)\n\t\t{\n\t\t\tcolorSorted.y = (((colorSorted.y - colorSorted.x) * s) / (colorSorted.z - colorSorted.x));\n\t\t\tcolorSorted.z = s;\n\t\t}\n\t\telse\n\t\t{\n\t\t\tcolorSorted.y = 0;\n\t\t\tcolorSorted.z = 0;\n\t\t}\n\n\t\tcolorSorted.x = 0;\n\n\t\treturn colorSorted;\n\t}\n\n\tfn setSaturation(c: vec3<f32>, s: f32) -> vec3<f32>\n\t{\n\t\tvar color = c;\n\n\t\tif (color.r <= color.g && color.r <= color.b)\n\t\t{\n\t\t\tif (color.g <= color.b)\n\t\t\t{\n\t\t\t\tcolor = vec3<f32>(setSaturationMinMidMax(color.rgb, s)).rgb;\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tcolor = vec3<f32>(setSaturationMinMidMax(color.rbg, s)).rbg;\n\t\t\t}\n\t\t}\n\t\telse if (color.g <= color.r && color.g <= color.b)\n\t\t{\n\t\t\tif (color.r <= color.b)\n\t\t\t{\n\t\t\t\tcolor = vec3<f32>(setSaturationMinMidMax(color.grb, s)).grb;\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tcolor = vec3<f32>(setSaturationMinMidMax(color.gbr, s)).gbr;\n\t\t\t}\n\t\t}\n\t\telse\n\t\t{\n\t\t\t// Using bgr for both fixes part of hue\n\t\t\tif (color.r <= color.g)\n\t\t\t{\n\t\t\t\tcolor = vec3<f32>(setSaturationMinMidMax(color.brg, s)).brg;\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tcolor  = vec3<f32>(setSaturationMinMidMax(color.bgr, s)).bgr;\n\t\t\t}\n\t\t}\n\n\t\treturn color;\n\t}\n\t",t.injectBits=Ml,t.insertVersion=Ya,t.isMobile=ue,t.isPow2=pr,t.isRenderingToScreen=sx,t.isSafari=Sh,t.isSingleItem=Ve,t.isWebGLSupported=hc,t.isWebGPUSupported=uc,t.ktxTranscoderUrls=Lp,t.loadBasis=bp,t.loadBasisOnWorker=yp,t.loadBitmapFont=Ba,t.loadDDS=Cp,t.loadFontAsBase64=kh,t.loadFontCSS=Bh,t.loadImageBitmap=Bd,t.loadJson=Yc,t.loadKTX=Fp,t.loadKTX2=jp,t.loadKTX2onWorker=Hp,t.loadSVGImage=Lh,t.loadSvg=bd,t.loadTextures=Dd,t.loadTxt=qc,t.loadVideoTextures=Zd,t.loadWebFont=dd,t.localUniformBit=au,t.localUniformBitGl=hu,t.localUniformBitGroup2=lu,t.localUniformMSDFBit=gh,t.localUniformMSDFBitGl=mh,t.log2=function(t){let e=(t>65535?1:0)<<4,r=((t>>>=e)>255?1:0)<<3;return e|=r,r=((t>>>=r)>15?1:0)<<2,e|=r,r=((t>>>=r)>3?1:0)<<1,e|=r,e|(t>>>=r)>>1},t.logDebugTexture=async function(t,e,r=200){const s=await e.extract.base64(t);await e.encoder.commandFinished;const i=r;console.log(`logging texture ${t.source.width}px ${t.source.height}px`);const n=["font-size: 1px;",`padding: ${i}px 300px;`,`background: url(${s}) no-repeat;`,"background-size: contain;"].join(" ");console.log("%c ",n)},t.logProgramError=Rx,t.logRenderGroupScene=function t(e,r=0,s={index:0,color:"#000000"}){let i="";for(let t=0;t<r;t++)i+="    ";const n=`%c ${i}- ${s.index}: ${e.root.label} worldX:${e.worldTransform.tx}`;console.log(n,`color:${s.color}; font-weight:bold;`),r++;for(let i=0;i<e.renderGroupChildren.length;i++){t(e.renderGroupChildren[i],r,XT(LT({},s),{index:i}))}},t.logScene=function t(e,r=0,s={color:"#000000"}){e.isRenderGroupRoot&&(s.color=zT[HT++]);let i="";for(let t=0;t<r;t++)i+="    ";let n=e.label;!n&&e instanceof ts&&(n=`sprite:${e.texture.label}`);let o=`%c ${i}|- ${n} (worldX:${e.worldTransform.tx}, relativeRenderX:${e.relativeGroupTransform.tx}, renderX:${e.groupTransform.tx}, localX:${e.x})`;e.isRenderGroupRoot&&(o+=" (RenderGroup)"),e.filters&&(o+="(*filters)"),console.log(o,`color:${s.color}; font-weight:bold;`),r++;for(let i=0;i<e.children.length;i++){t(e.children[i],r,LT({},s))}},t.mSDFBit=_h,t.mSDFBitGl=xh,t.mapFormatToGlFormat=Qx,t.mapFormatToGlInternalFormat=ay,t.mapFormatToGlType=ly,t.mapGlToVertexFormat=wx,t.mapSize=function(t){return Fx[t]},t.mapType=Sx,t.mapWebGLBlendModesToPixi=Nx,t.maskFrag=Lg,t.maskVert=Xg,t.maskWgsl=zg,t.matrixPool=wt,t.measureHtmlText=zh,t.measureMixin=Gt,t.migrateFragmentFromV7toV8=function(t){return t=`\n        out vec4 finalColor;\n    ${t=t.replaceAll("texture2D","texture").replaceAll("gl_FragColor","finalColor").replaceAll("varying","in")}\n    `},t.mipmapScaleModeToGlFilter=Yx,t.mixColors=ai,t.mixHexColors=ni,t.mixStandardAnd32BitColors=function(t,e,r){const s=e*((r>>24&255)/255)*255,i=((255&t)<<16)+(65280&t)+(t>>16&255),n=16777215&r;let o;return o=i===oi||n===oi?i+n-oi:ni(i,n,.5),o+(s<<24)},t.multiplyHexColors=function(t,e){return 16777215!==t&&e?16777215!==e&&t?((t>>16&255)*(e>>16&255)/255<<16)+((t>>8&255)*(e>>8&255)/255<<8)+(255&t)*(255&e)/255:t:e},t.nextPow2=dr,t.noiseFrag=Pg,t.noiseWgsl=Rg,t.nonCompressedFormats=cp,t.normalizeExtensionPriority=d,t.nssvg=wh,t.nsxhtml=Eh,t.onRenderMixin=kt,t.parseDDS=Op,t.parseFunctionBody=function(t){const e=t.toString(),r=e.indexOf("{"),s=e.lastIndexOf("}");if(-1===r||-1===s)throw new Error("getFunctionBody: No body found in function definition");return e.slice(r+1,s).trim()},t.parseKTX=Dp,t.path=Xe,t.preloadVideo=qd,t.removeItems=ut,t.removeStructAndGroupDuplicates=_l,t.resetUids=function(){for(const t in lt)delete lt[t]},t.resolveCharacters=ya,t.resolveCompressedTextureUrl=Jp,t.resolveJsonUrl=Jd,t.resolveTextureUrl=Qd,t.resourceToTexture=Es,t.roundPixelsBit=ih,t.roundPixelsBitGl=nh,t.roundedShapeArc=Mo,t.roundedShapeQuadraticCurve=Po,t.sayHello=ob,t.scaleModeToGlFilter=$x,t.setBasisTranscoderPath=function(t){Object.assign(mp,t)},t.setKTXTranscoderPath=function(t){Object.assign(Lp,t)},t.setPositions=mu,t.setProgramName=Za,t.setUvs=xu,t.sortMixin=Bt,t.spritesheetAsset=$r,t.squaredDistanceToLineSegment=ho,t.stripVersion=Qa,t.testImageFormat=Pc,t.testVideoFormat=Gc,t.textStyleToCSS=Mh,t.textureBit=km,t.textureBitGl=Bm,t.textureFrom=As,t.tilingBit=uu,t.tilingBitGl=cu,t.toLocalGlobalMixin=Ft,t.transformVertices=ii,t.triangulateWithHoles=ji,t.uboSyncFunctionsSTD40=z_,t.uboSyncFunctionsWGSL=H_,t.uid=ht,t.uniformParsers=I_,t.unpremultiplyAlpha=function(t){t instanceof Uint8ClampedArray&&(t=new Uint8Array(t.buffer));const e=t.length;for(let r=0;r<e;r+=4){const e=t[r+3];if(0!==e){const s=255.001/e;t[r]=t[r]*s+.5,t[r+1]=t[r+1]*s+.5,t[r+2]=t[r+2]*s+.5}}},t.unsafeEvalSupported=qu,t.updateLocalTransform=function(t,e){const r=e._scale,s=e._pivot,i=e._position,n=r._x,o=r._y,a=s._x,l=s._y;t.a=e._cx*n,t.b=e._sx*n,t.c=e._cy*o,t.d=e._sy*o,t.tx=i._x-(a*t.a+l*t.c),t.ty=i._y-(a*t.b+l*t.d)},t.updateQuadBounds=Yr,t.updateRenderGroupTransform=xy,t.updateRenderGroupTransforms=_y,t.updateTransformAndChildren=yy,t.updateTransformBackwards=Pt,t.updateWorldTransform=function(t,e,r){const s=t.a,i=t.b,n=t.c,o=t.d,a=t.tx,l=t.ty,h=e.a,u=e.b,c=e.c,d=e.d;r.a=s*h+i*c,r.b=s*u+i*d,r.c=n*h+o*c,r.d=n*u+o*d,r.tx=a*h+l*c+e.tx,r.ty=a*u+l*d+e.ty},t.v8_0_0="8.0.0",t.validFormats=Qp,t.validateRenderables=vy,t.vertexGPUTemplate=Bl,t.vertexGlTemplate=Fl,t.viewportFromFrame=function(t,e,r){r||(r=kv);const s=e.pixelWidth,i=e.pixelHeight;return t.x=r.x*s|0,t.y=r.y*i|0,t.width=r.width*s|0,t.height=r.height*i|0,t},t.vkFormatToGPUFormat=Kp,t.warn=n_,t.wrapModeToGlAddress=qx,t}({});!function(t,e,r){var s,i=256,n="random",o=r.pow(i,6),a=r.pow(2,52),l=2*a,h=255;function u(h,u,g){function m(){for(var t=y.g(6),e=o,r=0;t<a;)t=(t+r)*i,e*=i,r=y.g(1);for(;l<=t;)t/=2,e/=2,r>>>=1;return(t+r)/e}var _=[],x=p(function t(e,r){var s,i=[],n=typeof e;if(r&&"object"==n)for(s in e)try{i.push(t(e[s],r-1))}catch(t){}return i.length?i:"string"==n?e:e+"\0"}((u=1==u?{entropy:!0}:u||{}).entropy?[h,f(e)]:null==h?function(){try{var r;return s&&(r=s.randomBytes)?r=r(i):(r=new Uint8Array(i),(t.crypto||t.msCrypto).getRandomValues(r)),f(r)}catch(r){var n=t.navigator,o=n&&n.plugins;return[+new Date,t,o,t.screen,f(e)]}}():h,3),_),y=new c(_);return m.int32=function(){return 0|y.g(4)},m.quick=function(){return y.g(4)/4294967296},m.double=m,p(f(y.S),e),(u.pass||g||function(t,e,s,i){return i&&(i.S&&d(i,y),t.state=function(){return d(y,{})}),s?(r[n]=t,e):t})(m,x,"global"in u?u.global:this==r,u.state)}function c(t){var e,r=t.length,s=this,n=0,o=s.i=s.j=0,a=s.S=[];for(r||(t=[r++]);n<i;)a[n]=n++;for(n=0;n<i;n++)a[n]=a[o=h&o+t[n%r]+(e=a[n])],a[o]=e;(s.g=function(t){for(var e,r=0,n=s.i,o=s.j,a=s.S;t--;)e=a[n=h&n+1],r=r*i+a[h&(a[n]=a[o=h&o+e])+(a[o]=e)];return s.i=n,s.j=o,r})(i)}function d(t,e){return e.i=t.i,e.j=t.j,e.S=t.S.slice(),e}function p(t,e){for(var r,s=t+"",i=0;i<s.length;)e[h&i]=h&(r^=19*e[h&i])+s.charCodeAt(i++);return f(e)}function f(t){return String.fromCharCode.apply(0,t)}if(p(r.random(),e),"object"==typeof module&&module.exports){module.exports=u;try{s=require("crypto")}catch(u){}}else"function"==typeof define&&define.amd?define((function(){return u})):r["seed"+n]=u}("undefined"!=typeof self?self:this,[],Math),function(t,e,r,s){"use strict";function i(){const s=t,i=Math.floor,n=Array.prototype.slice,o=Object.prototype.toString;function a(t){return"[object Object]"==o.call(t)}function l(t){return a(t)}function h(t){return"[object Function]"==o.call(t)}function u(t){return"[object Array]"==o.call(t)}function c(t){return"[object Map]"==o.call(t)}function d(t){return"[object Set]"==o.call(t)}function p(t){return"[object String]"==o.call(t)}function f(t){return"[object Number]"==o.call(t)}function g(t){return"[object Boolean]"==o.call(t)}function m(t){return(t<0?-t:t)%2==0}function _(t){return void 0===t}function x(t){return u(t)||c(t)||a(t)}const y=1.6180339887,b=r?r():Math.seedrandom?new Math.seedrandom:function(){return Math.random()};function v(t,e){return t.forEach((t=>{if(!t[0](t[1]))throw new TypeError(`wanted ${e}`)})),!0}function T(t,e){for(let e,r=0;r<t.length;++r)if(e=t[r],e[0](e[1]))return!0;throw new TypeError(`wanted ${e}`)}function S(t,e,r){if(!t(e))throw new TypeError(`wanted ${r}`);return!0}const w=/(\/|\\\\)([^(\/|\\\\)]+)$/g,E=/(\.[^\.\/\?\\]*)(\?.*)?$/;function A(t,e){let r=E.exec(t);return r&&r[1]?(r=r[1].toLowerCase(),e||(r=r.substring(1))):r="",r}function M(t,e,r){const s=t(e);switch(r.length){case 0:return s;case 1:return s&&t(r[0]);case 2:return s&&t(r[0])&&t(r[1]);case 3:return s&&t(r[0])&&t(r[1])&&t(r[2]);default:return s&&r.every((e=>t(e)))}}let P=0;const R={},O={fun:(t,...e)=>M(h,t,e),str:(t,...e)=>M(p,t,e),undef:(t,...e)=>M(_,t,e),map:(t,...e)=>M(c,t,e),set:(t,...e)=>M(d,t,e),num:(t,...e)=>M(f,t,e),bool:(t,...e)=>M(g,t,e),pos:t=>f(t)&&t>0,neg:t=>f(t)&&t<0,vec:(t,...e)=>M(u,t,e),obj:(t,...e)=>M(a,t,e),notEmpty:t=>C.size(t)>0,isEmpty:t=>0==C.size(t),own:(t,e)=>Object.prototype.hasOwnProperty.call(t,e)},C={error(...t){console.error(...t)},log(...t){console.log(...t)},feq0:t=>t>=-1e-10&&t<=1e-10,feq:(t,e,r=1e-10)=>t>=e-r&&t<=e+r,hexToBin(t){const e={0:"0000",1:"0001",2:"0010",3:"0011",4:"0100",5:"0101",6:"0110",7:"0111",8:"1000",9:"1001",a:"1010",b:"1011",c:"1100",d:"1101",e:"1110",f:"1111",A:"1010",B:"1011",C:"1100",D:"1101",E:"1110",F:"1111"};let r="";for(let s,i=0;i<t.length;++i)(s=e[t[i]])?r+=s:(i=1/0,r=undefined);return r},pack:t=>JSON.stringify(t),unpack:t=>JSON.parse(t),v2:(t=0,e=0)=>[t,e],p2:(t=0,e=0)=>({x:t,y:e}),numOrZero:t=>isNaN(t)?0:t,setVec:(t,...e)=>(e.forEach(((e,r)=>t[r]=e)),t),evenN:(t,e)=>m(t=i(t))?t:e?t+1:t-1,nichts:t=>null==t,echt:t=>null!=t,nor:(t,e)=>null==t?e:t,or:(t,e)=>void 0===t?e:t,toNum(t,e){const r=parseFloat(t);return isNaN(r)&&f(e)?e:r},percentRemain:(t,e,r)=>(t>e&&(t=r?t%e:e),Math.max(0,e-t)/e),splitVerStr(t){const e=(""+(t||"")).split(".").filter((t=>t.length>0));return[this.toNum(e[0],0),this.toNum(e[1],0),this.toNum(e[2],0)]},cmpVerStrs(t,e){let r=this.splitVerStr(""+t),s=this.splitVerStr(""+e);return r[0]>s[0]?1:r[0]<s[0]?-1:r[1]>s[1]?1:r[1]<s[1]?-1:r[2]>s[2]?1:r[2]<s[2]?-1:0},pdef:t=>(t.configurable=!0)&&(t.enumerable=!0)&&t,findFiles:(t,e)=>t.filter((t=>e.indexOf(A(t,1))>-1)),zipMap(t,e,r){let s,i=Math.min(t.length,e.length),n=r||new Map;for(s=0;s<i;++s)n.set(t[s],e[s]);return n},zip(t,e,r){return this.zipMap(t,e,r)},zipObj(t,e,r){let s,i=Math.min(t.length,e.length),n=r||{};for(s=0;s<i;++s)n[t[s]]=e[s];return n},partition(t,e){const r=[];for(let s,i,n=0;;){for(s=[],i=0;i<t;++i){if(!(n<e.length)){i=-1;break}s.push(e[n++])}if(s.length>0&&r.push(s),i<0)break}return r},keys:t=>c(t)?Array.from(t.keys()):a(t)?Object.keys(t):[],selectNotKeys(t,e){T([[c,t],[a,t]],"map/object");const r=c(t)?new Map:{};return e=this.seq(e),this.doseq(t,((t,s)=>!e.includes(s)&&this.assoc(r,s,t))),r},selectKeys(t,e){T([[c,t],[a,t]],"map/object");const r=c(t)?new Map:{};return this.seq(e).forEach((e=>{c(t)?t.has(e)&&r.set(e,t.get(e)):O.own(t,e)&&(r[e]=t[e])})),r},copyKeys(t,e,r){return T([[c,t],[a,t]],"map/object"),e instanceof Map&&C.assert(t instanceof Map,"expected Map"),this.seq(r).forEach((r=>{c(e)?e.has(r)&&t.set(r,e.get(r)):(O.own(e,r)||void 0!==e[r])&&(t[r]=e[r])})),t},setManyKeys(t,e,r){return T([[c,t],[a,t]],"map/object"),this.seq(e).forEach((e=>{c(t)?t.set(e,r):t[e]=r})),t},clearKeys(t,e){return T([[c,t],[a,t]],"map/object"),this.seq(e).forEach((e=>{c(t)?t.delete(e):delete t[e]})),t},assertNot(t,...e){return this.assert(!t,...e)},assert(t,...e){if(!t)throw 0==e.length?"Assertion!":e.join("");return!0},noSuchKeys(t,e){return!this.some(this.seq(t),(t=>this.has(e,t)?t:null))},randInt2:(t,e)=>t+i(b()*(e-t+1)),randFloat2:(t,e)=>t+b()*(e-t),randMinus1To1:()=>2*(b()-.5),randInt:t=>i(b()*t),rand:(t=!1)=>t?Math.random():b(),randGaussian(t=6){let e,r=0;for(e=0;e<t;++e)r+=this.rand();return r/t},randSign:()=>b()>.5?-1:1,toGoldenRatio(t){let e=t/y,r=e/y;return[this.rounded(e),this.rounded(r)]},inst:(t,e)=>e instanceof t,hashCode(t){let e,r=0;for(e=0;e<t.length;++e)r=Math.imul(31,r)+t.charCodeAt(e);return r},cls(t){try{t.length=0}catch(t){}return t},randSample(t,e=1){let r,s;return 1==e?s=[this.randItem(t)]:0==e?s=[]:e>0&&(r=this.shuffle(t,!1),s=e>=r.length?r:r.slice(0,e)),s},randItem(t,e=!1){let r,s=-1;if(t)switch(t.length){case 0:case 1:r=t[s=0];break;case 2:r=t[s=this.randSign()>0?1:0];break;default:r=t[s=i(b()*t.length)]}return e?[r,s]:r},isPerc:t=>p(t)&&t.match(/^([0-9])(\.?[0-9]+|[0-9]*)%$/),isEven:t=>m(t),jsMap(...t){S(m,t.length,"even n# of args");let e,r=new Map;for(e=0;e<t.length;)r.set(t[e],t[e+1]),e+=2;return r},jsObj(...t){S(m,t.length,"even n# of args");let e,r={};for(e=0;e<t.length;)r[t[e]]=t[e+1],e+=2;return r},jsVec:(...t)=>0==t.length?[]:t.slice(),lastIndex:t=>u(t)&&t.length>0?t.length-1:-1,first(t){if(u(t)&&t.length>0)return t[0]},last(t){if(u(t)&&t.length>0)return t[t.length-1]},head(t){return this.first(t)},tail(t){return this.last(t)},floor:t=>Math.floor(t),ceil:t=>Math.ceil(t),abs:t=>Math.abs(t),sqrt:t=>Math.sqrt(t),min:(...t)=>Math.min(...t),max:(...t)=>Math.max(...t),slice:(t,e)=>n.call(t,e),every(t,e){S(u,t,"array");for(let r=0;r<t.length;++r)if(h(e)){if(!e(t[r]))return!1}else if(t[r]!=e)return!1;return t.length>0},notAny(t,e){S(u,t,"array");for(let r=0;r<t.length;++r)if(h(e)){if(e(t[r]))return!1}else if(t[r]===e)return!1;return t.length>0},copy(t,e=[]){v([[u,t],[u,e]],"arrays");let r,s=Math.min(t.length,e.length);for(r=0;r<s;++r)t[r]=e[r];return t},append(t,e=[],r=!1){v([[u,t],[u,e]],"arrays"),r&&(t.length=0);for(let r=0;r<e.length;++r)t.push(e[r]);return t},fill(t,e,...r){if(f(t)&&(t=new Array(t)),u(t))for(let s=0;s<t.length;++s)t[s]=h(e)?e(s,...r):e;return t},size(t){return u(t)||p(t)?t.length:d(t)||c(t)?t.size:t?this.keys(t).length:0},nextId:()=>++P,now:()=>Date.now(),fileExt:t=>A(t),fileBase(t){let e,r,s=t.indexOf("?");return s>0&&(t=t.substring(0,s)),t=t.replace(/(\/|\\\\)$/,""),r=w.exec(t),e="",r&&(e=r[2],s=e.lastIndexOf("."),s>0&&(e=e.substring(0,s))),e},range(t,e,r=1){1==arguments.length&&(e=t,t=0,r=1);let s=(e-t)/r;const i=[];s=Math.ceil(s),s=Math.max(0,s),i.length=s;for(let e=0;e<s;++e)i[e]=t,t+=r;return i},shuffle(t,e=!0){S(u,t,"array");const r=n.call(t,0);switch(r.length){case 0:case 1:break;case 2:if(this.randSign()>0){let t=r[0];r[0]=r[1],r[1]=t}break;default:for(let t,e,s=r.length-1;s>0;--s)e=i(b()*(s+1)),t=r[s],r[s]=r[e],r[e]=t}return e?this.copy(t,r):r},shuffle2(t,e=!0){S(u,t,"array");const r=n.call(t,0);switch(r.length){case 0:case 1:break;case 2:if(this.randSign()>0){let t=r[0];r[0]=r[1],r[1]=t}break;default:for(let t,e,s=0,n=r.length;s<n;++s)e=s+i(b()*(n-s)),t=r[e],r[e]=r[s],r[s]=t}return e?this.copy(t,r):r},shuffle3(t,e=!0){return(e?t:n.call(t,0)).sort(((t,e)=>this.rand()>.5?-1:this.rand()>.5?1:0))},uniq:t=>(S(u,t,"array"),Array.from(new Set(t))),map(t,e,r){if(S(x,t,"array/map/object"),u(t))return t.map(e,r);{const s=c(t)?new Map:{};return this.doseq(t,((i,n)=>{this.assoc(s,n,e.call(r,i,n,t))})),s}},find(t,e,r){let s,i=!0,o=n.call(arguments,3);return this.doseq(t,((t,n)=>{i&&e.apply(r,[t,n].concat(o))&&(s=[n,t],i=!1)})),s},some(t,e,r){let s,i=!0,o=n.call(arguments,3);return this.doseq(t,((t,n)=>{i&&(s=e.apply(r,[t,n].concat(o)),s?i=!1:s=void 0)})),s},equals(t,e){if(l(t)&&l(e)){let r,s,i=Object.keys(t),n=Object.keys(e);if(i.length==n.length){for(let o=0;o<i.length;++o)if(r=i[o],s=n[o],!this.equals(r,s)||!this.equals(t[r],e[s]))return!1;return!0}return!1}if(u(t)&&u(e)){if(t.length==e.length){for(let r=0;r<t.length;++r)if(!this.equals(t[r],e[r]))return!1;return!0}return!1}if(f(t)&&f(e))return t==e;if(p(t)&&p(e))return t==e;if(g(t)&&g(e))return t==e;if(null===t&&null===e)return!0;if(void 0===t&&void 0===e)return!0;throw Error("cant call equals for these types")},invoke(t,e){let r=n.call(arguments,2);u(t)&&t.forEach((t=>t[e].apply(t,r)))},delay:(t,e)=>setTimeout(e,t),timer:(t,e=0,r=!1)=>({repeat:!!r,id:r?setInterval(t,e):setTimeout(t,e)}),clear(t){t&&t.id?(t.repeat?clearInterval(t.id):clearTimeout(t.id),t.id=0):O.pos(t)&&clearTimeout(t)},dotimes(t,e,r,...s){for(let i=0;i<t;++i)e.call(r,i,...s)},rseq(t,e,r){if(S(u,t,"array"),t.length>0)for(let s=t.length-1;s>=0;--s)e.call(r,t[s],s,t)},doseq(t,e,r){u(t)?t.forEach(e,r):c(t)?t.forEach(((s,i)=>e.call(r,s,i,t))):a(t)&&Object.keys(t).forEach((s=>e.call(r,t[s],s,t)))},doseqEx(t,e,r){this.doseq(t,((s,i)=>null!=s&&e.call(r,s,i,t)))},dissoc(t,e){if(arguments.length>2){let e,r=1;for(;r<arguments.length;++r)e=this.dissoc(t,arguments[r]);return e}{let r;return c(t)?(r=t.get(e),t.delete(e)):a(t)&&(r=t[e],delete t[e]),r}},get(t,e){if(void 0!==e){if(c(t))return t.get(e);if(t)return t[e]}},assoc(t,e,r){if(arguments.length>3){if((arguments.length-1)%2!=0)throw"wanted even count of args";let e,r=1;for(;r<arguments.length;)e=this.assoc(t,arguments[r],arguments[r+1]),r+=2;return e}{let s;return c(t)?(s=t.get(e),t.set(e,r)):t&&(s=t[e],t[e]=r),s}},disj(t,e){const r=t?t.indexOf(e):-1;return r>-1&&t.splice(r,1),r>-1},conj:(t,...e)=>(t&&e.forEach((e=>t.push(e))),t),seq:(t,e=/[,; \t\n]+/)=>("string"==typeof t&&(t=t.split(e).map((t=>t.trim())).filter((t=>t.length>0))),u(t)||(t=[t]),t),has(t,e){return 1!=arguments.length&&(c(t)?t.has(e):u(t)?-1!=t.indexOf(e):!!a(t)&&O.own(t,e))},patch(t,e){return S(a,t=t||{},"object"),e&&Object.keys(e).forEach((r=>{this.has(t,r)||(t[r]=e[r])})),t},clone(t){return t?this.unpack(this.pack(t)):t},inject:(t,...e)=>(t=t||{},e.forEach((e=>e&&function(t,e){let r=Object.keys(e).reduce(((t,r)=>(t[r]=Object.getOwnPropertyDescriptor(e,r),t)),{});return Object.getOwnPropertySymbols(e).forEach((t=>{let s=Object.getOwnPropertyDescriptor(e,t);s.enumerable&&(r[t]=s)})),Object.defineProperties(t,r)}(t,e))),t),deepCopyArray(t){S(u,t,"array");let e,r,s=[];for(e=0,r=t.length;e<r;++e)s[e]=u(t[e])?this.deepCopyArray(t[e]):t[e];return s},mergeEx(t,e){return this.merge(this.merge({},t),e)},merge(t,e){let r;return Object.keys(e).forEach((s=>{r=e[s],"object"==typeof r&&null!==r&&t[s]?("object"!=typeof t[s]&&(t[s]=r instanceof Array?[]:{}),this.merge(t[s],r)):t[s]=r})),t},throttle(t,e,r){let s=!0,i=!0;if("function"!=typeof t)throw new TypeError("Expected a function");return a(r)&&(s="leading"in r?!!r.leading:s,i="trailing"in r?!!r.trailing:i),this.debounce(t,e,{leading:s,trailing:i,maxWait:e})},debounce(t,e,r){let i,n,o,a,h,u,c=0,d=!1,p=!1,f=!0;const g=!e&&0!==e&&"function"==typeof s.requestAnimationFrame;if("function"!=typeof t)throw new TypeError("Expected a function");function m(e){const r=i,s=n;return i=n=void 0,c=e,a=t.apply(s,r),a}function _(t,e){return g?(s.cancelAnimationFrame(h),s.requestAnimationFrame(t)):setTimeout(t,e)}function x(t){const r=t-u;return void 0===u||r>=e||r<0||p&&t-c>=o}function y(){const t=Date.now();if(x(t))return b(t);h=_(y,function(t){const r=t-c,s=e-(t-u);return p?Math.min(s,o-r):s}(t))}function b(t){return h=void 0,f&&i?m(t):(i=n=void 0,a)}function v(...t){const r=Date.now(),s=x(r);if(i=t,n=this,u=r,s){if(void 0===h)return function(t){return c=t,h=_(y,e),d?m(t):a}(u);if(p)return h=_(y,e),m(u)}return void 0===h&&(h=_(y,e)),a}return e=+e||0,l(r)&&(d=!!r.leading,p="maxWait"in r,o=p?Math.max(+r.maxWait||0,e):o,f="trailing"in r?!!r.trailing:f),v.cancel=function(){void 0!==h&&function(t){if(g)return s.cancelAnimationFrame(t);clearTimeout(t)}(h),c=0,i=u=n=h=void 0},v.flush=function(){return void 0===h?a:b(Date.now())},v.pending=function(){return void 0!==h},v},negate:t=>(S(h,t,"function"),function(...e){return!t.apply(this,e)}),strPadRight:(t,e,r)=>(e-=t.length)>0?t+new Array(Math.ceil(e/r.length)+1).join(r).substr(0,e):t,strPadLeft:(t,e,r)=>(e-=t.length)>0?new Array(Math.ceil(e/r.length)+1).join(r).substr(0,e)+t:t,safeSplit:(t,e)=>(t||"").trim().split(e).filter((t=>t.length>0)),capitalize:t=>t.charAt(0).toUpperCase()+t.slice(1),prettyNumber(t,e=2,r="0"){return this.strPadLeft(Number(t).toString(),e,r)},prettyMillis(t){let e,r,s=i(t/1e3);r=i(s/60),t-=1e3*s,s-=60*r,e=i(r/60),r-=60*e;let n=[];return n.push(`${s}.${t} secs`),(r>0||e>0)&&n.push(`${r} mins, `),e>0&&n.push(`${e} hrs, `),n.reverse().join("")},swap(t,e,r){let s=t[e];return t[e]=t[r],t[r]=s,t},listIndexesOf(t,e){let r=C.fill(t.length,(t=>t));return e?this.shuffle(r):r},dropArgs:(t,e)=>t.length>e?n.call(t,e):[],isSSL:()=>t&&t.location&&t.location.protocol.indexOf("https")>=0,isMobile:t=>t&&/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(t.userAgent),isSafari:t=>t&&/Safari/.test(t.userAgent)&&/Apple Computer/.test(t.vendor),isCrossOrigin(e){let r=t;if(2==arguments.length&&911==arguments[1].hack&&(r=arguments[1]),r&&r.location&&e){const t=e.indexOf("://");if(t>0){let s=e.indexOf("/",t+3);return(s<0?e:e.substring(0,s))!=r.location.origin}}},addEvent(t,e,r,s){u(t)&&1==arguments.length?t.forEach((t=>this.addEvent.apply(this,t))):e.addEventListener(t,r,s)},delEvent(t,e,r,s){u(t)&&1==arguments.length?t.forEach((t=>this.delEvent.apply(this,t))):e.removeEventListener(t,r,s)},rounded(t){return this.roundUnderOffset(t,.5)},roundUnderOffset(t,e){const r=i(t);return t-r<e?r:r+1}},I={qSelector:t=>e.querySelectorAll(t),qId:t=>e.getElementById(t),parent(t){if(t)return t.parentNode},conj:(t,e)=>t.appendChild(e),byTag:(t,r)=>p(r)?e.getElementsByTagNameNS(r,t):e.getElementsByTagName(id),attrs(t,e){return!a(e)&&e?(arguments.length>2&&t.setAttribute(e,arguments[2]),t.getAttribute(e)):(e&&C.doseq(e,((e,r)=>t.setAttribute(r,e))),t)},css(t,e){return!a(e)&&e?(arguments.length>2&&(t.style[e]=arguments[2]),t.style[e]):(e&&C.doseq(e,((e,r)=>t.style[r]=e)),t)},wrap(t,e){const r=t.parentNode;return e.appendChild(t),r.appendChild(e),e},newElm(t,r,s){const i=e.createElement(t);return this.attrs(i,r),this.css(i,s),i},newTxt(t,r,s){const i=e.createTextNode(t);return this.attrs(i,r),this.css(i,s),i}},G={},k=[];class B{constructor(){this._tree=new Map,this._targets=new Map}sub(t,e,r,s){let i=t[0],n=t[1];return n&&!this._targets.has(n)&&this._targets.set(n,1),C.seq(i).forEach((t=>{if(e||(e=t),p(e)&&(e=(r=r||n)[e]),!e)throw"Error: no callback for sub()";this._tree.has(t)||this._tree.set(t,C.jsMap());let i=this._tree.get(t);n=n||G,!i.has(n)&&i.set(n,[]),i.get(n).push([e,r,s])})),this}pub(t,...e){let r,s,i=t[0],n=t[1]||G;return(n===G||this._targets.has(n))&&C.seq(i).forEach((t=>{s=this._tree.get(t),r=s&&s.get(n),r&&r.forEach((t=>{t[0].apply(t[1],e.concat(t[2]||k))}))})),this}reset(){return this._targets.clear(),this._tree.clear(),this}drop(t){if(this._targets.has(t)){this._targets.delete(t);let e=this._tree.values();for(let r=e.next();!r.done;)r.value.delete(t),r=e.next()}return this}unsub(t,e,r){if(1!=arguments.length||O.vec(t)){let s=t[0],i=t[1]||G;if(i===G||this._targets.has(i)){let t,n;C.seq(s).forEach((s=>{if(t=this._tree.get(s),n=t&&t.get(i),n&&(p(e)&&(e=(r=r||i)[e]),e))for(let t=n.length-1;t>=0;--t)n[t][0]===e&&n[t][1]===r&&n.splice(t,1)}))}}else this.drop(t);return this}}return e?R.dom=I:(delete C.addEvent,delete C.delEvent),R.EventBus=function(){return new B},R.is=O,R.u=C,R}"object"==typeof module&&module.exports?r=require("../tpcl/seedrandom.min"):e=t.document,"object"==typeof module&&module.exports?module.exports=i():t["io/czlab/mcfud/core"]=i}(this),function(t,e){"use strict";function r(e){e||(e=t["io/czlab/mcfud/core"]());const r=360,s=2*Math.PI,i=(Math.PI,Math.floor),{is:n,u:o}=e,a=t=>t<0?- -t%r:t%r;return{lerp:(t,e,r)=>(1-r)*t+r*e,xmod:(t,e)=>t<0?t- -(e+e*i(-t/e)):t%e,ndiv:(t,e)=>i(t/e),pow:(t,e)=>0==e?1:1==e?t:2==e?t*t:3==e?t*t*t:Math.pow(t,e),pow2(t){let e=2;for(;t>e;)e*=2;return e},clamp:(t,e,r)=>r<t?t:r>e?e:r,sqr:t=>t*t,fuzzyEq:(t,e)=>o.feq(t,e),fuzzyZero:t=>o.feq0(t),radToDeg:t=>a(r*t/s),degToRad:t=>s*a(t)/r,pythag2:(t,e)=>t*t+e*e,pythag:(t,e)=>Math.sqrt(t*t+e*e),wrap:(t,e)=>(t+1)%e,biasGreater:(t,e)=>t>=.95*e+.01*t,remap(t,e,r,s,i,n){const o=(t-e)/(r-e)*(i-s)+s;return n?s<i?this.clamp(s,i,o):this.clamp(i,s,o):o},perlin1D(t,e,r,s,n){let o,a,l,h,u,c,d,p;for(let f=0;f<t;++f){o=0,a=0,l=1;for(let n=0;n<r;++n)h=t>>n,u=i(f/h)*h,c=(u+h)%t,d=(f-u)/h,p=(1-d)*e[i(u)]+d*e[i(c)],a+=l,o+=p*l,l/=s;n[f]=o/a}},perlin2D(t,e,r,s,n,o){let a,l,h,u,c,d,p,f,g,m,_,x;for(let y=0;y<t;++y)for(let b=0;b<e;++b){a=0,l=0,h=1;for(let o=0;o<s;++o)f=t>>o,g=i(y/f)*f,m=i(b/f)*f,_=(g+f)%t,x=(m+f)%e,u=(y-g)/f,c=(b-m)/f,d=(1-u)*r[i(m*t+g)]+u*r[i(m*t+_)],p=(1-u)*r[i(x*t+g)]+u*r[i(x*t+_)],l+=h,a+=(c*(p-d)+d)*h,h/=n;o[b*t+y]=a/l}}}}"object"==typeof module&&module.exports?module.exports=r(require("./core")):t["io/czlab/mcfud/math"]=r}(this),function(t,e){"use strict";function r(e){e||(e=t["io/czlab/mcfud/core"]());const{u:r,is:s}=e,i=(t,e)=>r.assert(!s.num(t)&&!s.num(e)&&t&&e,"wanted 2 vecs"),n=(t,e=0,r=0)=>t?[e,r]:{x:e,y:r},o={};class a{constructor(){this.x=0,this.y=0}unit(t){return s.bool(t)&&(t=n(t)),s.vec(t)?(t[0]=this.x,t[1]=this.y):(t.x=this.x,t.y=this.y),t}bind(t){return s.vec(t)?(this.x=t[0],this.y=t[1]):(this.x=t.x,this.y=t.y),this}op(t,e,r){let i=o.take();switch(i.x=this.x,i.y=this.y,t){case"+":s.num(e)&&(i.x+=e),s.num(r)&&(i.y+=r);break;case"-":s.num(e)&&(i.x-=e),s.num(r)&&(i.y-=r);break;case"*":s.num(e)&&(i.x*=e),s.num(r)&&(i.y*=r);break;case"/":s.num(e)&&(i.x/=e),s.num(r)&&(i.y/=r)}return i}"+"(t){return this.op("+",t.x,t.y)}"-"(t){return this.op("-",t.x,t.y)}"*"(t){return this.op("*",t.x,t.y)}"/"(t){return this.op("/",t.x,t.y)}}function l(t,e,r,i,n,o,a){const l=t-n,h=e-o,u=n+(l*r-h*i),c=o+(l*i+h*r);return s.vec(a)?(a[0]=u,a[1]=c):(a.x=u,a.y=c),a}function h(t,e,r,i){let n,a,l=o.take().bind(t);if(s.num(e))a=l.op(r,e,e);else{let t=o.take().bind(e);a=l[r](t),o.drop(t)}return n=a.unit(i?t:s.vec(t)),o.drop(l,a),n}return r.inject(o,{take(){return this._pool.pop()},drop(...t){t.forEach((t=>{t.x=0,t.y=0,this._pool.push(t)}))},_pool:r.fill(16,(()=>new a))}),{gx:t=>s.vec(t)?t[0]:t.x,sx(t,e){s.vec[t]?t[0]=e:t.x=e},gy:t=>s.vec(t)?t[1]:t.y,sy(t,e){s.vec[t]?t[1]=e:t.y=e},vec:(t=0,e=0)=>n(!0,t,e),vecXY:(t=0,e=0)=>n(!1,t,e),add(t,e){return r.assert(2==arguments.length)&&h(t,e,"+")},add$(t,e){return r.assert(2==arguments.length)&&h(t,e,"+",!0)},sub(t,e){return r.assert(2==arguments.length)&&h(t,e,"-")},sub$(t,e){return r.assert(2==arguments.length)&&h(t,e,"-",!0)},mul(t,e){return r.assert(2==arguments.length)&&h(t,e,"*")},mul$(t,e){return r.assert(2==arguments.length)&&h(t,e,"*",!0)},div(t,e){return r.assert(2==arguments.length)&&h(t,e,"/")},div$(t,e){return r.assert(2==arguments.length)&&h(t,e,"/",!0)},dot(t,e){i(t,e);let r=o.take().bind(t),s=o.take().bind(e),n=r.x*s.x+r.y*s.y;return o.drop(r,s),n},equals(t,e){let r=o.take().bind(t),s=o.take().bind(e),i=r.x==s.x&&r.y==s.y;return o.drop(r,s),i},vecAB(t,e){i(t,e);let r,n=o.take().bind(t),a=o.take().bind(e),l=o.take();return l.x=a.x-n.x,l.y=a.y-n.y,r=l.unit(s.vec(t)),o.drop(n,a,l),r},len2(t){return this.dot(t,t)},len(t){return Math.sqrt(this.len2(t))},dist2(t,e){return this.len2(this.sub(e,t))},dist(t,e){return Math.sqrt(this.dist2(t,e))},unit(t){let e,i=this.len(t),n=o.take().bind(t);return r.feq0(i)?(n.x=0,n.y=0):(n.x/=i,n.y/=i),e=n.unit(s.vec(t)),o.drop(n),e},unit$(t){let e,s=this.len(t),i=o.take().bind(t);return r.feq0(s)?(i.x=0,i.y=0):(i.x/=s,i.y/=s),e=i.unit(t),o.drop(i),e},copy(t,e){i(t,e);let r,s=o.take().bind(t),n=o.take().bind(e);return s.x=n.x,s.y=n.y,r=s.unit(t),o.drop(s,n),r},clone(t){let e=o.take().bind(t),r=e.unit(s.vec(t));return o.drop(e),r},set(t,e,r){let i,n=o.take().bind(t);return s.num(e)&&(n.x=e),s.num(r)&&(n.y=r),i=n.unit(t),o.drop(n),i},setX(t,e){return this.set(t,e)},setY(t,e){return this.set(t,null,e)},rot(t,e,r=null){let i,a,h=0,u=0,c=o.take().bind(t);return r&&(a=o.take().bind(r),h=a.x,u=a.y,o.drop(a)),i=l(c.x,c.y,Math.cos(e),Math.sin(e),h,u,n(s.vec(t))),o.drop(c),i},rot$(t,e,r){let s,i,n=0,a=0,h=o.take().bind(t);return r&&(i=o.take().bind(r),n=i.x,a=i.y,o.drop(i)),s=l(h.x,h.y,Math.cos(e),Math.sin(e),n,a,t),o.drop(h),s},cross(t,e){let r;if(s.num(t)){let i=o.take(),n=o.take().bind(e);i.x=-t*n.y,i.y=t*n.x,r=i.unit(s.vec(e)),o.drop(n,i)}else if(s.num(e)){let i=o.take(),n=o.take().bind(t);i.x=e*n.y,i.y=-e*n.x,r=i.unit(s.vec(t)),o.drop(n,i)}else{i(t,e);let s=o.take().bind(t),n=o.take().bind(e);r=s.x*n.y-s.y*n.x,o.drop(s,n)}return r},angle(t,e){return Math.acos(this.dot(t,e)/(this.len(t)*this.len(e)))},normal(t,e=!1){let r,i=o.take(),n=o.take().bind(t);return e?(i.x=-n.y,i.y=n.x):(i.x=n.y,i.y=-n.x),r=i.unit(s.vec(t)),o.drop(n,i),r},normal$(t,e=!1){let r,s=o.take(),i=o.take().bind(t);return e?(s.x=-i.y,s.y=i.x):(s.x=i.y,s.y=-i.x),r=s.unit(t),o.drop(i,s),r},proj_scalar(t,e){return this.dot(t,e)/this.len(e)},proj(t,e){const r=this.unit(e);this.mul$(r,this.dot(t,r));let i=o.take().bind(r),n=i.unit(s.vec(t));return o.drop(i),n},perp(t,e){return this.sub(t,this.proj(t,e))},reflect(t,e){const r=2*this.dot(t,e);return this.sub(t,this.mul(e,r))},flip(t){return this.mul(t,-1)},flip$(t){return this.mul$(t,-1)},translate(t,...e){let r,i,n,a,l=o.take().bind(t);return 1==e.length&&s.vec(e[0])&&!s.num(e[0][0])&&(e=e[0]),n=e.map((t=>(i=o.take().bind(t),r=i["+"](l),a=r.unit(s.vec(t)),o.drop(i,r),a))),o.drop(l),n},clamp$(t,e,r){const s=this.len(t),i=Math.max(e,Math.min(r,s));return s==i?t:this.mul$(this.div$(t,s||1),i)},clamp(t,e,r){const s=this.len(t),i=Math.max(e,Math.min(r,s));return s==i?t:this.mul(this.div(t,s||1),i)}}}"object"==typeof module&&module.exports?module.exports=r(require("./core")):t["io/czlab/mcfud/vec2"]=r}(this),function(t,e){"use strict";function r(e){e||(e=t["io/czlab/mcfud/core"]()),Math.atan2;const r=Math.cos,s=Math.sin,i=(Math.tan,Math.floor),{u:n,is:o}=e,a=t=>t%2!=0,l=(t,e,r,s)=>s-1+(r-1)*e,h=(t,e,r)=>({cells:r,dim:[t,e]}),u=(t,e)=>h(t,e,n.fill(t*e,0));return{v4:(t=0,e=0,r=0,s=0)=>[t,e,r,s],v3:(t=0,e=0,r=0)=>[t,e,r],dot:(t,e)=>t[0]*e[0]+t[1]*e[1]+t[2]*e[2],cross(t,e){return this.v3(t[1]*e[2]-t[2]*e[1],t[2]*e[0]-t[0]*e[2],t[0]*e[1]-t[1]*e[0])},len2(t){return this.dot(t,t)},len(t){return Math.sqrt(this.len2(t))},unit(t){let e=this.len(t);if(!n.feq0(e))return[t[0]/e,t[1]/e,t[2]/e]},sub(t,e){return o.num(e)?this.v3(t[0]-e,t[1]-e,t[2]-e):this.v3(t[0]-e[0],t[1]-e[1],t[2]-e[2])},add(t,e){return o.num(e)?this.v3(t[0]+e,t[1]+e,t[2]+e):this.v3(t[0]+e[0],t[1]+e[1],t[2]+e[2])},mul(t,e){return o.num(e)?this.v3(t[0]*e,t[1]*e,t[2]*e):this.v3(t[0]*e[0],t[1]*e[1],t[2]*e[2])},div(t,e){return o.num(e)?this.v3(t[0]/e,t[1]/e,t[2]/e):this.v3(t[0]/e[0],t[1]/e[1],t[2]/e[2])},matrix([t,e],...r){const s=t*e;return 0==r.length?u(t,e):n.assert(s==r.length)&&h(t,e,r)},matCell(t,e,r,s){const i=l(t.dim[0],t.dim[1],e,r);if(i>=0&&i<t.cells.length)return o.num(s)?(t.cells[i]=s,t):t.cells[i]},matIdentity(t){const e=n.assert(t>0)&&n.fill(t*t,0);for(let r=0;r<t;++r)e[l(0,t,r+1,r+1)]=1;return h(t,t,e)},matZero:t=>n.assert(t>0)&&h(t,t,n.fill(t*t,0)),matRowMajors(t){const[e,r]=t.dim;return n.partition(r,t.cells)},matColMajors(t){const[e,r]=t.dim,s=[];for(let i,n=0;n<r;++n){i=[];for(let s=0;s<e;++s)i.push(t.cells[s*r+n]);s.push(i)}return s},mat2(t,e,r,s){return this.matrix([2,2],t,e,r,s)},mat3(t,e,r,s,i,n,o,a,l){return this.matrix([3,3],t,e,r,s,i,n,o,a,l)},mat4(t,e,r,s,i,n,o,a,l,h,u,c,d,p,f,g){return this.matrix([4,4],t,e,r,s,i,n,o,a,l,h,u,c,d,p,f,g)},matEq(t,e){return t.dim[0]==e.dim[0]&&t.dim[1]==e.dim[1]&&(r=t.cells,s=e.cells,r.length==s.length&&r.every(((t,e)=>t==s[e]||n.feq(t,s[e]))));var r,s},matXpose(t){const[e,r]=t.dim,s=e*r,n=[];for(let o=0;o<s;++o)n.push(t.cells[i(o/e)+r*(o%e)]);return h(r,e,n)},matScale:(t,e)=>h(t.dim[0],t.dim[1],t.cells.map((t=>t*e))),matMult(t,e){let[r,s]=t.dim,[i,o]=e.dim,a=t.cells,l=e.cells;n.assert(s==i,"mismatch matrices");let u=new Array(r*o);for(let t=0;t<r;++t)for(let e=0;e<o;++e)u[e+t*o]=n.range(i).reduce(((r,i)=>r+a[i+t*s]*l[e+i*o]),0);return h(r,o,u)},matDet(t){let[e,r]=t.dim,s=[];if(2==r)return this._matDet2x2(t);for(let e=0;e<r;++e)n.conj(s,this.matDet(this.matCut(t,1,e+1)));return n.range(r).reduce(((e,r)=>{let i=s[r];return e+t.cells[r]*(a(r)?-i:i)}),0)},_matDet2x2:t=>(n.assert(4===t.cells.length),t.cells[0]*t.cells[3]-t.cells[1]*t.cells[2]),matCut(t,e,r){const[s,i]=t.dim;let o=e-1,a=r-1,l=[];for(let e=0;e<s;++e)for(let r=0;r<i;++r)e!=o&&r!=a&&n.conj(l,t.cells[r+e*i]);return h(s-1,i-1,l)},matMinor(t){const[e,r]=t.dim;let s=[];if(n.assert(e==r),2==r)return this._matMinor2x2(t);for(let i=0;i<e;++i)for(let e=0;e<r;++e)n.conj(s,this.matDet(this.matCut(t,i+1,e+1)));return h(e,r,s)},_matMinor2x2(t){return n.assert(4==t.cells.length)&&this.mat2(t.cells[3],t.cells[2],t.cells[1],t.cells[0])},matCofactor(t){const e=this.matMinor(t),[r,s]=e.dim;let i=e.cells.slice();for(let t=0;t<r;++t)for(let e,r=0;r<s;++r)e=t*s+r,a(t+r)&&(i[e]=-i[e]);return h(r,s,i)},matAdjugate(t){return this.matXpose(this.matCofactor(t))},_minv2x2(t){const[e,r]=t.dim;n.assert(4==t.cells.length&&2==e&&2==r);let s,i=t.cells,o=i[0]*i[3]-i[1]*i[2];if(n.feq0(o))s=this.matIdentity(e);else{let t=1/o;s=this.mat2(i[3]*t,-i[1]*t,-i[2]*t,i[0]*t)}return s},matInv(t){const[e,r]=t.dim;if(2==r)return this._minv2x2(t);let s=this.matDet(t);return n.feq0(s)?this.matIdentity(e):this.matScale(this.matAdjugate(t),1/s)},matFromColMajor(t){let e=t.length,r=t[0].length,s=u(r,e);for(let r,i=0;i<t.length;++i){r=t[i];for(let t=0;t<r.length;++t)s.cells[t*e+i]=r[t]}return s},matToColMajor(t){const[e,r]=t.dim,s=[];t.cells.slice();for(let i,n=0;n<r;++n){i=[];for(let s=0;s<e;++s)i.push(t.cells[s*r+n]);s.push(i)}return s},scale3D(t){const e=this.matIdentity(4);return e.cells[l(0,4,1,1)]=t[0],e.cells[l(0,4,2,2)]=t[1],e.cells[l(0,4,3,3)]=t[2],e},translate3D(t){const e=this.matIdentity(4);return e.cells[l(0,4,4,1)]=t[0],e.cells[l(0,4,4,2)]=t[1],e.cells[l(0,4,4,3)]=t[2],e},rot3D(t,e,r){return this.matMult(this.zRot3D(r),this.matMult(this.yRot3D(e),this.xRot3D(t)))},matVMult(t,e){let r=t.dim[1],s=e.length;n.assert(r==s);let i=this.matMult(t,h(s,1,e)),o=i.cells;return i.cells=null,o},rot2D(t){return this.mat2(r(t),-s(t),s(t),r(t))},xRot3D(t){return this.mat4(1,0,0,0,0,r(t),-s(t),0,0,s(t),r(t),0,0,0,0,1)},yRot3D(t){return this.mat4(r(t),0,s(t),0,0,1,0,0,-s(t),0,r(t),0,0,0,0,1)},zRot3D(t){return this.mat4(r(t),-s(t),0,0,s(t),r(t),0,0,0,0,1,0,0,0,0,1)},isIdentity(t){const[e,r]=t.dim;if(e==r){for(let s,i=0;i<e;++i)for(let e=0;e<r;++e)if(s=t.cells[i*r+e],i+1==e+1){if(1!=s)return!1}else if(0!=s)return!1;return!0}return!1},isOrthogonal(t){let e=this.matDet(t);return 1==Math.abs(e)&&this.isIdentity(this.matMult(this.matXpose(t),this.matInv(t)))}}}"object"==typeof module&&module.exports?module.exports=r(require("./core")):t["io/czlab/mcfud/matrix"]=r}(this),function(t,e){"use strict";const r=" @N/\\Ri2}aP`(xeT4F3mt;8~%r0v:L5$+Z{'V)\"CKIc>z.*fJEwSU7juYg<klO&1?[h9=n,yoQGsW]BMHpXb6A|D#q^_d!-".split(""),s=r.length;function i(e){e||(e=t["io/czlab/mcfud/core"]());const{u:i}=e,n=t=>Math.abs(t)%s,o=t=>r[t],a=t=>r.findIndex((e=>e==t));function l(t,e){let r=e+t;return o(r>=s?r-s:r)}function h(t,e){let r=e-t;return o(r<0?s+r:r)}return{encrypt(t,e){if(0!=e){let r,s=n(e);r=t.split("").map((t=>(r=a(t),r<0?t:((t,e,r)=>t<0?l(e,r):h(e,r))(e,s,r)))),t=r.join("")}return t},decrypt(t,e){if(0!=e){let r,s=n(e);r=t.split("").map((t=>(r=a(t),r<0?t:((t,e,r)=>t<0?h(e,r):l(e,r))(e,s,r)))),t=r.join("")}return t}}}"object"==typeof module&&module.exports?module.exports=i(require("./core")):t["io/czlab/mcfud/crypt"]=i}(this),function(t,e){"use strict";function r(e){return e||(e=t["io/czlab/mcfud/core"]()),{fsm(t){let e=t.initState();return{state:()=>e,process(){const r=t[e];r&&r.run&&r.run()},trigger(r="change",s){const i=t[e],n=i&&i.transitions[r];if(n){const r=n.target,o=t[r];if(o)return i.exit&&i.exit(),o.enter&&o.enter(),s&&s.action?s.action():n.action&&n.action(s),e=r}}}}}}"object"==typeof module&&module.exports?module.exports=r(require("./core")):t["io/czlab/mcfud/fsm"]=r}(this),function(t,e){"use strict";function r(e,r,s,i){e||(e=t["io/czlab/mcfud/core"]()),r||(r=t["io/czlab/mcfud/vec2"]()),s||(s=t["io/czlab/mcfud/math"]()),i||(i=t["io/czlab/mcfud/matrix"]());const n=2*Math.PI,{u:o}=e;return{setContextTransform:(t,e,r=!1)=>(t[r?"setTransform":"transform"](e.cells[0],e.cells[3],e.cells[1],e.cells[4],e.cells[2],e.cells[5]),t),textStyle:(t,e,r,s,i,n)=>(e&&(t.font=e),s&&(t.fillStyle=s),i&&(t.textAlign=i),n&&(t.textBaseline=n),r&&(t.strokeStyle=r),t),drawShape:(t,e,...r)=>(e&&e.draw&&e.draw(t,...r),t),cfgStyle:(t,e,r,s,i)=>(r&&(t.fillStyle=r),e&&(t.strokeStyle=e),i&&(t.lineCap=i),s&&(t.lineWidth=s),t),drawPoints(t,e){t.beginPath();for(let s,i,n,o=e.length,a=0;a<o;++a)n=(a+1)%o,s=e[a],i=e[n],t.moveTo(r.gx(s),r.gy(s)),t.lineTo(r.gx(i),r.gy(i));return t.closePath(),t.stroke(),t},fillPoints(t,e){t.beginPath();for(let s,i,n,o=e.length,a=0;a<o;++a)n=(a+1)%o,s=e[a],i=e[n],0==a?t.moveTo(r.gx(s),r.gy(s)):t.lineTo(r.gx(s),r.gy(s)),t.lineTo(r.gx(i),r.gy(i));return t.closePath(),t.fill(),t},drawCircle:(t,e,r,s)=>(t.beginPath(),t.arc(e,r,s,0,n,!0),t.closePath(),t.stroke(),t),fillCircle:(t,e,r,s)=>(t.beginPath(),t.arc(e,r,s,0,n,!0),t.closePath(),t.fill(),t),drawRect:(t,e,r,s,i,n=0,o=0,a=0)=>(t.save(),t.translate(o,a),t.rotate(n),t.translate(-o,-a),t.strokeRect(e,r,s,i),t.restore(),t),fillRect:(t,e,r,s,i,n=0,o=0,a=0)=>(t.save(),t.translate(o,a),t.rotate(n),t.translate(-o,-a),t.fillRect(e,r,s,i),t.restore(),t),drawLine:(t,e,r,s,i)=>(t.beginPath(),t.moveTo(e,r),t.lineTo(s,i),t.stroke(),t),drawText:(t,e,r,s)=>(t.strokeText(e,r,s),t),fillText:(t,e,r,s)=>(t.fillText(e,r,s),t),clearCanvas(t){return this.clearRect(t,0,0,t.canvas.width,t.canvas.height)},fillCanvas(t){return this.fillRect(t,0,0,t.canvas.width,t.canvas.height)},clearRect:(t,e,r,s,i)=>(t.clearRect(e,r,s,i),t)}}"object"==typeof module&&module.exports?module.exports=r(require("./core"),require("./vec2"),require("./math"),require("./matrix")):t["io/czlab/mcfud/gfx"]=r}(this),function(t,e){"use strict";const[r,s,i]=[1,0,-1];function n(e,n,o,a,l){e||(e=t["io/czlab/mcfud/core"]()),n||(n=t["io/czlab/mcfud/math"]()),o||(o=t["io/czlab/mcfud/vec2"]()),a||(a=t["io/czlab/mcfud/matrix"]()),l||(l=t["io/czlab/mcfud/algo/basic"]());const{Stack:h,StdCompare:u}=l,{is:c,u:d}=(Math.floor,e),p=d.fill(36,void 0);function f(t){d.assert(t.length>2&&t.length<=36,"too little/many vertices");let e=0,r=t[0][0];for(let s,i=1;i<t.length;++i)s=t[i][0],s>r?(r=s,e=i):d.feq(s,r)&&t[i][1]<t[e][1]&&(e=i);let s=0,i=e;for(;;){p[s]=i;let r=0,n=p[s];for(let e,s,a,l=1;l<t.length;++l)r!=i?(e=o.sub(t[r],t[n]),s=o.sub(t[l],t[n]),a=o.cross(e,s),a<0&&(r=l),d.feq0(a)&&o.len2(s)>o.len2(e)&&(r=l)):r=l;if(i=r,++s,r==e)break}const n=[];for(let e=0;e<s;++e)n.push(o.clone(t[p[e]]));return n}class g{constructor(t,e,r,s){switch(arguments.length){case 2:this.pos=o.vec(),this.width=t,this.height=e;break;case 4:this.pos=o.vec(t,e),this.width=r,this.height=s;break;default:throw"Error: bad input to Rect()"}}}class m{constructor(t,e){this.width=t,this.height=e}half(){return new m(n.ndiv(this.width,2),n.ndiv(this.height,2))}}class _{constructor(t,e,r,s){this.p=o.vec(t,e),this.q=o.vec(r,s)}}class b{constructor(t,e=0,r=0){this.pos=o.vec(e,r),this.shape=t}}class v{constructor(){this.orient=0}setOrient(t){throw Error("no implementation")}}class T{constructor(t,e){this.overlapN=o.vec(),this.overlapV=o.vec(),this.A=t,this.B=e,this.clear()}swap(){let t=new T,e=this.AInB,r=this.BInA,s=this.A;return t.overlap=this.overlap,t.A=this.B,t.B=s,t.AInB=r,t.BInA=e,t.overlapN=o.flip(this.overlapN),t.overlapV=o.flip(this.overlapV),t}clear(){return this.overlap=1/0,this.AInB=!0,this.BInA=!0,this}}function S(t,e){let r=1/0,s=-1/0;for(let i,n=0;n<t.length;++n)i=o.dot(t[n],e),i<r&&(r=i),i>s&&(s=i);return[r,s]}function w(t,e){let n=o.len2(t),a=o.dot(e,t);return a<0?r:a>n?i:s}function E(t,e,r,s,i,n){let[a,l]=S(e,i),[h,u]=S(s,i),c=o.vecAB(t,r),d=o.dot(c,i);if(h+=d,u+=d,a>u||h>l)return!0;if(n){let t=0;if(a<h)if(n.AInB=!1,l<u)t=l-h,n.BInA=!1;else{let[e,r]=[l-h,u-a];t=e<r?e:-r}else if(n.BInA=!1,l>u)t=a-u,n.AInB=!1;else{let[e,r]=[l-h,u-a];t=e<r?e:-r}let e=Math.abs(t);e<n.overlap&&(n.overlap=e,o.copy(n.overlapN,i),t<0&&o.flip$(n.overlapN))}}function A(t,e,r){let s,i=t.shape.radius+e.shape.radius,n=o.vecAB(t.pos,e.pos),a=o.len2(n),l=!(a>i*i);return l&&r&&(s=Math.sqrt(a),r.A=t,r.B=e,r.overlap=i-s,o.copy(r.overlapN,o.unit$(n)),o.copy(r.overlapV,o.mul(n,r.overlap)),r.AInB=t.shape.radius<=e.shape.radius&&s<=e.shape.radius-t.shape.radius,r.BInA=e.shape.radius<=t.shape.radius&&s<=t.shape.radius-e.shape.radius),l}function M(t,e,s){let n,a=e.shape.radius*e.shape.radius,l=o.vecAB(t.pos,e.pos),h=t.shape.calcPoints,u=o.vec();for(let c,d,p,f,g=h.length,m=0;m<g;++m){c=m==g-1?0:m+1,d=0==m?g-1:m-1,p=0,f=null,o.copy(u,t.shape.edges[m]),n=o.vecAB(h[m],l),s&&o.len2(n)>a&&(s.AInB=!1);let _=w(u,n);if(_===r){if(o.copy(u,t.shape.edges[d]),_=w(u,o.vecAB(h[d],l)),_===i){let t=o.len(n);if(t>e.shape.radius)return!1;s&&(s.BInA=!1,f=o.unit(n),p=e.shape.radius-t)}}else if(_===i){if(o.copy(u,t.shape.edges[c]),o.sub$(o.copy(n,l),h[c]),_=w(u,n),_===r){let t=o.len(n);if(t>e.shape.radius)return!1;s&&(s.BInA=!1,f=o.unit(n),p=e.shape.radius-t)}}else{let t=o.unit$(o.normal(u)),r=o.dot(n,t),i=Math.abs(r);if(r>0&&i>e.shape.radius)return!1;s&&(f=t,p=e.shape.radius-r,(r>=0||p<2*e.shape.radius)&&(s.BInA=!1))}f&&s&&Math.abs(p)<Math.abs(s.overlap)&&(s.overlap=p,o.copy(s.overlapN,f))}return s&&(s.A=t,s.B=e,o.mul$(o.copy(s.overlapV,s.overlapN),s.overlap)),!0}function P(t,e,r){let s=M(e,t,r);if(s&&r){let t=r.A,e=r.AInB;o.flip$(r.overlapN),o.flip$(r.overlapV),r.A=r.B,r.B=t,r.AInB=r.BInA,r.BInA=e}return s}function R(t,e,r){let s=t.shape.calcPoints,i=e.shape.calcPoints;for(let n=0;n<s.length;++n)if(E(t.pos,s,e.pos,i,t.shape.normals[n],r))return!1;for(let n=0;n<i.length;++n)if(E(t.pos,s,e.pos,i,e.shape.normals[n],r))return!1;if(r){if(0==r.overlap||d.feq0(r.overlap))return!1;r.A=t,r.B=e,o.copy(r.overlapV,r.overlapN),o.mul$(r.overlapV,r.overlap)}return!0}class O{static create(){return new O}constructor(){this.identity()}identity(){return this.m=a.matIdentity(3),this}translate(t,e){return this.m=a.matMult(this.m,a.mat3(1,0,t,0,1,e,0,0,1)),this}scale(t,e){return this.m=a.matMult(this.m,a.mat3(t,0,0,0,e,0,0,0,1)),this}shear(t,e){return this.m=a.matMult(this.m,a.mat3(1,t,0,e,1,0,0,0,1)),this}rotateCCW(t,e,r){let s=Math.sin(t),i=Math.cos(t);return void 0!==e&&void 0!==r?(this.translate(-e,-r),this.rotateCCW(t),this.translate(e,r)):this.m=a.matMult(this.m,a.mat3(i,-s,0,s,i,0,0,0,1)),this}rotateCW(t,e,r){let s=Math.sin(t),i=Math.cos(t);return void 0!==e&&void 0!==r?(this.translate(-e,-r),this.rotateCW(t),this.translate(e,r)):this.m=a.matMult(this.m,a.mat3(i,s,0,-s,i,0,0,0,1)),this}transformXY(t,e){let r=[t,e,1];return a.matVMult(this.m,r).length=2,2}transformPoints(t){let e,r=[0,0,1];t.forEach((t=>{c.vec(t)?(r[0]=t[0],r[1]=t[1]):(r[0]=t.x,r[1]=t.y),e=a.matVMult(this.m,r),c.vec(t)?(t[0]=e[0],t[1]=e[1]):(t.x=e[0],t.y=e[1])}))}}class C{constructor(t,e){if(e<t){let r=t;t=e,e=r}d.feq0(t)&&(t=0),d.feq0(e)&&(e=0),this.min=t,this.max=e}min(){return this.min}max(){return this.max}intersects(t){return!(this.max<t.min||t.max<this.min)}contains(t){return this.min<=t&&t<=this.max}length(){return this.max-this.min}static MinEndPtCmp(t,e){return t.min<e.min?-1:t.min>e.min?1:t.max<e.max?-1:t.max>e.max?1:0}static MaxEndPtCmp(t,e){return t.max<e.max?-1:t.max>e.max?1:t.min<e.min?-1:t.min>e.min?1:0}static LenCmp(t,e){let r=t.length(),s=e.length();return r<s?-1:r>s?1:0}static test(){let t=[new C(15,33),new C(45,60),new C(20,70),new C(46,55)];console.log("Unsorted"),t.forEach((t=>console.log(`min=${t.min}, max=${t.max}`))),console.log("Sort by min endpoint"),t.sort(C.MinEndPtCmp),t.forEach((t=>console.log(`min=${t.min}, max=${t.max}`))),console.log("Sort by max endpoint"),t.sort(C.MaxEndPtCmp),t.forEach((t=>console.log(`min=${t.min}, max=${t.max}`))),console.log("Sort by length"),t.sort(C.LenCmp),t.forEach((t=>console.log(`min=${t.min}, max=${t.max}`)))}}class I{static theta(t){return Math.atan2(t[1],t[0])}static angleBetween(t,e){return Math.atan2(e[1]-t[1],e[0]-t[0])}static ccw(t,e,r){let s=(e[0]-t[0])*(r[1]-t[1])-(e[1]-t[1])*(r[0]-t[0]);return s<0?-1:s>0?1:0}static area2(t,e,r){return(e[0]-t[0])*(r[1]-t[1])-(e[1]-t[1])*(r[0]-t[0])}static distTo(t,e){let r=t[0]-e[0],s=t[1]-e[1];return Math.sqrt(r*r+s*s)}static distSqTo(t,e){let r=t[0]-e[0],s=t[1]-e[1];return r*r+s*s}static compareTo(t,e){return t[1]<e[1]?-1:t[1]>e[1]?1:t[0]<e[0]?-1:t[0]>e[0]?1:0}static XOrderCmp(t,e){return t[0]<e[0]?-1:t[0]>e[0]?1:0}static YOrderCmp(t,e){return t[1]<e[1]?-1:t[1]>e[1]?1:0}static ROrderCmp(t,e){let r=t[0]*t[0]+t[1]*t[1]-(e[0]*e[0]+e[1]*e[1]);return r<0?-1:r>0?1:0}static PolarOrderCmp(t){return(e,r)=>{let s=e[0]-t[0],i=e[1]-t[1],n=r[0]-t[0],o=r[1]-t[1];return i>=0&&o<0?-1:o>=0&&i<0?1:d.feq0(i)&&d.feq0(o)?s>=0&&n<0?-1:n>=0&&s<0?1:0:-I.ccw(t,e,r)}}static DistToOrderCmp(t,e){let r=I.distSqTo(t),s=I.distSqTo(e);return r<s?-1:r>s?1:0}static equals(t,e){return e===t||!!e&&t[0]==e[0]&&t[1]==e[1]}static farthestPair(t){let e,r=[0,0],s=[0,0],i=0,n=-1/0,a=I.calcConvexHull(t);if(!1===a||t.length<=1)return!1;if(e=a.length,a.unshift(null),2==e)r=a[1],s=a[2],I.distTo(r,s);else{let t,i=2;for(;I.area2(a[e],a[1],a[i+1])>I.area2(a[e],a[1],a[i]);)++i;t=i;for(let l,h=1;h<=i&&t<=e;++h)for(I.distSqTo(a[h],a[t])>n&&(n=I.distSqTo(a[h],a[t]),o.copy(r,a[h]),o.copy(s,a[t]));t<e&&I.area2(a[h],a[h+1],a[t+1])>I.area2(a[h],a[h+1],a[t]);)++t,l=I.distSqTo(a[h],a[t]),l>n&&(n=I.distSqTo(a[h],a[t]),o.copy(r,a[h]),o.copy(s,a[t]))}return{best1:r,best2:s,bestDistance:Math.sqrt(n)}}static closestPair(t){let e=[0,0],r=[0,0],s=1/0,i=t.slice();const a=t.length;i.sort(I.YOrderCmp),i.sort(I.XOrderCmp);for(let t=0;t<a-1;++t)if(I.equals(i[t],i[t+1]))return o.copy(e,i[t]),o.copy(r,i[t+1]),{bestDistance:0,best1:e,best2:r};let l=i.slice();return function t(i,a,l,h,u){if(u<=h)return 1/0;let c=h+n.ndiv(u-h,2),d=i[c],p=t(i,a,l,h,c),f=t(i,a,l,c+1,u),g=Math.min(p,f);!function(t,e,r,s,i){for(let s=r;s<=i;++s)o.copy(e[s],t[s]);let n=r,a=s+1;for(let l=r;l<=i;++l)n>s?o.copy(t[l],e[a++]):a>i?o.copy(t[l],e[n++]):I.compareTo(e[a],e[n])<0?o.copy(t[l],e[a++]):o.copy(t[l],e[n++])}(a,l,h,c,u);let m=0;for(let t=h;t<=u;++t)Math.abs(a[t][0]-d[0])<g&&o.copy(l[m++],a[t]);for(let t=0;t<m;++t)for(let i,n=t+1;n<m&&l[n][1]-l[t][1]<g;++n)i=I.distTo(l[t],l[n]),i<g&&(g=i,i<s&&(s=g,o.copy(e,l[t]),o.copy(r,l[n])));return g}(i,l,d.fill(a,(()=>[0,0])),0,a-1),{bestDistance:s,best1:e,best2:r}}static calcConvexHull(t){d.assert(t&&t.length>0,"invalid points");let e,r,s,i=t.length,n=d.deepCopyArray(t),a=new h;for(n.sort(I.compareTo),e=n[0],n.shift(),n.sort(I.PolarOrderCmp(e)),n.unshift(e),a.push(n[0]),r=1;r<i&&I.equals(n[0],n[r]);++r);if(r==i)return!1;for(s=r+1;s<i&&0==I.ccw(n[0],n[r],n[s]);++s);a.push(n[s-1]);for(let t,e=s;e<i;++e){for(t=a.pop();I.ccw(a.peek(),t,n[e])<=0;)t=a.pop();a.push(t),a.push(n[e])}let l=new h;for(let t=a.iterator();t.hasNext();)l.push(t.next());i=l.size(),t=[];for(let e=l.iterator();e.hasNext();)t.push(o.clone(e.next()));if(i>2)for(let e=0;e<i;++e)if(I.ccw(t[e],t[(e+1)%i],t[(e+2)%i])<=0)return!1;return t}static test_convexHull(){let t="9230 13137 4096 24064 8192 26112 22016  9344 4440  8028 6505 31422 28462 32343 17152 19200 9561 11599\n               4096 20992 21538  2430 21903 23677 17152 16128 7168 25088 10162 18638 822 32301 16128 12032 18989  3797\n               8192 28160 16128 20224 14080 20224 26112  7296 20367 20436 7486   422 17835  2689 22016  3200 22016  5248\n               24650 16886 15104 20224 25866  4204 13056 15104 13662 10301 17152 20224 15104 12032 6144 20992 26112  3200\n               6144 29184 13056 12032 8128 20992 5076 19172 17152 17152 823 15895 25216  3200 6071 29161 5120 20992\n               10324 22176 29900  9390 27424  7945 4096 23040 12831 27971 29860 12437 28668  2061 1429 12561 29413   596\n               17152 18176 8192 27136 5120 29184 22016 11392 1444 10362 32011  3140 15731 32661 26112  4224 13120 20224\n               30950  2616 4096 22016 4096 25088 24064  3200 26112  5248 4862 30650 5570  8885 21784 18853 23164 32371\n               4160 29184 13056 13056 8192 29184 23040  7296 5120 25088 22016  7296 7168 29184 25216  7296 23040  3200\n               4718  4451 14080 16128 7168 20992 19546 17728 13056 16128 17947 17017 26112  6272 20658  1204 23553 13965\n               13056 14080 14080 12032 24064  7296 21377 26361 17088\n               12032 16128 16128 30875 28560 2542 26201 8192 25088 11444 16973".split(/\s+/).map((t=>+t)),e=[];for(let r=0;r<t.length;r+=2)e.push([t[r],t[r+1]]);e=[[5,15],[5,-20],[-60,10],[70,-10],[-60,-10],[70,10]];let r=I.calcConvexHull(e);!1===r||r.length!=e.length?console.log("not convex!"):r.forEach((t=>{console.log(`${t[0]}, ${t[1]}`)}))}static test_closestPair(){let t="954 11163 1125 11331 1296 11499 1467 11667 1657 11796 1847 11925 2037 12054 2238 12207 2439 12360\n               2640 12513 2878 12523 3116 12533 3354 12543 3518 12493 3682 12443 3846 12393\n               8463 7794 8022 7527 7581 7260 7140 6993 6731 6624 6322 6255 5913 5886\n               5521 5494 5129 5102 4737 4710 4599 5158".split(/\s+/).map((t=>+t)),e=[];for(let r=0;r<t.length;r+=2)e.push([t[r],t[r+1]]);let{bestDistance:r,best1:s,best2:i}=I.closestPair(e);console.log(`bestDist=${r}, p1=${s}, p2=${i}`)}static test_farthestPair(){let t="9230 13137 4096 24064 8192 26112 22016  9344 4440  8028 6505 31422 28462 32343 17152 19200 9561 11599 4096 20992 21538  2430\n               21903 23677 17152 16128 7168 25088 10162 18638 822 32301 16128 12032 18989  3797 8192 28160 16128 20224 14080 20224 26112  7296\n               20367 20436 7486   422 17835  2689 22016  3200 22016  5248 24650 16886 15104 20224 25866  4204 13056 15104 13662 10301 17152 20224\n               15104 12032 6144 20992 26112  3200 6144 29184 13056 12032 8128 20992 5076 19172 17152 17152 823 15895 25216  3200 6071 29161\n               5120 20992 10324 22176 29900  9390 27424  7945 4096 23040 12831 27971 29860 12437 28668  2061 1429 12561 29413   596 17152 18176\n               8192 27136 5120 29184 22016 11392 1444 10362 32011  3140 15731 32661 26112  4224 13120 20224 30950  2616 4096 22016\n               4096 25088 24064  3200 26112  5248 4862 30650 5570  8885 21784 18853 23164 32371 4160 29184 13056 13056 8192 29184 23040  7296\n               5120 25088 22016  7296 7168 29184 25216  7296 23040  3200 4718  4451 14080 16128 7168 20992 19546 17728 13056 16128 17947 17017\n               26112  6272 20658  1204 23553 13965 13056 14080 14080 12032 24064  7296 21377 26361 17088 12032 16128 16128\n               30875 28560 2542 26201 8192 25088 11444 16973".split(/\s+/).map((t=>+t)),e=[];for(let r=0;r<t.length;r+=2)e.push([t[r],t[r+1]]);let{bestDistance:r,best1:s,best2:i}=I.farthestPair(e);console.log(`bestDist=${r}, p1=${s}, p2=${i}`)}}return{Rect:g,Area:m,Line:_,Body:b,Circle:class extends v{constructor(t){super(),this.radius=t}setOrient(t){return this.orient=t,this}},Polygon:class extends v{constructor(t){super(),this.calcPoints=[],this.normals=[],this.edges=[],this.set(t||[])}set(t){return this.calcPoints.length=0,this.normals.length=0,this.edges.length=0,this.points=f(t),this.points.forEach((t=>{this.calcPoints.push(o.vec()),this.edges.push(o.vec()),this.normals.push(o.vec())})),this._recalc()}setOrient(t){return this.orient=t,this._recalc()}moveBy(t,e){return this.points.forEach((r=>{r[0]+=t,r[1]+=e})),this._recalc()}_recalc(){let t=this.points.length;return this.points.forEach(((t,e)=>{o.copy(this.calcPoints[e],t),d.feq0(this.orient)||o.rot$(this.calcPoints[e],this.orient)})),this.points.forEach(((e,r)=>{this.edges[r]=o.sub(this.calcPoints[(r+1)%t],this.calcPoints[r]),this.normals[r]=o.unit(o.normal(this.edges[r]))})),this}},Manifold:T,C2DMatrix:O,Point2D:I,Interval1D:C,Interval2D:class{constructor(t,e){this.x=t,this.y=e}intersects(t){return!!this.x.intersects(t.x)&&!!this.y.intersects(t.y)}contains(t){return x.contains(t[0])&&y.contains(t[1])}area(){return x.length()*y.length()}},bodyWrap:(t,e,r)=>new b(t,e,r),orderVertices:t=>f(t),polyArea(t,e=!1){let r=e?this.orderVertices(t):t,s=0;for(let t,e,i,n=r.length,o=0;o<n;++o)i=(o+1)%n,t=r[o],e=r[i],s+=t[0]*e[1]-e[0]*t[1];return n.ndiv(Math.abs(s),2)},calcPolygonCenter(t,e=!1){const r=e?this.orderVertices(t):t,s=6*this.polyArea(r);let i=0,a=0;for(let t,e,s,n=0,o=r.length;n<o;++n)s=(n+1)%o,t=r[n],e=r[s],i+=(t[0]+e[0])*(t[0]*e[1]-e[0]*t[1]),a+=(t[1]+e[1])*(t[0]*e[1]-e[0]*t[1]);return o.vec(n.ndiv(i,s),n.ndiv(a,s))},getAABB(t){if(d.assert(t instanceof b,"wanted a body"),d.has(t.shape,"radius"))return new g(t.pos[0]-t.shape.radius,t.pos[1]-t.shape.radius,2*t.shape.radius,2*t.shape.radius);{let e=o.translate(t.pos,t.shape.calcPoints),r=e[0][0],s=e[0][1],i=r,n=s;for(let t,o=1;o<e.length;++o)t=e[o],t[0]<r&&(r=t[0]),t[0]>i&&(i=t[0]),t[1]<s&&(s=t[1]),t[1]>n&&(n=t[1]);return new g(r,s,i-r,n-s)}},shiftPoints:(t,e)=>t.map((t=>o.add(t,e))),rotPoints:(t,e,r)=>t.map((t=>o.rot(t,e,r))),calcRectPoints(t,e){const r=t/2,s=e/2;return[o.vec(r,-s),o.vec(r,s),o.vec(-r,s),o.vec(-r,-s)]},line:(t,e,r,s)=>new _(t,e,r,s),rectEqRect:(t,e)=>t.width==e.width&&t.height==e.height&&t.pos[0]==e.pos[0]&&t.pos[1]==e.pos[1],rectContainsRect:(t,e)=>!(t.pos[0]>=e.pos[0]||t.pos[1]>=e.pos[1]||t.pos[0]+t.width<=e.pos[0]+e.width||t.pos[1]+t.height<=e.pos[1]+e.height),rectGetMaxX:t=>t.pos[0]+t.width,rectGetMidX:t=>t.pos[0]+t.width/2,rectGetMinX:t=>t.pos[0],rectGetMaxY:t=>t.pos[1]+t.height,rectGetMidY:t=>t.pos[1]+t.height/2,rectGetMinY:t=>t.pos[1],rectContainsPoint(t,e,r){return e>=this.rectGetMinX(t)&&e<=this.rectGetMaxX(t)&&r>=this.rectGetMinY(t)&&r<=this.rectGetMaxY(t)},rectOverlayRect:(t,e)=>!(t.pos[0]+t.width<e.pos[0]||e.pos[0]+e.width<t.pos[0]||t.pos[1]+t.height<e.pos[1]||e.pos[1]+e.height<t.pos[1]),rectUnion(t,e){const r=Math.min(t.pos[0],e.pos[0]),s=Math.min(t.pos[1],e.pos[1]);return new g(r,s,Math.max(t.pos[0]+t.width,e.pos[0]+e.width)-r,Math.max(t.pos[1]+t.height,e.pos[1]+e.height)-s)},rectIntersection(t,e){if(this.rectOverlayRect(t,e)){const r=Math.max(t.pos[0],e.pos[0]),s=Math.max(t.pos[1],e.pos[1]);return new g(r,s,Math.min(t.pos[0]+t.width,e.pos[0]+e.width)-r,Math.min(t.pos[1]+t.height,e.pos[1]+e.height)-s)}},hitTestPointCircle(t,e,r){d.assert(r instanceof b,"wanted a body");let s=t-r.pos[0],i=e-r.pos[1];return s*s+i*i<=r.shape.radius*r.shape.radius},hitCircleCircle(t,e){d.assert(t instanceof b&&e instanceof b,"need bodies");let r=new T;if(A(t,e,r))return r},hitTestCircleCircle:(t,e)=>(d.assert(t instanceof b&&e instanceof b,"need bodies"),A(t,e,new T)),hitPolygonCircle(t,e){d.assert(t instanceof b&&e instanceof b,"need bodies");let r=new T;if(M(t,e,r))return r},hitTestPolygonCircle:(t,e)=>(d.assert(t instanceof b&&e instanceof b,"need bodies"),M(t,e,new T)),hitCirclePolygon(t,e){d.assert(e instanceof b&&t instanceof b,"need bodies");let r=new T;if(P(t,e,r))return r},hitTestCirclePolygon:(t,e)=>(d.assert(e instanceof b&&t instanceof b,"need bodies"),P(t,e,new T)),hitPolygonPolygon(t,e){d.assert(t instanceof b&&e instanceof b,"need bodies");let r=new T;if(R(t,e,r))return r},hitTestPolygonPolygon:(t,e)=>(d.assert(t instanceof b&&e instanceof b,"need bodies"),R(t,e,new T)),hitTestPointInPolygon(t,e,r){let s;for(let i,n,o=r.length,a=0,l=o-1;a<o;)i=r[a],n=r[l],i[1]>e!=n[1]>e&&t<(n[0]-i[0])*(e-i[1])/(n[1]-i[1])+i[0]&&(s=!s),l=a,++a;return s},hitTestPointPolygon(t,e,r){return d.assert(r instanceof b,"wanted a body"),this.hitTestPointInPolygon(t,e,o.translate(r.pos,r.shape.calcPoints))},hitTestLineCircle(t,e,r,s,i){let n,a=o.sub(e,t),l=[r,s],h=o.sub(l,t),u=o.sub(l,e),c=o.len2(h),d=o.dot(h,a)/o.dot(a,a);return n=d>=0&&d<=1?c-d*d*o.len2(a):d<0?c:o.len2(u),[n<i*i]},hitTestLinePolygon(t,e,r){d.assert(r instanceof b,"wanted a body");let s=o.translate(r.pos,r.shape.calcPoints);for(let r=0,i=0;r<s.length;++r){i=r+1,i==s.length&&(i=0);let[n,o]=this.lineIntersect2D(t,e,s[r],s[i]);if(n)return[n,o]}return[!1]},lineIntersect2D(t,e,r,s){let i,n,o=t[0],a=t[1],l=e[0],h=e[1],u=r[0],c=r[1],p=s[0],f=s[1],g=(o-l)*(c-f)-(a-h)*(u-p);return d.feq0(g)?[!1]:(i=(o-u)*(c-f)-(a-c)*(u-p),i/=g,n=(o-u)*(a-h)-(a-c)*(o-l),n/=g,0<=i&&i<=1&&0<=n&&n<=1?[!0,i,[o+i*(l-o),a+i*(h-a)]]:[!1])},lineIntersection2D(t,e,r,s){if(t[1]>s[1]&&e[1]>s[1]&&t[1]>r[1]&&e[1]>r[1]||e[1]<r[1]&&t[1]<r[1]&&e[1]<s[1]&&t[1]<s[1]||t[0]>s[0]&&e[0]>s[0]&&t[0]>r[0]&&e[0]>r[0]||e[0]<r[0]&&t[0]<r[0]&&e[0]<s[0]&&t[0]<s[0])return[!1,0];let i=(t[1]-r[1])*(s[0]-r[0])-(t[0]-r[0])*(s[1]-r[1]),n=(e[0]-t[0])*(s[1]-r[1])-(e[1]-t[1])*(s[0]-r[0]),o=(t[1]-r[1])*(e[0]-t[0])-(t[0]-r[0])*(e[1]-t[1]),a=(e[0]-t[0])*(s[1]-r[1])-(e[1]-t[1])*(s[0]-r[0]),l=i*n,h=o*a;return l>0&&l<n*n&&h>0&&h<a*a?[!0,i/n]:[!1,0]}}}"object"==typeof module&&module.exports?module.exports=n(require("./core"),require("./math"),require("./vec2"),require("./matrix"),require("../algo/basic")):t["io/czlab/mcfud/geo2d"]=n}(this),function(t,e){"use strict";function r(r,s){r||(r=t["io/czlab/mcfud/core"]()),s||(s=t["io/czlab/mcfud/math"]()),Math.floor;const{u:i,is:n}=r;return{spatialGrid:(t=320,r=320)=>function(t,r){const o=new Map;return{searchAndExec(t,e){let r,s=t.getSpatial();for(let i,n,a=s.y1;a<=s.y2;++a)if(n=o.get(a))for(let o,l,h=s.x1;h<=s.x2;++h)if(i=n.get(h))for(o=i.values(),l=o.next();!l.done;){if(t!==l.value&&(r=e(t,l.value))){h=a=1/0;break}r=null,l=o.next()}return r},search(t,e=!1){let r,s,i=[],n=t.getSpatial();for(let a=n.y1;a<=n.y2;++a)if(s=o.get(a))for(let o=n.x1;o<=n.x2;++o)(r=s.get(o))&&r.forEach((r=>{(r!==t||e)&&i.push(r)}));return i},engrid(e,i){if(!e)return;let n=e.getBBox(),o=e.getSpatial(),a=s.ndiv(n.x1,t),l=s.ndiv(n.y1,r),h=s.ndiv(n.x2,t),u=s.ndiv(n.y2,r);return o.x1==a&&o.x2==h&&o.y1==l&&o.y2==u||(this.degrid(e),o.x1=a,o.x2=h,o.y1=l,o.y2=u,i||this._register(e)),e},reset(){o.clear()},_register(t){let e=t.getSpatial();if(n.num(e.x1))for(let r,s,n=e.y1;n<=e.y2;++n){o.has(n)||o.set(n,new Map),s=o.get(n);for(let n=e.x1;n<=e.x2;++n)s.has(n)||s.set(n,new Map),r=s.get(n),i.assoc(r,t.getGuid(),t)}},degrid(t){if(t){let r=t.getSpatial();if(n.num(r.x1))for(let e,s,n=r.y1;n<=r.y2;++n)if(s=o.get(n))for(let n=r.x1;n<=r.x2;++n)(e=s.get(n))&&i.dissoc(e,t.getGuid());r.x1=e,r.x2=e,r.y1=e,r.y2=e}}}}(t,r)}}"object"==typeof module&&module.exports?module.exports=r(require("./core"),require("./math")):t["io/czlab/mcfud/spatial"]=r}(this),function(t,e){"use strict";function r(e,r){e||(e=t["io/czlab/mcfud/core"]()),r||(r=t["io/czlab/mcfud/math"]()),Math.floor;const{u:s}=e;function i(t,e,o,a,l,h,u){let c=null,d=[],p=r.ndiv(t+e,2),f=r.ndiv(o+a,2);function g(t){function e({x1:t,x2:e,y1:r,y2:s}){let i=[],n=t<p,o=e>p;return r<f&&(n&&i.push(3),o&&i.push(0)),s>f&&(n&&i.push(2),o&&i.push(1)),i}return t.getBBox?e(t.getBBox()):(s.assert(void 0!==t.x1&&void 0!==t.y1&&void 0!==t.x2&&void 0!==t.y2,"wanted bbox for quadtree"),e(t))}const m={x1:t,x2:e,y1:o,y2:a};return{boundingBox:()=>m,subTrees:()=>c,dbg:t=>t(d,c,l,h,u),insert(...r){r.forEach((r=>{c?g(r).forEach((t=>c[t].insert(r))):(d.push(r),d.length>l&&u<h&&(s.assert(null===c),c=[i(p,e,o,f,l,h,u+1),i(p,e,f,a,l,h,u+1),i(t,p,f,a,l,h,u+1),i(t,p,o,f,l,h,u+1)],d.forEach((t=>g(t).forEach((e=>c[e].insert(t))))),d.length=0))}))},remove(t){c?c.forEach((e=>e.remove(t))):s.disj(d,t)},isLeaf:()=>null===c?-1:d.length,prune(){if(c){let t=0,e=0;for(let r,s=0;s<c.length;++s)r=c[s],r.prune(),n=r.isLeaf(),n>=0&&(++t,e+=n);t==c.length&&e<l&&(s.assert(0==d.length,"quadtree wanted zero items"),c.forEach((t=>t._swap(d))),c=null)}},_swap(t){d.forEach((e=>t.push(e))),d.length=0},reset(){d.length=0,c&&c.forEach((t=>t.reset())),c=null},searchAndExec(t,e,r){let s;if(c){let i=g(t);for(let n=0;n<i.length&&(s=c[i[n]].searchAndExec(t,e,r),!s);++n);}else for(let i,n=0;n<d.length&&(i=d[n],r&&i===t||!(s=e(i,t)));++n);return s},search(t,e){const r=new Map,s=[];return e&&r.set(t,null),c&&g(t).forEach((e=>{c[e].search(t).forEach((t=>{r.has(t)||(r.set(t,null),s.push(t))}))})),d.forEach((t=>{r.has(t)||(r.set(t,null),s.push(t))})),r.clear(),s}}}return{quadtree(t,e=12,r=5){const{x1:s,x2:n,y1:o,y2:a}=t;return i(s,n,o,a,e,r,0)}}}"object"==typeof module&&module.exports?module.exports=r(require("./core"),require("./math")):t["io/czlab/mcfud/qtree"]=r}(this),function(t,e){"use strict";function r(r){r||(r=t["io/czlab/mcfud/core"]());const{u:s}=r;class i{constructor(t,r){this.lastBestMove=e,this.state=e,this.other=r,this.cur=t}clone(t){const e=new i;return e.state=t(this.state),e.lastBestMove=this.lastBestMove,e.other=this.other,e.cur=this.cur,e}}function n(t,e,r,s){return t.evalScore(e,r,s)*(1+.001*r)}function o(t,e,r,i,a,l){if(0==r||t.isOver(e))return{depth:r,value:n(t,e,r,i)};let h=e,u=t.getStateCopier(),c=s.shuffle(t.getNextMoves(e));for(let n,d,p=0;p<c.length;++p)if(d=c[p],t.undoMove||(s.assert(u,"Missing state copier!"),e=h.clone(u)),t.makeMove(e,d),n=o(t,e,r-1,i,{value:-l.value,move:l.move},{value:-a.value,move:a.move}),t.undoMove&&t.unmakeMove(e,d),n.value=-n.value,n.move=d,n.value>a.value&&(a={value:n.value,move:d,depth:n.depth}),a.value>=l.value)return l;return JSON.parse(JSON.stringify(a))}function a(t,e,r,i,o,l){if(0==r||t.isOver(e))return[n(t,e,r,i),null];let h=s.shuffle(t.getNextMoves(e)),u=t.getStateCopier(),c=e,d=-1/0,p=h[0];r==i&&(c.lastBestMove=p);for(let n,f,g=0;g<h.length&&(t.undoMove||(s.assert(u,"Missing state copier!"),e=c.clone(u)),f=h[g],t.makeMove(e,f),n=-a(t,e,r-1,i,-l,-o)[0],t.undoMove&&t.unmakeMove(e,f),d<n&&(d=n,p=f),!(o<n&&(o=n,r==i&&(c.lastBestMove=f),o>=l)));++g);return[d,c.lastBestMove]}const l={algo:"negamax",GFrame:i,GameBoard:class{constructor(){}getStateCopier(){}getFirstMove(t){}getNextMoves(t){}evalScore(t){}isStalemate(t){}isOver(t){}unmakeMove(t,e){if(!this.undoMove)throw Error("Need Implementation");this.switchPlayer(t),this.undoMove(t,e)}makeMove(t,e){if(!this.doMove)throw Error("Need Implementation!");this.doMove(t,e),this.switchPlayer(t)}switchPlayer(t){let e=t.cur;t.cur=t.other,t.other=e}getOtherPlayer(t){return t===this.actors[1]?this.actors[2]:t===this.actors[2]?this.actors[1]:void 0}getPlayer(){return this.actors[0]}takeGFrame(){}run(t,e){this.getAlgoActor=()=>e,this.syncState(t,e);let r=this.getFirstMove();return s.nichts(r)&&(r=l.evalNegaMax(this)),r}},XXevalNegaMax(t){const e=t.takeGFrame(),r=t.depth;let[i,n]=a(t,e,r,r,-1/0,1/0);return s.nichts(n)&&console.log(`evalNegaMax: score=${i}, pos= ${n}, lastBestMove=${n}`),n},evalNegaMax(t){const e=t.takeGFrame(),r=t.depth;let{value:i,move:n}=o(t,e,r,r,{value:-1/0},{value:1/0});return s.nichts(n)&&console.log(`evalNegaMax: score= ${i}, pos= ${n}`),n}};return l}"object"==typeof module&&module.exports?module.exports=r(require("./core")):t["io/czlab/mcfud/negamax"]=r}(this),function(t,e){"use strict";function r(r){r||(r=t["io/czlab/mcfud/core"]());const{u:s}=r;class i{constructor(t,r){this.state=e,this.other=r,this.cur=t}clone(t){const e=new i;return e.state=t(this.state),e.other=this.other,e.cur=this.cur,e}}const n=(t,e,r,s)=>t.evalScore(e,r,s);function o(t,r,i,a,l,h,u){if(0==i||t.isOver(r))return[n(t,r,i,a),e];let c=r,d=t.getStateCopier(),p=s.shuffle(t.getNextMoves(r));if(u){let e,n,f=p[0],g=-1/0;for(let m=0;m<p.length&&(t.undoMove||(s.assert(d,"Missing state copier!"),r=c.clone(d)),n=p[m],t.makeMove(r,n),e=o(t,r,i-1,a,l,h,!u)[0],t.undoMove&&t.unmakeMove(r,n),l=Math.max(e,l),e>g&&(g=e,f=n),!(h<=l));++m);return[g,f]}{let e,n,f=p[0],g=1/0;for(let m=0;m<p.length&&(t.undoMove||(s.assert(d,"Missing state copier!"),r=c.clone(d)),n=p[m],t.makeMove(r,n),e=o(t,r,i-1,a,l,h,!u)[0],t.undoMove&&t.unmakeMove(r,n),h=Math.min(e,h),e<g&&(g=e,f=n),!(h<=l));++m);return[g,f]}}const a={algo:"minimax",GFrame:i,GameBoard:class{constructor(){this.aiActor=e}getStateCopier(){}getFirstMove(t){}getNextMoves(t){}evalScore(t,e,r){}isStalemate(t){}isOver(t,e){}unmakeMove(t,e){if(!this.undoMove)throw Error("Need Implementation");this.switchPlayer(t),this.undoMove(t,e)}makeMove(t,e){if(!this.doMove)throw Error("Need Implementation!");this.doMove(t,e),this.switchPlayer(t)}takeGFrame(){}switchPlayer(t){let e=t.cur;t.cur=t.other,t.other=e}getOtherPlayer(t){return t===this.actors[1]?this.actors[2]:t===this.actors[2]?this.actors[1]:void 0}getPlayer(){return this.actors[0]}run(t,e){this.getAlgoActor=()=>e,this.syncState(t,e);let r=this.getFirstMove();return s.nichts(r)&&(r=a.evalMiniMax(this)),r}},evalMiniMax(t){const e=t.takeGFrame(),r=t.depth;let[i,n]=o(t,e,r,r,-1/0,1/0,!0);return s.nichts(n)&&console.log(`evalMiniMax: score=${i}, pos= ${n}`),n}};return a}"object"==typeof module&&module.exports?module.exports=r(require("./core")):t["io/czlab/mcfud/minimax"]=r}(this),function(t,e){"use strict";function r(r){r||(r=t["io/czlab/mcfud/core"]());const s=(t,e)=>t<e?-1:t>e?1:0,i=Math.floor,{is:n,u:o}=r,a=t=>o.assert(n.num(t)||n.str(t),"expected number or string");function l(t,e=" ",r=""){for(;t.hasNext();)r+=`${t.next()}${e}`;return r}class h{constructor(t){this.current=t}hasNext(){return o.echt(this.current)}remove(){throw Error("Unsupported")}next(){if(!this.hasNext())throw Error("NoSuchElementException");let t=this.current.item;return this.current=this.current.next,t}}function u(t,e){return{item:t,next:e}}class c{constructor(){this.first=e,this.n=0}clone(){let t,e=new c,r=this.first;for(;r;)t?(t.next=u(r.item),t=t.next):e.first=t=u(r.item),e.n+=1,r=r.next;return e}isEmpty(){return o.nichts(this.first)}size(){return this.n}add(t){this.first=u(t,this.first),this.n+=1}iter(){return new h(this.first)}static test(){let t=new c;"to be or not to - be - - that - - - is".split(" ").forEach((e=>t.add(e))),console.log("size of bag = "+t.size()),console.log(l(t.iter()));let e=t.clone();console.log("size of cloned = "+e.size()),console.log(l(e.iter()))}}class d{constructor(){this.first=e,this.n=0}clone(){let t,e=new d,r=this.first;for(;r;)t?(t.next=u(r.item),t=t.next):e.first=t=u(r.item),e.n+=1,r=r.next;return e}isEmpty(){return o.nichts(this.first)}size(){return this.n}push(t){this.first=u(t,this.first),this.n+=1}pop(){if(this.isEmpty())throw Error("Stack underflow");let t=this.first.item;return this.first=this.first.next,this.n-=1,t}peek(){if(this.isEmpty())throw Error("Stack underflow");return this.first.item}toString(){return l(this.iter())}iter(){return new h(this.first)}static test(){let t=new d;"to be or not to - be - - that - - - is".split(" ").forEach((e=>{"-"!=e?t.push(e):t.isEmpty()||console.log("(-)"+t.pop()+" ")})),console.log("("+t.size()+" left on stack)");let e=t.clone();console.log("cloned= "+l(e.iter())),console.log("("+e.size()+" left on stack)")}}class p{constructor(){this.first=e,this.last=e,this.n=0}clone(){let t=new p,e=this.first;for(;e;)t.enqueue(e.item),e=e.next;return t}isEmpty(){return o.nichts(this.first)}size(){return this.n}peek(){if(this.isEmpty())throw Error("Queue underflow");return this.first.item}enqueue(t){let e=this.last;this.last=u(t),this.isEmpty()?this.first=this.last:e.next=this.last,this.n+=1}dequeue(){if(this.isEmpty())throw Error("Queue underflow");let t=this.first.item;return this.first=this.first.next,this.n-=1,this.isEmpty()&&(this.last=e),t}toString(){return l(this.iter())}iter(){return new h(this.first)}static test(){let t=new p;"to be or not to - be - - that - - - is".split(/\s+/).forEach((e=>{"-"!=e?t.enqueue(e):t.isEmpty()||console.log(t.dequeue()+" ")})),console.log("("+t.size()+" left on queue)");let e=t.clone();console.log("cloned= "+l(e.iter())),console.log("("+e.size()+" left on queue)")}}class f{constructor(t){this.compare=t||s,this.root=e,this.n=0}size(){return this.n}contains(t){return void 0!==this.get(t)}get(t){const e=(t,r,s)=>{if(r){let i=this.compare(t,r.key);s=i<0?e(t,r.left):i>0?e(t,r.right):r.value}return s};if(a(t)&&this.n>0)return e(t,this.root)}set(t,e){const r=(t,e,s)=>{if(!s)return this.n+=1,{key:t,value:e};let i=this.compare(t,s.key);return i<0?s.left=r(t,e,s.left):i>0?s.right=r(t,e,s.right):s.value=e,s};a(t)&&void 0!==e&&(this.root=r(t,e,this.root))}_getMaxNode(t){for(;t&&t.right;)t=t.right;return t}_getMaxKey(){let t=this._getMaxNode(this.root);if(t)return t.key}_getMinNode(t){for(;t&&t.left;)t=t.left;return t}_getMinKey(){let t=this._getMinNode(this.root);if(t)return t.key}remove(t){const r=(t,s)=>{if(s){let i,n,o,a=this.compare(t,s.key);a<0?s.left=r(t,s.left):a>0?s.right=r(t,s.right):s.left&&s.right?(o=this._getMaxNode(s.left),i=o.key,n=o.value,o.value=s.value,o.key=s.key,s.key=i,s.value=n,s.left=r(t,s.left)):s.left?(s=s.left,this.n-=1):s.right?(s=s.right,this.n-=1):(s=e,this.n-=1)}return s};a(t)&&(this.root=r(t,this.root))}keys(){let t=new p;return this.forEach(((e,r)=>t.enqueue(r))),t.iter()}firstKey(){let t;try{this.forEach(((e,r)=>{throw t=r,Error("????")}))}catch(t){}return t}lastKey(){let t;return this.forEach(((e,r)=>{t=r})),t}forEach(t,e){function r(t,e){return e&&e.apply(t,Array.prototype.slice.call(arguments,2))}!function t(e,s,i,n){if(!e)return r(i,n);t(e.left,s,i,(function(){r(i,s,e.value,e.key),t(e.right,s,i,(function(){r(i,n)}))}))}(this.root,t,e)}static test(){let t=new f;t.set(3,"3"),t.set(2,"2"),t.set(7,"7"),t.set(1,"1"),console.log(`firstKey= ${t.firstKey()}`),console.log(`lastKey= ${t.lastKey()}`),console.log(l(t.keys())),console.log(`k= ${t.get(3)}`),console.log(`has 2 = ${t.contains(2)}`),console.log(`has size = ${t.size()}`),t.remove(1),console.log(`has size = ${t.size()}`),console.log(l(t.keys())),console.log(`k= ${t.get(2)}`)}}class g{constructor(){this.st=new f}get(t){if(o.nichts(t))throw Error("calls get() with null key");return this.st.get(t)}put(t,e){if(o.nichts(t))throw Error("calls put() with null key");void 0===e?this.st.remove(t):this.st.set(t,e)}remove(t){if(o.nichts(t))throw Error("calls remove() with null key");this.st.remove(t)}contains(t){if(o.nichts(t))throw Error("calls contains() with null key");return this.st.contains(t)}size(){return this.st.size()}isEmpty(){return 0==this.size()}keys(){return this.st.keys()}min(){if(this.isEmpty())throw Error("calls min() with empty symbol table");return this.st.firstKey()}max(){if(this.isEmpty())throw Error("calls max() with empty symbol table");return this.st.lastKey()}ceiling(t){if(o.nichts(t))throw Error("argument to ceiling() is null");let e,r,s=this.st.keys();for(;s.hasNext();)if(r=s.next(),r==t||r>t){e=r;break}if(void 0===e)throw Error("argument to ceiling() is too large");return e}floor(t){if(o.nichts(t))throw Error("argument to floor() is null");let e,r,s=this.st.keys();for(;s.hasNext();)r=s.next(),(r==t||r<t)&&(e=r);if(void 0===e)throw Error("argument to floor() is too small");return e}static test(){let t=new g;t.put("a",1),t.put("g",9),t.put("c",3),t.put("j",10),t.put("z",26),t.put("x",24),console.log(`isEmpty= ${t.isEmpty()}`),console.log(`size= ${t.size()}`),console.log(`get-c= ${t.get("c")}`),console.log(`contains z= ${t.contains("z")}`),console.log(`contains m= ${t.contains("m")}`),console.log(l(t.keys())),console.log(`ceil w= ${t.ceiling("w")}`),console.log(`floor k= ${t.floor("k")}`),console.log(`min = ${t.min()}`),console.log(`max = ${t.max()}`),t.remove("x"),console.log(l(t.keys()))}}class m{static M=4;Node(t){return{m:t,children:new Array(m.M)}}Entry(t,e,r){return{key:t,val:e,next:r}}constructor(t){this.root=this.Node(0),this.compare=t,this._height=0,this.n=0}isEmpty(){return 0==this.size()}size(){return this.n}height(){return this._height}get(t){if(o.nichts(t))throw Error("argument to get() is null");return this._search(this.root,t,this._height)}_search(t,e,r){let s=t.children;if(0==r){for(let r=0;r<t.m;++r)if(0==this.compare(e,s[r].key))return s[r].val}else for(let i=0;i<t.m;++i)if(i+1==t.m||this.compare(e,s[i+1].key)<0)return this._search(s[i].next,e,r-1)}put(t,e){if(o.nichts(t))throw Error("argument key to put() is null");let r,s=this._insert(this.root,t,e,this._height);this.n+=1,s&&(r=this.Node(2),r.children[0]=this.Entry(this.root.children[0].key,null,this.root),r.children[1]=this.Entry(s.children[0].key,null,s),this.root=r,this._height+=1)}_insert(t,e,r,s){let i,n=this.Entry(e,r);if(0==s)for(i=0;i<t.m&&!(this.compare(e,t.children[i].key)<0);++i);else for(i=0;i<t.m;++i)if(i+1==t.m||this.compare(e,t.children[i+1].key)<0){let o=this._insert(t.children[i++].next,e,r,s-1);if(!o)return null;n.key=o.children[0].key,n.val=null,n.next=o;break}for(let e=t.m;e>i;--e)t.children[e]=t.children[e-1];if(t.children[i]=n,t.m++,t.m>=m.M)return this._split(t)}_split(t){let e=i(m.M/2),r=this.Node(e);t.m=e;for(let s=0;s<e;++s)r.children[s]=t.children[e+s];return r}toString(){return function t(e,r,s){let i="",n=e.children;if(0==r)for(let t=0;t<e.m;++t)i+=`${s}${n[t].key} ${n[t].val}\n`;else for(let o=0;o<e.m;++o)o>0&&(i+=`${s}(${n[o].key})\n`),i+=t(n[o].next,r-1,s+"     ");return i}(this.root,this._height,"")+"\n"}static test(){let t=new m(s);t.put("www.cs.princeton.edu","128.112.136.12"),t.put("www.cs.princeton.edu","128.112.136.11"),t.put("www.princeton.edu","128.112.128.15"),t.put("www.yale.edu","130.132.143.21"),t.put("www.simpsons.com","209.052.165.60"),t.put("www.apple.com","17.112.152.32"),t.put("www.amazon.com","207.171.182.16"),t.put("www.ebay.com","66.135.192.87"),t.put("www.cnn.com","64.236.16.20"),t.put("www.google.com","216.239.41.99"),t.put("www.nytimes.com","199.239.136.200"),t.put("www.microsoft.com","207.126.99.140"),t.put("www.dell.com","143.166.224.230"),t.put("www.slashdot.org","66.35.250.151"),t.put("www.espn.com","199.181.135.201"),t.put("www.weather.com","63.111.66.11"),t.put("www.yahoo.com","216.109.118.65"),console.log("cs.princeton.edu:  "+t.get("www.cs.princeton.edu")),console.log("hardvardsucks.com: "+t.get("www.harvardsucks.com")),console.log("simpsons.com:      "+t.get("www.simpsons.com")),console.log("apple.com:         "+t.get("www.apple.com")),console.log("ebay.com:          "+t.get("www.ebay.com")),console.log("dell.com:          "+t.get("www.dell.com")),console.log(""),console.log("size:    "+t.size()),console.log("height:  "+t.height()),console.log(t.toString()),console.log("")}}class _{constructor(t){this.d=t,this.st=new g}put(t,e){if(t<0||t>=this.d)throw Error("Illegal index");o.feq0(e)?this.st.remove(t):this.st.put(t,e)}get(t){if(t<0||t>=this.d)throw Error("Illegal index");return this.st.contains(t)?this.st.get(t):0}nnz(){return this.st.size()}dimension(){return this.d}dot(t){if(o.assert(t instanceof _,"expected SparseVector data"),this.d!=t.d)throw Error("Vector lengths disagree");let e,r=0,s=(this.st.size()<=t.st.size()?this:t).st.keys();for(;s.hasNext();)e=s.next(),t.st.contains(e)&&(r+=this.get(e)*t.get(e));return r}dotWith(t){let e=0;for(let r,s=this.st.keys();s.hasNext();)r=s.next(),e+=t[r]*this.get(r);return e}magnitude(){return Math.sqrt(this.dot(this))}scale(t){let e=new _(this.d);for(let r,s=this.st.keys();s.hasNext();)r=s.next(),e.put(r,t*this.get(r));return e}plus(t){if(o.assert(t instanceof _,"expected SparseVector data"),this.d!=t.d)throw Error("Vector lengths disagree");let e=new _(this.d);for(let t,r=this.st.keys();r.hasNext();)t=r.next(),e.put(t,this.get(t));for(let r,s=t.st.keys();s.hasNext();)r=s.next(),e.put(r,t.get(r)+e.get(r));return e}toString(){let t="";for(let e,r=this.st.keys();r.hasNext();)e=r.next(),t+=`(${e}, ${this.st.get(e)}) `;return t}static test(){let t=new _(10),e=new _(10);t.put(3,.5),t.put(9,.75),t.put(6,.11),t.put(6,0),e.put(3,.6),e.put(4,.9),console.log("a = "+t.toString()),console.log("b = "+e.toString()),console.log("a dot b = "+t.dot(e)),console.log("a + b   = "+t.plus(e).toString())}}return{prnIter:l,StdCompare:s,BTree:m,Bag:c,Stack:d,Queue:p,ST:g,TreeMap:f,SparseVector:_,Iterator:h}}"object"==typeof module&&module.exports?module.exports=r(require("../main/core")):t["io/czlab/mcfud/algo/basic"]=r}(this),function(t,e){"use strict";function r(r,s,i){r||(r=t["io/czlab/mcfud/core"]()),s||(s=t["io/czlab/mcfud/math"]()),i||(i=t["io/czlab/mcfud/algo/basic"]());const{prnIter:n,Bag:o,Stack:a,Iterator:l,StdCompare:h}=i,u=Math.floor,{is:c,u:d}=r;function p(t,e,r,s,i){d.assert(t>e,"bad resize capacity");let n,o=new Array(t);for(n=r;n<s;++n)o[n]=i[n];return o}const f=(t,e,r)=>r(t,e)<0;function g(t,e,r){const s=t[e];t[e]=t[r],t[r]=s}function m(t){let e,r="";for(e=0;e<t.length;++e)r+=`${t[e]} `;console.log(r)}class _{static sort(t,e){const r=t.length;for(let s=1;s<r;++s)for(let r=s;r>0&&f(t[r],t[r-1],e);--r)g(t,r,r-1);return t}static sortRange(t,e,r,s){for(let i=e+1;i<r;++i)for(let r=i;r>e&&f(t[r],t[r-1],s);--r)g(t,r,r-1);return t}static indexSort(t,e){const r=t.length,s=d.fill(r,(t=>t));for(let i=1;i<r;++i)for(let r=i;r>0&&f(t[s[r]],t[s[r-1]],e);--r)g(s,r,r-1);return s}static test(){let t="SORTEXAMPLE".split("");m(_.sort(t,h)),t="bed bug dad yes zoo all bad yet".split(" "),m(_.sortRange(t,0,t.length,h)),t="SORTEXAMPLE".split(""),m(_.indexSort(t,h))}}class x{static sort(t,e){let r,i,n,o=t.length;for(let a,l=1;l<o;++l){for(i=0,n=l,a=t[l];i<n;)r=i+s.ndiv(n-i,2),f(a,t[r],e)?n=r:i=r+1;for(let e=l;e>i;--e)t[e]=t[e-1];t[i]=a}return t}static test(){let t="SORTEXAMPLE".split("");m(x.sort(t,h)),t="bed bug dad yes zoo all bad yet".split(" "),m(x.sort(t,h))}}class y{static sort(t,e){let r,s=t.length;for(let i=0;i<s;++i){r=i;for(let n=i+1;n<s;++n)f(t[n],t[r],e)&&(r=n);g(t,i,r)}return t}static test(){let t="SORTEXAMPLE".split("");m(y.sort(t,h)),t="bed bug dad yes zoo all bad yet".split(" "),m(y.sort(t,h))}}class b{static sort(t,e){let r=t.length,i=1,n=s.ndiv(r,3);for(;i<n;)i=3*i+1;for(;i>=1;){for(let s=i;s<r;++s)for(let r=s;r>=i&&f(t[r],t[r-i],e);r-=i)g(t,r,r-i);i=s.ndiv(i,3)}return t}static test(){let t="SORTEXAMPLE".split("");m(b.sort(t,h)),t="bed bug dad yes zoo all bad yet".split(" "),m(b.sort(t,h))}}function v(t,e,r,i,n,o){if(n<=i);else{let a=i+s.ndiv(n-i,2);v(t,e,r,i,a,o),v(t,e,r,a+1,n,o),function(t,e,r,s,i,n,o){for(let t=s;t<=n;++t)r[t]=e[t];let a=s,l=i+1;for(let h=s;h<=n;++h)a>i?e[h]=r[l++]:l>n?e[h]=r[a++]:f(t[r[l]],t[r[a]],o)?e[h]=r[l++]:e[h]=r[a++]}(t,e,r,i,a,n,o)}return t}class T{static sort(t,e){return function t(e,r,i,n,o){if(n<=i);else{let a=i+s.ndiv(n-i,2);t(e,r,i,a,o),t(e,r,a+1,n,o),function(t,e,r,s,i,n){for(let s=r;s<=i;++s)e[s]=t[s];let o=r,a=s+1;for(let l=r;l<=i;++l)o>s?t[l]=e[a++]:a>i?t[l]=e[o++]:f(e[a],e[o],n)?t[l]=e[a++]:t[l]=e[o++]}(e,r,i,a,n,o)}return e}(t,new Array(t.length),0,t.length-1,e),t}static indexSort(t,e){let r=t.length,s=d.fill(r,(t=>t));return v(t,s,new Array(r),0,r-1,e),s}static test(){let t="SORTEXAMPLE".split("");m(T.sort(t,h)),t="bed bug dad yes zoo all bad yet".split(" "),m(T.sort(t,h)),t="SORTEXAMPLE".split(""),m(T.indexSort(t,h))}}class S{static sort(t,e){const r=t.length;for(let s,i=0;i<r;++i){s=0;for(let n=r-1;n>i;--n)f(t[n],t[n-1],e)&&(g(t,n,n-1),++s);if(0==s)break}return t}static test(){let t="bed bug dad yes zoo all bad yet".split(" ");S.sort(t,h),m(t)}}function w(t,e,r,s){let i=e,n=t[e],o=r+1;for(;;){for(;f(t[++i],n,s)&&i!=r;);for(;f(n,t[--o],s)&&o!=e;);if(i>=o)break;g(t,i,o)}return g(t,e,o),o}class E{static sort(t,e){return function t(e,r,s,i){if(s<=r);else{let n=w(e,r,s,i);t(e,r,n-1,i),t(e,n+1,s,i)}return e}(t,0,t.length-1,e),t}static select(t,e,r){if(e<0||e>=t.length)throw Error(`index is not between 0 and ${t.length}: ${e}`);let s=0,i=t.length-1;for(;i>s;){let n=w(t,s,i,r);if(n>e)i=n-1;else{if(!(n<e))return t[n];s=n+1}}return t[s]}static test(){let t="bed bug dad yes zoo all bad yet".split(" ");m(E.sort(t,h)),t="SORTEXAMPLE".split(""),m(E.sort(t,h)),d.shuffle(t),t.forEach(((e,r)=>console.log(E.select(t,r,h))))}}const A=(t,e,r,s)=>f(t[e],t[r],s);class M{Node(t){return{key:t,order:0}}constructor(t,r){this.compare=t,this.table=new Map,this.head=e,this._min=e,this.n=0,c.vec(r)&&r.forEach((t=>this.insert(t)))}isEmpty(){return 0==this.n}size(){return this.n}insert(t){let e=this.Node(t);this.n+=1,this.head=this._insertNode(e,this.head),this._min=this._min?this._greater(this._min.key,t)?this.head:this._min:this.head}min(){if(this.isEmpty())throw Error("Priority queue is empty");return this._min.key}delMin(){if(this.isEmpty())throw Error("Priority queue is empty");this.head=this._cut(this._min,this.head);let t=this._min.child,r=this._min.key;return this._min.key=e,t&&(this.head=this._meld(this.head,t),this._min.child=e),this.n-=1,this.isEmpty()?this._min=e:this._consolidate(),r}union(t){return this.head=this._meld(this.head,t.head),this._min=this._greater(this._min.key,t._min.key)?t._min:this._min,this.n=this.n+t.n,this}_greater(t,e){return!d.nichts(t)&&(!!d.nichts(e)||this.compare(t,e)>0)}_link(t,e){e.child=this._insertNode(t,e.child),e.order+=1}_consolidate(){this.table.clear();let t=this.head,r=e,s=e,i=0;this._min=this.head;do{for(r=t,t=t.next,s=this.table.get(r.order);s;)this.table.delete(r.order),this._greater(r.key,s.key)?(this._link(r,s),r=s):this._link(s,r),s=this.table.get(r.order);this.table.set(r.order,r),r.order>i&&(i=r.order)}while(t!==this.head);this.head=null,this.table.forEach((t=>{t&&(this._min=this._greater(this._min.key,t.key)?t:this._min,this.head=this._insertNode(t,this.head))}))}_insertNode(t,e){return e?(e.prev.next=t,t.next=e,t.prev=e.prev,e.prev=t):(t.prev=t,t.next=t),t}_cut(t,r){if(t.next===t)return t.next=e,t.prev=e,e;{t.next.prev=t.prev,t.prev.next=t.next;let s=t.next;return t.next=e,t.prev=e,r===t?s:r}}_meld(t,e){return t?e?(t.prev.next=e.next,e.next.prev=t.prev,t.prev=e,e.next=t,t):t:e}iter(){let t=new M(this.compare),e=r=>{if(!r)return;let s=r;do{t.insert(s.key),e(s.child),s=s.next}while(s!==r)};return e(this.head),{remove(){throw Error("UnsupportedOperationException")},hasNext:()=>!t.isEmpty(),next(){if(!this.hasNext())throw Error("NoSuchElementException");return t.delMin()}}}static test(){let t="",e=new M(h);"PQE".split("").forEach((t=>e.insert(t))),t+=e.delMin()+" ","XAM".split("").forEach((t=>e.insert(t))),t+=e.delMin()+" ","PLE".split("").forEach((t=>e.insert(t))),t+=e.delMin()+" ",e.isEmpty(),console.log(t),console.log("min= "+e.min()),console.log(n(e.iter())),console.log("("+e.size()+" left on pq)");let r=new M(h);"ZTAK".split("").forEach((t=>r.insert(t))),r=r.union(e),console.log(n(r.iter()))}}class P{Node(t){return{key:t,order:0,index:0}}constructor(t,r){if(t<0)throw Error("Cannot create a priority queue of negative size");this.maxN=t,this.n=0,this.head=e,this._min=e,this.compare=r,this.table=new Map,this.nodes=new Array(t)}isEmpty(){return 0==this.n}contains(t){if(t<0||t>=this.maxN)throw Error("IllegalArgumentException");return d.echt(this.nodes[t])}size(){return this.n}insert(t,e){if(t<0||t>=this.maxN)throw Error("IllegalArgumentException");if(this.contains(t))throw Error("Specified index is already in the queue");let r=this.Node(e);r.index=t,this.nodes[t]=r,this.n+=1,this.head=this._insertNode(r,this.head),this._min=this._min?this._greater(this._min.key,e)?this.head:this._min:this.head}minIndex(){if(this.isEmpty())throw Error("Priority queue is empty");return this._min.index}min(){if(this.isEmpty())throw Error("Priority queue is empty");return this._min.key}delMin(){if(this.isEmpty())throw Error("Priority queue is empty");this.head=this._cutNode(this._min,this.head);let t=this._min.child,r=this._min.index;if(this._min.key=e,t){do{t.parent=e,t=t.next}while(t!==this._min.child);this.head=this._meld(this.head,t),this._min.child=e}return this.n-=1,this.isEmpty()?this._min=e:this._consolidate(),this.nodes[r]=e,r}keyOf(t){if(t<0||t>=this.maxN)throw Error("IllegalArgumentException");if(!this.contains(t))throw Error("Specified index is not in the queue");return this.nodes[t].key}changeKey(t,e){if(t<0||t>=this.maxN)throw Error("IllegalArgumentException");if(!this.contains(t))throw Error("Specified index is not in the queue");this._greater(e,this.nodes[t].key)?this.increaseKey(t,e):this.decreaseKey(t,e)}decreaseKey(t,e){if(t<0||t>=this.maxN)throw Error("IllegalArgumentException");if(!this.contains(t))throw Error("Specified index is not in the queue");if(this._greater(e,this.nodes[t].key))throw Error("Calling with this argument would not decrease the key");let r=this.nodes[t];r.key=e,this._greater(this._min.key,e)&&(this._min=r),r.parent&&this._greater(r.parent.key,e)&&this._cut(t)}increaseKey(t,e){if(t<0||t>=this.maxN)throw Error("IllegalArgumentException");if(!this.contains(t))throw Error("Specified index is not in the queue");if(this._greater(this.nodes[t].key,e))throw Error("Calling with this argument would not increase the key");this.delete(t),this.insert(t,e)}delete(t){if(t<0||t>=this.maxN)throw Error("IllegalArgumentException");if(!this.contains(t))throw Error("Specified index is not in the queue");let r=this.nodes[t];if(r.key=null,r.parent&&this._cut(t),this.head=this._cutNode(r,this.head),r.child){let t=r.child;r.child=e,r=t;do{t.parent=e,t=t.next}while(t!==r);this.head=this._meld(this.head,t)}this.isEmpty()?this._min=e:this._consolidate(),this.nodes[t]=e,this.n-=1}_greater(t,e){return!d.nichts(t)&&(!!d.nichts(e)||this.compare(t,e)>0)}_link(t,e){t.parent=e,e.child=this._insertNode(t,e.child),e.order+=1}_cut(t){let r=this.nodes[t],s=r.parent;s.child=this._cutNode(r,s.child),r.parent=e,s.order-=1,this.head=this._insertNode(r,this.head),s.mark=!s.mark,!s.mark&&s.parent&&this._cut(s.index)}_consolidate(){let t=e,r=e,s=0,i=this.head;this.table.clear(),this._min=this.head;do{for(t=i,i=i.next,r=this.table.get(t.order);r;)this.table.delete(t.order),this._greater(t.key,r.key)?(this._link(t,r),t=r):this._link(r,t),r=this.table.get(t.order);this.table.set(t.order,t),t.order>s&&(s=t.order)}while(i!==this.head);this.head=e,this.table.forEach((t=>{this._min=this._greater(this._min.key,t.key)?t:this._min,this.head=this._insertNode(t,this.head)}))}_insertNode(t,e){return e?(e.prev.next=t,t.next=e,t.prev=e.prev,e.prev=t):(t.prev=t,t.next=t),t}_cutNode(t,r){if(t.next===t)return t.next=e,t.prev=e,e;{t.next.prev=t.prev,t.prev.next=t.next;let s=t.next;return t.next=e,t.prev=e,r===t?s:r}}_meld(t,e){return t?e?(t.prev.next=e.next,e.next.prev=t.prev,t.prev=e,e.next=t,t):t:e}iter(){let t=new P(this.maxN,this.compare);return this.nodes.forEach((e=>{e&&t.insert(e.index,e.key)})),{remove(){throw Error("UnsupportedOperationException")},hasNext:()=>!t.isEmpty(),next(){if(!this.hasNext())throw Error("NoSuchElementException");return t.delMin()}}}static test(){let t=["it","was","the","best","of","times","it","was","the","worst"],e=new P(t.length,h);for(let r=0;r<t.length;++r)e.insert(r,t[r]);for(console.log("min= "+e.min()),console.log("minindex= "+e.minIndex()),console.log("size= "+e.size()),console.log("contains(3)="+e.contains(3)),console.log("keyOf(3)="+e.keyOf(3)),e.changeKey(3,"bbbb");!e.isEmpty();){let t=e.minIndex();console.log(t+" "+e.keyOf(t)),e.delMin()}console.log("");for(let r=0;r<t.length;++r)e.insert(r,t[r]);for(let r,s=e.iter();s.hasNext();)r=s.next(),console.log(r+" "+t[r]);for(;!e.isEmpty();)e.delMin()}}class R{constructor(t,e){if(this.comparator=t,this.n=0,c.vec(e)){this.pq=new Array(e.length+1),this.n=e.length;for(let t=0;t<this.n;++t)this.pq[t+1]=e[t];for(let t=u(this.n/2);t>=1;--t)this._sink(t,this)}else this.pq=new Array(c.num(e)?e:2);d.assert(this._isMinHeap(),"not min heap")}isEmpty(){return 0==this.n}size(){return this.n}min(){if(this.isEmpty())throw Error("Priority queue underflow");return this.pq[1]}insert(t){this.n==this.pq.length-1&&(this.pq=p(2*this.pq.length,this.n,1,this.n+1,this.pq)),this.pq[++this.n]=t,this._swim(this.n),d.assert(this._isMinHeap(),"not min heap-insert")}delMin(){if(this.isEmpty())throw Error("Priority queue underflow");let t=this.pq[1];return g(this.pq,1,this.n--),this._sink(1),this.pq[this.n+1]=e,this.n>0&&this.n==s.ndiv(this.pq.length-1,4)&&(this.pq=p(s.ndiv(this.pq.length,2),this.n,1,this.n+1,this.pq)),t}_swim(t){for(;t>1&&this._greater(s.ndiv(t,2),t);)g(this.pq,t,s.ndiv(t,2)),t=s.ndiv(t,2)}_sink(t){for(;2*t<=this.n;){let e=2*t;if(e<this.n&&this._greater(e,e+1)&&e++,!this._greater(t,e))break;g(this.pq,t,e),t=e}}_greater(t,e){return this.comparator(this.pq[t],this.pq[e])>0}_isMinHeap(){for(let t=1;t<=this.n;++t)if(d.nichts(this.pq[t]))return!1;for(let t=this.n+1;t<this.pq.length;++t)if(!d.nichts(this.pq[t]))return!1;return!d.echt(this.pq[0])&&this._isMinHeapOrdered(1)}_isMinHeapOrdered(t){if(t>this.n)return!0;let e=2*t,r=2*t+1;return!(e<=this.n&&this._greater(t,e))&&!(r<=this.n&&this._greater(t,r))&&this._isMinHeapOrdered(e)&&this._isMinHeapOrdered(r)}iter(){let t=new R(this.comparator,this.size());for(let e=1;e<=this.n;++e)t.insert(this.pq[e]);return{remove(){throw Error("UnsupportedOperationException")},hasNext:()=>!t.isEmpty(),next(){if(!this.hasNext())throw Error("NoSuchElementException");return t.delMin()}}}static test(){let t="",e=new R(h);"PQE".split("").forEach((t=>e.insert(t))),t+=e.delMin()+" ","XAM".split("").forEach((t=>e.insert(t))),t+=e.delMin()+" ","PLE".split("").forEach((t=>e.insert(t))),t+=e.delMin()+" ",console.log(t),console.log("("+e.size()+" left on pq)")}}class O{constructor(t,e){if(this.comparator=t,this.n=0,c.vec(e)){this.pq=new Array(e.length+1),this.n=e.length;for(let t=0;t<this.n;++t)this.pq[t+1]=e[t];for(let t=u(this.n/2);t>=1;--t)this._sink(t)}else this.pq=new Array(c.num(e)?e:2);d.assert(this._isMaxHeap(),"not max heap")}isEmpty(){return 0==this.n}size(){return this.n}max(){if(this.isEmpty())throw Error("Priority queue underflow");return this.pq[1]}insert(t){this.n==this.pq.length-1&&(this.pq=p(2*this.pq.length,this.n,1,this.n+1,this.pq)),this.n+=1,this.pq[this.n]=t,this._swim(this.n),d.assert(this._isMaxHeap(),"not max heap-insert")}delMax(){if(this.isEmpty())throw Error("Priority queue underflow");let t=this.pq[1];return g(this.pq,1,this.n),this.n-=1,this._sink(1),this.pq[this.n+1]=null,this.n>0&&this.n==s.ndiv(this.pq.length-1,4)&&(this.pq=p(s.ndiv(this.pq.length,2),this.n,1,this.n+1,this.pq)),t}_isMaxHeap(){for(let t=1;t<=this.n;++t)if(d.nichts(this.pq[t]))return!1;for(let t=this.n+1;t<this.pq.length;++t)if(d.echt(this.pq[t]))return!1;return!d.echt(this.pq[0])&&this._isMaxHeapOrdered(1)}_isMaxHeapOrdered(t){if(t>this.n)return!0;let e=2*t,r=2*t+1;return!(e<=this.n&&A(this.pq,t,e,this.comparator))&&!(r<=this.n&&A(this.pq,t,r,this.comparator))&&this._isMaxHeapOrdered(e)&&this._isMaxHeapOrdered(r)}_swim(t){for(;t>1&&A(this.pq,s.ndiv(t,2),t,this.comparator);)g(this.pq,t,s.ndiv(t,2)),t=s.ndiv(t,2)}_sink(t){let e;for(;2*t<=this.n&&(e=2*t,e<this.n&&A(this.pq,e,e+1,this.comparator)&&++e,A(this.pq,t,e,this.comparator));)g(this.pq,t,e),t=e}iter(){const t=new O(this.comparator,this.size());for(let e=1;e<=this.n;++e)t.insert(this.pq[e]);return{remove(){throw Error("UnsupportedOperationException")},hasNext:()=>!t.isEmpty(),next(){if(!this.hasNext())throw Error("NoSuchElementException");return t.delMax()}}}static test(){let t="",e=new O(h);"PQE".split("").forEach((t=>e.insert(t))),t+=e.delMax()+" ","XAM".split("").forEach((t=>e.insert(t))),t+=e.delMax()+" ","PLE".split("").forEach((t=>e.insert(t))),t+=e.delMax()+" ",console.log(t),console.log("("+e.size()+" left on pq)")}}function C(t,e,r,s){return s(t[e-1],t[r-1])<0}function I(t,e,r){const s=t[e-1];t[e-1]=t[r-1],t[r-1]=s}class G{static sort(t,e){function r(t,e,r,s){for(;2*e<=r;){let i=2*e;if(i<r&&C(t,i,i+1,s)&&++i,!C(t,e,i,s))break;I(t,e,i),e=i}}let i,n=t.length;for(i=s.ndiv(n,2);i>=1;--i)r(t,i,n,e);for(i=n;i>1;)I(t,1,i--),r(t,1,i,e);return t}static test(){let t="SORTEXAMPLE".split("");m(G.sort(t,h)),t="bed bug dad yes zoo all bad yet".split(" "),m(G.sort(t,h))}}class k{constructor(t,e){if(t<0)throw Error("IllegalArgumentException");this.compare=e,this.maxN=t,this.n=0,this.mKeys=new Array(t+1),this.pq=new Array(t+1),this.qp=new Array(t+1);for(let e=0;e<=t;++e)this.qp[e]=-1}isEmpty(){return 0==this.n}contains(t){return this._validateIndex(t),-1!=this.qp[t]}size(){return this.n}insert(t,e){if(this._validateIndex(t),this.contains(t))throw Error("index is already in the priority queue");++this.n,this.qp[t]=this.n,this.pq[this.n]=t,this.mKeys[t]=e,this._swim(this.n)}minIndex(){if(0==this.n)throw Error("Priority queue underflow");return this.pq[1]}minKey(){if(0==this.n)throw Error("Priority queue underflow");return this.mKeys[this.pq[1]]}delMin(){if(0==this.n)throw Error("Priority queue underflow");let t=this.pq[1];return this._exch(1,this.n--),this._sink(1),d.assert(t==this.pq[this.n+1],"No good"),this.qp[t]=-1,this.mKeys[t]=null,this.pq[this.n+1]=-1,t}keyOf(t){if(this._validateIndex(t),!this.contains(t))throw Error("index is not in the priority queue");return this.mKeys[t]}changeKey(t,e){if(this._validateIndex(t),!this.contains(t))throw Error("index is not in the priority queue");this.mKeys[t]=e,this._swim(this.qp[t]),this._sink(this.qp[t])}decreaseKey(t,e){if(this._validateIndex(t),!this.contains(t))throw Error("index is not in the priority queue");let r=this.compare(this.mKeys[t],e);if(0==r)throw Error("Calling decreaseKey() with a key equal to the key in the priority queue");if(r<0)throw Error("Calling decreaseKey() with a key strictly greater than the key in the priority queue");this.mKeys[t]=e,this._swim(this.qp[t])}increaseKey(t,e){if(this._validateIndex(t),!this.contains(t))throw Error("index is not in the priority queue");let r=this.compare(this.mKeys[t],e);if(0==r)throw Error("Calling increaseKey() with a key equal to the key in the priority queue");if(r>0)throw Error("Calling increaseKey() with a key strictly less than the key in the priority queue");this.mKeys[t]=e,this._sink(this.qp[t])}delete(t){if(this._validateIndex(t),!this.contains(t))throw Error("index is not in the priority queue");let r=this.qp[t];this._exch(r,this.n--),this._swim(r),this._sink(r),this.mKeys[t]=e,this.qp[t]=-1}_validateIndex(t){if(t<0)throw Error("index is negative: "+t);if(t>=this.maxN)throw Error("index >= capacity: "+t)}_greater(t,e){return this.compare(this.mKeys[this.pq[t]],this.mKeys[this.pq[e]])>0}_exch(t,e){let r=this.pq[t];this.pq[t]=this.pq[e],this.pq[e]=r,this.qp[this.pq[t]]=t,this.qp[this.pq[e]]=e}_swim(t){for(;t>1&&this._greater(s.ndiv(t,2),t);)this._exch(t,s.ndiv(t,2)),t=s.ndiv(t,2)}_sink(t){for(;2*t<=this.n;){let e=2*t;if(e<this.n&&this._greater(e,e+1)&&++e,!this._greater(t,e))break;this._exch(t,e),t=e}}iter(){let t=new k(this.pq.length-1,this.compare);for(let e=1;e<=this.n;++e)t.insert(this.pq[e],this.mKeys[this.pq[e]]);return{remove(){throw Error("UnsupportedOperationException")},hasNext:()=>!t.isEmpty(),next(){if(!this.hasNext())throw Error("NoSuchElementException");return t.delMin()}}}static test(){let t=["it","was","the","best","of","times","it","was","the","worst"],e=new k(t.length,h);for(let r=0;r<t.length;++r)e.insert(r,t[r]);for(;!e.isEmpty();){let r=e.delMin();console.log(r+" "+t[r])}console.log("");for(let r=0;r<t.length;++r)e.insert(r,t[r]);for(let r,s=e.iter();s.hasNext();)r=s.next(),console.log(r+" "+t[r]);for(;!e.isEmpty();)e.delMin()}}class B{constructor(t,e){if(t<0)throw Error("IllegalArgumentException");this.compare=e,this.maxN=t,this.n=0,this.mKeys=new Array(t+1),this.pq=new Array(t+1),this.qp=new Array(t+1);for(let e=0;e<=t;++e)this.qp[e]=-1}isEmpty(){return 0==this.n}contains(t){return this._validateIndex(t),-1!=this.qp[t]}size(){return this.n}insert(t,e){if(this._validateIndex(t),this.contains(t))throw Error("index is already in the priority queue");++this.n,this.qp[t]=this.n,this.pq[this.n]=t,this.mKeys[t]=e,this._swim(this.n)}maxIndex(){if(0==this.n)throw Error("Priority queue underflow");return this.pq[1]}maxKey(){if(0==this.n)throw Error("Priority queue underflow");return this.mKeys[this.pq[1]]}delMax(){if(0==this.n)throw Error("Priority queue underflow");let t=this.pq[1];return this._exch(1,this.n--),this._sink(1),d.assert(this.pq[this.n+1]==t,"bad delMax"),this.qp[t]=-1,this.mKeys[t]=e,this.pq[this.n+1]=-1,t}keyOf(t){if(this._validateIndex(t),!this.contains(t))throw Error("index is not in the priority queue");return this.mKeys[t]}changeKey(t,e){if(this._validateIndex(t),!this.contains(t))throw Error("index is not in the priority queue");this.mKeys[t]=e,this._swim(this.qp[t]),this._sink(this.qp[t])}increaseKey(t,e){if(this._validateIndex(t),!this.contains(t))throw Error("index is not in the priority queue");if(0==this.compare(this.mKeys[t],e))throw Error("Calling increaseKey() with a key equal to the key in the priority queue");if(this.compare(this.mKeys[t],e)>0)throw Error("Calling increaseKey() with a key that is strictly less than the key in the priority queue");this.mKeys[t]=e,this._swim(this.qp[t])}decreaseKey(t,e){if(this._validateIndex(t),!this.contains(t))throw Error("index is not in the priority queue");if(0==this.compare(this.mKeys[t],e))throw Error("Calling decreaseKey() with a key equal to the key in the priority queue");if(this.compare(this.mKeys[t],e)<0)throw Error("Calling decreaseKey() with a key that is strictly greater than the key in the priority queue");this.mKeys[t]=e,this._sink(this.qp[t])}delete(t){if(this._validateIndex(t),!this.contains(t))throw Error("index is not in the priority queue");let r=this.qp[t];this._exch(r,this.n--),this._swim(r),this._sink(r),this.mKeys[t]=e,this.qp[t]=-1}_validateIndex(t){if(t<0)throw Error("index is negative: "+t);if(t>=this.maxN)throw Error("index >= capacity: "+t)}_less(t,e){return f(this.mKeys[this.pq[t]],this.mKeys[this.pq[e]],this.compare)}_exch(t,e){let r=this.pq[t];this.pq[t]=this.pq[e],this.pq[e]=r,this.qp[this.pq[t]]=t,this.qp[this.pq[e]]=e}_swim(t){for(;t>1&&this._less(s.ndiv(t,2),t);)this._exch(t,s.ndiv(t,2)),t=s.ndiv(t,2)}_sink(t){for(;2*t<=this.n;){let e=2*t;if(e<this.n&&this._less(e,e+1)&&++e,!this._less(t,e))break;this._exch(t,e),t=e}}iter(){let t=new B(this.pq.length-1,this.compare);for(let e=1;e<=this.n;++e)t.insert(this.pq[e],this.mKeys[this.pq[e]]);return{remove(){throw Error("UnsupportedOperationException")},hasNext:()=>!t.isEmpty(),next(){if(!this.hasNext())throw Error("NoSuchElementException");return t.delMax()}}}static test(){let t=["it","was","the","best","of","times","it","was","the","worst"],e=new B(t.length,h);for(let r=0;r<t.length;++r)e.insert(r,t[r]);for(let r,s=e.iter();s.hasNext();)r=s.next(),console.log(r+" "+t[r]);console.log("");for(let r=0;r<t.length;++r)d.rand()<.5?e.increaseKey(r,t[r]+t[r]):e.decreaseKey(r,t[r].substring(0,1));for(;!e.isEmpty();){let t=e.maxKey(),r=e.delMax();console.log(r+" "+t)}console.log("");for(let r=0;r<t.length;++r)e.insert(r,t[r]);let r=new Array(t.length);for(let e=0;e<t.length;++e)r[e]=e;d.shuffle(r);for(let t=0;t<r.length;++t){let s=e.keyOf(r[t]);e.delete(r[t]),console.log(r[t]+" "+s)}}}return{FibonacciMinPQ:M,IndexFibonacciMinPQ:P,Insertion:_,BinaryInsertion:x,Selection:y,Shell:b,Merge:T,Bubble:S,Quick:E,MinPQ:R,MaxPQ:O,Heap:G,IndexMinPQ:k,IndexMaxPQ:B}}"object"==typeof module&&module.exports?module.exports=r(require("../main/core"),require("../main/math"),require("./basic")):t["io/czlab/mcfud/algo/sort"]=r}(this),function(t,e){"use strict";function r(r,s,i,n){r||(r=t["io/czlab/mcfud/core"]()),s||(s=t["io/czlab/mcfud/math"]()),i||(i=t["io/czlab/mcfud/algo/basic"]()),n||(n=t["io/czlab/mcfud/algo/sort"]());const{Bag:o,Stack:a,Queue:l,StdCompare:h,prnIter:u}=i,{MinPQ:c}=n,{is:d,u:p}=(Math.floor,r);class f{static count(t,e){let r=new Map,s=0,i="",n=0;for(let i,o=0;o<t.length;++o)i=t[o],i.length<e||(++s,r.has(i)?r.set(i,r.get(i)+1):(r.set(i,1),++n));return r.set(i,0),Array.from(r.keys()).forEach((t=>{r.get(t)>r.get(i)&&(i=t)})),[i,r.get(i),[n,s]]}static test(){let t="it was the best of times it was the worst of times\n        it was the age of wisdom it was the age of foolishness\n        it was the epoch of belief it was the epoch of incredulity\n        it was the season of light it was the season of darkness\n        it was the spring of hope it was the winter of despair".split(" "),[e,r,s]=f.count(t,1);console.log(e+" "+r),console.log("distinct = "+s[0]),console.log("words= "+s[1])}}class g{constructor(){this.first=e,this.n=0}size(){return this.n}isEmpty(){return 0==this.size()}contains(t){if(p.nichts(t))throw Error("argument to contains is null");return void 0!==this.get(t)}get(t){if(p.nichts(t))throw Error("argument to get is null");for(let e=this.first;e;e=e.next)if(t==e.key)return e.val}put(t,e){if(p.nichts(t))throw Error("first argument to put is null");if(void 0===e)this.delete(t);else{let r,s;for(s=this.first;s&&!r;s=s.next)t==s.key&&(s.val=e,r=!0);r||(this.first=((t,e,r)=>({key:t,val:e,next:this.first}))(t,e),this.n+=1)}}delete(t){const r=(t,s)=>t?s==t.key?(this.n-=1,t.next):(t.next=r(t.next,s),t):e;if(p.nichts(t))throw Error("argument to delete is null");this.first=r(this.first,t)}keys(){let t=new l;for(let e=this.first;e;e=e.next)t.enqueue(e.key);return t.iter()}static load(t){let e=new g;return t.forEach(((t,r)=>e.put(t,r))),e}static test(){let t=g.load("SEARCHEXAMPLE".split(""));console.log(((e="",r=0,s=0)=>{for(s=t.keys();s.hasNext();)e+=`${r=s.next()}=${t.get(r)} `;return e})()),console.log("size= "+t.size()),console.log("contains R= "+t.contains("R")),console.log("get R= "+t.get("R")),t.delete("R"),t.isEmpty(),console.log("contains R= "+t.contains("R")),console.log("get R= "+t.get("R")),console.log("size= "+t.size())}}class m{constructor(t,e=2){this.mKeys=new Array(e),this.vals=new Array(e),this.compare=t,this.n=0,this._resize=t=>{let e=new Array(t),r=new Array(t);for(let t=0;t<this.n;++t)e[t]=this.mKeys[t],r[t]=this.vals[t];this.vals=r,this.mKeys=e},this._argOk=t=>p.echt(t,"Invalid argument"),this._check=()=>(()=>{for(let t=1;t<this.size();++t)if(this.compare(this.mKeys[t],this.mKeys[t-1])<0)return!1;return!0})()&&(()=>{for(let t=0;t<this.size();++t)if(t!=this.rank(this.select(t)))return!1;for(let t=0;t<this.size();++t)if(0!=this.compare(this.mKeys[t],this.select(this.rank(this.mKeys[t]))))return!1;return!0})()}isEmpty(){return 0==this.size()}contains(t){return this._argOk(t)&&void 0!==this.get(t)}get(t){if(this._argOk(t)&&!this.isEmpty()){let e=this.rank(t);if(e<this.n&&0==this.compare(this.mKeys[e],t))return this.vals[e]}}rank(t){let e,r,i=0,n=this.n-1;for(this._argOk(t);i<=n;)if(e=i+s.ndiv(n-i,2),r=this.compare(t,this.mKeys[e]),r<0)n=e-1;else{if(!(r>0))return e;i=e+1}return i}put(t,e){if(this._argOk(t)&&void 0===e)this.delete(t);else{let r=this.rank(t);if(r<this.n&&0==this.compare(this.mKeys[r],t))this.vals[r]=e;else{this.n==this.mKeys.length&&this._resize(2*this.mKeys.length);for(let t=this.n;t>r;--t)this.mKeys[t]=this.mKeys[t-1],this.vals[t]=this.vals[t-1];this.n+=1,this.mKeys[r]=t,this.vals[r]=e}}}delete(t){if(this._argOk(t)&&this.isEmpty());else{let r=this.rank(t);if(r==this.n||0!=this.compare(this.mKeys[r],t));else{for(let t=r;t<this.n-1;++t)this.mKeys[t]=this.mKeys[t+1],this.vals[t]=this.vals[t+1];this.n-=1,this.mKeys[this.n]=e,this.vals[this.n]=e,this.n>0&&this.n==s.ndiv(this.mKeys.length,4)&&this._resize(s.ndiv(this.mKeys.length,2)),this._check()}}}deleteMin(){if(this.isEmpty())throw Error("Symbol table underflow error");this.delete(this.min())}deleteMax(){if(this.isEmpty())throw Error("Symbol table underflow error");this.delete(this.max())}min(){if(this.isEmpty())throw Error("called min with empty symbol table");return this.mKeys[0]}max(){if(this.isEmpty())throw Error("called max with empty symbol table");return this.mKeys[this.n-1]}select(t){if(t<0||t>=this.size())throw Error(`called select with invalid argument: ${t}`);return this.mKeys[t]}floor(t){let e=this._argOk(t)&&this.rank(t);if(e<this.n&&0==this.compare(t,this.mKeys[e]))return this.mKeys[e];if(0==e)throw Error("argument to floor is too small");return this.mKeys[e-1]}ceiling(t){let e=this._argOk(t)&&this.rank(t);if(e==this.n)throw Error("argument to ceiling is too large");return this.mKeys[e]}size(t,e){return 0==arguments.length?this.n:(this._argOk(t)&&this._argOk(e),this.compare(t,e)>0?0:this.contains(e)?this.rank(e)-this.rank(t)+1:this.rank(e)-this.rank(t))}keys(t,e){0==arguments.length&&(t=this.min(),e=this.max()),this._argOk(t)&&this._argOk(e);let r=new l;if(this.compare(t,e)>0);else{for(let s=this.rank(t);s<this.rank(e);++s)r.enqueue(this.mKeys[s]);this.contains(e)&&r.enqueue(this.mKeys[this.rank(e)])}return r.iter()}static load(t,e){let r=new m(e);return t.forEach(((t,e)=>r.put(t,e))),r}static test(){let t=m.load("SEARCHEXAMPLE".split(""),h),e=e=>{e="";for(let r,s=t.keys();s.hasNext();)r=s.next(),e+=`${r}=${t.get(r)} `;return e};console.log(e()),t.deleteMin(),console.log(e()),t.deleteMax(),t.isEmpty(),console.log(e()),console.log("floor of Q= "+t.floor("Q")),console.log("ceil of Q= "+t.ceiling("Q")),console.log("size= "+t.size()),console.log("size= "+t.size("E","P")),console.log("keys E->P = "+u(t.keys("E","P")))}}class _{constructor(t){this.compare=t,this.root=e,this._argOk=t=>p.assert(t,"Invalid argument"),this._check=()=>(this.isBST(this.root,null,null)||console.log("Not in symmetric order"),this.isSizeConsistent(this.root)||console.log("Subtree counts not consistent"),this.isRankConsistent()||console.log("Ranks not consistent"),this.isBST(this.root,null,null)&&this.isSizeConsistent(this.root)&&this.isRankConsistent()),this.isBST=(t,e,r)=>!!p.nichts(t)||!(p.echt(e)&&this.compare(t.key,e)<=0)&&!(p.echt(r)&&this.compare(t.key,r)>=0)&&this.isBST(t.left,e,t.key)&&this.isBST(t.right,t.key,r),this.isSizeConsistent=t=>!!p.nichts(t)||t.size==this._sizeNode(t.left)+this._sizeNode(t.right)+1&&this.isSizeConsistent(t.left)&&this.isSizeConsistent(t.right),this.isRankConsistent=()=>{for(let t=0;t<this.size();++t)if(t!=this.rank(this.select(t)))return!1;for(let t,e=this.keys();e.hasNext();)if(t=e.next(),0!=this.compare(t,this.select(this.rank(t))))return!1;return!0}}Node(t,e,r){return{key:t,val:e,size:r}}isEmpty(){return 0==this.size()}contains(t){return this._argOk(t)&&void 0!==this.get(t)}get(t){return this._getNode(this.root,t)}_getNode(t,e){if(!this._argOk(e)||!p.nichts(t)){let r=this.compare(e,t.key);return r<0?this._getNode(t.left,e):r>0?this._getNode(t.right,e):t.val}}put(t,e){this._argOk(t)&&p.nichts(e)?this.delete(t):(this.root=this._putNode(this.root,t,e),this._check())}_putNode(t,e,r){if(p.nichts(t))t=this.Node(e,r,1);else{let s=this.compare(e,t.key);s<0?t.left=this._putNode(t.left,e,r):s>0?t.right=this._putNode(t.right,e,r):t.val=r,t.size=1+this._sizeNode(t.left)+this._sizeNode(t.right)}return t}deleteMin(){if(this.isEmpty())throw Error("Symbol table underflow");this.root=this._deleteMinNode(this.root),this._check()}_deleteMinNode(t){return p.nichts(t.left)?t=t.right:(t.left=this._deleteMinNode(t.left),t.size=this._sizeNode(t.left)+this._sizeNode(t.right)+1),t}deleteMax(){if(this.isEmpty())throw Error("Symbol table underflow");this.root=this._deleteMaxNode(this.root),this._check()}_deleteMaxNode(t){return p.nichts(t.right)?t=t.left:(t.right=this._deleteMaxNode(t.right),t.size=this._sizeNode(t.left)+this._sizeNode(t.right)+1),t}delete(t){this.root=this._argOk(t)&&this._deleteNode(this.root,t),this._check()}_deleteNode(t,e){if(p.echt(t)){let r=this.compare(e,t.key);if(r<0)t.left=this._deleteNode(t.left,e);else if(r>0)t.right=this._deleteNode(t.right,e);else{if(p.nichts(t.right))return t.left;if(p.nichts(t.left))return t.right;let e=t;(t=this._minNode(e.right)).right=this._deleteMinNode(e.right),t.left=e.left}t.size=this._sizeNode(t.left)+this._sizeNode(t.right)+1}return t}min(){if(this.isEmpty())throw Error("calls min with empty symbol table");return this._minNode(this.root).key}_minNode(t){return p.nichts(t.left)?t:this._minNode(t.left)}max(){if(this.isEmpty())throw Error("calls max with empty symbol table");return this._maxNode(this.root).key}_maxNode(t){return p.nichts(t.right)?t:this._maxNode(t.right)}floor(t){if(this._argOk(t)&&this.isEmpty())throw Error("calls floor with empty symbol table");let e=this._floorNode(this.root,t);if(p.nichts(e))throw Error("argument to floor is too small");return e.key}_floorNode(t,e){if(p.nichts(t))return null;let r=this.compare(e,t.key);if(0==r)return t;if(r<0)return this._floorNode(t.left,e);let s=this._floorNode(t.right,e);return p.nichts(s)?t:s}ceiling(t){if(this._argOk(t)&&this.isEmpty())throw Error("calls ceiling with empty symbol table");let e=this._ceilingNode(this.root,t);if(p.nichts(e))throw Error("argument to floor is too large");return e.key}_ceilingNode(t,r){if(p.nichts(t))return e;let s=this.compare(r,t.key);if(0==s)return t;if(s<0){return this._ceilingNode(t.left,r)||t}return this._ceilingNode(t.right,r)}select(t){if(t<0||t>=this.size())throw Error(`argument to select is invalid: ${t}`);return this._selectNode(this.root,t)}_selectNode(t,r){if(p.nichts(t))return e;let s=this._sizeNode(t.left);return s>r?this._selectNode(t.left,r):s<r?this._selectNode(t.right,r-s-1):t.key}rank(t){return this._argOk(t)&&this._rankNode(t,this.root)}_rankNode(t,e){if(p.nichts(e))return 0;let r=this.compare(t,e.key);return r<0?this._rankNode(t,e.left):r>0?1+this._sizeNode(e.left)+this._rankNode(t,e.right):this._sizeNode(e.left)}keys(t,e){let r=new l;return 0==arguments.length&&(this.isEmpty()||(t=this.min(),e=this.max())),!this.isEmpty()&&this._argOk(t)&&this._argOk(e)&&this._keysNode(this.root,r,t,e),r.iter()}_keysNode(t,e,r,s){if(p.nichts(t));else{let i=this.compare(r,t.key),n=this.compare(s,t.key);i<0&&this._keysNode(t.left,e,r,s),i<=0&&n>=0&&e.enqueue(t.key),n>0&&this._keysNode(t.right,e,r,s)}return e}_sizeNode(t){return p.nichts(t)?0:t.size}size(t,e){return 0==arguments.length?this._sizeNode(this.root):this._argOk(t)&&this._argOk(e)&&this.compare(t,e)>0?0:this.contains(e)?this.rank(e)-this.rank(t)+1:this.rank(e)-this.rank(t)}height(){return this._heightNode(this.root)}_heightNode(t){return p.nichts(t)?-1:1+Math.max(this._heightNode(t.left),this._heightNode(t.right))}levelOrder(){let t,e=[],r=new l;for(e.push(this.root);e.length>0;)t=e.pop(),p.echt(t)&&(r.enqueue(t.key),e.push(t.left,t.right));return r.iter()}static load(t,e){let r=new _(e);return t.forEach(((t,e)=>r.put(t,e))),r}static test(){let t,e=_.load("SEARCHEXAMPLE".split(""),h);t="";for(let r,s=e.levelOrder();s.hasNext();)r=s.next(),t+=`${r}=${e.get(r)} `;console.log("level-order:\n"+t),t="";for(let r,s=e.keys();s.hasNext();)r=s.next(),t+=`${r}=${e.get(r)} `;e.isEmpty(),console.log("keys=\n"+t),console.log("size="+e.size()),console.log("size E->Q = ",e.size("E","Q")),t="";for(let r,s=e.keys("E","Q");s.hasNext();)r=s.next(),t+=`${r}=${e.get(r)} `;console.log("keys[E->Q]= "+t),console.log("min= "+e.min()),console.log("max= "+e.max()),console.log("rank P= "+e.rank("P")),console.log("contains X= "+e.contains("X")),console.log("contains Z= "+e.contains("Z")),e.delete("X"),console.log("get C="+e.get("C")),console.log("max= "+e.max()),e.deleteMin(),e.deleteMax(),console.log("height= "+e.height()),console.log("min= "+e.min()),console.log("max= "+e.max()),console.log("rank E= "+e.rank("E")),console.log("floor G= "+e.floor("G")),console.log("ceiling G= "+e.ceiling("G"))}}class x{static BLACK=!1;static RED=!0;constructor(t){this.compare=t,this.root=e,this._argOk=t=>p.assert(t,"Invalid argument"),this._check=()=>{let t=(e,r,s)=>!!p.nichts(e)||!(r&&this.compare(e.key,r)<=0)&&!(s&&this.compare(e.key,s)>=0)&&t(e.left,r,e.key)&&t(e.right,e.key,s),e=t=>!!p.nichts(t)||t.size==this._sizeNode(t.left)+this._sizeNode(t.right)+1&&e(t.left)&&e(t.right),r=t=>!!p.nichts(t)||!this._isRed(t.right)&&(t===this.root||!this._isRed(t)||!this._isRed(t.left))&&r(t.left)&&r(t.right),s=(t,e)=>p.nichts(t)?0==e:(this._isRed(t)||--e,s(t.left,e)&&s(t.right,e));return t(this.root,null,null)&&e(this.root)&&(()=>{for(let t=0;t<this.size();++t)if(t!=this._rankNode(this.select(t)))return!1;for(let t,e=this.keys();e.hasNext();)if(t=e.next(),0!=this.compare(t,this.select(this._rankNode(t))))return!1;return!0})()&&r(this.root)&&(()=>{let t=0,e=this.root;for(;e;)this._isRed(e)||++t,e=e.left;return s(this.root,t)})()}}Node(t,e,r,s){return{key:t,val:e,color:r,size:s}}_isRed(t){return!p.nichts(t)&&t.color===x.RED}_sizeNode(t){return p.nichts(t)?0:t.size}isEmpty(){return p.nichts(this.root)}get(t){return this._argOk(t)&&this._getNode(this.root,t)}_getNode(t,e){for(;t;){let r=this.compare(e,t.key);if(r<0)t=t.left;else{if(!(r>0))return t.val;t=t.right}}}contains(t){return void 0!==this.get(t)}put(t,e){this._argOk(t)&&p.nichts(e)?this.delete(t):(this.root=this._putNode(this.root,t,e),this.root.color=x.BLACK)}_putNode(t,e,r){if(p.nichts(t))return this.Node(e,r,x.RED,1);let s=this.compare(e,t.key);return s<0?t.left=this._putNode(t.left,e,r):s>0?t.right=this._putNode(t.right,e,r):t.val=r,this._isRed(t.right)&&!this._isRed(t.left)&&(t=this._rotateLeft(t)),this._isRed(t.left)&&this._isRed(t.left.left)&&(t=this._rotateRight(t)),this._isRed(t.left)&&this._isRed(t.right)&&this._flipColors(t),t.size=this._sizeNode(t.left)+this._sizeNode(t.right)+1,t}deleteMin(){if(this.isEmpty())throw Error("BST underflow");this._isRed(this.root.left)||this._isRed(this.root.right)||(this.root.color=x.RED),this.root=this._deleteMinNode(this.root),this.isEmpty()||(this.root.color=x.BLACK)}_deleteMinNode(t){return p.nichts(t.left)?null:(this._isRed(t.left)||this._isRed(t.left.left)||(t=this._moveRedLeft(t)),t.left=this._deleteMinNode(t.left),this._balance(t))}deleteMax(){if(this.isEmpty())throw Error("BST underflow");this._isRed(this.root.left)||this._isRed(this.root.right)||(this.root.color=x.RED),this.root=this._deleteMaxNode(this.root),this.isEmpty()||(this.root.color=x.BLACK)}_deleteMaxNode(t){return this._isRed(t.left)&&(t=this._rotateRight(t)),p.nichts(t.right)?null:(this._isRed(t.right)||this._isRed(t.right.left)||(t=this._moveRedRight(t)),t.right=this._deleteMaxNode(t.right),this._balance(t))}delete(t){this._argOk(t)&&!this.contains(t)||(this._isRed(this.root.left)||this._isRed(this.root.right)||(this.root.color=x.RED),this.root=this._deleteNode(this.root,t),this.isEmpty()||(this.root.color=x.BLACK))}_deleteNode(t,e){if(this.compare(e,t.key)<0)this._isRed(t.left)||this._isRed(t.left.left)||(t=this._moveRedLeft(t)),t.left=this._deleteNode(t.left,e);else{if(this._isRed(t.left)&&(t=this._rotateRight(t)),0==this.compare(e,t.key)&&p.nichts(t.right))return null;if(this._isRed(t.right)||this._isRed(t.right.left)||(t=this._moveRedRight(t)),0==this.compare(e,t.key)){let e=this._minNode(t.right);t.key=e.key,t.val=e.val,t.right=this._deleteMinNode(t.right)}else t.right=this._deleteNode(t.right,e)}return this._balance(t)}_rotateRight(t){if(p.nichts(t)||!this._isRed(t.left))throw Error("bad input to rotateRight");let e=t.left;return t.left=e.right,e.right=t,e.color=e.right.color,e.right.color=x.RED,e.size=t.size,t.size=this._sizeNode(t.left)+this._sizeNode(t.right)+1,e}_rotateLeft(t){if(p.nichts(t)||!this._isRed(t.right))throw Error("bad input to rotateLeft");let e=t.right;return t.right=e.left,e.left=t,e.color=e.left.color,e.left.color=x.RED,e.size=t.size,t.size=this._sizeNode(t.left)+this._sizeNode(t.right)+1,e}_flipColors(t){t.color=!t.color,t.left.color=!t.left.color,t.right.color=!t.right.color}_moveRedLeft(t){return this._flipColors(t),this._isRed(t.right.left)&&(t.right=this._rotateRight(t.right),t=this._rotateLeft(t),this._flipColors(t)),t}_moveRedRight(t){return this._flipColors(t),this._isRed(t.left.left)&&(t=this._rotateRight(t),this._flipColors(t)),t}_balance(t){return this._isRed(t.right)&&!this._isRed(t.left)&&(t=this._rotateLeft(t)),this._isRed(t.left)&&this._isRed(t.left.left)&&(t=this._rotateRight(t)),this._isRed(t.left)&&this._isRed(t.right)&&this._flipColors(t),t.size=this._sizeNode(t.left)+this._sizeNode(t.right)+1,t}height(){return this._height(this.root)}_height(t){return p.nichts(t)?-1:1+Math.max(this._height(t.left),this._height(t.right))}min(){if(this.isEmpty())throw Error("calls min with empty symbol table");return this._minNode(this.root).key}_minNode(t){return p.nichts(t.left)?t:this._minNode(t.left)}max(){if(this.isEmpty())throw Error("calls max with empty symbol table");return this._maxNode(this.root).key}_maxNode(t){return p.nichts(t.right)?t:this._maxNode(t.right)}floor(t){if(this._argOk(t)&&this.isEmpty())throw Error("calls floor with empty symbol table");let e=this._floorNode(this.root,t);if(p.nichts(e))throw Error("argument to floor is too small");return e.key}_floorNode(t,r){if(p.nichts(t))return e;let s=this.compare(r,t.key);return 0==s?t:s<0?this._floorNode(t.left,r):this._floorNode(t.right,r)||t}ceiling(t){if(this._argOk(t)&&this.isEmpty())throw Error("calls ceiling with empty symbol table");let e=this._ceilingNode(this.root,t);if(p.nichts(e))throw Error("argument to ceiling is too small");return e.key}_ceilingNode(t,r){if(p.nichts(t))return e;let s=this.compare(r,t.key);return 0==s?t:s>0?this._ceilingNode(t.right,r):this._ceilingNode(t.left,r)||t}select(t){if(t<0||t>=this.size())throw Error(`argument to select is invalid: ${t}`);return this._selectNode(this.root,t)}_selectNode(t,r){if(p.nichts(t))return e;let s=this._sizeNode(t.left);return s>r?this._selectNode(t.left,r):s<r?this._selectNode(t.right,r-s-1):t.key}rank(t){return this._argOk(t)&&this._rankNode(t,this.root)}_rankNode(t,e){if(p.nichts(e))return 0;let r=this.compare(t,e.key);return r<0?this._rankNode(t,e.left):r>0?1+this._sizeNode(e.left)+this._rankNode(t,e.right):this._sizeNode(e.left)}keys(t,e){let r=new l;return 0==arguments.length&&(this.isEmpty()||(t=this.min(),e=this.max())),!this.isEmpty()&&this._argOk(t)&&this._argOk(e)&&this._keysNode(this.root,r,t,e),r.iter()}_keysNode(t,e,r,s){if(t){let i=this.compare(r,t.key),n=this.compare(s,t.key);i<0&&this._keysNode(t.left,e,r,s),i<=0&&n>=0&&e.enqueue(t.key),n>0&&this._keysNode(t.right,e,r,s)}return e}size(t,e){return 0==arguments.length?this._sizeNode(this.root):this._argOk(t)&&this._argOk(e)&&this.compare(t,e)>0?0:this.contains(e)?this.rank(e)-this.rank(t)+1:this.rank(e)-this.rank(t)}static load(t,e){let r=new x(e);return t.forEach(((t,e)=>r.put(t,e))),r}static test(){let t,e=x.load("SEARCHEXAMPLE".split(""),h);t="";for(let r,s=e.keys();s.hasNext();)r=s.next(),t+=`${r}=${e.get(r)} `;console.log(t),e.isEmpty(),console.log("height= "+e.height()+", size= "+e.size()),console.log("get X= "+e.get("X")),console.log("contains X= "+e.contains("X")),console.log("min= "+e.min()+",max= "+e.max()),e.deleteMin(),e.deleteMax(),console.log("min= "+e.min()+",max= "+e.max()),e.delete("R"),console.log("contains R= "+e.contains("R")),console.log("floor J= "+e.floor("J")),console.log("ceiling J= "+e.ceiling("J")),console.log("rank M= "+e.rank("M")),t="";for(let r,s=e.keys("D","Q");s.hasNext();)r=s.next(),t+=`${r}=${e.get(r)} `;console.log("keys[D-Q]= "+t),console.log("size[E-P]= "+e.size("E","P"))}}class y{static indexOf(t,e){let r=0,i=t.length-1;for(;r<=i;){let n=r+s.ndiv(i-r,2);if(e<t[n])i=n-1;else{if(!(e>t[n]))return n;r=n+1}}return-1}static test(){let t="84 48 68 10 18 98 12 23 54 57 33 16 77 11 29".split(" ").map((t=>+t)).sort();"23 50 10 99 18 23 98 84 11 10 48 77 13 54 98 77 77 68".split(" ").map((t=>+t)).forEach((e=>{y.indexOf(t,e)<0&&console.log(e)}))}}class b{Node(t,e,r,s){return{key:t,val:e,height:r,size:s}}constructor(t){this.compare=t,this.root=e}isEmpty(){return p.nichts(this.root)}_sizeNode(t){return p.nichts(t)?0:t.size}height(){return this._heightNode(this.root)}_heightNode(t){return p.nichts(t)?-1:t.height}get(t){if(p.nichts(t))throw Error("argument to get() is null");let e=this._getNode(this.root,t);if(e)return e.val}_getNode(t,r){if(!t)return e;let s=this.compare(r,t.key);return s<0?this._getNode(t.left,r):s>0?this._getNode(t.right,r):t}contains(t){return void 0!==this.get(t)}put(t,e){if(p.nichts(t))throw Error("first argument to put() is null");void 0===e?this.delete(t):this.root=this._putNode(this.root,t,e)}_putNode(t,e,r){if(!t)return this.Node(e,r,0,1);let s=this.compare(e,t.key);if(s<0)t.left=this._putNode(t.left,e,r);else{if(!(s>0))return t.val=r,t;t.right=this._putNode(t.right,e,r)}return t.size=1+this._sizeNode(t.left)+this._sizeNode(t.right),t.height=1+Math.max(this._heightNode(t.left),this._heightNode(t.right)),this._balanceNode(t)}_balanceNode(t){return this._balanceFactor(t)<-1?(this._balanceFactor(t.right)>0&&(t.right=this._rotateRight(t.right)),t=this._rotateLeft(t)):this._balanceFactor(t)>1&&(this._balanceFactor(t.left)<0&&(t.left=this._rotateLeft(t.left)),t=this._rotateRight(t)),t}_balanceFactor(t){return this._heightNode(t.left)-this._heightNode(t.right)}_rotateRight(t){let e=t.left;return t.left=e.right,e.right=t,e.size=t.size,t.size=1+this._sizeNode(t.left)+this._sizeNode(t.right),t.height=1+Math.max(this._heightNode(t.left),this._heightNode(t.right)),e.height=1+Math.max(this._heightNode(e.left),this._heightNode(e.right)),e}_rotateLeft(t){let e=t.right;return t.right=e.left,e.left=t,e.size=t.size,t.size=1+this._sizeNode(t.left)+this._sizeNode(t.right),t.height=1+Math.max(this._heightNode(t.left),this._heightNode(t.right)),e.height=1+Math.max(this._heightNode(e.left),this._heightNode(e.right)),e}delete(t){if(p.nichts(t))throw Error("argument to delete() is null");this.contains(t)&&(this.root=this._deleteNode(this.root,t))}_deleteNode(t,e){let r=this.compare(e,t.key);if(r<0)t.left=this._deleteNode(t.left,e);else if(r>0)t.right=this._deleteNode(t.right,e);else{if(!t.left)return t.right;if(!t.right)return t.left;let e=t;(t=this.min(e.right)).right=this.deleteMin(e.right),t.left=e.left}return t.size=1+this._sizeNode(t.left)+this._sizeNode(t.right),t.height=1+Math.max(this._heightNode(t.left),this._heightNode(t.right)),this._balance(t)}deleteMin(){if(this.isEmpty())throw Error("called deleteMin() with empty symbol table");this.root=this._deleteMinNode(this.root)}_deleteMinNode(t){return t.left?(t.left=this._deleteMinNode(t.left),t.size=1+this._sizeNode(t.left)+this._sizeNode(t.right),t.height=1+Math.max(this._heightNode(t.left),this._heightNode(t.right)),this._balance(t)):t.right}deleteMax(){if(this.isEmpty())throw Error("called deleteMax() with empty symbol table");this.root=this._deleteMaxNode(this.root)}_deleteMaxNode(t){return t.right?(t.right=this._deleteMaxNode(t.right),t.size=1+this._sizeNode(t.left)+this._sizeNode(t.right),t.height=1+Math.max(this._heightNode(t.left),this._heightNode(t.right)),this._balance(t)):t.left}min(){if(this.isEmpty())throw Error("called min() with empty symbol table");return this._minNode(this.root).key}_minNode(t){return t.left?this._minNode(t.left):t}max(){if(this.isEmpty())throw Error("called max() with empty symbol table");return this._maxNode(this.root).key}_maxNode(t){return t.right?this._maxNode(t.right):t}floor(t){if(p.nichts(t))throw Error("argument to floor() is null");if(this.isEmpty())throw Error("called floor() with empty symbol table");let e=this._floorNode(this.root,t);if(e)return e.key}_floorNode(t,r){if(p.nichts(t))return e;let s=this.compare(r,t.key);return 0==s?t:s<0?this._floorNode(t.left,r):this._floorNode(t.right,r)||t}ceiling(t){if(p.nichts(t))throw Error("argument to ceiling() is null");if(this.isEmpty())throw Error("called ceiling() with empty symbol table");let e=this._ceilingNode(this.root,t);if(e)return e.key}_ceilingNode(t,r){if(p.nichts(t))return e;let s=this.compare(r,t.key);return 0==s?t:s>0?this._ceilingNode(t.right,r):this._ceilingNode(t.left,r)||t}select(t){if(t<0||t>=this.size())throw Error("k is not in range 0-"+(this.size()-1));let e=this._selectNode(this.root,t);if(e)return e.key}_selectNode(t,r){if(p.nichts(t))return e;let s=this._sizeNode(t.left);return s>r?this._selectNode(t.left,r):s<r?this._selectNode(t.right,r-s-1):t}rank(t){if(p.nichts(t))throw Error("argument to rank() is null");return this._rankNode(t,this.root)}_rankNode(t,e){if(p.nichts(e))return 0;let r=this.compare(t,e.key);return r<0?this._rankNode(t,e.left):r>0?1+this._sizeNode(e.left)+this._rankNode(t,e.right):this._sizeNode(e.left)}keysInOrder(){let t=new l;return this._keysInOrderNode(this.root,t),t.iter()}_keysInOrderNode(t,e){p.nichts(t)||(this._keysInOrderNode(t.left,e),e.enqueue(t.key),this._keysInOrderNode(t.right,e))}keysLevelOrder(){let t=new l;if(!this.isEmpty()){let e=new l;for(e.enqueue(this.root);!e.isEmpty();){let r=e.dequeue();t.enqueue(r.key),r.left||e.enqueue(r.left),r.right&&e.enqueue(r.right)}}return t}keys(t,e){if(0==arguments.length)return this.keysInOrder();if(p.nichts(t))throw Error("first argument to keys() is null");if(p.nichts(e))throw Error("second argument to keys() is null");let r=new l;return this._keysNode(this.root,r,t,e),r.iter()}_keysNode(t,e,r,s){if(t){let i=this.compare(r,t.key),n=this.compare(s,t.key);i<0&&this._keysNode(t.left,e,r,s),i<=0&&n>=0&&e.enqueue(t.key),n>0&&this._keysNode(t.right,e,r,s)}}size(t,e){if(0==arguments.length)return this._sizeNode(this.root);if(p.nichts(t))throw Error("first argument to size() is null");if(p.nichts(e))throw Error("second argument to size() is null");return this.compare(t,e)>0?0:this.contains(e)?this.rank(e)-this.rank(t)+1:this.rank(e)-this.rank(t)}_check(){let t=this;return function e(r,s,i){return!r||!(!s&&t.compare(r.key,s)<=0)&&!(!i&&t.compare(r.key,i)>=0)&&e(r.left,s,r.key)&&e(r.right,r.key,i)}(this.root,null,null)&&function e(r){if(!r)return!0;let s=t._balanceFactor(r);return!(s>1||s<-1)&&e(r.left)&&e(r.right)}(this.root)&&function e(r){return!r||r.size==t._sizeNode(r.left)+t._sizeNode(r.right)+1&&e(r.left)&&e(r.right)}(this.root)&&function(){for(let e=0;e<t.size();e++)if(e!=t.rank(t.select(e)))return!1;for(let e,r=t.keys().iterator();r.hasNext();)if(e=r.next(),0!=this.compare(e,t.select(t.rank(key))))return!1;return!0}()}static test(){let t=new b(h);"SEARCHEXAMPLE".split("").forEach(((e,r)=>t.put(e,r)));for(let e,r=t.keys();r.hasNext();)e=r.next(),console.log(e+" "+t.get(e))}}const v=Math.sqrt(2);function T(t,e){return{parent:e,pos:t,f:0,g:0,h:0,pid:`${t[0]},${t[1]}`,equals(t){return this.pos[0]==t.pos[0]&&this.pos[1]==t.pos[1]}}}class S{static manhattan(t,e,r=1){return r*Math.abs(t[1]-e[1])+r*Math.abs(t[0]-e[0])}static euclidean(t,e,r=1){let s=e[0]-t[0],i=e[1]-t[1];return r*(s*s+i*i)}static diagonal(t,e,r=1,s=v){let i=Math.abs(e[0]-t[0]),n=Math.abs(e[1]-t[1]);return r*(i+n)+(s-2*r)*Math.min(i,n)}constructor(t){this.grid=t}pathTo(t,e,r){return this._search(this.grid,t,e,r)}_search(t,e,r,s){const i=s.compare,n=t.length,o=t[0].length,a=new Map,l=new Map,h=new c(i,10),u=T(r),d=T(e),p=[[1,0],[-1,0],[0,1],[0,-1]],f=(t,e)=>{for(;t;t=t.parent)e.unshift(t.pos);return e};s.wantDiagonal&&p.push([1,1],[1,-1],[-1,1],[-1,-1]),l.set(d.pid,d.g),h.insert(d);let g,m=[];for(;!h.isEmpty();){if(g=h.delMin(),l.delete(g.pid),a.set(g.pid,0),g.equals(u))return f(g,[]);m.length=0;for(let t,e=0;e<p.length;++e)t=[g.pos[0]+p[e][0],g.pos[1]+p[e][1]],t[0]>o-1||t[0]<0||t[1]>n-1||t[1]<0||s.blocked(t)||m.push(T(t,g));m.forEach((t=>{a.has(t.pid)||(t.g=g.g+s.cost(),t.h=s.calcHeuristic(t.pos,u.pos),t.f=t.g+t.h,l.has(t.pid)&&t.g>l.get(t.pid)||(h.insert(t),l.set(t.pid,t.g)))}))}}static test(){let t,e,r,s=[[0,1,0,0,0,0],[0,0,0,0,0,0],[0,1,0,1,0,0],[0,1,0,0,1,0],[0,0,0,0,1,0]],i=s.length,n=s[0].length,o={wantDiagonal:!1,compare:(t,e)=>t.f-e.f,cost:()=>1,blocked:t=>0!=s[t[1]][t[0]],calcHeuristic:(t,e)=>S.euclidean(t,e)},a=new S(s).pathTo([0,0],[5,4],o);a?(r="",a.forEach((t=>{r+=`[${t[0]},${t[1]}] `})),console.log(r),e=p.fill(i,(()=>p.fill(n,"#"))),t=0,a.forEach((r=>{e[r[1]][r[0]]=""+t,++t})),e.forEach((t=>{console.log(t.toString())}))):console.log("no path")}}return{AStarGrid:S,AVLTreeST:b,RedBlackBST:x,BST:_,BinarySearch:y,BinarySearchST:m,FrequencyCounter:f,SequentialSearchST:g}}"object"==typeof module&&module.exports?module.exports=r(require("../main/core"),require("../main/math"),require("./basic"),require("./sort")):t["io/czlab/mcfud/algo/search"]=r}(this),function(t,e){"use strict";function r(r,s,i,n){i||(i=t["io/czlab/mcfud/algo/basic"]()),n||(n=t["io/czlab/mcfud/algo/sort"]()),r||(r=t["io/czlab/mcfud/core"]()),s||(s=t["io/czlab/mcfud/math"]());const{prnIter:o,TreeMap:a,Bag:l,Stack:h,Queue:u,ST:c,StdCompare:d}=i,{IndexMinPQ:p,MinPQ:f}=n,{is:g,u:m}=(Math.floor,r);function _(t,e){if(t<0||t>=e)throw Error(`vertex ${t} is not between 0 and ${e-1}`);return!0}class x{constructor(t){m.assert(t>=0,"Number of vertices must be non-negative"),this.verts=t,this.edges=0,this.adjls=m.fill(t,(()=>new l))}clone(){let t=new x(this.V());t.edges=this.E(),t.adjls=[];for(let e=0,r=this.V();e<r;++e)t.adjls.push(this.adjls[e].clone());return t}V(){return this.verts}E(){return this.edges}addEdge(t,e){_(t,this.verts),_(e,this.verts),this.edges+=1,this.adjls[t].add(e),this.adjls[e].add(t)}adj(t){return _(t,this.verts)&&this.adjls[t]}degree(t){return _(t,this.verts)&&this.adjls[t].size()}toString(){let t=`${this.verts} vertices, ${this.edges} edges\n`;for(let e=0;e<this.verts;++e)t+=`${e}: `+o(this.adjls[e].iter()),t+="\n";return t}static load(t,e){let r=new x(t);m.assert(e.length%2==0,"wanted even n# of data points");for(let t=0;t<e.length;t+=2)r.addEdge(e[t],e[t+1]);return r}static test(){let t=x.load(13,[0,5,4,3,0,1,9,12,6,4,5,4,0,2,11,12,9,10,0,6,7,8,9,11,5,3]);t.degree(1),console.log(t.toString());let e=t.clone();console.log("cloned=\n"+e.toString())}}class y{constructor(t,e){this.bMarked=new Array(t.V()),this.nCount=0,_(e,this.bMarked.length)&&this._dfs(t,e)}_dfs(t,e){this.nCount+=1,this.bMarked[e]=!0;for(let r,s=t.adj(e).iter();s.hasNext();)r=s.next(),this.bMarked[r]||this._dfs(t,r)}marked(t){return _(t,this.bMarked.length)&&this.bMarked[t]}count(){return this.nCount}static test(){let t,e,r=x.load(13,[0,5,4,3,0,1,9,12,6,4,5,4,0,2,11,12,9,10,0,6,7,8,9,11,5,3]);[0,9].forEach((s=>{e=new y(r,s),t="";for(let s=0;s<r.V();++s)e.marked(s)&&(t+=`${s} `);console.log(t),console.log(e.count()!=r.V()?"NOT connected":"connected")}))}}class b{constructor(t,e){this.bMarked=new Array(t.V()),_(e,this.bMarked.length);let r,s,i=m.fill(t.V(),(e=>t.adj(e).iter())),n=new h;for(this.bMarked[e]=!0,n.push(e);!n.isEmpty();)r=n.peek(),i[r].hasNext()?(s=i[r].next(),this.bMarked[s]||(this.bMarked[s]=!0,n.push(s))):n.pop()}marked(t){return _(t,this.bMarked.length)&&this.bMarked[t]}static test(){let t,e,r=x.load(13,[0,5,4,3,0,1,9,12,6,4,5,4,0,2,11,12,9,10,0,6,7,8,9,11,5,3]);[0,9].forEach((s=>{e=new b(r,s),t="";for(let s=0;s<r.V();++s)e.marked(s)&&(t+=`${s} `);console.log(t)}))}}class v{constructor(t,e){this.bMarked=new Array(t.V()),this.edgeTo=new Array(t.V()),this.s=e,_(e,this.bMarked.length)&&this._dfs(t,e)}_dfs(t,e){this.bMarked[e]=!0;for(let r,s=t.adj(e).iter();s.hasNext();)r=s.next(),this.bMarked[r]||(this.edgeTo[r]=e,this._dfs(t,r))}hasPathTo(t){return _(t,this.bMarked.length)&&this.bMarked[t]}pathTo(t){if(_(t,this.bMarked.length)&&this.hasPathTo(t)){let e=new h;for(let r=t;r!=this.s;r=this.edgeTo[r])e.push(r);return e.push(this.s),e.iter()}}static test(){let t=x.load(6,[0,5,2,4,2,3,1,2,0,1,3,4,3,5,0,2]),e=new v(t,0);for(let r,s,i=0;i<t.V();++i)if(e.hasPathTo(i)){r=`0 to ${i}:  `;for(let t=e.pathTo(i);t.hasNext();)s=t.next(),r+=0==s?s:`-${s}`;console.log(r)}else console.log(`0 to ${i}:  not connected\n`)}}function T(t,e){if(!t||0==t.length)throw Error("argument is null or empty");return t.forEach((t=>_(t,e))),!0}class S{constructor(t,e){this.bMarked=new Array(t.V()),this.mDistTo=new Array(t.V()),this.edgeTo=new Array(t.V()),g.vec(e)||(e=[e]),T(e,t.V()),function(t,e,r){let s,i=[];for(s=0;s<t.V();++s)r.mDistTo[s]=1/0;for(e.forEach((t=>{r.bMarked[t]=!0,r.mDistTo[t]=0,i.push(t)}));i.length>0;){s=i.shift();for(let e,n=t.adj(s).iter();n.hasNext();)e=n.next(),r.bMarked[e]||(r.edgeTo[e]=s,r.mDistTo[e]=r.mDistTo[s]+1,r.bMarked[e]=!0,i.push(e))}}(t,e,this),function(t,e,r){if(0!=r.mDistTo[e])throw Error(`dist of source ${e} to itself = ${r.mDistTo[e]}`);for(let e=0;e<t.V();++e)for(let s,i=t.adj(e).iter();i.hasNext();){if(s=i.next(),r.hasPathTo(e)!==r.hasPathTo(s))throw Error(`edge ${e}-${s}hasPathTo(${e})=${r.hasPathTo(e)}hasPathTo(${s})=${r.hasPathTo(s)}`);if(r.hasPathTo(e)&&r.mDistTo[s]>r.mDistTo[e]+1)throw Error(`edge ${e}-${s}distTo[${e}]=${r.mDistTo[e]}distTo[${s}]=${r.mDistTo[s]}`)}for(let s,i=0;i<t.V();++i)if(r.hasPathTo(i)&&i!=e&&(s=r.edgeTo[i],r.mDistTo[i]!=r.mDistTo[s]+1))throw Error(`shortest path edge ${s}-${i} distTo[${s}]= ${r.mDistTo[s]}distTo[${i}]= ${r.mDistTo[i]}`)}(t,e,this)}hasPathTo(t){return _(t,this.bMarked.length)&&this.bMarked[t]}distTo(t){return _(t,this.bMarked.length)&&this.mDistTo[t]}pathTo(t){if(_(t,this.bMarked.length)&&this.hasPathTo(t)){let e,r=new h;for(e=t;0!=this.mDistTo[e];e=this.edgeTo[e])r.push(e);return r.push(e),r.iter()}}static test(){let t=x.load(6,[0,5,2,4,2,3,1,2,0,1,3,4,3,5,0,2]),e=new S(t,0);for(let r,s=0;s<t.V();++s)if(e.hasPathTo(s)){r=`0 to ${s}(${e.distTo(s)}): `;for(let t,i=e.pathTo(s);i.hasNext();)t=i.next(),r+=0==t?`${t}`:`-${t}`;console.log(r)}else console.log(`0 to ${s} (-):  not connected\n`)}}class w{constructor(t,e,r){if(t<0)throw Error("vertex index must be a non-negative integer");if(e<0)throw Error("vertex index must be a non-negative integer");this.v=t,this.w=e,this._weight=r}weight(){return this._weight}either(){return this.v}other(t){if(t==this.v)return this.w;if(t==this.w)return this.v;throw Error("Illegal endpoint")}static comparator(t,e){return t._weight<e._weight?-1:t._weight>e._weight?1:0}toString(){return`${this.v}-${this.w} ${this._weight}`}static test(){console.log(new w(12,34,5.67).toString())}}class E{constructor(t){if(t<0)throw Error("Number of vertices must be non-negative");this._V=t,this._E=0,this.adjls=m.fill(t,(()=>new l))}static randGraph(t,e){let r=new E(t);if(e<0)throw Error("Number of edges must be non-negative");for(let s,i,n,o=0;o<e;++o)i=m.randInt(t),n=m.randInt(t),s=Math.round(100*m.rand())/100,r.addEdge(new w(i,n,s));return r}clone(){let t=new E(this.V());t._E=this.E();for(let e=0;e<this.V();++e)t.adjls[e]=this.adjls[e].clone();return t}V(){return this._V}E(){return this._E}addEdge(t){let e=t.either(),r=t.other(e);_(e,this._V),_(r,this._V),this.adjls[e].add(t),this.adjls[r].add(t),this._E+=1}adj(t){return _(t,this._V)&&this.adjls[t]}degree(t){return _(t,this._V)&&this.adjls[t].size()}edges(){const t=new l;for(let e,r,s,i=0;i<this._V;++i)for(r=0,e=this.adjls[i].iter();e.hasNext();)s=e.next(),s.other(i)>i?t.add(s):s.other(i)==i&&(r%2==0&&t.add(s),++r);return t.iter()}toString(){let t=`${this._V} ${this._E}\n`;for(let e,r=0;r<this._V;++r){for(t+=`${r}: `,e=this.adjls[r].iter();e.hasNext();)t+=`${e.next()}, `;t+="\n"}return t}static load(t,e){let r=new E(t);m.assert(e.length%3==0,"Invalid data size");for(let s=0;s<e.length;s+=3)_(e[s],t)&&_(e[s+1],t)&&r.addEdge(new w(e[s],e[s+1],e[s+2]));return r}static test(){let t="4 5 0.35 4 7 0.37 5 7 0.28 0 7 0.16 1 5 0.32 0 4 0.38 2 3 0.17 1 7 0.19 0 2 0.26 1 2 0.36 1 3 0.29 2 7 0.34 6 2 0.40 3 6 0.52 6 0 0.58 6 4 0.93".split(" ").map((t=>+t)),e=E.load(8,t);console.log(e.toString())}}class A{constructor(t){this.bMarked=new Array(t.V()),this._id=new Array(t.V()),this._size=new Array(t.V()),this.nCount=0;for(let e=0;e<t.V();++e)this.bMarked[e]||(this._dfs(t,e),++this.nCount)}_dfs(t,e){this.bMarked[e]=!0,this._id[e]=this.nCount,this._size[this.nCount]+=1;for(let r,s,i=t.adj(e).iter();i.hasNext();)r=i.next(),t instanceof E?(s=r.other(e),this.bMarked[s]||this._dfs(t,s)):this.bMarked[r]||this._dfs(t,r)}id(t){return _(t,this.bMarked.length)&&this._id[t]}size(t){return _(t,this.bMarked.length)&&this._size[this._id[t]]}count(){return this.nCount}connected(t,e){return _(t,this.bMarked.length)&&_(e,this.bMarked.length)&&this.id(t)==this.id(e)}static test(){let t=x.load(13,[0,5,4,3,0,1,9,12,6,4,5,4,0,2,11,12,9,10,0,6,7,8,9,11,5,3]),e=new A(t),r=e.count();console.log(r+" components");let s=m.fill(r,(()=>[]));for(let r=0;r<t.V();++r)s[e.id(r)].push(r);for(let t,e=0;e<r;++e)t="",s[e].forEach((e=>t+=e.toString()+" ")),console.log(t)}}class M{static load(t,e){if(t<0)throw Error("verts in a Digraph must be non-negative");m.assert(e.length%2==0,"expected even n# of data-length");let r=new M(t);for(let t=0;t<e.length;t+=2)r.addEdge(e[t],e[t+1]);return r}constructor(t){if(t<0)throw Error("verts in a Digraph must be non-negative");this._V=t,this._E=0,this._indegree=m.fill(t,0),this.adjls=m.fill(t,(()=>new l))}clone(){let t=this,e=new M(this.V());e._E=this.E(),e._indegree=m.fill(e.V(),(e=>t._indegree[e]));for(let t=0;t<e.V();++t)e.adjls[t]=this.adjls[t].clone();return e}V(){return this._V}E(){return this._E}addEdge(t,e){_(t,this._V)&&_(e,this._V),this.adjls[t].add(e),this._indegree[e]+=1,++this._E}adj(t){return _(t,this._V)&&this.adjls[t]}outdegree(t){return _(t,this._V)&&this.adjls[t].size()}indegree(t){return _(t,this._V)&&this._indegree[t]}reverse(){let t=new M(this._V);for(let e,r=0;r<this._V;++r)for(e=this.adjls[r].iter();e.hasNext();)t.addEdge(e.next(),r);return t}toString(){let t=`${this._V} vertices, ${this._E} edges\n`;for(let e,r=0;r<this._V;++r){for(t+=`${r}: `,e=this.adjls[r].iter();e.hasNext();)t+=`${e.next()} `;t+="\n"}return t}static test(){let t=M.load(13,"4  2 2  3 3  2 6  0 0  1 2  0 11 12 12  9 9 10 9 11 7  9 10 12 11  4 4  3 3  5 6  8 8  6 5  4 0  5 6  4 6  9 7  6".split(/\s+/).map((t=>+t))),e="",r="";for(let s=0;s<t.V();++s)e+=`${s}=${t.indegree(s)}, `,r+=`${s}=${t.outdegree(s)},`;console.log("indegreee= "+e),console.log("outdegreee= "+r),console.log(t.toString());let s=t.clone();console.log("cloned=\n"+s.toString());let i=t.reverse();console.log("rev'ed=\n"+i.toString())}}class P{constructor(t,e){this.bMarked=new Array(t.V()),g.vec(e)||(e=[e]),T(e,t.V()),e.forEach((e=>{this.bMarked[e]||this._dfs(t,e)}))}_dfs(t,e){this.mCount+=1,this.bMarked[e]=!0;for(let r,s=t.adj(e).iter();s.hasNext();)r=s.next(),this.bMarked[r]||this._dfs(t,r)}marked(t){return _(t,this.bMarked.length)&&this.bMarked[t]}count(){return this.mCount}static test(){let t=M.load(13,"4  2 2  3 3  2 6  0 0  1 2  0 11 12 12  9 9 10 9 11 7  9 10 12 11  4 4  3 3  5 6  8 8  6 5  4 0  5 6  4 6  9 7  6".split(/\s+/).map((t=>+t))),e="",r=new P(t,[1,2,6]);for(let s=0;s<t.V();++s)r.marked(s)&&(e+=`${s} `);r.count(),console.log(e)}}class R{constructor(t){this.bMarked=new Array(t.V()),this.onStack=new Array(t.V()),this.edgeTo=new Array(t.V()),this.mCycle=e;for(let e=0;e<t.V();++e)this.bMarked[e]||this.mCycle||this._dfs(t,e)}_dfs(t,e){this.onStack[e]=!0,this.bMarked[e]=!0;for(let r,s=t.adj(e).iter();s.hasNext();){if(r=s.next(),this.mCycle)return;if(this.bMarked[r]){if(this.onStack[r]){this.mCycle=new h;for(let t=e;t!=r;t=this.edgeTo[t])this.mCycle.push(t);this.mCycle.push(r),this.mCycle.push(e),this._check()}}else this.edgeTo[r]=e,this._dfs(t,r)}this.onStack[e]=!1}hasCycle(){return!!this.mCycle}cycle(){return this.mCycle&&this.mCycle.iter()}_check(){if(this.hasCycle()){let t=-1,e=-1;for(let r,s=this.cycle();s.hasNext();)r=s.next(),-1==t&&(t=r),e=r;if(t!=e)throw Error(`cycle begins with ${t} and ends with ${e}\n`)}return!0}static test(){let t="2 3 0 6 0 1 2 0 11 12  9 12  9 10  9 11 3 5 8 7 5 4 0 5 6 4 6 9 7 6".split(/\s+/).map((t=>+t)),e="4  2 2  3 3  2 6  0 0  1 2  0 11 12 12  9 9\n               10 9 11 7  9 10 12 11  4 4  3 3  5 6  8 8\n               6 5  4 0  5 6  4 6  9 7  6".split(/\s+/).map((t=>+t));[new R(M.load(13,e)),new R(M.load(13,t))].forEach((t=>{t.hasCycle()?(console.log("Directed cycle: "),console.log(o(t.cycle()))):console.log("No directed cycle")}))}}class O{constructor(t,e,r){if(t<0)throw Error("Vertex names must be non-negative integers");if(e<0)throw Error("Vertex names must be non-negative integers");this.v=t,this.w=e,this._weight=r}from(){return this.v}to(){return this.w}weight(){return this._weight}toString(){return`${this.v}->${this.w} ${Number(this._weight).toFixed(2)}`}static test(){console.log(new O(12,34,5.67).toString())}}class C{constructor(t){if(t<0)throw Error("Number of vertices in a Digraph must be non-negative");this._V=t,this._E=0,this._indegree=new Array(t),this.adjls=m.fill(t,(()=>new l))}static randGraph(t,e){if(e<0)throw Error("n# edges in a Digraph must be non-negative");let r=new C(t);for(let s=0;s<e;++s)r.addEdge(new O(m.randInt(t),m.randInt(t),.01*_randInt(100)));return r}static load(t,e){if(t<0)throw Error("n# vertices in a Digraph must be non-negative");m.assert(e.length%3==0,"bad data length");let r=new C(t);for(let s=0;s<e.length;s+=3)_(e[s],t)&&_(e[s+1],t)&&r.addEdge(new O(e[s],e[s+1],e[s+2]));return r}clone(){let t=new C(this.V());t._E=this.E();for(let e=0;e<this.V();++e)t._indegree[e]=this._indegree(e);for(let e=0;e<this.V();++e)t.adjls[e]=this.adjls[e].clone();return t}V(){return this._V}E(){return this._E}addEdge(t){m.assert(t instanceof O,"Expected DirectedEdge");let e=t.to(),r=t.from();_(r,this._V),_(e,this._V),this.adjls[r].add(t),this._indegree[e]+=1,this._E++}adj(t){return _(t,this._V)&&this.adjls[t]}outdegree(t){return _(t,this._V)&&this.adjls[t].size()}indegree(t){return _(t,this._V)&&this._indegree[t]}edges(){const t=new l;for(let e=0;e<this._V;++e)for(let r=this.adj(e).iter();r.hasNext();)t.add(r.next());return t.iter()}toString(){let t=`${this._V} ${this._E}\n`;for(let e=0;e<this._V;++e)t+=`${e}: `+o(this.adjls[e].iter())+"\n";return t}static test(){let t="4 5 0.35\n        5 4 0.35\n        4 7 0.37\n        5 7 0.28\n        7 5 0.28\n        5 1 0.32\n        0 4 0.38\n        0 2 0.26\n        7 3 0.39\n        1 3 0.29\n        2 7 0.34\n        6 2 0.40\n        3 6 0.52\n        6 0 0.58\n        6 4 0.93".split(/\s+/).map((t=>+t)),e=C.load(8,t);console.log(e.toString())}}class I{constructor(t){this._pre=new Array(t.V()),this._post=new Array(t.V()),this.preCounter=0,this.postCounter=0,this.postorder=new u,this.preorder=new u,this.bMarked=new Array(t.V());for(let e=0;e<t.V();e++)this.bMarked[e]||this._dfs(t,e);this._check()}_dfs(t,e){this.bMarked[e]=!0,this._pre[e]=this.preCounter++,this.preorder.enqueue(e);for(let r,s=t.adj(e).iter();s.hasNext();)r=t instanceof C?s.next().to():s.next(),this.bMarked[r]||this._dfs(t,r);this.postorder.enqueue(e),this._post[e]=this.postCounter++}pre(t){return _(t,this.bMarked.length)&&this._pre[t]}post(t){return _(t,this.bMarked.length)&&this._post[t]}postOrder(){return this.postorder.iter()}preOrder(){return this.preorder.iter()}reversePost(){let t=new h;for(let e=this.postorder.iter();e.hasNext();)t.push(e.next());return t.iter()}_check(){let t,e=0;for(t=this.postOrder();t.hasNext();){if(this.post(t.next())!=e)throw Error("post(v) and post() inconsistent");++e}for(e=0,t=this.preOrder();t.hasNext();){if(this.pre(t.next())!=e)throw Error("pre(v) and pre() inconsistent");++e}return!0}static test(){let t=M.load(13,"2 3 0 6 0 1 2 0 11 12  9 12  9 10  9 11 3 5 8 7 5 4 0 5 6 4 6 9 7 6".split(/\s+/).map((t=>+t)));console.log(t.toString());let e=new I(t);console.log("   v  pre  post"),console.log("--------------");for(let r=0;r<t.V();++r)console.log(`    ${r}  ${e.pre(r)}  ${e.post(r)}\n`);console.log("Preorder:  "),console.log(o(e.preOrder())),console.log("Postorder:  "),console.log(o(e.postOrder())),console.log(""),console.log("Reverse postorder: "),console.log(o(e.reversePost()))}}class G{constructor(t){m.assert(t instanceof C,"Expected EdgeWeightedDigraph"),this.bMarked=new Array(t.V()),this.onStack=new Array(t.V()),this.edgeTo=new Array(t.V());for(let e=0;e<t.V();++e)this.bMarked[e]||this._dfs(t,e);this._check()}_dfs(t,e){this.onStack[e]=!0,this.bMarked[e]=!0;for(let r,s,i=t.adj(e).iter();i.hasNext();){if(s=i.next(),r=s.to(),this.mCycle)return;if(this.bMarked[r]){if(this.onStack[r]){this.mCycle=new h;let t=s;for(;t.from()!=r;)this.mCycle.push(t),t=this.edgeTo[t.from()];return void this.mCycle.push(t)}}else this.edgeTo[r]=s,this._dfs(t,r)}this.onStack[e]=!1}hasCycle(){return m.echt(this.mCycle)}cycle(){return this.mCycle&&this.mCycle.iter()}_check(){if(this.hasCycle()){let t=e,r=e;for(let e,s=this.cycle();s.hasNext();){if(e=s.next(),t||(t=e),r&&r.to()!=e.from())throw Error(`cycle edges ${r} and ${e} not incident\n`);r=e}if(r.to()!=t.from())throw Error(`cycle edges ${r} and ${t} not incident\n`)}return!0}static test(){let t=13,e=new C(t);m.shuffle(m.fill(t,(t=>t)));for(let r,s,i,n=0;n<8;++n){do{s=m.randInt(t),i=m.randInt(t)}while(s>=i);r=m.rand(),e.addEdge(new O(s,i,r))}for(let r=0;r<6;++r)e.addEdge(new O(m.randInt(t),m.randInt(t),m.rand()));console.log(e.toString());let r=new G(e);r.hasCycle()?console.log("Cycle: "+o(r.cycle())):console.log("No directed cycle")}}class k{constructor(t){this.st=new c,t.forEach((t=>t.forEach(((t,e)=>{this.st.contains(t)||this.st.put(t,this.st.size())})))),this.keys=new Array(this.st.size());for(let t,e=this.st.keys();e.hasNext();)t=e.next(),this.keys[this.st.get(t)]=t;this._graph=new x(this.st.size()),t.forEach((t=>{let e=this.st.get(t[0]);for(let r,s=1;s<t.length;++s)r=this.st.get(t[s]),this._graph.addEdge(e,r)}))}contains(t){return this.st.contains(t)}indexOf(t){return this.st.get(t)}nameOf(t){return _(t,this._graph.V())&&this.keys[t]}graph(){return this._graph}static test(){let t="JFK MCO\n                  ORD DEN\n                  ORD HOU\n                  DFW PHX\n                  JFK ATL\n                  ORD DFW\n                  ORD PHX\n                  ATL HOU\n                  DEN PHX\n                  PHX LAX\n                  JFK ORD\n                  DEN LAS\n                  DFW HOU\n                  ORD ATL\n                  LAS LAX\n                  ATL MCO\n                  HOU MCO\n                  LAS PHX".split(/\s+/),e=new k(m.partition(2,t)),r=e.graph();["JFK","LAX"].forEach((t=>{if(e.contains(t)){let s=e.indexOf(t);console.log(t);for(let t=r.adj(s).iter();t.hasNext();)console.log("   "+e.nameOf(t.next()))}else console.log("input not contain '"+t+"'")}))}}class B{constructor(t){this.st=new c,t.forEach((t=>t.forEach((t=>{this.st.contains(t)||this.st.put(t,this.st.size())})))),this.keys=new Array(this.st.size());for(let t,e=this.st.keys();e.hasNext();)t=e.next(),this.keys[this.st.get(t)]=t;this.graph=new M(this.st.size()),t.forEach((t=>{let e=this.st.get(t[0]);for(let r=1;r<t.length;++r)this.graph.addEdge(e,this.st.get(t[r]))}))}contains(t){return this.st.contains(t)}indexOf(t){return this.st.get(t)}nameOf(t){return _(t,this.graph.V())&&this.keys[t]}digraph(){return this.graph}static test(){let t="JFK MCO\n              ORD DEN\n              ORD HOU\n              DFW PHX\n              JFK ATL\n              ORD DFW\n              ORD PHX\n              ATL HOU\n              DEN PHX\n              PHX LAX\n              JFK ORD\n              DEN LAS\n              DFW HOU\n              ORD ATL\n              LAS LAX\n              ATL MCO\n              HOU MCO\n              LAS PHX".split(/\s+/),e=new B(m.partition(2,t)),r=e.digraph();["JFK","ATL","LAX"].forEach((t=>{console.log(`${t}`);let s=r.adj(e.indexOf(t)).iter();for(;s.hasNext();)console.log("   "+e.nameOf(s.next()))}))}}class D{constructor(t){let r;if(this._order=e,this.rank=e,t instanceof C?r=new G(t):t instanceof M?(r=new R(t),r.hasCycle()||(this.rank=new Array(t.V()))):m.assert(!1,"bad arg for Topological"),r&&!r.hasCycle()){this._order=new u;for(let e,r=0,s=new I(t).reversePost();s.hasNext();)e=s.next(),this.rank&&(this.rank[e]=r++),this._order.enqueue(e)}}order(){return this._order.iter()}hasOrder(){return m.echt(this._order)}rank(t){return this.rank&&_(t,this.rank.length)&&this.hasOrder()?this.rank[t]:-1}static test(){let t=new B([["Algorithms","Theoretical CS","Databases","Scientific Computing"],["Introduction to CS","Advanced Programming","Algorithms"],["Advanced Programming","Scientific Computing"],["Scientific Computing","Computational Biology"],["Theoretical CS","Computational Biology","Artificial Intelligence"],["Linear Algebra","Theoretical CS"],["Calculus","Linear Algebra"],["Artificial Intelligence","Neural Networks","Robotics","Machine Learning"],["Machine Learning","Neural Networks"]]);for(let e=new D(t.digraph()).order();e.hasNext();)console.log(t.nameOf(e.next()))}}class F{constructor(t,e){this.bMarked=new Array(t.V()),this.edgeTo=new Array(t.V()),this.s=e,_(e,this.bMarked.length)&&this._dfs(t,e)}_dfs(t,e){this.bMarked[e]=!0;for(let r,s=t.adj(e).iter();s.hasNext();)r=s.next(),this.bMarked[r]||(this.edgeTo[r]=e,this._dfs(t,r))}hasPathTo(t){return _(t,this.bMarked.length)&&this.bMarked[t]}pathTo(t){if(_(t,this.bMarked.length)&&this.hasPathTo(t)){let e=new h;for(let r=t;r!=this.s;r=this.edgeTo[r])e.push(r);return e.push(this.s),e.iter()}}static test(){let t,e="4  2 2  3 3  2 6  0 0  1 2  0 11 12 12  9 9 10\n              9 11 7  9 10 12 11  4 4  3 3  5 6\n              8 8  6 5  4 0  5 6  4 6  9 7  6".split(/\s+/).map((t=>+t)),r=M.load(13,e),s=new F(r,3);for(let e=0;e<r.V();++e)if(s.hasPathTo(e)){t=`3 to ${e}:  `;for(let r,i=s.pathTo(e);i.hasNext();)r=i.next(),t+=3==r?`${r}`:`-${r}`;console.log(t)}else console.log(`3 to ${e}:  not connected`)}}class N{constructor(t,e){g.vec(e)||(e=[e]),this.bMarked=new Array(t.V()),this.mDistTo=new Array(t.V()),this.edgeTo=new Array(t.V());for(let e=0;e<t.V();++e)this.mDistTo[e]=1/0;T(e,t.V())&&this._bfs(t,e)}_bfs(t,e){let r=new u;for(e.forEach((t=>{this.bMarked[t]=!0,this.mDistTo[t]=0,r.enqueue(t)}));!r.isEmpty();){let e=r.dequeue();for(let s,i=t.adj(e).iter();i.hasNext();)s=i.next(),this.bMarked[s]||(this.edgeTo[s]=e,this.mDistTo[s]=this.mDistTo[e]+1,this.bMarked[s]=!0,r.enqueue(s))}}hasPathTo(t){return _(t,this.bMarked.length)&&this.bMarked[t]}distTo(t){return _(t,this.bMarked.length)&&this.mDistTo[t]}pathTo(t){if(_(t,this.bMarked.length)&&this.hasPathTo(t)){let e,r=new h;for(e=t;0!=this.mDistTo[e];e=this.edgeTo[e])r.push(e);return r.push(e),r.iter()}}static test(){let t,e="4  2 2  3 3  2 6  0 0  1 2  0 11 12 12  9 9 10\n              9 11 7  9 10 12 11  4 4  3 3  5 6\n              8 8  6 5  4 0  5 6  4 6  9 7  6".split(/\s+/).map((t=>+t)),r=M.load(13,e),s=new N(r,3);for(let e=0;e<r.V();++e)if(t="",s.hasPathTo(e)){t=`3 to ${e} (${s.distTo(e)}):  `;for(let r,i=s.pathTo(e);i.hasNext();)r=i.next(),t+=3==r?`${r}`:`->${r}`;console.log(t)}else console.log(`3 to ${e} (-):  not connected`)}}class U{constructor(t,e,r){m.assert(t instanceof C,"Expected EdgeWeightedDigraph");for(let e,r=t.edges();r.hasNext();)if(e=r.next(),e.weight()<0)throw Error(`edge ${e} has negative weight`);this._distTo=new Array(t.V()),this.edgeTo=m.fill(t.V(),null),_(e,t.V());for(let e=0;e<t.V();++e)this._distTo[e]=1/0;for(this._distTo[e]=0,this.pq=new p(t.V(),r),this.pq.insert(e,this._distTo[e]);!this.pq.isEmpty();){let e=this.pq.delMin();for(let r=t.adj(e).iter();r.hasNext();)this._relax(r.next())}this._check(t,e)}_relax(t){let e=t.from(),r=t.to();this._distTo[r]>this._distTo[e]+t.weight()&&(this._distTo[r]=this._distTo[e]+t.weight(),this.edgeTo[r]=t,this.pq.contains(r)?this.pq.decreaseKey(r,this._distTo[r]):this.pq.insert(r,this._distTo[r]))}distTo(t){return _(t,this._distTo.length)&&this._distTo[t]}hasPathTo(t){return _(t,this._distTo.length)&&this._distTo[t]<1/0}pathTo(t){if(_(t,this._distTo.length)&&this.hasPathTo(t)){let e=new h;for(let r=this.edgeTo[t];r;r=this.edgeTo[r.from()])e.push(r);return e.iter()}}_check(t,e){for(let e=t.edges();e.hasNext();)if(e.next().weight()<0)throw Error("negative edge weight detected");if(0!=this._distTo[e]||this.edgeTo[e])throw Error("distTo[s] and edgeTo[s] inconsistent");for(let r=0;r<t.V();++r)if(r!=e&&!this.edgeTo[r]&&this._distTo[r]!=1/0)throw Error("distTo[] and edgeTo[] inconsistent");for(let e=0;e<t.V();++e)for(let r,s,i=t.adj(e).iter();i.hasNext();)if(s=i.next(),r=s.to(),this._distTo[e]+s.weight()<this._distTo[r])throw Error(`edge ${s} not relaxed`);for(let e,r,s=0;s<t.V();++s)if(this.edgeTo[s]){if(r=this.edgeTo[s],e=r.from(),s!=r.to())throw Error("bad edge");if(this._distTo[e]+r.weight()!=this._distTo[s])throw Error(`edge ${r} on shortest path not tight`)}return!0}static test(){let t="4 5 0.35\n                  5 4 0.35\n                  4 7 0.37\n                  5 7 0.28\n                  7 5 0.28\n                  5 1 0.32\n                  0 4 0.38\n                  0 2 0.26\n                  7 3 0.39\n                  1 3 0.29\n                  2 7 0.34\n                  6 2 0.40\n                  3 6 0.52\n                  6 0 0.58\n                  6 4 0.93".split(/\s+/).map((t=>+t)),e=C.load(8,t),r=new U(e,0,d);for(let t=0;t<e.V();++t)r.hasPathTo(t)?console.log(`0 to ${t} (${Number(r.distTo(t)).toFixed(2)})  ${o(r.pathTo(t))}`):console.log(`0 to ${t}         no path\n`)}}class L{constructor(t,e,r){m.assert(t instanceof E,"Expected EdgeWeightedGraph");for(let e,r=t.edges();r.hasNext();)if(e=r.next(),e.weight()<0)throw new Error(`edge ${e} has negative weight`);for(this._distTo=m.fill(t.V(),(()=>1/0)),this._distTo[e]=0,this.compare=r,this.edgeTo=m.fill(t.V(),(()=>null)),_(e,t.V()),this.pq=new p(t.V(),this.compare),this.pq.insert(e,this._distTo[e]);!this.pq.isEmpty();){let e=this.pq.delMin();for(let r=t.adj(e).iter();r.hasNext();)this._relax(r.next(),e)}this._check(t,e)}_relax(t,e){let r=t.other(e);this._distTo[r]>this._distTo[e]+t.weight()&&(this._distTo[r]=this._distTo[e]+t.weight(),this.edgeTo[r]=t,this.pq.contains(r)?this.pq.decreaseKey(r,this._distTo[r]):this.pq.insert(r,this._distTo[r]))}distTo(t){return _(t,this._distTo.length)&&this._distTo[t]}hasPathTo(t){return _(t,this._distTo.length)&&this._distTo[t]<1/0}pathTo(t){if(_(t,this._distTo.length)&&this.hasPathTo(t)){let e=t,r=new h;for(let s=this.edgeTo[t];s;s=this.edgeTo[e])r.push(s),e=s.other(e);return r.iter()}}_check(t,e){for(let e=t.edges();e.hasNext();)if(e.next().weight()<0)throw Error("negative edge weight detected");if(0!=this._distTo[e]||this.edgeTo[e])throw Error("distTo[s] and edgeTo[s] inconsistent");for(let r=0;r<t.V();++r)if(r!=e&&!this.edgeTo[r]&&this._distTo[r]!=1/0)throw Error("distTo[] and edgeTo[] inconsistent");for(let e=0;e<t.V();++e)for(let r,s,i=t.adj(e).iter();i.hasNext();)if(s=i.next(),r=s.other(e),this._distTo[e]+s.weight()<this._distTo[r])throw Error(`edge ${s} not relaxed`);for(let e,r,s=0;s<t.V();++s)if(this.edgeTo[s]){if(r=this.edgeTo[s],s!=r.either()&&s!=r.other(r.either()))return!1;if(e=r.other(s),this._distTo[e]+r.weight()!=this._distTo[s])throw Error(`edge ${r} on shortest path not tight`)}return!0}static test(){let t="4 5 0.35 4 7 0.37 5 7 0.28 0 7 0.16 1 5 0.32 0 4 0.38\n                  2 3 0.17 1 7 0.19 0 2 0.26 1 2 0.36 1 3 0.29 2 7 0.34\n                  6 2 0.40 3 6 0.52 6 0 0.58 6 4 0.93".split(/\s+/).map((t=>+t)),e=E.load(8,t),r=new L(e,6,d);for(let t,s=0;s<e.V();++s)if(r.hasPathTo(s)){t=`6 to ${s} (${Number(r.distTo(s)).toFixed(2)})  `;for(let e=r.pathTo(s);e.hasNext();)t+=`${e.next()}   `;console.log(t)}else console.log(`6 to ${s}         no path`)}}return{DepthFirstDirectedPaths:F,BreadthFirstDirectedPaths:N,SymbolGraph:k,DijkstraUndirectedSP:L,DijkstraSP:U,Topological:D,SymbolDigraph:B,EdgeWeightedDirectedCycle:G,DepthFirstOrder:I,EdgeWeightedDigraph:C,DirectedEdge:O,DirectedCycle:R,DirectedDFS:P,Digraph:M,CC:A,EdgeWeightedGraph:E,Edge:w,BreadthFirstPaths:S,DepthFirstPaths:v,NonrecursiveDFS:b,DepthFirstSearch:y,Graph:x}}"object"==typeof module&&module.exports?module.exports=r(require("../main/core"),require("../main/math"),require("./basic"),require("./sort")):t["io/czlab/mcfud/algo/graph"]=r}(this),function(t,e){"use strict";function r(e){e||(e=t["io/czlab/mcfud/core"]()),Math.floor;const{u:r,is:s}=e,i={mutationRate:.1,crossOverRate:.7,probTournament:.75,NUM_HIDDEN:1,BIAS:-1,NUM_ELITE:4,TOURNAMENT_SIZE:5,MAX_PERTURBATION:.3,ACTIVATION_RESPONSE:1,NEURONS_PER_HIDDEN:10};class n{constructor(){}gt(t){}lt(t){}eq(t){}clone(){}score(){}update(t){}}class o extends n{constructor(t,e){super(),this.value=t,this.flip=e}gt(t){return this.flip?this.value<t.value:this.value>t.value}eq(t){return this.value==t.value}lt(t){return this.flip?this.value>t.value:this.value<t.value}score(){return this.value}update(t){this.value=t}clone(){return new o(this.value,this.flip)}}class a{constructor(){this.averageScore=0,this.totalScore=0,this.bestScore=0,this.worstScore=0,this.best=void 0}}class l{constructor(t){const e=r.fill(t+1,(()=>r.randMinus1To1()));this.numInputs=e.length,this.activation=0,this.weights=e,this.error=0}}class h{constructor(t,e){this.numNeurons=t,this.neurons=r.fill(t,(()=>new l(e)))}}class u{constructor(t,e){this.fitness=e,this.genes=t,this.age=0}clone(){return new u(this.genes.slice(),this.fitness.clone())}}function c(t){let e=r.randInt(t.length),s=r.randInt(t.length);return e<s?[e,s]:[s,e]}function d(t,e){let s,i=0,n=r.rand(),o=t.map((t=>i+=t.fitness.score()/e));for(s=0;s<o.length-1;++s)if(n>=o[s]&&n<=o[s+1])return t[s];return t[0]}function p(t){let e=r.randInt(t.length),s=r.randInt(t.length);for(;e==s;)s=r.randInt2(0,t.length-1);return r.rand()<i.probTournament?t[e].fitness.gt(t[s].fitness)?t[e]:t[s]:t[e].fitness.lt(t[s].fitness)?t[e]:t[s]}function f(t,e){let r=0,s=1/0,i=new a;function n(t){r=t.fitness.score(),i.bestScore=r,i.best=t}function o(t){s=t.fitness.score(),i.worstScore=s}return e&&(s=0,r=1/0),t.forEach((t=>{e?t.fitness.score()<r?n(t):t.fitness.score()>s&&o(t):t.fitness.score()>r?n(t):t.fitness.score()<s&&o(t),i.totalScore+=t.fitness.score()})),i.averageScore=i.totalScore/t.length,i}function g(t,e="cycles"){let s=t.startTime=r.now();return t[e]=0,s}function m(t){return t.endTime=r.now()}function _(t,e,s,i,n){let o=r.randInt(e.length);for(;e.length>1&&o==t;)o=r.randInt(e.length);let a,l,h=e[t].genes,c=e[o].genes;s?[a,l]=s(h,c):(a=h.slice(),l=c.slice()),i&&(i(a),i(l));let d=n(a,e[t].fitness),p=n(l,e[o].fitness);return d.gt(p)?new u(a,d):new u(l,p)}function x(t,e){let r,s=0;for(;s<t.length&&(r=t[s],!r.fitness.eq(e.fitness)&&!e.fitness.lt(r.fitness));++s);return s}function y(t,{calcFit:e,crossOver:n,create:o,mutate:a}){if(s.num(t))return r.fill(t,(()=>o()));let l,h,c,g,m=[],_=f(t);t.sort(((t,e)=>t.fitness.lt(e.fitness)?-1:t.fitness.gt(e.fitness)?1:0));for(let e=i.NUM_ELITES,r=t.length-1;r>=0&&e>0;--r)m.push(t[r]),--e;for(;m.length<t.length;)void 0!==i.TOURNAMENT_SIZE?(c=p(t),g=p(t)):(c=d(t,_),g=d(t,_)),n?[l,h]=n(c.genes,g.genes):(l=c.genes.slice(),h=g.genes.slice()),a&&(a(l),a(h)),m.push(new u(l,e(l,c.fitness)),new u(h,e(h,g.fitness)));for(;m.length>t.length;)m.pop();return m}return{NeuronLayer:h,Neuron:l,NeuralNet:class{constructor(t,e,s,i){this.layers=function(n){if(s>0){n.push(new h(i,t));for(let t=0;t<s-1;++t)n.push(new h(i,i))}return r.conj(n,new h(e,s>0?i:t))}([]),this.numOfWeights=this.layers.reduce(((t,e)=>t+e.neurons.reduce(((t,e)=>t+e.weights.length),0)),0),this.numOutputs=e,this.numInputs=t,this.numHidden=s,this.neuronsPerHidden=i}putWeights(t){r.assert(t.length>=this.numOfWeights,"bad input to putWeights");let e=0;this.layers.forEach((r=>r.neurons.forEach((r=>r.weights.forEach(((s,i)=>r.weights[i]=t[e++]))))))}getWeights(){const t=[];for(let e=0;e<this.numHidden+1;++e)for(let r=0;r<this.layers[e].numNeurons;++r)for(let s=0;s<this.layers[e].neurons[r].numInputs;++s)t.push(this.layers[e].neurons[r].weights[s]);return t}getNumberOfWeights(){return this.numOfWeights}feedForward(t){return this.update(t)}update(t){r.assert(t.length>=this.numInputs,"invalid input size");let e,s,n,o=[];return this.layers.forEach(((r,a)=>{a>0&&(t=o),o=[],r.neurons.forEach((r=>{n=0,e=0,s=r.numInputs;for(let i=0;i<s-1;++i)e+=r.weights[i]*t[n++];e+=r.weights[s-1]*i.BIAS,o.push(r.activation=this.sigmoid(e,i.ACTIVATION_RESPONSE))}))})),r.assert(o.length==this.numOutputs,"out length incorrect")?o:[]}sigmoid(t,e){return 1/(1+Math.exp(-t/e))}calcSplitPoints(){let t=[],e=0;return this.layers.forEach((r=>r.neurons.forEach((r=>{e+=r.numInputs,t.push(e-1)})))),t}},runGASearch:function(t,e){let s,i,n=g(e),o=e.maxCycles||100,a=1e3*(e.maxSeconds||30),l=function*([t,e],{mutate:s,create:i,maxAge:n,calcFit:o,poolSize:a,crossOver:l}){let h,u=i();yield u;let c,d,p,f,g,m=[u],y=[u];a=a||1,n=n||50;for(let t=0;t<a-1;++t)h=i(),h.fitness.gt(u.fitness)&&(yield u=h,y.push(h)),m.push(h);for(g=a-1,f=1;;)if(r.now()-t>e&&(yield u),f=f>0?f-1:g,h=m[f],d=_(f,m,l,s,o),h.fitness.gt(d.fitness)){if(void 0===n)continue;if(h.age+=1,n>h.age)continue;if(p=x(y,d,y.length),c=p/y.length,r.rand()<Math.exp(-c)){m[f]=d;continue}u.age=0,m[f]=u}else d.fitness.gt(h.fitness)?(d.age=0,m[f]=d,d.fitness.gt(u.fitness)&&(yield u=d,y.push(u))):(d.age=h.age+1,m[f]=d)}([n,a],e);for(;;){if(s=l.next().value,i=m(e),i-n>a){i=null;break}if(!t.gt(s.fitness))break;if(e.cycles>=o)break;e.cycles+=1}return[null==i,s]},runGACycle:function(t,e){let s,i,{maxCycles:n,targetScore:o,maxSeconds:a}=e,l=g(e),h=1e3*(a||30);for(n=n||100;;){if(t=y(t,e),i=m(e),i-l>h){i=null;break}if(s=f(t),r.echt(o)&&s.bestScore>=o)break;if(e.cycles>=n)break;e.cycles+=1}return e.gen++,[null==i,t]},calcStats:f,NumFitness:o,Fitness:n,Chromosome:u,mutateSM:function(t){if(r.rand()<i.mutationRate){let e,[s,i]=c(t),n=i-s-1;if(2==n)e=t[s+1],t[s+1]=t[s+2],t[s+2]=e;else if(n>2){e=r.shuffle(t.slice(s+1,i));for(let r=0,n=s+1;n<i;++n)t[n]=e[r++]}}},mutateDM:function(t){if(r.rand()<i.mutationRate){let e,s,i,[n,o]=c(t),a=t.length;o-n-1>0&&(s=t.slice(n+1,o),i=t.slice(0,n+1).concat(t.slice(o)),e=r.randInt(i.length),s=i.slice(0,e).concat(s).concat(i.slice(e)),t.length=0,s.forEach((e=>t.push(e))),r.assert(t.length==a,"mutateDM error"))}},mutateIVM:function(t){if(r.rand()<i.mutationRate){let e,[s,i]=c(t),n=t.length;if(i-s-1>1){e=t.slice(s+1,i).reverse();for(let r=0,n=s+1;n<i;++n)t[n]=e[r++]}r.assert(n==t.length,"mutateIVM error")}},mutateDIVM:function(t){if(r.rand()<i.mutationRate){let e,s,i,[n,o]=c(t),a=t.length;o-n-1>0&&(s=t.slice(n+1,o).reverse(),i=t.slice(0,n+1).concat(t.slice(o)),e=r.randInt(i.length),s=i.slice(0,e).concat(s).concat(i.slice(e)),t.length=0,s.forEach((e=>t.push(e))),r.assert(t.length==a,"mutateDIVM error"))}},crossOverOBX:function(t,e){let s,n,o,a,l;if(r.randInt2(0,t.length-2),o=t.slice(),a=e.slice(),r.rand()>i.crossOverRate||t===e);else{n=r.listIndexesOf(t,!0).slice(0,r.toGoldenRatio(t.length)[1]).sort(),s=n.map((e=>t[e])),l=0;for(let t=0;t<a.length;++t)for(let e=0;e<s.length;++e)if(a[t]==s[e]){a[t]=s[l++];break}s.length=0,l=0;for(let t=0;t<n.length;++t)s.push(e[n[t]]);for(let t=0;t<o.length;++t)for(let e=0;e<s.length;++e)if(o[t]==s[e]){o[t]=s[l++];break}}return[o,a]},crossOverPBX:function(t,e){let s,n;if(r.rand()>i.crossOverRate||t===e)s=t.slice(),n=e.slice();else{s=r.fill(t.length,null),n=r.fill(t.length,null),r.listIndexesOf(t,!0).slice(0,r.toGoldenRatio(t.length)[1]).sort().forEach((r=>{s[r]=t[r],n[r]=e[r]}));let i=0,o=0;for(let r=0;r<t.length;++r){for(;null!==n[o]&&o<t.length;)++o;for(n.indexOf(t[r])<0&&(n[o]=t[r]);null!==s[i]&&i<t.length;)++i;s.indexOf(e[r])<0&&(s[i]=e[r])}r.assert(!s.some((t=>null===t)),"crossOverPBX null error"),r.assert(!n.some((t=>null===t)),"crossOverPBX null error")}return[s,n]},crossOverRND:function(t,e){let s,n;if(r.rand()>i.crossOverRate||t===e)s=t.slice(),n=e.slice();else{let i=r.randInt(t.length);s=[],n=[];for(let r=0;r<i;++r)s.push(t[r]),n.push(e[r]);for(let r=i;r<t.length;++r)s.push(e[r]),n.push(t[r])}return[s,n]},crossOverPMX:function(t,e){let s=t.slice(),n=e.slice();if(r.rand()>i.crossOverRate||t===e);else{let i=r.randInt2(0,t.length-2),o=i;for(;o<=i;)o=r.randInt2(0,t.length-1);for(let a,l,h,u,c=i;c<o+1;++c)h=t[c],u=e[c],h!=u&&(a=s.indexOf(h),l=s.indexOf(u),r.swap(s,a,l),a=n.indexOf(h),l=n.indexOf(u),r.swap(n,a,l))}return[s,n]},crossOverAtSplits:function(t,e,s){let n,o;if(r.rand()>i.crossOverRate||t===e)n=t.slice(),o=e.slice();else{let i=s[r.randInt2(0,s.length-2)],a=s[r.randInt2(i,s.length-1)];n=[],o=[];for(let r=0;r<t.length;++r)r<i||r>=a?(n.push(t[r]),o.push(e[r])):(n.push(e[r]),o.push(t[r]))}return[n,o]},hillClimb:function(t,e,s,i,n,o){o.startTime=r.now();let a,l=t(n);for(;!s(l);)a=t(i(l)),e(l,a)&&(l=a);return o.endTime=r.now(),l},showBest(t,e,s){console.log(r.fill(80,"-").join("")),console.log("total time: "+r.prettyMillis(e.endTime-e.startTime)),s&&console.log("time expired"),console.log("total generations= "+e.gen),console.log("total cycles= "+e.cycles),console.log("fitness= "+t.fitness.score()),console.log(r.fill(80,"-").join(""))},config:t=>r.inject(i,t)}}"object"==typeof module&&module.exports?module.exports=r(require("../main/core")):t["io/czlab/mcfud/algo/NNetGA"]=r}(this),function(t,e){"use strict";function r(e){e||(e=t["io/czlab/mcfud/core"]());const r=Math.floor,{u:s,is:i}=e,n={INPUT:0,HIDDEN:1,OUTPUT:2,BIAS:3,NONE:4},o={NEURON:0,LINK:1},a={SNAPSHOT:0,ACTIVE:1},l={numInputs:0,numOutputs:0,bias:-1,sigmoidResponse:1,numAddLinkAttempts:5,numTrysToFindLoopedLink:5,numTrysToFindOldLink:5,chanceAddLink:.07,chanceAddNode:.03,chanceAddRecurrentLink:-1,mutationRate:.8,maxWeightPerturbation:.5,probabilityWeightReplaced:.1,activationMutationRate:.1,maxActivationPerturbation:.1,compatibilityThreshold:.26,youngFitnessBonus:1.3,youngBonusAgeThreshhold:10,survivalRate:0,oldAgeThreshold:50,oldAgePenalty:.7,crossOverRate:.7,numGensAllowedNoImprovement:15,maxPermittedNeurons:100,numBestElites:4};function h(t,e=!1){return{value:t,gt(t){return e?this.value<t.value:this.value>t.value},eq(t){return this.value==t.value},lt(t){return e?this.value>t.value:this.value<t.value},score(){return this.value},update(t){this.value=t},clone(){return h(this.value,e)}}}class u{constructor(t,e=null,r=!1){this.pos=e?e.slice():[0,0],this.activation=1,this.recurrent=r,i.vec(t)?(this.id=t[0],this.neuronType=t[1]):(this.id=0,this.neuronType=t)}clone(){let t=new u(this.neuronType);return t.id=this.id,t.activation=this.activation,t.recurrent=this.recurrent,t.pos=this.pos.slice(),t}static from(t,e,r=null,s=!1){return new u([t,e],r,s)}}class c{constructor(t,e,r,i=!0,n=null,o=!1){this.fromNeuron=t,this.toNeuron=e,this.innovationID=r,this.recurrent=!0===o,this.enabled=!1!==i,this.weight=null===n?s.randMinus1To1():n}clone(){let t=new c;return t.fromNeuron=this.fromNeuron,t.toNeuron=this.toNeuron,t.innovationID=this.innovationID,t.recurrent=this.recurrent,t.enabled=this.enabled,t.weight=this.weight,t}}class d{constructor(t,e,r,s,i=n.NONE,o=null){this.pos=o?o.slice():[0,0],this.innovationID=s,this.innovationType=r,this.neuronID=0,this.neuronType=i,this.neuronIn=t,this.neuronOut=e}static from(t,e){let r=new d(-1,-1,null,e,t.neuronType,t.pos);return r.neuronID=t.id,r}}class p{constructor(t,e){this.NEURON_COUNTER=t.length-1,this.INNOV_COUNTER=0,this.vecInnovs=t.map((t=>d.from(t,this.nextIID()))).concat(e.map((t=>new d(t.fromNeuron,t.toNeuron,o.LINK,this.nextIID()))))}nextIID(){return this.INNOV_COUNTER++}check(t,e,r){let s=this.vecInnovs.find((s=>s.neuronIn==t&&s.neuronOut==e&&s.innovationType==r));return void 0===s?-1:s.innovationID}create(t,e,r,s=n.NONE,i=null){let a=new d(t,e,r,this.nextIID(),s,i);return o.NEURON==r&&(a.neuronID=++this.NEURON_COUNTER),this.vecInnovs.push(a),a}flush(){this.vecInnovs.length=0}getNeuronID(t){return this.vecInnovs[t].neuronID}}class f{constructor(t,e,r,s=!1){this.weight=t,this.from=e,this.out=r,this.recurrent=!0===s}clone(){let t=new f;return t.weight=this.weight,t.from=this.from,t.out=this.out,t.recurrent=this.recurrent,t}}class g{constructor(t,e,r,s){this.neuronType=t,this.neuronID=e,this.sumActivation=0,this.output=0,this.posX=0,this.posY=0,this.vecLinksIn=[],this.vecLinksOut=[],this.activation=s,this.pos=r?r.slice():[0,0]}clone(){let t=new g;return t.neuronType=this.neuronType,t.neuronID=this.neuronID,t.output=this.output,t.posX=this.posX,t.posY=this.posY,t.pos=this.pos.slice(),t.activation=this.activation,t.sumActivation=this.sumActivation,t.vecLinksIn=this.vecLinksIn.map((t=>t.clone())),t.vecLinksOut=this.vecLinksOut.map((t=>t.clone())),t}}class m{constructor(t,e){this.vecNeurons=t,this.depth=e}clone(){let t=new m(null,this.depth);return t.vecNeurons=this.vecNeurons.map((t=>t.clone())),t}compute(t,e){return this.update(t,e)}update(t,e=a.ACTIVE){let r=[],i=e==a.SNAPSHOT?this.depth:1;for(let e,a,h=0;h<i;++h){for(r.length=0,a=0;this.vecNeurons[a].neuronType==n.INPUT;)this.vecNeurons[a].output=t[a],++a;for(s.assert(this.vecNeurons[a].neuronType==n.BIAS,"expecting BIAS node"),this.vecNeurons[a].output=1,++a;a<this.vecNeurons.length;)e=this.vecNeurons[a].vecLinksIn.reduce(((t,e)=>t+e.weight*e.from.output),0),this.vecNeurons[a].output=(o=e,l=this.vecNeurons[a].activation,1/(1+Math.exp(-o/l))),this.vecNeurons[a].neuronType==n.OUTPUT&&r.push(this.vecNeurons[a].output),++a}var o,l;return e==a.SNAPSHOT&&this.vecNeurons.forEach((t=>t.output=0)),r}draw(t,e,r,s,i){}}class _{constructor(t,e,r,s=null,i=null){if(t<0)return;let o,a=0,l=1/(e+2),d=1/(r+1);if(s&&i)this.vecNeurons=s,this.vecLinks=i;else{for(this.vecNeurons=[],this.vecLinks=[],o=0;o<e;++o)this.vecNeurons.push(u.from(a++,n.INPUT,[(o+2)*l,0]));for(this.vecNeurons.push(u.from(a++,n.BIAS,[l,0])),o=0;o<r;++o)this.vecNeurons.push(u.from(a++,n.OUTPUT,[(o+1)*d,1]));for(o=0;o<e+1;++o)for(let t=0;t<r;++t)this.vecLinks.push(new c(this.vecNeurons[o].id,this.vecNeurons[e+1+t].id,e+r+1+this.vecLinks.length))}this.nextNeuronID=a,this.fitness=h(0),this.genomeID=t,this.adjustedFitness=0,this.amountToSpawn=0,this.numInputs=e,this.numOutputs=r,this.species=0}createPhenotype(t){let e=this.vecNeurons.map((t=>new g(t.neuronType,t.id,t.pos,t.activation)));return this.vecLinks.forEach((t=>{if(t.enabled){let r=e[this.getIndex(t.toNeuron)],s=e[this.getIndex(t.fromNeuron)],i=new f(t.weight,s,r,t.recurrent);s.vecLinksOut.push(i),r.vecLinksIn.push(i)}})),new m(e,t)}_randAny(){return this.vecNeurons[s.randInt2(0,this.vecNeurons.length-1)]}_randNonInputs(){return this.vecNeurons[s.randInt2(this.numInputs+1,this.vecNeurons.length-1)]}addLink(t,e,r,i,a){if(s.rand()>t)return;let l=-1,h=-1,u=!1;if(s.rand()<e)for(;i--;){let t=this._randNonInputs();if(t.neuronType!=n.BIAS&&t.neuronType!=n.INPUT&&!t.recurrent){l=h=t.id,u=t.recurrent=!0;break}}else for(;a--&&(l=this._randAny().id,h=this._randNonInputs().id,l==h||this.duplicateLink(l,h));)l=h=-1;if(l<0||h<0);else{let t=r.check(l,h,o.LINK);this.vecNeurons[this.getIndex(l)].pos[1]>this.vecNeurons[this.getIndex(h)].pos[1]&&(u=!0),t<0&&(t=r.create(l,h,o.LINK).innovationID),this.vecLinks.push(new c(l,h,t,!0,s.randMinus1To1(),u))}}addNeuron(t,e,i){if(s.rand()>t)return;let a,l,h,d,p=0,f=!1,g=this.numInputs+this.numOutputs+5;if(this.vecLinks.length<g){for(;i--;)if(p=s.randInt2(0,this.numGenes()-1-r(Math.sqrt(this.numGenes()))),a=this.vecLinks[p].fromNeuron,this.vecLinks[p].enabled&&!this.vecLinks[p].recurrent&&this.vecNeurons[this.getIndex(a)].neuronType!=n.BIAS){f=!0;break}if(!f)return}else for(;!f;)p=s.randInt2(0,this.numGenes()-1),a=this.vecLinks[p].fromNeuron,this.vecLinks[p].enabled&&!this.vecLinks[p].recurrent&&this.vecNeurons[this.getIndex(a)].neuronType!=n.BIAS&&(f=!0);this.vecLinks[p].enabled=!1;let m=this.vecLinks[p].weight,_=this.vecLinks[p].fromNeuron,x=this.vecLinks[p].toNeuron,y=(this.vecNeurons[this.getIndex(_)].pos[1]+this.vecNeurons[this.getIndex(x)].pos[1])/2,b=(this.vecNeurons[this.getIndex(_)].pos[0]+this.vecNeurons[this.getIndex(x)].pos[0])/2,v=e.check(_,x,o.NEURON);if(v>=0&&this.hasNeuron(e.getNeuronID(v))&&(v=-1),v<0){let t=e.create(_,x,o.NEURON,n.HIDDEN,[b,y]),r=u.from(this.nextNeuronID,n.HIDDEN,[b,y]);t.neuronID=r.id,d=r.id,this.nextNeuronID++,this.vecNeurons.push(r),l=e.create(_,d,o.LINK).innovationID,this.vecLinks.push(new c(_,d,l,!0,1)),h=e.create(d,x,o.LINK).innovationID,this.vecLinks.push(new c(d,x,h,!0,m))}else d=e.getNeuronID(v),l=e.check(_,d,o.LINK),h=e.check(d,x,o.LINK),(l<0||h<0)&&s.assert(!1,"Error in Genome::AddNeuron"),this.vecLinks.push(new c(_,d,l,!0,1),new c(d,x,h,!0,m)),this.vecNeurons.push(u.from(d,n.HIDDEN,[b,y]))}getIndex(t){for(let e=0;e<this.vecNeurons.length;++e)if(this.vecNeurons[e].id==t)return e;s.assert(!1,"Error in Genome::getIndex")}duplicateLink(t,e){return this.vecLinks.some((r=>r.fromNeuron==t&&r.toNeuron==e))}hasNeuron(t){return this.vecNeurons.some((e=>t==e.id))}mutateWeights(t,e,r){for(let i=0;i<this.vecLinks.length;++i)s.rand()<t&&(s.rand()<e?this.vecLinks[i].weight=s.randMinus1To1():this.vecLinks[i].weight+=s.randMinus1To1()*r)}mutateActivation(t,e){this.vecNeurons.forEach((r=>{s.rand()<t&&(r.activation+=s.randMinus1To1()*e)}))}calcCompatibility(t){let e=0,r=0,s=0,i=0,n=0,o=0;for(;e<this.vecLinks.length-1||r<t.vecLinks.length-1;){if(e==this.vecLinks.length-1){++r,++i;continue}if(r==t.vecLinks.length-1){++e,++i;continue}let a=this.vecLinks[e].innovationID,l=t.vecLinks[r].innovationID;a==l?(++e,++r,++n,o+=Math.abs(this.vecLinks[e].weight-t.vecLinks[r].weight)):(++s,a<l?++e:a>l&&++r)}const a=Math.max(this.numGenes(),t.numGenes());let l=1*i/a+1*s/a;return n>0?l+.4*o/n:l}sortGenes(){return this.vecLinks.sort(((t,e)=>t.innovationID<e.innovationID?-1:t.innovationID>e.innovationID?1:0)),this}id(){return this.genomeID}setID(t){this.genomeID=t}numGenes(){return this.vecLinks.length}numNeurons(){return this.vecNeurons.length}setFitness(t){this.fitness=h(t)}splitY(t){return this.vecNeurons[t].pos[1]}genes(){return this.vecLinks}neurons(){return this.vecNeurons}startOfGenes(){return 0}endOfGenes(){return this.vecLinks.length}clone(){let t=this,e=new _(-911);return e.fitness=t.fitness.clone(),e.genomeID=t.genomeID,e.adjustedFitness=t.adjustedFitness,e.amountToSpawn=t.amountToSpawn,e.numInputs=t.numInputs,e.numOutputs=t.numOutputs,e.species=t.species,e.vecNeurons=t.vecNeurons.map((t=>t.clone())),e.vecLinks=t.vecLinks.map((t=>t.clone())),e}}class x{constructor(t,e){this.speciesID=t,this._gensNoImprovement=0,this._age=0,this.spawnsRqd=0,this.vecMembers=[e],this._leader=e.clone(),this._bestFitness=e.fitness.score()}adjustFitnesses(){let t,e=0;this.vecMembers.forEach((r=>{t=r.fitness.score(),this._age<l.youngBonusAgeThreshhold&&(t*=l.youngFitnessBonus),this._age>l.oldAgeThreshold&&(t*=l.oldAgePenalty),e+=t,r.adjustedFitness=t/this.vecMembers.length}))}addMember(t){t.fitness.score()>this._bestFitness&&(this._bestFitness=t.fitness.score(),this._gensNoImprovement=0,this._leader=t.clone()),this.vecMembers.push(t),t.species=this.id()}purge(){return this.vecMembers.length=0,++this._gensNoImprovement,this.spawnsRqd=0,++this._age,this}calculateSpawnAmount(){this.vecMembers.forEach((t=>{this.spawnsRqd+=t.amountToSpawn}))}spawn(){let t,e;return 1==this.vecMembers.length?e=this.vecMembers[0]:(t=r(l.survivalRate*this.vecMembers.length)-1,t<0&&(t=1),e=this.vecMembers[s.randInt2(0,t)]),e.clone()}id(){return this.speciesID}bestFitness(){return this._bestFitness}age(){return this._age}leader(){return this._leader}numToSpawn(){return this.spawnsRqd}numMembers(){return this.vecMembers.length}gensNoImprovement(){return this._gensNoImprovement}}function y(t,e,r,s){const i=e-t;return s.push({val:t+i/2,depth:r+1}),r>6||(y(t,t+i/2,r+1,s),y(t+i/2,e,r+1,s)),s}return{NeatGA:class{constructor(t,e,r){let i=new _(0,e,r);this.vecSplits=y(0,1,0,[]),this.vecBestGenomes=[],this.vecSpecies=[],this.SPECIES_COUNTER=0,this.GENOME_COUNTER=0,this.generation=0,this.popSize=t,this.totFitAdj=0,this.avFitAdj=0,this.fittestGenome=0,this._bestEverFitness=0,this.vecGenomes=s.fill(t,(()=>new _(this.nextGID(),e,r))),this.innovHistory=new p(i.neurons(),i.genes())}resetAndKill(){this.totFitAdj=0,this.avFitAdj=0;let t=[];this.vecSpecies.forEach((e=>{e.gensNoImprovement()>l.numGensAllowedNoImprovement&&e.bestFitness()<this._bestEverFitness||t.push(e.purge())})),this.vecSpecies.length=0,t.forEach((t=>this.vecSpecies.push(t)))}speciateAndCalculateSpawnLevels(){let t=!1;this.vecGenomes.forEach((e=>{for(let r=0;r<this.vecSpecies.length;++r)if(e.calcCompatibility(this.vecSpecies[r].leader())<=l.compatibilityThreshold){this.vecSpecies[r].addMember(e),t=!0;break}t||this.vecSpecies.push(new x(this.nextSID(),e)),t=!1})),this.vecSpecies.forEach((t=>t.adjustFitnesses())),this.vecGenomes.forEach((t=>this.totFitAdj+=t.adjustedFitness)),this.avFitAdj=this.totFitAdj/this.vecGenomes.length,this.vecGenomes.forEach((t=>t.amountToSpawn=t.adjustedFitness/this.avFitAdj)),this.vecSpecies.forEach((t=>t.calculateSpawnAmount()))}crossOver(t,e){let r;function i(t,e){e.indexOf(t)<0&&e.push(t)}r=t.fitness.score()==e.fitness.score()?t.numGenes()==e.numGenes()?s.randSign()>0?1:0:t.numGenes()<e.numGenes()?0:1:t.fitness.score()>e.fitness.score()?0:1;let o,a=[],l=[],h=[],c=0,d=0;for(;c!=t.endOfGenes()||d!=e.endOfGenes();)c==t.endOfGenes()&&d!=e.endOfGenes()?(1==r&&(o=e.vecLinks[d]),++d):d==e.endOfGenes()&&c!=t.endOfGenes()||t.vecLinks[c].innovationID<e.vecLinks[d].innovationID?(0==r&&(o=t.vecLinks[c]),++c):e.vecLinks[d].innovationID<t.vecLinks[c].innovationID?(1==r&&(o=e.vecLinks[d]),++d):e.vecLinks[d].innovationID==t.vecLinks[c].innovationID&&(o=s.rand()<.5?t.vecLinks[c]:e.vecLinks[d],++c,++d),0!=l.length&&s.last(l).innovationID==o.innovationID||l.push(o.clone()),i(o.fromNeuron,h),i(o.toNeuron,h);return h.sort().forEach((t=>a.push(function(t,e){let r=u.from(0,n.HIDDEN);for(let s,i=0;i<t.vecInnovs.length;++i)if(s=t.vecInnovs[i],s.neuronID==e)return r.neuronType=s.neuronType,r.id=s.neuronID,r.pos=s.pos.slice(),r;s.assert(!1,"boom from createNeuronFromID")}(this.innovHistory,t)))),new _(this.nextGID(),t.numInputs,t.numOutputs,a,l)}nextSID(){return++this.SPECIES_COUNTER}nextGID(){return++this.GENOME_COUNTER}tournamentSelection(t){let e=0,r=0;for(let i,n=0,o=this.vecGenomes.length-1;n<t;++n)i=s.randInt2(0,o),this.vecGenomes[i].fitness.score()>r&&(e=i,r=this.vecGenomes[i].fitness.score());return this.vecGenomes[e]}calculateNetDepth(t){let e=0;for(let r=0;r<t.numNeurons();++r)for(let s=0;s<this.vecSplits.length;++s)t.splitY(r)==this.vecSplits[s].val&&this.vecSplits[s].depth>e&&(e=this.vecSplits[s].depth);return e+2}sortAndRecord(t){this.vecGenomes.forEach(((e,r)=>e.setFitness(t[r]))),this.vecGenomes.sort(((t,e)=>t.fitness.score()>e.fitness.score()?-1:t.fitness.score()<e.fitness.score()?1:0)),this._bestEverFitness=Math.max(this._bestEverFitness,this.vecGenomes[0].fitness.score()),this.vecBestGenomes.length=0;for(let t=0;t<l.numBestElites;++t)this.vecBestGenomes.push(this.vecGenomes[t])}epoch(t){s.assert(t.length==this.vecGenomes.length,"NeatGA::Epoch(scores/ genomes mismatch)!"),this.resetAndKill(),this.sortAndRecord(t),this.speciateAndCalculateSpawnLevels();let e,i=[],n=0;if(this.vecSpecies.forEach((t=>{if(n<this.popSize){let r=!1,o=s.rounded(t.numToSpawn());for(;o--;){if(r){if(1==t.numMembers())e=t.spawn();else{let r,i=5,n=t.spawn();if(s.rand()<l.crossOverRate){for(r=t.spawn();n.id()==r.id()&&i--;)r=t.spawn();e=n.id()!=r.id()?this.crossOver(n,r):n}else e=n}e.setID(this.nextGID()),e.numNeurons()<l.maxPermittedNeurons&&e.addNeuron(l.chanceAddNode,this.innovHistory,l.numTrysToFindOldLink),e.addLink(l.chanceAddLink,l.chanceAddRecurrentLink,this.innovHistory,l.numTrysToFindLoopedLink,l.numAddLinkAttempts),e.mutateWeights(l.mutationRate,l.probabilityWeightReplaced,l.maxWeightPerturbation),e.mutateActivation(l.activationMutationRate,l.maxActivationPerturbation)}else r=!0,e=t.leader().clone();i.push(e.sortGenes()),++n==this.popSize&&(o=0)}}})),n<this.popSize){let t=this.popSize-n;for(;t--;)i.push(this.tournamentSelection(r(this.popSize/5)).clone())}return this.vecGenomes=i,++this.generation,this.createPhenotypes()}createPhenotypes(){return this.vecGenomes.map((t=>t.createPhenotype(this.calculateNetDepth(t))))}renderSpeciesInfo(){}numSpecies(){return this.vecSpecies.length}bestEverFitness(){return this._bestEverFitness}getBestPhenotypesFromLastGeneration(){return this.vecBestGenomes.map(((t,e)=>{t.createPhenotype(this.calculateNetDepth(t))}))}},NeuralNet:m,Genome:_,NeuronGene:u,LinkGene:c,NLink:f,NNeuron:g,Species:x,NumFitness:h,InnovHistory:p,NeuronType:n,InnovType:o,RunType:a,configParams:t=>s.inject(l,t)}}"object"==typeof module&&module.exports?module.exports=r(require("../main/core")):t["io/czlab/mcfud/algo/NEAT"]=r}(this),function(t,e){"use strict";function r(e){e||(e=t["io/czlab/mcfud/core"]());const r=Math.floor,{u:s,is:i}=e;function n(t,e=!1){return{value:t,gt(t){return e?this.value<t.value:this.value>t.value},eq(t){return this.value==t.value},lt(t){return e?this.value>t.value:this.value<t.value},score(){return this.value},update(t){this.value=t},clone(){return n(this.value,e)}}}const o=n,a={BIAS:1,nextInnovNo:1,superSpeed:1,mutationRate:.8,crossOverRate:.25,probAddLink:.07,probAddNode:.03,probCancelLink:.75,probAddRecurrentLink:.05,probWeightReplaced:.1,maxWeightPerturbation:.02,noImprovementLimit:15,excessCoeff:1,weightDiffCoeff:.5,compatibilityThreshold:3};class l{constructor(t,e,r,s){this.innovNo=s,this.fromNode=t,this.toNode=e,this.weight=r,this.enabled=!0}mutateWeight(){s.rand()<a.probWeightReplaced?this.weight=s.randMinus1To1():this.weight+=s.randGaussian()*a.maxWeightPerturbation,this.weight>1&&(this.weight=1),this.weight<-1&&(this.weight=-1)}clone(t,e){let r=new l(t,e,this.weight,this.innovNo);return r.enabled=this.enabled,r}}class h{constructor(t,e,r,s){this.fromNode=t,this.toNode=e,this.innovNumber=r,this.innovNumbers=s.slice()}matches(t,e,r){if(t.genes.length==this.innovNumbers.length&&e.number==this.fromNode&&r.number==this.toNode){for(let e=0;e<t.genes.length;++e)if(!this.innovNumbers.includes(t.genes[e].innovNo))return!1;return!0}return!1}}class u{constructor(t,e,r=0){this.outputConnections=[],this.layer=r,this.neuronType=t,this.pos=[0,0],this.number=e,this.inputSum=0,this.outputValue=0}engage(){0!=this.layer&&(this.outputValue=this.sigmoid(this.inputSum));for(let t=0;t<this.outputConnections.length;++t)this.outputConnections[t].enabled&&(this.outputConnections[t].toNode.inputSum+=this.outputConnections[t].weight*this.outputValue);return this}stepFunction(t){return t<0?0:1}sigmoid(t){return 1/(1+Math.pow(Math.E,-4.9*t))}sigmoid2(t,e){return 1/(1+Math.exp(-t/e))}isConnectedTo(t){let e,r;if(t.layer<this.layer?(e=t,r=this):t.layer>this.layer&&(e=this,r=t),e&&r)for(let t=0;t<e.outputConnections.length;++t)if(e.outputConnections[t].toNode===r)return!0;return!1}clone(){return new u(this.neuronType,this.number,this.layer)}}class c{constructor(t,e,r=!1){this.outputs=e,this.fitness=o(0),this.inputs=t,this.layers=2,this.nextNode=0,this.network=[],this.genes=[],this.nodes=r?[]:this.ctor(t,e,[])}ctor(t,e,r){for(let e=0;e<t;++e)r.push(new u(0,e)),++this.nextNode;for(let s=0;s<e;++s)r.push(new u(1,s+t,1)),++this.nextNode;return this.biasNode=this.nextNode,this.nextNode++,r.push(new u(2,this.biasNode)),r}bindTo(t){return this.husk=t,t.brain=this}getNeuron(t){return this.nodes.find((e=>e.number==t))}connectNeurons(){return this.nodes.forEach((t=>t.outputConnections.length=0)),this.genes.forEach((t=>t.fromNode.outputConnections.push(t))),this}update(t){s.assert(this.network.length>0,"invalid network"),s.assert(t.length==this.inputs,"invalid input values");for(let e,r=0;r<this.inputs;++r)e=this.nodes[r],e.outputValue=t[r],s.assert(0==e.neuronType,"invalid input neuron");this.nodes[this.biasNode].outputValue=a.BIAS,this.network.forEach((t=>t.engage()));const e=[];for(let t,r=0;r<this.outputs;++r)t=this.nodes[this.inputs+r],e[r]=t.outputValue,s.assert(1==t.neuronType,"invalid output neuron");return this.nodes.forEach((t=>t.inputSum=0)),e}compute(t){return this.update(t)}generateNetwork(){this.connectNeurons(),s.cls(this.network);for(let t=0;t<this.layers;++t)for(let e=0;e<this.nodes.length;++e)this.nodes[e].layer==t&&this.network.push(this.nodes[e]);return this}addNeuron(t){if(0==this.genes.length)return this.addLink(t);let e=10,r=0;for(this.genes.length>1&&(r=s.randInt(this.genes.length));2==this.genes[r].fromNode.neuronType&&e>0;)r=s.randInt(this.genes.length),e--;if(e<=0)return console.warn("failed to add neuron"),this;this.genes[r].enabled=!1;let i,n,o=this.nextNode;if(this.nodes.push(new u(3,o)),++this.nextNode,n=this.getNeuron(o),i=this.getInnovNo(t,this.genes[r].fromNode,n),this.genes.push(new l(this.genes[r].fromNode,n,1,i)),i=this.getInnovNo(t,n,this.genes[r].toNode),this.genes.push(new l(n,this.genes[r].toNode,this.genes[r].weight,i)),n.layer=1+this.genes[r].fromNode.layer,i=this.getInnovNo(t,this.nodes[this.biasNode],o),this.genes.push(new l(this.nodes[this.biasNode],n,0,i)),n.layer==this.genes[r].toNode.layer){for(let t=0;t<this.nodes.length-1;++t)this.nodes[t].layer>=n.layer&&(this.nodes[t].layer+=1);++this.layers}return this.connectNeurons()}addLink(t){if(this.fullyConnected())return console.warn("addLink failed, too full"),this;let e,r,i=s.randInt(this.nodes.length),n=s.randInt(this.nodes.length),o=10,a=(t,e)=>this.nodes[t].layer==this.nodes[e].layer||this.nodes[t].isConnectedTo(this.nodes[e]);for(;a(i,n)&&o>0;)i=s.randInt(this.nodes.length),n=s.randInt(this.nodes.length),--o;return o<=0?(console.log("failed to add-link"),this):(this.nodes[i].layer>this.nodes[n].layer&&(r=n,n=i,i=r),e=this.getInnovNo(t,this.nodes[i],this.nodes[n]),this.genes.push(new l(this.nodes[i],this.nodes[n],s.randMinus1To1(),e)),this.connectNeurons())}getInnovNo(t,e,r){let s=!0,i=a.nextInnovNo;for(let n=0;n<t.length;++n)if(t[n].matches(this,e,r)){s=!1,i=t[n].innovNumber;break}return s&&(t.push(new h(e.number,r.number,i,this.genes.map((t=>t.innovNo)))),a.nextInnovNo+=1),i}fullyConnected(){let t=0,e=s.fill(this.layers,0);this.nodes.forEach((t=>e[t.layer]+=1));for(let r,s=0;s<this.layers-1;++s){r=0;for(let t=s+1;t<this.layers;++t)r+=e[t];t+=r*e[s]}return t<=this.genes.length}mutate(t){return 0==this.genes.length&&this.addLink(t),s.rand()<a.mutationRate&&this.genes.forEach((t=>t.mutateWeight())),s.rand()<a.probAddLink&&this.addLink(t),s.rand()<a.probAddNode&&this.addNeuron(t),this}crossOver(t){let e,r,i=[],n=[],o=new c(this.inputs,this.outputs,!0);o.nextNode=this.nextNode,o.layers=this.layers,o.biasNode=this.biasNode;for(let o=0;o<this.genes.length;++o)r=!0,e=this.matchingGene(t,this.genes[o].innovNo),-1!=e?(this.genes[o].enabled&&t.genes[e].enabled||s.rand()<a.probCancelLink&&(r=!1),n.push(s.rand()<.5?this.genes[o]:t.genes[e])):(n.push(this.genes[o]),r=this.genes[o].enabled),i.push(r);this.nodes.forEach((t=>o.nodes.push(t.clone())));for(let t=0;t<n.length;++t)o.genes.push(n[t].clone(o.getNeuron(n[t].fromNode.number),o.getNeuron(n[t].toNode.number))),o.genes[t].enabled=i[t];return o.connectNeurons()}matchingGene(t,e){for(let r=0;r<t.genes.length;++r)if(t.genes[r].innovNo==e)return r;return-1}printGenome(){console.log("Prvar genome  layers:"+this.layers),console.log("bias node: "+this.biasNode),console.log("this.nodes");for(let t=0;t<this.nodes.length;++t)console.log(this.nodes[t].number+",");console.log("Genes");for(let t=0;t<this.genes.length;++t)console.log("gene "+this.genes[t].innovNo+"From node "+this.genes[t].fromNode.number+"To node "+this.genes[t].toNode.number+"is enabled "+this.genes[t].enabled+"from layer "+this.genes[t].fromNode.layer+"to layer "+this.genes[t].toNode.layer+"weight: "+this.genes[t].weight);return this}clone(){let t=new c(this.inputs,this.outputs,!0);return this.nodes.forEach((e=>t.nodes.push(e.clone()))),this.genes.forEach((e=>{t.genes.push(e.clone(t.getNeuron(e.fromNode.number),t.getNeuron(e.toNode.number)))})),t.fitness=this.fitness.clone(),t.layers=this.layers,t.nextNode=this.nextNode,t.biasNode=this.biasNode,t.connectNeurons()}drawGenome(t,e,r,s){return this}}class d{constructor(t){this.bestFitness=0,this.members=[],this.rep,this.staleness=0,this.averageFitness=0,t&&(this.bestFitness=t.fitness.score(),this.members.push(t),this.rep=t.clone())}compatible(t){let e,r=this.getExcessDisjoint(t,this.rep),s=this.averageWeightDiff(t,this.rep),i=t.genes.length-20;return i<1&&(i=1),e=a.excessCoeff*r/i+a.weightDiffCoeff*s,a.compatibilityThreshold>e}add(t){return this.members.push(t),this}getExcessDisjoint(t,e){let r=0;for(let s=0;s<t.genes.length;++s)for(let i=0;i<e.genes.length;++i)if(t.genes[s].innovNo==e.genes[i].innovNo){++r;break}return t.genes.length+e.genes.length-2*r}averageWeightDiff(t,e){if(0==t.genes.length||0==e.genes.length)return 0;let r=0,s=0;for(let i=0;i<t.genes.length;++i)for(let n=0;n<e.genes.length;++n)if(t.genes[i].innovNo==e.genes[n].innovNo){++r,s+=Math.abs(t.genes[i].weight-e.genes[n].weight);break}return 0==r?100:s/r}sortAsc(){this.members.sort(((t,e)=>t.fitness.score()>e.fitness.score()?-1:t.fitness.score()<e.fitness.score()?1:0)),0==this.members.length?this.staleness=200:this.members[0].fitness.score()>this.bestFitness?(this.bestFitness=this.members[0].fitness.score(),this.rep=this.members[0].clone(),this.staleness=0):++this.staleness}setAverage(){this.averageFitness=this.members.reduce(((t,e)=>t+e.fitness.score()),0)/this.members.length}giveMeBaby(t){let e,r=()=>{let t=this.members.reduce(((t,e)=>t+e.fitness.score()),0),e=0,r=s.rand()*t;for(let t=0;t<this.members.length;++t)if(e+=this.members[t].fitness.score(),e>r)return this.members[t];return this.members[0]};if(s.rand()<a.crossOverRate)e=r().clone();else{let t=r(),s=r();e=t.fitness.score()<s.fitness.score()?s.crossOver(t):t.crossOver(s)}return e.mutate(t)}cull(){this.members.length>2&&(this.members.length=r(this.members.length/2))}fitnessSharing(){this.members.forEach((t=>{t.fitness.update(t.fitness.score()/this.members.length)}))}}return{NeatGA:class{constructor(t,e,r){this.history=[],this.species=[],this.gen=1,this.genomes=s.fill(t,((t,s)=>((s=new c(e,r)).mutate(this.history),s.generateNetwork())))}createPhenotypes(){return this.genomes}epoch(t){let e=1==this.gen?null:this.genomes[0];this.speciate(),this.genomes.forEach(((e,r)=>{r>=0&&e.fitness.update(t[r])})),this.sortSpecies(),this.resetAndKill();let i,n=[],o=this.getAvgFitnessSum();for(this.species.forEach((t=>{n.push(t.rep.clone()),i=r(t.averageFitness/o*this.genomes.length)-1;for(let e=0;e<i;++e)n.push(t.giveMeBaby(this.history))})),e||(e=this.species[0].rep),n.length<this.genomes.length&&n.push(e.clone());n.length<this.genomes.length;)n.push(this.species[0].giveMeBaby(this.history));return s.append(this.genomes,n,!0),this.gen+=1,this.genomes.forEach((t=>t.generateNetwork())),this.genomes}speciate(){this.species.forEach((t=>s.cls(t.members)));for(let t,e,r=0;r<this.genomes.length;++r){e=this.genomes[r],t=!1;for(let r=0;r<this.species.length;++r)if(this.species[r].compatible(e)){this.species[r].add(e),t=!0;break}t||this.species.push(new d(e))}}sortSpecies(){this.species.forEach((t=>t.sortAsc())),this.species.sort(((t,e)=>t.bestFitness>e.bestFitness?-1:t.bestFitness<e.bestFitness?1:0))}getAvgFitnessSum(){return this.species.reduce(((t,e)=>t+e.averageFitness),0)}resetAndKill(){let t=[];this.species.forEach((t=>{t.cull(),t.fitnessSharing(),t.setAverage()}));for(let e=0;e<this.species.length;++e)(e<2||this.species[e].staleness<a.noImprovementLimit)&&t.push(this.species[e]);s.append(this.species,t,!0);let e=this.getAvgFitnessSum();t=[];for(let r=0;r<this.species.length;++r)r<1?t.push(this.species[r]):this.species[r].averageFitness/e*this.species.length<1||t.push(this.species[r]);s.append(this.species,t,!0)}massExtinction(){this.species.length>5&&this.species.slice(0,5)}},Genome:c,LinkGene:l,Neuron:u,Species:d,NumFitness:n,InnovHistory:h,configParams:t=>s.inject(a,t)}}"object"==typeof module&&module.exports?module.exports=r(require("../main/core")):t["io/czlab/mcfud/algo/NEAT2"]=r}(this),function(t,e){"use strict";function r(e,r){e||(e=t["io/czlab/mcfud/core"]()),r||(r=t["io/czlab/mcfud/math"]());const{is:s,u:i}=e;function n(t,e,r){return e>t.length-1?t:`${t.substr(0,e)}${r}${t.substr(e+1)}`}function o(t,e){return+t.charAt(e)}class a{static DV={n:1,s:2,e:4,w:8};static DX={e:1,w:-1,n:0,s:0};static DY={e:0,w:0,n:-1,s:1};static OPPOSITE={e:"w",w:"e",n:"s",s:"n"};constructor(t,e){this.COLS=t,this.ROWS=e,this._getEntryNodes()}_getEntryNodes(){let t={},e=2*this.ROWS+1-2,r=2*this.COLS+1-2;t.start={x:1,y:1,gate:{x:0,y:1}},t.end={x:r,y:e,gate:{x:r+1,y:e}},this.entryNodes=t}getIO(){let t=this.entryNodes.end.gate,e=this.entryNodes.start.gate;return{start:[e.x,e.y],end:[t.x,t.y]}}generate(){this.grid=this._walk(0,0,i.fill(this.ROWS,(()=>i.fill(this.COLS,0))))}canSouth(t){return 0!=(t&a.DV.s)}canEast(t){return 0!=(t&a.DV.e)}toAscii(){let t=this.grid,e=t.length,r=[],s=t[0].length;for(let i,n=0;n<e;++n){i="|";for(let e=0;e<s;++e)i+=this.canSouth(t[n][e])?" ":"_",this.canEast(t[n][e])?i+=this.canSouth(t[n][e]|t[n][e+1])?" ":"_":i+="|";r.push(i)}return r.unshift("_".repeat(r[0].length)),r.join("\n")}_walk(t,e,r){let s,n;return i.shuffle(["n","s","e","w"]).forEach((i=>{s=t+a.DX[i],n=e+a.DY[i],n>=0&&n<r.length&&s>=0&&s<r[n].length&&0==r[n][s]&&(r[e][t]|=a.DV[i],r[n][s]|=a.DV[a.OPPOSITE[i]],this._walk(s,n,r))})),r}toGrid(){let t,e,r=this.grid,s=r.length,n=[],o=r[0].length;for(let i,a=0;a<s;++a){t=[],e=[],i=0,t[i]=1,e[i]=1;for(let s=0;s<o;++s)++i,this.canSouth(r[a][s])?(t[i]=0,e[i]=0):(t[i]=0,e[i]=1),++i,this.canEast(r[a][s])?(t[i]=0,e[i]=1):(t[i]=1,e[i]=1);n.push(t,e)}return n.unshift(i.fill(n[0].length,1)),n}}return{Maze1:class{constructor(t,e,r="D",s={}){let{bias:i,removeWalls:n,maxWallsRemove:o}=s;this.bias=i||"",this.removeWalls=n||0,this.maxWallsRemove=o||300,this.ROWS=t,this.COLS=e,this.matrix=[],this.entryNodes=this.getEntryNodes(r)}generate(){this.getMatrix(this.parseMaze(i.fill(this.COLS*this.ROWS,(()=>"01111")))),this.removeMazeWalls()}toAscii(){return""}getIO(){let t=this.entryNodes.end.gate,e=this.entryNodes.start.gate;return{start:[e.x,e.y],end:[t.x,t.y]}}toGrid(){let t,e=[];return this.matrix.forEach(((r,s)=>{t=[];for(let e=0;e<r.length;++e)t[e]="1"==r.charAt(e)?1:0;e.push(t)})),e}parseMaze(t){const e={n:1,s:2,w:3,e:4},s={n:2,s:1,w:4,e:3};let a,l,h,u=0,c=[],d=0,p=3,f=t.length-1,g=i.randInt(t.length);for(this.bias&&("H"==this.bias?p=this.COLS/100>=1?r.ndiv(this.COLS,100)+2:3:"V"==this.bias&&(p=this.ROWS/100>=1?r.ndiv(this.ROWS,100)+2:3)),t[g]=n(t[g],0,1);u<f;)if(++d,a=this.getNeighbours(g),h=Object.keys(a).filter((e=>-1!=a[e]&&!o(t[a[e]],0))),this.bias&&d!=p?h=this.biasDirections(h):d=0,h.length)++u,h.length>1&&c.push(g),l=h[i.randInt(h.length)],t[g]=n(t[g],e[l],0),g=a[l],t[g]=n(t[g],s[l],0),t[g]=n(t[g],0,1);else{if(0==c.length)break;g=c.pop()}return t}getMatrix(t){let e="",r="",s=this.COLS*this.ROWS;i.assert(t.length==s,"invalid nodes");for(let i=0;i<s;++i){if(e+=0==e.length?"1":"",r+=0==r.length?"1":"",o(t[i],1))e+="11",r+=o(t[i],4)?"01":"00";else{let s=t.hasOwnProperty(i-this.COLS)&&o(t[i-this.COLS],4),n=t.hasOwnProperty(i+1)&&o(t[i+1],1);o(t[i],4)?(e+="01",r+="01"):n||s?(e+="01",r+="00"):(e+="00",r+="00")}(i+1)%this.COLS==0&&(this.matrix.push(e,r),e="",r="")}this.matrix.push("1".repeat(2*this.COLS+1))}getEntryNodes(t){let e={},r=2*this.ROWS+1-2,s=2*this.COLS+1-2;if("D"==t&&(e.start={x:1,y:1,gate:{x:0,y:1}},e.end={x:s,y:r,gate:{x:s+1,y:r}}),"H"==t||"V"==t){let i="H"==t?r:s;i=(i-1)/2;let n=i%2==0;i=n?i+1:i;let o="H"==t?1:i,a="H"==t?i:1,l="H"==t?s:n?o:o+2,h="H"==t?n?a:a+2:r,u="H"==t?{x:0,y:a}:{x:o,y:0},c="H"==t?{x:s+1,y:h}:{x:l,y:r+1};e.start={x:o,y:a,gate:u},e.end={x:l,y:h,gate:c}}return e}biasDirections(t){let e=-1!=t.indexOf("w")||-1!=t.indexOf("e"),r=-1!=t.indexOf("n")||-1!=t.indexOf("s");return"H"==this.bias&&e?t.filter((t=>"w"==t||"e"==t)):"V"==this.bias&&r?t.filter((t=>"n"==t||"s"==t)):t}getNeighbours(t){return{w:t>0&&t%this.COLS!=0?t-1:-1,e:(t+1)%this.COLS!=0?t+1:-1,n:t-this.COLS>=0?t-this.COLS:-1,s:this.COLS*this.ROWS>t+this.COLS?t+this.COLS:-1}}removeWall(t,e){const r=t%2==0,s=e%2==0;if(!o(this.matrix[t],e))return!1;if(!r&&s){const r=t-2>0&&1==o(this.matrix[t-2],e),s=t+2<this.matrix.length&&1==o(this.matrix[t+2],e);if(r&&s)return this.matrix[t]=n(this.matrix[t],e,"0"),!0;if(!r&&s){const r=1==o(this.matrix[t-1],e-1),s=1==o(this.matrix[t-1],e+1);if(r||s)return this.matrix[t]=n(this.matrix[t],e,"0"),!0}else if(!s&&r){const r=1==o(this.matrix[t+1],e-1),s=1==o(this.matrix[t+1],e+1);if(r||s)return this.matrix[t]=n(this.matrix[t],e,"0"),!0}}else if(r&&!s){const r=1==o(this.matrix[t],e-2),s=1==o(this.matrix[t],e+2);if(r&&s)return this.matrix[t]=n(this.matrix[t],e,"0"),!0;if(!r&&s){const r=1==o(this.matrix[t-1],e-1),s=1==o(this.matrix[t+1],e-1);if(r||s)return this.matrix[t]=n(this.matrix[t],e,"0"),!0}else if(!s&&r){const r=1==o(this.matrix[t-1],e+1),s=1==o(this.matrix[t+1],e+1);if(r||s)return this.matrix[t]=n(this.matrix[t],e,"0"),!0}}}removeMazeWalls(){if(0==this.removeWalls||0==this.matrix.length)return;let t,e,r=0,s=this.matrix.length-1,n=this.maxWallsRemove;for(;r<n&&(++r,!(this.wallsRemoved>=this.removeWalls));){let r=i.randInt2(1,s);r=r==s?r-1:r,e=[],t=this.matrix[r];for(let r=0;r<t.length;r++)0!=r&&r!=t.length-1&&o(t,r)&&e.push(r);i.shuffle(e);for(let t=0;t<e.length;t++)if(this.removeWall(r,e[t])){++this.wallsRemoved;break}}}},Maze2:a}}"object"==typeof module&&module.exports?module.exports=r(require("../main/core"),require("../main/math")):t["io/czlab/mcfud/algo/maze"]=r}(this),function(t,e){"use strict";function r(e,r){if(e||(e=t["io/czlab/mcfud/core"]()),!r)throw"Fatal: No Colors!";const{is:s,u:i}=e;function n(t,e){let r="";for(;t>0;)r+=e,--t;return r}function o(t,e){let r=u;return e&&(s.str(t)?r="any"==t||t==e?c:u:t instanceof e&&(r=c)),r}function a(t,e,r){return new Promise(((s,i)=>{let n;try{n=r.call(t),n instanceof Promise?n.then((function(t){s(`${t?c:u}: ${e}`)})):(n=n?709394==n?h:c:u,s(`${n}: ${e}`))}catch(t){n=u,s(`${n}: ${e}`)}}))}function l(t,e,r,s){return new Promise(((i,n)=>{let a;try{a=r.call(t),a=709394==a?c:o(s,null)}catch(t){a=o(s,t)}i(`${a}: ${e}`)}))}const[h,u,c]=["Skippd","Failed","Passed"];return{prn(t){const e=t.passed.length,s=t.total,o=e/s*100;console.log(r.white(n(78,"+"))),console.log(r.white.bold(t.title)),console.log(r.white(t.date)),console.log(r.white(n(78,"+"))),t.passed.length>0&&console.log(r.green(t.passed.join("\n"))),t.skippd.length>0&&console.log(r.grey(t.skippd.join("\n"))),t.failed.length>0&&console.log(r.magenta(t.failed.join("\n"))),console.log(r.white(n(78,"="))),console.log(r.yellow(["Passed: ",e,"/",s," [",0|o,"%]"].join(""))),console.log(r.magenta("Failed: "+(s-e))),console.log(r.white(["cpu-time: ",i.prettyMillis(t.duration)].join(""))),console.log(r.white(n(78,"=")))},deftest(t){let[e,r,s,i]=[null,null,null,null];const n={ensure:(t,e)=>(s.push([1,t,e]),n),eerror:(t,e)=>(s.push([911,t,e]),n),begin:t=>(i={},s=[],e=t,n),end(n){r=n;let o=function(){return new Promise(((t,n)=>{e&&e(i);let o,h=[];for(let t,e,r=0;r<s.length;++r){switch(e=s[r],e[0]){case 1:t=a(i,e[1],e[2]);break;case 911:t=l(i,e[1],e[2],"any")}o=o?o.then((function(e){return h.push(e),t})):t}o&&o.then((function(e){h.push(e),s.length=0,r&&r(i),t(h)}))}))};return(o.title=t)&&o}};return n},_run:t=>new Promise(((e,r)=>{t().then((function(t){e(t)}))})),runtest(t,e){const r=Date.now();return this._run(t).then((function(s){const i=Date.now(),n={title:e||t.title,date:(new Date).toString(),total:s.length,duration:i-r,passed:s.filter((t=>"P"==t[0])),skippd:s.filter((t=>"S"==t[0])),failed:s.filter((t=>"F"==t[0]))};return new Promise((t=>{t(n)}))}))}}}"object"==typeof module&&module.exports?module.exports=r(require("./core"),require("colors/safe")):t["io/czlab/mcfud/test"]=r}(this),function(t,e){"use strict";const r=["fnt"],s=["mp3","wav","ogg"],i=["ttf","otf","ttc","woff"],n=["jpg","png","jpeg","gif","webp"];function o(o,a){const{EventBus:l,dom:h,is:u,u:c}=t["io/czlab/mcfud/core"](),d=t["io/czlab/mcfud/vec2"](),p=t["io/czlab/mcfud/math"](),f=l(),g=Math.floor,m=1/15;let _=!1;class x extends PIXI.Container{constructor(){super(),this.m5={stage:!0}}onResize(t,e){this.children.forEach((r=>{r instanceof t.Scenes.SceneWrapper&&(r=r.children[0]),r.onCanvasResize(e[0],e[1])})),t.Input.resize()}}function y(){return window.innerWidth||document.documentElement.clientWidth||document.body.clientWidth}function b(){return window.innerHeight||document.documentElement.clientHeight||document.body.clientHeight}function v(t){let e,r=[],n=0,o=t.u.load,a=[],l=[],d=[];t.u.assetFiles.forEach((e=>{u.obj(e)?c.has(i,c.fileExt(e.url))&&l.push(e):u.str(e)&&(e=t.assetPath(e),c.has(s,c.fileExt(e))?a.push(e):d.push(e))})),function(t){let e,r,s;t.forEach((t=>{s=h.newElm("style"),r=h.newElm("span"),e=`@font-face {font-family: '${t.family}'; src: url('${t.url}');}`,c.log(`loading fontface = ${e}`),h.conj(s,h.newTxt(e)),h.conj(document.head,s),r.innerHTML="?",h.css(r,"fontFamily",void 0),h.conj(document.body,r),h.css(r,{display:"block",opacity:"0"})}))}(l),o||(o=function(t){return{init(){let e=t.Sprites.sprite("boot/ZotohLab_x1240.png"),r=t.Sprites.sprite("boot/preloader_bar.png"),s=t.Sprites.sprite("boot/preloader_bar.png"),[i,n]=t.scaleXY([e.width,e.height],[t.width,t.height]),o=t.getScaleFactor(),a=i>n?n:i;a*=.2,t.Sprites.scaleXY(s,a,a),t.Sprites.scaleXY(r,a,a),t.Sprites.scaleXY(e,a,a),t.Sprites.pinCenter(this,e),t.Sprites.pinBelow(e,r,4*o),t.Sprites.pinBelow(e,s,4*o),t.Sprites.opacity(s,.3),this.insertEx([e,s,r]),this.g.pbar=r,this.g.pbar_width=r.width},update(t){this.g.pbar.width=this.g.pbar_width*t}}}(t));{const r=new t.Scenes.Scene("loader",{setup(){o.init.call(this)}},{});e=t.stage.addChild(r).runOnce()}return PIXI.Assets.load(d,(t=>{r.unshift(t)})).then((e=>{c.delay(0,(()=>function(e){function s(t){c.log(`loaded ${t}`)}!function(t,e){let r=t.length;function s(){c.delay(0,(()=>e()))}function i(t){--r,0==r&&s()}t.forEach((t=>{(async function(t){const e=await PIXI.DOMAdapter.get().fetch(t),r=await e.arrayBuffer(),s=t.lastIndexOf("/");return{name:s>0?t.substring(s+1):t,url:t,buffer:r}})(t).then((t=>{P.Sound.decodeData(t.name,t.url,t.buffer,i)}))})),0==r&&s()}(a,(()=>{let i=0;for(const[r,n]of Object.entries(e))++i,s(r),t._cache[r]=n;a.forEach(s),c.log(`completed loading of ${i+a.length} files.`),r.unshift("$")}))}(e)))})).catch((t=>{++n,c.error(`Failed to load all assets: ${t}`)})),t.addBgTask({update(){if(0==r.length);else{let s=r.pop();u.num(s)?s&&o.update.call(e,s):"$"==s?c.delay(800,(()=>function(t,e,r,s){e&&t.delBgTask(e),c.delay(50,(()=>{t.Scenes.remove(r),s?c.error("Cannot load game!"):t._runAppStart()}))}(t,this,e,n>0))):c.error("Fatal error while loading assets")}}}),t.start()}c.patch(o,{assetFiles:[],logos:[],aniFps:12,fps:60});const T={width:0,height:0},w={width:1,height:1};function E(t){P._curFPS=P.calcFPS(t),a.forEach((e=>e.update?.(t))),!_&&P.stageCS((e=>e.update?.(t)))}const A=e=>t.requestAnimationFrame(e);class M{constructor(t){this.uid=t}playSound(){}pokeMove(){this.onPoke()}pokeWait(){this.onWait()}uuid(){return this.uid}stateValue(){c.assert(!1,"implement stateValue!")}}const P={_offsetX:0,_offsetY:0,_scaleX:1,_scaleY:1,_selectedCellX:0,_selectedCellY:0,_startPanX:0,_startPanY:0,_curFPS:60,Bot:class extends M{constructor(t="p2"){super(t)}onPoke(){}onWait(){}},Local:class extends M{constructor(t="p1"){super(t)}onPoke(){P.Input.resume()}onWait(){P.Input.pause()}},Mediator:class{constructor(){this.players=[],this._pcnt=0,this.state,this.pcur,this.end,this.pwin}cur(){return this.pcur}add(t){return t.pnum=++this._pcnt,t.owner=this,this.players.push(t),this}winner(){return this.pwin}isGameOver(){return this.end}gameState(t){return t&&(this.state=t),this.state}gameOver(t){return P.Input.resume(),this.pwin=t,this.end=!0}start(t){c.assert(t,"bad player to start with"),this.end=!1,this.pcur=t,this._turn()}other(){return this.pcur===this.players[0]?this.players[1]:this.pcur===this.players[1]?this.players[0]:void 0}_turn(){this.players.forEach((t=>{t!==this.pcur&&t.pokeWait()})),this.pcur.pokeMove()}redoTurn(){this.pcur.pokeMove()}postMove(t,e){c.assert(!1,"implement postMove!")}updateState(t,e){c.assert(!1,"implement updateState!")}updateSound(t){}updateMove(t,e){this.end||(this.updateState(t,e),this.updateSound(t),c.delay(0,(()=>this.postMove(t,e))))}takeTurn(){this.end||(this.pcur===this.players[0]?this.pcur=this.players[1]:this.pcur===this.players[1]&&(this.pcur=this.players[0]),this._turn())}},SSheetFrame:class{#t;#e;constructor(t,e){this.#t=t,this.#e=e}get frame(){return this.#e}get sheet(){return this.#t}toString(){return`${this.#t}::${this.#e}`}},UNSCII:"unscii",DOKI_LOWER:"Doki Lowercase",BIGSHOUTBOB:"Big Shout Bob",COPYRIGHT:"(c) www.zotohlab.com 2022-2024.",_frame:1/o.fps,EVERY:1,SOME:2,CENTER:3,TOP:4,LEFT:5,RIGHT:6,BOTTOM:7,UP:8,DOWN:9,NW:10,NE:11,SW:12,SE:13,NONE:100,PI_45:Math.PI/4,PI_90:Math.PI/2,PI_180:Math.PI,PI_270:1.5*Math.PI,PI_360:2*Math.PI,v2:d,math:p,ute:c,is:u,dom:h,u:o,Game:{mode:1},_cache:{},MODE_ONE:1,MODE_TWO:2,MODE_NET:3,CON:console,noop:()=>{},warn(...t){console.warn(...t)},get mouse(){return P.Input.pointer()},playSfx(t){return this.sound(t).play()},accel:(t,e,r)=>t+e*r,on:(...t)=>f.sub(...t),emit:(...t)=>f.pub(...t),off:(...t)=>f.unsub(...t),ssf(t,e){return new this.SSheetFrame(t,e)},frameRate(){return this._frame},sideRight:t=>t==P.RIGHT||t==P.NE||t==P.SE,sideLeft:t=>t==P.LEFT||t==P.NW||t==P.SW,sideTop:t=>t==P.UP||t==P.TOP||t==P.NW||t==P.NE,sideBottom:t=>t==P.DOWN||t==P.BOTTOM||t==P.SW||t==P.SE,overlap:(t,e)=>!(t.x2<e.x1||e.x2<t.x1||t.y2<e.y1||e.y2<t.y1),overlapX:(t,e)=>t.x2>e.x1&&e.x2>t.x1,overlapY:(t,e)=>t.y2>e.y1&&e.y2>t.y1,hasClass(t,e){if(e)return t.classList.contains(e)},toggleClass:(t,e)=>(e&&t.classList.toggle(e),t),addClass:(t,e)=>(c.hasClass(t,e)||t.classList.add(e),t),removeClass:(t,e)=>(c.hasClass(t,e)&&t.classList.remove(e),t),wrapv:(t,e,r)=>t<e?r:t>r?e:t,get canvas(){return this._canvasObj},get assets(){return PIXI.Assets.cache._cache},get designSize(){return this.u.arena},get width(){return this.canvas.width},get height(){return this.canvas.height},stageCS(t){this.inModal?t(c.last(this.stage.children)):this.stage.children.forEach((e=>{e instanceof P.Scenes.SceneWrapper&&(e=e.children[0]),e&&t(e)}))},moveToTop(t){let e=t.parent;return e&&(e.removeChild(t),e.addChild(t)),t},scroll(e,r){t.scrollTo(e||0,r||1)},portrait:()=>P.height>P.width,screenCenter:()=>c.v2(g(P.width/2),g(P.height/2)),scaleXY:(t,e)=>[e[0]/t[0],e[1]/t[1]],makeAnchor(t,e){return new PIXI.ObservablePoint(this,t,e??t)},mockStage(t=0,e=0,r,s){let i=u.obj(t)?t:{x:t,y:e,width:r??P.width,height:s??P.height};return i.getGlobalPosition=()=>({x:this.x,y:this.y}),i.anchor=P.makeAnchor(0,0),i.m5={stage:!0},i},tcached(t){return c.inst(PIXI.Texture,t)?t:u.str(t)?this._cache[t]||PIXI.Assets.cache._cache.get(t):e},clickPlayMsg(){return(this.touchDevice?"Tap":"Click")+" to Play!"},splitXY:(t,e)=>[t%e,g(t/e)],rect:(t,e,r,s)=>new PIXI.Rectangle(t,e,r,s),scaleSZ:(t,e)=>({width:e.width/t.width,height:e.height/t.height}),sheet(t,e){const r=this.resource(t);return c.assert(r,`unknown sheet: ${t}.`),c.assert(u.obj(r.data)&&u.obj(r.textures),`bad sheet: ${t}`),r.textures[e]},image(t){return this.resource(t)},xml(t){return this.resource(t)},json(t){return this.resource(t)},assetPath(t,e){if(u.str(t))if(t.includes("/"))e=t;else{let o="data",a=c.fileExt(t);c.has(n,a)?o="images":c.has(r,a)||c.has(i,a)?o="fonts":c.has(s,a)&&(o="audio"),e=`${o}/${t}`}return e||""},contentScaleFactor(){return T.height=P.height,T.width=P.width,"max"!==o.scaleToWindow?w:this.scaleSZ(this.designSize,T)},getScaleFactor(t){if(t||"max"==o.scaleToWindow){T.height=P.height,T.width=P.width;let t=this.scaleSZ(this.designSize,T);return"x"==o.scaleFit||"X"==o.scaleFit?t.width:"y"==o.scaleFit||"Y"==o.scaleFit?t.height:Math.min(t.width,t.height)}return 1},resource(t,r){let s,i;return c.inst(this.SSheetFrame,t)?i=this.sheet(t.sheet,t.frame):t&&(s=this.assetPath(t),i=this.tcached(t)||this.tcached(s)||PIXI.Texture.from(s)),i||(r?c.assert(!1,`no such resource ${t}.`):e)},addChild:(t,e,...r)=>(t.addChild(e),r.forEach((e=>t.addChild(e))),e),_fpsList:e,_fpsSum:0,calcFPS(t){let e,r=0;return t>0&&(e=g(1/t),this._fpsList||(this._fpsList=c.fill(60,e),this._fpsSum=60*e),this._fpsSum-=this._fpsList.pop(),this._fpsList.unshift(e),this._fpsSum+=e,r=g(this._fpsSum/60)),r},degToRad:t=>t*(Math.PI/180),radToDeg:t=>t*(180/Math.PI),addBgTask(t){a.push(t)},delBgTask(t){t&&(c.disj(a,t),t.dispose&&t.dispose())},resume(){_=!1},pause(){_=!0},start(){let t=0,e=c.now(),r=function(){let s=c.now(),i=(s-e)/1e3,n=P.frameRate();for(i>m&&(i=m),t+=i;t>=n;t-=n)E(i);P.ctx.render(P.stage),e=s,A(r)};return A(r)},_runAppStart(){return P.Input.keybd(P.Input.Q,(()=>{this.takeScreenShot()})),P.u.start(this)},takeScreenShot(){P.ctx.extract.canvas(P.stage).toBlob((t=>{const e=document.createElement("a");document.body.append(e),e.download="screenshot",e.href=URL.createObjectURL(t),e.click(),e.remove()}),"image/png")},worldToScreen(t,e){return[g((t-this._offsetX)*this._scaleX),g((e-this._offsetY)*this._scaleY)]},screenToWorld(t,e){return[t/this._scaleX+this._offsetX,e/this._scaleY+this._offsetY]}};{let e,r=PIXI.isMobile.tablet,s=PIXI.isMobile.phone;e=PIXI.isMobile.windows.device?r?"tablet":s?"phone":"windows":PIXI.isMobile.apple.device?r?"ipad":s?"iphone":"apple":PIXI.isMobile.android.device?"android":r||s?"mobile":"desktop",c.log(`we are running on a ${e} device`),function(e){let r=!1,s=o.arena;c.assert(s,"design resolution req'd."),"max"!=o.scaleToWindow&&!0!==o.scaleToWindow||(r=!0,s={width:y(),height:b()},1==o.arena.scale&&(r=!1,o.arena=s,o.scaleToWindow="win")),e.maxed=r,o.logos||(o.logos=new Array),(async()=>{e.ctx=await PIXI.autoDetectRenderer(c.inject(s,{webgpu:{antialias:!0},webgl:{antialias:!0}})),function(e,r){e.touchDevice=!!("ontouchstart"in document),e._canvasObj=e.ctx.canvas,e._canvasObj.id="mojoh5",e.scale=1,e.scaledBgColor="#5A0101",e.stage=new x,["Sprites","Input","Scenes","Sound","FX","Ute2D","Tiles","Touch"].forEach((r=>{c.log(`installing module ${r}...`),t[`io/czlab/mojoh5/${r}`](e).assets?.forEach((t=>e.u.assetFiles.unshift(t)))})),a.push(e.FX),function(t){let e=h.newElm("style");h.conj(document.body,P._canvasObj),h.conj(e,h.newTxt("body, * {padding: 0; margin: 0; height:100%; overflow:hidden}")),h.conj(document.head,e),h.css(P._canvasObj,{outline:"none"}),h.attrs(P._canvasObj,"tabindex","0"),h.css(document.body,{background:"black"})}(),c.has(r,"border")&&h.css(e.canvas,"border",r.border),c.has(r,"bgColor")&&(e.ctx.backgroundColor=e.Sprites.color(r.bgColor)),e.prevHeight=0,e.prevWidth=0,!0===r.resize&&(c.addEvent("resize",t,c.debounce((t=>{const[r,s]=[e.prevWidth,e.prevHeight];e.ctx.resize(y(),b()),e.emit(["canvas.resize"],[r,s]),e.prevWidth=y(),e.prevHeight=b()}),r.debounceRate||150)),e.on(["canvas.resize"],(t=>S.onResize(e,t)))),t.setTimeout((function(){!function(t){t._canvasObj.height=b(),t._canvasObj.width=y(),t._canvasObj.focus(),t.scroll(),c.log(`canvas size= w:${t.canvas.width},h=${t.canvas.height}`),t.prevHeight=b(),t.prevWidth=y(),t.u.load||(t.u.logos=["boot/preloader_bar.png","boot/ZotohLab_x1240.png"]);let e=t.u.logos.map((e=>t.assetPath(e)));PIXI.Assets.init(),(async(r,s)=>{try{r=await PIXI.Assets.load(e),s=Object.keys(r)}catch(t){c.error(t)}s&&e.length==s.length?(s.forEach((t=>c.log(`loaded logo file "${t}"`))),c.delay(50,(()=>v(t)))):c.log("logo files not loaded!")})()}(e)}),1e3)}(e,o)})()}(P)}}if("object"==typeof module&&module.exports)throw"Panic: browser only!";t.MojoH5=function(t){return o(t,[])},t.MojoH5Ldr=function(e){window.addEventListener("load",(()=>t.MojoH5(e)))}}(this),function(t,e){"use strict";const r={blue:"#319bd5",green:"#78c03f",yellow:"#f9ef50",red:"#eb2224",orange:"#f48917",grey:"#848685",cyan:"#1ee5e6",lime:"#e5e61e",magenta:"#e61ee5",purple:"#a6499a"},s={aqua:"#00FFFF",black:"#000000",blue:"#0000FF",brown:"#A52A2A",crimson:"#DC143C",cyan:"#00FFFF",fuchsia:"#FF00FF",gray:"#808080",green:"#008000",grey:"#808080",lavender:"#E6E6FA",lime:"#00FF00",magenta:"#FF00FF",maroon:"#800000",navy:"#000080",olive:"#808000",orange:"#FFA500",purple:"#800080",red:"#FF0000",silver:"#C0C0C0",teal:"#008080",turquoise:"#40E0D0",wheat:"#F5DEB3",white:"#FFFFFF",yellow:"#FFFF00"};function i(i){const{v2:n,math:o,ute:a,is:l,dom:h}=i,u=t["io/czlab/mcfud/geo2d"](),c=2*Math.PI,d=Math.floor;function p(t,e,r,s){return new PIXI.GenerateTextureSystem(i.ctx).generateTexture(t)}var f,g,m;function _(t,r){let s,n;return a.inst(PIXI.Graphics,t)&&(t=p(t)),a.inst(PIXI.Texture,t)?n=t:l.vec(t)?(l.str(t[0])&&(t=t.map((t=>i.resource(t)))),s=a.inst(PIXI.Texture,t[0])?new PIXI.AnimatedSprite(t,!1):e):l.str(t)&&(n=i.resource(t)),n&&(s=r(n)),a.assert(s,`SpriteError: ${t} not found`)&&s}function x(t,e,r,s,i,n){let o=e,a=t,l=[];for(let e,h,u,c=0;c<r;++c){u=[];for(let t=0;t<s;++t)h=o+n,e=a+i,u.push({x1:a,x2:e,y1:o,y2:h}),a=e;o=h,a=t,l.push(u)}return l}function y(t,e,r){let s,n;return e&&e.m5&&e.m5.stage?n={x1:0,y1:0,x2:i.width,y2:i.height}:(void 0!==e.angle&&a.assert(a.feq0(e.angle),"expected non rotated object!"),s=e.parent,n=t.getAABB(e)),r&&s===r&&(n.x1+=r.x,n.x2+=r.x,n.y1+=r.y,n.y2+=r.y),[n,o.ndiv(n.x2-n.x1,2),o.ndiv(n.y2-n.y1,2),o.ndiv(n.x1+n.x2,2),o.ndiv(n.y1+n.y2,2)]}function b(t,e,r){if(e.m5.static)n.sub$(t.m5.vel,n.mul(r.overlapN,2*n.dot(t.m5.vel,r.overlapN)));else{let s=n.mul$(n.sub(e.m5.vel,t.m5.vel),r.overlapN),i=-2*(s[0]+s[1])/(t.m5.invMass+e.m5.invMass);n.sub$(t.m5.vel,n.mul$(n.div(r.overlapN,t.m5.mass),i)),n.add$(e.m5.vel,n.mul$(n.div(r.overlapN,e.m5.mass),i))}}function v(t,e,r){let s,i=t.toBody(e),n=t.toBody(r);return s=e.m5.circle?r.m5.circle?u.hitCircleCircle(i,n):u.hitCirclePolygon(i,n):r.m5.circle?u.hitPolygonCircle(i,n):u.hitPolygonPolygon(i,n),s&&(s.A=e,s.B=r),s}f=new PIXI.Container,(g=new PIXI.Graphics).circle(0,0,4),g.fill({color:0}),m=new PIXI.Sprite(p(g)),["m5","tiled","remove","collideXY","setup","preTMX","postTMX","dispose","preDispose","onTick","getGuid","getBBox","getSpatial"].forEach((t=>{[[f,"Container"],[g,"Graphics"],[m,"Sprite"]].forEach((e=>{a.assertNot(a.has(e[0],t),`Uh Oh, PIXI ${e[1]} has our ${t} property!`)}))}));const T={SomeColors:{},BtnColors:{},Geo:u,assets:["boot/splash.jpg","boot/star.png","boot/audioOff.png","boot/audioOn.png","boot/unscii.fnt","boot/doki.fnt","boot/BIG_SHOUT_BOB.fnt"],assertCenter:t=>a.assert(t?.anchor&&a.feq(t.anchor.x,.5)&&a.feq(t.anchor.y,.5),"not center'ed"),empty:t=>t&&0==t.children.length,btnPress(t,e,r,s,n,o=343){const l=this;return function(t){t.tint=l.color(e),s&&i.sound(s).play(),a.delay(o,(()=>{t.tint=l.color(r),n(t)}))}},oneOffClick(t,e){const r=function(){i.Input.off(["single.tap"],r),e&&i.sound(e).play(),t()};return i.Input.on(["single.tap"],r),r},cancelOneOffClick:t=>(t&&i.Input.off(["single.tap"],t),e),sizeXY:(t,e,r)=>(l.num(r)&&(t.height=r),l.num(e)&&(t.width=e),t),asCircle:t=>(t.m5.circle=!0)&&t,scaleXY:(t,e,r)=>(l.num(e)&&(t.scale.x=e),l.num(r)&&(t.scale.y=r),t),scaleBy:(t,e,r)=>(l.num(e)&&(t.scale.x*=e),l.num(r)&&(t.scale.y*=r),t),isVX:t=>!a.feq0(t.m5.vel[0]),isVY:t=>!a.feq0(t.m5.vel[1]),halfSize:t=>({width:d(t.width/2),height:d(t.height/2)}),anchorXY:(t,e,r)=>(a.assert(t.anchor,"sprite has no anchor object"),t.anchor.y=r??e,t.anchor.x=e,t),centerAnchor(t){return this.anchorXY(t,.5,.5)},topLeftAnchor(t){return this.anchorXY(t,0,0)},offsetXY:(t,e,r)=>(a.assert(t.anchor&&e>=0&&e<=1&&r>=0&&r<=1,"no anchor or bad target offset points"),[t.width*(e-t.anchor.x),t.height*(r-t.anchor.y)]),topLeftOffsetXY(t){return this.offsetXY(t,0,0)},centerOffsetXY(t){return this.offsetXY(t,.5,.5)},adjOffsetXY:(t,e,r)=>(a.assert(t.anchor&&e>=0&&e<=1&&r>=0&&r<=1,"no anchor or bad target offset points"),[t.width*(t.anchor.x-e),t.height*(t.anchor.y-r)]),makeSteerable(t){t.width!=t.height&&i.warn(`object ${t.m5?.uuid} is not a square, radius will be off....`);let{width:e,height:r}=this.halfSize(t);return t.m5.steer=[0,0],t.m5.steerInfo={wanderAngle:a.rand()*Math.PI*2,arrivalThreshold:400,wanderDistance:10,wanderRadius:5,wanderRange:1,avoidDistance:400,inSightDistance:200,tooCloseDistance:60,maxForce:5,pathIndex:0},t.m5.radius=Math.sqrt(e*e+r*r),t},updateSteer:(t,e=!0)=>(t.m5?.steer&&(n.clamp$(t.m5.steer,0,t.m5.steerInfo.maxForce),n.div$(t.m5.steer,t.m5.mass),n.add$(t.m5.vel,t.m5.steer),e&&n.mul$(t.m5.steer,0)),t),clrSpatial:t=>(t.m5?.sgrid&&(t.m5.sgrid.x1=e,t.m5.sgrid.x2=e,t.m5.sgrid.y1=e,t.m5.sgrid.y2=e),t),lift(t){if(!t.m5){const e=this;t.g={},t.m5={uuid:`s${a.nextId()}`,circle:!1,stage:!1,drag:!1,dead:!1,angVel:0,friction:n.vec(1,1),gravity:n.vec(),vel:n.vec(),acc:n.vec(),static:!1,sensor:!1,sgrid:{},mass:1,type:0,cmask:0,speed:0,heading:i.RIGHT,get invMass(){return a.feq0(t.m5.mass)?0:1/t.m5.mass}},t.m5.resize=function(r,s,i,n){e.resize(t,r,s,i,n)},t.m5.getImageOffsets=function(){return{x1:0,x2:0,y1:0,y2:0}},t.m5.getContactPoints=function(){return function(t,e,r){let s=[n.vec(e,r),n.vec(e,0),n.vec(0,0),n.vec(0,r)];return t&&s.forEach((s=>{s[0]-=d(e*t.x),s[1]-=d(r*t.y)})),s}(t.anchor,t.width,t.height)},t.getGuid=function(){return t.m5.uuid},t.getSpatial=function(){return t.m5.sgrid},t.getBBox=function(){return a.feq0(t.angle)?e.getAABB(t):e.boundingBox(t)}}return t},clamp2Pi(t){for(;t.rotation>c;)t.rotation-=c;for(;t.rotation<0;)t.rotation+=c;return t},getHeading:t=>[Math.cos(t.rotation),Math.sin(t.rotation)],setOrient:(t,e,r=!1)=>(r?t.angle=e:t.rotation=e,t),toPolygon:t=>new u.Polygon(t.m5.getContactPoints()).setOrient(t.rotation),toCircle(t){return this.assertCenter(t)&&new u.Circle(d(t.width/2)).setOrient(t.rotation)},toBody(t){let e=t.x,r=t.y,s=t.m5.circle?this.toCircle(t):this.toPolygon(t);return u.bodyWrap(s,e,r)},gposXY(t){const{x:e,y:r}=t.getGlobalPosition();return n.vec(e,r)},isTopLeft:t=>!t.anchor||a.feq0(t.anchor.x)&&a.feq0(t.anchor.y),isCenter:t=>!!t.anchor&&a.feq(t.anchor.x,.5)&&a.feq(t.anchor.y,.5),centerXY(t){return this.isCenter(t)?n.vec(t.x,t.y):n.add(this.centerOffsetXY(t),t)},setScaleModeNearest:(t,e=!0)=>(t.texture.source.scaleMode=e?"nearest":"linear",t),angle(t,e){return n.angle(this.centerXY(t),this.centerXY(e))},die:t=>(t.m5.dead=!0)&&t,undie:t=>(t.m5.dead=!1)||t,move:(t,e)=>(e?(n.add$(t.m5.vel,n.mul(t.m5.gravity,e)),n.add$(t.m5.vel,n.mul(t.m5.acc,e)),n.mul$(t.m5.vel,t.m5.friction)):e=1,void 0!==t.m5.maxSpeed&&n.clamp$(t.m5.vel,0,t.m5.maxSpeed),n.add$(t,n.mul(t.m5.vel,e))),leftSide(t){let e=t.x,r=t.width,s=t.anchor?t.anchor.x:0;return s>.7?e-=r:s>0&&(e-=d(r/2)),e},rightSide(t){return this.leftSide(t)+t.width},topSide(t){let e=t.y,r=t.height,s=t.anchor?t.anchor.y:0;return s>.7?e-=r:s>0&&(e-=d(r/2)),e},bottomSide(t){return this.topSide(t)+t.height},getAABB(t){if(void 0!==t.x1&&void 0!==t.y2)return t;a.assert(t.m5,"bad sprite for getAABB");let{x1:e,y1:r,x2:s,y2:i}=t.m5.getImageOffsets(),n=this.leftSide(t),o=this.topSide(t);return{x1:n+e,y1:o+r,x2:n+t.width-s,y2:o+t.height-i}},bbox4:(t,e,r,s)=>a.assert(r<=s,"bad bbox")&&{x1:t,x2:e,y1:r,y2:s},bboxCenter(t){if(l.num(t.x1))return n.vec(o.ndiv(t.x1+t.x2,2),o.ndiv(t.y1+t.y2,2))},bboxFrame(t,e=16,r="#dedede"){a.assert(void 0!==t.x1,"bad bounding box");let s,{x1:i,x2:n,y1:o,y2:l}=t,h=n-i,u=l-o,c=this.graphics();return c.roundRect(0,0,h+e,u+e,d(e/4)),c.stroke({width:e,color:this.color(r)}),s=this.sprite(c),s.x=i-e,s.y=o-e,s},bboxSize:t=>void 0!==t.x1?n.vec(t.x2-t.x1,t.y2-t.y1):a.assert(!1,"bad bounding box"),pointInBBox:(t,e,r)=>void 0!==r.x1&&t>r.x1&&t<r.x2&&e>r.y1&&e<r.y2,boundingBox(t){a.feq0(t.rotation)||a.assert(this.isCenter(t),"expected rotated obj with center-anchor");let e,r,s=[],i=[],n=d(t.width/2),o=d(t.height/2),l=Math.tanh(o/n),h=Math.sqrt(n*n+o*o);return r=c-l+t.rotation,i.push(h*Math.sin(r)),s.push(h*Math.cos(r)),r=l+t.rotation,i.push(h*Math.sin(r)),s.push(h*Math.cos(r)),r=Math.PI-l+t.rotation,i.push(h*Math.sin(r)),s.push(h*Math.cos(r)),r=Math.PI+l+t.rotation,i.push(h*Math.sin(r)),s.push(h*Math.cos(r)),e=this.centerXY(t),i.sort(((t,e)=>t-e)),s.sort(((t,e)=>t-e)),{x1:d(s[0]+e[0]),x2:d(s[3]+e[0]),y1:d(i[0]+e[1]),y2:d(i[3]+e[1])}},hitTestPoint(t,e,r){const s=this.toBody(r);return r.m5.circle?u.hitTestPointCircle(t,e,s):u.hitTestPointPolygon(t,e,s)},distance(t,e){return n.dist(this.centerXY(t),this.centerXY(e))},scaleContent(...t){1==t.length&&l.vec(t[0])&&(t=t[0]);const e=i.getScaleFactor();t.forEach((t=>{t.scale.x*=e,t.scale.y*=e}))},scaleToCanvas:t=>(t.height=i.height,t.width=i.width,t),uuid:(t,e)=>(t.m5.uuid=e,t),opacity:(t,e)=>(t.alpha=e,t),tint(t,e){return t.tint=this.color(e),t},hide:t=>(t.visible=!1)||t,show:t=>(t.visible=!0)&&t,pset:(t,e,r)=>(t.g[e]=r,t),pget:(t,e)=>t.g[e],container(t){const e=this.lift(new PIXI.Container);return t&&t(e),e},group(...t){const e=this.container();return t.forEach((t=>e.addChild(t))),e},sprite(t,e=!1,r=0,s=0){const n=this.lift(_(t,(t=>new PIXI.Sprite(t))));return n.x=r,n.y=s,e&&this.centerAnchor(n),a.inst(PIXI.AnimatedSprite,n)?function(t){let e=0,r={};function s(){e&&(e=clearInterval(e))}function n(){r.cnt<r.total?(t.gotoAndStop(t.currentFrame+1),r.cnt+=1):t.loop?(t.gotoAndStop(r.start),r.cnt=1):(s(),t.onComplete?.())}return a.inject(t.m5,{stopFrames(){s(),t.gotoAndStop(t.currentFrame)},showFrame(e){s(),t.gotoAndStop(e)},playFrames(o){s(),r.start=0,r.end=t.totalFrames-1,l.vec(o)&&o.length>1&&(r.start=o[0],r.end=o[1]),r.total=r.end-r.start+1,t.gotoAndStop(r.start),r.cnt=1,e=setInterval(n,1e3/i.aniFps)}}),t}(n):n},spriteFrame(t,e,r=!1,s=0,n=0){return this.sprite(i.sheet(t,e),r,s,n)},tilingSprite(t,e,r){return this.lift(_(t,(t=>new PIXI.TilingSprite({texture:t,width:e||t.width,height:r||t.height}))))},repeatSprite(t,e=!0,r=!0,s,o){let a,l=this,h=[],u=0,c=0,d=0,p=0;function f(){const e=l.lift(_(t,(t=>new PIXI.Sprite(t))));let r=i.getScaleFactor();return r=1,e.width*=1,e.height*=1,e}if(e){for(;d<s;)h.push(a=f()),n.set(a,u,c),d+=a.width,u+=a.width,d>=s&&p<o&&r&&(p+=a.height,c+=a.height,u=0,d=0);r=!1}if(r){for(;p<o;)h.push(a=f()),n.set(a,u,c),p+=a.height,c+=a.height,p>=o&&d<s&&e&&(d+=a.width,u+=a.width,c=0,p=0);e=!1}return h},animation(t,e,r,s=0){let o=i.resource(t);if(!o)throw`SpriteError: ${t} not loaded.`;let a=d(o.width/e),l=[],h=a*d(o.height/r);for(let t,i,o=0;o<h;++o)t=o%a*e,i=d(o/a)*r,s>0&&(t+=s+s*o%a,i+=s+s*d(o/a)),l.push(n.vec(t,i));return this.sprite(l.map((t=>new PIXI.Texture({source:o.source,frame:new PIXI.Rectangle(t[0],t[1],e,r)}))))},frame(t,e,r,s,n){return this.sprite(new PIXI.Texture({source:i.resource(t).source,frame:new PIXI.Rectangle(s,n,e,r)}))},frameSelect:(t,e,r,s)=>s.map((s=>new PIXI.Texture({source:i.resource(t).source,frame:new PIXI.Rectangle(s[0],s[1],e,r)}))),frames(t,e,r,s=0,n=0,a=0,l=0){let h=e+s,u=r+n,c=i.resource(t),p=d(c.height/u),f=[],g=o.ndiv(c.width+s,h);for(let t,s=0;s<p;++s){t=l+r*s;for(let s,i=0;i<g;++i)s=a+e*i,f.push(new PIXI.Texture({source:c.source,frame:new PIXI.Rectangle(s,t,e,r)}))}return f},frameImages:(...t)=>(1==t.length&&l.vec(t[0])&&(t=t[0]),t.map((t=>i.resource(t)))),spriteFrom(...t){return this.sprite(this.frameImages(...t))},text(t,e,r=0,s=0){return n.set(this.lift(new PIXI.Text(t||"",e)),r,s)},bitmapText(t,e,r){let s;return l.str(e)?(s={fontFamily:e},l.num(r)&&(s.fontSize=r)):s=e,s.fontFamily||(s.fontFamily=s.fontName?s.fontName:"unscii"),s.align||(s.align="center"),this.lift(new PIXI.BitmapText({text:t||"",style:s}))},triangle(t,e,r,s=16777215,i=16777215,o=0,a=0,h=0){let u=this.graphics(),c=1,p=d(t/2),f=this.color(i),g=r<.5?0:r>.5?t:p;!1!==s&&l.vec(s)&&(c=s[1],s=s[0]),u.poly([0,0,g,-e,t,0]),!1!==s&&u.fill({color:this.color(s),alpha:c}),o>0&&u.stroke({width:o,color:f,alpha:1});let m=this.sprite(u);return m.m5.getContactPoints=e<0?()=>[[g,-e],[t,0],[0,0]]:()=>[[t,e],[g,0],[0,e]],n.set(m,a,h)},rect(t,e,r=16777215,s=16777215,i=0){return this.sprite(this.rectTexture(t,e,r,s,i))},grect:(t,e,r,s,i)=>(t.rect(e,r,s,i),t),gcircle:(t,e,r,s)=>(t.circle(e,r,s),t),gfillEx:(t,e,r)=>(r||(r={}),r.texture=e,t.texture(r),t),gclear:t=>t.clear(),gpath:(t,e)=>(a.assert(l.vec(e),"expected path actions!"),e.forEach((e=>{l.vec(e)?t[e.shift()].apply(t,e):l.str(e)&&t[e]()})),t),gfill:(t,e)=>(a.assert(l.obj(e),"expected fill style object"),t.fill(e),t),gstroke:(t,e)=>(a.assert(l.obj(e),"expected stroke style object"),t.stroke(e),t),rectTexture(t,e,r=16777215,s=16777215,i=0){let n,o=this.graphics();return!1!==r&&(l.vec(r)?(n=r[1],r=r[0]):n=1),o.rect(0,0,t,e),!1!==r&&o.fill({color:this.color(r),alpha:n}),i>0&&o.stroke({width:i,color:this.color(s)}),this.genTexture(o)},drawBody(t,...e){const r=this.graphics();return t.apply(this,[r].concat(e)),this.lift(new PIXI.Sprite(this.genTexture(r)))},circle(t,e=16777215,r=16777215,s=0){return this.circleEx(this.circleTexture(t,e,r,s))},circleTexture(t,e=16777215,r=16777215,s=0){let i,n=this.graphics();return!1!==e&&(l.vec(e)?(i=e[1],e=e[0]):i=1),n.circle(0,0,t),!1!==e&&n.fill({color:this.color(e),alpha:i}),s>0&&n.stroke({width:s,color:this.color(r)}),this.genTexture(n)},circleEx(t){const e=this.lift(new PIXI.Sprite(t));return(e.m5.circle=!0)&&this.centerAnchor(e)},line(t,e,r,s,i=1){let o,a=n.clone(r),l=n.clone(s),h=this.graphics(),u=this.color(t);function c(){h.clear(),h.moveTo(a[0],a[1]),h.lineTo(l[0],l[1]),h.stroke({width:e,color:u,alpha:i})}return c(),o=this.lift(h),o.m5.ptA=function(t,e){return void 0!==t&&(a[0]=t,a[1]=e??t,c()),a},o.m5.ptB=function(t,e){return void 0!==t&&(l[0]=t,l[1]=e??t,c()),l},o},isMoving:t=>!a.feq0(t.m5.vel[0])||!a.feq0(t.m5.vel[1]),makeCells(t,e,r,s,i,n){let a=o.ndiv(r-t,i);return x(t,e,o.ndiv(s-t,n),a,i,n)},gridBox(t=.9,e=.9,r){let s=r??i,n=d(s.height*e),a=d(s.width*t),l=o.ndiv(s.width-a,2),h=o.ndiv(s.height-n,2);return{x1:l,y1:h,x2:l+a,y2:h+n}},gridSQ(t,e=.9,r){let s=e*(i.height<i.width?i.height:i.width),n=d(s/t),l=n;a.isEven(n)||--n,l=n,s=t*n;let h=o.ndiv(i.height-s,2),u=o.ndiv(i.width-s,2),c=u,p=h;return r&&(r.height=s,r.width=s,void 0!==r.x&&(c=r.x),void 0!==r.y&&(p=r.y),r.x=u,r.y=h,r.x1=u,r.y1=h,r.x2=u+s,r.y2=h+s),x(c,p,t,t,n,l)},divXY([t,e],r=.9,s=.9,n){let a,l,h,u,c=d(i.height*s),p=d(i.width*r),f=d(p/t),g=d(c/e);return c=e*g,p=t*f,h=o.ndiv(i.height-c,2),u=o.ndiv(i.width-p,2),a=u,l=h,n&&(n.height=c,n.width=p,void 0!==n.x&&(a=n.x),void 0!==n.y&&(l=n.y),n.x=u,n.y=h,n.x1=u,n.y1=h,n.x2=u+p,n.y2=h+c),x(a,l,e,t,f,g)},gridXY([t,e],r=.9,s=.9,n){let l,h,u,c,p=d(i.height*s),f=d(i.width*r),g=d(f/t),m=d(p/e),_=g>m?m:g;return a.isEven(_)||--_,p=e*_,f=t*_,u=o.ndiv(i.height-p,2),c=o.ndiv(i.width-f,2),l=c,h=u,n&&(n.height=p,n.width=f,void 0!==n.x&&(l=n.x),void 0!==n.y&&(h=n.y),n.x=c,n.y=u,n.x1=c,n.y1=u,n.x2=c+f,n.y2=u+p),x(l,h,e,t,_,_)},gridBBox(t,e,r){let s=r[0].length,i=r[0][0],n=r[r.length-1][s-1];return{x1:t+i.x1,x2:t+n.x2,y1:e+i.y1,y2:e+n.y2}},graphics(t){const e=new PIXI.Graphics;return(e.m5={uuid:`${t||a.nextId()}`})&&e},drawGridBox(t,e=1,r="white",s){return s||(s=this.graphics()),s.rect(t.x1,t.y1,t.x2-t.x1,t.y2-t.y1),s.stroke({width:e,color:this.color(r)}),s},drawGridBoxEx(t,e=1,r="white",s=1,i){return i||(i=this.graphics()),i.roundRect(t.x1,t.y1,t.x2-t.x1,t.y2-t.y1,s),i.stroke({width:e,color:this.color(r)}),i},drawGridLines(t,e,r,s,i,n){let o=r.length,a=r[0].length;n||(n=this.graphics());for(let s,i=1;i<o;++i)s=r[i],n.moveTo(t+s[0].x1,e+s[0].y1),n.lineTo(t+s[a-1].x2,e+s[a-1].y1);for(let s,i=1;i<a;++i)s=r[0],n.moveTo(t+s[i].x1,e+s[i].y1),s=r[o-1],n.lineTo(t+s[i].x1,e+s[i].y2);return l.obj(i)?(i.color=this.color(i.color||"white"),i.width=s,n.stroke(i)):n.stroke({width:s,color:this.color(i)}),n},add:(t,...e)=>(e.forEach((e=>e&&t.addChild(e))),t),remove:(...t)=>(1==t.length&&l.vec(t[0])&&(t=t[0]),a.doseqEx(t,(t=>{t.parent&&(a.inst(i.Scenes.Scene,t.parent)?t.parent.remove(t):t.parent.removeChild(t)),i.emit(["post.remove",t]),i.off(t),t.m5.dispose?.()})),t[0]),centerObj(t){let e=t.anchor,r=i.width/2,s=i.height/2,n=t.width/2,o=t.height/2;return t.x=r,t.y=s,e||(e={x:0,y:0}),e.x<.3&&(t.x=r-n),e.x>.7&&(t.x=r+n),e.y<.3&&(t.y=s-o),e.y>.7&&(t.y=s+o),t},fillMax(t){return(l.str(t)||a.inst(PIXI.Texture,t))&&(t=this.sprite(t)),a.assert(a.inst(PIXI.Container,t),"expected sprite"),t.height=i.height,t.width=i.width,this.centerObj(t)},colorToRgbA(t){a.assert(l.str(t)&&t.length>0,"bad color string value");let e,r=t.toLowerCase(),i=s[r];if("transparent"==r)return[0,0,0,0];if(i&&(t=i),"#"==t[0]){if((e=t.split("")).shift(),3==e.length&&e.push("F"),4==e.length&&(e=e.flatMap((t=>[t,t]))),6==e.length&&e.push("F","F"),8==e.length)return[parseInt(e[0]+e[1],16),parseInt(e[2]+e[3],16),parseInt(e[4]+e[5],16),parseInt(e[6]+e[7],16)/255]}else if(0==r.indexOf("rgb"))return r.indexOf("rgba")<0&&(r+=",1"),r.match(/[\.\d]+/g).map((t=>+t));throw`Error: Bad color string: ${t}`},byteToHex:t=>("0"+t.toString(16)).slice(-2),colorToHex(t){const e=this.colorToRgbA(t);return"0x"+[0,1,2].map((t=>this.byteToHex(e[t]))).join("")},color3(t,e,r){return parseInt(["0x",this.byteToHex(t),this.byteToHex(e),this.byteToHex(r)].join(""))},color(t){return isNaN(t)?parseInt(this.colorToHex(t)):t},rgba(t){return a.assert(l.vec(t),"wanted rgba array"),parseInt("0x"+[0,1,2].map((e=>this.byteToHex(t[e]))).join(""))},hsla(t,e,r,s){function i(t){return Math.min(1,Math.max(0,t))}function n(t){return 6*(t=t<0?t+1:t>1?t-1:t)<1?a+(o-a)*t*6:2*t<1?o:3*t<2?a+(o-a)*(2/3-t)*6:a}t=t%360/360,e=i(e),r=i(r),s=i(s);let o=r<=.5?r*(e+1):r+e-r*e,a=2*r-o;return this.rgba([255*n(t+1/3),255*n(t),255*n(t-1/3),s])},resize(t,e,r,s,i){t&&a.doseqEx(t.children,(e=>e.m5&&e.m5.resize?.(t.x,t.y,t.width,t.height)))},pinAbove(t,e,r=10,s=.5){let[i,o,a,l,h]=y(this,t),[u,c,d,p,f]=y(this,e,t),g=i.y1-r-(u.y2-u.y1),m=s<.3?i.x1:s<.7?l-c:i.x2-(u.x2-u.x1);e.y=!e.anchor||e.anchor.y<.3?g:e.anchor.y<.7?g+d:g+(u.y2-u.y1),e.x=!e.anchor||e.anchor.x<.3?m:e.anchor.x<.7?m+c:m+(u.x2-u.x1),e.parent===t&&n.sub$(e,t)},pinBelow(t,e,r=10,s=.5){let[i,o,a,l,h]=y(this,t),[u,c,d,p,f]=y(this,e,t),g=i.y2+r,m=s<.3?i.x1:s<.7?l-c:i.x2-(u.x2-u.x1);e.y=!e.anchor||e.anchor.y<.3?g:e.anchor.y<.7?g+d:g+(u.y2-u.y1),e.x=!e.anchor||e.anchor.x<.3?m:e.anchor.x<.7?m+c:m+(u.x2-u.x1),e.parent===t&&n.sub$(e,t)},pinCenter(t,e){let[r,s,i,o,a]=y(this,t),[l,h,u,c,d]=y(this,e,t),p=o-h,f=a-u;e.y=!e.anchor||e.anchor.y<.3?f:e.anchor.y<.7?f+u:f+(l.y2-l.y1),e.x=!e.anchor||e.anchor.x<.3?p:e.anchor.x<.7?p+h:p+(l.x2-l.x1),(t.m5.stage||e.parent===t)&&n.sub$(e,t)},pinLeft(t,e,r=10,s=.5){let[i,o,a,l,h]=y(this,t),[u,c,d,p,f]=y(this,e,t),g=i.x1-r-(u.x2-u.x1),m=s<.3?i.y1:s<.7?h-d:i.y2-(u.y2-u.y1);e.y=!e.anchor||e.anchor.y<.3?m:e.anchor.y<.7?m+d:m+(u.y2-u.y1),e.x=!e.anchor||e.anchor.x<.3?g:e.anchor.x<.7?g+c:g+(u.x2-u.x1),e.parent===t&&n.sub$(e,t)},pinRight(t,e,r=10,s=.5){let[i,o,a,l,h]=y(this,t),[u,c,d,p,f]=y(this,e,t),g=i.x2+r,m=s<.3?i.y1:s<.7?h-d:i.y2-(u.y2-u.y1);e.y=!e.anchor||e.anchor.y<.3?m:e.anchor.y<.7?m+d:m+(u.y2-u.y1),e.x=!e.anchor||e.anchor.x<.3?g:e.anchor.x<.7?g+c:g+(u.x2-u.x1),e.parent===t&&n.sub$(e,t)},setMass(t,e){t.m5.mass=e},genTexture:(t,e,r,s)=>p(t),bounceOff:t=>b(t.A,t.B,t),hit(t,e){const r=v(this,t,e);return r&&(i.emit(["hit",t],r),i.emit(["hit",e],r.swap())),r},collide(t,e,r=!0){const s=function(t,e,r,s=!0){let i,o=v(t,e,r);return o&&(r.m5.static?n.sub$(e,o.overlapV):(i=n.div(o.overlapV,2),n.sub$(e,i),n.add$(r,i)),s&&b(e,r,o)),o}(this,t,e,r);return s&&function(t){const e=new Set;return t.overlapN[1]<-.3&&e.add(i.TOP),t.overlapN[1]>.3&&e.add(i.BOTTOM),t.overlapN[0]<-.3&&e.add(i.LEFT),t.overlapN[0]>.3&&e.add(i.RIGHT),e.add(t),e}(s)},hitTest(t,e){return v(this,t,e)},clamp(t,r,s=!1,n){let o,h,u,c,d,p;l.vec(r)&&(u=r[1].left,c=r[1].right,d=r[1].top,p=r[1].bottom,r=r[0]),c=!1!==c,u=!1!==u,d=!1!==d,p=!1!==p,r instanceof i.Scenes.Scene?h=i.mockStage():r.m5&&r.m5.stage?h=r:void 0!==r.x2&&void 0!==r.y2?(h=r,o=!0):(r.isSprite?a.assert(t.parent===r):a.assert(!1,"Error: clamp() using bad container"),a.assert(a.feq0(r.rotation),"Error: clamp() container can't rotate"),a.assert(a.feq0(r.anchor.x),"Error: clamp() container anchor.x !==0"),a.assert(a.feq0(r.anchor.y),"Error: clamp() container anchor.y !==0"),h=r);let f=o?[0,0]:this.topLeftOffsetXY(h),g=new Set,m=!1,_=!1,x=this.getAABB(t),y=o?h.x1:h.x+f[0],b=y+(o?h.x2-h.x1:h.width),v=o?h.y1:h.y+f[1],T=v+(o?h.y2-h.y1:h.height);return u&&x.x1<y&&(t.x+=y-x.x1,m=!0,g.add(i.LEFT)),c&&x.x2>b&&(t.x-=x.x2-b,m=!0,g.add(i.RIGHT)),d&&x.y1<v&&(t.y+=v-x.y1,_=!0,g.add(i.TOP)),p&&x.y2>T&&(t.y-=x.y2-T,_=!0,g.add(i.BOTTOM)),g.size>0?(m&&(t.m5.vel[0]/=t.m5.mass,s&&(t.m5.vel[0]*=-1)),_&&(t.m5.vel[1]/=t.m5.mass,s&&(t.m5.vel[1]*=-1)),n&&n(g)):g=e,g},dbgShowDir(t){let e="?";switch(t){case i.NE:e="top-right";break;case i.NW:e="top-left";break;case i.TOP:case i.UP:e="top";break;case i.LEFT:e="left";break;case i.RIGHT:e="right";break;case i.BOTTOM:case i.DOWN:e="bottom";break;case i.SE:e="bottom-right";break;case i.SW:e="bottom-left"}return e},dbgShowCol(t){const e=[];if(l.set(t))for(let r of t.values())e.push(this.dbgShowDir(r));return e.join(",")}};return T.bmpText=T.bitmapText,a.doseq(s,((t,e)=>{T.SomeColors[e]=T.color(t)})),a.doseq(r,((t,e)=>{T.BtnColors[e]=T.color(t)})),i.Sprites=T}if("object"==typeof module&&module.exports)throw"Panic: browser only";t["io/czlab/mojoh5/Sprites"]=function(t){return t.Sprites?t.Sprites:i(t)}}(this),function(t,e){"use strict";function r(e,r){const s=t["io/czlab/mcfud/spatial"](),{v2:i,math:n,ute:o,is:a}=e,l=Math.floor,h=t=>t.startsWith("scene::")?t:`scene::${t}`;function u(t){t&&(t.dispose?.(),t.parent.removeChild(t))}class c extends PIXI.Container{constructor(t){super(),this.addChild(t),this.label=t.label,this.m5={stage:!0}}dispose(){u(this.children[0])}update(t){this.children[0].update(t)}}class d extends PIXI.Container{constructor(t,e,r){super(),this.label=h(t),this.g={},this.m5={index:{},queue:[],garbo:[],sid:t,options:r,stage:!0,sgrid:s.spatialGrid(r.sgridX||320,r.sgridY||320)},a.fun(e)?this.setup=e:a.obj(e)&&o.inject(this,e)}#r(t,r,s){let i,n,o,a=!1;for(o=0;!a&&o<s.length;++o)n=s[o],r!==n&&!n.m5.dead&&r.m5.cmask&n.m5.type&&(i=e.Sprites.hitTest(r,n))&&(e.emit(["hit",r],i),i.B.m5.static||e.emit(["hit",i.B],i.swap()),t.engrid(r),a=!0);return a}collideXY(t){return this.#r(this.m5.sgrid,t,this.m5.sgrid.search(t))}onCanvasResize(t,r){return e.Sprites.resize({x:0,y:0,width:t,height:r,children:this.children}),this}future(t,r){return this.m5.queue.push([t,n.ndiv(e._curFPS*r,1e3)||1]),this}futureX(t,e){return this.m5.queue.push([t,e||1]),this}getChildById(t){return t&&this.m5.index[t]}remove(t){return a.str(t)&&(t=this.getChildById(t)),t&&(this.removeChild(t),e.off(t),t.m5._engrid&&this.m5.sgrid.degrid(t),e.Input.undoXXX(t),o.dissoc(this.m5.index,t.m5.uuid)),this}degrid(t){return t&&t.m5._engrid&&this.m5.sgrid.degrid(t),t}engrid(t){return t&&t.m5._engrid&&this.m5.sgrid.engrid(t),t}insertEx(t,e=!1){let r;return o.assert(a.vec(t),"wanted array of child sprites to be inserted!"),t.forEach((t=>{this.insertAt(t,null,e),r=t})),r}insert(t,e=!1){return this.insertAt(t,null,e)}insertAt(t,e,r=!1){return t=this.#s(t,e),r&&(t instanceof PIXI.TilingSprite||(t.m5._engrid=!0,this.m5.sgrid.engrid(t))),t}#s(t,e){return a.num(e)&&e>=0&&e<this.children.length?this.addChildAt(t,e):this.addChild(t),this.m5.index[t.m5.uuid]=t}preDispose(){return this}dispose(){return this.preDispose(),this.m5.dead=!0,e.off(this),function t(r){r&&(e.Input.undoXXX(r),r.children.forEach((e=>t(e))))}(this),this.removeChildren(),e.modalScene===this&&(e.modalScene=void 0,e.Input.restore(),o.log("removed the current modal scene")),this}#i(t,r){t.forEach((t=>{t.visible&&t.m5&&t.m5.tick&&(t.m5.tick(r),"x"==t.m5.flip&&(t.scale.x*=-1),"y"==t.m5.flip&&(t.scale.y*=-1),t.m5.flip=!1,e.emit(["post.tick",t],r),t.m5._engrid&&this.m5.sgrid.engrid(t)),t.children.length>0&&this.#i(t.children,r)}))}searchSGrid(t,e=!1){return this.m5.sgrid.search(t,e)}queueForRemoval(t){return this.m5.garbo.push(t)&&t}update(t){return this.m5.dead||(this.m5.queue.filter((t=>(t[1]-=1,t[1]<=0))).reverse().forEach((t=>{o.disj(this.m5.queue,t),t[0]()})),this.preUpdate?.(t),this.#i(this.children,t),this.postUpdate?.(t),this.m5.garbo.forEach((t=>this.remove(t))),this.m5.garbo.length=0),this}runOnce(){return this.setup?.(this.m5.options),this}}function p(t,r,s){let{Sprites:i}=e,h=e.getScaleFactor();if(0==t.length)return;let u,c,d=(r=o.patch(r,{bg:0,padding:10,fit:20,borderWidth:4,border:i.SomeColors.white})).borderWidth*h,p=r.group||i.container(),f=r.padding*h,g=0,m=-1,_=r.fit*h,x=2*_,y=t=>{g+=t.height,t.width>m&&(m=t.width)},b=t=>{g+=t.width,t.height>m&&(m=t.height)};t.forEach((t=>{o.assert(o.feq0(t.anchor.x)&&o.feq0(t.anchor.y),"wanted topleft anchor"),(s==e.DOWN?y:b)(t),r.skipAdd||p.addChild(t)})),m+=x,g+=f*(t.length-1)+x,s==e.DOWN?(u=m,c=g):(c=m,u=g);{let t=i.rect(u,c,r.bg,r.border,d);p.addChildAt(t,0),a.vec(r.bg)||(t.alpha=0==r.opacity?0:r.opacity||.5,"transparent"==r.bg&&(t.alpha=0))}let v,[T,S]=[l(u/2),l(c/2)],w=s==e.DOWN?"pinBelow":"pinRight";return t.forEach(((t,r)=>{s==e.DOWN?0==r&&(t.x=T-t.width/2,t.y=_):0==r&&(t.y=S-t.height/2,t.x=_),v&&e.Sprites[w](v,t,f),v=t})),p.x=r.x??n.ndiv(e.width-u,2),p.y=r.y??n.ndiv(e.height-c,2),p}function f(t,r,s){let i,n,{Sprites:o,Input:a}=e,l=o.color(r.selectedColor??"green"),h=o.color(r.disabledColor??"grey");return t.forEach((t=>{t.m5.uuid==r.defaultChoice?(n=t,t.tint=l):t.tint=h,t.m5.button&&(t.m5.press=t=>{t!==n&&(n.tint=h,t.tint=l,n=t,r.onClick?.(t))})})),n||(n=t[0],n.tint=l),i=p(t,r,s),i.getSelectedChoice=()=>n.m5.uuid,i}const g={Scene:d,SceneWrapper:c,layoutX:(t,r)=>p(t,r,e.RIGHT),layoutY:(t,r)=>p(t,r,e.DOWN),choiceMenuX:(t,r)=>f(t,r,e.RIGHT),choiceMenuY:(t,r)=>f(t,r,e.DOWN),scene(t,e,s){a.fun(e)&&(e={setup:e}),r[t]=[e,s]},replace(t,r,s){const i=h(a.str(t)?t:t.label),n=e.stage.getChildByName(i);if(!n)throw`Fatal: no such scene: ${i}`;return this.run(r,e.stage.getChildIndex(n),s)},remove(...t){1==t.length&&a.vec(t[0])&&(t=t[0]),t.forEach((t=>u(a.str(t)?e.stage.getChildByName(h(t)):t)))},removeAll(){for(;e.stage.children.length>0;)u(e.stage.children[e.stage.children.length-1]);e.mouse.reset(),e.Input.reset()},find:t=>e.stage.getChildByName(h(t)),runEx(t,e,r){return this.removeAll(),this.run(t,e,r)},runSeq(...t){t.forEach((t=>{o.assert(a.vec(t),"Expecting array"),this.run(t[0],t[1],t[2])}))},modal(t,r){return o.assert(!e.modalScene,"Another modal is already running!"),e.Input.save(),e.modalScene=this.run(t,null,r)},run(t,s,i){let n,l,h,p=r[t];if(e.modalScene)throw"Fatal: modal scene is running";if(!p)throw`Fatal: unknown scene: ${t}`;if(a.obj(s)&&(i=s,s=o.dissoc(i,"slot")),i=o.inject({},p[1],i),h=o.inject({},p[0]),o.nichts(s)&&(s=i.slot||-1),i.tiled?(o.assert(i.tiled.name,"no tmx file!"),l=new e.Tiles.TiledScene(t,h,i)):l=new d(t,h,i),n=l,i.centerStage&&(n=new c(l)),s>=0&&s<e.stage.children.length){let t=e.stage.getChildAt(s);e.stage.addChildAt(n,s),u(t)}else e.stage.addChild(n);return l.runOnce(),l},topMost(){let t=o.last(e.stage.children);return t instanceof c&&(t=t.children[0]),o.assert(t instanceof d,"top is not a scene!"),t}};return e.Scenes=g}if("object"==typeof module&&module.exports)throw"Panic: browser only";t["io/czlab/mojoh5/Scenes"]=function(t){return t.Scenes?t.Scenes:r(t,{})}}(this),function(t,e){"use strict";if("object"==typeof module&&module.exports)throw"Panic: browser only";t["io/czlab/mojoh5/FX"]=function(t){return t.FX?t.FX:function(t,r,s){const i=Math.floor,n=5*Math.PI,o=Math.PI/2,a=2*Math.PI,{v2:l,math:h,ute:u,is:c}=t;function d(e,s,i=60,n=!1,o={}){return u.inject({duration:i,sprite:e,easing:s,loop:n,cur:0,on:0,dead:0,onFrame(t,e){},_run(){this.cur=0,this.on=1,this.dead=0,r.push(this)},onTick(){this.on&&(this.cur<this.duration?(this.onFrame(!1,this.easing(this.cur/this.duration)),this.cur+=1):(this.onFrame(!0),this.loop?(c.num(this.loop)&&--this.loop,this.onLoopReset(),this.cur=0):(this.on=0,this.dispose(),this.onComplete&&u.delay(0,(()=>this.onComplete())))))},dispose(){this.dead=1,t.emit(["tween.disposed"],this)}},o)}function p(t,r,s,i){return d(t,r,s,i,{start(t,r,s,i){this._x=c.num(r)?[t,r]:e,this._y=c.num(i)?[s,i]:e,this._run()},onLoopReset(){this._x&&u.swap(this._x,0,1),this._y&&u.swap(this._y,0,1)},onFrame(t,e){this._x&&(this.sprite.x=t?this._x[1]:h.lerp(this._x[0],this._x[1],e)),this._y&&(this.sprite.y=t?this._y[1]:h.lerp(this._y[0],this._y[1],e))}})}function f(...e){const r=e.slice(0),s={onTweenEnd(t){for(let e,s=0;s<r.length;++s)if(e=r[s],e===t){r.splice(s,1);break}0==r.length&&(this.dispose(),this.onComplete&&u.delay(0,(()=>this.onComplete())))},dispose(){t.off(["tween.disposed"],"onTweenEnd",s),r.length=0}};return t.on(["tween.disposed"],"onTweenEnd",s),s}const g={EXPO_IN:t=>0==t?0:Math.pow(1024,t-1),EXPO_OUT:t=>1==t?1:1-Math.pow(2,-10*t),EXPO_INOUT:t=>0==t?0:1==t?1:(t*=2)<1?.5*Math.pow(1024,t-1):.5*(2-Math.pow(2,-10*(t-1))),LINEAR:t=>t,SMOOTH:t=>3*t*t-2*t*t*t,SMOOTH_QUAD(t){let e=g.SMOOTH(t);return e*e},SMOOTH_CUBIC(t){let e=g.SMOOTH(t);return e*e*e},EASE_IN_CUBIC:t=>t*t*t,EASE_OUT_CUBIC(t){let e=1-t;return 1-e*e*e},EASE_INOUT_CUBIC(t){if(t<.5)return 4*t*t*t;{let e=-2*t+2;return 1-e*e*e/2}},EASE_IN_QUAD:t=>t*t,EASE_OUT_QUAD:t=>1-(1-t)*(1-t),EASE_INOUT_QUAD(t){if(t<.5)return 2*t*t;{let e=-2*t+2;return 1-e*e/2}},EASE_IN_SINE:t=>1-Math.cos(t*o),EASE_OUT_SINE:t=>Math.sin(t*o),EASE_INOUT_SINE:t=>.5-Math.cos(t*Math.PI)/2,SPLINE(t,e,r,s,i){let n=t*t,o=n*t;return.5*(e*(2*n-o-t)+r*(3*o-5*n+2)+s*(-3*o+4*n+t)+i*(o-n))},CUBIC_BEZIER(t,e,r,s,i){let n=t*t,o=1-t,a=o*o;return a*o*e+3*a*t*r+3*o*n*s+n*t*i},ELASTIC_IN:t=>0==t?0:1==t?1:-Math.pow(2,10*(t-1))*Math.sin((t-1.1)*n),ELASTIC_OUT:t=>0==t?0:1==t?1:1+Math.pow(2,-10*t)*Math.sin((t-.1)*n),ELASTIC_INOUT(t){switch(t){case 0:return 0;case 1:return 1;default:return(t*=2)<1?-.5*Math.pow(2,10*(t-1))*Math.sin((t-1.1)*n):1+.5*Math.pow(2,-10*(t-1))*Math.sin((t-1.1)*n)}},BOUNCE_IN:t=>1-g.BOUNCE_OUT(1-t),BOUNCE_OUT:t=>t<1/2.75?7.5625*t*t:t<2/2.75?7.5625*(t-=1.5/2.75)*t+.75:t<2.5/2.75?7.5625*(t-=2.25/2.75)*t+.9375:7.5625*(t-=2.625/2.75)*t+.984375,BOUNCE_INOUT:t=>t<.5?.5*g.BOUNCE_IN(2*t):.5*g.BOUNCE_OUT(2*t-1)+.5,tweenAlpha(t,e,r,s=60,i=!1){const n=function(t,e,r,s){return d(t,e,r,s,{start(t,e){this._a=[t,e],this._run()},onLoopReset(){u.swap(this._a,0,1)},onFrame(t,e){this.sprite.alpha=t?this._a[1]:h.lerp(this._a[0],this._a[1],e)}})}(t,e,s,i);let o=t.alpha,a=r;return c.vec(r)&&(o=r[0],a=r[1]),n.start(o,a),n},tweenAngle(t,e,r,s=60,i=!1){const n=function(t,e,r,s){return d(t,e,r,s,{start(t,e){this._a=[t,e],this._run()},onLoopReset(){u.swap(this._a,0,1)},onFrame(t,e){this.sprite.rotation=t?this._a[1]:h.lerp(this._a[0],this._a[1],e)}})}(t,e,s,i);let o=t.rotation,a=r;return c.vec(r)&&(o=r[0],a=r[1]),n.start(o,a),n},tweenScale(t,r,s,i,n=60,o=!1){const a=function(t,r,s,i){return d(t,r,s,i,{start(t,r,s,i){this._x=c.num(r)?[t,r]:e,this._y=c.num(i)?[s,i]:e,this._run()},onLoopReset(){this._x&&u.swap(this._x,0,1),this._y&&u.swap(this._y,0,1)},onFrame(t,e){this._x&&(this.sprite.scale.x=t?this._x[1]:h.lerp(this._x[0],this._x[1],e)),this._y&&(this.sprite.scale.y=t?this._y[1]:h.lerp(this._y[0],this._y[1],e))}})}(t,r,n,o);let l=t.scale.x,p=t.scale.y,f=s,g=i;return c.vec(s)&&(l=s[0],f=s[1]),c.vec(i)&&(p=i[0],g=i[1]),c.num(f)||(l=f=e),c.num(g)||(p=g=e),a.start(l,f,p,g),a},tweenXY(t,r,s,i,n=60,o=!1){const a=p(t,r,n,o);let l=t.x,h=t.y,u=s,d=i;return c.vec(s)&&(l=s[0],u=s[1]),c.vec(i)&&(h=i[0],d=i[1]),c.num(u)||(l=u=e),c.num(d)||(h=d=e),a.start(l,u,h,d),a},fadeOut(t,e=60){return this.tweenAlpha(t,this.EASE_OUT_SINE,0,e)},fadeIn(t,e=60){return this.tweenAlpha(t,this.EASE_OUT_SINE,1,e)},pulse(t,e=0,r=60,s=!0){return this.tweenAlpha(t,this.SMOOTH,e,r,s)},slide(t,e,r,s,i=60){return this.tweenXY(t,e,r,s,i)},throb(t,e=.9,r=.9,s=60,i=!0){return this.tweenScale(t,this.SMOOTH_QUAD,e,r,s,i)},scale(t,e=.5,r=.5,s=60){return this.tweenScale(t,this.SMOOTH,e,r,s)},strobe(t,e=1.3,r=10,s=20,i=10,n=!0){return this.tweenScale(t,(t=>this.SPLINE(t,r,0,1,s)),e,e,i,n)},jiggle(t,r,s=1.4,i=1.2,n=10,o=!0){let{x1:a,x2:l,y1:h,y2:c}=r;return f(this.tweenScale(t,(t=>this.SPLINE(t,u.or(a,10),0,1,u.or(l,10))),s,e,n,o),this.tweenScale(t,(t=>this.SPLINE(t,u.or(h,-10),0,1,u.or(c,-10))),e,i,n,o))},bezier(t,e,r,s,i=60){let n=p(t,this.SMOOTH,i);return n.start=function(){this._run()},n.onFrame=function(i,n){i||l.set(t,g.CUBIC_BEZIER(n,t.x,e[0],r[0],s[0]),g.CUBIC_BEZIER(n,t.y,e[1],r[1],s[1]))},n.start(),n},remove(t){t?.dispose()},update(t){u.rseq(r,(e=>e.onTick(t))),u.rseq(s,(e=>e.onTick(t)));for(let t=r.length-1;t>=0;--t)r[t].dead&&r.splice(t,1);for(let t=s.length-1;t>=0;--t)s[t].m5.dead&&_S.remove(s[t])&&s.splice(t,1)},particles(t,e,r,i,n=24,o={},a={},h=[0,.3],c=!0){function d(n){let c,d=i(),p=u.randInt2(o.size,a.size);s.push(d),t.addChild(d),d.totalFrames&&d.gotoAndStop(u.randInt2(0,d.totalFrames-1)),_S.sizeXY(_S.centerAnchor(d),p,p),l.set(d,e,r),d.g.scaleSpeed=u.randFloat2(o.scale,a.scale),d.g.alphaSpeed=u.randFloat2(o.alpha,a.alpha),d.g.angVel=u.randFloat2(o.rotate,a.rotate),c=u.randFloat2(o.speed,a.speed),l.set(d.m5.vel,c*Math.cos(n),c*Math.sin(n)),d.onTick=function(){this.m5.dead||(l.add$(this.m5.vel,h),l.add$(this,this.m5.vel),this.scale.x-this.g.scaleSpeed>0&&(this.scale.x-=this.g.scaleSpeed),this.scale.y-this.g.scaleSpeed>0&&(this.scale.y-=this.g.scaleSpeed),this.rotation+=this.m5.angVel,this.alpha-=this.g.alphaSpeed,this.alpha<=0&&(this.m5.dead=!0))}}o=u.patch(o,{angle:0,size:4,speed:.3,scale:.01,alpha:.02,rotate:.01});for(let t=((a=u.patch(a,{angle:6.28,size:16,speed:3,scale:.05,alpha:.02,rotate:.03})).angle-o.angle)/(n-1),e=o.angle,r=0;r<n;++r)d(c?u.randFloat2(o.angle,a.angle):e),e+=t},shake(t,e=16,r=!1,n=!0){let o={},a=1,l=t.x,h=t.y,c=1,d=t.rotation,p=e,f=i(e/8);return o.onTick=()=>r?void(a<8?(t.rotation=d,e-=f,t.rotation=e*c,++a,c*=-1):n?(e=p,a=1):u.disj(s,o)):void(a<8?(t.x=l,t.y=h,e-=f,t.x+=u.randInt2(-e,e),t.y+=u.randInt2(-e,e),++a):n?(e=p,a=1):u.disj(s,o)),s.push(o)&&t},StarWarp:function(e,r){r=r||{};let{Sprites:s}=t,i=2e3,n=0,l=0,h=0,c=u.now(),d=r.color??"yellow",p=r.items??1e3,f=t.resource("boot/star.png");const g=u.fill(p,(t=>((t=s.sprite(f)).g.d3=[0,0,0],u.rand()<.3&&(t.tint=s.color(d)),s.anchorXY(t,.5,.69),e.addChild(t),m(t,u.rand()*i))));function m(t,e){let r=u.rand()*a,s=50*u.rand()+1;return t.g.d3[0]=Math.cos(r)*s,t.g.d3[1]=Math.sin(r)*s,t.g.d3[2]=isNaN(e)?n+i*(1+.5*u.rand()):e,t}return{dispose(){g.forEach((t=>s.remove(t)))},update(e){let r,a,d=t.width/2,p=t.height/2;l+=(h-l)/20,n+=10*e*(l+.025),g.forEach(((e,r)=>{e.g.d3[2]<n&&m(e),r=20*t.width/a,a=e.g.d3[2]-n,e.x=e.g.d3[0]*r+d,e.y=e.g.d3[1]*r+p;let h=e.x-d,u=e.y-p,c=Math.sqrt(h*h+u*u),f=Math.max(0,1-a/i);e.rotation=Math.atan2(u,h)+o,s.scaleXY(e,.05*f,f*(.05+6*l*c/t.width))})),r=u.now(),r-c>5e3&&(c=r,h=h>0?0:1)}}},SeqTweens:function(...t){let e=[];t.forEach((t=>{e.push(t),u.disj(r,t)}));const s={onDone(){this.dispose(),this.onComplete&&u.delay(0,(()=>this.onComplete()))},dispose(){e.length=0}};return function t(i){i?(r.push(i),i.onComplete=()=>t(e.shift())):s.onDone()}(e.shift()),s},BatchTweens:f};return t.FX=g}(t,[],[])}}(this),function(t,e){"use strict";function r(r){const s=t["io/czlab/mcfud/geo2d"](),{v2:i,math:n,is:o,ute:a}=r,l=Math.abs,h=Math.cos,u=Math.sin,c=Math.floor,d=Math.PI/180;Math.PI,r.Scenes.scene("Splash",{setup(t){let e,s,n,o=r.getScaleFactor(),{title:l,titleFont:h,titleColor:u,titleSize:c}=t,{footerMsgSize:d,action:p,clickSnd:f}=t,{bg:g,playMsg:m,playMsgFont:_,playMsgColor:x,playMsgSize:y,playMsgColor2:b}=t;_=_||r.DOKI_LOWER,h=h||r.BIGSHOUTBOB,d=(d||18)*o,m=m||r.clickPlayMsg(),x=x??r.Sprites.color("white"),b=b??r.Sprites.color("#ffc901"),u=u??r.Sprites.color("#ffc901"),c=(c||96)*o,y=(y||48)*o,this.insert(r.Sprites.fillMax(g||"boot/splash.jpg")),e=this.insert(r.Sprites.container()),n=r.Sprites.bmpText(l,h,c),a.echt(u)&&r.Sprites.tint(n,u),i.set(n,r.width/2,.45*r.height),e.addChild(r.Sprites.centerAnchor(n));{s=r.Sprites.bmpText(m,_,y);let t,i=r.FX.throb(s,.747,.747);const o=()=>{r.Sprites.tint(s,b),r.FX.remove(i),t=r.FX.tweenAlpha(e,r.FX.EASE_OUT_SINE,0,90),t.onComplete=()=>r.Scenes.runEx(p.name,p.cfg)};let a=r.Sprites.oneOffClick(o,f);r.Sprites.centerAnchor(s),r.Sprites.pinBelow(n,s),e.addChild(s),r.touchDevice||(this.g.space=r.Input.keybd(r.Input.SPACE,(()=>{r.Sprites.cancelOneOffClick(a),o(),r.sound(f).play()})))}{const t=r.Sprites.bmpText("Powered by MojoH5 2d game engine.",r.UNSCII,d),e=r.Sprites.bmpText(r.COPYRIGHT,r.UNSCII,d);r.Sprites.pinBelow(this,e,1.5*-e.height,0),r.Sprites.pinBelow(this,t,1.5*-t.height,1),this.insert(e),this.insert(t)}},preDispose(){this.g.space?.dispose()}}),r.Scenes.scene("EndGame",{setup(t){let{winner:e,snd:s}=t,{fontName:i,fontSize:n,msg:o,replay:a,quit:l}=t;s||(s=e?"game_win.mp3":"game_over.mp3"),n=(n||32)*r.getScaleFactor(),i=i||r.DOKI_LOWER;let h={fontName:i,fontSize:n},u=()=>r.Sprites.opacity(r.Sprites.bmpText("#",h),0),c=r.Sprites.bmpText("Game Over",h),d=r.Sprites.bmpText(o,h),p=r.Input.mkBtn(r.Sprites.bmpText("Play Again?",h)),f=r.Sprites.bmpText(" or ",h),g=r.Input.mkBtn(r.Sprites.bmpText("Quit",h));p.m5.press=()=>r.Scenes.runEx(a.name,a.cfg),g.m5.press=()=>r.Scenes.runEx(l.name,l.cfg),r.sound(s).play(),this.insert(r.Scenes.layoutY([c,d,u(),u(),u(),p,f,g],t))}}),r.Scenes.scene("PhotoMat",{setup(t){let s=t.image?r.resource(t.image):e;this.g.gfx=r.Sprites.graphics(),r.Sprites.grect(this.g.gfx,0,0,r.width,t.y1),r.Sprites.grect(this.g.gfx,0,t.y2,r.width,r.height-t.y2),r.Sprites.grect(this.g.gfx,0,0,t.x1,r.height),r.Sprites.grect(this.g.gfx,t.x2,0,r.width-t.x2,r.height),s?r.Sprites.gfillEx(this.g.gfx,s,{}):r.Sprites.gfill(this.g.gfx,{color:r.Sprites.color(t.color)}),this.insert(this.g.gfx)}}),r.Scenes.scene("HotKeys",{setup(t){let e,s,i=r.getScaleFactor(),n=t.buttons?"makeButton":"makeHotspot",{fontName:l,fontSize:h,cb:u,radius:c,alpha:d,color:p}=t,{char_fire:f,char_down:g,char_up:m,char_left:_,char_right:x}=t;a.assert(o.fun(u),"expected callback"),l=l||r.DOKI_LOWER,h=(h||24)*i,c=(c||36)*i,d=d??.3,p=p??"grey",t.fontName=l,t.fontSize=h,t.radius=c,t.alpha=d,t.color=p,e=[["left",_||"<"],["right",x||">"],["up",m||"+"],["down",g||"-"],["fire",f||"^"]].reduce(((e,s,i)=>(("fire"!=s[0]||t.fire)&&(e[s[0]]=r.Sprites.opacity(r.Sprites.circle(c,p),d),e[s[0]].addChild(r.Sprites.centerAnchor(r.Sprites.bmpText(s[1],l,h)))),e)),{}),s=u(e),s.right&&(this.insert(r.Input[n](s.right)),s.right.m5.hotspot&&(s.right.m5.touch=(t,e)=>e?r.Input.setKeyOn(r.Input.RIGHT):r.Input.setKeyOff(r.Input.RIGHT))),s.left&&(this.insert(r.Input[n](s.left)),s.left.m5.hotspot&&(s.left.m5.touch=(t,e)=>e?r.Input.setKeyOn(r.Input.LEFT):r.Input.setKeyOff(r.Input.LEFT))),s.up&&(this.insert(r.Input[n](s.up)),s.up.m5.hotspot&&(s.up.m5.touch=(t,e)=>e?r.Input.setKeyOn(r.Input.UP):r.Input.setKeyOff(r.Input.UP))),s.down&&(this.insert(r.Input[n](s.down)),s.down.m5.hotspot&&(s.down.m5.touch=(t,e)=>e?r.Input.setKeyOn(r.Input.DOWN):r.Input.setKeyOff(r.Input.DOWN))),s.fire&&(this.insert(r.Input[n](s.fire)),s.fire.m5.hotspot&&(s.fire.m5.touch=(t,e)=>e?r.Input.setKeyOn(r.Input.SPACE):r.Input.setKeyOff(r.Input.SPACE))),t.extra?.(this,t)}}),r.Scenes.scene("AudioIcon",{setup(t){let{cb:e,iconOn:s,iconOff:n}=t,{xOffset:o,yOffset:a,xScale:l,yScale:h}=t,{Sound:u}=r,c=r.getScaleFactor(),d=r.Input.mkBtn(r.Sprites.spriteFrom(s||"boot/audioOn.png",n||"boot/audioOff.png"));l=l??c,h=h??c,a=a??0,o=o??-10*c,r.Sprites.scaleXY(r.Sprites.opacity(d,.343),l,h),i.set(d,r.width-d.width+o,0+a),d.m5.showFrame(u.sfx()?0:1),d.m5.press=()=>{u.sfx()?(u.mute(),d.m5.showFrame(1)):(u.unmute(),d.m5.showFrame(0))},this.insert(d)}}),r.Scenes.scene("StarfieldBg",{setup(t){const e=[],s=r.Sprites.graphics();a.patch(t,{height:r.height,width:r.width,count:100,minVel:15,maxVel:30}),a.inject(this.g,{gfx:s,stars:e,lag:0,dynamic:!0,fps:1/t.fps,draw(){return r.Sprites.gclear(s),e.forEach((t=>{r.Sprites.grect(s,t.x,t.y,t.size,t.size),r.Sprites.gfill(s,{color:a.rand()<.3?r.Sprites.SomeColors.yellow:r.Sprites.SomeColors.white})})),this},moveStars(r){this.lag+=r,this.lag>=this.fps&&(this.lag=0,e.forEach((e=>{e.y+=r*e.vel,e.y>t.height&&(i.set(e,a.randInt(t.width),0),e.size=a.randInt(4),e.vel=a.rand()*(t.maxVel-t.minVel)+t.minVel)})),this.draw())}}),t.static&&(this.g.dynamic=!1);for(let r=0;r<t.count;++r)e[r]={x:a.rand()*t.width,y:a.rand()*t.height,size:3*a.rand()+1,vel:a.rand()*(t.maxVel-t.minVel)+t.minVel};this.g.draw()&&this.insert(s)},postUpdate(t){this.g.dynamic&&this.g.moveStars(t)}},{fps:90,count:100,minVel:15,maxVel:30});const p={Periodic:class{#n;#o;#a;#l;#h;constructor(t,e,r=16){this.#n=e,this.#o=t,this.#a=0,this.#l=r,this.#h=a.fill(r,t)}lifeCycle(t){this.#a+=t,this.#a>this.#n&&(this.#a=0,this.discharge())}discharge(){throw"Periodic: please implement action()"}reclaim(t){this.#h.length<this.#l&&this.#h.push(t)}take(){return this.#h.length>0?this.#h.pop():this.#o()}},Meander:function(t){function s(t,e,s,i){e.impact=l(s),r.emit([i,t],e)}const n=[],o={dispose(){r.off(o)},boom(o){if(a.assert(o.A===t,"got hit by someone else???"),o.B&&o.B.m5.sensor)r.emit(["bump.sensor",o.B],o.A);else{let[n,a]=t.m5.vel;o.impact=e,i.sub$(t,o.overlapV),o.overlapN[1]<-.3?(a<0&&!t.m5.skipHit&&i.setY(t.m5.vel,0),s(t,o,a,"bump.top")):o.overlapN[1]>.3&&(a>0&&!t.m5.skipHit&&i.setY(t.m5.vel,0),s(t,o,a,"bump.bottom")),o.overlapN[0]<-.3?(n<0&&!t.m5.skipHit&&i.setX(t.m5.vel,0),s(t,o,n,"bump.left")):o.overlapN[0]>.3&&(n>0&&!t.m5.skipHit&&i.setX(t.m5.vel,0),s(t,o,n,"bump.right")),o.impact===e?o.impact=0:r.emit(["bump.*",t],o)}n.push(o)}};return r.on(["hit",t],"boom",o),r.on(["post.remove",t],"dispose",o),function(s){return n.length=0,r.Sprites.move(t,s)&&t.parent.collideXY(t),n.length>0?n[0]:e}},Camera:function(t,e,s,i){const n=i?.height??s,l=i?.width??e,h=c(n/2),u=c(l/2),d=c(n/4),p=c(l/4);let f=0,g=0,m={dispose(){r.off(m)},set x(e){f=e,t.x=-f},set y(e){g=e,t.y=-g},get x(){return f},get y(){return g},worldHeight:s,worldWidth:e,width:l,height:n,follow(t){const i=a.feq0(t.angle)?r.Sprites.getAABB(t):r.Sprites.boundingBox(t);i.x1<this.x+c(u-p)&&(this.x=i.x1-p),i.x2>this.x+c(u+p)&&(this.x=i.x2-3*p),i.y1<this.y+c(h-d)&&(this.y=i.y1-d),i.y2>this.y+c(h+d)&&(this.y=i.y2-3*d),this.x<0&&(this.x=0),this.y<0&&(this.y=0),this.x+l>e&&(this.x=e-l),this.y+n>s&&(this.y=s-n);let{x1:o,x2:f,y1:g,y2:m}=t.m5.getImageOffsets(),_=i.x2-f;return _>e&&(t.x-=_-e),_=i.y2-m,_>s&&(t.y-=_-s),_=i.x1+o,_<0&&(t.x+=-_),_=i.y1+g,_<0&&(t.y+=-_),t},centerOver:function(t,e){if(1!=arguments.length||o.num(t))o.num(t)&&(this.x=t-u),o.num(e)&&(this.y=e-h);else{const e=r.Sprites.centerXY(t);this.x=e[0]-u,this.y=e[1]-h}return t}};return r.on(["post.remove",t],"dispose",m),m},Patrol:function(t,e,s){const n={dispose(){r.off(n)},goLeft(e){t.m5.heading=r.LEFT,t.m5.flip="x",i.setX(t.m5.vel,-e.impact)},goRight(e){t.m5.heading=r.RIGHT,t.m5.flip="x",i.setX(t.m5.vel,e.impact)},goUp(e){i.setY(t.m5.vel,-e.impact),t.m5.heading=r.UP,t.m5.flip="y"},goDown(e){i.setY(t.m5.vel,e.impact),t.m5.heading=r.DOWN,t.m5.flip="y"}};return e&&(r.on(["bump.right",t],"goLeft",n),r.on(["bump.left",t],"goRight",n)),s&&(r.on(["bump.top",t],"goDown",n),r.on(["bump.bottom",t],"goUp",n)),r.on(["post.remove",t],"dispose",n),n},Jitter:function(t,s,n){s=s??-300,n=n??r.Input.UP;let o=0,a=0,l=s/3;const h={onGround(){a=.06666666666666667},dispose(){r.off(h)}};return r.on(["bump.bottom",t],"onGround",h),function(h,u){if(!t.m5.skipHit){let c=t.m5.speed,d=r.Input.keyDown(r.Input.RIGHT),p=r.Input.keyDown(r.Input.LEFT),f=r.Input.keyDown(n);u&&(p||d||a>0)&&(u.overlapN[1]>.85||u.overlapN[1]<-.85)&&(u=e),p&&!d?(t.m5.heading=r.LEFT,u&&a>0?i.set(t.m5.vel,c*u.overlapN[1],-c*u.overlapN[0]):i.setX(t.m5.vel,-c)):d&&!p?(t.m5.heading=r.RIGHT,u&&a>0?i.set(t.m5.vel,-c*u.overlapN[1],c*u.overlapN[0]):i.setX(t.m5.vel,c)):i.setX(t.m5.vel,0),a>0&&0==o&&f?(i.setY(t.m5.vel,s),o+=1,a=-h):f&&o<2&&(o+=1,r.emit(["jump",t])),o&&!f&&(o=0,r.emit(["jumped",t]),t.m5.vel[1]<l&&(t.m5.vel[1]=l)),a>0&&(t.m5.vel[1]=0)}a-=h}},MazeRunner:function(t,e){return function(s,n){let[l,h]=t.m5.vel,u=t.m5.speed,c=!a.feq0(l),d=!a.feq0(h);c&&d||!e||(d&&(o.obj(e)?t.m5.showFrame(e[h>0?r.DOWN:r.UP]):e&&(t.angle=h>0?180:0)),c&&(o.obj(e)?t.m5.showFrame(e[l>0?r.RIGHT:r.LEFT]):e&&(t.angle=l>0?90:-90)));let p=r.u.touchOnly,f=p?t.m5.heading==r.RIGHT:r.Input.keyDown(r.Input.RIGHT)&&r.RIGHT,g=p?t.m5.heading==r.LEFT:r.Input.keyDown(r.Input.LEFT)&&r.LEFT,m=p?t.m5.heading==r.UP:r.Input.keyDown(r.Input.UP)&&r.UP,_=p?t.m5.heading==r.DOWN:r.Input.keyDown(r.Input.DOWN)&&r.DOWN;(g||m)&&(u*=-1),g&&f?i.setX(t.m5.vel,0):(g||f)&&(t.m5.heading=g||f,i.setX(t.m5.vel,u)),m&&_?i.setY(t.m5.vel,0):(m||_)&&(t.m5.heading=m||_,i.setY(t.m5.vel,u))}},seek(t,e){const r=i.unit$(i.sub(e,t));return r&&(i.mul$(r,t.m5.maxSpeed),i.sub$(r,t.m5.vel),i.add$(t.m5.steer,r)),t},flee(t,e,r){let s=i.sub(t,e),n=i.len2(s);return void 0===r&&(r=t.m5.steerInfo.tooCloseDistance),n>r*r||(i.unit$(s)||(s=[.1,.1]),i.mul$(s,t.m5.maxSpeed),i.sub$(s,t.m5.vel),i.add$(t.m5.steer,s)),t},arrive(t,e,r){let s=1,n=i.dist(t,e),o=i.unit$(i.sub(e,t));return void 0===r&&(r=t.m5.steerInfo.arrivalThreshold),n>r||(s=n/r),i.mul$(o,t.m5.maxSpeed*s),i.sub$(o,t.m5.vel),i.add$(t.m5.steer,o),t},pursue(t,e){return this.seek(t,i.add(e,i.mul(e.m5.vel,i.dist(t,e)/t.m5.maxSpeed)))},evade(t,e){return this.flee(t,i.sub(e,i.mul(e.m5.vel,i.dist(t,e)/t.m5.maxSpeed)))},idle:t=>(i.mul$(t.m5.vel,0),i.mul$(t.m5.steer,0),t),wander(t){let e=i.mul$([1,1],t.m5.steerInfo.wanderRadius),r=i.len(e),s=i.mul$(i.unit(t.m5.vel),t.m5.steerInfo.wanderDistance);return e[0]=Math.cos(t.m5.steerInfo.wanderAngle)*r,e[1]=Math.sin(t.m5.steerInfo.wanderAngle)*r,t.m5.steerInfo.wanderAngle+=a.rand()*t.m5.steerInfo.wanderRange-.5*t.m5.steerInfo.wanderRange,i.add$(t.m5.steer,i.add$(s,e)),t},interpose(t,e,r){let s=i.div$(i.add(e,r),2),n=i.dist(t,s)/t.m5.maxSpeed,o=i.add(e,i.mul(e.m5.vel,n)),a=i.add(r,i.mul(r.m5.vel,n));return this.seek(t,i.div$(i.add$(o,a),2))},separation(t,e,r=300,s=100){let n=[0,0],o=0;return e.forEach((e=>{e!==t&&i.dist(e,t)<r&&(i.add$(n,i.sub(e,t)),++o)})),o>0&&i.flip$(i.div$(n,o)),i.add$(t.m5.steer,i.mul$(i.unit$(n),s)),t},followLeader(t,e,r,s=400,n=300,o=100,a=1600,l=200){let h,u=i.mul$(i.unit(e.m5.vel),s),c=i.add(e,u);return i.flip$(u),h=i.add(e,u),function(t,e,r,s){return i.dist(r,t)<s||i.dist(e,t)<s}(t,e,c,a)&&this.evade(t,e),this.arrive(t,h,l),this.separation(t,r,n,o)},queue(t,e,r=500,s=500){let n=function(){let n,o=i.mul$(i.unit(t.m5.vel),r),a=i.add(t,o);for(let r=0;r<e.length;++r)if(e[r]!==t&&i.dist(a,e[r])<s){n=e[r];break}return n}(),o=[0,0],a=i.mul(t.m5.vel,1);return n&&(o=i.mul$(i.flip(t.m5.steer),.8),i.unit$(i.flip$(a)),i.add$(o,a),i.dist(t,n)<s&&i.mul$(t.m5.vel,.3)),i.add$(t.m5.steer,o),t},flock(t,e){let r=0,s=[0,0],n=i.mul(t.m5.vel,1);return e.forEach((e=>{e!==this&&function(e){return!(i.dist(t,e)>t.m5.steerInfo.inSightDistance||i.dot(i.sub(e,t),i.unit(t.m5.vel))<0)}(e)&&(i.add$(n,e.m5.vel),i.add$(s,e),i.dist(t,e)<t.m5.steerInfo.tooCloseDistance&&this.flee(t,e),++r)})),r>0&&(i.div$(n,r),i.div$(s,r),this.seek(t,s),i.add$(t.m5.steer,i.sub$(n,t.m5.vel))),t},followPath(t,e,r,s=1){let n=e[t.m5.pathIndex];if(n)return i.dist(t,n)<s&&(t.m5.pathIndex>=e.length-1?r&&(t.m5.pathIndex=0):t.m5.pathIndex+=1),t.m5.pathIndex>=e.length-1&&!r?this.arrive(t,n):this.seek(t,n),t},avoid(t,e){let r,s=null,n=i.len(t.m5.vel)/t.m5.maxSpeed,o=i.add(t,i.mul$(i.unit(t.m5.vel),n)),a=i.add(t,i.mul$(i.unit(t.m5.vel),.5*t.m5.steerInfo.avoidDistance));for(let r,n=0;n<e.length;++n)e[n]!==this&&(r=i.dist(e[n],o)<=e[n].m5.radius||i.dist(e[n],a)<=e[n].m5.radius,r&&(null===s||i.dist(t,e[n])<i.dist(t,s))&&(s=e[n]));return s&&(r=i.mul$(i.unit$(i.sub(o,s)),100),i.add$(t.m5.steer,r)),t},lineOfSight(t,e,i){let n=r.Sprites.centerXY(t),o=r.Sprites.centerXY(e);for(let t,e,a=0;a<i.length;++a)if(e=i[a],t=e.m5.circle?s.hitTestLineCircle(n,o,e.x,e.y,e.width/2):s.hitTestLinePolygon(n,o,s.bodyWrap(r.Sprites.toPolygon(e),e.x,e.y)),t[0])return!1;return!0},shoot(t,e,s,n,o,a){const l=n(),h=r.Sprites.topLeftOffsetXY(t);return i.add$(h,[o,a]),i.copy(l,i.add(t,h)),i.set(l.m5.vel,Math.cos(e)*s,Math.sin(e)*s),l},healthBar(t){let{scale:e,width:s,height:i,lives:n,borderWidth:o,line:a,fill:l}=t,h=4*e,u=4*e,d=[];o=(o||4)*e,n=n||3,l=r.Sprites.color(l),a=r.Sprites.color(a);for(let t=c(s/n),e=0;e<n;++e)d.push(r.Sprites.rect(t,i-2*o,l));return{dec(){return this.lives>0&&(this.lives-=1,d[this.lives].visible=!1),this.lives>0},lives:d.length,sprite:r.Scenes.layoutX(d,{bg:["#cccccc",0],borderWidth:o,border:a,padding:h,fit:u})}},gaugeUI(t){let{minDeg:e,maxDeg:s,line:i,gfx:o,scale:l,cx:c,cy:p,radius:f,alpha:g,fill:m,needle:_}=a.patch(t,{minDeg:90,maxDeg:360});const x=[0,45*d,90*d,135*d,180*d,225*d,270*d,315*d];function y(t,e,r,s){return[t+r*h(s),e+r*u(s)]}return _=r.Sprites.color(_),i=r.Sprites.color(i),m=r.Sprites.color(m),f*=l,{gfx:o,draw(){r.Sprites.gclear(o),r.Sprites.gcircle(o,c,p,f),r.Sprites.gfill(o,{color:m,alpha:g}),r.Sprites.gstroke(o,{width:f/8,color:i}),x.forEach((t=>function(t,e,s,n){let[a,h]=y(t,e,f-4*l,s),[u,c]=y(t,e,f-12*l,s);r.Sprites.gpath(o,[["moveTo",a,h],["lineTo",u,c],["closePath"]]),r.Sprites.gstroke(o,{color:i,width:n,cap:"round"})}(c,p,t,7*l))),function(t,e,s){let[n,a]=y(c,p,t-20*l,s),[h,u]=y(c,p,2*l,s+90*d),[f,g]=y(c,p,2*l,s-90*d);r.Sprites.gpath(o,[["moveTo",h,u],["lineTo",n,a],["lineTo",f,g],["closePath"]]),r.Sprites.gstroke(o,{cap:"round",width:4*l,color:_}),r.Sprites.gcircle(o,c,p,9*l),r.Sprites.gfill(o,{color:i}),r.Sprites.gstroke(o,{color:i})}(f*l,0,d*n.lerp(e,s,t.update()))}}}};return r.Ute2D=p}if("object"==typeof module&&module.exports)throw"Panic: browser only";t["io/czlab/mojoh5/Ute2D"]=t=>t.Ute2D?t.Ute2D:r(t)}(this),function(t,e){"use strict";if(!t.AudioContext)throw"Fatal: no audio.";function r(r,s){const{ute:i,is:n}=r,o=(Math.floor,new Map);let a=1;function l(t,n,l){let h=0,u=1;const c={sids:i.jsMap(),buffer:e,loop:!1,src:l,name:n,get pan(){return h},set pan(t){h=t},get vol(){return u},set vol(t){u=t},play(){const e=i.now(),s=this.name;if(r.Sound.sfx()&&!function(t,e,r){let s;return o.has(t)&&o.get(t)>e?s=!0:o.delete(t),s}(s,e)){let e=a++,r=1e3*this.buffer.duration,s=t.ctx.createGain(),n=t.ctx.createStereoPanner(),o=t.ctx.createBufferSource();o.buffer=this.buffer,o.connect(s),s.connect(n),n.connect(t.ctx.destination),this.loop?o.loop=!0:i.delay(r,(()=>this.sids.delete(e))),n.pan.value=h,s.gain.value=u,o.start(0),this.sids.set(e,o)}return this},stop(){return this.sids.forEach((t=>t.stop(0))),this.sids.length=0,this}};return s[n]=c}const h={ctx:new t.AudioContext,_mute:0,init(){i.delay(0,(()=>{"suspended"==this.ctx.state&&this.ctx.resume()}))},sfx(){return 0==this._mute},mute(){return(this._mute=1)&&this},unmute(){return(this._mute=0)||this},decodeData(t,e,r,s,i){let n=l(this,t,e);return this.ctx.decodeAudioData(r,(t=>{s(n.buffer=t)}),(t=>{i&&i(e,t)})),n},decodeUrl(t,e,r,s){let i=new XMLHttpRequest,n=l(this,t,e);return i.open("GET",e,!0),i.responseType="arraybuffer",i.addEventListener("load",(()=>{this.decodeData(e,i.response,r,s)})),i.send(),n}};return r.sound=function(t,n=!0){return s[t||r.assetPath(t)]||(n?i.assert(!1,`Sound: ${t} not loaded.`):e)},r.Sound=h}if("object"==typeof module&&module.exports)throw"Panic: browser only";t["io/czlab/mojoh5/Sound"]=function(t){return t.Sound?t.Sound:r(t,{})}}(this),function(t,e){"use strict";function r(r){const s=t["io/czlab/mcfud/geo2d"](),{math:i,v2:n,ute:o,is:a}=r,l=["ctrlKey","altKey","shiftKey"],h=[],u=()=>h[0];function c(t){function i(e,r,s){t===u()&&((r=t.keyInputs.get(e.keyCode))||t.keyInputs.set(e.keyCode,r={}),r.state=s,o.copyKeys(r,e,l),e.preventDefault())}const h=["keyup",globalThis,function(t,e){i(t,e,!1)},!1],c=["keydown",globalThis,function(t,e){i(t,e,!0)},!1];return r.touchDevice||o.addEvent([h,c]),o.inject(t,{yid:`yid#${o.nextId()}`,keyInputs:o.jsMap(),pauseInput:!1,ptr:e,dispose(){this.ptr.dispose(),r.touchDevice||o.delEvent([h,c])},pointer(){return this.ptr||(this.ptr=function(t){let i={Actives:{DragsID:o.jsMap(),Touches:o.jsMap(),reset(){this.DragsID.clear(),this.Touches.clear()}},Hotspots:[],Buttons:[],DragDrops:[],state:[!1,!0],touchZeroID:e,_visible:!0,_x:0,_y:0,width:1,height:1,downTime:0,downAt:[0,0],elapsedTime:0,dragged:e,dragOffsetX:0,dragOffsetY:0,anchor:r.makeAnchor(.5,.5),get cursor(){return r.canvas.style.cursor},set cursor(t){r.canvas.style.cursor=t},get x(){return this._x/r.scale},get y(){return this._y/r.scale},get visible(){return this._visible},get isUp(){return this.state[1]},get isDown(){return this.state[0]},set visible(t){this.cursor=t?"auto":"none",this._visible=t},_testTouchDragStart(t,e){for(let s,i,n=0;n<t.length;++n)if(i=t[n],e.get(i.id)||this.Actives.DragsID.get(i.id))e.set(i.id,1);else for(let t,n=this.DragDrops.length-1;n>=0;--n)if((t=this.DragDrops[n])&&t.m5.drag&&this._test(t,i.x,i.y)){s={dragged:t,id:i.id,dragPtrX:i.x,dragPtrY:i.y,dragStartX:t.x,dragStartY:t.y},this.Actives.DragsID.set(i.id,s),this.touchZeroID==i.id&&this._resetClickTap(),r.moveToTop(t),e.set(i.id,1);break}},_testMouseDragStart(){for(let t,e=this.DragDrops.length-1;e>=0;--e)if((t=this.DragDrops[e])&&t.m5.drag&&this.hitTest(t)){this.dragStartX=t.x,this.dragStartY=t.y,this.dragPtrX=this.x,this.dragPtrY=this.y,this.dragged=t,r.moveToTop(t);break}return this.dragged},_maybeUpdateMouseDrag(){this.state[0]&&this.dragged&&n.set(this.dragged,this.dragStartX+(this.x-this.dragPtrX),this.dragStartY+(this.y-this.dragPtrY))},_maybeEndMouseDrag(t=0){return this.state[1]&&this.dragged&&(this.dragged.m5.onDragDropped?.(),this.dragged=e,t=!0),t},getGlobalPosition(){return{x:this.x,y:this.y}},_press(){if(t!==u())return;let e,r,s,i=this.Buttons.length;for(e=0;e<i;++e)if(r=this.Buttons[e],r.m5.gui&&r.m5.press&&this.hitTest(r)){r.m5.press(r),s=!0;break}if(!s)for(e=0;e<i;++e)if(r=this.Buttons[e],r.m5.press&&this.hitTest(r)){r.m5.press(r);break}},_doMDown(e){if(t!==u())return;let r,s=i;for(let t,i=0;i<s.Hotspots.length;++i)if((t=s.Hotspots[i])&&t.m5.touch&&s.hitTest(t)){t.m5.touch(t,e),r=!0;break}return r},mouseDown(e){if(t!==u())return;let s=i,n=o.now();0==e.button&&(e.preventDefault(),s._x=e.pageX-e.target.offsetLeft,s._y=e.pageY-e.target.offsetTop,o.setVec(s.state,!0,!1),s.downTime=n,s.downAt[0]=s._x,s.downAt[1]=s._y,r.Sound.init(),t.pauseInput||(!s._testMouseDragStart()&&s._doMDown(!0),r.emit([`${t.yid}/mousedown`])))},mouseMove(e){if(t!==u())return;let s=i;s._x=e.pageX-e.target.offsetLeft,s._y=e.pageY-e.target.offsetTop,t.pauseInput||(s._maybeUpdateMouseDrag(),r.emit([`${t.yid}/mousemove`]))},mouseUp(e){if(t!==u())return;let s=i,a=o.now();if(0==e.button&&(e.preventDefault(),s.elapsedTime=Math.max(0,a-s.downTime),s._x=e.pageX-e.target.offsetLeft,s._y=e.pageY-e.target.offsetTop,o.setVec(s.state,!1,!0),!t.pauseInput)){if(s._maybeEndMouseDrag());else if(!s._doMDown(!1)){let e=n.vecAB(s.downAt,s),i=n.len2(e);i<400&&s.elapsedTime<200?(s._press(),r.emit([`${t.yid}/single.tap`])):s._swipeMotion(e,i,s.elapsedTime)}r.emit([`${t.yid}/mouseup`])}},_swipeMotion(e,s,i,o){if(t!==u())return;let a,l=n.unit$(n.normal(e));s>400&&i<1e3&&(Math.abs(l[0])>.8||Math.abs(l[1])>.8)&&(l[0]>.8&&(a="swipe.down"),l[0]<-.8&&(a="swipe.up"),l[1]>.8&&(a="swipe.left"),l[1]<-.8&&(a="swipe.right")),a&&r.emit([`${t.yid}/${a}`],o)},_doMTouch(e,r,s){if(t===u())for(let t,i=0;i<e.length;++i)if(t=e[i],!r.get(t.id))for(let e,i=0;i<this.Hotspots.length;++i)if((e=this.Hotspots[i])&&e.m5.touch&&this._test(e,t.x,t.y)){e.m5.touch(e,s),r.set(t.id,1);break}},touchCancel(e){if(o.log("received touchCancel event!"),t!==u())return;let r,s,n=i,a=e.changedTouches;for(s=0;s<a.length;++s)r=a[s],n.Actives.Touches.delete(r.id),n.Actives.DragsID.delete(r.id);0==n.Actives.Touches.size&&(n.Actives.DragsID.clear(),n._freeTouches())},touchStart(s){if(t!==u())return;let n=s.target,a=[],l=i,h=o.now(),c=o.jsMap(),d=s.targetTouches;s.preventDefault();for(let t,s,i,u,c,p,f=0;f<d.length;++f)p=d[f],c=p.identifier,i=p.pageX-n.offsetLeft,u=p.pageY-n.offsetTop,t={id:c,_x:i,_y:u,downTime:h,downAt:[i,u],x:i/r.scale,y:u/r.scale},s={id:c,_x:i,_y:u,downTime:h,downAt:[i,u],x:t.x,y:t.y},l.Actives.Touches.set(c,s),a.push(t),l.touchZeroID===e&&0==f&&(l.touchZeroID=c,l._x=i,l._y=u,l.downTime=h,l.downAt=[i,u],o.setVec(l.state,!0,!1));r.Sound.init(),t.pauseInput||(l._testTouchDragStart(a,c),l._doMTouch(a,c,!0),r.emit([`${t.yid}/touchstart`],a))},touchMove(e){if(t!==u())return;let s=i,o=[],a=e.target,l=e.changedTouches;e.preventDefault();for(let t,e,i,h,u,c,d,p,f=0;f<l.length;++f)d=l[f],p=d.identifier,(t=s.Actives.Touches.get(p))?(u=d.pageX-a.offsetLeft,c=d.pageY-a.offsetTop,i=u/r.scale,h=c/r.scale,p==s.touchZeroID&&(s._x=u,s._y=c),t.x=i,t.y=h,t._x=u,t._y=c,(t=s.Actives.DragsID.get(p))&&(t.x=i,t.y=h,t._x=u,t._y=c,e=t.dragged,n.set(e,t.dragStartX+(i-t.dragPtrX),t.dragStartY+(h-t.dragPtrY))),o.push({id:p,x:i,y:h,_x:u,_y:c})):r.warn(`move-no activetouch with id=${p}`);!t.pauseInput&&r.emit([`${t.yid}/touchmove`],o)},touchEnd(e){if(t!==u())return;let s,n,a,l,h,c,d=i,p=[],f=o.jsMap(),g=e.changedTouches,m=e.target,_=o.now();for(e.preventDefault(),a=0;a<g.length;++a)h=g[a],c=h.identifier,s=h.pageX-m.offsetLeft,n=h.pageY-m.offsetTop,c==d.touchZeroID&&(d.elapsedTime=Math.max(0,_-d.downTime),o.setVec(d.state,!1,!0),d._x=s,d._y=n),(l=d.Actives.Touches.get(c))?(l.elapsedTime=Math.max(0,_-l.downTime),l.x=s/r.scale,l.y=n/r.scale,l._x=s,l._y=n,p.push(o.clone(l))):r.warn(`end-no activetouch with id=${c}`);for(t.pauseInput||(d._maybeEndTouchDrag(p,f),d._doMTouch(p,f,!1),d._onEndMultiTouches(p,f),r.emit([`${t.yid}/touchend`],p)),a=0;a<g.length;++a)d.Actives.Touches.delete(g[a].identifier);0==d.Actives.Touches.size&&d._freeTouches()},_maybeEndTouchDrag(t,e){let r=this._x,s=this._y;for(let r,s,i,o=0;o<t.length;++o)i=t[o],(s=this.Actives.DragsID.get(i.id))&&(this.Actives.DragsID.delete(i.id),r=s.dragged,e.set(i.id,1),this._x=i._x,this._y=i._y,n.set(r,s.dragStartX+(i.x-s.dragPtrX),s.dragStartY+(i.y-s.dragPtrY)),r.m5.onDragDropped?.());this._x=r,this._y=s},_onEndMultiTouches(e,s){if(t===u())for(let i,o,a,l=0;l<e.length;++l)if(i=e[l],!s.get(i.id))if(o=n.vecAB(i.downAt,i),a=n.len2(o),a<400&&i.elapsedTime<200){for(let t,e=0,r=this.Buttons.length;e<r;++e)if((t=this.Buttons[e])&&t.m5.press&&this._test(t,i.x,i.y)){t.m5.press(t);break}this._x=i.downAt[0],this._y=i.downAt[1],r.emit([`${t.yid}/single.tap`],i)}else this._swipeMotion(o,a,i.elapsedTime,i)},_resetClickTap(){o.setVec(this.state,!1,!0),this.touchZeroID=e},_freeTouches(){this._resetClickTap(),this.Actives.reset()},reset(){this._freeTouches(),this.DragDrops.length=0,this.Buttons.length=0,this.Hotspots.length=0},_test(t,e,i){let o=r.Sprites,a=o.gposXY(t),l=o.toPolygon(t),h=n.translate(a,l.calcPoints);return s.hitTestPointInPolygon(e,i,h)},hitTest(t){return this._test(t,this.x,this.y)},update(t){}};const a=[["mousemove",r.canvas,i.mouseMove],["mousedown",r.canvas,i.mouseDown],["mouseup",globalThis,i.mouseUp]],l=[["touchmove",r.canvas,i.touchMove],["touchstart",r.canvas,i.touchStart],["touchend",globalThis,i.touchEnd],["touchcancel",globalThis,i.touchCancel]];return r.touchDevice?o.addEvent(l):o.addEvent(a),i.dispose=function(){this.reset(),r.touchDevice?o.delEvent(l):o.delEvent(a)},i}(this))},update(t){!this.pauseInput&&this.ptr.update(t)},keybd(e,s,i){const n={press:s,release:i};let l=!0,h=!1,c=this,d=a.vec(e)?e:[e];const p=["keyup",globalThis,function(e){t===u()&&(d.includes(e.keyCode)&&(!c.pauseInput&&h&&n.release?.(e.altKey,e.ctrlKey,e.shiftKey),l=!0,h=!1),e.preventDefault())},!1],f=["keydown",globalThis,function(e){t===u()&&(d.includes(e.keyCode)&&(!c.pauseInput&&l&&n.press?.(e.altKey,e.ctrlKey,e.shiftKey),l=!1,h=!0),e.preventDefault())},!1];return r.touchDevice||o.addEvent([p,f]),n.dispose=()=>{r.touchDevice||o.delEvent([p,f])},n},reset(){this.pauseInput=!1,this.ptr.reset(),this.keyInputs.clear()},resize(){(r.mouse=this.ptr).reset()},dbg(){o.log(`N# of hotspots= ${this.ptr.Hotspots.length}`),o.log(`N# of buttons= ${this.ptr.Buttons.length}`),o.log(`N# of drags= ${this.ptr.DragDrops.length}`),o.log(`Mouse pointer = ${this.ptr}`)}}),t.pointer()&&t}let d=!0;const p={LEFT:37,RIGHT:39,UP:38,DOWN:40,ZERO:48,ONE:49,TWO:50,THREE:51,FOUR:52,FIVE:53,SIX:54,SEVEN:55,EIGHT:56,NINE:57,A:65,B:66,C:67,D:68,E:69,F:70,G:71,H:72,I:73,J:74,K:75,L:76,M:77,N:78,O:79,P:80,Q:81,R:82,S:83,T:84,U:85,V:86,W:87,X:88,Y:89,Z:90,ENTER:13,ESC:27,BACKSPACE:8,TAB:9,SHIFT:16,CTRL:17,ALT:18,SPACE:32,HOME:36,END:35,PGGUP:33,PGDOWN:34,isPaused:()=>u().pauseInput,resume(){u().pauseInput=!1},pause(){u().pauseInput=!0},dbg(){u().dbg()},_cur:()=>u(),setMultiTouch(t){d=t},resize(){u().resize()},reset(){u().reset()},setKeyOn(t){let e=u().keyInputs.get(t);e||u().keyInputs.set(t,e={}),e.state=!0},setKeyOff(t){let e=u().keyInputs.get(t);e||u().keyInputs.set(t,e={}),e.state=!1},keybd:(t,e,r)=>u().keybd(t,e,r),undoButton:t=>(o.disj(u().ptr.Buttons,t),t.m5.button=!1,t),makeButton:(t,e=!1)=>(o.conj(u().ptr.Buttons,t),t.m5.button=!0,t.m5.gui=e,t),undoHotspot:t=>(o.disj(u().ptr.Hotspots,t),t.m5.hotspot=!1,t),makeHotspot:t=>(o.conj(u().ptr.Hotspots,t),t.m5.hotspot=!0,t),undoXXX(t){t&&t.m5&&(t.m5.drag&&this.undoDrag(t),t.m5.button&&this.undoButton(t),t.m5.hotspot&&this.undoHotspot(t))},update(t){u().update(t)},makeDrag:t=>(o.conj(u().ptr.DragDrops,t),t.m5.drag=!0,t),undoDrag:t=>(o.disj(u().ptr.DragDrops,t),t.m5.drag=!1,t),keyUp(t){return!this.keyDown(t)},keyDown(t){let r=u().keyInputs.get(t);return r&&r.state?r:e},pointer:()=>u().pointer(),dispose(){h.forEach((t=>t.dispose())),h.length=0},restore(){h.length>1&&(h.shift().dispose(),u().pauseInput=!1)},save(){h.unshift(c({}))},on:(...t)=>(o.assert(a.vec(t[0])&&a.str(t[0][0]),"bad arg for Input.on()"),t[0][0]=`${u().yid}/${t[0][0]}`,r.on(...t)),off:(...t)=>(o.assert(a.vec(t[0])&&a.str(t[0][0]),"bad arg for Input.off()"),t[0][0]=`${u().yid}/${t[0][0]}`,r.off(...t))};return r.canvas.style.touchAction="none",p.undoBtn=p.undoButton,p.mkBtn=p.makeButton,p.mkDrag=p.makeDrag,h.push(c({})),r.Input=p}if("object"==typeof module&&module.exports)throw"Panic: browser only";t["io/czlab/mojoh5/Input"]=function(t){return t.Input?t.Input:r(t)}}(this),function(t,e){"use strict";if("object"==typeof module&&module.exports)throw"Panic: browser only";t["io/czlab/mojoh5/Touch"]=function(t){return t.Touch?t.Touch:function(t){const e=Math.PI/8,r=3*e,s=5*e,i=7*e,{is:n,ute:o}=t,a=Math.sin,l=Math.cos,h=Math.abs,u=180/Math.PI;function c(n){let{Input:c}=t;function d(t){let e=t.target,r=t.changedTouches;r?(t=r[0],n.m5.touchId=r[0].identifier):n.m5.touchId=0,n.m5.startX=t.pageX-e.offsetLeft,n.m5.startY=t.pageY-e.offsetTop,n.m5.drag=!0,n.m5.static||(n.visible=!0,n.x=n.m5.startX,n.y=n.m5.startY),c.isPaused()||n.m5.onStart()}function p(t){n.m5.drag&&(n.m5.hdle.position.set(0,0),n.m5.drag=!1,n.m5.static||(n.visible=!1),c.isPaused()||n.m5.onEnd())}function f(d){if(c.isPaused()||!n.visible||!n.m5.drag)return;let p,f=d.target;if(d.changedTouches){for(let t=0,e=d.changedTouches;t<e.length;++t)if(n.m5.touchId==e[t].identifier){p=[e[t].pageX-f.offsetLeft,e[t].pageY-f.offsetTop];break}}else p=[d.pageX-f.offsetLeft,d.pageY-f.offsetTop];let g,m,_,x=0,y=p?p[0]-n.m5.startX:0,b=p?p[1]-n.m5.startY:0,v=n.m5.range;if(p[0]=0,p[1]=0,!o.feq0(y)||!o.feq0(b)){if(m=h(y),_=h(b),o.feq0(y))p[0]=0,b>0?(p[1]=b>v?v:b,x=270,g=t.DOWN):(p[1]=-(_>v?v:_),x=90,g=t.UP);else if(o.feq0(b))p[1]=0,y>0?(p[0]=m>v?v:m,x=0,g=t.RIGHT):(p[0]=-(m>v?v:m),x=180,g=t.LEFT);else{let n=Math.atan(h(b/y));x=n*u,p[0]=p[1]=0,y*y+b*b>=v*v?(p[0]=v*l(n),p[1]=v*a(n)):(p[0]=m>v?v:m,p[1]=_>v?v:_),b<0&&(p[1]=-h(p[1])),y<0&&(p[0]=-h(p[0])),y>0&&b<0||(y<0&&b<0?x=180-x:y<0&&b>0?x+=180:y>0&&b>0&&(x=360-x)),g=function(n,a){const l=Math.atan2(+a,+n);return l>-s&&l<-r?t.UP:l>r&&l<s?t.DOWN:l>-e&&l<0||l>0&&l<e?t.RIGHT:l>i&&l<Math.PI||l>-Math.PI&&l<-i?t.LEFT:l>e&&l<r?t.SE:l>s&&l<i?t.SW:l>-r&&l<-e?t.NE:l>-i&&l<-s?t.NW:void o.assert(!1,"Failed Joystick calcDir")}(p[0],p[1])}n.m5.hdle.position.set(p[0],p[1]),n.m5.onChange(g,x)}}const g=[["mousemove",t.canvas,f],["mousedown",t.canvas,d],["mouseup",globalThis,p],["touchend",globalThis,p],["touchcancel",globalThis,p],["touchmove",t.canvas,f],["touchstart",t.canvas,d]];return o.addEvent(g),n.m5.dispose=()=>{o.delEvent(g)},n}const d={assets:["boot/joystick.png","boot/joystick-handle.png"],joystick(e){let{Sprites:r}=t,s=r.sprite("boot/joystick-handle.png"),i=r.sprite("boot/joystick.png"),n=r.container(),a=t.getScaleFactor(),l=o.inject({oscale:.7*a,iscale:1*a,hdle:s,schtick:i,onEnd(){},onStart(){},prevDir:0,static:!1,onChange(t,e){}},e);return n.addChild(r.centerAnchor(r.scaleXY(i,l.oscale,l.oscale))),n.addChild(r.centerAnchor(r.scaleXY(s,l.iscale,l.iscale))),l.range=n.width/2.5,l.static||(n.visible=!1),o.inject(n.m5,l),c(n)}};return t.Touch=d}(t)}}(this),function(t,e){"use strict";if("object"==typeof module&&module.exports)throw"Panic: browser only";t["io/czlab/mojoh5/Tiles"]=function(t){return t.Tiles?t.Tiles:function(t){const e=[t.UP,t.LEFT,t.RIGHT,t.DOWN],{ute:r,is:s,v2:i,math:n}=t,o=Math.abs,a=Math.ceil,l=Math.floor;function h(t,e,s){return i=t,n=e,o=s.tiled.tileW,a=s.tiled.tileH,h=s.tiled.tilesInX,i>=0&&n>=0?l(i/o)+l(n/a)*h:r.assert(!1,`IndexError: ${i},${n}, wanted +ve values`);var i,n,o,a,h}function u(e,r){return i.vecAB(t.Sprites.centerXY(e),t.Sprites.centerXY(r))}function c(t){const e=t.image?.split("/");t.image=e&&e.length&&e[e.length-1]}function d(t,e,s){const i=[];return t.forEach((t=>{i.push([t.firstgid,t]),t.spacing||(t.spacing=0),c(t);const n={};(t.tiles||[]).forEach((e=>{let i=r.selectNotKeys(e,"properties");i=r.inject(i,p(e)),i.gid=t.firstgid+e.id,n[e.id]=i,s[i.gid]=i})),e[t.name]=n})),i.sort(((t,e)=>t[0]>e[0]?1:t[0]<e[0]?-1:0))}function p(t){return(t.properties||[]).reduce(((t,e)=>(t[e.name]=e.value,t)),{})}function f(e,i,o){let a={},h={},u=s.str(i)?function(e){let s=t.resource(e,!0),i=s&&(s.tiledversion||s.version);return i&&r.cmpVerStrs(i,"1.4.2")>=0?s:r.assert(!1,`${e} needs update`)}(i):i;r.assert(s.obj(u),"bad tiled map"),u=JSON.parse(JSON.stringify(u)),r.inject(e.tiled,{tileW:u.tilewidth,tileH:u.tileheight,tilesInX:u.width,tilesInY:u.height,tiledMap:u,saved_tileW:u.tilewidth,saved_tileH:u.tileheight,tiledWidth:u.tilewidth*u.width,tiledHeight:u.tileheight*u.height},p(u));let f=e.getScaleFactor(),m=r.evenN(f*u.tileheight),_=r.evenN(f*u.tilewidth);e.tiled.new_tileW=_,e.tiled.new_tileH=m;const x={imagelayer(t){c(t)},tilelayer(t){s.vec(t.data[0])&&(t.width=t.data[0].length,t.height=t.data.length,t.data=t.data.flat()),t.width||(t.width=e.tiled.tilesInX),t.height||(t.height=e.tiled.tilesInY);let r,i=p(t);if(!1!==t.visible)for(let r,s=0;s<t.data.length;++s){if(0==(r=t.data[s]))continue;!1===t.collision||!1===i.collision||!0!==t.collision&&!0!==i.collision||(r>0&&(e.tiled.collision[s]=r),t.collision=!0);let n=s%t.width,a=l(s/t.width),u=h[r],c=u&&u.Class,d=c&&o[c],p=e.getTSInfo(r),f=g(e,r,n,a,i.width,i.height);f&&(f.tiled.layer=t,f.tiled.index=s,f.m5.static=!0),d&&(f=d.c(e,f,p,u)),f&&(e.insert(f,!!d),u&&u.sensor&&(f.m5.sensor=!0))}else(r=i.Class)&&o[r](e,t)},objectgroup(t){t.sprites=[],t.objects.forEach((i=>{r.assert(s.num(i.x),"wanted xy position");let a,l,u=p(i),c=i.gid??-1;r.inject(i,u),c>0&&(l=h[c]);let d=r.nor(l&&l.Class,i.Class),f=d&&o[d],x=e.tiled.saved_tileW,y=e.tiled.saved_tileH,b=n.ndiv(i.x+x/2,x),v=n.ndiv(i.y-y/2,y),T=e.getTSInfo(c);i.column=b,i.row=v,a=c<=0?{width:_,height:m}:g(e,c,b,v,i.width,i.height,d),f&&(a=f.c(e,a,T,l,i)),a&&(!1===i.visible&&(a.visible=!1),i.uuid=a.m5.uuid,t.sprites.push(a),e.insert(a,!0),l&&l.sensor&&(a.m5.sensor=!0))}))}};o=o??{},r.inject(e.tiled,{objFactory:o,tileSets:a,tileProps:h,collision:r.fill(u.width*u.height,0),imagelayer:[],objectgroup:[],tilelayer:[],tileGidList:d(u.tilesets,a,h)}),["imagelayer","tilelayer","objectgroup"].forEach((t=>{u.layers.filter((e=>e.type==t)).forEach((r=>{x[t](r),e.tiled[t].push(r)}))})),e.tiled.tileW=_,e.tiled.tileH=m,e.tiled.tiledWidth=_*u.width,e.tiled.tiledHeight=m*u.height,e.parent instanceof t.Scenes.SceneWrapper&&(e.tiled.tiledHeight<t.height&&(e.parent.y=n.ndiv(t.height-e.tiled.tiledHeight,2)),e.tiled.tiledWidth<t.width&&(e.parent.x=n.ndiv(t.width-e.tiled.tiledWidth,2)))}function g(e,i,o,a,h,u,c){let d,p=e.getTSInfo(i,!0),f=p.columns,g=i-p.firstgid,m=e.tiled.tileProps[i],_=e.getScaleFactor();d=(c=c??(m&&m.Class))&&e.tiled.objFactory[c],r.assertNot(g<0,`Bad tile id: ${g}`),s.num(f)||(f=n.ndiv(p.imagewidth,p.tilewidth+p.spacing));let x=g%f,y=l(g/f),b=x*p.tilewidth,v=y*p.tileheight;p.spacing>0&&(b+=p.spacing*x,v+=p.spacing*y);let T=d&&d.s(e)||t.Sprites.frame(p.image,h||p.tilewidth,u||p.tileheight,b,v);return T&&(T.tiled={id:g,gid:i},h==e.tiled.saved_tileW?T.width=e.tiled.new_tileW:(T.scale.x=_,T.width=r.evenN(T.width)),u==e.tiled.saved_tileH?T.height=e.tiled.new_tileH:(T.scale.y=_,T.height=r.evenN(T.height)),T.x=o*e.tiled.new_tileW,T.y=a*e.tiled.new_tileH),T}const m=t.Sprites.lift({width:0,height:0,parent:null,x:0,y:0,rotation:0,tiled:{},anchor:{x:0,y:0},getGlobalPosition(){return{x:this.x+this.parent.x,y:this.y+this.parent.y}}});class _ extends t.Scenes.Scene{constructor(t,e,r){super(t,e,r),this.tiled={}}reloadMap(t){this.tiled={},this.m5.options.tiled=t,f(this,t.name,t.factory)}runOnce(){const t=this.m5.options.tiled;this.preTMX?.(t),f(this,t.name,t.factory),this.postTMX?.(t),super.runOnce()}removeTile(e,r){let{x:s,y:i}=r;r.anchor.x<.3&&(i=r.y+l(r.height/2),s=r.x+l(r.width/2));let n=l(s/this.tiled.tileW),o=l(i/this.tiled.tileH),a=this.getTileLayer(e),h=n+o*this.tiled.tilesInX;a.data[h]=0,a.collision&&(this.tiled.collision[h]=0),t.Sprites.remove(r)}getTileLayer(t,e){const s=r.some(this.tiled.tilelayer,(e=>{if(e.name==t)return e}));if(!s&&e)throw`There is no layer with name: ${t}`;return s}getObjectGroup(t,e){const s=r.some(this.tiled.objectgroup,(e=>{if(e.name==t)return e}));if(!s&&e)throw`There is no group with name: ${t}`;return s}setTile(t,e,r,s){let i,n=this.getTSInfo(s,!0),o=(n.firstgid,this.getTileLayer(t)),a=r+this.tiled.tilesInX*e;return o.collision&&(this.tiled.collision[a]=s),i=g(this,s,r,e,n.tilewidth,n.tileheight),i&&(i.tiled.index=a,i.tiled.layer=o),i}getTile(t){let{x:e,y:r}=t;return t.anchor.x<.3&&(r+=l(t.height/2),e+=l(t.width/2)),this.getTileXY(e,r)}getTileXY(t,e){let s=l(t/this.tiled.tileW),i=l(e/this.tiled.tileH);return r.assert(s>=0&&s<this.tiled.tilesInX,`bad tile col:${s}`),r.assert(i>=0&&i<this.tiled.tilesInY,`bad tile row:${i}`),[s,i]}getNamedItem(t){const e=[];return this.tiled.objectgroup.forEach((s=>{s.objects.forEach((s=>{t==r.get(s,"name")&&e.push(s)}))})),e}getScaleFactor(){let e=t.height/(this.tiled.saved_tileH*this.tiled.tilesInY),r=t.width/(this.tiled.saved_tileW*this.tiled.tilesInX),s=1;return"max"==t.u.scaleToWindow&&(s=r<e?r:e),s}getTileIndex(e){let[r,s]=t.Sprites.centerXY(e);return h(r,s,this)}getTSInfo(t,e){const s=function(t,e){let r=-1;if(t>0)for(r=0;e[r+1]&&t>=e[r+1][0];)++r;return r>=0?e[r]:[]}(t,this.tiled.tileGidList)[1];return!s&&e?r.assert(!1,`Bad GID ${t}, no tileset`):s}getTileProps(t){return this.tiled.tileProps[t]}_getContactObj(t,e,r){let s=m;return s.height=this.tiled.tileH,s.width=this.tiled.tileW,s.x=e*s.width,s.y=r*s.height,s.tiled.gid=t,s.tiled.row=r,s.tiled.col=e,s.m5.sensor=!1,s}collideXY(e){let i=t.Sprites,n=this.tiled.tileW,o=this.tiled.tileH,h=this.tiled.collision,u=r.feq0(e.angle)?i.getAABB(e):i.boundingBox(e),c=Math.max(0,l(u.x1/n)),d=Math.max(0,l(u.y1/o)),p=Math.min(this.tiled.tilesInX-1,a(u.x2/n)),f=Math.min(this.tiled.tilesInY-1,a(u.y2/o));for(let n,o,a,l,u=d;u<=f;++u)for(let d=c;d<=p;++d)a=u*this.tiled.tilesInX+d,o=h[a],r.assert(s.num(o),"bad gid"),0!=o&&(l=this._getContactObj(o,d,u),n=this.getTileProps(o),n&&(l.m5.sensor=!!n.sensor),l.parent=this,i.hit(e,l)&&l.m5.sensor&&t.emit(["bump.sensor",e],l));return super.collideXY(e)}}class x{constructor(t,e){this.straightCost=t,this.diagonalCost=e}manhattan(t,e){return o(t.row-e.row)*this.straightCost+o(t.col-e.col)*this.straightCost}euclidean(t,e){let s=e.col-t.col,i=e.row-t.row;return l(r.sqrt(s*s+i*i)*this.straightCost)}diagonal(t,e){let r=o(e.col-t.col),s=o(e.row-t.row);return l(r>s?this.diagonalCost*s+this.straightCost*(r-s):this.diagonalCost*r+this.straightCost*(s-r))}}const y={TiledScene:_,neighborCells(t,e,r){let s=e.tiled.tilesInX,i=[t-s-1,t-s,t-s+1,t-1],n=[t+1,t+s-1,t+s,t+s+1];return r||i.push(t),i.concat(n)},updateMap(t,e,i){let n=r.fill(t.length,0),o=t=>{let e=this.getTileIndex(t,i);r.assert(e>=0&&e<n.length,"tiled index outofbound"),t.tiled.index=e,n[e]=t.tiled.gid};return s.vec(e)?e.forEach(o):o(e),n},shortestPath(t,e,r,s,i=[],n="manhattan",o=!0){let a=s.tiled.tilesInX,h=r.map(((t,e)=>({f:0,g:0,h:0,parent:null,index:e,col:e%a,row:l(e/a)}))),u=h[e],c=h[t],d=c,p=[d],f=[],g=[],m=t=>(o?this.neighborCells(t,s,!0):this.crossCells(t,s)).map((t=>h[t])).filter((e=>{if(e){let s=t%a==0,n=(t+1)%a==0,o=e.col%(a-1)==0&&0!=e.col,l=e.col%a==0,h=i.some((t=>r[e.index]==t));return s?!o:n?!l:!h}}));for(;d!==u;){let t=m(d.index);for(let e,r,s,i,o,a=0;a<t.length;++a){o=t[a],i=14,d.row!=o.row&&d.col!=o.col||(i=10),r=d.g+i,e=r+new x(10,14)[n](o,u);let l=p.some((t=>o===t)),h=f.some((t=>o===t));l||h?o.f>e&&(o.f=e,o.g=r,o.h=s,o.parent=d):(o.f=e,o.g=r,o.h=s,o.parent=d,p.push(o))}if(f.push(d),0==p.length)return g;p=p.sort(((t,e)=>t.f-e.f)),d=p.shift()}if(0!=p.length){let t=u;for(g.push(t);t!==c;)t=t.parent,g.unshift(t)}return g},lineOfSight(e,r,s,n,o=0,a=32,c=[]){let d,p,f,g,m,_,x=u(e,r),y=i.len(x),b=l(y/a),v=[];for(let r,s=1;s<=b;++s)r=t.Sprites.centerXY(e),p=a*s,m=x[0]/y,_=x[1]/y,f=l(r[0]+m*p),g=l(r[1]+_*p),v.push({x:f,y:g,index:h(f,g,n)});return d=180*Math.atan2(x[1],x[0])/Math.PI,v.every((t=>s[t.index]==o))&&(0==c.length||c.some((t=>t==d)))},crossCells(t,e){const r=e.tiled.tilesInX;return[t-r,t-1,t+1,t+r]},getCrossTiles(t,e,r){return this.crossCells(t,r).map((t=>e[t]))},getDiagonalCells(t,e){const r=s.num(e)?e:e.tiled.tilesInX;return[t-r-1,t-r+1,t+r-1,t+r+1]},getDiagonalTiles(t,e,r){return this.getDiagonalCells(t,r).map((t=>e[t]))},validDirections(r,s,i,n){const o=this.getTileIndex(r,n);return this.getCrossTiles(o,s,n).map(((r,s)=>r==i?e[s]:t.NONE)).filter((e=>e!==t.NONE))},canChangeDirection(e=[]){let r=e.find((e=>e===t.UP)),s=e.find((e=>e===t.DOWN)),i=e.find((e=>e===t.LEFT)),n=e.find((e=>e===t.RIGHT));return 0==e.length||1==e.length||(r||s)&&(i||n)},randomDirection:(e=[])=>0==e.length?t.NONE:1==e.length?e[0]:e[r.randInt2(0,e.length-1)],closestDirection(e,r){const s=u(e,r);return o(s[0])<o(s[1])?s[1]<=0?t.UP:t.DOWN:s[0]<=0?t.LEFT:t.RIGHT}};return t.Tiles=y}(t)}}(this),function(t,e){"use strict";t["io/czlab/racer/track"]=function(t,e){const{Sprites:r,Scenes:s,Input:i,Game:n,v2:o,math:a,ute:l,is:h}=t,u=Math.floor,c=(Math.ceil,Math.sin,Math.cos,["car01.png","car02.png","car03.png","car04.png","semi.png","truck.png"]),d=["tree1.png","tree2.png","dead_tree1.png","dead_tree2.png","palm_tree.png","bush1.png","bush2.png","cactus.png","stump.png","boulder1.png","boulder2.png","boulder3.png"],p={E:25,M:50,H:100},f={E:2,M:4,H:6},g={E:20,M:40,H:60},m={road:r.color("#6B6B6B"),grass:r.color("#10AA10"),rumble:r.color("#555555"),lane:r.color("#CCCCCC")},_={road:r.color("#696969"),grass:r.color("#009A00"),rumble:r.color("#bbbbbb")},x={road:r.SomeColors.white,grass:r.SomeColors.white,rumble:r.SomeColors.white},y={road:r.SomeColors.black,grass:r.SomeColors.black,rumble:r.SomeColors.yellow},b=(t,e,r)=>t+(e-t)*(-Math.cos(r*Math.PI)/2+.5),v=()=>0==n.lines.length?0:l.last(n.lines).p2.world.y,T=(t=p.M,e=f.M,r=0)=>P(t,e,r),S=(t=p.M,e=g.M)=>P(t,0,e),w=(t=p.M)=>P(t,0,0),E=(t=p.E,e=g.E)=>[[t,0,e/2],[t,0,-e],[t,f.E,e],[t,0,0],[t,-f.E,e/2],[t,0,0]].forEach((t=>P(...t))),A=()=>[[p.M,-f.E,0],[p.M,f.M,g.M],[p.M,f.E,-g.E],[p.M,-f.E,g.M],[p.M,-f.M,-g.M]].forEach((t=>P(...t))),M=()=>[[10,0,5],[10,0,-2],[10,0,-5],[10,0,8],[10,0,5],[10,0,-7],[10,0,5],[10,0,-2]].forEach((t=>P(...t)));function P(t,r,s){function i(t,r){let s=n.lines.length;n.lines.push({index:s,p1:{world:{y:v(),z:s*e},camera:{},screen:{}},p2:{world:{y:r,z:(s+1)*e},camera:{},screen:{}},curve:t,sprites:[],cars:[],clip:0,color:a.ndiv(s,n.rumbles)%2?_:m})}let o,h=t,u=t,c=v(),d=t+h+u,p=c+l.toNum(s,0)*e;for(o=0;o<t;++o)i((g=o/t,(f=0)+(r-f)*Math.pow(g,2)),b(c,p,o/d));var f,g;for(o=0;o<h;++o)i(r,b(c,p,(t+o)/d));for(o=0;o<u;++o)i(b(r,0,o/u),b(c,p,(t+h+o)/d))}n.initTrack=function(r){n.lines.length=0,w(p.E),E(),A(),T(p.M,f.M,g.E),M(),E(),T(2*p.H,f.M,g.M),w(),S(p.M,g.H),A(),T(p.H,-f.M,0),S(p.H,g.H),T(p.H,f.M,-g.E),M(),S(p.H,-g.M),w(),A(),((t=200)=>{P(t,-f.E,-v()/e)})(),function(e){let r,s;function i(r,s,i){let o=t.sheet(e,s);n.lines[r].sprites.push({png:s,source:o,offset:i,w:o.width})}for(r=10;r<200;r+=4+u(r/100))l.rand()<.3&&(i(r,"palm_tree.png",.5+.5*l.rand()),i(r,"palm_tree.png",1+2*l.rand()));for(r=250;r<1e3;r+=5)l.rand()>.7&&(i(r,"column.png",1.1),i(r+l.randInt2(0,5),"tree1.png",-1-2*l.rand()),i(r+l.randInt2(0,5),"tree2.png",-1-2*l.rand()));for(r=200;r<n.lines.length;r+=3)l.rand()<.3&&i(r,l.randItem(d),l.randSign()*(2+5*l.rand()));for(r=1e3;r<n.lines.length-50;r+=100)if(l.rand()>.7){s=l.randSign();for(let t=0;t<20;++t)l.rand()<.3&&i(r+l.randInt2(0,50),l.randItem(d),s*(1.5+l.rand()))}}(r),function(r){let s,i,o,a,h;for(n.cars.length=0,s=0;s<n.totalCars;++s){o=u(l.rand()*n.lines.length)*e,a=l.randItem(c);let s=t.sheet(r,a);h=n.maxSpeed/4+l.rand()*n.maxSpeed/("semi.png"==a?4:2),i={offset:l.rand()*l.randSign()*.8,source:s,z:o,png:a,speed:h,w:s.width},n.getLine(i.z).cars.push(i),n.cars.push(i)}}(r),n.lines[n.getLine(n.player.z).index+2].color=x,n.lines[n.getLine(n.player.z).index+3].color=x;for(let t=0;t<n.rumbles;++t)n.lines[n.lines.length-1-t].color=y;n.SEGN=n.lines.length,n.trackLength=n.SEGN*e}}}(this),function(t,e){"use strict";const r="images/tiles.json";function s(e){const{Sprites:s,Scenes:i,Input:n,Game:o,FX:a,v2:l,math:h,ute:u,is:c}=e,d=Math.floor,p=(Math.ceil,Math.sin,Math.cos,e.u.SEGLEN),f=e.DOKI_LOWER;t["io/czlab/racer/track"](e,p);const g=t=>o.lines[d(t/p)%o.lines.length],m=e.u.fps*p;function _(t,e,r){let s=t+e;for(;s>=r;)s-=r;for(;s<0;)s+=r;return s}function x(t,e,r,s,i){let n=(i||1)/2;return!(t+e*n<r-s*n||t-e*n>r+s*n)}function y(t,e,r,s,i,n,o,a,l,h){t.poly([e,r,s,i,n,o,a,l]),t.fill({color:h})}function b(t,e,r,s,i,n){const a=(t,e)=>t/Math.max(32,8*e),l=(t,e)=>t/Math.max(6,2*e);let h=l(s.w,r),u=l(i.w,r),c=a(s.w,r),d=a(i.w,r);if(t.rect(0,i.y,o.W,s.y-i.y),t.fill({color:n.grass}),y(e,s.x-s.w-h,s.y,s.x-s.w,s.y,i.x-i.w,i.y,i.x-i.w-u,i.y,n.rumble),y(e,s.x+s.w+h,s.y,s.x+s.w,s.y,i.x+i.w,i.y,i.x+i.w+u,i.y,n.rumble),y(e,s.x-s.w,s.y,s.x+s.w,s.y,i.x+i.w,i.y,i.x-i.w,i.y,n.road),n.lane){let t=2*s.w/r,o=2*i.w/r,a=s.x-s.w+t,l=i.x-i.w+o;for(let h=1;h<r;a+=t,l+=o,++h)y(e,a-c/2,s.y,a+c/2,s.y,l+d/2,i.y,l-d/2,i.y,n.lane)}}function v(t,e,r,i,n,a,l,h){u.assert(u.inst(PIXI.Texture,e),"expected Texture!");let c,d,p=e,f=w(),g=p.width*r*o.W2*f,m=p.height*r*o.W2*f;i+=g*(a||0),n+=m*(l||0),d=h?Math.max(0,n+m-h):0,d<m&&(c=s.sprite(p),c.x=i,c.y=n,c.setSize(g,m-d),t.insert(c))}function T(t,r,s,i,n,a,l){let h=o.H/480,c=1.5*u.rand()*r*h*u.randSign();v(t,e.image("player.png"),s,i,n+c,-.5,-1)}function S(t,e,r,s,i){t.camera.x=(t.world.x||0)-e,t.camera.y=(t.world.y||0)-r,t.camera.z=(t.world.z||0)-s,t.screen.scale=i/t.camera.z,t.screen.w=Math.round(t.screen.scale*o.roadWidth*o.W2),t.screen.x=Math.round(o.W2+t.screen.scale*t.camera.x*o.W2),t.screen.y=Math.round(o.H2-t.screen.scale*t.camera.y*o.H2)}u.merge(o,{getLine:g,lines:[],cars:[],centrifugal:.3,lookAhead:20,lapTime:0,totalCars:16,roadWidth:2e3,rumbles:3,trackLength:0,lanes:3,fov:Math.PI/2,drawRange:300,pos:0,speed:0,maxSpeed:m,accel:m/5,braking:-m,decel:-m/5,offRoadDecel:-m/2,offRoadLimit:m/4,W:e.width,H:e.height,W2:e.width/2,H2:e.height/2,skySpeed:.001,hillSpeed:.002,treeSpeed:.003,skyOffset:0,hillOffset:0,treeOffset:0});const w=()=>o.roadWidth*o.SPRITES_SCALE,E=t=>t*o.SPRITES_SCALE,A=(t,e)=>t%e/e;i.scene("PlayGame",{setup(){const t=this;e.getScaleFactor();u.inject(this.g,{hills:s.fillMax("hills.png"),trees:s.fillMax("trees.png"),sky:s.fillMax("sky.png"),gfx:s.graphics(),gfx2:s.graphics(),initLevel(){let t=1/o.lanes,s=1/Math.tan(o.fov/2),i=e.image("player.png").width;return u.merge(o,{SPRITES_SCALE:t/i,camH:1e3,camD:s,player:{w:t,x:0,y:0,z:1e3*s}}),o.initTrack(r),this},resetGfx(){t.insert(this.sky),t.insert(this.hills),t.insert(this.trees),t.insert(this.gfx),t.insert(this.gfx2)},draw(){let e=g(o.pos),r=A(o.pos,p),s=0,i=o.H,n=-e.curve*r,a=g(o.pos+o.player.z),l=A(o.pos+o.player.z,p);o.player.y=h.lerp(a.p1.world.y,a.p2.world.y,l),this.gfx.clear()&&this.gfx2.clear()&&this.resetGfx();for(let t,r,a,l,h=0;h<o.drawRange;++h)l=o.lines[(e.index+h)%o.SEGN],l.clip=i,t=o.player.x*o.roadWidth,r=o.player.y+o.camH,a=o.pos-(l.index<e.index?o.trackLength:0),S(l.p1,t-s,r,a,o.camD),S(l.p2,t-s-n,r,a,o.camD),s+=n,n+=l.curve,l.p2.screen.y>=i||l.p1.camera.z<=o.camD||(b(this.gfx,this.gfx2,o.lanes,l.p1.screen,l.p2.screen,l.color),i=l.p2.screen.y);for(let r,s,i,n,u,c=o.drawRange-1;c>0;--c){for(u=o.lines[(e.index+c)%o.SEGN],u.cars.forEach((e=>{r=h.lerp(u.p1.screen.scale,u.p2.screen.scale,e.percent),v(t,e.source,r,h.lerp(u.p1.screen.x,u.p2.screen.x,e.percent)+r*e.offset*o.roadWidth*o.W2,h.lerp(u.p1.screen.y,u.p2.screen.y,e.percent),-.5,-1,u.clip)})),n=0;n<u.sprites.length;++n)i=u.sprites[n],v(t,i.source,u.p1.screen.scale,u.p1.screen.x+u.p1.screen.scale*i.offset*o.roadWidth*o.W2,u.p1.screen.y,i.offset<0?-1:0,-1,u.clip);u==a&&(s=o.camD/o.player.z,T(t,o.speed/o.maxSpeed,s,o.W2,o.H2-s*h.lerp(a.p1.camera.y,a.p2.camera.y,l)*o.H2,(o.speed,o.keyLeft||o.keyRight),(a.p2.world.y,a.p1.world.y)))}},update(t){let r,s,i,a,l,c=g(o.pos+o.player.z),d=o.speed/o.maxSpeed,f=o.pos,m=2*t*d;if(function(t,e){function r(t,e,r){let s,i,n,a=E(t.w);if(e.index-r.index>o.drawRange)return 0;for(let l,h,u=1;u<o.lookAhead;++u){if(l=o.lines[(e.index+u)%o.SEGN],l==r&&t.speed>o.speed&&x(o.player.x,o.player.w,t.offset,a,1.2))return s=o.player.x>.5?-1:o.player.x<-.5||t.offset>o.player.x?1:-1,1*s/u*(t.speed-o.speed)/o.maxSpeed;for(h=0;h<l.cars.length;++h)if(i=l.cars[h],n=E(i.w),t.speed>i.speed&&x(t.offset,a,i.offset,n,1.2))return s=i.offset>.5?-1:i.offset<-.5||t.offset>i.offset?1:-1,1*s/u*(t.speed-i.speed)/o.maxSpeed}return t.offset<-.9?.1:t.offset>.9?-.1:0}for(let s,i,n,a=0;a<o.cars.length;++a)n=o.cars[a],s=g(n.z),n.offset+=r(n,s,t),n.z=_(n.z,e*n.speed,o.trackLength),n.percent=n.z%p/p,i=g(n.z),s!==i&&(i.cars.push(n),u.disj(s.cars,n))}(c,t),o.pos=_(o.pos,t*o.speed,o.trackLength),o.player.x+=n.keyDown(n.LEFT)?-m:n.keyDown(n.RIGHT)?m:0,o.player.x-=m*d*c.curve*o.centrifugal,o.speed=n.keyDown(n.SPACE)?e.accel(o.speed,o.accel,t):n.keyDown(n.DOWN)?e.accel(o.speed,o.braking,t):e.accel(o.speed,o.decel,t),o.player.x<-1||o.player.x>1)for(o.speed>o.offRoadLimit&&(o.speed=e.accel(o.speed,o.offRoadDecel,t)),r=0;r<c.sprites.length;++r)if(a=c.sprites[r],l=E(a.w),x(o.player.x,o.player.w,a.offset+l/2*(a.offset>0?1:-1),l)){o.speed=o.maxSpeed/5,o.pos=_(c.p1.world.z,-o.player.z,o.trackLength);break}for(r=0;r<c.cars.length;++r)if(s=c.cars[r],i=E(s.w),o.speed>s.speed&&x(o.player.x,o.player.w,s.offset,i,.8)){o.speed=s.speed*(s.speed/o.speed),o.pos=_(s.z,-o.player.z,o.trackLength);break}o.player.x=h.clamp(-3,3,o.player.x),o.speed=h.clamp(0,o.maxSpeed,o.speed),o.skyOffset=_(o.skyOffset,o.skySpeed*c.curve*(o.pos-f)/p,1),o.hillOffset=_(o.hillOffset,o.hillSpeed*c.curve*(o.pos-f)/p,1),o.treeOffset=_(o.treeOffset,o.treeSpeed*c.curve*(o.pos-f)/p,1),o.pos>o.player.z&&(o.lapTime&&f<o.player.z?o.lapTime=0:o.lapTime+=t)}}),this.g.initLevel()&&i.run("HUD")},postUpdate(t){this.removeChildren(),this.g.update(t),this.g.draw()}}),i.scene("HUD",{setup(){let t=this,r=e.getScaleFactor(),i=s.bmpText("0","unscii",36*r);this.insert(this.g.lapTime=i),u.inject(this.g,{initHotspots(){let i,o,a,h,u,c={fontName:f,fontSize:32*r},d=s.color("#cccccc"),p=36*r,g=4*r;a=s.circle(p,d,d,g),h=a.width/4,u=h,a.addChild(s.centerAnchor(s.bmpText(">",c))),l.set(a,e.width-a.width/2-h,e.height-a.height/2-u),t.insert(s.opacity(n.makeHotspot(a),.2)),i=s.circle(p,d,d,g),i.addChild(s.centerAnchor(s.bmpText("<",c))),s.pinLeft(a,i,h),t.insert(s.opacity(n.makeHotspot(i),.2)),o=s.circle(p,d,d,g),o.addChild(s.centerAnchor(s.bmpText("+",c))),l.set(o,h+o.width/2,e.height-o.height/2-u),t.insert(s.opacity(n.makeHotspot(o),.2)),a.m5.touch=(t,e)=>{e?n.setKeyOn(n.RIGHT):n.setKeyOff(n.RIGHT)},i.m5.touch=(t,e)=>{e?n.setKeyOn(n.LEFT):n.setKeyOff(n.LEFT)},o.m5.touch=(t,e)=>{e?n.setKeyOn(n.SPACE):n.setKeyOff(n.SPACE)}}}),this.g.initHotspots()},postUpdate(){this.g.lapTime.text=`Lap Time: ${Number(o.lapTime).toFixed(3)}`}}),i.run("Splash",{title:"Retro Racer",clickSnd:"click.mp3",action:{name:"PlayGame"}})}MojoH5Ldr({assetFiles:["player.png","click.mp3","sky.png","hills.png","trees.png",r],arena:{width:1344,height:840},scaleToWindow:"max",scaleFit:"x",SEGLEN:200,start(...t){s(...t)}})}(this);